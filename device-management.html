<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-zh="è®¾å¤‡ç®¡ç†" data-en="Device Management">è®¾å¤‡ç®¡ç†</title>
    <link rel="stylesheet" href="assets/css/common.css">
    <link rel="stylesheet" href="assets/css/navbar.css">
    <!-- ç¦ç”¨navbar.jsä»¥é¿å…è‡ªåŠ¨é‡å®šå‘ -->
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-brand">
                <img src="logo.png" alt="Logo" class="nav-logo">
            </div>
            <div class="nav-menu">
                <a href="dashboard.html" class="nav-link" data-zh="ä»ªè¡¨ç›˜" data-en="Dashboard">ä»ªè¡¨ç›˜</a>
                <a href="device-management.html" class="nav-link active" data-zh="è®¾å¤‡ç®¡ç†" data-en="Device Management">è®¾å¤‡ç®¡ç†</a>
                <a href="space-management.html" class="nav-link" data-zh="å»ºç­‘ç®¡ç†" data-en="Building Management">å»ºç­‘ç®¡ç†</a>
                <a href="user-management.html" class="nav-link" data-zh="ç”¨æˆ·ç®¡ç†" data-en="User Management">ç”¨æˆ·ç®¡ç†</a>
                <a href="bills.html" class="nav-link" data-zh="è´¦å•ç®¡ç†" data-en="Bill Management">è´¦å•ç®¡ç†</a>
            </div>
            <div class="nav-actions" style="overflow: visible !important;">
                <div class="lang-dropdown">
                    <select id="language-select" class="form-select lang-select">
                        <option value="zh" data-zh="ä¸­æ–‡" data-en="Chinese">ä¸­æ–‡</option>
                        <option value="en" data-zh="English" data-en="English">English</option>
                    </select>
                </div>
                <div class="user-menu" style="position: relative; overflow: visible !important;">
                    <input type="checkbox" id="user-dropdown-toggle" style="display: none;">
                    <label for="user-dropdown-toggle" style="display: flex; align-items: center; cursor: pointer; gap: 8px;">
                        <div class="user-avatar">ç®¡</div>
                        <span data-zh="ç®¡ç†å‘˜" data-en="Admin">ç®¡ç†å‘˜</span>
                        <span style="font-size: 12px; margin-left: 4px;">â–¼</span>
                    </label>

                    <!-- ä¸‹æ‹‰èœå• -->
                    <div class="dropdown-menu" style="position: fixed; top: 64px; right: 20px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); min-width: 120px; display: none; z-index: 9999; padding: 4px 0;">
                        <label for="logout-confirm-toggle" style="display: flex; align-items: center; padding: 12px 16px; text-decoration: none; color: #dc2626; font-size: 14px; transition: background-color 0.15s ease; gap: 8px; cursor: pointer;">
                            <span style="font-size: 16px;">ğŸšª</span>
                            <span data-zh="é€€å‡ºç™»å½•" data-en="Logout">é€€å‡ºç™»å½•</span>
                        </label>
                    </div>
                </div>

                <style>
                    .navbar, .nav-content, .nav-actions, .user-menu {
                        overflow: visible !important;
                    }

                    #user-dropdown-toggle:checked + label + .dropdown-menu {
                        display: block !important;
                        animation: dropdownFadeIn 0.2s ease-out;
                    }

                    #user-dropdown-toggle:checked + label span:last-child {
                        transform: rotate(180deg);
                        transition: transform 0.2s ease;
                    }

                    .dropdown-menu a:hover {
                        background-color: #f9fafb !important;
                    }

                    .dropdown-menu a[href="login.html"]:hover {
                        background-color: #fef2f2 !important;
                    }

                    @keyframes dropdownFadeIn {
                        from {
                            opacity: 0;
                            transform: translateY(-10px);
                        }
                        to {
                            opacity: 1;
                            transform: translateY(0);
                        }
                    }

                    /* é€€å‡ºç¡®è®¤å¼¹çª—æ ·å¼ */
                    #logout-confirm-toggle:checked + .logout-modal {
                        display: flex !important;
                        animation: modalFadeIn 0.3s ease-out;
                    }

                    #logout-confirm-toggle:checked + .logout-modal > div {
                        transform: scale(1) !important;
                        animation: modalSlideIn 0.3s ease-out;
                    }

                    @keyframes modalFadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }

                    @keyframes modalSlideIn {
                        from {
                            transform: scale(0.8) translateY(-20px);
                            opacity: 0;
                        }
                        to {
                            transform: scale(1) translateY(0);
                            opacity: 1;
                        }
                    }

                    /* hoveræ•ˆæœ */
                    .logout-modal label:hover {
                        background-color: #e5e7eb !important;
                    }

                    .logout-modal a:hover {
                        background-color: #b91c1c !important;
                    }
                </style>
            </div>
        </div>
    </nav>

    <!-- é€€å‡ºç¡®è®¤å¼¹çª— -->
    <input type="checkbox" id="logout-confirm-toggle" style="display: none;">
    <div class="logout-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: none; z-index: 99999; align-items: center; justify-content: center; backdrop-filter: blur(4px);">
        <div style="background: white; border-radius: 12px; padding: 32px; max-width: 420px; width: 90%; box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3); transform: scale(0.9); transition: transform 0.2s ease;">
            <!-- å…³é—­æŒ‰é’® -->
            <label for="logout-confirm-toggle" style="position: absolute; top: 16px; right: 16px; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: #f3f4f6; color: #6b7280; font-size: 18px; line-height: 1;">Ã—</label>

            <!-- å›¾æ ‡ -->
            <div style="text-align: center; font-size: 48px; margin-bottom: 20px;">âš ï¸</div>

            <!-- æ ‡é¢˜ -->
            <h3 style="text-align: center; font-size: 20px; font-weight: 600; color: #1f2937; margin-bottom: 12px; margin-top: 0;" data-zh="ç¡®è®¤é€€å‡º" data-en="Confirm Logout">ç¡®è®¤é€€å‡º</h3>

            <!-- æè¿° -->
            <p style="text-align: center; color: #6b7280; font-size: 16px; line-height: 1.5; margin-bottom: 28px; margin-top: 0;" data-zh="æ‚¨ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿé€€å‡ºåéœ€è¦é‡æ–°è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ã€‚" data-en="Are you sure you want to logout? You will need to enter your username and password again.">æ‚¨ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿé€€å‡ºåéœ€è¦é‡æ–°è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ã€‚</p>

            <!-- æŒ‰é’®ç»„ -->
            <div style="display: flex; gap: 12px; justify-content: center;">
                <label for="logout-confirm-toggle" style="padding: 12px 24px; background: #f3f4f6; color: #374151; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; text-align: center; transition: background-color 0.2s ease; min-width: 80px;" data-zh="å–æ¶ˆ" data-en="Cancel">å–æ¶ˆ</label>
                <a href="index.html" style="padding: 12px 24px; background: #dc2626; color: white; border-radius: 8px; text-decoration: none; font-size: 14px; font-weight: 500; text-align: center; transition: background-color 0.2s ease; min-width: 80px; display: block;" data-zh="ç¡®è®¤é€€å‡º" data-en="Confirm">ç¡®è®¤é€€å‡º</a>
            </div>
        </div>
    </div>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <main class="main-content">
        <div class="content-layout">
            <div class="main-container">

                <!-- æœç´¢å’Œæ“ä½œåŒºåŸŸ -->
                <div class="search-section">
                    <div class="search-controls">
                        <input type="text" id="device-search" class="form-input" placeholder="è®¾å¤‡ID/åç§°/ä½ç½®..." data-zh-placeholder="è®¾å¤‡ID/åç§°/ä½ç½®..." data-en-placeholder="Device ID/Name/Location...">
                        <select id="device-status-filter" class="form-select">
                            <option value="all" data-zh="å…¨éƒ¨çŠ¶æ€" data-en="All Status">å…¨éƒ¨çŠ¶æ€</option>
                            <option value="online" data-zh="åœ¨çº¿" data-en="Online">åœ¨çº¿</option>
                            <option value="offline" data-zh="ç¦»çº¿" data-en="Offline">ç¦»çº¿</option>
                            <option value="error" data-zh="æ•…éšœ" data-en="Error">æ•…éšœ</option>
                        </select>
                    </div>
                    <div class="search-actions">
                        <button class="btn btn-primary" onclick="searchDevices()">
                            <span data-zh="æŸ¥è¯¢" data-en="Search">æŸ¥è¯¢</span>
                        </button>
                        <button class="btn btn-secondary" onclick="resetFilters()">
                            <span data-zh="é‡ç½®" data-en="Reset">é‡ç½®</span>
                        </button>
                    </div>
                </div>

                <!-- è®¾å¤‡ç®¡ç†å¡ç‰‡ -->
                <div class="table-container">
                    <!-- è®¾å¤‡çŠ¶æ€æ ‡ç­¾é¡µ -->
                    <div class="device-tabs">
                        <button class="device-tab active" data-status="unconnected" onclick="filterDevicesByStatus('unconnected')">
                            <span data-zh="æœªè¿æ¥" data-en="Unconnected">æœªè¿æ¥</span>
                            <span class="tab-count" id="count-unconnected">(3)</span>
                        </button>
                        <button class="device-tab" data-status="connected-unbound" onclick="filterDevicesByStatus('connected-unbound')">
                            <span data-zh="å·²è¿æ¥ï¼Œæœªç»‘å®š" data-en="Connected, Unbound">å·²è¿æ¥ï¼Œæœªç»‘å®š</span>
                            <span class="tab-count" id="count-connected-unbound">(5)</span>
                        </button>
                        <button class="device-tab" data-status="bound" onclick="filterDevicesByStatus('bound')">
                            <span data-zh="å·²ç»‘å®š" data-en="Bound">å·²ç»‘å®š</span>
                            <span class="tab-count" id="count-bound">(7)</span>
                        </button>
                    </div>
                    <div class="table-header">
                        <div class="table-actions-left">
                            <button class="btn btn-success" onclick="showAddDeviceModal()">
                                <span data-zh="+ æ·»åŠ è®¾å¤‡" data-en="+ Add Device">+ æ·»åŠ è®¾å¤‡</span>
                            </button>
                        </div>
                        <div class="table-actions-right" id="batch-actions">
                            <span class="selected-count" id="selected-count" data-zh="å·²é€‰æ‹© 0 ä¸ªè®¾å¤‡" data-en="Selected 0 devices">å·²é€‰æ‹© 0 ä¸ªè®¾å¤‡</span>
                            <button class="btn btn-primary" id="ota-upgrade-btn" onclick="showOtaUpgradeModal()" disabled>
                                <span data-zh="OTAå‡çº§" data-en="OTA Upgrade">OTAå‡çº§</span>
                            </button>
                        </div>
                    </div>
                    <table class="table" id="devices-table">
                        <thead id="devices-thead">
                            <!-- è¡¨å¤´ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </thead>
                        <tbody id="devices-tbody">
                            <!-- æ•°æ®ç”±JavaScriptç”Ÿæˆ -->
                        </tbody>
                    </table>

                    <!-- åˆ†é¡µ -->
                    <div class="pagination">
                        <button class="btn btn-secondary" id="prev-page" disabled>
                            <span>â€¹</span>
                            <span data-zh="ä¸Šä¸€é¡µ" data-en="Previous">ä¸Šä¸€é¡µ</span>
                        </button>
                        <div class="page-info">
                            <span data-zh="ç¬¬" data-en="Page">ç¬¬</span>
                            <span id="current-page">1</span>
                            <span data-zh="é¡µï¼Œå…±" data-en="of">é¡µï¼Œå…±</span>
                            <span id="total-pages">2</span>
                            <span data-zh="é¡µ" data-en="pages">é¡µ</span>
                        </div>
                        <button class="btn btn-secondary" id="next-page">
                            <span data-zh="ä¸‹ä¸€é¡µ" data-en="Next">ä¸‹ä¸€é¡µ</span>
                            <span>â€º</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- æ·»åŠ è®¾å¤‡æ¨¡æ€æ¡† -->
    <div id="device-modal" class="modal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title" data-zh="æ·»åŠ è®¾å¤‡" data-en="Add Device">æ·»åŠ è®¾å¤‡</h3>
                <button class="modal-close" onclick="hideAddDeviceModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="device-form" class="device-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="device-name" data-zh="è®¾å¤‡åç§°" data-en="Device Name"><span style="color: red;">*</span>è®¾å¤‡åç§°</label>
                                <input type="text" id="device-name" name="deviceName" class="form-input"
                                       placeholder="1å·æ¥¼ä¸»ç”µè¡¨" data-zh-placeholder="1å·æ¥¼ä¸»ç”µè¡¨" data-en-placeholder="Building 1 Main Meter">
                            </div>
                            <div class="form-group">
                                <label for="device-id" data-zh="è®¾å¤‡ID" data-en="Device ID"><span style="color: red;">*</span>è®¾å¤‡ID</label>
                                <input type="text" id="device-id" name="deviceId" class="form-input"
                                       placeholder="MTR001" data-zh-placeholder="MTR001" data-en-placeholder="MTR001">
                            </div>
                        </div>


                        <div class="form-row">
                            <div class="form-group">
                                <label for="device-ratio" data-zh="å€ç‡" data-en="Ratio">å€ç‡</label>
                                <input type="text" id="device-ratio" name="deviceRatio" class="form-input"
                                       placeholder="1" value="1">
                                <small class="form-hint" data-zh="è®¾ç½®ç³»æ•°åï¼Œç”µæµã€åŠŸç‡å’Œç”µèƒ½å°†ä¼šä¸ºç”µè¡¨çš„æµ‹é‡å€¼ä¹˜ä»¥è¯¥ç³»æ•°ï¼Œä»è€Œè½¬æ¢ä¸ºå®é™…çš„æµ‹é‡å€¼" data-en="After setting the coefficient, current, power and energy will be the meter's measured value multiplied by this coefficient to convert to actual measured values">è®¾ç½®ç³»æ•°åï¼Œç”µæµã€åŠŸç‡å’Œç”µèƒ½å°†ä¼šä¸ºç”µè¡¨çš„æµ‹é‡å€¼ä¹˜ä»¥è¯¥ç³»æ•°ï¼Œä»è€Œè½¬æ¢ä¸ºå®é™…çš„æµ‹é‡å€¼</small>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="device-remarks" data-zh="å¤‡æ³¨" data-en="Remarks">å¤‡æ³¨</label>
                                <input type="text" id="device-remarks" name="deviceRemarks" class="form-input"
                                       placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯" data-zh-placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯" data-en-placeholder="Enter remarks">
                            </div>
                        </div>

                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideAddDeviceModal()" data-zh="å–æ¶ˆ" data-en="Cancel">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="saveDevice()" data-zh="ä¿å­˜" data-en="Save">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
    <div id="delete-confirm-modal" class="modal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content delete-confirm-modal">
            <div class="modal-header">
                <h3 data-zh="ç¡®è®¤åˆ é™¤" data-en="Confirm Delete">ç¡®è®¤åˆ é™¤</h3>
                <button class="modal-close" onclick="hideDeleteConfirm()">&times;</button>
            </div>
            <div class="modal-body">
                <p data-zh="ç¡®å®šè¦åˆ é™¤è®¾å¤‡ &quot;<span id='delete-device-name'></span>&quot; å—ï¼Ÿ" data-en="Are you sure you want to delete device &quot;<span id='delete-device-name'></span>&quot;?">ç¡®å®šè¦åˆ é™¤è®¾å¤‡ "<span id="delete-device-name"></span>" å—ï¼Ÿ</p>
                <p class="delete-warning" data-zh="æ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚" data-en="This action cannot be undone.">æ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideDeleteConfirm()" data-zh="å–æ¶ˆ" data-en="Cancel">å–æ¶ˆ</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()" data-zh="åˆ é™¤" data-en="Delete">åˆ é™¤</button>
            </div>
        </div>
    </div>

    <!-- OTAå‡çº§æ¨¡æ€æ¡† -->
    <div id="ota-upgrade-modal" class="modal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content ota-upgrade-modal">
            <div class="modal-header">
                <h3>OTAå‡çº§</h3>
                <button class="modal-close" onclick="hideOtaUpgradeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="ota-info">
                    <h4>å³å°†å‡çº§çš„è®¾å¤‡</h4>
                    <div id="ota-device-list" class="device-list">
                        <!-- è®¾å¤‡åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>

                <div class="ota-progress" id="ota-progress" style="display: none;">
                    <h4>å‡çº§è¿›åº¦</h4>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill"></div>
                        </div>
                        <span class="progress-text" id="progress-text">0%</span>
                    </div>
                    <div class="upgrade-status" id="upgrade-status">
                        å‡†å¤‡å‡çº§...
                    </div>
                </div>

                <div class="ota-warning">
                    <p>âš ï¸ å‡çº§æ³¨æ„äº‹é¡¹ï¼š</p>
                    <ul>
                        <li>å‡çº§è¿‡ç¨‹ä¸­è®¾å¤‡å¯èƒ½ä¼šçŸ­æš‚æ–­çº¿</li>
                        <li>è¯·ç¡®ä¿è®¾å¤‡ç”µæºç¨³å®š</li>
                        <li>å‡çº§è¿‡ç¨‹é¢„è®¡éœ€è¦2-5åˆ†é’Ÿ</li>
                        <li>å‡çº§æœŸé—´è¯·å‹¿æ–­å¼€è®¾å¤‡ç”µæº</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideOtaUpgradeModal()" id="ota-cancel-btn">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="startOtaUpgradeProcess()" id="ota-start-btn">å¼€å§‹å‡çº§</button>
                <button type="button" class="btn btn-success" onclick="hideOtaUpgradeModal()" id="ota-complete-btn" style="display: none;">å®Œæˆ</button>
            </div>
        </div>
    </div>

    <!-- é‡æ–°å¯ç”¨navbar.jså’Œcommon.jsä»¥ç¡®ä¿è¯­è¨€åŠŸèƒ½æ­£å¸¸ -->
    <script src="assets/js/navbar.js"></script>
    <script src="assets/js/common.js"></script>
    <script>
        // ä½¿ç”¨å…¨å±€è¯­è¨€å‡½æ•°
        function getDevicePageLanguage() {
            return getCurrentLanguage(); // ä½¿ç”¨å…¨å±€è¯­è¨€è®¾ç½®
        }

        // å¼ºåˆ¶ç¿»è¯‘æ‰€æœ‰é™æ€æ–‡æœ¬
        function forceTranslateStaticText() {
            const currentLang = getDevicePageLanguage();
            console.log('å¼ºåˆ¶ç¿»è¯‘é™æ€æ–‡æœ¬ï¼Œå½“å‰è¯­è¨€:', currentLang);

            // ç¿»è¯‘æ‰€æœ‰å¸¦æœ‰data-zhå’Œdata-enå±æ€§çš„å…ƒç´ ï¼Œä½†æ’é™¤è¡¨æ ¼å†…å®¹
            document.querySelectorAll('[data-zh][data-en]').forEach(element => {
                // è·³è¿‡è¡¨æ ¼å†…å®¹åŒºåŸŸï¼Œé¿å…å½±å“åŠ¨æ€ç”Ÿæˆçš„å†…å®¹
                if (element.closest('#devices-tbody')) {
                    return;
                }

                const zhText = element.getAttribute('data-zh');
                const enText = element.getAttribute('data-en');
                if (zhText && enText) {
                    // ç‰¹æ®Šå¤„ç†æ ‡ç­¾ä¸­çš„çº¢è‰²æ˜Ÿå·
                    if (element.tagName === 'LABEL' && element.querySelector('span[style*="color: red"]')) {
                        const redSpan = element.querySelector('span[style*="color: red"]');
                        element.innerHTML = `${redSpan.outerHTML}${currentLang === 'en' ? enText : zhText}`;
                    } else {
                        element.textContent = currentLang === 'en' ? enText : zhText;
                    }
                }
            });

            // ç¿»è¯‘å ä½ç¬¦
            document.querySelectorAll('[data-zh-placeholder][data-en-placeholder]').forEach(element => {
                const zhPlaceholder = element.getAttribute('data-zh-placeholder');
                const enPlaceholder = element.getAttribute('data-en-placeholder');
                if (zhPlaceholder && enPlaceholder) {
                    element.placeholder = currentLang === 'en' ? enPlaceholder : zhPlaceholder;
                }
            });

            // ç¿»è¯‘ç‰¹æ®Šæ–‡æœ¬
            const selectedCountElement = document.getElementById('selected-count');
            if (selectedCountElement) {
                const count = selectedCountElement.textContent.match(/\d+/) || ['0'];
                selectedCountElement.textContent = currentLang === 'en'
                    ? `Selected ${count[0]} devices`
                    : `å·²é€‰æ‹© ${count[0]} ä¸ªè®¾å¤‡`;
            }

            console.log('é™æ€æ–‡æœ¬ç¿»è¯‘å®Œæˆ');
        }

        // è®¾å¤‡æ•°æ®
        const devicesData = [
            {
                id: 'MTR001',
                name: 'è®¾å¤‡001',
                nameEn: 'Device 001',
                type: 'three-phase',
                position: '1å·æ¥¼/1å±‚/101',
                ratio: 1,
                status: 'online',
                bound: true,
                lastReading: '2025-09-22 10:30'
            },
            {
                id: 'MTR002',
                name: 'è®¾å¤‡002',
                nameEn: 'Device 002',
                type: 'three-phase',
                position: '2å·æ¥¼/2å±‚/202',
                ratio: 1,
                status: 'online',
                bound: true,
                lastReading: '2025-09-22 10:28'
            },
            {
                id: 'MTR003',
                name: 'è®¾å¤‡003',
                nameEn: 'Device 003',
                type: 'single-phase',
                position: 'building-1',
                ratio: 10,
                status: 'offline',
                bound: false,
                lastReading: '2025-09-22 08:15'
            },
            {
                id: 'MTR004',
                name: 'è®¾å¤‡004',
                nameEn: 'Device 004',
                type: 'single-phase',
                position: 'building-1',
                ratio: 5,
                status: 'online',
                bound: false,
                lastReading: '2025-09-22 10:25'
            },
            {
                id: 'MTR005',
                name: 'è®¾å¤‡005',
                nameEn: 'Device 005',
                type: 'three-phase',
                position: '1å·æ¥¼/åœ°ä¸‹1å±‚/B101',
                ratio: 1,
                status: 'online',
                bound: true,
                lastReading: '2025-09-22 10:20'
            },
            {
                id: 'MTR006',
                name: 'è®¾å¤‡006',
                nameEn: 'Device 006',
                type: 'three-phase',
                position: 'building-2',
                ratio: 1,
                status: 'offline',
                bound: false,
                lastReading: '2025-09-22 09:45'
            },
            {
                id: 'MTR007',
                name: 'è®¾å¤‡007',
                nameEn: 'Device 007',
                type: 'single-phase',
                position: 'building-2',
                ratio: 10,
                status: 'online',
                bound: false,
                lastReading: '2025-09-22 10:32'
            },
            {
                id: 'MTR008',
                name: 'è®¾å¤‡008',
                nameEn: 'Device 008',
                type: 'three-phase',
                position: 'building-1',
                ratio: 1,
                status: 'offline',
                bound: false,
                lastReading: '2025-09-22 08:30'
            }
        ];

        // åˆ†é¡µå˜é‡
        let currentPage = 1;
        let currentStatus = 'unconnected'; // å½“å‰é€‰ä¸­çš„çŠ¶æ€
        let filteredDevices = devicesData.filter(device => device.status === 'offline' && !device.bound); // é»˜è®¤æ˜¾ç¤ºæœªè¿æ¥è®¾å¤‡

        // æ ¹æ®çŠ¶æ€å®šä¹‰è¡¨å¤´é…ç½®
        const tableHeaders = {
            'unconnected': [
                { key: 'id', zh: 'è®¾å¤‡ID', en: 'Device ID' },
                { key: 'name', zh: 'è®¾å¤‡åç§°', en: 'Device Name' },
                { key: 'ratio', zh: 'å€ç‡', en: 'Ratio' },
                { key: 'status', zh: 'è¿æ¥çŠ¶æ€', en: 'Connection Status' }
            ],
            'connected-unbound': [
                { key: 'id', zh: 'è®¾å¤‡ID', en: 'Device ID' },
                { key: 'name', zh: 'è®¾å¤‡åç§°', en: 'Device Name' },
                { key: 'position', zh: 'ä½ç½®', en: 'Position' },
                { key: 'ratio', zh: 'å€ç‡', en: 'Ratio' },
                { key: 'status', zh: 'è¿æ¥çŠ¶æ€', en: 'Connection Status' }
            ],
            'bound': [
                { key: 'id', zh: 'è®¾å¤‡ID', en: 'Device ID' },
                { key: 'name', zh: 'è®¾å¤‡åç§°', en: 'Device Name' },
                { key: 'position', zh: 'ä½ç½®', en: 'Position' },
                { key: 'ratio', zh: 'å€ç‡', en: 'Ratio' },
                { key: 'status', zh: 'è¿æ¥çŠ¶æ€', en: 'Connection Status' }
            ]
        };

        // æ ¹æ®çŠ¶æ€å®šä¹‰æ“ä½œæŒ‰é’®é…ç½®
        const actionButtons = {
            'unconnected': [
                { action: 'edit', zh: 'ç¼–è¾‘', en: 'Edit', class: 'btn-primary' },
                { action: 'delete', zh: 'åˆ é™¤', en: 'Delete', class: 'btn-danger' }
            ],
            'connected-unbound': [
                { action: 'edit', zh: 'ç¼–è¾‘', en: 'Edit', class: 'btn-primary' },
                { action: 'view', zh: 'è¯¦æƒ…', en: 'Details', class: 'btn-info' },
                { action: 'delete', zh: 'åˆ é™¤', en: 'Delete', class: 'btn-danger' }
            ],
            'bound': [
                { action: 'edit', zh: 'ç¼–è¾‘', en: 'Edit', class: 'btn-primary' },
                { action: 'view', zh: 'è¯¦æƒ…', en: 'Details', class: 'btn-info' },
                { action: 'delete', zh: 'åˆ é™¤', en: 'Delete', class: 'btn-danger' }
            ]
        };

        // æ¸²æŸ“è¡¨å¤´
        function renderTableHeaders(status) {
            const thead = document.getElementById('devices-thead');
            const headers = tableHeaders[status];
            const currentLang = getDevicePageLanguage();

            let headerHtml = `
                <tr>
                    <th style="width: 50px;">
                        <input type="checkbox" id="select-all-devices" onchange="toggleSelectAll()">
                    </th>
            `;

            headers.forEach(header => {
                const headerText = currentLang === 'en' ? header.en : header.zh;
                headerHtml += `<th data-sortable data-zh="${header.zh}" data-en="${header.en}">${headerText}</th>`;
            });

            headerHtml += `<th data-zh="æ“ä½œ" data-en="Actions">${currentLang === 'en' ? 'Actions' : 'æ“ä½œ'}</th></tr>`;
            thead.innerHTML = headerHtml;
        }

        // æ¸²æŸ“è®¾å¤‡è¡Œ
        function renderDeviceRow(device, status) {
            const headers = tableHeaders[status];
            const actions = actionButtons[status];
            const currentLang = getDevicePageLanguage();

            let rowHtml = `
                <tr>
                    <td><input type="checkbox" class="device-checkbox" value="${device.id}"></td>
            `;

            headers.forEach(header => {
                let cellValue = '';
                switch(header.key) {
                    case 'id':
                        cellValue = device.id;
                        break;
                    case 'name':
                        cellValue = currentLang === 'en' ? (device.nameEn || device.name) : device.name;
                        break;
                    case 'position':
                        // å·²è¿æ¥æœªç»‘å®šçš„è®¾å¤‡æ˜¾ç¤º--
                        if (device.status === 'online' && !device.bound) {
                            cellValue = '--';
                        } else if (device.bound) {
                            // å·²ç»‘å®šè®¾å¤‡ç›´æ¥æ˜¾ç¤ºä½ç½®ä¿¡æ¯
                            cellValue = device.position || '-';
                        } else {
                            const positionMap = currentLang === 'en' ? {
                                'building-1': 'Building 1',
                                'building-2': 'Building 2',
                                'parking': 'Parking',
                                'outdoor': 'Outdoor Area'
                            } : {
                                'building-1': '1å·æ¥¼',
                                'building-2': '2å·æ¥¼',
                                'parking': 'åœè½¦åœº',
                                'outdoor': 'å®¤å¤–åŒºåŸŸ'
                            };
                            cellValue = positionMap[device.position] || device.position || '-';
                        }
                        break;
                    case 'ratio':
                        cellValue = device.ratio;
                        break;
                    case 'status':
                        let statusText, statusClass;

                        // æ ¹æ®è®¾å¤‡çŠ¶æ€å’Œç»‘å®šæƒ…å†µç¡®å®šæ˜¾ç¤ºæ–‡æœ¬
                        if (device.status === 'offline' && !device.bound) {
                            statusText = currentLang === 'en' ? 'Unconnected' : 'æœªè¿æ¥';
                            statusClass = 'status-unconnected';
                        } else if (device.status === 'online' && !device.bound) {
                            statusText = currentLang === 'en' ? 'Connected, Unbound' : 'å·²è¿æ¥ï¼Œæœªç»‘å®š';
                            statusClass = 'status-connected-unbound';
                        } else if (device.bound) {
                            statusText = currentLang === 'en' ? 'Bound' : 'å·²ç»‘å®š';
                            statusClass = 'status-bound';
                        } else {
                            statusText = device.status === 'online' ?
                                (currentLang === 'en' ? 'Online' : 'åœ¨çº¿') :
                                (currentLang === 'en' ? 'Offline' : 'ç¦»çº¿');
                            statusClass = device.status === 'online' ? 'status-online' : 'status-offline';
                        }

                        cellValue = `<span class="${statusClass}">${statusText}</span>`;
                        break;
                    default:
                        cellValue = device[header.key] || '-';
                }
                rowHtml += `<td>${cellValue}</td>`;
            });

            // æ·»åŠ æ“ä½œåˆ—
            rowHtml += '<td><div class="actions">';
            actions.forEach(action => {
                const buttonText = currentLang === 'en' ? action.en : action.zh;
                let onclick = '';
                switch(action.action) {
                    case 'edit':
                        onclick = `editDevice('${device.id}')`;
                        break;
                    case 'view':
                        onclick = `viewDevice('${device.id}')`;
                        break;
                    case 'delete':
                        onclick = `deleteDevice('${device.id}')`;
                        break;
                }
                rowHtml += `<button class="btn btn-sm ${action.class}" onclick="${onclick}">${buttonText}</button>`;
            });
            rowHtml += '</div></td></tr>';

            return rowHtml;
        }

        function renderDevicesTable() {
            console.log('=== renderDevicesTable called ===');
            console.log('devicesData:', devicesData);
            console.log('devicesData length:', devicesData.length);
            console.log('filteredDevices length:', filteredDevices.length);

            // é¦–å…ˆæ¸²æŸ“è¡¨å¤´
            renderTableHeaders(currentStatus);

            const tbody = document.getElementById('devices-tbody');
            console.log('tbody element:', tbody);
            if (!tbody) {
                console.error('devices-tbody element not found!');
                return;
            }
            const itemsPerPage = 10;
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageDevices = filteredDevices.slice(startIndex, endIndex);

            console.log('Page devices to render:', pageDevices);
            console.log('startIndex:', startIndex, 'endIndex:', endIndex, 'pageDevices length:', pageDevices.length);

            if (pageDevices.length === 0) {
                console.warn('No devices to display on current page');
                const currentLang = getDevicePageLanguage();
                const columnCount = tableHeaders[currentStatus].length + 2; // +2 for checkbox and actions columns
                tbody.innerHTML = `<tr><td colspan="${columnCount}" style="text-align:center; padding: 20px;">${currentLang === 'en' ? 'No device data' : 'æš‚æ— è®¾å¤‡æ•°æ®'}</td></tr>`;
                return;
            }

            console.log('About to render pageDevices:', pageDevices);

            try {
                tbody.innerHTML = pageDevices.map(device => {
                    console.log('Rendering device:', device);
                    const currentLang = getDevicePageLanguage();
                    console.log('Current language:', currentLang);

                    const statusClass = device.status === 'online' ? 'status-online' :
                                       device.status === 'offline' ? 'status-offline' : 'status-error';

                    const statusText = device.status === 'online'
                        ? (currentLang === 'en' ? 'Online' : 'åœ¨çº¿')
                        : device.status === 'offline'
                        ? (currentLang === 'en' ? 'Offline' : 'ç¦»çº¿')
                        : (currentLang === 'en' ? 'Error' : 'æ•…éšœ');

                    const positionMap = currentLang === 'en' ? {
                        'building-1': 'Building 1',
                        'building-2': 'Building 2',
                        'parking': 'Parking',
                        'outdoor': 'Outdoor Area'
                    } : {
                        'building-1': '1å·æ¥¼',
                        'building-2': '2å·æ¥¼',
                        'parking': 'åœè½¦åœº',
                        'outdoor': 'å®¤å¤–åŒºåŸŸ'
                    };
                    const positionText = positionMap[device.position] || device.position || '-';

                    return renderDeviceRow(device, currentStatus);
                }).join('');
                console.log('è¡¨æ ¼HTMLç”ŸæˆæˆåŠŸï¼Œé•¿åº¦:', tbody.innerHTML.length);
                updatePagination();
            } catch (error) {
                console.error('æ¸²æŸ“è¡¨æ ¼æ—¶å‡ºé”™:', error);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px; color: red;">æ¸²æŸ“é”™è¯¯: ' + error.message + '</td></tr>';
            }
        }

        // æ›´æ–°åˆ†é¡µ
        function updatePagination() {
            const totalPages = Math.ceil(filteredDevices.length / 10);
            document.getElementById('current-page').textContent = currentPage;
            document.getElementById('total-pages').textContent = totalPages;
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage === totalPages;
        }

        function searchDevices() {
            const currentLang = getDevicePageLanguage();
            alert(currentLang === 'en' ? 'Search functionality' : 'æœç´¢åŠŸèƒ½');
        }

        function resetFilters() {
            const currentLang = getDevicePageLanguage();
            alert(currentLang === 'en' ? 'Reset filters functionality' : 'é‡ç½®åŠŸèƒ½');
        }

        // è®¾å¤‡çŠ¶æ€æ ‡ç­¾é¡µè¿‡æ»¤åŠŸèƒ½
        function filterDevicesByStatus(status) {
            // æ›´æ–°å½“å‰çŠ¶æ€
            currentStatus = status;

            // æ›´æ–°æ ‡ç­¾é¡µæ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.device-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-status="${status}"]`).classList.add('active');

            // æ ¹æ®çŠ¶æ€è¿‡æ»¤è®¾å¤‡
            let newFilteredDevices = [];
            switch(status) {
                case 'unconnected':
                    newFilteredDevices = devicesData.filter(device => device.status === 'offline' && !device.bound);
                    break;
                case 'connected-unbound':
                    newFilteredDevices = devicesData.filter(device => device.status === 'online' && !device.bound);
                    break;
                case 'bound':
                    newFilteredDevices = devicesData.filter(device => device.bound === true);
                    break;
            }

            // æ›´æ–°å…¨å±€è¿‡æ»¤è®¾å¤‡æ•°æ®
            filteredDevices = newFilteredDevices;
            currentPage = 1;
            renderDevicesTable();
            updatePagination();

            console.log(`è¿‡æ»¤çŠ¶æ€: ${status}, è®¾å¤‡æ•°é‡: ${filteredDevices.length}`);
        }

        // æ›´æ–°è®¾å¤‡çŠ¶æ€ç»Ÿè®¡
        function updateDeviceTabCounts() {
            const counts = {
                unconnected: devicesData.filter(d => d.status === 'offline' && !d.bound).length,
                'connected-unbound': devicesData.filter(d => d.status === 'online' && !d.bound).length,
                bound: devicesData.filter(d => d.bound === true).length
            };

            Object.keys(counts).forEach(status => {
                const countElement = document.getElementById(`count-${status}`);
                if (countElement) {
                    countElement.textContent = `(${counts[status]})`;
                }
            });
        }

        function showAddDeviceModal() {
            const currentLang = getDevicePageLanguage();
            document.getElementById('modal-title').textContent = currentLang === 'en' ? 'Add Device' : 'æ·»åŠ è®¾å¤‡';
            document.getElementById('device-form').reset();
            document.getElementById('device-form').setAttribute('data-mode', 'add');
            document.getElementById('device-form').removeAttribute('data-device-id');
            document.getElementById('device-modal').style.display = 'flex';
            document.body.classList.add('modal-open');
        }

        function hideAddDeviceModal() {
            document.getElementById('device-modal').style.display = 'none';
            document.body.classList.remove('modal-open');
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.addEventListener('click', function(event) {
            const deviceModal = document.getElementById('device-modal');
            const deleteModal = document.getElementById('delete-confirm-modal');
            const otaModal = document.getElementById('ota-upgrade-modal');

            if (event.target === deviceModal || event.target === deviceModal.querySelector('.modal-overlay')) {
                hideAddDeviceModal();
            }

            if (event.target === deleteModal || event.target === deleteModal.querySelector('.modal-overlay')) {
                hideDeleteConfirm();
            }

            if (event.target === otaModal || event.target === otaModal.querySelector('.modal-overlay')) {
                hideOtaUpgradeModal();
            }
        });

        function saveDevice() {
            const form = document.getElementById('device-form');
            const formData = new FormData(form);
            const mode = form.getAttribute('data-mode');
            const deviceId = form.getAttribute('data-device-id');

            // è·å–è¡¨å•æ•°æ®


            const deviceData = {
                id: formData.get('deviceId').trim() || 'MTR' + String(Math.floor(Math.random() * 900) + 100),
                name: formData.get('deviceName').trim() || 'æœªå‘½åè®¾å¤‡',
                nameEn: formData.get('deviceName').trim() || 'Unnamed Device',
                type: 'single-phase',
                position: 'building-1', // é»˜è®¤ä½ç½®
                ratio: parseInt(formData.get('deviceRatio').trim()) || 1,
                status: 'offline',
                bound: false,
                lastReading: new Date().toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                }).replace(/\//g, '-')
            };

            try {
                if (mode === 'edit') {
                    // ç¼–è¾‘æ¨¡å¼ï¼šæ›´æ–°ç°æœ‰è®¾å¤‡
                    const index = devicesData.findIndex(d => d.id === deviceId);
                    if (index > -1) {
                        devicesData[index] = { ...devicesData[index], ...deviceData };

                        // æ›´æ–°è®¾å¤‡çŠ¶æ€ç»Ÿè®¡
                        updateDeviceTabCounts();
                        // é‡æ–°è¿‡æ»¤å½“å‰çŠ¶æ€çš„è®¾å¤‡
                        filterDevicesByStatus(currentStatus);

                        // å…³é—­æ¨¡æ€æ¡†
                        hideAddDeviceModal();

                        alert('è®¾å¤‡ç¼–è¾‘æˆåŠŸï¼');
                    }
                } else {
                    // æ·»åŠ æ¨¡å¼ï¼šæ–°å¢è®¾å¤‡
                    devicesData.push(deviceData);

                    // æ›´æ–°è®¾å¤‡çŠ¶æ€ç»Ÿè®¡
                    updateDeviceTabCounts();
                    // é‡æ–°è¿‡æ»¤å½“å‰çŠ¶æ€çš„è®¾å¤‡
                    filterDevicesByStatus(currentStatus);

                    // å…³é—­æ¨¡æ€æ¡†
                    hideAddDeviceModal();

                    alert('è®¾å¤‡æ·»åŠ æˆåŠŸï¼');

                    // æ ‡è®°è®¾å¤‡æµç¨‹ä¸ºå®Œæˆ
                    let workflowProgress = JSON.parse(localStorage.getItem('workflowProgress') || '{}');
                    workflowProgress.device = true;
                    localStorage.setItem('workflowProgress', JSON.stringify(workflowProgress));
                }

                console.log(mode === 'edit' ? 'ç¼–è¾‘è®¾å¤‡:' : 'æ–°å¢è®¾å¤‡:', deviceData);
            } catch (error) {
                console.error('ä¿å­˜è®¾å¤‡æ—¶å‡ºé”™:', error);
                alert('ä¿å­˜è®¾å¤‡å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        function editDevice(deviceId) {
            const device = devicesData.find(d => d.id === deviceId);
            if (!device) return;

            // å¡«å……è¡¨å•æ•°æ®
            const currentLang = getDevicePageLanguage();
            document.getElementById('device-name').value = currentLang === 'en' ? (device.nameEn || device.name) : device.name;
            document.getElementById('device-id').value = device.id;
            document.getElementById('device-ratio').value = device.ratio || '1';

            // ä¿®æ”¹æ ‡é¢˜å’Œä¿å­˜å‡½æ•°
            document.getElementById('modal-title').textContent = currentLang === 'en' ? 'Edit Device' : 'ç¼–è¾‘è®¾å¤‡';
            document.getElementById('device-form').setAttribute('data-mode', 'edit');
            document.getElementById('device-form').setAttribute('data-device-id', deviceId);

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('device-modal').style.display = 'flex';
            document.body.classList.add('modal-open');
        }

        function viewDevice(deviceId) {
            window.location.href = `device-detail.html?id=${deviceId}`;
        }

        let deleteDeviceId = null;

        function deleteDevice(deviceId) {
            const device = devicesData.find(d => d.id === deviceId);
            if (!device) return;

            const currentLang = getDevicePageLanguage();
            deleteDeviceId = deviceId;
            document.getElementById('delete-device-name').textContent = currentLang === 'en' ? (device.nameEn || device.name) : device.name;

            // æ›´æ–°åˆ é™¤ç¡®è®¤æ–‡æœ¬
            const deleteTextElement = document.querySelector('#delete-confirm-modal .modal-body p:first-child');
            if (deleteTextElement) {
                const deviceName = currentLang === 'en' ? (device.nameEn || device.name) : device.name;
                deleteTextElement.innerHTML = currentLang === 'en'
                    ? `Are you sure you want to delete device "<span id="delete-device-name">${deviceName}</span>"?`
                    : `ç¡®å®šè¦åˆ é™¤è®¾å¤‡ "<span id="delete-device-name">${deviceName}</span>" å—ï¼Ÿ`;
            }

            // æ›´æ–°è­¦å‘Šæ–‡æœ¬
            const warningElement = document.querySelector('#delete-confirm-modal .delete-warning');
            if (warningElement) {
                warningElement.textContent = currentLang === 'en' ? 'This operation cannot be undone.' : 'æ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚';
            }

            document.getElementById('delete-confirm-modal').style.display = 'flex';
            document.body.classList.add('modal-open');
        }

        function hideDeleteConfirm() {
            document.getElementById('delete-confirm-modal').style.display = 'none';
            document.body.classList.remove('modal-open');
            deleteDeviceId = null;
        }

        function confirmDelete() {
            if (deleteDeviceId) {
                const index = devicesData.findIndex(d => d.id === deleteDeviceId);
                if (index > -1) {
                    devicesData.splice(index, 1);
                    filteredDevices = [...devicesData];
                    currentPage = 1;
                    renderDevicesTable();
                    hideDeleteConfirm();
                    alert('è®¾å¤‡åˆ é™¤æˆåŠŸï¼');
                }
            }
        }

        // å¤šé€‰åŠŸèƒ½
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('select-all-devices');
            const deviceCheckboxes = document.querySelectorAll('.device-checkbox');

            deviceCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });

            updateBatchActions();
        }

        function updateBatchActions() {
            const selectedCheckboxes = document.querySelectorAll('.device-checkbox:checked');
            const selectedCount = document.getElementById('selected-count');
            const selectAllCheckbox = document.getElementById('select-all-devices');
            const otaUpgradeBtn = document.getElementById('ota-upgrade-btn');

            const currentLang = getDevicePageLanguage();
            selectedCount.textContent = currentLang === 'en'
                ? `Selected ${selectedCheckboxes.length} devices`
                : `å·²é€‰æ‹© ${selectedCheckboxes.length} ä¸ªè®¾å¤‡`;

            // å¯ç”¨/ç¦ç”¨OTAå‡çº§æŒ‰é’®
            if (selectedCheckboxes.length > 0) {
                otaUpgradeBtn.disabled = false;
                otaUpgradeBtn.classList.remove('btn-disabled');
            } else {
                otaUpgradeBtn.disabled = true;
                otaUpgradeBtn.classList.add('btn-disabled');
            }

            // æ›´æ–°å…¨é€‰å¤é€‰æ¡†çŠ¶æ€
            const allCheckboxes = document.querySelectorAll('.device-checkbox');
            selectAllCheckbox.checked = allCheckboxes.length > 0 && selectedCheckboxes.length === allCheckboxes.length;
            selectAllCheckbox.indeterminate = selectedCheckboxes.length > 0 && selectedCheckboxes.length < allCheckboxes.length;
        }

        // OTAå‡çº§åŠŸèƒ½
        function showOtaUpgradeModal() {
            const selectedDevices = Array.from(document.querySelectorAll('.device-checkbox:checked')).map(cb => cb.value);
            if (selectedDevices.length === 0) {
                return; // æŒ‰é’®å·²ç¦ç”¨ï¼Œä¸åº”è¯¥åˆ°è¾¾è¿™é‡Œ
            }

            // å¡«å……è®¾å¤‡åˆ—è¡¨
            const deviceList = document.getElementById('ota-device-list');
            deviceList.innerHTML = selectedDevices.map(id => {
                const device = devicesData.find(d => d.id === id);
                return `
                    <div class="device-item">
                        <span class="device-id">${device.id}</span>
                        <span class="device-name">${device.name}</span>
                        <span class="device-status-indicator waiting">ç­‰å¾…ä¸­</span>
                    </div>
                `;
            }).join('');

            // é‡ç½®æ¨¡æ€æ¡†çŠ¶æ€
            document.getElementById('ota-progress').style.display = 'none';
            document.getElementById('ota-start-btn').style.display = 'inline-flex';
            document.getElementById('ota-complete-btn').style.display = 'none';
            document.getElementById('ota-cancel-btn').style.display = 'inline-flex';

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('ota-upgrade-modal').style.display = 'flex';
            document.body.classList.add('modal-open');
        }

        function hideOtaUpgradeModal() {
            document.getElementById('ota-upgrade-modal').style.display = 'none';
            document.body.classList.remove('modal-open');
        }

        function startOtaUpgradeProcess() {
            const selectedDevices = Array.from(document.querySelectorAll('.device-checkbox:checked')).map(cb => cb.value);

            // éšè—å¼€å§‹æŒ‰é’®ï¼Œæ˜¾ç¤ºè¿›åº¦æ¡
            document.getElementById('ota-start-btn').style.display = 'none';
            document.getElementById('ota-cancel-btn').style.display = 'none';
            document.getElementById('ota-progress').style.display = 'block';

            // å¼€å§‹å‡çº§è¿‡ç¨‹
            simulateOtaUpgrade(selectedDevices);
        }

        function simulateOtaUpgrade(deviceIds) {
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            const upgradeStatus = document.getElementById('upgrade-status');
            const deviceItems = document.querySelectorAll('.device-item');

            let currentDevice = 0;
            let progress = 0;

            function updateProgress() {
                if (currentDevice < deviceIds.length) {
                    const device = devicesData.find(d => d.id === deviceIds[currentDevice]);
                    upgradeStatus.textContent = `æ­£åœ¨å‡çº§: ${device.name} (${device.id})`;

                    // æ›´æ–°å½“å‰è®¾å¤‡çŠ¶æ€
                    deviceItems[currentDevice].querySelector('.device-status-indicator').className = 'device-status-indicator upgrading';
                    deviceItems[currentDevice].querySelector('.device-status-indicator').textContent = 'å‡çº§ä¸­';

                    // æ¨¡æ‹Ÿè®¾å¤‡å‡çº§è¿›åº¦
                    const deviceProgress = setInterval(() => {
                        progress += Math.random() * 5 + 2; // éšæœºå¢åŠ è¿›åº¦

                        if (progress >= (currentDevice + 1) * (100 / deviceIds.length)) {
                            progress = (currentDevice + 1) * (100 / deviceIds.length);
                            clearInterval(deviceProgress);

                            // è®¾å¤‡å‡çº§å®Œæˆ
                            deviceItems[currentDevice].querySelector('.device-status-indicator').className = 'device-status-indicator completed';
                            deviceItems[currentDevice].querySelector('.device-status-indicator').textContent = 'å·²å®Œæˆ';

                            currentDevice++;

                            if (currentDevice < deviceIds.length) {
                                setTimeout(updateProgress, 500);
                            } else {
                                // æ‰€æœ‰è®¾å¤‡å‡çº§å®Œæˆ
                                upgradeStatus.textContent = 'å‡çº§å®Œæˆï¼æ‰€æœ‰è®¾å¤‡å·²æˆåŠŸå‡çº§ã€‚';
                                document.getElementById('ota-complete-btn').style.display = 'inline-flex';

                                // æ¸…é™¤é€‰æ‹©å¹¶ç½®ç°OTAæŒ‰é’®
                                setTimeout(() => {
                                    document.getElementById('select-all-devices').checked = false;
                                    document.querySelectorAll('.device-checkbox').forEach(cb => cb.checked = false);
                                    updateBatchActions(); // è¿™ä¼šé‡æ–°ç¦ç”¨OTAæŒ‰é’®
                                }, 1000);
                            }
                        }

                        progressFill.style.width = progress + '%';
                        progressText.textContent = Math.round(progress) + '%';
                    }, 100);
                }
            }

            updateProgress();
        }

        // è¯­è¨€ç³»ç»Ÿç”±å…¨å±€NavigationManagerå¤„ç†

        function updateLanguage(language) {
            const elements = document.querySelectorAll('[data-zh][data-en]');
            elements.forEach(element => {
                // Special handling for labels with required asterisk and label text
                if (element.tagName === 'LABEL' && element.querySelector('.label-text')) {
                    const labelTextSpan = element.querySelector('.label-text');
                    const newText = language === 'zh' ? element.getAttribute('data-zh') : element.getAttribute('data-en');
                    // Update only the label text span, keeping the asterisk
                    labelTextSpan.textContent = newText.replace('*', '');
                } else {
                    // Normal handling for other elements
                    if (language === 'zh') {
                        element.textContent = element.getAttribute('data-zh');
                    } else {
                        element.textContent = element.getAttribute('data-en');
                    }
                }
            });

            // å¼ºåˆ¶ç¿»è¯‘æ‰€æœ‰é™æ€æ–‡æœ¬
            forceTranslateStaticText();

            // é‡æ–°æ¸²æŸ“è¡¨æ ¼ä»¥åº”ç”¨æ–°è¯­è¨€
            renderDevicesTable();
        }

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å¼€å§‹');

            // è¯­è¨€ç³»ç»Ÿç”±å…¨å±€NavigationManagerå¤„ç†ï¼Œæ— éœ€é¢å¤–åˆå§‹åŒ–
            console.log('ä½¿ç”¨å…¨å±€è¯­è¨€ç®¡ç†ç³»ç»Ÿ');

            // ç¡®è®¤æ•°æ®å­˜åœ¨
            console.log('è®¾å¤‡æ•°æ®é•¿åº¦:', devicesData.length);
            console.log('è®¾å¤‡æ•°æ®:', devicesData);

            // æµ‹è¯•DOMæ˜¯å¦å­˜åœ¨
            const tbody = document.getElementById('devices-tbody');
            console.log('è¡¨æ ¼tbody:', tbody);
            if (tbody) {
                console.log('tbodyå­˜åœ¨ï¼Œå¼€å§‹æ¸²æŸ“');
                // æ›´æ–°è®¾å¤‡çŠ¶æ€ç»Ÿè®¡
                updateDeviceTabCounts();
                // åˆå§‹åŒ–æ˜¾ç¤ºæœªè¿æ¥è®¾å¤‡
                filterDevicesByStatus('unconnected');
            } else {
                console.error('æ— æ³•æ‰¾åˆ°devices-tbodyå…ƒç´ ');
            }

            // ç„¶åå¼ºåˆ¶ç¿»è¯‘é™æ€æ–‡æœ¬
            setTimeout(forceTranslateStaticText, 50);

            // åˆå§‹åŒ–æ—¶è®¾ç½®OTAæŒ‰é’®ä¸ºç¦ç”¨çŠ¶æ€
            updateBatchActions();

            // åˆ†é¡µäº‹ä»¶
            document.getElementById('prev-page').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderDevicesTable();
                }
            });

            document.getElementById('next-page').addEventListener('click', () => {
                const totalPages = Math.ceil(filteredDevices.length / 10);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderDevicesTable();
                }
            });

            console.log('é¡µé¢åˆå§‹åŒ–å®Œæˆ');

            // å»¶è¿Ÿæ£€æŸ¥è¡¨æ ¼æ˜¯å¦æœ‰æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰åˆ™å¼ºåˆ¶æ˜¾ç¤º
            setTimeout(function() {
                const tbody = document.getElementById('devices-tbody');
                if (tbody && (!tbody.innerHTML || tbody.innerHTML.trim() === '')) {
                    console.log('è¡¨æ ¼ä¸ºç©ºï¼Œå¼ºåˆ¶æ˜¾ç¤ºè®¾å¤‡æ•°æ®');
                    // ç›´æ¥è°ƒç”¨ä¸€æ¬¡æ¸²æŸ“å‡½æ•°
                    renderDevicesTable();

                    // å¦‚æœè¿˜æ˜¯æ²¡æœ‰æ•°æ®ï¼Œæ‰‹åŠ¨æ’å…¥ä¸€äº›ç¤ºä¾‹æ•°æ®
                    setTimeout(function() {
                        if (!tbody.innerHTML || tbody.innerHTML.trim() === '') {
                            tbody.innerHTML = `
                                <tr>
                                    <td><input type="checkbox" class="device-checkbox"></td>
                                    <td>MTR001</td>
                                    <td>1å·æ¥¼ä¸»ç”µè¡¨</td>
                                    <td>ä¸‰ç›¸ç”µè¡¨</td>
                                    <td>building-1</td>
                                    <td><span class="status-online">åœ¨çº¿</span></td>
                                    <td>
                                        <button class="btn-sm btn-primary" onclick="editDevice('MTR001')">ç¼–è¾‘</button>
                                        <button class="btn-sm btn-danger" onclick="deleteDevice('MTR001')">åˆ é™¤</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" class="device-checkbox"></td>
                                    <td>MTR002</td>
                                    <td>2å·æ¥¼ä¸»ç”µè¡¨</td>
                                    <td>å•ç›¸ç”µè¡¨</td>
                                    <td>building-2</td>
                                    <td><span class="status-offline">ç¦»çº¿</span></td>
                                    <td>
                                        <button class="btn-sm btn-primary" onclick="editDevice('MTR002')">ç¼–è¾‘</button>
                                        <button class="btn-sm btn-danger" onclick="deleteDevice('MTR002')">åˆ é™¤</button>
                                    </td>
                                </tr>
                            `;
                            console.log('å·²å¼ºåˆ¶æ˜¾ç¤ºè®¾å¤‡æ•°æ®');
                        }
                    }, 500);
                }
            }, 1000);
        });
    </script>

    <script>
        // æ·»åŠ è®¾å¤‡ç®¡ç†é¡µé¢ç‰¹æœ‰æ ·å¼ - ä¸bills.htmlä¿æŒä¸€è‡´
        const style = document.createElement('style');
        style.textContent = `
            /* å¯¼èˆªæ æ ·å¼ - è¦†ç›–common.css */
            .navbar {
                height: 56px !important;
                overflow: hidden !important;
                background: rgba(255, 255, 255, 0.8) !important;
                backdrop-filter: blur(20px) !important;
                border-bottom: var(--border) !important;
                position: sticky !important;
                top: 0 !important;
                z-index: 1000 !important;
            }

            .nav-content {
                display: flex !important;
                align-items: center !important;
                justify-content: space-between !important;
                padding: 12px 20px !important;
                gap: 15px !important;
                height: 100% !important;
                max-width: none !important;
                margin: 0 !important;
            }

            .nav-brand {
                display: flex !important;
                align-items: center !important;
                flex-shrink: 0 !important;
            }

            .nav-menu {
                flex: 1 !important;
                display: flex !important;
                justify-content: center !important;
            }

            .nav-actions {
                display: flex !important;
                align-items: center !important;
                gap: 15px !important;
            }

            .nav-logo {
                height: 32px !important;
                max-width: 150px !important;
                object-fit: contain !important;
                transition: all 0.2s ease !important;
            }

            .nav-logo:hover {
                transform: scale(1.02) !important;
            }

            /* å¸ƒå±€ç³»ç»Ÿ */
            .content-layout {
                display: flex;
                max-width: 1600px;
                margin: 0 auto;
                padding: var(--space-12) var(--space-8);
                gap: var(--space-6);
            }

            .main-container {
                flex: 1;
                min-width: 0;
                padding-top: 0;
            }

            /* æœç´¢åŒºåŸŸæ ·å¼ */
            .search-section {
                background: var(--background);
                border: var(--border);
                border-radius: var(--radius);
                padding: var(--space-6);
                margin-bottom: var(--space-6);
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: var(--space-4);
            }

            .search-controls {
                display: flex;
                gap: var(--space-4);
                flex: 1;
            }

            .search-controls .form-input {
                min-width: 300px;
            }

            .search-actions {
                display: flex;
                gap: var(--space-3);
            }

            .actions {
                display: flex;
                gap: var(--space-2);
                flex-wrap: wrap;
            }


            /* è¯­è¨€ä¸‹æ‹‰åˆ—è¡¨æ ·å¼ */
            .lang-dropdown {
                display: flex;
                align-items: center;
            }

            .lang-select {
                min-width: 100px;
                padding: var(--space-2) var(--space-3);
                border: var(--border);
                border-radius: var(--radius);
                background: var(--background);
                font-size: 14px;
                font-weight: var(--font-weight-medium);
                cursor: pointer;
                transition: all 0.15s ease;
            }

            .lang-select:focus {
                outline: 2px solid var(--accent);
                outline-offset: -2px;
            }

            .lang-select:hover {
                background: var(--surface);
            }

            .pagination {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: var(--space-4);
                padding: var(--space-6);
                background: var(--surface);
                border-top: var(--border);
            }

            .page-info {
                font-size: 14px;
                color: var(--text-secondary);
            }

            .actions {
                display: flex;
                gap: var(--space-2);
            }

            .btn-sm {
                padding: var(--space-1) var(--space-2);
                font-size: 12px;
            }

            /* è®¾å¤‡çŠ¶æ€æ ·å¼ */
            .device-status {
                padding: var(--space-1) var(--space-2);
                border-radius: calc(var(--radius) / 2);
                font-size: 12px;
                font-weight: var(--font-weight-medium);
                display: inline-block;
                min-width: 48px;
                text-align: center;
            }

            .status-online {
                background: rgba(40, 167, 69, 0.1);
                color: var(--success);
            }

            .status-offline {
                background: rgba(255, 149, 0, 0.1);
                color: var(--warning);
            }

            .status-error {
                background: rgba(220, 53, 69, 0.1);
                color: var(--error);
            }

            .btn-danger {
                background: #dc2626;
                color: white;
                border: 1px solid #dc2626;
            }

            .btn-danger:hover {
                background: #b91c1c;
                border-color: #b91c1c;
            }

            .btn-success {
                background: var(--primary);
                color: white;
                border: 1px solid var(--primary);
            }

            .btn-success:hover {
                background: #333333;
                border-color: #333333;
                transform: translateY(-1px);
                box-shadow: var(--shadow-hover);
            }

            /* åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†æ ·å¼ */
            .modal:has(.delete-confirm-modal) {
                justify-content: center !important;
                align-items: center !important;
            }

            .delete-confirm-modal {
                width: 400px !important;
                height: auto !important;
                max-width: 90vw;
                animation: modalSlideIn 0.3s ease-out !important;
                border-radius: var(--radius) !important;
            }

            /* OTAå‡çº§æ¨¡æ€æ¡†å±…ä¸­ */
            .modal:has(.ota-upgrade-modal) {
                justify-content: center !important;
                align-items: center !important;
            }

            .delete-warning {
                color: var(--text-secondary);
                font-size: 14px;
                margin-top: 8px;
                font-style: italic;
            }

            /* å³æŠ½å±‰æ ·å¼ */
            .modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(8px);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: flex-end;
                padding: 0;
                overflow: hidden;
            }

            /* é˜²æ­¢èƒŒæ™¯é¡µé¢æ»šåŠ¨ */
            body.modal-open {
                overflow: hidden;
            }

            .modal[style*="flex"] {
                display: flex !important;
            }

            .modal-overlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.3);
                z-index: -1;
            }

            .modal-content {
                background: var(--background);
                border-radius: 0;
                box-shadow: -10px 0 30px rgba(0, 0, 0, 0.3);
                width: 500px;
                height: 100vh;
                overflow: hidden;
                position: relative;
                z-index: 1;
                animation: drawerSlideIn 0.3s ease-out;
                display: flex;
                flex-direction: column;
            }

            @keyframes drawerSlideIn {
                from {
                    opacity: 0;
                    transform: translateX(100%);
                }
                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }

            .modal-header {
                padding: 24px 32px;
                background: var(--background);
                color: var(--text-primary);
                border-radius: 0;
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: var(--border);
                flex-shrink: 0;
            }

            .modal-header h3 {
                margin: 0;
                font-size: 20px;
                font-weight: 600;
                color: var(--text-primary);
            }

            .modal-close {
                background: none;
                border: none;
                color: var(--text-secondary);
                font-size: 24px;
                font-weight: bold;
                cursor: pointer;
                padding: 8px;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s ease;
            }

            .modal-close:hover {
                background: var(--surface);
                color: var(--text-primary);
                transform: scale(1.1);
            }

            .modal-body {
                padding: 32px;
                flex: 1;
                overflow-y: auto;
            }

            .modal-footer {
                padding: 20px 32px;
                background: var(--surface);
                border-top: var(--border);
                display: flex;
                justify-content: flex-end;
                gap: 12px;
                border-radius: 0;
                flex-shrink: 0;
            }

            /* è¡¨å•æ ·å¼ */
            .device-form {
                display: flex;
                flex-direction: column;
                gap: 16px;
            }

            .form-section {
                background: var(--surface);
                border: var(--border);
                border-radius: var(--radius);
                padding: 24px;
                position: relative;
            }

            .section-title {
                margin: 0 0 20px 0;
                font-size: 16px;
                font-weight: 600;
                color: var(--text-primary);
                display: flex;
                align-items: center;
                gap: 8px;
                padding-bottom: 8px;
                border-bottom: 2px solid var(--primary);
            }

            .section-title::before {
                content: '';
                width: 4px;
                height: 16px;
                background: var(--primary);
                border-radius: 2px;
            }

            .form-row {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 12px;
                margin-bottom: 12px;
            }

            .form-row:last-child {
                margin-bottom: 0;
            }

            .form-group {
                display: flex;
                flex-direction: column;
                gap: 4px;
            }

            .form-group.full-width {
                grid-column: 1 / -1;
            }

            .form-group label {
                font-size: 14px;
                font-weight: 500;
                color: var(--text-primary);
                display: flex;
                align-items: center;
                gap: 4px;
            }

            .form-group label .required {
                color: red !important;
            }

            /* Force red asterisks - override all inheritance and dark mode */
            .required,
            span[style*="color: red"],
            span[style*="color:red"],
            label span[style*="color: red"],
            label span[style*="color:red"] {
                color: #FF0000 !important;
                font-weight: bold !important;
                margin-right: 4px !important;
                display: inline-block !important;
                font-size: 16px !important;
            }

            /* Additional high-specificity rule for asterisks in dark mode */
            @media (prefers-color-scheme: dark) {
                .required,
                span[style*="color: red"],
                span[style*="color:red"],
                label span[style*="color: red"],
                label span[style*="color:red"] {
                    color: #FF3333 !important;
                }
            }

            /* Ultimate red asterisk override - maximum specificity */
            html body .modal-content .modal-body .device-form .form-group label .required,
            html body .modal-content .modal-body .device-form .form-group label .asterisk-red,
            html body .modal-content .modal-body .device-form .form-group label span.required,
            html body .modal-content .modal-body .device-form .form-group label span.asterisk-red,
            html body .device-form .form-group label .required,
            html body .device-form .form-group label .asterisk-red,
            html body .form-group label .required,
            html body .form-group label .asterisk-red,
            .asterisk-red {
                color: #DC143C !important;
                font-weight: bold !important;
                margin-right: 4px !important;
                display: inline-block !important;
                font-size: 16px !important;
                text-shadow: none !important;
                filter: none !important;
                opacity: 1 !important;
            }

            /* Dark mode specific override with even higher specificity */
            @media (prefers-color-scheme: dark) {
                html body .modal-content .modal-body .device-form .form-group label .required,
                html body .modal-content .modal-body .device-form .form-group label .asterisk-red,
                html body .modal-content .modal-body .device-form .form-group label span.required,
                html body .modal-content .modal-body .device-form .form-group label span.asterisk-red,
                html body .device-form .form-group label .required,
                html body .device-form .form-group label .asterisk-red,
                html body .form-group label .required,
                html body .form-group label .asterisk-red,
                .asterisk-red {
                    color: #FF4444 !important;
                    font-weight: bold !important;
                    text-shadow: 0 0 1px rgba(255, 68, 68, 0.8) !important;
                }
            }

            .form-input,
            .form-select,
            .form-textarea {
                padding: 12px 16px;
                border: var(--border);
                border-radius: var(--radius);
                background: var(--background);
                color: var(--text-primary);
                font-size: 14px;
                transition: all 0.2s ease;
                outline: none;
                font-family: inherit;
                width: 100%;
                display: block;
            }

            .form-input:focus,
            .form-select:focus,
            .form-textarea:focus {
                border-color: var(--primary);
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
                background: var(--background);
            }

            .form-input:hover,
            .form-select:hover {
                border-color: var(--accent);
            }

            .form-textarea {
                resize: vertical;
                min-height: 80px;
                font-family: inherit;
                line-height: 1.5;
            }

            .form-input::placeholder,
            .form-textarea::placeholder {
                color: var(--text-secondary);
                opacity: 0.7;
            }

            .form-hint {
                font-size: 12px;
                color: var(--text-secondary);
                margin-top: 4px;
                font-style: italic;
            }


            /* æŒ‰é’®æ ·å¼ - ä¸bills.htmlä¿æŒä¸€è‡´ */
            .btn {
                padding: var(--space-2) var(--space-4);
                border: none;
                border-radius: var(--radius);
                font-family: inherit;
                font-size: 14px;
                font-weight: var(--font-weight-medium);
                cursor: pointer;
                transition: all 0.15s ease;
                text-decoration: none;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: var(--space-2);
            }

            .btn-primary {
                background: var(--primary);
                color: white;
            }

            .btn-primary:hover {
                transform: translateY(-1px);
                box-shadow: var(--shadow-hover);
            }

            .btn-secondary {
                background: var(--surface);
                color: var(--text-primary);
                border: var(--border);
            }

            .btn-secondary:hover {
                background: var(--divider);
            }


            /* è¡¨æ ¼å¤´éƒ¨æ ·å¼ */
            .table-header {
                background: var(--background);
                border: var(--border);
                border-bottom: none;
                border-radius: var(--radius) var(--radius) 0 0;
                padding: var(--space-4) var(--space-6);
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 0;
            }

            .table-actions-left {
                display: flex;
                gap: var(--space-3);
            }

            .table-actions-right {
                display: flex;
                align-items: center;
                gap: var(--space-4);
            }

            .selected-count {
                font-size: 14px;
                color: var(--text-secondary);
                font-weight: var(--font-weight-medium);
            }

            /* ç¦ç”¨æŒ‰é’®æ ·å¼ */
            .btn-disabled {
                background: #cccccc !important;
                color: #666666 !important;
                border: 1px solid #999999 !important;
                cursor: not-allowed !important;
                opacity: 1 !important;
            }

            .btn-disabled:hover {
                background: #cccccc !important;
                color: #666666 !important;
                border: 1px solid #999999 !important;
                transform: none !important;
                box-shadow: none !important;
            }

            /* OTAå‡çº§æ¨¡æ€æ¡†æ ·å¼ */
            .ota-upgrade-modal {
                width: 600px !important;
                height: auto !important;
                max-width: 90vw;
                animation: modalSlideIn 0.3s ease-out !important;
                border-radius: var(--radius) !important;
            }

            .ota-info {
                margin-bottom: var(--space-6);
            }

            .ota-info h4 {
                margin: 0 0 var(--space-4) 0;
                color: var(--text-primary);
                font-size: 16px;
                font-weight: 600;
            }

            .device-list {
                background: var(--surface);
                border: var(--border);
                border-radius: var(--radius);
                padding: var(--space-4);
                max-height: 200px;
                overflow-y: auto;
            }

            .device-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: var(--space-3);
                border-bottom: var(--border);
                font-size: 14px;
            }

            .device-item:last-child {
                border-bottom: none;
            }

            .device-id {
                font-weight: 600;
                color: var(--text-primary);
                min-width: 80px;
            }

            .device-name {
                flex: 1;
                color: var(--text-secondary);
                margin: 0 var(--space-3);
            }

            .device-status-indicator {
                padding: var(--space-1) var(--space-2);
                border-radius: calc(var(--radius) / 2);
                font-size: 12px;
                font-weight: 500;
                min-width: 60px;
                text-align: center;
            }

            .device-status-indicator.waiting {
                background: rgba(255, 149, 0, 0.1);
                color: var(--warning);
            }

            .device-status-indicator.upgrading {
                background: rgba(59, 130, 246, 0.1);
                color: var(--primary);
                animation: pulse 1.5s infinite;
            }

            .device-status-indicator.completed {
                background: rgba(40, 167, 69, 0.1);
                color: var(--success);
            }

            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.6; }
            }

            .ota-progress {
                margin: var(--space-6) 0;
            }

            .ota-progress h4 {
                margin: 0 0 var(--space-4) 0;
                color: var(--text-primary);
                font-size: 16px;
                font-weight: 600;
            }

            .progress-container {
                display: flex;
                align-items: center;
                gap: var(--space-3);
                margin-bottom: var(--space-4);
            }

            .progress-bar {
                flex: 1;
                height: 8px;
                background: var(--divider);
                border-radius: 4px;
                overflow: hidden;
            }

            .progress-fill {
                height: 100%;
                background: var(--primary);
                border-radius: 4px;
                transition: width 0.3s ease;
                width: 0%;
            }

            .progress-text {
                font-weight: 600;
                color: var(--text-primary);
                min-width: 40px;
                text-align: right;
            }

            .upgrade-status {
                padding: var(--space-3);
                background: var(--surface);
                border: var(--border);
                border-radius: var(--radius);
                font-size: 14px;
                color: var(--text-secondary);
                text-align: center;
            }

            .ota-warning {
                background: rgba(255, 149, 0, 0.1);
                border: 1px solid rgba(255, 149, 0, 0.3);
                border-radius: var(--radius);
                padding: var(--space-4);
                margin-top: var(--space-6);
            }

            .ota-warning p {
                margin: 0 0 var(--space-3) 0;
                font-weight: 600;
                color: var(--warning);
            }

            .ota-warning ul {
                margin: 0;
                padding-left: var(--space-5);
                color: var(--text-secondary);
            }

            .ota-warning li {
                margin-bottom: var(--space-2);
                font-size: 14px;
            }

            .table-container {
                background: var(--background);
                border: var(--border);
                border-radius: var(--radius);
                overflow: hidden;
                margin-bottom: var(--space-6);
            }

            .table-container .table {
                border: none;
                margin: 0;
            }

            /* å“åº”å¼è®¾è®¡ */
            @media (max-width: 1200px) {
                .content-layout {
                    flex-direction: column;
                }
            }

            @media (max-width: 768px) {
                .content-layout {
                    padding: var(--space-8) var(--space-4);
                }

                .search-section {
                    flex-direction: column;
                    align-items: stretch;
                }

                .search-controls {
                    flex-direction: column;
                }

                .search-controls .form-input {
                    min-width: auto;
                }

                .actions {
                    flex-direction: column;
                }

                .modal {
                    padding: 0;
                }

                .modal-content {
                    width: 100%;
                    height: 100%;
                    animation: drawerSlideUp 0.3s ease-out;
                }

                @keyframes drawerSlideUp {
                    from {
                        opacity: 0;
                        transform: translateY(100%);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }

                .modal-header,
                .modal-body,
                .modal-footer {
                    padding: 20px;
                }

                .form-row {
                    grid-template-columns: 1fr;
                    gap: 16px;
                }

                .form-section {
                    padding: 16px;
                }
            }
            /* ä½ç½®é€‰æ‹©å™¨æ ·å¼ */
            .location-selector {
                display: flex;
                gap: 8px;
                align-items: center;
            }

            .location-selector select {
                flex: 1;
                min-width: 120px;
            }

            @media (max-width: 768px) {
                .location-selector {
                    flex-direction: column;
                    gap: 8px;
                }

                .location-selector select {
                    width: 100%;
                }
            }

            /* è®¾å¤‡çŠ¶æ€æ ‡ç­¾é¡µæ ·å¼ */
            .device-tabs {
                display: flex;
                background: var(--surface);
                border-bottom: var(--border);
                padding: var(--space-4) var(--space-6);
                margin: 0;
                gap: var(--space-2);
                border-radius: var(--radius) var(--radius) 0 0;
            }

            .device-tab {
                display: flex;
                align-items: center;
                gap: var(--space-2);
                padding: var(--space-2) var(--space-4);
                background: transparent;
                border: none;
                border-radius: var(--radius);
                color: var(--text-secondary);
                font-size: 14px;
                font-weight: var(--font-weight-medium);
                cursor: pointer;
                transition: all 0.15s ease;
                white-space: nowrap;
                position: relative;
            }

            .device-tab:hover {
                background: var(--hover);
                color: var(--text-primary);
            }

            .device-tab.active {
                background: var(--background);
                color: var(--primary);
                font-weight: var(--font-weight-semibold);
            }

            .device-tab.active::after {
                content: '';
                position: absolute;
                bottom: -1px;
                left: 0;
                right: 0;
                height: 2px;
                background: var(--primary);
                border-radius: 1px;
            }

            .device-tab.active:hover {
                background: var(--background);
                color: var(--primary);
            }

            .tab-count {
                font-size: 13px;
                font-weight: var(--font-weight-normal);
                opacity: 0.8;
            }

            /* å“åº”å¼è®¾è®¡ */
            @media (max-width: 768px) {
                .device-tabs {
                    flex-wrap: wrap;
                    gap: var(--space-2);
                }

                .device-tab {
                    flex: 1;
                    min-width: 0;
                    justify-content: center;
                    padding: var(--space-2) var(--space-3);
                    font-size: 13px;
                }
            }

            /* æŒ‰é’®æ ·å¼è¡¥å…… - åŒ¹é…å›¾ç‰‡é¢œè‰² */
            .btn-primary {
                background: #f5f5f5 !important;
                color: #333333 !important;
                border: 1px solid #e0e0e0 !important;
            }

            .btn-primary:hover {
                background: #ebebeb !important;
                border-color: #d0d0d0 !important;
                color: #333333 !important;
            }

            .btn-info {
                background: #000000 !important;
                color: white !important;
                border: 1px solid #000000 !important;
            }

            .btn-info:hover {
                background: #333333 !important;
                border-color: #333333 !important;
            }

            .btn-danger {
                background: #c53030 !important;
                color: white !important;
                border: 1px solid #c53030 !important;
            }

            .btn-danger:hover {
                background: #b91c1c !important;
                border-color: #b91c1c !important;
            }

            /* çŠ¶æ€æ ·å¼ */
            .status-online {
                color: var(--success);
                font-weight: var(--font-weight-medium);
            }

            .status-offline {
                color: var(--error);
                font-weight: var(--font-weight-medium);
            }

            .status-unconnected {
                color: #6b7280;
                font-weight: var(--font-weight-medium);
            }

            .status-connected-unbound {
                color: #f59e0b;
                font-weight: var(--font-weight-medium);
            }

            .status-bound {
                color: var(--success);
                font-weight: var(--font-weight-medium);
            }
        `;
        document.head.appendChild(style);

        // ä½ç½®æ ‘ç»“æ„æ•°æ®
        const locationData = {
            buildings: [
                {
                    id: 'BUILDING001',
                    name: 'Aæ ‹',
                    nameEn: 'Building A',
                    floors: [
                        {
                            id: 'FLOOR001',
                            number: '1',
                            rooms: [
                                { id: 'ROOM001', number: 'A-101' },
                                { id: 'ROOM002', number: 'A-102' },
                                { id: 'ROOM003', number: 'A-103' }
                            ]
                        },
                        {
                            id: 'FLOOR002',
                            number: '2',
                            rooms: [
                                { id: 'ROOM004', number: 'A-201' },
                                { id: 'ROOM005', number: 'A-202' }
                            ]
                        }
                    ]
                },
                {
                    id: 'BUILDING002',
                    name: 'Bæ ‹',
                    nameEn: 'Building B',
                    floors: [
                        {
                            id: 'FLOOR003',
                            number: '1',
                            rooms: [
                                { id: 'ROOM006', number: 'B-101' },
                                { id: 'ROOM007', number: 'B-102' }
                            ]
                        },
                        {
                            id: 'FLOOR004',
                            number: '2',
                            rooms: [
                                { id: 'ROOM008', number: 'B-201' }
                            ]
                        }
                    ]
                }
            ]
        };

        // åˆå§‹åŒ–æ¥¼æ ‹é€‰æ‹©å™¨
        function initializeDeviceBuildingOptions() {
            const buildingSelect = document.getElementById('device-building');
            const lang = getCurrentLanguage();

            buildingSelect.innerHTML = `<option value="">${lang === 'en' ? 'Select Building' : 'è¯·é€‰æ‹©æ¥¼æ ‹'}</option>`;

            locationData.buildings.forEach(building => {
                const option = document.createElement('option');
                option.value = building.id;
                option.textContent = lang === 'en' ? building.nameEn : building.name;
                buildingSelect.appendChild(option);
            });
        }

        // æ›´æ–°æ¥¼å±‚é€‰æ‹©å™¨
        function updateDeviceFloorOptions() {
            const buildingSelect = document.getElementById('device-building');
            const floorSelect = document.getElementById('device-floor');
            const roomSelect = document.getElementById('device-room');
            const lang = getCurrentLanguage();

            const selectedBuildingId = buildingSelect.value;

            // é‡ç½®æ¥¼å±‚å’Œæˆ¿é—´é€‰æ‹©å™¨
            floorSelect.innerHTML = '';
            roomSelect.innerHTML = '';
            roomSelect.disabled = true;

            if (!selectedBuildingId) {
                floorSelect.disabled = true;
                floorSelect.innerHTML = `<option value="">${lang === 'en' ? 'Select Building First' : 'è¯·å…ˆé€‰æ‹©æ¥¼æ ‹'}</option>`;
                roomSelect.innerHTML = `<option value="">${lang === 'en' ? 'Select Floor First' : 'è¯·å…ˆé€‰æ‹©æ¥¼å±‚'}</option>`;
                return;
            }

            // æ‰¾åˆ°é€‰ä¸­çš„æ¥¼æ ‹
            const building = locationData.buildings.find(b => b.id === selectedBuildingId);
            if (!building) return;

            // å¯ç”¨æ¥¼å±‚é€‰æ‹©å™¨å¹¶å¡«å……é€‰é¡¹
            floorSelect.disabled = false;
            floorSelect.innerHTML = `<option value="">${lang === 'en' ? 'Select Floor' : 'è¯·é€‰æ‹©æ¥¼å±‚'}</option>`;

            building.floors.forEach(floor => {
                const option = document.createElement('option');
                option.value = floor.id;
                option.textContent = floor.number + (lang === 'en' ? 'F' : 'æ¥¼');
                floorSelect.appendChild(option);
            });

            roomSelect.innerHTML = `<option value="">${lang === 'en' ? 'Select Floor First' : 'è¯·å…ˆé€‰æ‹©æ¥¼å±‚'}</option>`;
        }

        // æ›´æ–°æˆ¿é—´é€‰æ‹©å™¨
        function updateDeviceRoomOptions() {
            const floorSelect = document.getElementById('device-floor');
            const roomSelect = document.getElementById('device-room');
            const lang = getCurrentLanguage();

            const selectedFloorId = floorSelect.value;

            // é‡ç½®æˆ¿é—´é€‰æ‹©å™¨
            roomSelect.innerHTML = '';

            if (!selectedFloorId) {
                roomSelect.disabled = true;
                roomSelect.innerHTML = `<option value="">${lang === 'en' ? 'Select Floor First' : 'è¯·å…ˆé€‰æ‹©æ¥¼å±‚'}</option>`;
                return;
            }

            // æ‰¾åˆ°é€‰ä¸­çš„æ¥¼å±‚
            const floor = locationData.buildings
                .flatMap(b => b.floors)
                .find(f => f.id === selectedFloorId);

            if (!floor) return;

            // å¯ç”¨æˆ¿é—´é€‰æ‹©å™¨å¹¶å¡«å……é€‰é¡¹
            roomSelect.disabled = false;
            roomSelect.innerHTML = `<option value="">${lang === 'en' ? 'Select Room' : 'è¯·é€‰æ‹©æˆ¿é—´'}</option>`;

            floor.rooms.forEach(room => {
                const option = document.createElement('option');
                option.value = room.id;
                option.textContent = room.number;
                roomSelect.appendChild(option);
            });
        }

        // ä¿®æ”¹showAddDeviceModalå‡½æ•°ä»¥åˆå§‹åŒ–ä½ç½®é€‰æ‹©å™¨
        const originalShowAddDeviceModal = showAddDeviceModal;
        showAddDeviceModal = function() {
            originalShowAddDeviceModal();
            initializeDeviceBuildingOptions();

            // é‡ç½®æ‰€æœ‰é€‰æ‹©å™¨
            document.getElementById('device-building').value = '';
            document.getElementById('device-floor').disabled = true;
            document.getElementById('device-room').disabled = true;
            document.getElementById('device-floor').innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©æ¥¼æ ‹</option>';
            document.getElementById('device-room').innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©æ¥¼å±‚</option>';
        };

        // æ·»åŠ è¯­è¨€åˆ‡æ¢äº‹ä»¶ç›‘å¬å™¨
        window.addEventListener('languageChanged', function(event) {
            console.log('Language changed to:', event.detail.language);

            // é‡æ–°ç¿»è¯‘é™æ€æ–‡æœ¬
            forceTranslateStaticText();

            // é‡æ–°æ¸²æŸ“è®¾å¤‡åˆ—è¡¨
            renderDevicesTable();

            // æ›´æ–°æ‰¹é‡æ“ä½œæ–‡æœ¬
            updateBatchActions();

            // é‡æ–°åˆå§‹åŒ–ä½ç½®é€‰æ‹©å™¨ï¼ˆå¦‚æœæ¨¡æ€æ¡†å·²æ‰“å¼€ï¼‰
            const modal = document.getElementById('device-modal');
            if (modal && modal.style.display === 'flex') {
                initializeDeviceBuildingOptions();
            }

            // æ›´æ–°æœç´¢æ¡†placeholder
            const searchInput = document.getElementById('device-search');
            if (searchInput) {
                const lang = getCurrentLanguage();
                searchInput.placeholder = lang === 'en' ? 'Device ID/Name/Location...' : 'è®¾å¤‡ID/åç§°/ä½ç½®...';
            }
        });

    </script>

</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-zh="用户管理" data-en="User Management">用户管理</title>
    <link rel="stylesheet" href="assets/css/common.css">
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-brand">
                <h1 data-zh="能源管理系统" data-en="Energy Management System">能源管理系统</h1>
            </div>
            <div class="nav-menu">
                <a href="dashboard.html" class="nav-link" data-zh="仪表盘" data-en="Dashboard">仪表盘</a>
                <a href="device-management.html" class="nav-link" data-zh="设备管理" data-en="Device Management">设备管理</a>
                <a href="space-management.html" class="nav-link" data-zh="建筑管理" data-en="Building Management">建筑管理</a>
                <a href="user-management.html" class="nav-link active" data-zh="用户管理" data-en="User Management">用户管理</a>
                <a href="bills.html" class="nav-link" data-zh="账单管理" data-en="Bill Management">账单管理</a>
            </div>
            <div class="nav-actions" style="overflow: visible !important;">
                <div class="lang-dropdown">
                    <select id="language-select" class="form-select lang-select">
                        <option value="zh" data-zh="中文" data-en="Chinese">中文</option>
                        <option value="en" data-zh="English" data-en="English">English</option>
                    </select>
                </div>
                <div class="user-menu" style="position: relative; overflow: visible !important;">
                    <input type="checkbox" id="user-dropdown-toggle" style="display: none;">
                    <label for="user-dropdown-toggle" style="display: flex; align-items: center; cursor: pointer; gap: 8px;">
                        <div class="user-avatar">管</div>
                        <span data-zh="管理员" data-en="Admin">管理员</span>
                        <span style="font-size: 12px; margin-left: 4px;">▼</span>
                    </label>
                    <div class="dropdown-menu" style="position: fixed; top: 64px; right: 20px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); min-width: 120px; display: none; z-index: 9999; padding: 4px 0;">
                        <label for="logout-confirm-toggle" style="display: flex; align-items: center; padding: 12px 16px; color: #dc2626; font-size: 14px; cursor: pointer; gap: 8px;">
                            <span style="font-size: 16px;">🚪</span>
                            <span data-zh="退出登录" data-en="Logout">退出登录</span>
                        </label>
                    </div>
                </div>
                <style>
                    #user-dropdown-toggle:checked + label + .dropdown-menu { display: block !important; }
                    #logout-confirm-toggle:checked + .logout-modal { display: flex !important; }
                </style>
            </div>
        </div>
    </nav>

    <!-- 退出确认弹窗 -->
    <input type="checkbox" id="logout-confirm-toggle" style="display: none;">
    <div class="logout-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: none; z-index: 99999; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; padding: 32px; max-width: 420px; width: 90%; box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);">
            <div style="text-align: center; font-size: 48px; margin-bottom: 20px;">⚠️</div>
            <h3 style="text-align: center; font-size: 20px; font-weight: 600; color: #1f2937; margin: 0 0 12px 0;">确认退出</h3>
            <p style="text-align: center; color: #6b7280; font-size: 16px; margin: 0 0 28px 0;">您确定要退出登录吗？退出后需要重新输入用户名和密码。</p>
            <div style="display: flex; gap: 12px; justify-content: center;">
                <label for="logout-confirm-toggle" style="padding: 12px 24px; background: #f3f4f6; color: #374151; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; min-width: 80px; text-align: center;">取消</label>
                <a href="index.html" style="padding: 12px 24px; background: #dc2626; color: white; border-radius: 8px; text-decoration: none; font-size: 14px; font-weight: 500; min-width: 80px; text-align: center;">确认退出</a>
            </div>
        </div>
    </div>

    <!-- 主内容区域 -->
    <main class="main-content">
        <div class="container">
            <!-- 页面标题 -->
            <div class="page-header">
                <h2 data-zh="用户管理" data-en="User Management">用户管理</h2>
                <p data-zh="管理系统用户信息和账户状态" data-en="Manage system users and account status">管理系统用户信息和账户状态</p>
            </div>

            <!-- 用户统计卡片 -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-icon">👥</div>
                    <div class="metric-content">
                        <div class="metric-value">2,847</div>
                        <div class="metric-label" data-zh="总用户数" data-en="Total Users">总用户数</div>
                        <div class="metric-change positive">
                            <span>+12%</span>
                            <span data-zh="较上月" data-en="vs last month">较上月</span>
                        </div>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-icon">✅</div>
                    <div class="metric-content">
                        <div class="metric-value">2,715</div>
                        <div class="metric-label" data-zh="活跃用户" data-en="Active Users">活跃用户</div>
                        <div class="metric-change positive">
                            <span>+8.3%</span>
                            <span data-zh="较上月" data-en="vs last month">较上月</span>
                        </div>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-icon">🆕</div>
                    <div class="metric-content">
                        <div class="metric-value">156</div>
                        <div class="metric-label" data-zh="本月新增" data-en="New This Month">本月新增</div>
                        <div class="metric-change positive">
                            <span>+23%</span>
                            <span data-zh="较上月" data-en="vs last month">较上月</span>
                        </div>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-icon">⚠️</div>
                    <div class="metric-content">
                        <div class="metric-value">132</div>
                        <div class="metric-label" data-zh="待审核" data-en="Pending Review">待审核</div>
                        <div class="metric-change negative">
                            <span>+5</span>
                            <span data-zh="需处理" data-en="need action">需处理</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 搜索和操作区域 -->
            <div class="search-section">
                <div class="search-controls">
                    <input type="text" id="user-search" class="form-input" placeholder="搜索用户..." data-zh-placeholder="搜索用户..." data-en-placeholder="Search users...">
                    <select id="status-filter" class="form-select">
                        <option value="all" data-zh="全部状态" data-en="All Status">全部状态</option>
                        <option value="active" data-zh="活跃" data-en="Active">活跃</option>
                        <option value="inactive" data-zh="停用" data-en="Inactive">停用</option>
                        <option value="pending" data-zh="待审核" data-en="Pending">待审核</option>
                    </select>
                    <select id="type-filter" class="form-select">
                        <option value="all" data-zh="全部类型" data-en="All Types">全部类型</option>
                        <option value="residential" data-zh="居民用户" data-en="Residential">居民用户</option>
                        <option value="commercial" data-zh="商业用户" data-en="Commercial">商业用户</option>
                        <option value="industrial" data-zh="工业用户" data-en="Industrial">工业用户</option>
                    </select>
                </div>
                <div class="search-actions">
                    <button class="btn btn-primary" onclick="showAddUserDialog()">
                        <span>+</span>
                        <span data-zh="添加用户" data-en="Add User">添加用户</span>
                    </button>
                    <button class="btn btn-secondary" onclick="exportUsers()">
                        <span>📊</span>
                        <span data-zh="导出" data-en="Export">导出</span>
                    </button>
                </div>
            </div>

            <!-- 用户列表表格 -->
            <div class="table-container">
                <div class="table-header">
                    <h3 class="table-title" data-zh="用户列表" data-en="User List">用户列表</h3>
                    <div class="table-actions">
                        <button class="btn btn-secondary" onclick="refreshUsers()">
                            <span>🔄</span>
                            <span data-zh="刷新" data-en="Refresh">刷新</span>
                        </button>
                    </div>
                </div>

                <table class="table" id="users-table">
                    <thead>
                        <tr>
                            <th data-sortable data-zh="用户信息" data-en="User Info">用户信息</th>
                            <th data-sortable data-zh="用户类型" data-en="Type">用户类型</th>
                            <th data-sortable data-zh="注册时间" data-en="Registration">注册时间</th>
                            <th data-sortable data-zh="状态" data-en="Status">状态</th>
                            <th data-sortable data-zh="房间号" data-en="Room">房间号</th>
                            <th data-sortable data-zh="本月用量" data-en="Monthly Usage">本月用量</th>
                            <th data-zh="操作" data-en="Actions">操作</th>
                        </tr>
                    </thead>
                    <tbody id="users-tbody">
                        <!-- 数据由JavaScript生成 -->
                    </tbody>
                </table>

                <!-- 分页 -->
                <div class="pagination">
                    <button class="btn btn-secondary" id="prev-page" disabled>
                        <span>‹</span>
                        <span data-zh="上一页" data-en="Previous">上一页</span>
                    </button>
                    <div class="page-info">
                        <span data-zh="第" data-en="Page">第</span>
                        <span id="current-page">1</span>
                        <span data-zh="页，共" data-en="of">页，共</span>
                        <span id="total-pages">142</span>
                        <span data-zh="页" data-en="pages">页</span>
                    </div>
                    <button class="btn btn-secondary" id="next-page">
                        <span data-zh="下一页" data-en="Next">下一页</span>
                        <span>›</span>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script src="assets/js/common.js"></script>
    <script>
        // 用户数据
        const usersData = [
            {
                id: '001',
                userId: '140070110346',
                name: '张明华',
                nameEn: 'Zhang Minghua',
                avatar: '张',
                email: 'zhang.minghua@email.com',
                phone: '138****8888',
                type: 'residential',
                status: 'active',
                registrationDate: '2024-01-15',
                monthlyUsage: 382,
                address: '北京市朝阳区建国路88号',
                checkinStatus: 'checked_in', // checked_in, checked_out, never_checked_in
                roomNumber: 'A-101',
                checkinDate: '2024-01-15'
            },
            {
                id: '002',
                userId: '140070110347',
                name: '李小红',
                nameEn: 'Li Xiaohong',
                avatar: '李',
                email: 'li.xiaohong@email.com',
                phone: '139****6666',
                type: 'commercial',
                status: 'active',
                registrationDate: '2024-02-20',
                monthlyUsage: 1256,
                address: '上海市浦东新区陆家嘴金融城',
                checkinStatus: 'checked_out',
                roomNumber: null,
                checkinDate: null,
                checkoutDate: '2024-11-01'
            },
            {
                id: '003',
                userId: '140070110348',
                name: '王建国',
                nameEn: 'Wang Jianguo',
                avatar: '王',
                email: 'wang.jianguo@email.com',
                phone: '137****9999',
                type: 'industrial',
                status: 'pending',
                registrationDate: '2024-03-10',
                monthlyUsage: 5430,
                address: '深圳市南山区科技园北区',
                checkinStatus: 'never_checked_in',
                roomNumber: null,
                checkinDate: null
            },
            {
                id: '004',
                userId: '140070110349',
                name: '陈志强',
                nameEn: 'Chen Zhiqiang',
                avatar: '陈',
                email: 'chen.zhiqiang@email.com',
                phone: '136****7777',
                type: 'residential',
                status: 'active',
                registrationDate: '2024-01-25',
                monthlyUsage: 198,
                address: '广州市天河区珠江新城',
                checkinStatus: 'checked_in',
                roomNumber: 'B-201',
                checkinDate: '2024-01-25'
            },
            {
                id: '005',
                userId: '140070110350',
                name: '刘美丽',
                nameEn: 'Liu Meili',
                avatar: '刘',
                email: 'liu.meili@email.com',
                phone: '135****5555',
                type: 'commercial',
                status: 'inactive',
                registrationDate: '2024-02-14',
                monthlyUsage: 0,
                address: '杭州市西湖区文三路',
                checkinStatus: 'never_checked_in',
                roomNumber: null,
                checkinDate: null
            },
            {
                id: '006',
                userId: '140070110351',
                name: '黄永强',
                nameEn: 'Huang Yongqiang',
                avatar: '黄',
                email: 'huang.yongqiang@email.com',
                phone: '134****4444',
                type: 'residential',
                status: 'active',
                registrationDate: '2024-03-05',
                monthlyUsage: 678,
                address: '成都市高新区天府大道'
            },
            {
                id: '007',
                userId: '140070110352',
                name: '周晓燕',
                nameEn: 'Zhou Xiaoyan',
                avatar: '周',
                email: 'zhou.xiaoyan@email.com',
                phone: '133****3333',
                type: 'residential',
                status: 'pending',
                registrationDate: '2024-03-18',
                monthlyUsage: 123,
                address: '武汉市武昌区光谷大道'
            },
            {
                id: '008',
                userId: '140070110353',
                name: '吴大伟',
                nameEn: 'Wu Dawei',
                avatar: '吴',
                email: 'wu.dawei@email.com',
                phone: '132****2222',
                type: 'industrial',
                status: 'active',
                registrationDate: '2024-01-30',
                monthlyUsage: 8512,
                address: '西安市高新区科技路'
            },
            {
                id: '009',
                userId: '140070110354',
                name: '郑小芳',
                nameEn: 'Zheng Xiaofang',
                avatar: '郑',
                email: 'zheng.xiaofang@email.com',
                phone: '131****1111',
                type: 'commercial',
                status: 'active',
                registrationDate: '2024-02-28',
                monthlyUsage: 2289,
                address: '南京市建邺区奥体中心'
            },
            {
                id: '010',
                userId: '140070110355',
                name: '孙建华',
                nameEn: 'Sun Jianhua',
                avatar: '孙',
                email: 'sun.jianhua@email.com',
                phone: '130****0000',
                type: 'residential',
                status: 'active',
                registrationDate: '2024-03-12',
                monthlyUsage: 734,
                address: '重庆市渝北区龙溪街道'
            }
        ];

        let currentPage = 1;
        let filteredUsers = [...usersData];

        // 渲染用户表格
        function renderUsersTable() {
            const tbody = document.getElementById('users-tbody');
            const itemsPerPage = 10;
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageUsers = filteredUsers.slice(startIndex, endIndex);

            const typeTexts = {
                zh: {
                    residential: '居民',
                    commercial: '商业',
                    industrial: '工业'
                },
                en: {
                    residential: 'Residential',
                    commercial: 'Commercial',
                    industrial: 'Industrial'
                }
            };

            const statusTexts = {
                zh: {
                    active: '活跃',
                    inactive: '停用',
                    pending: '待审核'
                },
                en: {
                    active: 'Active',
                    inactive: 'Inactive',
                    pending: 'Pending'
                }
            };

            const actionTexts = {
                zh: {
                    view: '查看',
                    edit: '编辑',
                    delete: '删除'
                },
                en: {
                    view: 'View',
                    edit: 'Edit',
                    delete: 'Delete'
                }
            };

            tbody.innerHTML = pageUsers.map(user => {
                const displayName = getCurrentLanguage() === 'zh' ? user.name : user.nameEn;
                const userType = typeTexts[getCurrentLanguage()][user.type];
                const userStatus = statusTexts[getCurrentLanguage()][user.status];

                return `
                    <tr>
                        <td>
                            <div class="user-info">
                                <div class="user-avatar">${user.avatar}</div>
                                <div>
                                    <div class="user-name">${displayName}</div>
                                    <div class="user-details">
                                        <span>${user.userId}</span> •
                                        <span>${user.email}</span>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td>${userType}</td>
                        <td>${EnergySystem.formatDate(user.registrationDate)}</td>
                        <td>
                            <span class="status status-${user.status}">${userStatus}</span>
                        </td>
                        <td>
                            ${user.roomNumber ? `<span class="room-number">${user.roomNumber}</span>` :
                              `<span class="no-room">${getCurrentLanguage() === 'zh' ? '未分配' : 'Not Assigned'}</span>`}
                        </td>
                        <td>${user.monthlyUsage.toLocaleString()} kWh</td>
                        <td>
                            <div class="actions">
                                <button class="btn btn-secondary btn-sm" onclick="viewUser('${user.id}')">
                                    ${actionTexts[getCurrentLanguage()].view}
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="editUser('${user.id}')">
                                    ${actionTexts[getCurrentLanguage()].edit}
                                </button>
                                ${user.checkinStatus === 'checked_in' ?
                                    `<button class="btn btn-warning btn-sm" onclick="checkoutUser('${user.id}')">
                                        ${getCurrentLanguage() === 'zh' ? '退租' : 'Check-out'}
                                    </button>` :
                                    (user.checkinStatus === 'checked_out' || user.checkinStatus === 'never_checked_in') ?
                                    `<button class="btn btn-success btn-sm" onclick="checkinUser('${user.id}')">
                                        ${getCurrentLanguage() === 'zh' ? '入驻' : 'Check-in'}
                                    </button>` : ''
                                }
                                <button class="btn btn-secondary btn-sm" onclick="deleteUser('${user.id}')">
                                    ${actionTexts[getCurrentLanguage()].delete}
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            updatePagination();
        }

        // 更新分页
        function updatePagination() {
            const totalPages = Math.ceil(filteredUsers.length / 10);
            document.getElementById('current-page').textContent = currentPage;
            document.getElementById('total-pages').textContent = totalPages;

            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage === totalPages;
        }

        // 搜索和过滤
        function handleFilter() {
            const searchTerm = document.getElementById('user-search').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;
            const typeFilter = document.getElementById('type-filter').value;

            filteredUsers = usersData.filter(user => {
                const nameMatch = user.name.toLowerCase().includes(searchTerm) ||
                                 user.nameEn.toLowerCase().includes(searchTerm) ||
                                 user.userId.includes(searchTerm) ||
                                 user.email.toLowerCase().includes(searchTerm);

                const statusMatch = statusFilter === 'all' || user.status === statusFilter;
                const typeMatch = typeFilter === 'all' || user.type === typeFilter;

                return nameMatch && statusMatch && typeMatch;
            });

            currentPage = 1;
            renderUsersTable();
        }

        // 用户操作函数
        function viewUser(userId) {
            const user = usersData.find(u => u.id === userId);
            if (user) {
                showNotification(`查看用户: ${user.name}`, 'info');
            }
        }

        function editUser(userId) {
            const user = usersData.find(u => u.id === userId);
            if (user) {
                showNotification(`编辑用户: ${user.name}`, 'info');
            }
        }

        function deleteUser(userId) {
            const user = usersData.find(u => u.id === userId);
            if (user) {
                showConfirmDialog(
                    `确定要删除用户 ${user.name} 吗？`,
                    (confirmed) => {
                        if (confirmed) {
                            showNotification(`已删除用户: ${user.name}`, 'success');
                        }
                    }
                );
            }
        }

        // 入驻功能
        function checkinUser(userId) {
            const user = usersData.find(u => u.id === userId);
            if (user) {
                showConfirmDialog(
                    `确定要为用户 ${user.name} 办理入驻手续吗？`,
                    (confirmed) => {
                        if (confirmed) {
                            // 模拟分配房间
                            const availableRooms = ['A-102', 'A-103', 'B-202', 'B-203', 'C-301'];
                            const randomRoom = availableRooms[Math.floor(Math.random() * availableRooms.length)];

                            // 更新用户状态
                            user.checkinStatus = 'checked_in';
                            user.roomNumber = randomRoom;
                            user.checkinDate = new Date().toISOString().split('T')[0];
                            user.checkoutDate = null;

                            // 重新渲染表格
                            renderUsersTable();
                            showNotification(`${user.name} 入驻成功！分配房间：${randomRoom}`, 'success');
                        }
                    }
                );
            }
        }

        // 退租功能
        function checkoutUser(userId) {
            const user = usersData.find(u => u.id === userId);
            if (user) {
                showConfirmDialog(
                    `确定要为用户 ${user.name} 办理退租手续吗？当前房间：${user.roomNumber}`,
                    (confirmed) => {
                        if (confirmed) {
                            // 更新用户状态
                            user.checkinStatus = 'checked_out';
                            user.checkoutDate = new Date().toISOString().split('T')[0];
                            const oldRoom = user.roomNumber;
                            user.roomNumber = null;

                            // 重新渲染表格
                            renderUsersTable();
                            showNotification(`${user.name} 退租成功！已释放房间：${oldRoom}`, 'success');
                        }
                    }
                );
            }
        }

        function showAddUserDialog() {
            showNotification('打开添加用户对话框', 'info');
        }

        function exportUsers() {
            showNotification('正在导出用户数据...', 'info');
        }

        function refreshUsers() {
            showLoading(document.querySelector('.table-container'));

            setTimeout(() => {
                hideLoading(document.querySelector('.table-container'));
                renderUsersTable();
                showNotification('用户数据已刷新', 'success');
            }, 1000);
        }

        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            // 设置当前页面导航
            setActiveNavigation('users.html');

            // 初始化语言系统
            initLanguageSystem();

            // 渲染初始表格
            renderUsersTable();

            // 绑定搜索和过滤事件
            document.getElementById('user-search').addEventListener('input', EnergySystem.debounce(handleFilter, 300));
            document.getElementById('status-filter').addEventListener('change', handleFilter);
            document.getElementById('type-filter').addEventListener('change', handleFilter);

            // 分页事件
            document.getElementById('prev-page').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderUsersTable();
                }
            });

            document.getElementById('next-page').addEventListener('click', () => {
                const totalPages = Math.ceil(filteredUsers.length / 10);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderUsersTable();
                }
            });

            // 启用表格排序
            EnergySystem.createTableSort('users-table');

            // 监听语言变化
            window.addEventListener('languageChanged', () => {
                renderUsersTable();
            });
        });

        // 添加样式
        const style = document.createElement('style');
        style.textContent = `
            .search-section {
                background: var(--background);
                border: var(--border);
                border-radius: var(--radius);
                padding: var(--space-6);
                margin-bottom: var(--space-8);
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: var(--space-4);
            }

            .search-controls {
                display: flex;
                gap: var(--space-4);
                flex: 1;
            }

            .search-controls .form-input {
                min-width: 300px;
            }

            .search-actions {
                display: flex;
                gap: var(--space-3);
            }

            .actions {
                display: flex;
                gap: var(--space-2);
            }

            /* 房间号样式 */
            .room-number {
                background: #e3f2fd;
                color: #1976d2;
                padding: 4px 8px;
                border-radius: 4px;
                font-weight: 500;
                font-size: 12px;
            }

            .no-room {
                color: #999;
                font-style: italic;
                font-size: 12px;
            }

            .btn-sm {
                padding: var(--space-1) var(--space-2);
                font-size: 12px;
            }

            .user-details {
                font-size: 12px;
                color: var(--text-tertiary);
                margin-top: var(--space-1);
            }

            .pagination {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: var(--space-4);
                padding: var(--space-6);
                background: var(--surface);
                border-top: var(--border);
            }

            .page-info {
                font-size: 14px;
                color: var(--text-secondary);
            }

            @media (max-width: 768px) {
                .search-section {
                    flex-direction: column;
                    align-items: stretch;
                }

                .search-controls {
                    flex-direction: column;
                }

                .search-controls .form-input {
                    min-width: auto;
                }

                .actions {
                    flex-direction: column;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
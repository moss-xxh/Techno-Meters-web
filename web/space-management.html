<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-zh="空间管理" data-en="Space Management">空间管理</title>
    <link rel="stylesheet" href="assets/css/common.css">
    <link rel="stylesheet" href="assets/css/navbar.css">
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-brand">
                <img src="logo.png" alt="Logo" class="nav-logo">
            </div>
            <div class="nav-menu">
                <a href="dashboard.html" class="nav-link" data-zh="仪表盘" data-en="Dashboard">仪表盘</a>
                <a href="pricing-templates.html" class="nav-link" data-zh="电价模版" data-en="Pricing Templates">电价模版</a>
                <a href="space-management.html" class="nav-link active" data-zh="空间管理" data-en="Space Management">空间管理</a>
                <a href="device-management.html" class="nav-link" data-zh="设备管理" data-en="Device Management">设备管理</a>
                <a href="user-management.html" class="nav-link" data-zh="用户管理" data-en="User Management">用户管理</a>
                <a href="bills.html" class="nav-link" data-zh="账单管理" data-en="Bill Management">账单管理</a>
            </div>
            <div class="nav-actions">
                <div class="lang-dropdown">
                    <select id="language-select" class="form-select lang-select">
                        <option value="zh" data-zh="中文" data-en="Chinese">中文</option>
                        <option value="en" data-zh="English" data-en="English">English</option>
                    </select>
                </div>
                <div class="user-menu">
                    <div class="user-avatar">管</div>
                    <span data-zh="管理员" data-en="Admin">管理员</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主内容区域 -->
    <main class="main-content">
        <div class="content-layout">
            <!-- 左侧树结构 -->
            <div class="sidebar-container">
                <div class="sidebar-header">
                    <h3 data-zh="建筑结构" data-en="Building Structure">建筑结构</h3>
                    <div class="sidebar-actions">
                        <button class="btn btn-sm btn-primary" onclick="showAddBuildingModal()">
                            <span data-zh="+ 楼" data-en="+ Building">+ 楼</span>
                        </button>
                    </div>
                </div>
                <div class="tree-container">
                    <div id="building-tree" class="tree">
                        <!-- 树结构由JavaScript生成 -->
                    </div>
                </div>
            </div>

            <!-- 右侧内容区域 -->
            <div class="main-container">
                <!-- 搜索和操作区域 -->
                <div class="search-section">
                    <div class="search-controls">
                        <input type="text" id="room-search" class="form-input" placeholder="房间号/电表号..." data-zh-placeholder="房间号/电表号..." data-en-placeholder="Room/Meter...">
                        <select id="room-status-filter" class="form-select">
                            <option value="all" data-zh="全部状态" data-en="All Status">全部状态</option>
                            <option value="vacant" data-zh="空闲" data-en="Vacant">空闲</option>
                            <option value="occupied" data-zh="已入驻" data-en="Occupied">已入驻</option>
                        </select>
                    </div>
                    <div class="search-actions">
                        <button class="btn btn-primary" onclick="searchRooms()">
                            <span data-zh="查询" data-en="Search">查询</span>
                        </button>
                        <button class="btn btn-secondary" onclick="resetFilters()">
                            <span data-zh="重置" data-en="Reset">重置</span>
                        </button>
                    </div>
                </div>

                <!-- 视图切换标签页 -->
                <div class="view-tabs">
                    <div class="tabs-left">
                        <button class="tab-btn active" onclick="switchView('table')" data-view="table">
                            <span data-zh="表格视图" data-en="Table View">表格视图</span>
                        </button>
                        <button class="tab-btn" onclick="switchView('card')" data-view="card">
                            <span data-zh="卡片视图" data-en="Card View">卡片视图</span>
                        </button>
                    </div>
                    <div class="tabs-right">
                        <button class="btn btn-success btn-sm" onclick="showAddRoomModal()">
                            <span data-zh="+ 添加房间" data-en="+ Add Room">+ 添加房间</span>
                        </button>
                    </div>
                </div>

                <!-- 视图内容区域 -->
                <div class="views-layout">
                    <!-- 房间列表表格 -->
                    <div id="table-view" class="view-container table-container">
                        <div class="view-content-header">
                            <div class="view-title">
                                <span id="current-selection" data-zh="" data-en=""></span>
                            </div>
                        </div>
                    <table class="table" id="rooms-table">
                        <thead>
                            <tr>
                                <th data-sortable data-zh="房间号" data-en="Room Number">房间号</th>
                                <th data-sortable data-zh="楼层" data-en="Floor">楼层</th>
                                <th data-sortable data-zh="电表" data-en="Meter">电表</th>
                                <th data-sortable data-zh="计费模版" data-en="Billing Template">计费模版</th>
                                <th data-sortable data-zh="租户" data-en="Tenant">租户</th>
                                <th data-sortable data-zh="状态" data-en="Status">状态</th>
                                <th data-zh="操作" data-en="Actions">操作</th>
                            </tr>
                        </thead>
                        <tbody id="rooms-tbody">
                            <!-- 数据由JavaScript生成 -->
                        </tbody>
                    </table>

                    <!-- 分页 -->
                    <div class="pagination">
                        <button class="btn btn-secondary" id="prev-page" disabled>
                            <span>‹</span>
                            <span data-zh="上一页" data-en="Previous">上一页</span>
                        </button>
                        <div class="page-info">
                            <span data-zh="第" data-en="Page">第</span>
                            <span id="current-page">1</span>
                            <span data-zh="页，共" data-en="of">页，共</span>
                            <span id="total-pages">3</span>
                            <span data-zh="页" data-en="pages">页</span>
                        </div>
                        <button class="btn btn-secondary" id="next-page">
                            <span data-zh="下一页" data-en="Next">下一页</span>
                            <span>›</span>
                        </button>
                    </div>
                </div>

                    <!-- 房间卡片视图 -->
                    <div id="card-view" class="view-container card-container" style="display: none;">
                        <div class="cards-grid" id="rooms-cards">
                            <!-- 卡片由JavaScript生成 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 添加楼栋模态框 -->
    <div id="building-modal" class="modal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="building-modal-title" data-zh="添加楼栋" data-en="Add Building">添加楼栋</h3>
                <button class="modal-close" onclick="hideBuildingModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="building-form" class="user-form">
                    <div class="form-row">
                        <div class="form-group">
                            <div style="display: flex; align-items: center;">
                                <span style="color: red; font-size: 14px; margin-right: 2px;">*</span>
                                <label for="building-name" data-zh="楼栋名称" data-en="Building Name">楼栋名称</label>
                            </div>
                            <input type="text" id="building-name" name="buildingName" class="form-input"
                                   data-zh-placeholder="如：A栋" data-en-placeholder="e.g., Building A" placeholder="如：A栋" required>
                        </div>
                        <div class="form-group">
                            <div style="display: flex; align-items: center;">
                                <span style="color: red; font-size: 14px; margin-right: 2px;">*</span>
                                <label for="total-floors" data-zh="总楼层数" data-en="Total Floors">总楼层数</label>
                            </div>
                            <input type="number" id="total-floors" name="totalFloors" class="form-input"
                                   data-zh-placeholder="如：5" data-en-placeholder="e.g., 5" placeholder="如：5" min="1" max="50" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label for="building-description" data-zh="楼栋描述" data-en="Building Description">楼栋描述</label>
                            <textarea id="building-description" name="description" class="form-textarea"
                                      rows="3" data-zh-placeholder="楼栋相关描述信息..." data-en-placeholder="Building related description..." placeholder="楼栋相关描述信息..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideBuildingModal()" data-zh="取消" data-en="Cancel">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveBuilding()" data-zh="保存" data-en="Save">保存</button>
            </div>
        </div>
    </div>

    <!-- 添加楼层模态框 -->
    <div id="floor-modal" class="modal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="floor-modal-title" data-zh="添加楼层" data-en="Add Floor">添加楼层</h3>
                <button class="modal-close" onclick="hideFloorModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="floor-form" class="user-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label data-zh="所属楼栋" data-en="Building">所属楼栋</label>
                            <div id="floor-building-name" style="padding: 12px; background: #f5f5f5; border-radius: 6px; color: #666;">--</div>
                            <input type="hidden" id="floor-building-id">
                        </div>
                        <div class="form-group">
                            <div style="display: flex; align-items: center;">
                                <span style="color: red; font-size: 14px; margin-right: 2px;">*</span>
                                <label for="floor-number" data-zh="楼层号" data-en="Floor Number">楼层号</label>
                            </div>
                            <input type="number" id="floor-number" name="floorNumber" class="form-input"
                                   data-zh-placeholder="如：1" data-en-placeholder="e.g., 1" placeholder="如：1" min="1" max="50" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label for="floor-description" data-zh="楼层描述" data-en="Floor Description">楼层描述</label>
                            <textarea id="floor-description" name="description" class="form-textarea"
                                      rows="3" data-zh-placeholder="楼层相关描述信息..." data-en-placeholder="Floor related description..." placeholder="楼层相关描述信息..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideFloorModal()" data-zh="取消" data-en="Cancel">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveFloor()" data-zh="保存" data-en="Save">保存</button>
            </div>
        </div>
    </div>

    <!-- 添加房间模态框 -->
    <div id="user-modal" class="modal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title" data-zh="添加房间" data-en="Add Room">添加房间</h3>
                <button class="modal-close" onclick="hideModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="user-form" class="user-form">
                        <div class="form-row">
                            <div class="form-group">
                                <div style="display: flex; align-items: center;">
                                    <span style="color: red; font-size: 14px; margin-right: 2px;">*</span>
                                    <label for="room-number" data-zh="房间号" data-en="Room Number">房间号</label>
                                </div>
                                <input type="text" id="room-number" name="roomNumber" class="form-input"
                                       data-zh-placeholder="如：A-101" data-en-placeholder="e.g., A-101" placeholder="如：A-101" required>
                            </div>
                            <div class="form-group">
                                <label for="room-building" data-zh="位置" data-en="Location">位置</label>
                                <div class="location-selector">
                                    <select id="room-building" name="building" class="form-input" onchange="updateFloorOptions()" required>
                                        <option value="">请选择楼栋</option>
                                    </select>
                                    <select id="room-floor" name="floor" class="form-input" required disabled>
                                        <option value="">请先选择楼栋</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <div style="display: flex; align-items: center;">
                                    <span style="color: red; font-size: 14px; margin-right: 2px;">*</span>
                                    <label for="bind-meter" data-zh="绑定电表" data-en="Bind Meter">绑定电表</label>
                                </div>
                                <select id="bind-meter" name="meterId" class="form-input" required>
                                    <option value="">请选择电表</option>
                                    <option value="METER001">METER001 - 单相电表</option>
                                    <option value="METER002">METER002 - 三相电表</option>
                                    <option value="METER003">METER003 - 单相电表</option>
                                    <option value="METER004">METER004 - 三相电表</option>
                                    <option value="METER005">METER005 - 智能电表</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <div style="display: flex; align-items: center;">
                                    <span style="color: red; font-size: 14px; margin-right: 2px;">*</span>
                                    <label for="billing-template" data-zh="计费模版" data-en="Billing Template">计费模版</label>
                                </div>
                                <select id="billing-template" name="billingTemplate" class="form-input" required>
                                    <option value="">请选择计费模版</option>
                                    <option value="residential_basic">住宅基础计费</option>
                                    <option value="residential_tiered">住宅阶梯计费</option>
                                    <option value="commercial_standard">商业标准计费</option>
                                    <option value="commercial_peak">商业峰谷计费</option>
                                    <option value="office_flat">办公室固定计费</option>
                                </select>
                            </div>
                        </div>


                        <div class="form-row">
                            <div class="form-group full-width">
                                <label for="room-description" data-zh="房间描述" data-en="Room Description">房间描述</label>
                                <textarea id="room-description" name="description" class="form-textarea"
                                          rows="3" data-zh-placeholder="房间描述信息..." data-en-placeholder="Room description..." placeholder="房间描述信息..."></textarea>
                            </div>
                        </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideModal()" data-zh="取消" data-en="Cancel">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveUser()" data-zh="保存" data-en="Save">保存</button>
            </div>
        </div>
    </div>

    <!-- 入驻弹窗 -->
    <div id="checkin-modal" class="modal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-zh="租户入驻" data-en="Tenant Check-in">租户入驻</h3>
                <button class="modal-close" onclick="hideCheckinModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="checkin-form" class="user-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label data-zh="房间号" data-en="Room Number">房间号</label>
                            <div id="checkin-user-name" style="padding: 12px; background: #f5f5f5; border-radius: 6px; color: #666;">--</div>
                            <input type="hidden" id="checkin-user-id">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <div style="display: flex; align-items: center;">
                                <span style="color: red; font-size: 14px; margin-right: 2px;">*</span>
                                <label for="checkin-tenant-select" data-zh="租户姓名" data-en="Tenant Name">租户姓名</label>
                            </div>
                            <div class="tenant-select-wrapper">
                                <input type="text" id="checkin-tenant-search" class="form-input" placeholder="搜索或输入租户姓名" autocomplete="off">
                                <select id="checkin-tenant-select" name="tenantName" class="form-input tenant-dropdown" style="display: none;" required>
                                    <option value="">请选择租户</option>
                                </select>
                                <div id="tenant-search-results" class="search-results"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div style="display: flex; align-items: center;">
                                <span style="color: red; font-size: 14px; margin-right: 2px;">*</span>
                                <label for="checkin-date" data-zh="入驻时间" data-en="Check-in Date">入驻时间</label>
                            </div>
                            <input type="date" id="checkin-date" name="checkinDate" class="form-input" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <div style="display: flex; align-items: center;">
                                <span style="color: red; font-size: 14px; margin-right: 2px;">*</span>
                                <label for="electricity-reading" data-zh="电表读数" data-en="Electricity Reading">电表读数 (kWh)</label>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="number" id="electricity-reading" name="electricityReading" class="form-input"
                                       placeholder="输入当前电表读数" step="0.01" min="0" required style="flex: 1;">
                                <button type="button" class="btn btn-secondary" onclick="readCurrentMeter()" style="flex-shrink: 0;">读取</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideCheckinModal()" data-zh="取消" data-en="Cancel">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveCheckin()" data-zh="确认入驻" data-en="Confirm Check-in">确认入驻</button>
            </div>
        </div>
    </div>

    <!-- 退租弹窗 -->
    <div id="checkout-modal" class="modal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-zh="租户退租" data-en="Tenant Check-out">租户退租</h3>
                <button class="modal-close" onclick="hideCheckoutModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="checkout-form" class="user-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label data-zh="租户姓名" data-en="Tenant Name">租户姓名</label>
                            <div id="checkout-user-name" style="padding: 12px; background: #f5f5f5; border-radius: 6px; color: #666;">--</div>
                            <input type="hidden" id="checkout-user-id">
                        </div>
                        <div class="form-group">
                            <label data-zh="当前房间" data-en="Current Room">当前房间</label>
                            <div id="checkout-user-room" style="padding: 12px; background: #f5f5f5; border-radius: 6px; color: #666;">--</div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <div style="display: flex; align-items: center;">
                                <span style="color: red; font-size: 14px; margin-right: 2px;">*</span>
                                <label for="checkout-date" data-zh="退租时间" data-en="Check-out Date">退租时间</label>
                            </div>
                            <input type="date" id="checkout-date" name="checkoutDate" class="form-input" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <div style="display: flex; align-items: center;">
                                <span style="color: red; font-size: 14px; margin-right: 2px;">*</span>
                                <label for="checkout-electricity-reading" data-zh="电表读数" data-en="Electricity Reading">电表读数 (kWh)</label>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="number" id="checkout-electricity-reading" name="electricityReading" class="form-input"
                                       data-zh-placeholder="输入当前电表读数" data-en-placeholder="Enter current meter reading" placeholder="输入当前电表读数" step="0.01" min="0" required style="flex: 1;">
                                <button type="button" class="btn btn-secondary" onclick="readCurrentMeterForCheckout()" style="flex-shrink: 0;" data-zh="读取" data-en="Read">读取</button>
                            </div>
                            <div style="margin-top: 6px; font-size: 12px; color: #999;">
                                <span data-zh="提示：退租后，请前往账单管理查看账单" data-en="Tip: After check-out, go to Bills Management to view bills">提示：退租后，请前往账单管理查看账单</span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideCheckoutModal()" data-zh="取消" data-en="Cancel">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveCheckout()" data-zh="确认退租" data-en="Confirm Check-out">确认退租</button>
            </div>
        </div>
    </div>

    <!-- 删除楼栋确认弹窗 -->
    <div id="delete-building-modal" class="modal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content delete-confirm-modal">
            <div class="modal-header">
                <h3 data-zh="确认删除楼栋" data-en="Confirm Delete Building">确认删除楼栋</h3>
                <button class="modal-close" onclick="hideBuildingDeleteConfirm()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="delete-warning-icon">⚠️</div>
                <p data-zh="确定要删除楼栋" data-en="Are you sure you want to delete building">确定要删除楼栋 "<span id="delete-building-name">--</span>" 吗？</p>
                <div class="delete-warning-box">
                    <p class="delete-warning" data-zh="警告：此操作将同时删除：" data-en="Warning: This operation will also delete:">⚠️ 警告：此操作将同时删除：</p>
                    <ul class="delete-warning-list">
                        <li data-zh="该楼栋下的所有楼层" data-en="All floors in this building">• 该楼栋下的所有楼层</li>
                        <li data-zh="该楼栋下的所有房间" data-en="All rooms in this building">• 该楼栋下的所有房间</li>
                        <li data-zh="相关的租户和账单数据" data-en="Related tenant and billing data">• 相关的租户和账单数据</li>
                    </ul>
                    <p class="delete-warning" data-zh="此操作不可撤销，请谨慎操作！" data-en="This operation cannot be undone!">此操作不可撤销，请谨慎操作！</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideBuildingDeleteConfirm()" data-zh="取消" data-en="Cancel">取消</button>
                <button type="button" class="btn btn-danger" onclick="confirmBuildingDelete()" data-zh="确认删除" data-en="Confirm Delete">确认删除</button>
            </div>
        </div>
    </div>

    <!-- 删除楼层确认弹窗 -->
    <div id="delete-floor-modal" class="modal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content delete-confirm-modal">
            <div class="modal-header">
                <h3 data-zh="确认删除楼层" data-en="Confirm Delete Floor">确认删除楼层</h3>
                <button class="modal-close" onclick="hideFloorDeleteConfirm()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="delete-warning-icon">⚠️</div>
                <p data-zh="确定要删除" data-en="Are you sure you want to delete">确定要删除 "<span id="delete-floor-info">--</span>" 吗？</p>
                <div class="delete-warning-box">
                    <p class="delete-warning" data-zh="警告：此操作将同时删除：" data-en="Warning: This operation will also delete:">⚠️ 警告：此操作将同时删除：</p>
                    <ul class="delete-warning-list">
                        <li data-zh="该楼层下的所有房间" data-en="All rooms on this floor">• 该楼层下的所有房间</li>
                        <li data-zh="相关的租户和账单数据" data-en="Related tenant and billing data">• 相关的租户和账单数据</li>
                    </ul>
                    <p class="delete-warning" data-zh="此操作不可撤销，请谨慎操作！" data-en="This operation cannot be undone!">此操作不可撤销，请谨慎操作！</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideFloorDeleteConfirm()" data-zh="取消" data-en="Cancel">取消</button>
                <button type="button" class="btn btn-danger" onclick="confirmFloorDelete()" data-zh="确认删除" data-en="Confirm Delete">确认删除</button>
            </div>
        </div>
    </div>

    <!-- 删除房间确认弹窗 -->
    <div id="delete-confirm-modal" class="modal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content delete-confirm-modal">
            <div class="modal-header">
                <h3 data-zh="确认删除房间" data-en="Confirm Delete Room">确认删除房间</h3>
                <button class="modal-close" onclick="hideDeleteConfirm()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="delete-warning-icon">⚠️</div>
                <p data-zh="确定要删除房间" data-en="Are you sure you want to delete room">确定要删除房间 "<span id="delete-user-name">--</span>" 吗？</p>
                <p class="delete-warning" data-zh="此操作不可撤销。" data-en="This operation cannot be undone.">此操作不可撤销。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideDeleteConfirm()" data-zh="取消" data-en="Cancel">取消</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()" data-zh="删除" data-en="Delete">删除</button>
            </div>
        </div>
    </div>

    <script src="assets/js/navbar.js"></script>
    <script src="assets/js/common.js"></script>
    <script>
        // 获取当前语言
        function getCurrentLanguage() {
            return document.getElementById('language-select')?.value || 'zh';
        }

        // 建筑结构数据
        const buildingsData = [
            {
                id: 'BUILDING001',
                name: 'A栋',
                nameEn: 'Building A',
                totalFloors: 5,
                description: '主楼栋',
                descriptionEn: 'Main Building',
                floors: [
                    { id: 'FLOOR001', number: 1, buildingId: 'BUILDING001', description: '一楼商铺', descriptionEn: '1st Floor Shops' },
                    { id: 'FLOOR002', number: 2, buildingId: 'BUILDING001', description: '二楼办公', descriptionEn: '2nd Floor Offices' },
                    { id: 'FLOOR003', number: 3, buildingId: 'BUILDING001', description: '三楼住宅', descriptionEn: '3rd Floor Residential' },
                    { id: 'FLOOR004', number: 4, buildingId: 'BUILDING001', description: '四楼住宅', descriptionEn: '4th Floor Residential' },
                    { id: 'FLOOR005', number: 5, buildingId: 'BUILDING001', description: '五楼住宅', descriptionEn: '5th Floor Residential' }
                ]
            },
            {
                id: 'BUILDING002',
                name: 'B栋',
                nameEn: 'Building B',
                totalFloors: 3,
                description: '副楼栋',
                descriptionEn: 'Secondary Building',
                floors: [
                    { id: 'FLOOR006', number: 1, buildingId: 'BUILDING002', description: '一楼仓库', descriptionEn: '1st Floor Warehouse' },
                    { id: 'FLOOR007', number: 2, buildingId: 'BUILDING002', description: '二楼办公', descriptionEn: '2nd Floor Offices' },
                    { id: 'FLOOR008', number: 3, buildingId: 'BUILDING002', description: '三楼会议室', descriptionEn: '3rd Floor Conference Rooms' }
                ]
            }
        ];

        // 房间数据
        const roomsData = [
            {
                id: 'ROOM001',
                roomNumber: 'A-101',
                buildingId: 'BUILDING001',
                floorId: 'FLOOR001',
                floorNumber: 1,
                meterId: 'METER001',
                billingTemplate: 'commercial_standard',
                description: '一楼商铺',
                descriptionEn: 'First floor shop',
                status: 'occupied',
                tenant: '张明华',
                tenantEn: 'Zhang Minghua',
                tenantPhone: '+91 98765 43210',
                checkinDate: '2024-01-15',
                electricityReading: 1250.5
            },
            {
                id: 'ROOM002',
                roomNumber: 'A-201',
                buildingId: 'BUILDING001',
                floorId: 'FLOOR002',
                floorNumber: 2,
                meterId: 'METER002',
                billingTemplate: 'office_flat',
                description: '二楼办公室',
                descriptionEn: 'Second floor office',
                status: 'vacant'
            },
            {
                id: 'ROOM003',
                roomNumber: 'A-301',
                buildingId: 'BUILDING001',
                floorId: 'FLOOR003',
                floorNumber: 3,
                meterId: 'METER003',
                billingTemplate: 'residential_basic',
                description: '三楼住宅',
                descriptionEn: 'Third floor residential',
                status: 'occupied',
                tenant: '王建国',
                tenantEn: 'Wang Jianguo',
                tenantPhone: '+91 76543 21098',
                checkinDate: '2024-05-10',
                electricityReading: 675.3
            },
            {
                id: 'ROOM005',
                roomNumber: 'B-201',
                buildingId: 'BUILDING002',
                floorId: 'FLOOR007',
                floorNumber: 2,
                meterId: 'METER005',
                billingTemplate: 'office_flat',
                description: '二楼办公室',
                descriptionEn: 'Second floor office',
                status: 'vacant'
            }
        ];

        // 租户数据
        const tenantsData = [
            { id: 'TENANT001', name: '张明华', phone: '+91 98765 43210', email: 'zhang@example.com' },
            { id: 'TENANT002', name: '李小红', phone: '+91 98765 43211', email: 'li@example.com' },
            { id: 'TENANT003', name: '王大强', phone: '+91 98765 43212', email: 'wang@example.com' },
            { id: 'TENANT004', name: '陈美丽', phone: '+91 98765 43213', email: 'chen@example.com' },
            { id: 'TENANT005', name: '刘建国', phone: '+91 98765 43214', email: 'liu@example.com' },
            { id: 'TENANT006', name: '赵敏', phone: '+91 98765 43215', email: 'zhao@example.com' },
            { id: 'TENANT007', name: '孙志强', phone: '+91 98765 43216', email: 'sun@example.com' },
            { id: 'TENANT008', name: '周丽娜', phone: '+91 98765 43217', email: 'zhou@example.com' },
            { id: 'TENANT009', name: '吴磊', phone: '+91 98765 43218', email: 'wu@example.com' },
            { id: 'TENANT010', name: '郑海燕', phone: '+91 98765 43219', email: 'zheng@example.com' }
        ];

        // 编辑和删除功能相关变量
        let isEditMode = false;
        let editingUserId = null;
        let deleteUserId = null;

        // 建筑结构管理变量
        let currentSelectedBuilding = null;
        let currentSelectedFloor = null;
        let isBuildingEditMode = false;
        let editingBuildingId = null;
        let isFloorEditMode = false;
        let editingFloorId = null;

        // 删除相关变量
        let deleteBuildingId = null;
        let deleteFloorId = null;

        // 视图管理变量
        let currentView = 'table';

        function renderRoomsTable() {
            try {
                console.log('renderRoomsTable called, roomsData length:', roomsData.length);
                console.log('buildingsData length:', buildingsData.length);
                const tbody = document.getElementById('rooms-tbody');
                if (!tbody) {
                    console.error('rooms-tbody element not found!');
                    return;
                }
            tbody.innerHTML = '';

            // 根据当前选择过滤房间
            let filteredRooms = roomsData;
            if (currentSelectedBuilding && !currentSelectedFloor) {
                filteredRooms = roomsData.filter(room => room.buildingId === currentSelectedBuilding);
            } else if (currentSelectedFloor) {
                filteredRooms = roomsData.filter(room => room.floorId === currentSelectedFloor);
            }

            console.log('Filtered rooms:', filteredRooms);
            // 应用搜索过滤
            const searchTerm = document.getElementById('room-search').value.toLowerCase();
            const statusFilter = document.getElementById('room-status-filter').value;

            if (searchTerm) {
                filteredRooms = filteredRooms.filter(room =>
                    room.roomNumber.toLowerCase().includes(searchTerm) ||
                    (room.meterId && room.meterId.toLowerCase().includes(searchTerm)) ||
                    (room.tenant && room.tenant.toLowerCase().includes(searchTerm)) ||
                    (room.tenantEn && room.tenantEn.toLowerCase().includes(searchTerm))
                );
            }

            if (statusFilter !== 'all') {
                filteredRooms = filteredRooms.filter(room => room.status === statusFilter);
            }

            console.log('Filtered rooms length:', filteredRooms.length);

            if (filteredRooms.length === 0) {
                console.warn('No rooms to display');
                const lang = getCurrentLanguage();
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 20px;">${lang === 'en' ? 'No room data' : '暂无房间数据'}</td></tr>`;
                return;
            }

            filteredRooms.forEach(room => {
                console.log('Rendering room:', room);
                const row = document.createElement('tr');

                const statusClass = room.status === 'occupied' ? 'status-online' :
                                   room.status === 'vacant' ? 'status-offline' : 'status-pending';

                const lang = getCurrentLanguage();
                const statusText = room.status === 'occupied' ?
                    (lang === 'en' ? 'Occupied' : '已入驻') :
                    (lang === 'en' ? 'Vacant' : '空闲');

                // 获取建筑和楼层信息
                const building = buildingsData.find(b => b.id === room.buildingId);
                const buildingName = building ? (lang === 'en' ? building.nameEn : building.name) : '--';
                const floorInfo = `${buildingName} ${room.floorNumber}${lang === 'en' ? 'F' : '楼'}`;

                // 获取租户名称
                const tenantName = room.tenant ? (lang === 'en' ? room.tenantEn : room.tenant) : '--';

                // 格式化计费模版显示
                const billingTemplateMap = lang === 'en' ? {
                    'residential_basic': 'Residential Basic',
                    'residential_tiered': 'Residential Tiered',
                    'commercial_standard': 'Commercial Standard',
                    'commercial_peak': 'Commercial Peak',
                    'office_flat': 'Office Flat Rate'
                } : {
                    'residential_basic': '住宅基础计费',
                    'residential_tiered': '住宅阶梯计费',
                    'commercial_standard': '商业标准计费',
                    'commercial_peak': '商业峰谷计费',
                    'office_flat': '办公室固定计费'
                };
                const billingText = billingTemplateMap[room.billingTemplate] || room.billingTemplate;

                row.innerHTML = `
                    <td>${room.roomNumber}</td>
                    <td>${floorInfo}</td>
                    <td>${room.meterId}</td>
                    <td>${billingText}</td>
                    <td>${tenantName}</td>
                    <td><span class="device-status ${statusClass}">${statusText}</span></td>
                    <td>
                        <div class="room-actions">
                            <button class="btn btn-sm btn-secondary" onclick="editRoom('${room.id}')">${lang === 'en' ? 'Edit' : '编辑'}</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteRoom('${room.id}')">${lang === 'en' ? 'Delete' : '删除'}</button>
                            ${room.status === 'vacant' ?
                                `<button class="btn btn-sm btn-success" onclick="assignTenant('${room.id}')">${lang === 'en' ? 'Check In' : '入驻'}</button>` :
                                room.status === 'occupied' ?
                                `<button class="btn btn-sm btn-warning" onclick="checkoutTenant('${room.id}')">${lang === 'en' ? 'Check Out' : '退租'}</button>` :
                                ''}
                        </div>
                    </td>
                `;

                tbody.appendChild(row);
            });
            } catch (error) {
                console.error('Error rendering rooms table:', error);
                const tbody = document.getElementById('rooms-tbody');
                if (tbody) {
                    const lang = getCurrentLanguage();
                    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 20px; color: red;">${lang === 'en' ? 'Error loading room data' : '加载房间数据出错'}</td></tr>`;
                }
            }
        }

        // 渲染建筑树结构
        function renderBuildingTree() {
            try {
                const treeContainer = document.getElementById('building-tree');
                if (!treeContainer) {
                    console.error('building-tree element not found!');
                    return;
                }
                treeContainer.innerHTML = '';

            const lang = getCurrentLanguage();
            buildingsData.forEach(building => {
                const buildingElement = document.createElement('div');
                buildingElement.className = 'tree-node building-node';
                buildingElement.innerHTML = `
                    <div class="tree-item ${currentSelectedBuilding === building.id ? 'selected' : ''}" onclick="selectBuilding('${building.id}')">
                        <span class="tree-icon">🏢</span>
                        <span class="tree-label">${lang === 'en' ? building.nameEn : building.name}</span>
                        <div class="tree-actions">
                            <button class="btn-icon" onclick="event.stopPropagation(); editBuilding('${building.id}')" title="${lang === 'en' ? 'Edit Building' : '编辑楼栋'}">
                                ✏️
                            </button>
                            <button class="btn-icon" onclick="event.stopPropagation(); addFloor('${building.id}')" title="${lang === 'en' ? 'Add Floor' : '添加楼层'}">
                                ➕
                            </button>
                            <button class="btn-icon" onclick="event.stopPropagation(); deleteBuilding('${building.id}')" title="${lang === 'en' ? 'Delete Building' : '删除楼栋'}">
                                🗑️
                            </button>
                        </div>
                    </div>
                    <div class="tree-children ${currentSelectedBuilding === building.id ? 'expanded' : ''}">
                        ${building.floors.map(floor => `
                            <div class="tree-item floor-item ${currentSelectedFloor === floor.id ? 'selected' : ''}" onclick="selectFloor('${floor.id}')">
                                <span class="tree-icon">🏠</span>
                                <span class="tree-label">${floor.number}${lang === 'en' ? 'F' : '楼'}</span>
                                <div class="tree-actions">
                                    <button class="btn-icon" onclick="event.stopPropagation(); editFloor('${floor.id}')" title="${lang === 'en' ? 'Edit Floor' : '编辑楼层'}">
                                        ✏️
                                    </button>
                                    <button class="btn-icon" onclick="event.stopPropagation(); addRoomToFloor('${floor.id}')" title="${lang === 'en' ? 'Add Room' : '添加房间'}">
                                        🏠
                                    </button>
                                    <button class="btn-icon" onclick="event.stopPropagation(); deleteFloor('${floor.id}')" title="${lang === 'en' ? 'Delete Floor' : '删除楼层'}">
                                        🗑️
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                treeContainer.appendChild(buildingElement);
            });
            } catch (error) {
                console.error('Error rendering building tree:', error);
                const treeContainer = document.getElementById('building-tree');
                if (treeContainer) {
                    const lang = getCurrentLanguage();
                    treeContainer.innerHTML = `<div style="padding: 20px; color: red; text-align: center;">${lang === 'en' ? 'Error loading building data' : '加载建筑数据出错'}</div>`;
                }
            }
        }

        // 选择建筑
        function selectBuilding(buildingId) {
            currentSelectedBuilding = buildingId;
            currentSelectedFloor = null;
            const lang = getCurrentLanguage();
            const building = buildingsData.find(b => b.id === buildingId);
            const titleText = building ? (lang === 'en' ? building.nameEn : building.name) : '';
            document.getElementById('current-selection').textContent = titleText;
            renderBuildingTree();
            if (currentView === 'table') {
                renderRoomsTable();
            } else {
                renderRoomsCards();
            }
        }

        // 选择楼层
        function selectFloor(floorId) {
            const floor = buildingsData.flatMap(b => b.floors).find(f => f.id === floorId);
            if (floor) {
                currentSelectedBuilding = floor.buildingId;
                currentSelectedFloor = floorId;
                const building = buildingsData.find(b => b.id === floor.buildingId);
                const lang = getCurrentLanguage();
                document.getElementById('current-selection').textContent =
                    `${lang === 'en' ? building.nameEn : building.name} ${floor.number}${lang === 'en' ? 'F' : '楼'}`;
                renderBuildingTree();
                renderRoomsTable();
            }
        }

        function searchRooms() {
            // 直接应用过滤条件并重新渲染
            if (currentView === 'table') {
                renderRoomsTable();
            } else {
                renderRoomsCards();
            }
        }

        function resetFilters() {
            // 重置选择状态
            currentSelectedBuilding = null;
            currentSelectedFloor = null;
            document.getElementById('current-selection').textContent = '';
            document.getElementById('room-search').value = '';
            document.getElementById('room-status-filter').value = 'all';
            renderBuildingTree();
            if (currentView === 'table') {
                renderRoomsTable();
            } else {
                renderRoomsCards();
            }
        }

        // ========== 视图切换函数 ==========
        function switchView(viewType) {
            currentView = viewType;

            // 更新标签页状态
            const tabBtns = document.querySelectorAll('.tab-btn');
            tabBtns.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.view === viewType) {
                    btn.classList.add('active');
                }
            });

            // 切换视图容器
            const tableView = document.getElementById('table-view');
            const cardView = document.getElementById('card-view');

            if (viewType === 'table') {
                tableView.style.display = 'block';
                cardView.style.display = 'none';
                renderRoomsTable();
            } else {
                tableView.style.display = 'none';
                cardView.style.display = 'block';
                renderRoomsCards();
            }
        }

        function renderRoomsCards() {
            try {
                const cardsContainer = document.getElementById('rooms-cards');
                if (!cardsContainer) {
                    console.error('rooms-cards element not found!');
                    return;
                }
                cardsContainer.innerHTML = '';

            // 根据当前选择过滤房间
            let filteredRooms = roomsData;
            if (currentSelectedBuilding && !currentSelectedFloor) {
                filteredRooms = roomsData.filter(room => room.buildingId === currentSelectedBuilding);
            } else if (currentSelectedFloor) {
                filteredRooms = roomsData.filter(room => room.floorId === currentSelectedFloor);
            }

            // 应用搜索过滤
            const searchTerm = document.getElementById('room-search').value.toLowerCase();
            const statusFilter = document.getElementById('room-status-filter').value;

            if (searchTerm) {
                filteredRooms = filteredRooms.filter(room =>
                    room.roomNumber.toLowerCase().includes(searchTerm) ||
                    (room.meterId && room.meterId.toLowerCase().includes(searchTerm)) ||
                    (room.tenant && room.tenant.toLowerCase().includes(searchTerm)) ||
                    (room.tenantEn && room.tenantEn.toLowerCase().includes(searchTerm))
                );
            }

            if (statusFilter !== 'all') {
                filteredRooms = filteredRooms.filter(room => room.status === statusFilter);
            }

            // 生成房间卡片
            filteredRooms.forEach(room => {
                const building = buildingsData.find(b => b.id === room.buildingId);
                const floor = building ? building.floors.find(f => f.id === room.floorId) : null;

                const statusBadge = room.status === 'occupied' ? 'success' : 'warning';
                const lang = getCurrentLanguage();
                const statusText = room.status === 'occupied' ?
                    (lang === 'en' ? 'Occupied' : '已入驻') :
                    (lang === 'en' ? 'Vacant' : '空闲');

                // 格式化计费模版显示
                const billingTemplateMap = lang === 'en' ? {
                    'residential_basic': 'Residential Basic',
                    'residential_tiered': 'Residential Tiered',
                    'commercial_standard': 'Commercial Standard',
                    'commercial_peak': 'Commercial Peak',
                    'office_flat': 'Office Flat Rate'
                } : {
                    'residential_basic': '住宅基础计费',
                    'residential_tiered': '住宅阶梯计费',
                    'commercial_standard': '商业标准计费',
                    'commercial_peak': '商业峰谷计费',
                    'office_flat': '办公室固定计费'
                };
                const billingText = billingTemplateMap[room.billingTemplate] || room.billingTemplate;

                const cardElement = document.createElement('div');
                cardElement.className = 'room-card';
                cardElement.innerHTML = `
                    <div class="card-header">
                        <h4 class="room-number">${room.roomNumber}</h4>
                        <span class="status-badge ${statusBadge}">${statusText}</span>
                    </div>
                    <div class="card-body">
                        <div class="card-info">
                            <p><strong>${lang === 'en' ? 'Location:' : '位置：'}</strong>${building ? (lang === 'en' ? building.nameEn : building.name) : ''} ${floor ? floor.number + (lang === 'en' ? 'F' : '楼') : ''}</p>
                            <p><strong>${lang === 'en' ? 'Meter:' : '电表号：'}</strong>${room.meterId || (lang === 'en' ? 'Unbound' : '未绑定')}</p>
                            <p><strong>${lang === 'en' ? 'Billing:' : '计费模板：'}</strong>${billingText || (lang === 'en' ? 'Not Set' : '未设置')}</p>
                            ${room.tenant ? `<p><strong>${lang === 'en' ? 'Tenant:' : '租户：'}</strong>${lang === 'en' ? room.tenantEn : room.tenant}</p>` : ''}
                            ${room.tenantPhone ? `<p><strong>${lang === 'en' ? 'Phone:' : '联系电话：'}</strong>${room.tenantPhone}</p>` : ''}
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-sm btn-primary" onclick="editRoom('${room.id}')">${lang === 'en' ? 'Edit' : '编辑'}</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteRoom('${room.id}')">${lang === 'en' ? 'Delete' : '删除'}</button>
                            ${room.status === 'vacant' ?
                                `<button class="btn btn-sm btn-success" onclick="assignTenant('${room.id}')">${lang === 'en' ? 'Check In' : '入驻'}</button>` :
                                room.status === 'occupied' ?
                                `<button class="btn btn-sm btn-warning" onclick="checkoutTenant('${room.id}')">${lang === 'en' ? 'Check Out' : '退租'}</button>` :
                                ''}
                        </div>
                    </div>
                `;
                cardsContainer.appendChild(cardElement);
            });

            if (filteredRooms.length === 0) {
                const lang = getCurrentLanguage();
                cardsContainer.innerHTML = `<div class="no-data">${lang === 'en' ? 'No room data' : '暂无房间数据'}</div>`;
            }
            } catch (error) {
                console.error('Error rendering rooms cards:', error);
                const cardsContainer = document.getElementById('rooms-cards');
                if (cardsContainer) {
                    const lang = getCurrentLanguage();
                    cardsContainer.innerHTML = `<div class="no-data" style="color: red;">${lang === 'en' ? 'Error loading room data' : '加载房间数据出错'}</div>`;
                }
            }
        }

        // ========== 建筑管理函数 ==========
        function showAddBuildingModal() {
            isBuildingEditMode = false;
            editingBuildingId = null;
            const lang = getCurrentLanguage();
            document.getElementById('building-modal-title').textContent = lang === 'en' ? 'Add Building' : '添加楼栋';
            document.getElementById('building-form').reset();
            document.getElementById('building-modal').style.display = 'flex';
            document.body.classList.add('modal-open');
        }

        function editBuilding(buildingId) {
            const building = buildingsData.find(b => b.id === buildingId);
            if (building) {
                isBuildingEditMode = true;
                editingBuildingId = buildingId;
                const lang = getCurrentLanguage();
                document.getElementById('building-modal-title').textContent = lang === 'en' ? 'Edit Building' : '编辑楼栋';
                document.getElementById('building-name').value = lang === 'en' ? building.nameEn : building.name;
                document.getElementById('total-floors').value = building.totalFloors;
                document.getElementById('building-description').value = lang === 'en' ? building.descriptionEn : building.description;
                document.getElementById('building-modal').style.display = 'flex';
                document.body.classList.add('modal-open');
            }
        }

        function hideBuildingModal() {
            document.getElementById('building-modal').style.display = 'none';
            document.body.classList.remove('modal-open');
            isBuildingEditMode = false;
            editingBuildingId = null;
        }

        function saveBuilding() {
            const formData = new FormData(document.getElementById('building-form'));
            const buildingData = {
                name: formData.get('buildingName').trim(),
                totalFloors: parseInt(formData.get('totalFloors')),
                description: formData.get('description').trim()
            };

            // 数据验证
            const lang = getCurrentLanguage();
            if (!buildingData.name) {
                alert(lang === 'en' ? 'Building name is required' : '楼栋名称不能为空');
                return;
            }
            if (!buildingData.totalFloors || buildingData.totalFloors < 1 || buildingData.totalFloors > 50) {
                alert(lang === 'en' ? 'Total floors must be between 1 and 50' : '楼层数必须在1-50之间');
                return;
            }
            if (buildingData.name.length > 20) {
                alert(lang === 'en' ? 'Building name cannot exceed 20 characters' : '楼栋名称不能超过20个字符');
                return;
            }

            // 检查楼栋名称是否重复
            const existingBuilding = buildingsData.find(b =>
                b.name === buildingData.name &&
                (!isBuildingEditMode || b.id !== editingBuildingId)
            );
            if (existingBuilding) {
                alert(lang === 'en' ? 'Building name already exists' : '楼栋名称已存在');
                return;
            }

            try {
                if (isBuildingEditMode && editingBuildingId) {
                    // 编辑模式
                    const building = buildingsData.find(b => b.id === editingBuildingId);
                    if (building) {
                        building.name = buildingData.name;
                        building.totalFloors = buildingData.totalFloors;
                        building.description = buildingData.description;
                        alert('楼栋信息更新成功！');
                    }
                } else {
                    // 添加模式
                    const newBuilding = {
                        id: 'BUILDING' + String(Math.floor(Math.random() * 900) + 100),
                        name: buildingData.name,
                        totalFloors: buildingData.totalFloors,
                        description: buildingData.description,
                        floors: []
                    };
                    buildingsData.push(newBuilding);
                    alert('楼栋添加成功！');

                    // 标记空间流程为完成
                    let workflowProgress = JSON.parse(localStorage.getItem('workflowProgress') || '{}');
                    workflowProgress.space = true;
                    localStorage.setItem('workflowProgress', JSON.stringify(workflowProgress));
                }
                hideBuildingModal();
                renderBuildingTree();
            } catch (error) {
                console.error('保存楼栋时出错:', error);
                alert('保存失败，请重试');
            }
        }

        function deleteBuilding(buildingId) {
            const building = buildingsData.find(b => b.id === buildingId);
            if (building) {
                deleteBuildingId = buildingId;
                document.getElementById('delete-building-name').textContent = building.name;
                document.getElementById('delete-building-modal').style.display = 'flex';
                document.body.classList.add('modal-open');
            }
        }

        function hideBuildingDeleteConfirm() {
            document.getElementById('delete-building-modal').style.display = 'none';
            document.body.classList.remove('modal-open');
            deleteBuildingId = null;
        }

        function confirmBuildingDelete() {
            if (deleteBuildingId) {
                const index = buildingsData.findIndex(b => b.id === deleteBuildingId);
                if (index > -1) {
                    const buildingName = buildingsData[index].name;
                    buildingsData.splice(index, 1);

                    // 删除相关房间
                    for (let i = roomsData.length - 1; i >= 0; i--) {
                        if (roomsData[i].buildingId === deleteBuildingId) {
                            roomsData.splice(i, 1);
                        }
                    }

                    // 重置选择状态
                    if (currentSelectedBuilding === deleteBuildingId) {
                        currentSelectedBuilding = null;
                        currentSelectedFloor = null;
                        document.getElementById('current-selection').textContent = '';
                    }

                    renderBuildingTree();
                    renderRoomsTable();
                    hideBuildingDeleteConfirm();

                    if (typeof EnergySystem !== 'undefined') {
                        EnergySystem.showNotification(`楼栋 ${buildingName} 删除成功！`, 'success');
                    } else {
                        alert(`楼栋 ${buildingName} 删除成功！`);
                    }
                }
            }
        }

        // ========== 楼层管理函数 ==========
        function addFloor(buildingId) {
            const building = buildingsData.find(b => b.id === buildingId);
            if (building) {
                isFloorEditMode = false;
                editingFloorId = null;
                const lang = getCurrentLanguage();
                document.getElementById('floor-modal-title').textContent = lang === 'en' ? 'Add Floor' : '添加楼层';
                document.getElementById('floor-building-name').textContent = lang === 'en' ? building.nameEn : building.name;
                document.getElementById('floor-building-id').value = buildingId;
                document.getElementById('floor-form').reset();
                document.getElementById('floor-modal').style.display = 'flex';
                document.body.classList.add('modal-open');
            }
        }

        function editFloor(floorId) {
            const floor = buildingsData.flatMap(b => b.floors).find(f => f.id === floorId);
            if (floor) {
                const building = buildingsData.find(b => b.id === floor.buildingId);
                isFloorEditMode = true;
                editingFloorId = floorId;
                const lang = getCurrentLanguage();
                document.getElementById('floor-modal-title').textContent = lang === 'en' ? 'Edit Floor' : '编辑楼层';
                document.getElementById('floor-building-name').textContent = lang === 'en' ? building.nameEn : building.name;
                document.getElementById('floor-building-id').value = floor.buildingId;
                document.getElementById('floor-number').value = floor.number;
                document.getElementById('floor-description').value = floor.description;
                document.getElementById('floor-modal').style.display = 'flex';
                document.body.classList.add('modal-open');
            }
        }

        function hideFloorModal() {
            document.getElementById('floor-modal').style.display = 'none';
            document.body.classList.remove('modal-open');
            isFloorEditMode = false;
            editingFloorId = null;
        }

        function saveFloor() {
            const formData = new FormData(document.getElementById('floor-form'));
            const buildingId = document.getElementById('floor-building-id').value;
            const floorData = {
                number: parseInt(formData.get('floorNumber')),
                description: formData.get('description').trim()
            };

            if (!floorData.number) {
                alert('请填写楼层号');
                return;
            }

            try {
                const building = buildingsData.find(b => b.id === buildingId);
                if (!building) return;

                if (isFloorEditMode && editingFloorId) {
                    // 编辑模式
                    const floor = building.floors.find(f => f.id === editingFloorId);
                    if (floor) {
                        floor.number = floorData.number;
                        floor.description = floorData.description;
                        alert('楼层信息更新成功！');
                    }
                } else {
                    // 添加模式
                    const newFloor = {
                        id: 'FLOOR' + String(Math.floor(Math.random() * 900) + 100),
                        number: floorData.number,
                        buildingId: buildingId,
                        description: floorData.description
                    };
                    building.floors.push(newFloor);
                    alert('楼层添加成功！');
                }
                hideFloorModal();
                renderBuildingTree();
            } catch (error) {
                console.error('保存楼层时出错:', error);
                alert('保存失败，请重试');
            }
        }

        function deleteFloor(floorId) {
            const floor = buildingsData.flatMap(b => b.floors).find(f => f.id === floorId);
            if (floor) {
                const building = buildingsData.find(b => b.id === floor.buildingId);
                deleteFloorId = floorId;
                document.getElementById('delete-floor-info').textContent = `${building.name} ${floor.number}楼`;
                document.getElementById('delete-floor-modal').style.display = 'flex';
                document.body.classList.add('modal-open');
            }
        }

        function hideFloorDeleteConfirm() {
            document.getElementById('delete-floor-modal').style.display = 'none';
            document.body.classList.remove('modal-open');
            deleteFloorId = null;
        }

        function confirmFloorDelete() {
            if (deleteFloorId) {
                const floor = buildingsData.flatMap(b => b.floors).find(f => f.id === deleteFloorId);
                if (floor) {
                    const building = buildingsData.find(b => b.id === floor.buildingId);
                    const floorIndex = building.floors.findIndex(f => f.id === deleteFloorId);

                    if (floorIndex > -1) {
                        building.floors.splice(floorIndex, 1);

                        // 删除相关房间
                        for (let i = roomsData.length - 1; i >= 0; i--) {
                            if (roomsData[i].floorId === deleteFloorId) {
                                roomsData.splice(i, 1);
                            }
                        }

                        // 重置选择状态
                        if (currentSelectedFloor === deleteFloorId) {
                            currentSelectedFloor = null;
                            if (currentSelectedBuilding === floor.buildingId) {
                                document.getElementById('current-selection').textContent = building.name;
                            } else {
                                currentSelectedBuilding = null;
                                document.getElementById('current-selection').textContent = '';
                            }
                        }

                        renderBuildingTree();
                        renderRoomsTable();
                        hideFloorDeleteConfirm();

                        if (typeof EnergySystem !== 'undefined') {
                            EnergySystem.showNotification(`${building.name} ${floor.number}楼 删除成功！`, 'success');
                        } else {
                            alert(`${building.name} ${floor.number}楼 删除成功！`);
                        }
                    }
                }
            }
        }

        // ========== 房间管理函数 ==========
        function showAddRoomModal() {
            showAddModal();
        }

        function addRoomToFloor(floorId) {
            // 找到对应的楼层
            const floor = buildingsData.flatMap(b => b.floors).find(f => f.id === floorId);
            if (floor) {
                // 选择该楼层
                selectFloor(floorId);
                // 打开添加房间弹窗
                showAddModal();
            }
        }

        // ========== 位置选择函数 ==========
        function initializeBuildingOptions() {
            const buildingSelect = document.getElementById('room-building');
            const lang = getCurrentLanguage();
            buildingSelect.innerHTML = `<option value="">${lang === 'en' ? 'Select Building' : '请选择楼栋'}</option>`;

            buildingsData.forEach(building => {
                const option = document.createElement('option');
                option.value = building.id;
                const name = lang === 'en' ? building.nameEn : building.name;
                const desc = lang === 'en' ? building.descriptionEn : building.description;
                option.textContent = `${name} - ${desc}`;
                buildingSelect.appendChild(option);
            });
        }

        function updateFloorOptions() {
            const buildingSelect = document.getElementById('room-building');
            const floorSelect = document.getElementById('room-floor');
            const selectedBuildingId = buildingSelect.value;
            const lang = getCurrentLanguage();

            // 清空楼层选项
            floorSelect.innerHTML = '';

            if (!selectedBuildingId) {
                floorSelect.disabled = true;
                floorSelect.innerHTML = `<option value="">${lang === 'en' ? 'Select Building First' : '请先选择楼栋'}</option>`;
                return;
            }

            // 找到选中的楼栋
            const building = buildingsData.find(b => b.id === selectedBuildingId);
            if (building) {
                floorSelect.disabled = false;
                floorSelect.innerHTML = `<option value="">${lang === 'en' ? 'Select Floor' : '请选择楼层'}</option>`;

                // 添加楼层选项
                building.floors.forEach(floor => {
                    const option = document.createElement('option');
                    option.value = floor.id;
                    const floorLabel = lang === 'en' ? `${floor.number}F` : `${floor.number}楼`;
                    const desc = lang === 'en' ? floor.descriptionEn : floor.description;
                    option.textContent = `${floorLabel} - ${desc}`;
                    floorSelect.appendChild(option);
                });
            }
        }

        function initializeMeterOptions() {
            const meterSelect = document.getElementById('bind-meter');
            const lang = getCurrentLanguage();

            const meterOptions = [
                { value: 'METER001', nameZh: 'METER001 - 单相电表', nameEn: 'METER001 - Single Phase Meter' },
                { value: 'METER002', nameZh: 'METER002 - 三相电表', nameEn: 'METER002 - Three Phase Meter' },
                { value: 'METER003', nameZh: 'METER003 - 单相电表', nameEn: 'METER003 - Single Phase Meter' },
                { value: 'METER004', nameZh: 'METER004 - 三相电表', nameEn: 'METER004 - Three Phase Meter' },
                { value: 'METER005', nameZh: 'METER005 - 智能电表', nameEn: 'METER005 - Smart Meter' }
            ];

            meterSelect.innerHTML = `<option value="">${lang === 'en' ? 'Select Meter' : '请选择电表'}</option>`;

            meterOptions.forEach(meter => {
                const option = document.createElement('option');
                option.value = meter.value;
                option.textContent = lang === 'en' ? meter.nameEn : meter.nameZh;
                meterSelect.appendChild(option);
            });
        }

        function initializeBillingTemplateOptions() {
            const billingSelect = document.getElementById('billing-template');
            const lang = getCurrentLanguage();

            const billingOptions = [
                { value: 'residential_basic', nameZh: '住宅基础计费', nameEn: 'Residential Basic' },
                { value: 'residential_tiered', nameZh: '住宅阶梯计费', nameEn: 'Residential Tiered' },
                { value: 'commercial_standard', nameZh: '商业标准计费', nameEn: 'Commercial Standard' },
                { value: 'commercial_peak', nameZh: '商业峰谷计费', nameEn: 'Commercial Peak' },
                { value: 'office_flat', nameZh: '办公室固定计费', nameEn: 'Office Flat Rate' }
            ];

            billingSelect.innerHTML = `<option value="">${lang === 'en' ? 'Select Billing Template' : '请选择计费模版'}</option>`;

            billingOptions.forEach(billing => {
                const option = document.createElement('option');
                option.value = billing.value;
                option.textContent = lang === 'en' ? billing.nameEn : billing.nameZh;
                billingSelect.appendChild(option);
            });
        }

        function initializeFloorSelectDefault() {
            const floorSelect = document.getElementById('room-floor');
            const lang = getCurrentLanguage();

            floorSelect.innerHTML = `<option value="">${lang === 'en' ? 'Select Building First' : '请先选择楼栋'}</option>`;
            floorSelect.disabled = true;
        }

        function showAddModal() {
            // 重置编辑模式
            isEditMode = false;
            editingUserId = null;

            // 初始化各种选项
            initializeBuildingOptions();
            initializeMeterOptions();
            initializeBillingTemplateOptions();
            initializeFloorSelectDefault();

            // 重置表单和UI
            const lang = getCurrentLanguage();
            document.getElementById('modal-title').textContent = lang === 'en' ? 'Add Room' : '添加房间';
            document.getElementById('user-form').reset();

            // 重置表单字段状态
            const roomNumberField = document.getElementById('room-number');
            roomNumberField.readOnly = false;
            roomNumberField.disabled = false;
            roomNumberField.style.backgroundColor = '';
            roomNumberField.style.color = '';
            roomNumberField.style.cursor = '';

            // 显示弹窗
            document.getElementById('user-modal').style.display = 'flex';
            document.body.classList.add('modal-open');
        }

        function hideModal() {
            document.getElementById('user-modal').style.display = 'none';
            document.body.classList.remove('modal-open');

            // 重置编辑模式
            isEditMode = false;
            editingUserId = null;

            // 重置表单字段状态
            const roomNumberField = document.getElementById('room-number');
            roomNumberField.readOnly = false;
            roomNumberField.disabled = false;
            roomNumberField.style.backgroundColor = '';
            roomNumberField.style.color = '';
            roomNumberField.style.cursor = '';

            // 重置楼栋和楼层选择
            document.getElementById('room-building').value = '';
            document.getElementById('room-floor').disabled = true;
            document.getElementById('room-floor').innerHTML = '<option value="">请先选择楼栋</option>';
        }

        function saveUser() {
            const formData = new FormData(document.getElementById('user-form'));

            // 获取表单数据
            const buildingId = formData.get('building');
            const floorId = formData.get('floor');

            // 查找楼栋和楼层信息
            const building = buildingsData.find(b => b.id === buildingId);
            const floor = building ? building.floors.find(f => f.id === floorId) : null;

            const roomData = {
                roomNumber: formData.get('roomNumber').trim(),
                buildingId: buildingId,
                floorId: floorId,
                floorNumber: floor ? floor.number : null,
                meterId: formData.get('meterId'),
                billingTemplate: formData.get('billingTemplate'),
                description: formData.get('description').trim()
            };

            // 验证必填字段
            if (!roomData.roomNumber || !buildingId || !floorId || !roomData.meterId || !roomData.billingTemplate) {
                alert('请填写所有必填字段，包括选择楼栋和楼层');
                return;
            }

            try {
                if (isEditMode && editingUserId) {
                    // 编辑模式：更新现有房间
                    const roomIndex = roomsData.findIndex(r => r.id === editingUserId);
                    if (roomIndex > -1) {
                        // 保留原有数据，只更新允许编辑的字段
                        roomsData[roomIndex].meterId = roomData.meterId;
                        roomsData[roomIndex].billingTemplate = roomData.billingTemplate;
                        roomsData[roomIndex].buildingId = roomData.buildingId;
                        roomsData[roomIndex].floorId = roomData.floorId;
                        roomsData[roomIndex].floorNumber = roomData.floorNumber;
                        roomsData[roomIndex].description = roomData.description;
                        // 房间号不允许编辑，保持原值

                        // 重新渲染表格和卡片
                        renderRoomsTable();
                        renderRoomsCards();
                        // 关闭模态框
                        hideModal();

                        // 显示成功消息
                        if (typeof EnergySystem !== 'undefined') {
                            EnergySystem.showNotification('房间信息更新成功！', 'success');
                        } else {
                            alert('房间信息更新成功！');
                        }
                    }
                } else {
                    // 添加模式：创建新房间
                    const newRoom = {
                        id: 'ROOM' + String(Math.floor(Math.random() * 900) + 100),
                        roomNumber: roomData.roomNumber,
                        buildingId: roomData.buildingId,
                        floorId: roomData.floorId,
                        floorNumber: roomData.floorNumber,
                        meterId: roomData.meterId,
                        billingTemplate: roomData.billingTemplate,
                        description: roomData.description,
                        status: 'vacant',
                        tenant: null,
                        tenantPhone: null,
                        checkinDate: null,
                        electricityReading: null
                    };

                    // 添加到房间列表
                    roomsData.push(newRoom);
                    // 重新渲染表格和卡片
                    renderRoomsTable();
                    renderRoomsCards();
                    // 关闭模态框
                    hideModal();

                    // 显示成功消息
                    if (typeof EnergySystem !== 'undefined') {
                        EnergySystem.showNotification('房间添加成功！', 'success');
                    } else {
                        alert('房间添加成功！');
                    }
                }
            } catch (error) {
                console.error('保存租户时出错:', error);
                alert('保存失败，请重试');
            }
        }

        function editRoom(roomId) {
            const room = roomsData.find(r => r.id === roomId);
            if (room) {
                // 设置为编辑模式
                isEditMode = true;
                editingUserId = roomId;

                // 初始化各种选项
                initializeBuildingOptions();
                initializeMeterOptions();
                initializeBillingTemplateOptions();
                initializeFloorSelectDefault();

                // 更新弹窗标题
                const lang = getCurrentLanguage();
                document.getElementById('modal-title').textContent = lang === 'en' ? 'Edit Room' : '编辑房间';

                // 填充表单数据
                document.getElementById('room-number').value = room.roomNumber || '';
                document.getElementById('bind-meter').value = room.meterId || '';
                document.getElementById('billing-template').value = room.billingTemplate || '';

                // 设置楼栋和楼层选择
                if (room.buildingId) {
                    document.getElementById('room-building').value = room.buildingId;
                    updateFloorOptions();

                    // 设置楼层选择
                    if (room.floorId) {
                        setTimeout(() => {
                            document.getElementById('room-floor').value = room.floorId;
                        }, 0);
                    }
                }

                document.getElementById('room-description').value = (lang === 'en' ? room.descriptionEn : room.description) || '';

                // 设置房间号为只读（编辑时不允许修改房间号）
                const roomNumberField = document.getElementById('room-number');
                roomNumberField.readOnly = true;
                roomNumberField.disabled = false;
                roomNumberField.style.backgroundColor = '#f5f5f5';
                roomNumberField.style.color = '#666';
                roomNumberField.style.cursor = 'not-allowed';

                // 显示弹窗
                document.getElementById('user-modal').style.display = 'flex';
                document.body.classList.add('modal-open');
            }
        }

        function deleteRoom(roomId) {
            const room = roomsData.find(r => r.id === roomId);
            if (!room) return;

            if (typeof EnergySystem !== 'undefined' && EnergySystem.showConfirmDialog) {
                const lang = getCurrentLanguage();
                const message = lang === 'en' ? `Are you sure you want to delete room ${room.roomNumber}?` : `确定要删除房间 ${room.roomNumber} 吗？`;
                EnergySystem.showConfirmDialog(
                    message,
                    (confirmed) => {
                        if (confirmed) {
                            // 删除房间逻辑
                            const index = roomsData.findIndex(r => r.id === roomId);
                            if (index > -1) {
                                roomsData.splice(index, 1);
                                renderRoomsTable();
                                renderRoomsCards();
                                if (typeof EnergySystem !== 'undefined' && EnergySystem.showNotification) {
                                    EnergySystem.showNotification(`已删除房间: ${room.roomNumber}`, 'success');
                                } else {
                                    alert(`已删除房间: ${room.roomNumber}`);
                                }
                            }
                        }
                    }
                );
            } else {
                const lang = getCurrentLanguage();
                const message = lang === 'en' ? `Are you sure you want to delete room ${room.roomNumber}?` : `确定要删除房间 ${room.roomNumber} 吗？`;
                if (confirm(message)) {
                    // 删除房间逻辑
                    const index = roomsData.findIndex(r => r.id === roomId);
                    if (index > -1) {
                        roomsData.splice(index, 1);
                        renderRoomsTable();
                        renderRoomsCards();
                        alert(`已删除房间: ${room.roomNumber}`);
                    }
                }
            }
        }

        function assignTenant(roomId) {
            const room = roomsData.find(r => r.id === roomId);
            if (room) {
                // 填充入驻表单
                document.getElementById('checkin-user-name').textContent = `房间: ${room.roomNumber}`;
                document.getElementById('checkin-user-id').value = roomId;

                // 设置默认入驻日期为今天
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('checkin-date').value = today;

                // 初始化租户搜索
                initTenantSearch();

                // 显示入驻弹窗
                document.getElementById('checkin-modal').style.display = 'flex';
                document.body.classList.add('modal-open');
            }
        }

        // 初始化租户搜索功能
        function initTenantSearch() {
            const searchInput = document.getElementById('checkin-tenant-search');
            const resultsDiv = document.getElementById('tenant-search-results');
            let selectedTenant = null;

            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();

                if (query.length === 0) {
                    resultsDiv.style.display = 'none';
                    selectedTenant = null;
                    return;
                }

                // 过滤租户
                const filteredTenants = tenantsData.filter(tenant =>
                    tenant.name.toLowerCase().includes(query) ||
                    tenant.phone.includes(query)
                );

                if (filteredTenants.length > 0) {
                    displaySearchResults(filteredTenants, resultsDiv, searchInput);
                } else {
                    resultsDiv.innerHTML = '<div class="search-result-item">未找到匹配的租户，可输入新租户姓名</div>';
                    resultsDiv.style.display = 'block';
                }
            });

            searchInput.addEventListener('focus', function() {
                if (this.value.trim().length > 0) {
                    resultsDiv.style.display = 'block';
                }
            });

            // 点击其他地方隐藏搜索结果
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
                    resultsDiv.style.display = 'none';
                }
            });
        }

        function displaySearchResults(tenants, resultsDiv, searchInput) {
            resultsDiv.innerHTML = '';

            tenants.forEach(tenant => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.innerHTML = `
                    <div class="tenant-name">${tenant.name}</div>
                    <div class="tenant-phone">${tenant.phone}</div>
                `;

                item.addEventListener('click', function() {
                    searchInput.value = tenant.name;
                    searchInput.dataset.tenantId = tenant.id;
                    searchInput.dataset.tenantPhone = tenant.phone;
                    resultsDiv.style.display = 'none';
                });

                resultsDiv.appendChild(item);
            });

            resultsDiv.style.display = 'block';
        }

        function checkoutTenant(roomId) {
            const room = roomsData.find(r => r.id === roomId);
            if (room) {
                // 填充退租表单
                const lang = getCurrentLanguage();
                const tenantName = room.tenant ? (lang === 'en' ? room.tenantEn : room.tenant) : (lang === 'en' ? 'Unknown Tenant' : '未知租户');
                document.getElementById('checkout-user-name').textContent = tenantName;
                document.getElementById('checkout-user-room').textContent = room.roomNumber;
                document.getElementById('checkout-user-id').value = roomId;

                // 设置默认退租日期为今天
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('checkout-date').value = today;

                // 设置当前电表读数
                if (room.electricityReading) {
                    document.getElementById('checkout-electricity-reading').value = room.electricityReading;
                }

                // 显示退租弹窗
                document.getElementById('checkout-modal').style.display = 'flex';
                document.body.classList.add('modal-open');
            }
        }

        // 入驻弹窗函数
        function hideCheckinModal() {
            document.getElementById('checkin-modal').style.display = 'none';
            document.body.classList.remove('modal-open');
            // 清空表单
            document.getElementById('checkin-form').reset();
            document.getElementById('checkin-user-name').textContent = '--';
            document.getElementById('checkin-user-id').value = '';
            // 清空搜索输入
            const searchInput = document.getElementById('checkin-tenant-search');
            searchInput.value = '';
            searchInput.dataset.tenantId = '';
            searchInput.dataset.tenantPhone = '';
            document.getElementById('tenant-search-results').style.display = 'none';
        }

        function readCurrentMeter() {
            // 模拟读取当前电表读数
            const currentReading = (Math.random() * 1000 + 500).toFixed(2);
            document.getElementById('electricity-reading').value = currentReading;

            if (typeof EnergySystem !== 'undefined') {
                EnergySystem.showNotification(`已读取当前电表读数：${currentReading} kWh`, 'success');
            } else {
                alert(`已读取当前电表读数：${currentReading} kWh`);
            }
        }

        function saveCheckin() {
            const formData = new FormData(document.getElementById('checkin-form'));
            const roomId = document.getElementById('checkin-user-id').value;
            const searchInput = document.getElementById('checkin-tenant-search');

            // 获取表单数据
            const checkinData = {
                tenantName: searchInput.value.trim(),
                tenantPhone: searchInput.dataset.tenantPhone || '',
                checkinDate: formData.get('checkinDate'),
                electricityReading: parseFloat(formData.get('electricityReading'))
            };

            // 验证必填字段
            if (!checkinData.tenantName || !checkinData.checkinDate ||
                isNaN(checkinData.electricityReading)) {
                alert('请填写所有必填字段');
                return;
            }

            // 验证读数值
            if (checkinData.electricityReading < 0) {
                alert('电表读数不能为负数');
                return;
            }

            try {
                // 更新房间状态
                const room = roomsData.find(r => r.id === roomId);
                if (room) {
                    room.status = 'occupied';
                    room.tenant = checkinData.tenantName;
                    room.tenantPhone = checkinData.tenantPhone;
                    room.checkinDate = checkinData.checkinDate;
                    room.electricityReading = checkinData.electricityReading;

                    // 重新渲染表格和卡片
                    renderRoomsTable();
                    renderRoomsCards();

                    // 关闭弹窗
                    hideCheckinModal();

                    // 显示成功消息
                    if (typeof EnergySystem !== 'undefined') {
                        EnergySystem.showNotification(`${checkinData.tenantName} 入驻成功！房间：${room.roomNumber}`, 'success');
                    } else {
                        alert(`${checkinData.tenantName} 入驻成功！房间：${room.roomNumber}`);
                    }
                }
            } catch (error) {
                console.error('入驻保存失败:', error);
                alert('入驻保存失败，请重试');
            }
        }

        // 退租弹窗函数
        function hideCheckoutModal() {
            document.getElementById('checkout-modal').style.display = 'none';
            document.body.classList.remove('modal-open');
            // 清空表单
            document.getElementById('checkout-form').reset();
        }

        function readCurrentMeterForCheckout() {
            // 模拟读取当前电表读数
            const currentReading = (Math.random() * 1000 + 500).toFixed(2);
            document.getElementById('checkout-electricity-reading').value = currentReading;

            if (typeof EnergySystem !== 'undefined') {
                EnergySystem.showNotification(`已读取当前电表读数：${currentReading} kWh`, 'success');
            } else {
                alert(`已读取当前电表读数：${currentReading} kWh`);
            }
        }

        function saveCheckout() {
            const formData = new FormData(document.getElementById('checkout-form'));
            const roomId = document.getElementById('checkout-user-id').value;

            // 获取表单数据
            const checkoutData = {
                checkoutDate: formData.get('checkoutDate'),
                electricityReading: parseFloat(formData.get('electricityReading'))
            };

            // 验证必填字段
            if (!checkoutData.checkoutDate || isNaN(checkoutData.electricityReading)) {
                alert('请填写所有必填字段');
                return;
            }

            // 验证读数值
            if (checkoutData.electricityReading < 0) {
                alert('电表读数不能为负数');
                return;
            }

            try {
                // 更新房间状态
                const room = roomsData.find(r => r.id === roomId);
                if (room) {
                    const tenantName = room.tenant;
                    room.status = 'vacant';
                    room.checkoutDate = checkoutData.checkoutDate;
                    room.finalElectricityReading = checkoutData.electricityReading;
                    // 清除租户信息
                    room.tenant = null;
                    room.tenantPhone = null;

                    // 重新渲染表格和卡片
                    renderRoomsTable();
                    renderRoomsCards();

                    // 关闭弹窗
                    hideCheckoutModal();

                    // 显示成功消息
                    if (typeof EnergySystem !== 'undefined') {
                        EnergySystem.showNotification(`${tenantName} 退租成功！房间：${room.roomNumber}`, 'success');
                    } else {
                        alert(`${tenantName} 退租成功！房间：${room.roomNumber}`);
                    }
                }
            } catch (error) {
                console.error('退租保存失败:', error);
                alert('退租保存失败，请重试');
            }
        }

        function hideDeleteConfirm() {
            document.getElementById('delete-confirm-modal').style.display = 'none';
            document.body.classList.remove('modal-open');
            deleteUserId = null;
        }

        function confirmDelete() {
            if (deleteUserId) {
                const index = usersData.findIndex(u => u.id === deleteUserId);
                if (index > -1) {
                    const userName = usersData[index].name;
                    usersData.splice(index, 1);
                    renderUsersTable();
                    hideDeleteConfirm();

                    if (typeof EnergySystem !== 'undefined') {
                        EnergySystem.showNotification(`${userName} 删除成功！`, 'success');
                    } else {
                        alert(`${userName} 删除成功！`);
                    }
                }
            }
        }

        // 点击模态框外部关闭
        document.addEventListener('click', function(event) {
            const userModal = document.getElementById('user-modal');
            if (event.target === userModal || event.target === userModal.querySelector('.modal-overlay')) {
                hideModal();
            }

            const buildingModal = document.getElementById('building-modal');
            if (event.target === buildingModal || event.target === buildingModal.querySelector('.modal-overlay')) {
                hideBuildingModal();
            }

            const floorModal = document.getElementById('floor-modal');
            if (event.target === floorModal || event.target === floorModal.querySelector('.modal-overlay')) {
                hideFloorModal();
            }

            const deleteBuildingModal = document.getElementById('delete-building-modal');
            if (event.target === deleteBuildingModal || event.target === deleteBuildingModal.querySelector('.modal-overlay')) {
                hideBuildingDeleteConfirm();
            }

            const deleteFloorModal = document.getElementById('delete-floor-modal');
            if (event.target === deleteFloorModal || event.target === deleteFloorModal.querySelector('.modal-overlay')) {
                hideFloorDeleteConfirm();
            }

            const checkinModal = document.getElementById('checkin-modal');
            if (event.target === checkinModal || event.target === checkinModal.querySelector('.modal-overlay')) {
                hideCheckinModal();
            }

            const checkoutModal = document.getElementById('checkout-modal');
            if (event.target === checkoutModal || event.target === checkoutModal.querySelector('.modal-overlay')) {
                hideCheckoutModal();
            }

            const deleteModal = document.getElementById('delete-confirm-modal');
            if (event.target === deleteModal || event.target === deleteModal.querySelector('.modal-overlay')) {
                hideDeleteConfirm();
            }
        });

        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            console.log('空间管理页面加载开始');

            // 检查EnergySystem是否可用
            if (typeof EnergySystem !== 'undefined') {
                console.log('EnergySystem可用');
                EnergySystem.setActiveNavigation('space-management.html');
                // 检查initLanguageSystem方法是否存在
                if (typeof EnergySystem.initLanguageSystem === 'function') {
                    EnergySystem.initLanguageSystem();
                } else {
                    console.log('EnergySystem.initLanguageSystem方法不存在，使用备用语言系统');
                    if (typeof initLanguageSystem === 'function') {
                        initLanguageSystem();
                    }
                }
            } else {
                console.log('EnergySystem不可用，使用简单语言系统');
                if (typeof initLanguageSystem === 'function') {
                    initLanguageSystem();
                }
            }

            // 输出数据信息
            console.log('初始化时buildingsData length:', buildingsData.length);
            console.log('初始化时roomsData length:', roomsData.length);
            console.log('buildingsData sample:', buildingsData[0]);
            console.log('roomsData sample:', roomsData[0]);

            // 渲染建筑树和房间表格
            console.log('准备渲染建筑树...');
            renderBuildingTree();
            console.log('准备渲染房间表格...');
            renderRoomsTable();

            // 初始化表单选项
            initializeBuildingOptions();
            initializeMeterOptions();
            initializeBillingTemplateOptions();
            initializeFloorSelectDefault();
            console.log('空间管理页面初始化完成');

            // 添加语言切换事件监听器
            const languageSelect = document.getElementById('language-select');
            if (languageSelect) {
                languageSelect.addEventListener('change', function() {
                    console.log('语言切换到:', this.value);
                    // 重新渲染动态内容以应用新语言
                    renderBuildingTree();
                    initializeBuildingOptions();
                    initializeMeterOptions();
                    initializeBillingTemplateOptions();
                    initializeFloorSelectDefault();
                    updateFloorOptions();
                    if (currentView === 'table') {
                        renderRoomsTable();
                    } else {
                        renderRoomsCards();
                    }
                });
            }

            // 添加实时输入验证
            const buildingNameInput = document.getElementById('building-name');
            if (buildingNameInput) {
                buildingNameInput.addEventListener('input', function() {
                    if (this.value.length > 20) {
                        const lang = getCurrentLanguage();
                        this.style.borderColor = 'red';
                        this.title = lang === 'en' ? 'Building name cannot exceed 20 characters' : '楼栋名称不能超过20个字符';
                    } else {
                        this.style.borderColor = '';
                        this.title = '';
                    }
                });
            }

            const totalFloorsInput = document.getElementById('total-floors');
            if (totalFloorsInput) {
                totalFloorsInput.addEventListener('input', function() {
                    const value = parseInt(this.value);
                    if (value < 1 || value > 50) {
                        const lang = getCurrentLanguage();
                        this.style.borderColor = 'red';
                        this.title = lang === 'en' ? 'Total floors must be between 1 and 50' : '楼层数必须在1-50之间';
                    } else {
                        this.style.borderColor = '';
                        this.title = '';
                    }
                });
            }

            // 延迟检查表格和建筑树是否有数据，如果没有则强制显示
            setTimeout(function() {
                const roomsTbody = document.getElementById('rooms-tbody');
                const buildingTree = document.getElementById('building-tree');

                // 检查房间表格
                if (roomsTbody && (!roomsTbody.innerHTML || roomsTbody.innerHTML.trim() === '')) {
                    console.log('房间表格为空，强制显示房间数据');
                    // 直接调用一次渲染函数
                    renderRoomsTable();

                    // 如果还是没有数据，手动插入示例数据
                    setTimeout(function() {
                        if (!roomsTbody.innerHTML || roomsTbody.innerHTML.trim() === '') {
                            roomsTbody.innerHTML = `
                                <tr>
                                    <td>A-101</td>
                                    <td>A栋 1楼</td>
                                    <td>住宅基础计费</td>
                                    <td><span class="status-online">已入驻</span></td>
                                    <td>张三</td>
                                    <td>
                                        <button class="btn-sm btn-primary" onclick="editRoom('ROOM001')">编辑</button>
                                        <button class="btn-sm btn-danger" onclick="deleteRoom('ROOM001')">删除</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>A-102</td>
                                    <td>A栋 1楼</td>
                                    <td>住宅阶梯计费</td>
                                    <td><span class="status-offline">空闲</span></td>
                                    <td>--</td>
                                    <td>
                                        <button class="btn-sm btn-primary" onclick="editRoom('ROOM002')">编辑</button>
                                        <button class="btn-sm btn-danger" onclick="deleteRoom('ROOM002')">删除</button>
                                    </td>
                                </tr>
                            `;
                            console.log('已强制显示房间数据');
                        }
                    }, 500);
                }

                // 检查建筑树
                if (buildingTree && (!buildingTree.innerHTML || buildingTree.innerHTML.trim() === '')) {
                    console.log('建筑树为空，强制显示建筑数据');
                    // 直接调用一次渲染函数
                    renderBuildingTree();

                    // 如果还是没有数据，手动插入示例数据
                    setTimeout(function() {
                        if (!buildingTree.innerHTML || buildingTree.innerHTML.trim() === '') {
                            buildingTree.innerHTML = `
                                <div class="tree-node building-node">
                                    <div class="tree-item" onclick="selectBuilding('BUILDING001')">
                                        <span class="tree-icon">🏢</span>
                                        <span class="tree-label">A栋</span>
                                        <div class="tree-actions">
                                            <button class="btn-icon" onclick="event.stopPropagation(); editBuilding('BUILDING001')" title="编辑楼栋">✏️</button>
                                            <button class="btn-icon" onclick="event.stopPropagation(); deleteBuilding('BUILDING001')" title="删除楼栋">🗑️</button>
                                        </div>
                                    </div>
                                    <div class="tree-children">
                                        <div class="tree-node floor-node">
                                            <div class="tree-item" onclick="selectFloor('FLOOR001')">
                                                <span class="tree-icon">📁</span>
                                                <span class="tree-label">1楼</span>
                                                <div class="tree-actions">
                                                    <button class="btn-icon" onclick="event.stopPropagation(); editFloor('FLOOR001')" title="编辑楼层">✏️</button>
                                                    <button class="btn-icon" onclick="event.stopPropagation(); addRoomToFloor('FLOOR001')" title="添加房间">➕</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            console.log('已强制显示建筑树数据');
                        }
                    }, 500);
                }
            }, 1000);
        });
    </script>
    <script>
        // 添加用户管理页面特有样式 - 与bills.html保持一致
        const style = document.createElement('style');
        style.textContent = `
            /* 导航栏样式 - 覆盖common.css */
            .navbar {
                height: 56px !important;
                overflow: hidden !important;
                background: rgba(255, 255, 255, 0.8) !important;
                backdrop-filter: blur(20px) !important;
                border-bottom: var(--border) !important;
                position: sticky !important;
                top: 0 !important;
                z-index: 1000 !important;
            }

            .nav-content {
                display: flex !important;
                align-items: center !important;
                justify-content: space-between !important;
                padding: 12px 20px !important;
                gap: 15px !important;
                height: 100% !important;
                max-width: none !important;
                margin: 0 !important;
            }

            .nav-brand {
                display: flex !important;
                align-items: center !important;
                flex-shrink: 0 !important;
            }

            .nav-menu {
                flex: 1 !important;
                display: flex !important;
                justify-content: center !important;
                gap: 20px !important;
            }

            .nav-actions {
                display: flex !important;
                align-items: center !important;
                gap: 15px !important;
            }

            .nav-logo {
                height: 32px !important;
                max-width: 150px !important;
                object-fit: contain !important;
                transition: all 0.2s ease !important;
            }

            .nav-logo:hover {
                transform: scale(1.02) !important;
            }

            /* 布局系统 */
            .content-layout {
                display: flex;
                max-width: 1600px;
                margin: 0 auto;
                padding: var(--space-12) var(--space-8);
                gap: var(--space-6);
            }

            /* 左侧边栏样式 */
            .sidebar-container {
                width: 300px;
                flex-shrink: 0;
                background: var(--background);
                border: var(--border);
                border-radius: var(--radius);
                overflow: hidden;
                height: fit-content;
                max-height: calc(100vh - 120px);
                display: flex;
                flex-direction: column;
            }

            .sidebar-header {
                padding: var(--space-4) var(--space-6);
                background: var(--surface);
                border-bottom: var(--border);
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .sidebar-header h3 {
                margin: 0;
                font-size: 16px;
                font-weight: 600;
                color: var(--text-primary);
            }

            .sidebar-actions {
                display: flex;
                gap: var(--space-2);
            }

            .tree-container {
                flex: 1;
                overflow-y: auto;
                padding: var(--space-4);
            }

            /* 树结构样式 */
            .tree {
                font-size: 14px;
            }

            .tree-node {
                margin-bottom: var(--space-2);
            }

            .tree-item {
                display: flex;
                align-items: center;
                padding: var(--space-2) var(--space-3);
                border-radius: var(--radius);
                cursor: pointer;
                transition: all 0.2s ease;
                position: relative;
                gap: var(--space-2);
            }

            .tree-item:hover {
                background: var(--surface);
            }

            .tree-item.selected {
                background: var(--primary);
                color: white;
            }

            .tree-item.selected .tree-actions {
                opacity: 1;
            }

            .tree-icon {
                font-size: 16px;
                width: 20px;
                text-align: center;
                flex-shrink: 0;
            }

            .tree-label {
                flex: 1;
                font-weight: 500;
            }

            .tree-actions {
                display: flex;
                gap: var(--space-1);
                opacity: 0;
                transition: opacity 0.2s ease;
            }

            .tree-item:hover .tree-actions {
                opacity: 1;
            }

            .btn-icon {
                background: none;
                border: none;
                padding: 2px 4px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
                transition: all 0.2s ease;
            }

            .btn-icon:hover {
                background: rgba(0, 0, 0, 0.1);
            }

            .tree-item.selected .btn-icon:hover {
                background: rgba(255, 255, 255, 0.2);
            }

            .tree-children {
                margin-left: var(--space-6);
                margin-top: var(--space-2);
                border-left: 2px solid var(--divider);
                padding-left: var(--space-4);
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease;
            }

            .tree-children.expanded {
                max-height: 1000px;
            }

            .floor-item {
                margin-bottom: var(--space-1);
                font-size: 13px;
            }

            .floor-item .tree-icon {
                font-size: 14px;
            }

            .main-container {
                flex: 1;
                min-width: 0;
                padding-top: 0;
            }

            /* 表格标题样式 */
            .table-title {
                font-size: 16px;
                font-weight: 600;
                color: var(--text-primary);
            }

            /* 搜索区域样式 */
            .search-section {
                background: var(--background);
                border: var(--border);
                border-radius: var(--radius);
                padding: var(--space-6);
                margin-bottom: var(--space-6);
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: var(--space-4);
            }

            .search-controls {
                display: flex;
                gap: var(--space-4);
                flex: 1;
            }

            .search-controls .form-input {
                min-width: 300px;
            }

            .search-actions {
                display: flex;
                gap: var(--space-3);
            }

            /* 表单样式 - 从设备管理页面复制 */
            .form-input,
            .form-select,
            .form-textarea {
                padding: 12px 16px !important;
                border: 1px solid #F0F0F0 !important;
                border-radius: 8px !important;
                background: #FFFFFF !important;
                color: #000000 !important;
                font-size: 14px !important;
                transition: all 0.2s ease !important;
                outline: none !important;
                font-family: inherit !important;
                width: 100% !important;
                display: block !important;
            }

            .form-input:focus,
            .form-select:focus,
            .form-textarea:focus {
                border-color: #0066CC !important;
                box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1) !important;
                background: #FFFFFF !important;
            }

            .form-input:hover,
            .form-select:hover {
                border-color: #666666 !important;
            }

            /* 表格头部样式 - 从设备管理页面复制 */
            .table-header {
                background: var(--background);
                border: var(--border);
                border-bottom: none;
                border-radius: var(--radius) var(--radius) 0 0;
                padding: var(--space-4) var(--space-6);
                display: flex;
                justify-content: flex-start;
                align-items: center;
                margin-bottom: 0;
            }

            .table-container {
                background: transparent;
                border: none;
                border-radius: 0;
                overflow: hidden;
                margin-bottom: 0;
            }

            .table-container .table {
                border: none;
                margin: 0;
            }

            /* 按钮样式 - 从设备管理页面复制 */
            .btn {
                padding: var(--space-2) var(--space-4);
                border: none;
                border-radius: var(--radius);
                font-family: inherit;
                font-size: 14px;
                font-weight: var(--font-weight-medium);
                cursor: pointer;
                transition: all 0.15s ease;
                text-decoration: none;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: var(--space-2);
            }

            .btn-primary {
                background: var(--primary);
                color: white;
            }

            .btn-primary:hover {
                transform: translateY(-1px);
                box-shadow: var(--shadow-hover);
            }

            .btn-secondary {
                background: var(--surface);
                color: var(--text-primary);
                border: var(--border);
            }

            .btn-secondary:hover {
                background: var(--divider);
            }

            .btn-success {
                background: #000000 !important;
                color: white !important;
                border: 1px solid #000000 !important;
            }

            .btn-success:hover {
                background: #333333 !important;
                border-color: #333333 !important;
                transform: translateY(-1px) !important;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
            }

            .btn-warning {
                background: #ff9500;
                color: white;
                border: 1px solid #ff9500;
            }

            .btn-warning:hover {
                background: #e6850e;
                border-color: #e6850e;
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(255, 149, 0, 0.15);
            }

            .btn-sm {
                padding: 3px 6px;
                font-size: 10px;
                min-width: auto;
                white-space: nowrap;
                margin: 1px;
            }

            /* 操作按钮容器 - 确保按钮在一行显示 */
            .table td:last-child {
                white-space: nowrap;
                min-width: 200px;
                text-align: center;
            }

            /* 针对操作按钮的特别样式 */
            .table .btn-sm {
                display: inline-block;
                margin: 0 1px;
                padding: 2px 4px;
                font-size: 9px;
                line-height: 1.2;
            }

            /* 卡片视图中的按钮样式 */
            .card .btn-sm {
                padding: 3px 6px;
                font-size: 10px;
                margin: 2px 1px;
                display: inline-block;
            }

            /* 确保按钮容器不换行 */
            .card .room-actions,
            .table .room-actions {
                white-space: nowrap;
                display: flex;
                gap: 2px;
                justify-content: center;
                flex-wrap: nowrap;
            }

            /* 语言下拉列表样式 */
            .lang-dropdown {
                display: flex;
                align-items: center;
            }

            .lang-select {
                min-width: 100px;
                padding: var(--space-2) var(--space-3);
                border: var(--border);
                border-radius: var(--radius);
                background: var(--background);
                font-size: 14px;
                font-weight: var(--font-weight-medium);
                cursor: pointer;
                transition: all 0.15s ease;
            }

            .lang-select:focus {
                outline: 2px solid var(--accent);
                outline-offset: -2px;
            }

            .lang-select:hover {
                background: var(--surface);
            }

            .pagination {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: var(--space-4);
                padding: var(--space-6);
                background: var(--surface);
                border-top: var(--border);
            }

            .page-info {
                font-size: 14px;
                color: var(--text-secondary);
            }

            /* 用户状态样式 */
            .device-status {
                padding: var(--space-1) var(--space-2);
                border-radius: calc(var(--radius) / 2);
                font-size: 12px;
                font-weight: var(--font-weight-medium);
                display: inline-block;
                min-width: 48px;
                text-align: center;
            }

            .status-online {
                background: rgba(40, 167, 69, 0.1);
                color: var(--success);
            }

            .status-offline {
                background: rgba(255, 149, 0, 0.1);
                color: var(--warning);
            }

            .status-pending {
                background: rgba(108, 117, 125, 0.1);
                color: #6c757d;
            }

            .btn-danger {
                background: #dc2626;
                color: white;
                border: 1px solid #dc2626;
            }

            .btn-danger:hover {
                background: #b91c1c;
                border-color: #b91c1c;
            }

            .btn-success {
                background: #16a34a;
                color: white;
                border: 1px solid #16a34a;
            }

            .btn-success:hover {
                background: #15803d;
                border-color: #15803d;
            }

            /* 右抽屉模态框样式 - 与设备管理页面保持一致 */
            .modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(8px);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: flex-end;
                padding: 0;
                overflow: hidden;
            }

            .modal[style*="flex"] {
                display: flex !important;
            }

            /* 防止背景页面滚动 */
            body.modal-open {
                overflow: hidden;
            }

            /* 强制显示红色星号 */
            .required-asterisk {
                color: #ff0000 !important;
                font-weight: bold !important;
                margin-left: 3px !important;
                font-size: 14px !important;
                display: inline !important;
                visibility: visible !important;
                opacity: 1 !important;
            }

            /* 覆盖所有可能的样式 */
            label .required-asterisk,
            .form-group label .required-asterisk,
            .modal .required-asterisk,
            * .required-asterisk {
                color: #ff0000 !important;
                font-weight: bold !important;
                margin-left: 3px !important;
                font-size: 14px !important;
                display: inline !important;
                visibility: visible !important;
                opacity: 1 !important;
                text-decoration: none !important;
                background: none !important;
            }

            .modal-overlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.3);
                z-index: -1;
            }

            .modal-content {
                background: var(--background);
                border-radius: 0;
                box-shadow: -10px 0 30px rgba(0, 0, 0, 0.3);
                width: 500px;
                height: 100vh;
                overflow: hidden;
                position: relative;
                z-index: 1;
                animation: drawerSlideIn 0.3s ease-out;
                display: flex;
                flex-direction: column;
            }

            @keyframes drawerSlideIn {
                from {
                    opacity: 0;
                    transform: translateX(100%);
                }
                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }

            .modal-header {
                padding: 24px 32px;
                background: var(--background);
                color: var(--text-primary);
                border-radius: 0;
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: var(--border);
                flex-shrink: 0;
            }

            .modal-header h3 {
                margin: 0;
                font-size: 20px;
                font-weight: 600;
                color: var(--text-primary);
            }

            .modal-close {
                background: none;
                border: none;
                color: var(--text-secondary);
                font-size: 24px;
                font-weight: bold;
                cursor: pointer;
                padding: 8px;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s ease;
            }

            .modal-close:hover {
                background: var(--surface);
                color: var(--text-primary);
                transform: scale(1.1);
            }

            .modal-body {
                padding: 32px;
                flex: 1;
                overflow-y: auto;
            }

            .modal-footer {
                padding: 20px 32px;
                background: var(--surface);
                border-top: var(--border);
                display: flex;
                justify-content: flex-end;
                gap: 12px;
                border-radius: 0;
                flex-shrink: 0;
            }

            /* 表单样式 */
            .user-form {
                display: flex;
                flex-direction: column;
                gap: 24px;
            }

            .form-section {
                background: var(--surface);
                border: var(--border);
                border-radius: var(--radius);
                padding: 24px;
                position: relative;
            }

            .section-title {
                margin: 0 0 20px 0;
                font-size: 16px;
                font-weight: 600;
                color: var(--text-primary);
                display: flex;
                align-items: center;
                gap: 8px;
                padding-bottom: 8px;
                border-bottom: 2px solid var(--primary);
            }

            .section-title::before {
                content: '';
                width: 4px;
                height: 16px;
                background: var(--primary);
                border-radius: 2px;
            }

            .form-row {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 20px;
                margin-bottom: 16px;
            }

            .form-row:last-child {
                margin-bottom: 0;
            }

            .form-group {
                display: flex;
                flex-direction: column;
                gap: 6px;
            }

            .form-group.full-width {
                grid-column: 1 / -1;
            }

            .form-group label {
                font-size: 14px;
                font-weight: 500;
                color: var(--text-primary);
                display: flex;
                align-items: center;
                gap: 4px;
            }

            .form-input,
            .form-select,
            .form-textarea {
                padding: 12px 16px;
                border: 2px solid var(--border-color);
                border-radius: var(--radius);
                background: var(--background);
                color: var(--text-primary);
                font-size: 14px;
                transition: all 0.2s ease;
                outline: none;
                font-family: inherit;
            }

            .form-input:focus,
            .form-select:focus,
            .form-textarea:focus {
                border-color: var(--primary);
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
                background: var(--background);
            }

            .form-input:hover,
            .form-select:hover {
                border-color: var(--accent);
            }

            .form-textarea {
                resize: vertical;
                min-height: 80px;
                font-family: inherit;
                line-height: 1.5;
            }

            .form-input::placeholder,
            .form-textarea::placeholder {
                color: var(--text-secondary);
                opacity: 0.7;
            }

            .form-hint {
                font-size: 12px;
                color: var(--text-secondary);
                margin-top: 4px;
                font-style: italic;
            }

            .form-input[required]:invalid {
                border-color: var(--error);
            }

            .form-input[required]:invalid:focus {
                box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
            }

            /* 按钮样式 - 与bills.html保持一致 */
            .btn {
                padding: var(--space-2) var(--space-4);
                border: none;
                border-radius: var(--radius);
                font-family: inherit;
                font-size: 14px;
                font-weight: var(--font-weight-medium);
                cursor: pointer;
                transition: all 0.15s ease;
                text-decoration: none;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: var(--space-2);
            }

            .btn-primary {
                background: var(--primary);
                color: white;
            }

            .btn-primary:hover {
                transform: translateY(-1px);
                box-shadow: var(--shadow-hover);
            }

            .btn-secondary {
                background: var(--surface);
                color: var(--text-primary);
                border: var(--border);
            }

            .btn-secondary:hover {
                background: var(--divider);
            }

            .actions {
                display: flex;
                gap: var(--space-2);
            }

            /* 响应式设计 */
            @media (max-width: 1200px) {
                .content-layout {
                    flex-direction: column;
                }

                .sidebar-container {
                    width: 100%;
                    max-height: 300px;
                    margin-bottom: var(--space-4);
                }

                .tree-children.expanded {
                    max-height: 200px;
                }
            }

            @media (max-width: 768px) {
                .content-layout {
                    padding: var(--space-8) var(--space-4);
                }

                .sidebar-container {
                    max-height: 250px;
                }

                .sidebar-header {
                    padding: var(--space-3) var(--space-4);
                }

                .tree-container {
                    padding: var(--space-3);
                }

                .search-section {
                    flex-direction: column;
                    align-items: stretch;
                }

                .search-controls {
                    flex-direction: column;
                }

                .search-controls .form-input {
                    min-width: auto;
                }

                .table-header {
                    flex-direction: column;
                    gap: var(--space-3);
                    align-items: stretch;
                }

                .modal {
                    padding: 10px;
                }

                .modal-content {
                    margin-top: 20px;
                    max-height: calc(100vh - 20px);
                }

                .modal-header,
                .modal-body,
                .modal-footer {
                    padding: 20px;
                }

                .form-row {
                    grid-template-columns: 1fr;
                    gap: 16px;
                }

                .form-section {
                    padding: 16px;
                }

                .nav-menu {
                    gap: 10px !important;
                }

                .tree-actions {
                    opacity: 1;
                }

                .btn-icon {
                    padding: 4px 6px;
                    font-size: 14px;
                }
            }

            /* 删除确认模态框样式 */
            #delete-confirm-modal,
            #delete-building-modal,
            #delete-floor-modal {
                justify-content: center !important;
                align-items: center !important;
            }

            .delete-confirm-modal {
                width: 450px !important;
                height: auto !important;
                max-width: 90vw;
                border-radius: var(--radius) !important;
                position: relative;
                margin: 0;
                transform: translateY(0);
            }

            .delete-warning-icon {
                font-size: 48px;
                text-align: center;
                margin-bottom: 16px;
            }

            .delete-warning-box {
                background: #fff5f5;
                border: 1px solid #fecaca;
                border-radius: 8px;
                padding: 16px;
                margin: 16px 0;
            }

            .delete-warning {
                color: #dc2626;
                font-size: 14px;
                margin: 8px 0;
                font-weight: 500;
            }

            .delete-warning-list {
                margin: 12px 0;
                padding-left: 0;
                list-style: none;
            }

            .delete-warning-list li {
                color: #7f1d1d;
                font-size: 14px;
                margin: 6px 0;
                padding-left: 8px;
            }

            .delete-confirm-modal .modal-body {
                text-align: center;
            }

            .delete-confirm-modal .modal-body p {
                font-size: 16px;
                font-weight: 500;
                color: var(--text-primary);
                margin-bottom: 12px;
            }

            /* 视图切换标签页样式 */
            .view-tabs {
                display: flex;
                justify-content: space-between;
                align-items: flex-end;
                margin-bottom: 0;
                border-bottom: 1px solid #e0e0e0;
                padding-bottom: 0;
                background: #f8f9fa;
                padding: 8px var(--space-6) 0 8px;
                border-radius: 8px 8px 0 0;
            }

            .tabs-left {
                display: flex;
                gap: 4px;
            }

            .tabs-right {
                display: flex;
                align-items: center;
                gap: 8px;
                padding-bottom: 8px;
                margin-right: 0;
            }

            .tabs-right .btn {
                margin-right: 0;
            }

            .tab-btn {
                padding: 12px 24px;
                border: none;
                background: transparent;
                color: #555;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.3s ease;
                border-radius: 8px 8px 0 0;
                position: relative;
                outline: none;
            }

            .tab-btn:hover {
                background: #f5f5f5;
                color: #222;
            }

            .tab-btn:focus {
                outline: 2px solid var(--primary-color);
                outline-offset: 2px;
            }

            .tab-btn.active {
                background: white;
                color: var(--primary-color);
                font-weight: 600;
                border: 1px solid #e0e0e0;
                border-bottom: 1px solid white;
                box-shadow: 0 -2px 4px rgba(0,0,0,0.05);
            }

            .tab-btn.active::after {
                content: '';
                position: absolute;
                bottom: -2px;
                left: 0;
                right: 0;
                height: 2px;
                background: var(--primary-color);
            }

            /* 视图布局容器 */
            .views-layout {
                background: white;
                border: 1px solid #e0e0e0;
                border-top: none;
                border-radius: 0 0 8px 8px;
                padding: 20px;
                margin-bottom: 20px;
            }

            /* 视图容器样式 */
            .view-container {
                width: 100%;
                background: transparent;
                border: none;
                border-radius: 0;
                padding: 0;
                margin-bottom: 0;
            }

            /* 视图内容头部 */
            .view-content-header {
                display: none; /* 隐藏空的头部 */
            }

            /* 位置选择器样式 */
            .location-selector {
                display: flex;
                gap: 8px;
                align-items: center;
            }

            .location-selector select {
                flex: 1;
            }


            /* 卡片网格样式 */
            .cards-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
                gap: 20px;
                padding: 0;
            }

            .room-card {
                background: white;
                border: 1px solid #e0e0e0;
                border-radius: 12px;
                overflow: hidden;
                transition: all 0.3s ease;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                cursor: default;
            }

            .room-card:hover {
                transform: translateY(-4px);
                box-shadow: 0 8px 25px rgba(0,0,0,0.15);
                border-color: var(--primary-color);
            }

            .room-card:focus-within {
                outline: 2px solid var(--primary-color);
                outline-offset: 2px;
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(0,0,0,0.12);
            }


            .card-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 16px 20px;
                background: linear-gradient(135deg, #f8f9fa, #e9ecef);
                border-bottom: 1px solid #e0e0e0;
            }

            .room-number {
                font-size: 18px;
                font-weight: 700;
                color: #111;
                margin: 0;
            }

            .status-badge {
                padding: 4px 12px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 500;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .status-badge.success {
                background: #10b981;
                color: white;
                border: 1px solid #059669;
                font-weight: 600;
            }

            .status-badge.warning {
                background: #f59e0b;
                color: white;
                border: 1px solid #d97706;
                font-weight: 600;
            }

            /* 租户搜索样式 */
            .tenant-select-wrapper {
                position: relative;
            }

            .search-results {
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: white;
                border: 1px solid #ddd;
                border-top: none;
                border-radius: 0 0 6px 6px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                max-height: 200px;
                overflow-y: auto;
                z-index: 1000;
                display: none;
            }

            .search-result-item {
                padding: 12px 16px;
                cursor: pointer;
                border-bottom: 1px solid #f0f0f0;
                transition: background-color 0.2s;
            }

            .search-result-item:hover {
                background-color: #f5f5f5;
            }

            .search-result-item:last-child {
                border-bottom: none;
            }

            .search-result-item.selected {
                background-color: #e3f2fd;
                color: #1976d2;
            }

            .tenant-name {
                font-weight: 500;
                color: #333;
            }

            .tenant-phone {
                font-size: 12px;
                color: #666;
                margin-top: 2px;
            }


            .card-body {
                padding: 20px;
            }

            .card-info {
                margin-bottom: 16px;
            }

            .card-info p {
                margin: 8px 0;
                font-size: 14px;
                color: #333;
                line-height: 1.5;
            }

            .card-info strong {
                color: #111;
                font-weight: 600;
            }

            .card-actions {
                display: flex;
                gap: 8px;
                justify-content: flex-end;
            }

            .card-actions .btn {
                font-size: 12px;
                padding: 6px 12px;
                font-weight: 600;
                border-radius: 6px;
                transition: all 0.2s ease;
            }

            .card-actions .btn:focus {
                outline: 2px solid var(--primary-color);
                outline-offset: 2px;
            }

            .no-data {
                grid-column: 1 / -1;
                text-align: center;
                padding: 60px 20px;
                color: #666;
                font-size: 16px;
                font-style: italic;
                background: #f9f9f9;
                border-radius: 12px;
                border: 2px dashed #ddd;
            }

            /* 响应式设计 */
            @media (max-width: 768px) {
                .cards-grid {
                    grid-template-columns: 1fr;
                }

                .view-tabs {
                    flex-direction: column;
                    gap: 8px;
                    padding: 8px;
                }

                .tabs-left {
                    order: 1;
                }

                .tabs-right {
                    order: 2;
                    justify-content: flex-start;
                    padding-bottom: 0;
                }

                .tab-btn {
                    border-radius: 8px;
                    margin-bottom: 4px;
                }

                .tab-btn.active::after {
                    display: none;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-zh="ç©ºé—´ç®¡ç†" data-en="Space Management">ç©ºé—´ç®¡ç†</title>
    <link rel="stylesheet" href="assets/css/common.css">
    <link rel="stylesheet" href="assets/css/navbar.css">
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-brand">
                <img src="logo.png" alt="Logo" class="nav-logo">
            </div>
            <div class="nav-menu">
                <a href="dashboard.html" class="nav-link" data-zh="ä»ªè¡¨ç›˜" data-en="Dashboard">ä»ªè¡¨ç›˜</a>
                <a href="pricing-templates.html" class="nav-link" data-zh="ç”µä»·æ¨¡ç‰ˆ" data-en="Pricing Templates">ç”µä»·æ¨¡ç‰ˆ</a>
                <a href="space-management.html" class="nav-link active" data-zh="ç©ºé—´ç®¡ç†" data-en="Space Management">ç©ºé—´ç®¡ç†</a>
                <a href="device-management.html" class="nav-link" data-zh="è®¾å¤‡ç®¡ç†" data-en="Device Management">è®¾å¤‡ç®¡ç†</a>
                <a href="user-management.html" class="nav-link" data-zh="ç”¨æˆ·ç®¡ç†" data-en="User Management">ç”¨æˆ·ç®¡ç†</a>
                <a href="bills.html" class="nav-link" data-zh="è´¦å•ç®¡ç†" data-en="Bill Management">è´¦å•ç®¡ç†</a>
            </div>
            <div class="nav-actions">
                <div class="lang-dropdown">
                    <select id="language-select" class="form-select lang-select">
                        <option value="zh" data-zh="ä¸­æ–‡" data-en="Chinese">ä¸­æ–‡</option>
                        <option value="en" data-zh="English" data-en="English">English</option>
                    </select>
                </div>
                <div class="user-menu">
                    <div class="user-avatar">ç®¡</div>
                    <span data-zh="ç®¡ç†å‘˜" data-en="Admin">ç®¡ç†å‘˜</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <main class="main-content">
        <div class="content-layout">
            <!-- å·¦ä¾§æ ‘ç»“æ„ -->
            <div class="sidebar-container">
                <div class="sidebar-header">
                    <h3 data-zh="å»ºç­‘ç»“æ„" data-en="Building Structure">å»ºç­‘ç»“æ„</h3>
                    <div class="sidebar-actions">
                        <button class="btn btn-sm btn-primary" onclick="showAddBuildingModal()">
                            <span data-zh="+ æ¥¼" data-en="+ Building">+ æ¥¼</span>
                        </button>
                    </div>
                </div>
                <div class="tree-container">
                    <div id="building-tree" class="tree">
                        <!-- æ ‘ç»“æ„ç”±JavaScriptç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- å³ä¾§å†…å®¹åŒºåŸŸ -->
            <div class="main-container">
                <!-- æœç´¢å’Œæ“ä½œåŒºåŸŸ -->
                <div class="search-section">
                    <div class="search-controls">
                        <input type="text" id="room-search" class="form-input" placeholder="æˆ¿é—´å·/ç”µè¡¨å·..." data-zh-placeholder="æˆ¿é—´å·/ç”µè¡¨å·..." data-en-placeholder="Room/Meter...">
                        <select id="room-status-filter" class="form-select">
                            <option value="all" data-zh="å…¨éƒ¨çŠ¶æ€" data-en="All Status">å…¨éƒ¨çŠ¶æ€</option>
                            <option value="vacant" data-zh="ç©ºé—²" data-en="Vacant">ç©ºé—²</option>
                            <option value="occupied" data-zh="å·²å…¥é©»" data-en="Occupied">å·²å…¥é©»</option>
                        </select>
                    </div>
                    <div class="search-actions">
                        <button class="btn btn-primary" onclick="searchRooms()">
                            <span data-zh="æŸ¥è¯¢" data-en="Search">æŸ¥è¯¢</span>
                        </button>
                        <button class="btn btn-secondary" onclick="resetFilters()">
                            <span data-zh="é‡ç½®" data-en="Reset">é‡ç½®</span>
                        </button>
                    </div>
                </div>

                <!-- è§†å›¾åˆ‡æ¢æ ‡ç­¾é¡µ -->
                <div class="view-tabs">
                    <div class="tabs-left">
                        <button class="tab-btn active" onclick="switchView('table')" data-view="table">
                            <span data-zh="è¡¨æ ¼è§†å›¾" data-en="Table View">è¡¨æ ¼è§†å›¾</span>
                        </button>
                        <button class="tab-btn" onclick="switchView('card')" data-view="card">
                            <span data-zh="å¡ç‰‡è§†å›¾" data-en="Card View">å¡ç‰‡è§†å›¾</span>
                        </button>
                    </div>
                    <div class="tabs-right">
                        <button class="btn btn-success btn-sm" onclick="showAddRoomModal()">
                            <span data-zh="+ æ·»åŠ æˆ¿é—´" data-en="+ Add Room">+ æ·»åŠ æˆ¿é—´</span>
                        </button>
                    </div>
                </div>

                <!-- è§†å›¾å†…å®¹åŒºåŸŸ -->
                <div class="views-layout">
                    <!-- æˆ¿é—´åˆ—è¡¨è¡¨æ ¼ -->
                    <div id="table-view" class="view-container table-container">
                        <div class="view-content-header">
                            <div class="view-title">
                                <span id="current-selection" data-zh="" data-en=""></span>
                            </div>
                        </div>
                    <table class="table" id="rooms-table">
                        <thead>
                            <tr>
                                <th data-sortable data-zh="æˆ¿é—´å·" data-en="Room Number">æˆ¿é—´å·</th>
                                <th data-sortable data-zh="æ¥¼å±‚" data-en="Floor">æ¥¼å±‚</th>
                                <th data-sortable data-zh="ç”µè¡¨" data-en="Meter">ç”µè¡¨</th>
                                <th data-sortable data-zh="è®¡è´¹æ¨¡ç‰ˆ" data-en="Billing Template">è®¡è´¹æ¨¡ç‰ˆ</th>
                                <th data-sortable data-zh="ç§Ÿæˆ·" data-en="Tenant">ç§Ÿæˆ·</th>
                                <th data-sortable data-zh="çŠ¶æ€" data-en="Status">çŠ¶æ€</th>
                                <th data-zh="æ“ä½œ" data-en="Actions">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="rooms-tbody">
                            <!-- æ•°æ®ç”±JavaScriptç”Ÿæˆ -->
                        </tbody>
                    </table>

                    <!-- åˆ†é¡µ -->
                    <div class="pagination">
                        <button class="btn btn-secondary" id="prev-page" disabled>
                            <span>â€¹</span>
                            <span data-zh="ä¸Šä¸€é¡µ" data-en="Previous">ä¸Šä¸€é¡µ</span>
                        </button>
                        <div class="page-info">
                            <span data-zh="ç¬¬" data-en="Page">ç¬¬</span>
                            <span id="current-page">1</span>
                            <span data-zh="é¡µï¼Œå…±" data-en="of">é¡µï¼Œå…±</span>
                            <span id="total-pages">3</span>
                            <span data-zh="é¡µ" data-en="pages">é¡µ</span>
                        </div>
                        <button class="btn btn-secondary" id="next-page">
                            <span data-zh="ä¸‹ä¸€é¡µ" data-en="Next">ä¸‹ä¸€é¡µ</span>
                            <span>â€º</span>
                        </button>
                    </div>
                </div>

                    <!-- æˆ¿é—´å¡ç‰‡è§†å›¾ -->
                    <div id="card-view" class="view-container card-container" style="display: none;">
                        <div class="cards-grid" id="rooms-cards">
                            <!-- å¡ç‰‡ç”±JavaScriptç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- æ·»åŠ æ¥¼æ ‹æ¨¡æ€æ¡† -->
    <div id="building-modal" class="modal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="building-modal-title" data-zh="æ·»åŠ æ¥¼æ ‹" data-en="Add Building">æ·»åŠ æ¥¼æ ‹</h3>
                <button class="modal-close" onclick="hideBuildingModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="building-form" class="user-form">
                    <div class="form-row">
                        <div class="form-group">
                            <div style="display: flex; align-items: center;">
                                <span style="color: red; font-size: 14px; margin-right: 2px;">*</span>
                                <label for="building-name" data-zh="æ¥¼æ ‹åç§°" data-en="Building Name">æ¥¼æ ‹åç§°</label>
                            </div>
                            <input type="text" id="building-name" name="buildingName" class="form-input"
                                   data-zh-placeholder="å¦‚ï¼šAæ ‹" data-en-placeholder="e.g., Building A" placeholder="å¦‚ï¼šAæ ‹" required>
                        </div>
                        <div class="form-group">
                            <div style="display: flex; align-items: center;">
                                <span style="color: red; font-size: 14px; margin-right: 2px;">*</span>
                                <label for="total-floors" data-zh="æ€»æ¥¼å±‚æ•°" data-en="Total Floors">æ€»æ¥¼å±‚æ•°</label>
                            </div>
                            <input type="number" id="total-floors" name="totalFloors" class="form-input"
                                   data-zh-placeholder="å¦‚ï¼š5" data-en-placeholder="e.g., 5" placeholder="å¦‚ï¼š5" min="1" max="50" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label for="building-description" data-zh="æ¥¼æ ‹æè¿°" data-en="Building Description">æ¥¼æ ‹æè¿°</label>
                            <textarea id="building-description" name="description" class="form-textarea"
                                      rows="3" data-zh-placeholder="æ¥¼æ ‹ç›¸å…³æè¿°ä¿¡æ¯..." data-en-placeholder="Building related description..." placeholder="æ¥¼æ ‹ç›¸å…³æè¿°ä¿¡æ¯..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideBuildingModal()" data-zh="å–æ¶ˆ" data-en="Cancel">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="saveBuilding()" data-zh="ä¿å­˜" data-en="Save">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ æ¥¼å±‚æ¨¡æ€æ¡† -->
    <div id="floor-modal" class="modal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="floor-modal-title" data-zh="æ·»åŠ æ¥¼å±‚" data-en="Add Floor">æ·»åŠ æ¥¼å±‚</h3>
                <button class="modal-close" onclick="hideFloorModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="floor-form" class="user-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label data-zh="æ‰€å±æ¥¼æ ‹" data-en="Building">æ‰€å±æ¥¼æ ‹</label>
                            <div id="floor-building-name" style="padding: 12px; background: #f5f5f5; border-radius: 6px; color: #666;">--</div>
                            <input type="hidden" id="floor-building-id">
                        </div>
                        <div class="form-group">
                            <div style="display: flex; align-items: center;">
                                <span style="color: red; font-size: 14px; margin-right: 2px;">*</span>
                                <label for="floor-number" data-zh="æ¥¼å±‚å·" data-en="Floor Number">æ¥¼å±‚å·</label>
                            </div>
                            <input type="number" id="floor-number" name="floorNumber" class="form-input"
                                   data-zh-placeholder="å¦‚ï¼š1" data-en-placeholder="e.g., 1" placeholder="å¦‚ï¼š1" min="1" max="50" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label for="floor-description" data-zh="æ¥¼å±‚æè¿°" data-en="Floor Description">æ¥¼å±‚æè¿°</label>
                            <textarea id="floor-description" name="description" class="form-textarea"
                                      rows="3" data-zh-placeholder="æ¥¼å±‚ç›¸å…³æè¿°ä¿¡æ¯..." data-en-placeholder="Floor related description..." placeholder="æ¥¼å±‚ç›¸å…³æè¿°ä¿¡æ¯..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideFloorModal()" data-zh="å–æ¶ˆ" data-en="Cancel">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="saveFloor()" data-zh="ä¿å­˜" data-en="Save">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ æˆ¿é—´æ¨¡æ€æ¡† -->
    <div id="user-modal" class="modal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title" data-zh="æ·»åŠ æˆ¿é—´" data-en="Add Room">æ·»åŠ æˆ¿é—´</h3>
                <button class="modal-close" onclick="hideModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="user-form" class="user-form">
                        <div class="form-row">
                            <div class="form-group">
                                <div style="display: flex; align-items: center;">
                                    <span style="color: red; font-size: 14px; margin-right: 2px;">*</span>
                                    <label for="room-number" data-zh="æˆ¿é—´å·" data-en="Room Number">æˆ¿é—´å·</label>
                                </div>
                                <input type="text" id="room-number" name="roomNumber" class="form-input"
                                       data-zh-placeholder="å¦‚ï¼šA-101" data-en-placeholder="e.g., A-101" placeholder="å¦‚ï¼šA-101" required>
                            </div>
                            <div class="form-group">
                                <label for="room-building" data-zh="ä½ç½®" data-en="Location">ä½ç½®</label>
                                <div class="location-selector">
                                    <select id="room-building" name="building" class="form-input" onchange="updateFloorOptions()" required>
                                        <option value="">è¯·é€‰æ‹©æ¥¼æ ‹</option>
                                    </select>
                                    <select id="room-floor" name="floor" class="form-input" required disabled>
                                        <option value="">è¯·å…ˆé€‰æ‹©æ¥¼æ ‹</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <div style="display: flex; align-items: center;">
                                    <span style="color: red; font-size: 14px; margin-right: 2px;">*</span>
                                    <label for="bind-meter" data-zh="ç»‘å®šç”µè¡¨" data-en="Bind Meter">ç»‘å®šç”µè¡¨</label>
                                </div>
                                <select id="bind-meter" name="meterId" class="form-input" required>
                                    <option value="">è¯·é€‰æ‹©ç”µè¡¨</option>
                                    <option value="METER001">METER001 - å•ç›¸ç”µè¡¨</option>
                                    <option value="METER002">METER002 - ä¸‰ç›¸ç”µè¡¨</option>
                                    <option value="METER003">METER003 - å•ç›¸ç”µè¡¨</option>
                                    <option value="METER004">METER004 - ä¸‰ç›¸ç”µè¡¨</option>
                                    <option value="METER005">METER005 - æ™ºèƒ½ç”µè¡¨</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <div style="display: flex; align-items: center;">
                                    <span style="color: red; font-size: 14px; margin-right: 2px;">*</span>
                                    <label for="billing-template" data-zh="è®¡è´¹æ¨¡ç‰ˆ" data-en="Billing Template">è®¡è´¹æ¨¡ç‰ˆ</label>
                                </div>
                                <select id="billing-template" name="billingTemplate" class="form-input" required>
                                    <option value="">è¯·é€‰æ‹©è®¡è´¹æ¨¡ç‰ˆ</option>
                                    <option value="residential_basic">ä½å®…åŸºç¡€è®¡è´¹</option>
                                    <option value="residential_tiered">ä½å®…é˜¶æ¢¯è®¡è´¹</option>
                                    <option value="commercial_standard">å•†ä¸šæ ‡å‡†è®¡è´¹</option>
                                    <option value="commercial_peak">å•†ä¸šå³°è°·è®¡è´¹</option>
                                    <option value="office_flat">åŠå…¬å®¤å›ºå®šè®¡è´¹</option>
                                </select>
                            </div>
                        </div>


                        <div class="form-row">
                            <div class="form-group full-width">
                                <label for="room-description" data-zh="æˆ¿é—´æè¿°" data-en="Room Description">æˆ¿é—´æè¿°</label>
                                <textarea id="room-description" name="description" class="form-textarea"
                                          rows="3" data-zh-placeholder="æˆ¿é—´æè¿°ä¿¡æ¯..." data-en-placeholder="Room description..." placeholder="æˆ¿é—´æè¿°ä¿¡æ¯..."></textarea>
                            </div>
                        </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideModal()" data-zh="å–æ¶ˆ" data-en="Cancel">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="saveUser()" data-zh="ä¿å­˜" data-en="Save">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- å…¥é©»å¼¹çª— -->
    <div id="checkin-modal" class="modal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-zh="ç§Ÿæˆ·å…¥é©»" data-en="Tenant Check-in">ç§Ÿæˆ·å…¥é©»</h3>
                <button class="modal-close" onclick="hideCheckinModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="checkin-form" class="user-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label data-zh="æˆ¿é—´å·" data-en="Room Number">æˆ¿é—´å·</label>
                            <div id="checkin-user-name" style="padding: 12px; background: #f5f5f5; border-radius: 6px; color: #666;">--</div>
                            <input type="hidden" id="checkin-user-id">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <div style="display: flex; align-items: center;">
                                <span style="color: red; font-size: 14px; margin-right: 2px;">*</span>
                                <label for="checkin-tenant-select" data-zh="ç§Ÿæˆ·å§“å" data-en="Tenant Name">ç§Ÿæˆ·å§“å</label>
                            </div>
                            <div class="tenant-select-wrapper">
                                <input type="text" id="checkin-tenant-search" class="form-input" placeholder="æœç´¢æˆ–è¾“å…¥ç§Ÿæˆ·å§“å" autocomplete="off">
                                <select id="checkin-tenant-select" name="tenantName" class="form-input tenant-dropdown" style="display: none;" required>
                                    <option value="">è¯·é€‰æ‹©ç§Ÿæˆ·</option>
                                </select>
                                <div id="tenant-search-results" class="search-results"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div style="display: flex; align-items: center;">
                                <span style="color: red; font-size: 14px; margin-right: 2px;">*</span>
                                <label for="checkin-date" data-zh="å…¥é©»æ—¶é—´" data-en="Check-in Date">å…¥é©»æ—¶é—´</label>
                            </div>
                            <input type="date" id="checkin-date" name="checkinDate" class="form-input" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <div style="display: flex; align-items: center;">
                                <span style="color: red; font-size: 14px; margin-right: 2px;">*</span>
                                <label for="electricity-reading" data-zh="ç”µè¡¨è¯»æ•°" data-en="Electricity Reading">ç”µè¡¨è¯»æ•° (kWh)</label>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="number" id="electricity-reading" name="electricityReading" class="form-input"
                                       placeholder="è¾“å…¥å½“å‰ç”µè¡¨è¯»æ•°" step="0.01" min="0" required style="flex: 1;">
                                <button type="button" class="btn btn-secondary" onclick="readCurrentMeter()" style="flex-shrink: 0;">è¯»å–</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideCheckinModal()" data-zh="å–æ¶ˆ" data-en="Cancel">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="saveCheckin()" data-zh="ç¡®è®¤å…¥é©»" data-en="Confirm Check-in">ç¡®è®¤å…¥é©»</button>
            </div>
        </div>
    </div>

    <!-- é€€ç§Ÿå¼¹çª— -->
    <div id="checkout-modal" class="modal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-zh="ç§Ÿæˆ·é€€ç§Ÿ" data-en="Tenant Check-out">ç§Ÿæˆ·é€€ç§Ÿ</h3>
                <button class="modal-close" onclick="hideCheckoutModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="checkout-form" class="user-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label data-zh="ç§Ÿæˆ·å§“å" data-en="Tenant Name">ç§Ÿæˆ·å§“å</label>
                            <div id="checkout-user-name" style="padding: 12px; background: #f5f5f5; border-radius: 6px; color: #666;">--</div>
                            <input type="hidden" id="checkout-user-id">
                        </div>
                        <div class="form-group">
                            <label data-zh="å½“å‰æˆ¿é—´" data-en="Current Room">å½“å‰æˆ¿é—´</label>
                            <div id="checkout-user-room" style="padding: 12px; background: #f5f5f5; border-radius: 6px; color: #666;">--</div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <div style="display: flex; align-items: center;">
                                <span style="color: red; font-size: 14px; margin-right: 2px;">*</span>
                                <label for="checkout-date" data-zh="é€€ç§Ÿæ—¶é—´" data-en="Check-out Date">é€€ç§Ÿæ—¶é—´</label>
                            </div>
                            <input type="date" id="checkout-date" name="checkoutDate" class="form-input" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <div style="display: flex; align-items: center;">
                                <span style="color: red; font-size: 14px; margin-right: 2px;">*</span>
                                <label for="checkout-electricity-reading" data-zh="ç”µè¡¨è¯»æ•°" data-en="Electricity Reading">ç”µè¡¨è¯»æ•° (kWh)</label>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="number" id="checkout-electricity-reading" name="electricityReading" class="form-input"
                                       data-zh-placeholder="è¾“å…¥å½“å‰ç”µè¡¨è¯»æ•°" data-en-placeholder="Enter current meter reading" placeholder="è¾“å…¥å½“å‰ç”µè¡¨è¯»æ•°" step="0.01" min="0" required style="flex: 1;">
                                <button type="button" class="btn btn-secondary" onclick="readCurrentMeterForCheckout()" style="flex-shrink: 0;" data-zh="è¯»å–" data-en="Read">è¯»å–</button>
                            </div>
                            <div style="margin-top: 6px; font-size: 12px; color: #999;">
                                <span data-zh="æç¤ºï¼šé€€ç§Ÿåï¼Œè¯·å‰å¾€è´¦å•ç®¡ç†æŸ¥çœ‹è´¦å•" data-en="Tip: After check-out, go to Bills Management to view bills">æç¤ºï¼šé€€ç§Ÿåï¼Œè¯·å‰å¾€è´¦å•ç®¡ç†æŸ¥çœ‹è´¦å•</span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideCheckoutModal()" data-zh="å–æ¶ˆ" data-en="Cancel">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="saveCheckout()" data-zh="ç¡®è®¤é€€ç§Ÿ" data-en="Confirm Check-out">ç¡®è®¤é€€ç§Ÿ</button>
            </div>
        </div>
    </div>

    <!-- åˆ é™¤æ¥¼æ ‹ç¡®è®¤å¼¹çª— -->
    <div id="delete-building-modal" class="modal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content delete-confirm-modal">
            <div class="modal-header">
                <h3 data-zh="ç¡®è®¤åˆ é™¤æ¥¼æ ‹" data-en="Confirm Delete Building">ç¡®è®¤åˆ é™¤æ¥¼æ ‹</h3>
                <button class="modal-close" onclick="hideBuildingDeleteConfirm()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="delete-warning-icon">âš ï¸</div>
                <p data-zh="ç¡®å®šè¦åˆ é™¤æ¥¼æ ‹" data-en="Are you sure you want to delete building">ç¡®å®šè¦åˆ é™¤æ¥¼æ ‹ "<span id="delete-building-name">--</span>" å—ï¼Ÿ</p>
                <div class="delete-warning-box">
                    <p class="delete-warning" data-zh="è­¦å‘Šï¼šæ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤ï¼š" data-en="Warning: This operation will also delete:">âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤ï¼š</p>
                    <ul class="delete-warning-list">
                        <li data-zh="è¯¥æ¥¼æ ‹ä¸‹çš„æ‰€æœ‰æ¥¼å±‚" data-en="All floors in this building">â€¢ è¯¥æ¥¼æ ‹ä¸‹çš„æ‰€æœ‰æ¥¼å±‚</li>
                        <li data-zh="è¯¥æ¥¼æ ‹ä¸‹çš„æ‰€æœ‰æˆ¿é—´" data-en="All rooms in this building">â€¢ è¯¥æ¥¼æ ‹ä¸‹çš„æ‰€æœ‰æˆ¿é—´</li>
                        <li data-zh="ç›¸å…³çš„ç§Ÿæˆ·å’Œè´¦å•æ•°æ®" data-en="Related tenant and billing data">â€¢ ç›¸å…³çš„ç§Ÿæˆ·å’Œè´¦å•æ•°æ®</li>
                    </ul>
                    <p class="delete-warning" data-zh="æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œè¯·è°¨æ…æ“ä½œï¼" data-en="This operation cannot be undone!">æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œè¯·è°¨æ…æ“ä½œï¼</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideBuildingDeleteConfirm()" data-zh="å–æ¶ˆ" data-en="Cancel">å–æ¶ˆ</button>
                <button type="button" class="btn btn-danger" onclick="confirmBuildingDelete()" data-zh="ç¡®è®¤åˆ é™¤" data-en="Confirm Delete">ç¡®è®¤åˆ é™¤</button>
            </div>
        </div>
    </div>

    <!-- åˆ é™¤æ¥¼å±‚ç¡®è®¤å¼¹çª— -->
    <div id="delete-floor-modal" class="modal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content delete-confirm-modal">
            <div class="modal-header">
                <h3 data-zh="ç¡®è®¤åˆ é™¤æ¥¼å±‚" data-en="Confirm Delete Floor">ç¡®è®¤åˆ é™¤æ¥¼å±‚</h3>
                <button class="modal-close" onclick="hideFloorDeleteConfirm()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="delete-warning-icon">âš ï¸</div>
                <p data-zh="ç¡®å®šè¦åˆ é™¤" data-en="Are you sure you want to delete">ç¡®å®šè¦åˆ é™¤ "<span id="delete-floor-info">--</span>" å—ï¼Ÿ</p>
                <div class="delete-warning-box">
                    <p class="delete-warning" data-zh="è­¦å‘Šï¼šæ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤ï¼š" data-en="Warning: This operation will also delete:">âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤ï¼š</p>
                    <ul class="delete-warning-list">
                        <li data-zh="è¯¥æ¥¼å±‚ä¸‹çš„æ‰€æœ‰æˆ¿é—´" data-en="All rooms on this floor">â€¢ è¯¥æ¥¼å±‚ä¸‹çš„æ‰€æœ‰æˆ¿é—´</li>
                        <li data-zh="ç›¸å…³çš„ç§Ÿæˆ·å’Œè´¦å•æ•°æ®" data-en="Related tenant and billing data">â€¢ ç›¸å…³çš„ç§Ÿæˆ·å’Œè´¦å•æ•°æ®</li>
                    </ul>
                    <p class="delete-warning" data-zh="æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œè¯·è°¨æ…æ“ä½œï¼" data-en="This operation cannot be undone!">æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œè¯·è°¨æ…æ“ä½œï¼</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideFloorDeleteConfirm()" data-zh="å–æ¶ˆ" data-en="Cancel">å–æ¶ˆ</button>
                <button type="button" class="btn btn-danger" onclick="confirmFloorDelete()" data-zh="ç¡®è®¤åˆ é™¤" data-en="Confirm Delete">ç¡®è®¤åˆ é™¤</button>
            </div>
        </div>
    </div>

    <!-- åˆ é™¤æˆ¿é—´ç¡®è®¤å¼¹çª— -->
    <div id="delete-confirm-modal" class="modal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content delete-confirm-modal">
            <div class="modal-header">
                <h3 data-zh="ç¡®è®¤åˆ é™¤æˆ¿é—´" data-en="Confirm Delete Room">ç¡®è®¤åˆ é™¤æˆ¿é—´</h3>
                <button class="modal-close" onclick="hideDeleteConfirm()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="delete-warning-icon">âš ï¸</div>
                <p data-zh="ç¡®å®šè¦åˆ é™¤æˆ¿é—´" data-en="Are you sure you want to delete room">ç¡®å®šè¦åˆ é™¤æˆ¿é—´ "<span id="delete-user-name">--</span>" å—ï¼Ÿ</p>
                <p class="delete-warning" data-zh="æ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚" data-en="This operation cannot be undone.">æ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideDeleteConfirm()" data-zh="å–æ¶ˆ" data-en="Cancel">å–æ¶ˆ</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()" data-zh="åˆ é™¤" data-en="Delete">åˆ é™¤</button>
            </div>
        </div>
    </div>

    <script src="assets/js/navbar.js"></script>
    <script src="assets/js/common.js"></script>
    <script>
        // è·å–å½“å‰è¯­è¨€
        function getCurrentLanguage() {
            return document.getElementById('language-select')?.value || 'zh';
        }

        // å»ºç­‘ç»“æ„æ•°æ®
        const buildingsData = [
            {
                id: 'BUILDING001',
                name: 'Aæ ‹',
                nameEn: 'Building A',
                totalFloors: 5,
                description: 'ä¸»æ¥¼æ ‹',
                descriptionEn: 'Main Building',
                floors: [
                    { id: 'FLOOR001', number: 1, buildingId: 'BUILDING001', description: 'ä¸€æ¥¼å•†é“º', descriptionEn: '1st Floor Shops' },
                    { id: 'FLOOR002', number: 2, buildingId: 'BUILDING001', description: 'äºŒæ¥¼åŠå…¬', descriptionEn: '2nd Floor Offices' },
                    { id: 'FLOOR003', number: 3, buildingId: 'BUILDING001', description: 'ä¸‰æ¥¼ä½å®…', descriptionEn: '3rd Floor Residential' },
                    { id: 'FLOOR004', number: 4, buildingId: 'BUILDING001', description: 'å››æ¥¼ä½å®…', descriptionEn: '4th Floor Residential' },
                    { id: 'FLOOR005', number: 5, buildingId: 'BUILDING001', description: 'äº”æ¥¼ä½å®…', descriptionEn: '5th Floor Residential' }
                ]
            },
            {
                id: 'BUILDING002',
                name: 'Bæ ‹',
                nameEn: 'Building B',
                totalFloors: 3,
                description: 'å‰¯æ¥¼æ ‹',
                descriptionEn: 'Secondary Building',
                floors: [
                    { id: 'FLOOR006', number: 1, buildingId: 'BUILDING002', description: 'ä¸€æ¥¼ä»“åº“', descriptionEn: '1st Floor Warehouse' },
                    { id: 'FLOOR007', number: 2, buildingId: 'BUILDING002', description: 'äºŒæ¥¼åŠå…¬', descriptionEn: '2nd Floor Offices' },
                    { id: 'FLOOR008', number: 3, buildingId: 'BUILDING002', description: 'ä¸‰æ¥¼ä¼šè®®å®¤', descriptionEn: '3rd Floor Conference Rooms' }
                ]
            }
        ];

        // æˆ¿é—´æ•°æ®
        const roomsData = [
            {
                id: 'ROOM001',
                roomNumber: 'A-101',
                buildingId: 'BUILDING001',
                floorId: 'FLOOR001',
                floorNumber: 1,
                meterId: 'METER001',
                billingTemplate: 'commercial_standard',
                description: 'ä¸€æ¥¼å•†é“º',
                descriptionEn: 'First floor shop',
                status: 'occupied',
                tenant: 'å¼ æ˜å',
                tenantEn: 'Zhang Minghua',
                tenantPhone: '+91 98765 43210',
                checkinDate: '2024-01-15',
                electricityReading: 1250.5
            },
            {
                id: 'ROOM002',
                roomNumber: 'A-201',
                buildingId: 'BUILDING001',
                floorId: 'FLOOR002',
                floorNumber: 2,
                meterId: 'METER002',
                billingTemplate: 'office_flat',
                description: 'äºŒæ¥¼åŠå…¬å®¤',
                descriptionEn: 'Second floor office',
                status: 'vacant'
            },
            {
                id: 'ROOM003',
                roomNumber: 'A-301',
                buildingId: 'BUILDING001',
                floorId: 'FLOOR003',
                floorNumber: 3,
                meterId: 'METER003',
                billingTemplate: 'residential_basic',
                description: 'ä¸‰æ¥¼ä½å®…',
                descriptionEn: 'Third floor residential',
                status: 'occupied',
                tenant: 'ç‹å»ºå›½',
                tenantEn: 'Wang Jianguo',
                tenantPhone: '+91 76543 21098',
                checkinDate: '2024-05-10',
                electricityReading: 675.3
            },
            {
                id: 'ROOM005',
                roomNumber: 'B-201',
                buildingId: 'BUILDING002',
                floorId: 'FLOOR007',
                floorNumber: 2,
                meterId: 'METER005',
                billingTemplate: 'office_flat',
                description: 'äºŒæ¥¼åŠå…¬å®¤',
                descriptionEn: 'Second floor office',
                status: 'vacant'
            }
        ];

        // ç§Ÿæˆ·æ•°æ®
        const tenantsData = [
            { id: 'TENANT001', name: 'å¼ æ˜å', phone: '+91 98765 43210', email: 'zhang@example.com' },
            { id: 'TENANT002', name: 'æå°çº¢', phone: '+91 98765 43211', email: 'li@example.com' },
            { id: 'TENANT003', name: 'ç‹å¤§å¼º', phone: '+91 98765 43212', email: 'wang@example.com' },
            { id: 'TENANT004', name: 'é™ˆç¾ä¸½', phone: '+91 98765 43213', email: 'chen@example.com' },
            { id: 'TENANT005', name: 'åˆ˜å»ºå›½', phone: '+91 98765 43214', email: 'liu@example.com' },
            { id: 'TENANT006', name: 'èµµæ•', phone: '+91 98765 43215', email: 'zhao@example.com' },
            { id: 'TENANT007', name: 'å­™å¿—å¼º', phone: '+91 98765 43216', email: 'sun@example.com' },
            { id: 'TENANT008', name: 'å‘¨ä¸½å¨œ', phone: '+91 98765 43217', email: 'zhou@example.com' },
            { id: 'TENANT009', name: 'å´ç£Š', phone: '+91 98765 43218', email: 'wu@example.com' },
            { id: 'TENANT010', name: 'éƒ‘æµ·ç‡•', phone: '+91 98765 43219', email: 'zheng@example.com' }
        ];

        // ç¼–è¾‘å’Œåˆ é™¤åŠŸèƒ½ç›¸å…³å˜é‡
        let isEditMode = false;
        let editingUserId = null;
        let deleteUserId = null;

        // å»ºç­‘ç»“æ„ç®¡ç†å˜é‡
        let currentSelectedBuilding = null;
        let currentSelectedFloor = null;
        let isBuildingEditMode = false;
        let editingBuildingId = null;
        let isFloorEditMode = false;
        let editingFloorId = null;

        // åˆ é™¤ç›¸å…³å˜é‡
        let deleteBuildingId = null;
        let deleteFloorId = null;

        // è§†å›¾ç®¡ç†å˜é‡
        let currentView = 'table';

        function renderRoomsTable() {
            try {
                console.log('renderRoomsTable called, roomsData length:', roomsData.length);
                console.log('buildingsData length:', buildingsData.length);
                const tbody = document.getElementById('rooms-tbody');
                if (!tbody) {
                    console.error('rooms-tbody element not found!');
                    return;
                }
            tbody.innerHTML = '';

            // æ ¹æ®å½“å‰é€‰æ‹©è¿‡æ»¤æˆ¿é—´
            let filteredRooms = roomsData;
            if (currentSelectedBuilding && !currentSelectedFloor) {
                filteredRooms = roomsData.filter(room => room.buildingId === currentSelectedBuilding);
            } else if (currentSelectedFloor) {
                filteredRooms = roomsData.filter(room => room.floorId === currentSelectedFloor);
            }

            console.log('Filtered rooms:', filteredRooms);
            // åº”ç”¨æœç´¢è¿‡æ»¤
            const searchTerm = document.getElementById('room-search').value.toLowerCase();
            const statusFilter = document.getElementById('room-status-filter').value;

            if (searchTerm) {
                filteredRooms = filteredRooms.filter(room =>
                    room.roomNumber.toLowerCase().includes(searchTerm) ||
                    (room.meterId && room.meterId.toLowerCase().includes(searchTerm)) ||
                    (room.tenant && room.tenant.toLowerCase().includes(searchTerm)) ||
                    (room.tenantEn && room.tenantEn.toLowerCase().includes(searchTerm))
                );
            }

            if (statusFilter !== 'all') {
                filteredRooms = filteredRooms.filter(room => room.status === statusFilter);
            }

            console.log('Filtered rooms length:', filteredRooms.length);

            if (filteredRooms.length === 0) {
                console.warn('No rooms to display');
                const lang = getCurrentLanguage();
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 20px;">${lang === 'en' ? 'No room data' : 'æš‚æ— æˆ¿é—´æ•°æ®'}</td></tr>`;
                return;
            }

            filteredRooms.forEach(room => {
                console.log('Rendering room:', room);
                const row = document.createElement('tr');

                const statusClass = room.status === 'occupied' ? 'status-online' :
                                   room.status === 'vacant' ? 'status-offline' : 'status-pending';

                const lang = getCurrentLanguage();
                const statusText = room.status === 'occupied' ?
                    (lang === 'en' ? 'Occupied' : 'å·²å…¥é©»') :
                    (lang === 'en' ? 'Vacant' : 'ç©ºé—²');

                // è·å–å»ºç­‘å’Œæ¥¼å±‚ä¿¡æ¯
                const building = buildingsData.find(b => b.id === room.buildingId);
                const buildingName = building ? (lang === 'en' ? building.nameEn : building.name) : '--';
                const floorInfo = `${buildingName} ${room.floorNumber}${lang === 'en' ? 'F' : 'æ¥¼'}`;

                // è·å–ç§Ÿæˆ·åç§°
                const tenantName = room.tenant ? (lang === 'en' ? room.tenantEn : room.tenant) : '--';

                // æ ¼å¼åŒ–è®¡è´¹æ¨¡ç‰ˆæ˜¾ç¤º
                const billingTemplateMap = lang === 'en' ? {
                    'residential_basic': 'Residential Basic',
                    'residential_tiered': 'Residential Tiered',
                    'commercial_standard': 'Commercial Standard',
                    'commercial_peak': 'Commercial Peak',
                    'office_flat': 'Office Flat Rate'
                } : {
                    'residential_basic': 'ä½å®…åŸºç¡€è®¡è´¹',
                    'residential_tiered': 'ä½å®…é˜¶æ¢¯è®¡è´¹',
                    'commercial_standard': 'å•†ä¸šæ ‡å‡†è®¡è´¹',
                    'commercial_peak': 'å•†ä¸šå³°è°·è®¡è´¹',
                    'office_flat': 'åŠå…¬å®¤å›ºå®šè®¡è´¹'
                };
                const billingText = billingTemplateMap[room.billingTemplate] || room.billingTemplate;

                row.innerHTML = `
                    <td>${room.roomNumber}</td>
                    <td>${floorInfo}</td>
                    <td>${room.meterId}</td>
                    <td>${billingText}</td>
                    <td>${tenantName}</td>
                    <td><span class="device-status ${statusClass}">${statusText}</span></td>
                    <td>
                        <div class="room-actions">
                            <button class="btn btn-sm btn-secondary" onclick="editRoom('${room.id}')">${lang === 'en' ? 'Edit' : 'ç¼–è¾‘'}</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteRoom('${room.id}')">${lang === 'en' ? 'Delete' : 'åˆ é™¤'}</button>
                            ${room.status === 'vacant' ?
                                `<button class="btn btn-sm btn-success" onclick="assignTenant('${room.id}')">${lang === 'en' ? 'Check In' : 'å…¥é©»'}</button>` :
                                room.status === 'occupied' ?
                                `<button class="btn btn-sm btn-warning" onclick="checkoutTenant('${room.id}')">${lang === 'en' ? 'Check Out' : 'é€€ç§Ÿ'}</button>` :
                                ''}
                        </div>
                    </td>
                `;

                tbody.appendChild(row);
            });
            } catch (error) {
                console.error('Error rendering rooms table:', error);
                const tbody = document.getElementById('rooms-tbody');
                if (tbody) {
                    const lang = getCurrentLanguage();
                    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 20px; color: red;">${lang === 'en' ? 'Error loading room data' : 'åŠ è½½æˆ¿é—´æ•°æ®å‡ºé”™'}</td></tr>`;
                }
            }
        }

        // æ¸²æŸ“å»ºç­‘æ ‘ç»“æ„
        function renderBuildingTree() {
            try {
                const treeContainer = document.getElementById('building-tree');
                if (!treeContainer) {
                    console.error('building-tree element not found!');
                    return;
                }
                treeContainer.innerHTML = '';

            const lang = getCurrentLanguage();
            buildingsData.forEach(building => {
                const buildingElement = document.createElement('div');
                buildingElement.className = 'tree-node building-node';
                buildingElement.innerHTML = `
                    <div class="tree-item ${currentSelectedBuilding === building.id ? 'selected' : ''}" onclick="selectBuilding('${building.id}')">
                        <span class="tree-icon">ğŸ¢</span>
                        <span class="tree-label">${lang === 'en' ? building.nameEn : building.name}</span>
                        <div class="tree-actions">
                            <button class="btn-icon" onclick="event.stopPropagation(); editBuilding('${building.id}')" title="${lang === 'en' ? 'Edit Building' : 'ç¼–è¾‘æ¥¼æ ‹'}">
                                âœï¸
                            </button>
                            <button class="btn-icon" onclick="event.stopPropagation(); addFloor('${building.id}')" title="${lang === 'en' ? 'Add Floor' : 'æ·»åŠ æ¥¼å±‚'}">
                                â•
                            </button>
                            <button class="btn-icon" onclick="event.stopPropagation(); deleteBuilding('${building.id}')" title="${lang === 'en' ? 'Delete Building' : 'åˆ é™¤æ¥¼æ ‹'}">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </div>
                    <div class="tree-children ${currentSelectedBuilding === building.id ? 'expanded' : ''}">
                        ${building.floors.map(floor => `
                            <div class="tree-item floor-item ${currentSelectedFloor === floor.id ? 'selected' : ''}" onclick="selectFloor('${floor.id}')">
                                <span class="tree-icon">ğŸ </span>
                                <span class="tree-label">${floor.number}${lang === 'en' ? 'F' : 'æ¥¼'}</span>
                                <div class="tree-actions">
                                    <button class="btn-icon" onclick="event.stopPropagation(); editFloor('${floor.id}')" title="${lang === 'en' ? 'Edit Floor' : 'ç¼–è¾‘æ¥¼å±‚'}">
                                        âœï¸
                                    </button>
                                    <button class="btn-icon" onclick="event.stopPropagation(); addRoomToFloor('${floor.id}')" title="${lang === 'en' ? 'Add Room' : 'æ·»åŠ æˆ¿é—´'}">
                                        ğŸ 
                                    </button>
                                    <button class="btn-icon" onclick="event.stopPropagation(); deleteFloor('${floor.id}')" title="${lang === 'en' ? 'Delete Floor' : 'åˆ é™¤æ¥¼å±‚'}">
                                        ğŸ—‘ï¸
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                treeContainer.appendChild(buildingElement);
            });
            } catch (error) {
                console.error('Error rendering building tree:', error);
                const treeContainer = document.getElementById('building-tree');
                if (treeContainer) {
                    const lang = getCurrentLanguage();
                    treeContainer.innerHTML = `<div style="padding: 20px; color: red; text-align: center;">${lang === 'en' ? 'Error loading building data' : 'åŠ è½½å»ºç­‘æ•°æ®å‡ºé”™'}</div>`;
                }
            }
        }

        // é€‰æ‹©å»ºç­‘
        function selectBuilding(buildingId) {
            currentSelectedBuilding = buildingId;
            currentSelectedFloor = null;
            const lang = getCurrentLanguage();
            const building = buildingsData.find(b => b.id === buildingId);
            const titleText = building ? (lang === 'en' ? building.nameEn : building.name) : '';
            document.getElementById('current-selection').textContent = titleText;
            renderBuildingTree();
            if (currentView === 'table') {
                renderRoomsTable();
            } else {
                renderRoomsCards();
            }
        }

        // é€‰æ‹©æ¥¼å±‚
        function selectFloor(floorId) {
            const floor = buildingsData.flatMap(b => b.floors).find(f => f.id === floorId);
            if (floor) {
                currentSelectedBuilding = floor.buildingId;
                currentSelectedFloor = floorId;
                const building = buildingsData.find(b => b.id === floor.buildingId);
                const lang = getCurrentLanguage();
                document.getElementById('current-selection').textContent =
                    `${lang === 'en' ? building.nameEn : building.name} ${floor.number}${lang === 'en' ? 'F' : 'æ¥¼'}`;
                renderBuildingTree();
                renderRoomsTable();
            }
        }

        function searchRooms() {
            // ç›´æ¥åº”ç”¨è¿‡æ»¤æ¡ä»¶å¹¶é‡æ–°æ¸²æŸ“
            if (currentView === 'table') {
                renderRoomsTable();
            } else {
                renderRoomsCards();
            }
        }

        function resetFilters() {
            // é‡ç½®é€‰æ‹©çŠ¶æ€
            currentSelectedBuilding = null;
            currentSelectedFloor = null;
            document.getElementById('current-selection').textContent = '';
            document.getElementById('room-search').value = '';
            document.getElementById('room-status-filter').value = 'all';
            renderBuildingTree();
            if (currentView === 'table') {
                renderRoomsTable();
            } else {
                renderRoomsCards();
            }
        }

        // ========== è§†å›¾åˆ‡æ¢å‡½æ•° ==========
        function switchView(viewType) {
            currentView = viewType;

            // æ›´æ–°æ ‡ç­¾é¡µçŠ¶æ€
            const tabBtns = document.querySelectorAll('.tab-btn');
            tabBtns.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.view === viewType) {
                    btn.classList.add('active');
                }
            });

            // åˆ‡æ¢è§†å›¾å®¹å™¨
            const tableView = document.getElementById('table-view');
            const cardView = document.getElementById('card-view');

            if (viewType === 'table') {
                tableView.style.display = 'block';
                cardView.style.display = 'none';
                renderRoomsTable();
            } else {
                tableView.style.display = 'none';
                cardView.style.display = 'block';
                renderRoomsCards();
            }
        }

        function renderRoomsCards() {
            try {
                const cardsContainer = document.getElementById('rooms-cards');
                if (!cardsContainer) {
                    console.error('rooms-cards element not found!');
                    return;
                }
                cardsContainer.innerHTML = '';

            // æ ¹æ®å½“å‰é€‰æ‹©è¿‡æ»¤æˆ¿é—´
            let filteredRooms = roomsData;
            if (currentSelectedBuilding && !currentSelectedFloor) {
                filteredRooms = roomsData.filter(room => room.buildingId === currentSelectedBuilding);
            } else if (currentSelectedFloor) {
                filteredRooms = roomsData.filter(room => room.floorId === currentSelectedFloor);
            }

            // åº”ç”¨æœç´¢è¿‡æ»¤
            const searchTerm = document.getElementById('room-search').value.toLowerCase();
            const statusFilter = document.getElementById('room-status-filter').value;

            if (searchTerm) {
                filteredRooms = filteredRooms.filter(room =>
                    room.roomNumber.toLowerCase().includes(searchTerm) ||
                    (room.meterId && room.meterId.toLowerCase().includes(searchTerm)) ||
                    (room.tenant && room.tenant.toLowerCase().includes(searchTerm)) ||
                    (room.tenantEn && room.tenantEn.toLowerCase().includes(searchTerm))
                );
            }

            if (statusFilter !== 'all') {
                filteredRooms = filteredRooms.filter(room => room.status === statusFilter);
            }

            // ç”Ÿæˆæˆ¿é—´å¡ç‰‡
            filteredRooms.forEach(room => {
                const building = buildingsData.find(b => b.id === room.buildingId);
                const floor = building ? building.floors.find(f => f.id === room.floorId) : null;

                const statusBadge = room.status === 'occupied' ? 'success' : 'warning';
                const lang = getCurrentLanguage();
                const statusText = room.status === 'occupied' ?
                    (lang === 'en' ? 'Occupied' : 'å·²å…¥é©»') :
                    (lang === 'en' ? 'Vacant' : 'ç©ºé—²');

                // æ ¼å¼åŒ–è®¡è´¹æ¨¡ç‰ˆæ˜¾ç¤º
                const billingTemplateMap = lang === 'en' ? {
                    'residential_basic': 'Residential Basic',
                    'residential_tiered': 'Residential Tiered',
                    'commercial_standard': 'Commercial Standard',
                    'commercial_peak': 'Commercial Peak',
                    'office_flat': 'Office Flat Rate'
                } : {
                    'residential_basic': 'ä½å®…åŸºç¡€è®¡è´¹',
                    'residential_tiered': 'ä½å®…é˜¶æ¢¯è®¡è´¹',
                    'commercial_standard': 'å•†ä¸šæ ‡å‡†è®¡è´¹',
                    'commercial_peak': 'å•†ä¸šå³°è°·è®¡è´¹',
                    'office_flat': 'åŠå…¬å®¤å›ºå®šè®¡è´¹'
                };
                const billingText = billingTemplateMap[room.billingTemplate] || room.billingTemplate;

                const cardElement = document.createElement('div');
                cardElement.className = 'room-card';
                cardElement.innerHTML = `
                    <div class="card-header">
                        <h4 class="room-number">${room.roomNumber}</h4>
                        <span class="status-badge ${statusBadge}">${statusText}</span>
                    </div>
                    <div class="card-body">
                        <div class="card-info">
                            <p><strong>${lang === 'en' ? 'Location:' : 'ä½ç½®ï¼š'}</strong>${building ? (lang === 'en' ? building.nameEn : building.name) : ''} ${floor ? floor.number + (lang === 'en' ? 'F' : 'æ¥¼') : ''}</p>
                            <p><strong>${lang === 'en' ? 'Meter:' : 'ç”µè¡¨å·ï¼š'}</strong>${room.meterId || (lang === 'en' ? 'Unbound' : 'æœªç»‘å®š')}</p>
                            <p><strong>${lang === 'en' ? 'Billing:' : 'è®¡è´¹æ¨¡æ¿ï¼š'}</strong>${billingText || (lang === 'en' ? 'Not Set' : 'æœªè®¾ç½®')}</p>
                            ${room.tenant ? `<p><strong>${lang === 'en' ? 'Tenant:' : 'ç§Ÿæˆ·ï¼š'}</strong>${lang === 'en' ? room.tenantEn : room.tenant}</p>` : ''}
                            ${room.tenantPhone ? `<p><strong>${lang === 'en' ? 'Phone:' : 'è”ç³»ç”µè¯ï¼š'}</strong>${room.tenantPhone}</p>` : ''}
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-sm btn-primary" onclick="editRoom('${room.id}')">${lang === 'en' ? 'Edit' : 'ç¼–è¾‘'}</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteRoom('${room.id}')">${lang === 'en' ? 'Delete' : 'åˆ é™¤'}</button>
                            ${room.status === 'vacant' ?
                                `<button class="btn btn-sm btn-success" onclick="assignTenant('${room.id}')">${lang === 'en' ? 'Check In' : 'å…¥é©»'}</button>` :
                                room.status === 'occupied' ?
                                `<button class="btn btn-sm btn-warning" onclick="checkoutTenant('${room.id}')">${lang === 'en' ? 'Check Out' : 'é€€ç§Ÿ'}</button>` :
                                ''}
                        </div>
                    </div>
                `;
                cardsContainer.appendChild(cardElement);
            });

            if (filteredRooms.length === 0) {
                const lang = getCurrentLanguage();
                cardsContainer.innerHTML = `<div class="no-data">${lang === 'en' ? 'No room data' : 'æš‚æ— æˆ¿é—´æ•°æ®'}</div>`;
            }
            } catch (error) {
                console.error('Error rendering rooms cards:', error);
                const cardsContainer = document.getElementById('rooms-cards');
                if (cardsContainer) {
                    const lang = getCurrentLanguage();
                    cardsContainer.innerHTML = `<div class="no-data" style="color: red;">${lang === 'en' ? 'Error loading room data' : 'åŠ è½½æˆ¿é—´æ•°æ®å‡ºé”™'}</div>`;
                }
            }
        }

        // ========== å»ºç­‘ç®¡ç†å‡½æ•° ==========
        function showAddBuildingModal() {
            isBuildingEditMode = false;
            editingBuildingId = null;
            const lang = getCurrentLanguage();
            document.getElementById('building-modal-title').textContent = lang === 'en' ? 'Add Building' : 'æ·»åŠ æ¥¼æ ‹';
            document.getElementById('building-form').reset();
            document.getElementById('building-modal').style.display = 'flex';
            document.body.classList.add('modal-open');
        }

        function editBuilding(buildingId) {
            const building = buildingsData.find(b => b.id === buildingId);
            if (building) {
                isBuildingEditMode = true;
                editingBuildingId = buildingId;
                const lang = getCurrentLanguage();
                document.getElementById('building-modal-title').textContent = lang === 'en' ? 'Edit Building' : 'ç¼–è¾‘æ¥¼æ ‹';
                document.getElementById('building-name').value = lang === 'en' ? building.nameEn : building.name;
                document.getElementById('total-floors').value = building.totalFloors;
                document.getElementById('building-description').value = lang === 'en' ? building.descriptionEn : building.description;
                document.getElementById('building-modal').style.display = 'flex';
                document.body.classList.add('modal-open');
            }
        }

        function hideBuildingModal() {
            document.getElementById('building-modal').style.display = 'none';
            document.body.classList.remove('modal-open');
            isBuildingEditMode = false;
            editingBuildingId = null;
        }

        function saveBuilding() {
            const formData = new FormData(document.getElementById('building-form'));
            const buildingData = {
                name: formData.get('buildingName').trim(),
                totalFloors: parseInt(formData.get('totalFloors')),
                description: formData.get('description').trim()
            };

            // æ•°æ®éªŒè¯
            const lang = getCurrentLanguage();
            if (!buildingData.name) {
                alert(lang === 'en' ? 'Building name is required' : 'æ¥¼æ ‹åç§°ä¸èƒ½ä¸ºç©º');
                return;
            }
            if (!buildingData.totalFloors || buildingData.totalFloors < 1 || buildingData.totalFloors > 50) {
                alert(lang === 'en' ? 'Total floors must be between 1 and 50' : 'æ¥¼å±‚æ•°å¿…é¡»åœ¨1-50ä¹‹é—´');
                return;
            }
            if (buildingData.name.length > 20) {
                alert(lang === 'en' ? 'Building name cannot exceed 20 characters' : 'æ¥¼æ ‹åç§°ä¸èƒ½è¶…è¿‡20ä¸ªå­—ç¬¦');
                return;
            }

            // æ£€æŸ¥æ¥¼æ ‹åç§°æ˜¯å¦é‡å¤
            const existingBuilding = buildingsData.find(b =>
                b.name === buildingData.name &&
                (!isBuildingEditMode || b.id !== editingBuildingId)
            );
            if (existingBuilding) {
                alert(lang === 'en' ? 'Building name already exists' : 'æ¥¼æ ‹åç§°å·²å­˜åœ¨');
                return;
            }

            try {
                if (isBuildingEditMode && editingBuildingId) {
                    // ç¼–è¾‘æ¨¡å¼
                    const building = buildingsData.find(b => b.id === editingBuildingId);
                    if (building) {
                        building.name = buildingData.name;
                        building.totalFloors = buildingData.totalFloors;
                        building.description = buildingData.description;
                        alert('æ¥¼æ ‹ä¿¡æ¯æ›´æ–°æˆåŠŸï¼');
                    }
                } else {
                    // æ·»åŠ æ¨¡å¼
                    const newBuilding = {
                        id: 'BUILDING' + String(Math.floor(Math.random() * 900) + 100),
                        name: buildingData.name,
                        totalFloors: buildingData.totalFloors,
                        description: buildingData.description,
                        floors: []
                    };
                    buildingsData.push(newBuilding);
                    alert('æ¥¼æ ‹æ·»åŠ æˆåŠŸï¼');

                    // æ ‡è®°ç©ºé—´æµç¨‹ä¸ºå®Œæˆ
                    let workflowProgress = JSON.parse(localStorage.getItem('workflowProgress') || '{}');
                    workflowProgress.space = true;
                    localStorage.setItem('workflowProgress', JSON.stringify(workflowProgress));
                }
                hideBuildingModal();
                renderBuildingTree();
            } catch (error) {
                console.error('ä¿å­˜æ¥¼æ ‹æ—¶å‡ºé”™:', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        function deleteBuilding(buildingId) {
            const building = buildingsData.find(b => b.id === buildingId);
            if (building) {
                deleteBuildingId = buildingId;
                document.getElementById('delete-building-name').textContent = building.name;
                document.getElementById('delete-building-modal').style.display = 'flex';
                document.body.classList.add('modal-open');
            }
        }

        function hideBuildingDeleteConfirm() {
            document.getElementById('delete-building-modal').style.display = 'none';
            document.body.classList.remove('modal-open');
            deleteBuildingId = null;
        }

        function confirmBuildingDelete() {
            if (deleteBuildingId) {
                const index = buildingsData.findIndex(b => b.id === deleteBuildingId);
                if (index > -1) {
                    const buildingName = buildingsData[index].name;
                    buildingsData.splice(index, 1);

                    // åˆ é™¤ç›¸å…³æˆ¿é—´
                    for (let i = roomsData.length - 1; i >= 0; i--) {
                        if (roomsData[i].buildingId === deleteBuildingId) {
                            roomsData.splice(i, 1);
                        }
                    }

                    // é‡ç½®é€‰æ‹©çŠ¶æ€
                    if (currentSelectedBuilding === deleteBuildingId) {
                        currentSelectedBuilding = null;
                        currentSelectedFloor = null;
                        document.getElementById('current-selection').textContent = '';
                    }

                    renderBuildingTree();
                    renderRoomsTable();
                    hideBuildingDeleteConfirm();

                    if (typeof EnergySystem !== 'undefined') {
                        EnergySystem.showNotification(`æ¥¼æ ‹ ${buildingName} åˆ é™¤æˆåŠŸï¼`, 'success');
                    } else {
                        alert(`æ¥¼æ ‹ ${buildingName} åˆ é™¤æˆåŠŸï¼`);
                    }
                }
            }
        }

        // ========== æ¥¼å±‚ç®¡ç†å‡½æ•° ==========
        function addFloor(buildingId) {
            const building = buildingsData.find(b => b.id === buildingId);
            if (building) {
                isFloorEditMode = false;
                editingFloorId = null;
                const lang = getCurrentLanguage();
                document.getElementById('floor-modal-title').textContent = lang === 'en' ? 'Add Floor' : 'æ·»åŠ æ¥¼å±‚';
                document.getElementById('floor-building-name').textContent = lang === 'en' ? building.nameEn : building.name;
                document.getElementById('floor-building-id').value = buildingId;
                document.getElementById('floor-form').reset();
                document.getElementById('floor-modal').style.display = 'flex';
                document.body.classList.add('modal-open');
            }
        }

        function editFloor(floorId) {
            const floor = buildingsData.flatMap(b => b.floors).find(f => f.id === floorId);
            if (floor) {
                const building = buildingsData.find(b => b.id === floor.buildingId);
                isFloorEditMode = true;
                editingFloorId = floorId;
                const lang = getCurrentLanguage();
                document.getElementById('floor-modal-title').textContent = lang === 'en' ? 'Edit Floor' : 'ç¼–è¾‘æ¥¼å±‚';
                document.getElementById('floor-building-name').textContent = lang === 'en' ? building.nameEn : building.name;
                document.getElementById('floor-building-id').value = floor.buildingId;
                document.getElementById('floor-number').value = floor.number;
                document.getElementById('floor-description').value = floor.description;
                document.getElementById('floor-modal').style.display = 'flex';
                document.body.classList.add('modal-open');
            }
        }

        function hideFloorModal() {
            document.getElementById('floor-modal').style.display = 'none';
            document.body.classList.remove('modal-open');
            isFloorEditMode = false;
            editingFloorId = null;
        }

        function saveFloor() {
            const formData = new FormData(document.getElementById('floor-form'));
            const buildingId = document.getElementById('floor-building-id').value;
            const floorData = {
                number: parseInt(formData.get('floorNumber')),
                description: formData.get('description').trim()
            };

            if (!floorData.number) {
                alert('è¯·å¡«å†™æ¥¼å±‚å·');
                return;
            }

            try {
                const building = buildingsData.find(b => b.id === buildingId);
                if (!building) return;

                if (isFloorEditMode && editingFloorId) {
                    // ç¼–è¾‘æ¨¡å¼
                    const floor = building.floors.find(f => f.id === editingFloorId);
                    if (floor) {
                        floor.number = floorData.number;
                        floor.description = floorData.description;
                        alert('æ¥¼å±‚ä¿¡æ¯æ›´æ–°æˆåŠŸï¼');
                    }
                } else {
                    // æ·»åŠ æ¨¡å¼
                    const newFloor = {
                        id: 'FLOOR' + String(Math.floor(Math.random() * 900) + 100),
                        number: floorData.number,
                        buildingId: buildingId,
                        description: floorData.description
                    };
                    building.floors.push(newFloor);
                    alert('æ¥¼å±‚æ·»åŠ æˆåŠŸï¼');
                }
                hideFloorModal();
                renderBuildingTree();
            } catch (error) {
                console.error('ä¿å­˜æ¥¼å±‚æ—¶å‡ºé”™:', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        function deleteFloor(floorId) {
            const floor = buildingsData.flatMap(b => b.floors).find(f => f.id === floorId);
            if (floor) {
                const building = buildingsData.find(b => b.id === floor.buildingId);
                deleteFloorId = floorId;
                document.getElementById('delete-floor-info').textContent = `${building.name} ${floor.number}æ¥¼`;
                document.getElementById('delete-floor-modal').style.display = 'flex';
                document.body.classList.add('modal-open');
            }
        }

        function hideFloorDeleteConfirm() {
            document.getElementById('delete-floor-modal').style.display = 'none';
            document.body.classList.remove('modal-open');
            deleteFloorId = null;
        }

        function confirmFloorDelete() {
            if (deleteFloorId) {
                const floor = buildingsData.flatMap(b => b.floors).find(f => f.id === deleteFloorId);
                if (floor) {
                    const building = buildingsData.find(b => b.id === floor.buildingId);
                    const floorIndex = building.floors.findIndex(f => f.id === deleteFloorId);

                    if (floorIndex > -1) {
                        building.floors.splice(floorIndex, 1);

                        // åˆ é™¤ç›¸å…³æˆ¿é—´
                        for (let i = roomsData.length - 1; i >= 0; i--) {
                            if (roomsData[i].floorId === deleteFloorId) {
                                roomsData.splice(i, 1);
                            }
                        }

                        // é‡ç½®é€‰æ‹©çŠ¶æ€
                        if (currentSelectedFloor === deleteFloorId) {
                            currentSelectedFloor = null;
                            if (currentSelectedBuilding === floor.buildingId) {
                                document.getElementById('current-selection').textContent = building.name;
                            } else {
                                currentSelectedBuilding = null;
                                document.getElementById('current-selection').textContent = '';
                            }
                        }

                        renderBuildingTree();
                        renderRoomsTable();
                        hideFloorDeleteConfirm();

                        if (typeof EnergySystem !== 'undefined') {
                            EnergySystem.showNotification(`${building.name} ${floor.number}æ¥¼ åˆ é™¤æˆåŠŸï¼`, 'success');
                        } else {
                            alert(`${building.name} ${floor.number}æ¥¼ åˆ é™¤æˆåŠŸï¼`);
                        }
                    }
                }
            }
        }

        // ========== æˆ¿é—´ç®¡ç†å‡½æ•° ==========
        function showAddRoomModal() {
            showAddModal();
        }

        function addRoomToFloor(floorId) {
            // æ‰¾åˆ°å¯¹åº”çš„æ¥¼å±‚
            const floor = buildingsData.flatMap(b => b.floors).find(f => f.id === floorId);
            if (floor) {
                // é€‰æ‹©è¯¥æ¥¼å±‚
                selectFloor(floorId);
                // æ‰“å¼€æ·»åŠ æˆ¿é—´å¼¹çª—
                showAddModal();
            }
        }

        // ========== ä½ç½®é€‰æ‹©å‡½æ•° ==========
        function initializeBuildingOptions() {
            const buildingSelect = document.getElementById('room-building');
            const lang = getCurrentLanguage();
            buildingSelect.innerHTML = `<option value="">${lang === 'en' ? 'Select Building' : 'è¯·é€‰æ‹©æ¥¼æ ‹'}</option>`;

            buildingsData.forEach(building => {
                const option = document.createElement('option');
                option.value = building.id;
                const name = lang === 'en' ? building.nameEn : building.name;
                const desc = lang === 'en' ? building.descriptionEn : building.description;
                option.textContent = `${name} - ${desc}`;
                buildingSelect.appendChild(option);
            });
        }

        function updateFloorOptions() {
            const buildingSelect = document.getElementById('room-building');
            const floorSelect = document.getElementById('room-floor');
            const selectedBuildingId = buildingSelect.value;
            const lang = getCurrentLanguage();

            // æ¸…ç©ºæ¥¼å±‚é€‰é¡¹
            floorSelect.innerHTML = '';

            if (!selectedBuildingId) {
                floorSelect.disabled = true;
                floorSelect.innerHTML = `<option value="">${lang === 'en' ? 'Select Building First' : 'è¯·å…ˆé€‰æ‹©æ¥¼æ ‹'}</option>`;
                return;
            }

            // æ‰¾åˆ°é€‰ä¸­çš„æ¥¼æ ‹
            const building = buildingsData.find(b => b.id === selectedBuildingId);
            if (building) {
                floorSelect.disabled = false;
                floorSelect.innerHTML = `<option value="">${lang === 'en' ? 'Select Floor' : 'è¯·é€‰æ‹©æ¥¼å±‚'}</option>`;

                // æ·»åŠ æ¥¼å±‚é€‰é¡¹
                building.floors.forEach(floor => {
                    const option = document.createElement('option');
                    option.value = floor.id;
                    const floorLabel = lang === 'en' ? `${floor.number}F` : `${floor.number}æ¥¼`;
                    const desc = lang === 'en' ? floor.descriptionEn : floor.description;
                    option.textContent = `${floorLabel} - ${desc}`;
                    floorSelect.appendChild(option);
                });
            }
        }

        function initializeMeterOptions() {
            const meterSelect = document.getElementById('bind-meter');
            const lang = getCurrentLanguage();

            const meterOptions = [
                { value: 'METER001', nameZh: 'METER001 - å•ç›¸ç”µè¡¨', nameEn: 'METER001 - Single Phase Meter' },
                { value: 'METER002', nameZh: 'METER002 - ä¸‰ç›¸ç”µè¡¨', nameEn: 'METER002 - Three Phase Meter' },
                { value: 'METER003', nameZh: 'METER003 - å•ç›¸ç”µè¡¨', nameEn: 'METER003 - Single Phase Meter' },
                { value: 'METER004', nameZh: 'METER004 - ä¸‰ç›¸ç”µè¡¨', nameEn: 'METER004 - Three Phase Meter' },
                { value: 'METER005', nameZh: 'METER005 - æ™ºèƒ½ç”µè¡¨', nameEn: 'METER005 - Smart Meter' }
            ];

            meterSelect.innerHTML = `<option value="">${lang === 'en' ? 'Select Meter' : 'è¯·é€‰æ‹©ç”µè¡¨'}</option>`;

            meterOptions.forEach(meter => {
                const option = document.createElement('option');
                option.value = meter.value;
                option.textContent = lang === 'en' ? meter.nameEn : meter.nameZh;
                meterSelect.appendChild(option);
            });
        }

        function initializeBillingTemplateOptions() {
            const billingSelect = document.getElementById('billing-template');
            const lang = getCurrentLanguage();

            const billingOptions = [
                { value: 'residential_basic', nameZh: 'ä½å®…åŸºç¡€è®¡è´¹', nameEn: 'Residential Basic' },
                { value: 'residential_tiered', nameZh: 'ä½å®…é˜¶æ¢¯è®¡è´¹', nameEn: 'Residential Tiered' },
                { value: 'commercial_standard', nameZh: 'å•†ä¸šæ ‡å‡†è®¡è´¹', nameEn: 'Commercial Standard' },
                { value: 'commercial_peak', nameZh: 'å•†ä¸šå³°è°·è®¡è´¹', nameEn: 'Commercial Peak' },
                { value: 'office_flat', nameZh: 'åŠå…¬å®¤å›ºå®šè®¡è´¹', nameEn: 'Office Flat Rate' }
            ];

            billingSelect.innerHTML = `<option value="">${lang === 'en' ? 'Select Billing Template' : 'è¯·é€‰æ‹©è®¡è´¹æ¨¡ç‰ˆ'}</option>`;

            billingOptions.forEach(billing => {
                const option = document.createElement('option');
                option.value = billing.value;
                option.textContent = lang === 'en' ? billing.nameEn : billing.nameZh;
                billingSelect.appendChild(option);
            });
        }

        function initializeFloorSelectDefault() {
            const floorSelect = document.getElementById('room-floor');
            const lang = getCurrentLanguage();

            floorSelect.innerHTML = `<option value="">${lang === 'en' ? 'Select Building First' : 'è¯·å…ˆé€‰æ‹©æ¥¼æ ‹'}</option>`;
            floorSelect.disabled = true;
        }

        function showAddModal() {
            // é‡ç½®ç¼–è¾‘æ¨¡å¼
            isEditMode = false;
            editingUserId = null;

            // åˆå§‹åŒ–å„ç§é€‰é¡¹
            initializeBuildingOptions();
            initializeMeterOptions();
            initializeBillingTemplateOptions();
            initializeFloorSelectDefault();

            // é‡ç½®è¡¨å•å’ŒUI
            const lang = getCurrentLanguage();
            document.getElementById('modal-title').textContent = lang === 'en' ? 'Add Room' : 'æ·»åŠ æˆ¿é—´';
            document.getElementById('user-form').reset();

            // é‡ç½®è¡¨å•å­—æ®µçŠ¶æ€
            const roomNumberField = document.getElementById('room-number');
            roomNumberField.readOnly = false;
            roomNumberField.disabled = false;
            roomNumberField.style.backgroundColor = '';
            roomNumberField.style.color = '';
            roomNumberField.style.cursor = '';

            // æ˜¾ç¤ºå¼¹çª—
            document.getElementById('user-modal').style.display = 'flex';
            document.body.classList.add('modal-open');
        }

        function hideModal() {
            document.getElementById('user-modal').style.display = 'none';
            document.body.classList.remove('modal-open');

            // é‡ç½®ç¼–è¾‘æ¨¡å¼
            isEditMode = false;
            editingUserId = null;

            // é‡ç½®è¡¨å•å­—æ®µçŠ¶æ€
            const roomNumberField = document.getElementById('room-number');
            roomNumberField.readOnly = false;
            roomNumberField.disabled = false;
            roomNumberField.style.backgroundColor = '';
            roomNumberField.style.color = '';
            roomNumberField.style.cursor = '';

            // é‡ç½®æ¥¼æ ‹å’Œæ¥¼å±‚é€‰æ‹©
            document.getElementById('room-building').value = '';
            document.getElementById('room-floor').disabled = true;
            document.getElementById('room-floor').innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©æ¥¼æ ‹</option>';
        }

        function saveUser() {
            const formData = new FormData(document.getElementById('user-form'));

            // è·å–è¡¨å•æ•°æ®
            const buildingId = formData.get('building');
            const floorId = formData.get('floor');

            // æŸ¥æ‰¾æ¥¼æ ‹å’Œæ¥¼å±‚ä¿¡æ¯
            const building = buildingsData.find(b => b.id === buildingId);
            const floor = building ? building.floors.find(f => f.id === floorId) : null;

            const roomData = {
                roomNumber: formData.get('roomNumber').trim(),
                buildingId: buildingId,
                floorId: floorId,
                floorNumber: floor ? floor.number : null,
                meterId: formData.get('meterId'),
                billingTemplate: formData.get('billingTemplate'),
                description: formData.get('description').trim()
            };

            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!roomData.roomNumber || !buildingId || !floorId || !roomData.meterId || !roomData.billingTemplate) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µï¼ŒåŒ…æ‹¬é€‰æ‹©æ¥¼æ ‹å’Œæ¥¼å±‚');
                return;
            }

            try {
                if (isEditMode && editingUserId) {
                    // ç¼–è¾‘æ¨¡å¼ï¼šæ›´æ–°ç°æœ‰æˆ¿é—´
                    const roomIndex = roomsData.findIndex(r => r.id === editingUserId);
                    if (roomIndex > -1) {
                        // ä¿ç•™åŸæœ‰æ•°æ®ï¼Œåªæ›´æ–°å…è®¸ç¼–è¾‘çš„å­—æ®µ
                        roomsData[roomIndex].meterId = roomData.meterId;
                        roomsData[roomIndex].billingTemplate = roomData.billingTemplate;
                        roomsData[roomIndex].buildingId = roomData.buildingId;
                        roomsData[roomIndex].floorId = roomData.floorId;
                        roomsData[roomIndex].floorNumber = roomData.floorNumber;
                        roomsData[roomIndex].description = roomData.description;
                        // æˆ¿é—´å·ä¸å…è®¸ç¼–è¾‘ï¼Œä¿æŒåŸå€¼

                        // é‡æ–°æ¸²æŸ“è¡¨æ ¼å’Œå¡ç‰‡
                        renderRoomsTable();
                        renderRoomsCards();
                        // å…³é—­æ¨¡æ€æ¡†
                        hideModal();

                        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        if (typeof EnergySystem !== 'undefined') {
                            EnergySystem.showNotification('æˆ¿é—´ä¿¡æ¯æ›´æ–°æˆåŠŸï¼', 'success');
                        } else {
                            alert('æˆ¿é—´ä¿¡æ¯æ›´æ–°æˆåŠŸï¼');
                        }
                    }
                } else {
                    // æ·»åŠ æ¨¡å¼ï¼šåˆ›å»ºæ–°æˆ¿é—´
                    const newRoom = {
                        id: 'ROOM' + String(Math.floor(Math.random() * 900) + 100),
                        roomNumber: roomData.roomNumber,
                        buildingId: roomData.buildingId,
                        floorId: roomData.floorId,
                        floorNumber: roomData.floorNumber,
                        meterId: roomData.meterId,
                        billingTemplate: roomData.billingTemplate,
                        description: roomData.description,
                        status: 'vacant',
                        tenant: null,
                        tenantPhone: null,
                        checkinDate: null,
                        electricityReading: null
                    };

                    // æ·»åŠ åˆ°æˆ¿é—´åˆ—è¡¨
                    roomsData.push(newRoom);
                    // é‡æ–°æ¸²æŸ“è¡¨æ ¼å’Œå¡ç‰‡
                    renderRoomsTable();
                    renderRoomsCards();
                    // å…³é—­æ¨¡æ€æ¡†
                    hideModal();

                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    if (typeof EnergySystem !== 'undefined') {
                        EnergySystem.showNotification('æˆ¿é—´æ·»åŠ æˆåŠŸï¼', 'success');
                    } else {
                        alert('æˆ¿é—´æ·»åŠ æˆåŠŸï¼');
                    }
                }
            } catch (error) {
                console.error('ä¿å­˜ç§Ÿæˆ·æ—¶å‡ºé”™:', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        function editRoom(roomId) {
            const room = roomsData.find(r => r.id === roomId);
            if (room) {
                // è®¾ç½®ä¸ºç¼–è¾‘æ¨¡å¼
                isEditMode = true;
                editingUserId = roomId;

                // åˆå§‹åŒ–å„ç§é€‰é¡¹
                initializeBuildingOptions();
                initializeMeterOptions();
                initializeBillingTemplateOptions();
                initializeFloorSelectDefault();

                // æ›´æ–°å¼¹çª—æ ‡é¢˜
                const lang = getCurrentLanguage();
                document.getElementById('modal-title').textContent = lang === 'en' ? 'Edit Room' : 'ç¼–è¾‘æˆ¿é—´';

                // å¡«å……è¡¨å•æ•°æ®
                document.getElementById('room-number').value = room.roomNumber || '';
                document.getElementById('bind-meter').value = room.meterId || '';
                document.getElementById('billing-template').value = room.billingTemplate || '';

                // è®¾ç½®æ¥¼æ ‹å’Œæ¥¼å±‚é€‰æ‹©
                if (room.buildingId) {
                    document.getElementById('room-building').value = room.buildingId;
                    updateFloorOptions();

                    // è®¾ç½®æ¥¼å±‚é€‰æ‹©
                    if (room.floorId) {
                        setTimeout(() => {
                            document.getElementById('room-floor').value = room.floorId;
                        }, 0);
                    }
                }

                document.getElementById('room-description').value = (lang === 'en' ? room.descriptionEn : room.description) || '';

                // è®¾ç½®æˆ¿é—´å·ä¸ºåªè¯»ï¼ˆç¼–è¾‘æ—¶ä¸å…è®¸ä¿®æ”¹æˆ¿é—´å·ï¼‰
                const roomNumberField = document.getElementById('room-number');
                roomNumberField.readOnly = true;
                roomNumberField.disabled = false;
                roomNumberField.style.backgroundColor = '#f5f5f5';
                roomNumberField.style.color = '#666';
                roomNumberField.style.cursor = 'not-allowed';

                // æ˜¾ç¤ºå¼¹çª—
                document.getElementById('user-modal').style.display = 'flex';
                document.body.classList.add('modal-open');
            }
        }

        function deleteRoom(roomId) {
            const room = roomsData.find(r => r.id === roomId);
            if (!room) return;

            if (typeof EnergySystem !== 'undefined' && EnergySystem.showConfirmDialog) {
                const lang = getCurrentLanguage();
                const message = lang === 'en' ? `Are you sure you want to delete room ${room.roomNumber}?` : `ç¡®å®šè¦åˆ é™¤æˆ¿é—´ ${room.roomNumber} å—ï¼Ÿ`;
                EnergySystem.showConfirmDialog(
                    message,
                    (confirmed) => {
                        if (confirmed) {
                            // åˆ é™¤æˆ¿é—´é€»è¾‘
                            const index = roomsData.findIndex(r => r.id === roomId);
                            if (index > -1) {
                                roomsData.splice(index, 1);
                                renderRoomsTable();
                                renderRoomsCards();
                                if (typeof EnergySystem !== 'undefined' && EnergySystem.showNotification) {
                                    EnergySystem.showNotification(`å·²åˆ é™¤æˆ¿é—´: ${room.roomNumber}`, 'success');
                                } else {
                                    alert(`å·²åˆ é™¤æˆ¿é—´: ${room.roomNumber}`);
                                }
                            }
                        }
                    }
                );
            } else {
                const lang = getCurrentLanguage();
                const message = lang === 'en' ? `Are you sure you want to delete room ${room.roomNumber}?` : `ç¡®å®šè¦åˆ é™¤æˆ¿é—´ ${room.roomNumber} å—ï¼Ÿ`;
                if (confirm(message)) {
                    // åˆ é™¤æˆ¿é—´é€»è¾‘
                    const index = roomsData.findIndex(r => r.id === roomId);
                    if (index > -1) {
                        roomsData.splice(index, 1);
                        renderRoomsTable();
                        renderRoomsCards();
                        alert(`å·²åˆ é™¤æˆ¿é—´: ${room.roomNumber}`);
                    }
                }
            }
        }

        function assignTenant(roomId) {
            const room = roomsData.find(r => r.id === roomId);
            if (room) {
                // å¡«å……å…¥é©»è¡¨å•
                document.getElementById('checkin-user-name').textContent = `æˆ¿é—´: ${room.roomNumber}`;
                document.getElementById('checkin-user-id').value = roomId;

                // è®¾ç½®é»˜è®¤å…¥é©»æ—¥æœŸä¸ºä»Šå¤©
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('checkin-date').value = today;

                // åˆå§‹åŒ–ç§Ÿæˆ·æœç´¢
                initTenantSearch();

                // æ˜¾ç¤ºå…¥é©»å¼¹çª—
                document.getElementById('checkin-modal').style.display = 'flex';
                document.body.classList.add('modal-open');
            }
        }

        // åˆå§‹åŒ–ç§Ÿæˆ·æœç´¢åŠŸèƒ½
        function initTenantSearch() {
            const searchInput = document.getElementById('checkin-tenant-search');
            const resultsDiv = document.getElementById('tenant-search-results');
            let selectedTenant = null;

            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();

                if (query.length === 0) {
                    resultsDiv.style.display = 'none';
                    selectedTenant = null;
                    return;
                }

                // è¿‡æ»¤ç§Ÿæˆ·
                const filteredTenants = tenantsData.filter(tenant =>
                    tenant.name.toLowerCase().includes(query) ||
                    tenant.phone.includes(query)
                );

                if (filteredTenants.length > 0) {
                    displaySearchResults(filteredTenants, resultsDiv, searchInput);
                } else {
                    resultsDiv.innerHTML = '<div class="search-result-item">æœªæ‰¾åˆ°åŒ¹é…çš„ç§Ÿæˆ·ï¼Œå¯è¾“å…¥æ–°ç§Ÿæˆ·å§“å</div>';
                    resultsDiv.style.display = 'block';
                }
            });

            searchInput.addEventListener('focus', function() {
                if (this.value.trim().length > 0) {
                    resultsDiv.style.display = 'block';
                }
            });

            // ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—æœç´¢ç»“æœ
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
                    resultsDiv.style.display = 'none';
                }
            });
        }

        function displaySearchResults(tenants, resultsDiv, searchInput) {
            resultsDiv.innerHTML = '';

            tenants.forEach(tenant => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.innerHTML = `
                    <div class="tenant-name">${tenant.name}</div>
                    <div class="tenant-phone">${tenant.phone}</div>
                `;

                item.addEventListener('click', function() {
                    searchInput.value = tenant.name;
                    searchInput.dataset.tenantId = tenant.id;
                    searchInput.dataset.tenantPhone = tenant.phone;
                    resultsDiv.style.display = 'none';
                });

                resultsDiv.appendChild(item);
            });

            resultsDiv.style.display = 'block';
        }

        function checkoutTenant(roomId) {
            const room = roomsData.find(r => r.id === roomId);
            if (room) {
                // å¡«å……é€€ç§Ÿè¡¨å•
                const lang = getCurrentLanguage();
                const tenantName = room.tenant ? (lang === 'en' ? room.tenantEn : room.tenant) : (lang === 'en' ? 'Unknown Tenant' : 'æœªçŸ¥ç§Ÿæˆ·');
                document.getElementById('checkout-user-name').textContent = tenantName;
                document.getElementById('checkout-user-room').textContent = room.roomNumber;
                document.getElementById('checkout-user-id').value = roomId;

                // è®¾ç½®é»˜è®¤é€€ç§Ÿæ—¥æœŸä¸ºä»Šå¤©
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('checkout-date').value = today;

                // è®¾ç½®å½“å‰ç”µè¡¨è¯»æ•°
                if (room.electricityReading) {
                    document.getElementById('checkout-electricity-reading').value = room.electricityReading;
                }

                // æ˜¾ç¤ºé€€ç§Ÿå¼¹çª—
                document.getElementById('checkout-modal').style.display = 'flex';
                document.body.classList.add('modal-open');
            }
        }

        // å…¥é©»å¼¹çª—å‡½æ•°
        function hideCheckinModal() {
            document.getElementById('checkin-modal').style.display = 'none';
            document.body.classList.remove('modal-open');
            // æ¸…ç©ºè¡¨å•
            document.getElementById('checkin-form').reset();
            document.getElementById('checkin-user-name').textContent = '--';
            document.getElementById('checkin-user-id').value = '';
            // æ¸…ç©ºæœç´¢è¾“å…¥
            const searchInput = document.getElementById('checkin-tenant-search');
            searchInput.value = '';
            searchInput.dataset.tenantId = '';
            searchInput.dataset.tenantPhone = '';
            document.getElementById('tenant-search-results').style.display = 'none';
        }

        function readCurrentMeter() {
            // æ¨¡æ‹Ÿè¯»å–å½“å‰ç”µè¡¨è¯»æ•°
            const currentReading = (Math.random() * 1000 + 500).toFixed(2);
            document.getElementById('electricity-reading').value = currentReading;

            if (typeof EnergySystem !== 'undefined') {
                EnergySystem.showNotification(`å·²è¯»å–å½“å‰ç”µè¡¨è¯»æ•°ï¼š${currentReading} kWh`, 'success');
            } else {
                alert(`å·²è¯»å–å½“å‰ç”µè¡¨è¯»æ•°ï¼š${currentReading} kWh`);
            }
        }

        function saveCheckin() {
            const formData = new FormData(document.getElementById('checkin-form'));
            const roomId = document.getElementById('checkin-user-id').value;
            const searchInput = document.getElementById('checkin-tenant-search');

            // è·å–è¡¨å•æ•°æ®
            const checkinData = {
                tenantName: searchInput.value.trim(),
                tenantPhone: searchInput.dataset.tenantPhone || '',
                checkinDate: formData.get('checkinDate'),
                electricityReading: parseFloat(formData.get('electricityReading'))
            };

            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!checkinData.tenantName || !checkinData.checkinDate ||
                isNaN(checkinData.electricityReading)) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
                return;
            }

            // éªŒè¯è¯»æ•°å€¼
            if (checkinData.electricityReading < 0) {
                alert('ç”µè¡¨è¯»æ•°ä¸èƒ½ä¸ºè´Ÿæ•°');
                return;
            }

            try {
                // æ›´æ–°æˆ¿é—´çŠ¶æ€
                const room = roomsData.find(r => r.id === roomId);
                if (room) {
                    room.status = 'occupied';
                    room.tenant = checkinData.tenantName;
                    room.tenantPhone = checkinData.tenantPhone;
                    room.checkinDate = checkinData.checkinDate;
                    room.electricityReading = checkinData.electricityReading;

                    // é‡æ–°æ¸²æŸ“è¡¨æ ¼å’Œå¡ç‰‡
                    renderRoomsTable();
                    renderRoomsCards();

                    // å…³é—­å¼¹çª—
                    hideCheckinModal();

                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    if (typeof EnergySystem !== 'undefined') {
                        EnergySystem.showNotification(`${checkinData.tenantName} å…¥é©»æˆåŠŸï¼æˆ¿é—´ï¼š${room.roomNumber}`, 'success');
                    } else {
                        alert(`${checkinData.tenantName} å…¥é©»æˆåŠŸï¼æˆ¿é—´ï¼š${room.roomNumber}`);
                    }
                }
            } catch (error) {
                console.error('å…¥é©»ä¿å­˜å¤±è´¥:', error);
                alert('å…¥é©»ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // é€€ç§Ÿå¼¹çª—å‡½æ•°
        function hideCheckoutModal() {
            document.getElementById('checkout-modal').style.display = 'none';
            document.body.classList.remove('modal-open');
            // æ¸…ç©ºè¡¨å•
            document.getElementById('checkout-form').reset();
        }

        function readCurrentMeterForCheckout() {
            // æ¨¡æ‹Ÿè¯»å–å½“å‰ç”µè¡¨è¯»æ•°
            const currentReading = (Math.random() * 1000 + 500).toFixed(2);
            document.getElementById('checkout-electricity-reading').value = currentReading;

            if (typeof EnergySystem !== 'undefined') {
                EnergySystem.showNotification(`å·²è¯»å–å½“å‰ç”µè¡¨è¯»æ•°ï¼š${currentReading} kWh`, 'success');
            } else {
                alert(`å·²è¯»å–å½“å‰ç”µè¡¨è¯»æ•°ï¼š${currentReading} kWh`);
            }
        }

        function saveCheckout() {
            const formData = new FormData(document.getElementById('checkout-form'));
            const roomId = document.getElementById('checkout-user-id').value;

            // è·å–è¡¨å•æ•°æ®
            const checkoutData = {
                checkoutDate: formData.get('checkoutDate'),
                electricityReading: parseFloat(formData.get('electricityReading'))
            };

            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!checkoutData.checkoutDate || isNaN(checkoutData.electricityReading)) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
                return;
            }

            // éªŒè¯è¯»æ•°å€¼
            if (checkoutData.electricityReading < 0) {
                alert('ç”µè¡¨è¯»æ•°ä¸èƒ½ä¸ºè´Ÿæ•°');
                return;
            }

            try {
                // æ›´æ–°æˆ¿é—´çŠ¶æ€
                const room = roomsData.find(r => r.id === roomId);
                if (room) {
                    const tenantName = room.tenant;
                    room.status = 'vacant';
                    room.checkoutDate = checkoutData.checkoutDate;
                    room.finalElectricityReading = checkoutData.electricityReading;
                    // æ¸…é™¤ç§Ÿæˆ·ä¿¡æ¯
                    room.tenant = null;
                    room.tenantPhone = null;

                    // é‡æ–°æ¸²æŸ“è¡¨æ ¼å’Œå¡ç‰‡
                    renderRoomsTable();
                    renderRoomsCards();

                    // å…³é—­å¼¹çª—
                    hideCheckoutModal();

                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    if (typeof EnergySystem !== 'undefined') {
                        EnergySystem.showNotification(`${tenantName} é€€ç§ŸæˆåŠŸï¼æˆ¿é—´ï¼š${room.roomNumber}`, 'success');
                    } else {
                        alert(`${tenantName} é€€ç§ŸæˆåŠŸï¼æˆ¿é—´ï¼š${room.roomNumber}`);
                    }
                }
            } catch (error) {
                console.error('é€€ç§Ÿä¿å­˜å¤±è´¥:', error);
                alert('é€€ç§Ÿä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        function hideDeleteConfirm() {
            document.getElementById('delete-confirm-modal').style.display = 'none';
            document.body.classList.remove('modal-open');
            deleteUserId = null;
        }

        function confirmDelete() {
            if (deleteUserId) {
                const index = usersData.findIndex(u => u.id === deleteUserId);
                if (index > -1) {
                    const userName = usersData[index].name;
                    usersData.splice(index, 1);
                    renderUsersTable();
                    hideDeleteConfirm();

                    if (typeof EnergySystem !== 'undefined') {
                        EnergySystem.showNotification(`${userName} åˆ é™¤æˆåŠŸï¼`, 'success');
                    } else {
                        alert(`${userName} åˆ é™¤æˆåŠŸï¼`);
                    }
                }
            }
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.addEventListener('click', function(event) {
            const userModal = document.getElementById('user-modal');
            if (event.target === userModal || event.target === userModal.querySelector('.modal-overlay')) {
                hideModal();
            }

            const buildingModal = document.getElementById('building-modal');
            if (event.target === buildingModal || event.target === buildingModal.querySelector('.modal-overlay')) {
                hideBuildingModal();
            }

            const floorModal = document.getElementById('floor-modal');
            if (event.target === floorModal || event.target === floorModal.querySelector('.modal-overlay')) {
                hideFloorModal();
            }

            const deleteBuildingModal = document.getElementById('delete-building-modal');
            if (event.target === deleteBuildingModal || event.target === deleteBuildingModal.querySelector('.modal-overlay')) {
                hideBuildingDeleteConfirm();
            }

            const deleteFloorModal = document.getElementById('delete-floor-modal');
            if (event.target === deleteFloorModal || event.target === deleteFloorModal.querySelector('.modal-overlay')) {
                hideFloorDeleteConfirm();
            }

            const checkinModal = document.getElementById('checkin-modal');
            if (event.target === checkinModal || event.target === checkinModal.querySelector('.modal-overlay')) {
                hideCheckinModal();
            }

            const checkoutModal = document.getElementById('checkout-modal');
            if (event.target === checkoutModal || event.target === checkoutModal.querySelector('.modal-overlay')) {
                hideCheckoutModal();
            }

            const deleteModal = document.getElementById('delete-confirm-modal');
            if (event.target === deleteModal || event.target === deleteModal.querySelector('.modal-overlay')) {
                hideDeleteConfirm();
            }
        });

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ç©ºé—´ç®¡ç†é¡µé¢åŠ è½½å¼€å§‹');

            // æ£€æŸ¥EnergySystemæ˜¯å¦å¯ç”¨
            if (typeof EnergySystem !== 'undefined') {
                console.log('EnergySystemå¯ç”¨');
                EnergySystem.setActiveNavigation('space-management.html');
                // æ£€æŸ¥initLanguageSystemæ–¹æ³•æ˜¯å¦å­˜åœ¨
                if (typeof EnergySystem.initLanguageSystem === 'function') {
                    EnergySystem.initLanguageSystem();
                } else {
                    console.log('EnergySystem.initLanguageSystemæ–¹æ³•ä¸å­˜åœ¨ï¼Œä½¿ç”¨å¤‡ç”¨è¯­è¨€ç³»ç»Ÿ');
                    if (typeof initLanguageSystem === 'function') {
                        initLanguageSystem();
                    }
                }
            } else {
                console.log('EnergySystemä¸å¯ç”¨ï¼Œä½¿ç”¨ç®€å•è¯­è¨€ç³»ç»Ÿ');
                if (typeof initLanguageSystem === 'function') {
                    initLanguageSystem();
                }
            }

            // è¾“å‡ºæ•°æ®ä¿¡æ¯
            console.log('åˆå§‹åŒ–æ—¶buildingsData length:', buildingsData.length);
            console.log('åˆå§‹åŒ–æ—¶roomsData length:', roomsData.length);
            console.log('buildingsData sample:', buildingsData[0]);
            console.log('roomsData sample:', roomsData[0]);

            // æ¸²æŸ“å»ºç­‘æ ‘å’Œæˆ¿é—´è¡¨æ ¼
            console.log('å‡†å¤‡æ¸²æŸ“å»ºç­‘æ ‘...');
            renderBuildingTree();
            console.log('å‡†å¤‡æ¸²æŸ“æˆ¿é—´è¡¨æ ¼...');
            renderRoomsTable();

            // åˆå§‹åŒ–è¡¨å•é€‰é¡¹
            initializeBuildingOptions();
            initializeMeterOptions();
            initializeBillingTemplateOptions();
            initializeFloorSelectDefault();
            console.log('ç©ºé—´ç®¡ç†é¡µé¢åˆå§‹åŒ–å®Œæˆ');

            // æ·»åŠ è¯­è¨€åˆ‡æ¢äº‹ä»¶ç›‘å¬å™¨
            const languageSelect = document.getElementById('language-select');
            if (languageSelect) {
                languageSelect.addEventListener('change', function() {
                    console.log('è¯­è¨€åˆ‡æ¢åˆ°:', this.value);
                    // é‡æ–°æ¸²æŸ“åŠ¨æ€å†…å®¹ä»¥åº”ç”¨æ–°è¯­è¨€
                    renderBuildingTree();
                    initializeBuildingOptions();
                    initializeMeterOptions();
                    initializeBillingTemplateOptions();
                    initializeFloorSelectDefault();
                    updateFloorOptions();
                    if (currentView === 'table') {
                        renderRoomsTable();
                    } else {
                        renderRoomsCards();
                    }
                });
            }

            // æ·»åŠ å®æ—¶è¾“å…¥éªŒè¯
            const buildingNameInput = document.getElementById('building-name');
            if (buildingNameInput) {
                buildingNameInput.addEventListener('input', function() {
                    if (this.value.length > 20) {
                        const lang = getCurrentLanguage();
                        this.style.borderColor = 'red';
                        this.title = lang === 'en' ? 'Building name cannot exceed 20 characters' : 'æ¥¼æ ‹åç§°ä¸èƒ½è¶…è¿‡20ä¸ªå­—ç¬¦';
                    } else {
                        this.style.borderColor = '';
                        this.title = '';
                    }
                });
            }

            const totalFloorsInput = document.getElementById('total-floors');
            if (totalFloorsInput) {
                totalFloorsInput.addEventListener('input', function() {
                    const value = parseInt(this.value);
                    if (value < 1 || value > 50) {
                        const lang = getCurrentLanguage();
                        this.style.borderColor = 'red';
                        this.title = lang === 'en' ? 'Total floors must be between 1 and 50' : 'æ¥¼å±‚æ•°å¿…é¡»åœ¨1-50ä¹‹é—´';
                    } else {
                        this.style.borderColor = '';
                        this.title = '';
                    }
                });
            }

            // å»¶è¿Ÿæ£€æŸ¥è¡¨æ ¼å’Œå»ºç­‘æ ‘æ˜¯å¦æœ‰æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰åˆ™å¼ºåˆ¶æ˜¾ç¤º
            setTimeout(function() {
                const roomsTbody = document.getElementById('rooms-tbody');
                const buildingTree = document.getElementById('building-tree');

                // æ£€æŸ¥æˆ¿é—´è¡¨æ ¼
                if (roomsTbody && (!roomsTbody.innerHTML || roomsTbody.innerHTML.trim() === '')) {
                    console.log('æˆ¿é—´è¡¨æ ¼ä¸ºç©ºï¼Œå¼ºåˆ¶æ˜¾ç¤ºæˆ¿é—´æ•°æ®');
                    // ç›´æ¥è°ƒç”¨ä¸€æ¬¡æ¸²æŸ“å‡½æ•°
                    renderRoomsTable();

                    // å¦‚æœè¿˜æ˜¯æ²¡æœ‰æ•°æ®ï¼Œæ‰‹åŠ¨æ’å…¥ç¤ºä¾‹æ•°æ®
                    setTimeout(function() {
                        if (!roomsTbody.innerHTML || roomsTbody.innerHTML.trim() === '') {
                            roomsTbody.innerHTML = `
                                <tr>
                                    <td>A-101</td>
                                    <td>Aæ ‹ 1æ¥¼</td>
                                    <td>ä½å®…åŸºç¡€è®¡è´¹</td>
                                    <td><span class="status-online">å·²å…¥é©»</span></td>
                                    <td>å¼ ä¸‰</td>
                                    <td>
                                        <button class="btn-sm btn-primary" onclick="editRoom('ROOM001')">ç¼–è¾‘</button>
                                        <button class="btn-sm btn-danger" onclick="deleteRoom('ROOM001')">åˆ é™¤</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>A-102</td>
                                    <td>Aæ ‹ 1æ¥¼</td>
                                    <td>ä½å®…é˜¶æ¢¯è®¡è´¹</td>
                                    <td><span class="status-offline">ç©ºé—²</span></td>
                                    <td>--</td>
                                    <td>
                                        <button class="btn-sm btn-primary" onclick="editRoom('ROOM002')">ç¼–è¾‘</button>
                                        <button class="btn-sm btn-danger" onclick="deleteRoom('ROOM002')">åˆ é™¤</button>
                                    </td>
                                </tr>
                            `;
                            console.log('å·²å¼ºåˆ¶æ˜¾ç¤ºæˆ¿é—´æ•°æ®');
                        }
                    }, 500);
                }

                // æ£€æŸ¥å»ºç­‘æ ‘
                if (buildingTree && (!buildingTree.innerHTML || buildingTree.innerHTML.trim() === '')) {
                    console.log('å»ºç­‘æ ‘ä¸ºç©ºï¼Œå¼ºåˆ¶æ˜¾ç¤ºå»ºç­‘æ•°æ®');
                    // ç›´æ¥è°ƒç”¨ä¸€æ¬¡æ¸²æŸ“å‡½æ•°
                    renderBuildingTree();

                    // å¦‚æœè¿˜æ˜¯æ²¡æœ‰æ•°æ®ï¼Œæ‰‹åŠ¨æ’å…¥ç¤ºä¾‹æ•°æ®
                    setTimeout(function() {
                        if (!buildingTree.innerHTML || buildingTree.innerHTML.trim() === '') {
                            buildingTree.innerHTML = `
                                <div class="tree-node building-node">
                                    <div class="tree-item" onclick="selectBuilding('BUILDING001')">
                                        <span class="tree-icon">ğŸ¢</span>
                                        <span class="tree-label">Aæ ‹</span>
                                        <div class="tree-actions">
                                            <button class="btn-icon" onclick="event.stopPropagation(); editBuilding('BUILDING001')" title="ç¼–è¾‘æ¥¼æ ‹">âœï¸</button>
                                            <button class="btn-icon" onclick="event.stopPropagation(); deleteBuilding('BUILDING001')" title="åˆ é™¤æ¥¼æ ‹">ğŸ—‘ï¸</button>
                                        </div>
                                    </div>
                                    <div class="tree-children">
                                        <div class="tree-node floor-node">
                                            <div class="tree-item" onclick="selectFloor('FLOOR001')">
                                                <span class="tree-icon">ğŸ“</span>
                                                <span class="tree-label">1æ¥¼</span>
                                                <div class="tree-actions">
                                                    <button class="btn-icon" onclick="event.stopPropagation(); editFloor('FLOOR001')" title="ç¼–è¾‘æ¥¼å±‚">âœï¸</button>
                                                    <button class="btn-icon" onclick="event.stopPropagation(); addRoomToFloor('FLOOR001')" title="æ·»åŠ æˆ¿é—´">â•</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            console.log('å·²å¼ºåˆ¶æ˜¾ç¤ºå»ºç­‘æ ‘æ•°æ®');
                        }
                    }, 500);
                }
            }, 1000);
        });
    </script>
    <script>
        // æ·»åŠ ç”¨æˆ·ç®¡ç†é¡µé¢ç‰¹æœ‰æ ·å¼ - ä¸bills.htmlä¿æŒä¸€è‡´
        const style = document.createElement('style');
        style.textContent = `
            /* å¯¼èˆªæ æ ·å¼ - è¦†ç›–common.css */
            .navbar {
                height: 56px !important;
                overflow: hidden !important;
                background: rgba(255, 255, 255, 0.8) !important;
                backdrop-filter: blur(20px) !important;
                border-bottom: var(--border) !important;
                position: sticky !important;
                top: 0 !important;
                z-index: 1000 !important;
            }

            .nav-content {
                display: flex !important;
                align-items: center !important;
                justify-content: space-between !important;
                padding: 12px 20px !important;
                gap: 15px !important;
                height: 100% !important;
                max-width: none !important;
                margin: 0 !important;
            }

            .nav-brand {
                display: flex !important;
                align-items: center !important;
                flex-shrink: 0 !important;
            }

            .nav-menu {
                flex: 1 !important;
                display: flex !important;
                justify-content: center !important;
                gap: 20px !important;
            }

            .nav-actions {
                display: flex !important;
                align-items: center !important;
                gap: 15px !important;
            }

            .nav-logo {
                height: 32px !important;
                max-width: 150px !important;
                object-fit: contain !important;
                transition: all 0.2s ease !important;
            }

            .nav-logo:hover {
                transform: scale(1.02) !important;
            }

            /* å¸ƒå±€ç³»ç»Ÿ */
            .content-layout {
                display: flex;
                max-width: 1600px;
                margin: 0 auto;
                padding: var(--space-12) var(--space-8);
                gap: var(--space-6);
            }

            /* å·¦ä¾§è¾¹æ æ ·å¼ */
            .sidebar-container {
                width: 300px;
                flex-shrink: 0;
                background: var(--background);
                border: var(--border);
                border-radius: var(--radius);
                overflow: hidden;
                height: fit-content;
                max-height: calc(100vh - 120px);
                display: flex;
                flex-direction: column;
            }

            .sidebar-header {
                padding: var(--space-4) var(--space-6);
                background: var(--surface);
                border-bottom: var(--border);
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .sidebar-header h3 {
                margin: 0;
                font-size: 16px;
                font-weight: 600;
                color: var(--text-primary);
            }

            .sidebar-actions {
                display: flex;
                gap: var(--space-2);
            }

            .tree-container {
                flex: 1;
                overflow-y: auto;
                padding: var(--space-4);
            }

            /* æ ‘ç»“æ„æ ·å¼ */
            .tree {
                font-size: 14px;
            }

            .tree-node {
                margin-bottom: var(--space-2);
            }

            .tree-item {
                display: flex;
                align-items: center;
                padding: var(--space-2) var(--space-3);
                border-radius: var(--radius);
                cursor: pointer;
                transition: all 0.2s ease;
                position: relative;
                gap: var(--space-2);
            }

            .tree-item:hover {
                background: var(--surface);
            }

            .tree-item.selected {
                background: var(--primary);
                color: white;
            }

            .tree-item.selected .tree-actions {
                opacity: 1;
            }

            .tree-icon {
                font-size: 16px;
                width: 20px;
                text-align: center;
                flex-shrink: 0;
            }

            .tree-label {
                flex: 1;
                font-weight: 500;
            }

            .tree-actions {
                display: flex;
                gap: var(--space-1);
                opacity: 0;
                transition: opacity 0.2s ease;
            }

            .tree-item:hover .tree-actions {
                opacity: 1;
            }

            .btn-icon {
                background: none;
                border: none;
                padding: 2px 4px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
                transition: all 0.2s ease;
            }

            .btn-icon:hover {
                background: rgba(0, 0, 0, 0.1);
            }

            .tree-item.selected .btn-icon:hover {
                background: rgba(255, 255, 255, 0.2);
            }

            .tree-children {
                margin-left: var(--space-6);
                margin-top: var(--space-2);
                border-left: 2px solid var(--divider);
                padding-left: var(--space-4);
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease;
            }

            .tree-children.expanded {
                max-height: 1000px;
            }

            .floor-item {
                margin-bottom: var(--space-1);
                font-size: 13px;
            }

            .floor-item .tree-icon {
                font-size: 14px;
            }

            .main-container {
                flex: 1;
                min-width: 0;
                padding-top: 0;
            }

            /* è¡¨æ ¼æ ‡é¢˜æ ·å¼ */
            .table-title {
                font-size: 16px;
                font-weight: 600;
                color: var(--text-primary);
            }

            /* æœç´¢åŒºåŸŸæ ·å¼ */
            .search-section {
                background: var(--background);
                border: var(--border);
                border-radius: var(--radius);
                padding: var(--space-6);
                margin-bottom: var(--space-6);
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: var(--space-4);
            }

            .search-controls {
                display: flex;
                gap: var(--space-4);
                flex: 1;
            }

            .search-controls .form-input {
                min-width: 300px;
            }

            .search-actions {
                display: flex;
                gap: var(--space-3);
            }

            /* è¡¨å•æ ·å¼ - ä»è®¾å¤‡ç®¡ç†é¡µé¢å¤åˆ¶ */
            .form-input,
            .form-select,
            .form-textarea {
                padding: 12px 16px !important;
                border: 1px solid #F0F0F0 !important;
                border-radius: 8px !important;
                background: #FFFFFF !important;
                color: #000000 !important;
                font-size: 14px !important;
                transition: all 0.2s ease !important;
                outline: none !important;
                font-family: inherit !important;
                width: 100% !important;
                display: block !important;
            }

            .form-input:focus,
            .form-select:focus,
            .form-textarea:focus {
                border-color: #0066CC !important;
                box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1) !important;
                background: #FFFFFF !important;
            }

            .form-input:hover,
            .form-select:hover {
                border-color: #666666 !important;
            }

            /* è¡¨æ ¼å¤´éƒ¨æ ·å¼ - ä»è®¾å¤‡ç®¡ç†é¡µé¢å¤åˆ¶ */
            .table-header {
                background: var(--background);
                border: var(--border);
                border-bottom: none;
                border-radius: var(--radius) var(--radius) 0 0;
                padding: var(--space-4) var(--space-6);
                display: flex;
                justify-content: flex-start;
                align-items: center;
                margin-bottom: 0;
            }

            .table-container {
                background: transparent;
                border: none;
                border-radius: 0;
                overflow: hidden;
                margin-bottom: 0;
            }

            .table-container .table {
                border: none;
                margin: 0;
            }

            /* æŒ‰é’®æ ·å¼ - ä»è®¾å¤‡ç®¡ç†é¡µé¢å¤åˆ¶ */
            .btn {
                padding: var(--space-2) var(--space-4);
                border: none;
                border-radius: var(--radius);
                font-family: inherit;
                font-size: 14px;
                font-weight: var(--font-weight-medium);
                cursor: pointer;
                transition: all 0.15s ease;
                text-decoration: none;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: var(--space-2);
            }

            .btn-primary {
                background: var(--primary);
                color: white;
            }

            .btn-primary:hover {
                transform: translateY(-1px);
                box-shadow: var(--shadow-hover);
            }

            .btn-secondary {
                background: var(--surface);
                color: var(--text-primary);
                border: var(--border);
            }

            .btn-secondary:hover {
                background: var(--divider);
            }

            .btn-success {
                background: #000000 !important;
                color: white !important;
                border: 1px solid #000000 !important;
            }

            .btn-success:hover {
                background: #333333 !important;
                border-color: #333333 !important;
                transform: translateY(-1px) !important;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
            }

            .btn-warning {
                background: #ff9500;
                color: white;
                border: 1px solid #ff9500;
            }

            .btn-warning:hover {
                background: #e6850e;
                border-color: #e6850e;
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(255, 149, 0, 0.15);
            }

            .btn-sm {
                padding: 3px 6px;
                font-size: 10px;
                min-width: auto;
                white-space: nowrap;
                margin: 1px;
            }

            /* æ“ä½œæŒ‰é’®å®¹å™¨ - ç¡®ä¿æŒ‰é’®åœ¨ä¸€è¡Œæ˜¾ç¤º */
            .table td:last-child {
                white-space: nowrap;
                min-width: 200px;
                text-align: center;
            }

            /* é’ˆå¯¹æ“ä½œæŒ‰é’®çš„ç‰¹åˆ«æ ·å¼ */
            .table .btn-sm {
                display: inline-block;
                margin: 0 1px;
                padding: 2px 4px;
                font-size: 9px;
                line-height: 1.2;
            }

            /* å¡ç‰‡è§†å›¾ä¸­çš„æŒ‰é’®æ ·å¼ */
            .card .btn-sm {
                padding: 3px 6px;
                font-size: 10px;
                margin: 2px 1px;
                display: inline-block;
            }

            /* ç¡®ä¿æŒ‰é’®å®¹å™¨ä¸æ¢è¡Œ */
            .card .room-actions,
            .table .room-actions {
                white-space: nowrap;
                display: flex;
                gap: 2px;
                justify-content: center;
                flex-wrap: nowrap;
            }

            /* è¯­è¨€ä¸‹æ‹‰åˆ—è¡¨æ ·å¼ */
            .lang-dropdown {
                display: flex;
                align-items: center;
            }

            .lang-select {
                min-width: 100px;
                padding: var(--space-2) var(--space-3);
                border: var(--border);
                border-radius: var(--radius);
                background: var(--background);
                font-size: 14px;
                font-weight: var(--font-weight-medium);
                cursor: pointer;
                transition: all 0.15s ease;
            }

            .lang-select:focus {
                outline: 2px solid var(--accent);
                outline-offset: -2px;
            }

            .lang-select:hover {
                background: var(--surface);
            }

            .pagination {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: var(--space-4);
                padding: var(--space-6);
                background: var(--surface);
                border-top: var(--border);
            }

            .page-info {
                font-size: 14px;
                color: var(--text-secondary);
            }

            /* ç”¨æˆ·çŠ¶æ€æ ·å¼ */
            .device-status {
                padding: var(--space-1) var(--space-2);
                border-radius: calc(var(--radius) / 2);
                font-size: 12px;
                font-weight: var(--font-weight-medium);
                display: inline-block;
                min-width: 48px;
                text-align: center;
            }

            .status-online {
                background: rgba(40, 167, 69, 0.1);
                color: var(--success);
            }

            .status-offline {
                background: rgba(255, 149, 0, 0.1);
                color: var(--warning);
            }

            .status-pending {
                background: rgba(108, 117, 125, 0.1);
                color: #6c757d;
            }

            .btn-danger {
                background: #dc2626;
                color: white;
                border: 1px solid #dc2626;
            }

            .btn-danger:hover {
                background: #b91c1c;
                border-color: #b91c1c;
            }

            .btn-success {
                background: #16a34a;
                color: white;
                border: 1px solid #16a34a;
            }

            .btn-success:hover {
                background: #15803d;
                border-color: #15803d;
            }

            /* å³æŠ½å±‰æ¨¡æ€æ¡†æ ·å¼ - ä¸è®¾å¤‡ç®¡ç†é¡µé¢ä¿æŒä¸€è‡´ */
            .modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(8px);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: flex-end;
                padding: 0;
                overflow: hidden;
            }

            .modal[style*="flex"] {
                display: flex !important;
            }

            /* é˜²æ­¢èƒŒæ™¯é¡µé¢æ»šåŠ¨ */
            body.modal-open {
                overflow: hidden;
            }

            /* å¼ºåˆ¶æ˜¾ç¤ºçº¢è‰²æ˜Ÿå· */
            .required-asterisk {
                color: #ff0000 !important;
                font-weight: bold !important;
                margin-left: 3px !important;
                font-size: 14px !important;
                display: inline !important;
                visibility: visible !important;
                opacity: 1 !important;
            }

            /* è¦†ç›–æ‰€æœ‰å¯èƒ½çš„æ ·å¼ */
            label .required-asterisk,
            .form-group label .required-asterisk,
            .modal .required-asterisk,
            * .required-asterisk {
                color: #ff0000 !important;
                font-weight: bold !important;
                margin-left: 3px !important;
                font-size: 14px !important;
                display: inline !important;
                visibility: visible !important;
                opacity: 1 !important;
                text-decoration: none !important;
                background: none !important;
            }

            .modal-overlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.3);
                z-index: -1;
            }

            .modal-content {
                background: var(--background);
                border-radius: 0;
                box-shadow: -10px 0 30px rgba(0, 0, 0, 0.3);
                width: 500px;
                height: 100vh;
                overflow: hidden;
                position: relative;
                z-index: 1;
                animation: drawerSlideIn 0.3s ease-out;
                display: flex;
                flex-direction: column;
            }

            @keyframes drawerSlideIn {
                from {
                    opacity: 0;
                    transform: translateX(100%);
                }
                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }

            .modal-header {
                padding: 24px 32px;
                background: var(--background);
                color: var(--text-primary);
                border-radius: 0;
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: var(--border);
                flex-shrink: 0;
            }

            .modal-header h3 {
                margin: 0;
                font-size: 20px;
                font-weight: 600;
                color: var(--text-primary);
            }

            .modal-close {
                background: none;
                border: none;
                color: var(--text-secondary);
                font-size: 24px;
                font-weight: bold;
                cursor: pointer;
                padding: 8px;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s ease;
            }

            .modal-close:hover {
                background: var(--surface);
                color: var(--text-primary);
                transform: scale(1.1);
            }

            .modal-body {
                padding: 32px;
                flex: 1;
                overflow-y: auto;
            }

            .modal-footer {
                padding: 20px 32px;
                background: var(--surface);
                border-top: var(--border);
                display: flex;
                justify-content: flex-end;
                gap: 12px;
                border-radius: 0;
                flex-shrink: 0;
            }

            /* è¡¨å•æ ·å¼ */
            .user-form {
                display: flex;
                flex-direction: column;
                gap: 24px;
            }

            .form-section {
                background: var(--surface);
                border: var(--border);
                border-radius: var(--radius);
                padding: 24px;
                position: relative;
            }

            .section-title {
                margin: 0 0 20px 0;
                font-size: 16px;
                font-weight: 600;
                color: var(--text-primary);
                display: flex;
                align-items: center;
                gap: 8px;
                padding-bottom: 8px;
                border-bottom: 2px solid var(--primary);
            }

            .section-title::before {
                content: '';
                width: 4px;
                height: 16px;
                background: var(--primary);
                border-radius: 2px;
            }

            .form-row {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 20px;
                margin-bottom: 16px;
            }

            .form-row:last-child {
                margin-bottom: 0;
            }

            .form-group {
                display: flex;
                flex-direction: column;
                gap: 6px;
            }

            .form-group.full-width {
                grid-column: 1 / -1;
            }

            .form-group label {
                font-size: 14px;
                font-weight: 500;
                color: var(--text-primary);
                display: flex;
                align-items: center;
                gap: 4px;
            }

            .form-input,
            .form-select,
            .form-textarea {
                padding: 12px 16px;
                border: 2px solid var(--border-color);
                border-radius: var(--radius);
                background: var(--background);
                color: var(--text-primary);
                font-size: 14px;
                transition: all 0.2s ease;
                outline: none;
                font-family: inherit;
            }

            .form-input:focus,
            .form-select:focus,
            .form-textarea:focus {
                border-color: var(--primary);
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
                background: var(--background);
            }

            .form-input:hover,
            .form-select:hover {
                border-color: var(--accent);
            }

            .form-textarea {
                resize: vertical;
                min-height: 80px;
                font-family: inherit;
                line-height: 1.5;
            }

            .form-input::placeholder,
            .form-textarea::placeholder {
                color: var(--text-secondary);
                opacity: 0.7;
            }

            .form-hint {
                font-size: 12px;
                color: var(--text-secondary);
                margin-top: 4px;
                font-style: italic;
            }

            .form-input[required]:invalid {
                border-color: var(--error);
            }

            .form-input[required]:invalid:focus {
                box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
            }

            /* æŒ‰é’®æ ·å¼ - ä¸bills.htmlä¿æŒä¸€è‡´ */
            .btn {
                padding: var(--space-2) var(--space-4);
                border: none;
                border-radius: var(--radius);
                font-family: inherit;
                font-size: 14px;
                font-weight: var(--font-weight-medium);
                cursor: pointer;
                transition: all 0.15s ease;
                text-decoration: none;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: var(--space-2);
            }

            .btn-primary {
                background: var(--primary);
                color: white;
            }

            .btn-primary:hover {
                transform: translateY(-1px);
                box-shadow: var(--shadow-hover);
            }

            .btn-secondary {
                background: var(--surface);
                color: var(--text-primary);
                border: var(--border);
            }

            .btn-secondary:hover {
                background: var(--divider);
            }

            .actions {
                display: flex;
                gap: var(--space-2);
            }

            /* å“åº”å¼è®¾è®¡ */
            @media (max-width: 1200px) {
                .content-layout {
                    flex-direction: column;
                }

                .sidebar-container {
                    width: 100%;
                    max-height: 300px;
                    margin-bottom: var(--space-4);
                }

                .tree-children.expanded {
                    max-height: 200px;
                }
            }

            @media (max-width: 768px) {
                .content-layout {
                    padding: var(--space-8) var(--space-4);
                }

                .sidebar-container {
                    max-height: 250px;
                }

                .sidebar-header {
                    padding: var(--space-3) var(--space-4);
                }

                .tree-container {
                    padding: var(--space-3);
                }

                .search-section {
                    flex-direction: column;
                    align-items: stretch;
                }

                .search-controls {
                    flex-direction: column;
                }

                .search-controls .form-input {
                    min-width: auto;
                }

                .table-header {
                    flex-direction: column;
                    gap: var(--space-3);
                    align-items: stretch;
                }

                .modal {
                    padding: 10px;
                }

                .modal-content {
                    margin-top: 20px;
                    max-height: calc(100vh - 20px);
                }

                .modal-header,
                .modal-body,
                .modal-footer {
                    padding: 20px;
                }

                .form-row {
                    grid-template-columns: 1fr;
                    gap: 16px;
                }

                .form-section {
                    padding: 16px;
                }

                .nav-menu {
                    gap: 10px !important;
                }

                .tree-actions {
                    opacity: 1;
                }

                .btn-icon {
                    padding: 4px 6px;
                    font-size: 14px;
                }
            }

            /* åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†æ ·å¼ */
            #delete-confirm-modal,
            #delete-building-modal,
            #delete-floor-modal {
                justify-content: center !important;
                align-items: center !important;
            }

            .delete-confirm-modal {
                width: 450px !important;
                height: auto !important;
                max-width: 90vw;
                border-radius: var(--radius) !important;
                position: relative;
                margin: 0;
                transform: translateY(0);
            }

            .delete-warning-icon {
                font-size: 48px;
                text-align: center;
                margin-bottom: 16px;
            }

            .delete-warning-box {
                background: #fff5f5;
                border: 1px solid #fecaca;
                border-radius: 8px;
                padding: 16px;
                margin: 16px 0;
            }

            .delete-warning {
                color: #dc2626;
                font-size: 14px;
                margin: 8px 0;
                font-weight: 500;
            }

            .delete-warning-list {
                margin: 12px 0;
                padding-left: 0;
                list-style: none;
            }

            .delete-warning-list li {
                color: #7f1d1d;
                font-size: 14px;
                margin: 6px 0;
                padding-left: 8px;
            }

            .delete-confirm-modal .modal-body {
                text-align: center;
            }

            .delete-confirm-modal .modal-body p {
                font-size: 16px;
                font-weight: 500;
                color: var(--text-primary);
                margin-bottom: 12px;
            }

            /* è§†å›¾åˆ‡æ¢æ ‡ç­¾é¡µæ ·å¼ */
            .view-tabs {
                display: flex;
                justify-content: space-between;
                align-items: flex-end;
                margin-bottom: 0;
                border-bottom: 1px solid #e0e0e0;
                padding-bottom: 0;
                background: #f8f9fa;
                padding: 8px var(--space-6) 0 8px;
                border-radius: 8px 8px 0 0;
            }

            .tabs-left {
                display: flex;
                gap: 4px;
            }

            .tabs-right {
                display: flex;
                align-items: center;
                gap: 8px;
                padding-bottom: 8px;
                margin-right: 0;
            }

            .tabs-right .btn {
                margin-right: 0;
            }

            .tab-btn {
                padding: 12px 24px;
                border: none;
                background: transparent;
                color: #555;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.3s ease;
                border-radius: 8px 8px 0 0;
                position: relative;
                outline: none;
            }

            .tab-btn:hover {
                background: #f5f5f5;
                color: #222;
            }

            .tab-btn:focus {
                outline: 2px solid var(--primary-color);
                outline-offset: 2px;
            }

            .tab-btn.active {
                background: white;
                color: var(--primary-color);
                font-weight: 600;
                border: 1px solid #e0e0e0;
                border-bottom: 1px solid white;
                box-shadow: 0 -2px 4px rgba(0,0,0,0.05);
            }

            .tab-btn.active::after {
                content: '';
                position: absolute;
                bottom: -2px;
                left: 0;
                right: 0;
                height: 2px;
                background: var(--primary-color);
            }

            /* è§†å›¾å¸ƒå±€å®¹å™¨ */
            .views-layout {
                background: white;
                border: 1px solid #e0e0e0;
                border-top: none;
                border-radius: 0 0 8px 8px;
                padding: 20px;
                margin-bottom: 20px;
            }

            /* è§†å›¾å®¹å™¨æ ·å¼ */
            .view-container {
                width: 100%;
                background: transparent;
                border: none;
                border-radius: 0;
                padding: 0;
                margin-bottom: 0;
            }

            /* è§†å›¾å†…å®¹å¤´éƒ¨ */
            .view-content-header {
                display: none; /* éšè—ç©ºçš„å¤´éƒ¨ */
            }

            /* ä½ç½®é€‰æ‹©å™¨æ ·å¼ */
            .location-selector {
                display: flex;
                gap: 8px;
                align-items: center;
            }

            .location-selector select {
                flex: 1;
            }


            /* å¡ç‰‡ç½‘æ ¼æ ·å¼ */
            .cards-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
                gap: 20px;
                padding: 0;
            }

            .room-card {
                background: white;
                border: 1px solid #e0e0e0;
                border-radius: 12px;
                overflow: hidden;
                transition: all 0.3s ease;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                cursor: default;
            }

            .room-card:hover {
                transform: translateY(-4px);
                box-shadow: 0 8px 25px rgba(0,0,0,0.15);
                border-color: var(--primary-color);
            }

            .room-card:focus-within {
                outline: 2px solid var(--primary-color);
                outline-offset: 2px;
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(0,0,0,0.12);
            }


            .card-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 16px 20px;
                background: linear-gradient(135deg, #f8f9fa, #e9ecef);
                border-bottom: 1px solid #e0e0e0;
            }

            .room-number {
                font-size: 18px;
                font-weight: 700;
                color: #111;
                margin: 0;
            }

            .status-badge {
                padding: 4px 12px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 500;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .status-badge.success {
                background: #10b981;
                color: white;
                border: 1px solid #059669;
                font-weight: 600;
            }

            .status-badge.warning {
                background: #f59e0b;
                color: white;
                border: 1px solid #d97706;
                font-weight: 600;
            }

            /* ç§Ÿæˆ·æœç´¢æ ·å¼ */
            .tenant-select-wrapper {
                position: relative;
            }

            .search-results {
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: white;
                border: 1px solid #ddd;
                border-top: none;
                border-radius: 0 0 6px 6px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                max-height: 200px;
                overflow-y: auto;
                z-index: 1000;
                display: none;
            }

            .search-result-item {
                padding: 12px 16px;
                cursor: pointer;
                border-bottom: 1px solid #f0f0f0;
                transition: background-color 0.2s;
            }

            .search-result-item:hover {
                background-color: #f5f5f5;
            }

            .search-result-item:last-child {
                border-bottom: none;
            }

            .search-result-item.selected {
                background-color: #e3f2fd;
                color: #1976d2;
            }

            .tenant-name {
                font-weight: 500;
                color: #333;
            }

            .tenant-phone {
                font-size: 12px;
                color: #666;
                margin-top: 2px;
            }


            .card-body {
                padding: 20px;
            }

            .card-info {
                margin-bottom: 16px;
            }

            .card-info p {
                margin: 8px 0;
                font-size: 14px;
                color: #333;
                line-height: 1.5;
            }

            .card-info strong {
                color: #111;
                font-weight: 600;
            }

            .card-actions {
                display: flex;
                gap: 8px;
                justify-content: flex-end;
            }

            .card-actions .btn {
                font-size: 12px;
                padding: 6px 12px;
                font-weight: 600;
                border-radius: 6px;
                transition: all 0.2s ease;
            }

            .card-actions .btn:focus {
                outline: 2px solid var(--primary-color);
                outline-offset: 2px;
            }

            .no-data {
                grid-column: 1 / -1;
                text-align: center;
                padding: 60px 20px;
                color: #666;
                font-size: 16px;
                font-style: italic;
                background: #f9f9f9;
                border-radius: 12px;
                border: 2px dashed #ddd;
            }

            /* å“åº”å¼è®¾è®¡ */
            @media (max-width: 768px) {
                .cards-grid {
                    grid-template-columns: 1fr;
                }

                .view-tabs {
                    flex-direction: column;
                    gap: 8px;
                    padding: 8px;
                }

                .tabs-left {
                    order: 1;
                }

                .tabs-right {
                    order: 2;
                    justify-content: flex-start;
                    padding-bottom: 0;
                }

                .tab-btn {
                    border-radius: 8px;
                    margin-bottom: 4px;
                }

                .tab-btn.active::after {
                    display: none;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
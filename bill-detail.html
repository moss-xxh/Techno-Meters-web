<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-zh="è´¦å•è¯¦æƒ…" data-en="Bill Details">è´¦å•è¯¦æƒ…</title>
    <link rel="stylesheet" href="assets/css/common.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-brand">
                <h1 data-zh="èƒ½æºç®¡ç†ç³»ç»Ÿ" data-en="Energy Management System">èƒ½æºç®¡ç†ç³»ç»Ÿ</h1>
            </div>
            <div class="nav-menu">
                <a href="dashboard.html" class="nav-link" data-zh="ä»ªè¡¨æ¿" data-en="Dashboard">ä»ªè¡¨æ¿</a>
                <a href="users.html" class="nav-link" data-zh="ç”¨æˆ·ç®¡ç†" data-en="User Management">ç”¨æˆ·ç®¡ç†</a>
                <a href="bills.html" class="nav-link" data-zh="è´¦å•ç®¡ç†" data-en="Bill Management">è´¦å•ç®¡ç†</a>
                <a href="reports.html" class="nav-link" data-zh="æŠ¥è¡¨åˆ†æ" data-en="Reports">æŠ¥è¡¨åˆ†æ</a>
                <a href="settings.html" class="nav-link" data-zh="ç³»ç»Ÿè®¾ç½®" data-en="Settings">ç³»ç»Ÿè®¾ç½®</a>
            </div>
            <div class="nav-actions">
                <div class="lang-dropdown">
                    <select id="language-select" class="form-select lang-select">
                        <option value="zh" data-zh="ä¸­æ–‡" data-en="Chinese">ä¸­æ–‡</option>
                        <option value="en" data-zh="English" data-en="English">English</option>
                    </select>
                </div>
                <div class="user-menu">
                    <div class="user-avatar">ç®¡</div>
                    <span data-zh="ç®¡ç†å‘˜" data-en="Admin">ç®¡ç†å‘˜</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <main class="main-content">
        <div class="container">
            <!-- é¡µé¢æ ‡é¢˜å’Œè¿”å›æŒ‰é’® -->
            <div class="page-header">
                <div class="header-left">
                    <button class="btn btn-secondary" onclick="goBack()">
                        <span>â†</span>
                        <span data-zh="è¿”å›" data-en="Back">è¿”å›</span>
                    </button>
                    <div class="header-text">
                        <div class="header-title-section">
                            <span id="detail-username" class="user-name-header">Priya Sharma</span>
                            <span id="header-business-type" class="business-type">å±…æ°‘</span>
                        </div>
                        <div class="header-info">
                            <span class="header-info-item">
                                <span class="info-label" data-zh="ç”µè¡¨å·" data-en="Meter No.">ç”µè¡¨å·</span>
                                <span id="header-electric-number" class="info-value">1111111001</span>
                            </span>
                            <span class="header-info-item">
                                <span class="info-label" data-zh="åœ°å€" data-en="Address">åœ°å€</span>
                                <span id="header-address" class="info-value">æ³°ç±³å°”çº³å¾·</span>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="downloadBill()">
                        <span>ğŸ“„</span>
                        <span data-zh="ä¸‹è½½è´¦å•" data-en="Download Bill">ä¸‹è½½è´¦å•</span>
                    </button>
                </div>
            </div>

            <!-- ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ -->
            <div class="bill-summary">
                <div class="info-horizontal">
                    <span class="info-pair">
                        <span class="label" data-zh="è´¦æœŸ" data-en="Billing Period">è´¦æœŸ</span>
                        <span id="detail-period" class="value">2025å¹´9æœˆ</span>
                    </span>
                    <span class="info-pair">
                        <span class="label" data-zh="è®¡è´¹æ–¹å¼" data-en="Billing Method">è®¡è´¹æ–¹å¼</span>
                        <span id="detail-billing-method" class="value">é˜¶æ¢¯ç”µè´¹</span>
                    </span>
                    <span class="info-pair">
                        <span class="label" data-zh="ç”¨ç”µé‡" data-en="Usage">ç”¨ç”µé‡</span>
                        <div class="usage-detail">
                            <span id="detail-usage" class="value">387 kWh</span>
                            <span id="reading-detail" class="reading-info">ï¼ˆ54,801 - 55,188ï¼‰</span>
                        </div>
                    </span>
                    <span class="info-pair">
                        <span class="label" data-zh="è´¹ç”¨" data-en="Cost">è´¹ç”¨</span>
                        <span id="detail-amount" class="value amount">â‚¹2546</span>
                    </span>
                </div>
            </div>


            <!-- è¯¦ç»†ä¿¡æ¯å±•ç¤ºåŒºåŸŸ -->
            <div class="details-grid">
                <!-- è´¦å•ç®¡ç†è¡¨æ ¼ -->
                <div class="cost-breakdown-section">
                    <div class="section-header">
                        <h4 data-zh="è´¦å•ç®¡ç†" data-en="Bill Management">è´¦å•ç®¡ç†</h4>
                    </div>
                    <div class="cost-table-container">
                        <div class="cost-table">
                            <div class="cost-header">
                                <span data-zh="é¡¹ç›®" data-en="Item">é¡¹ç›®</span>
                                <span data-zh="é‡‘é¢ï¼ˆå¢æ¯”ï¼‰" data-en="Amount (â‚¹)">é‡‘é¢ï¼ˆå¢æ¯”ï¼‰</span>
                                <span data-zh="è¯´æ˜" data-en="Description">è¯´æ˜</span>
                            </div>
                            <div id="cost-body" class="cost-body">
                                <!-- è´¹ç”¨æ˜ç»†æ•°æ®ç”±JavaScriptç”Ÿæˆ -->
                            </div>
                            <div class="cost-total">
                                <span class="final-label" data-zh="æ€»è´¹ç”¨" data-en="Total Cost">æ€»è´¹ç”¨</span>
                                <span class="final-amount" id="final-total-amount">â‚¹1,107</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- é˜¶æ¢¯æ”¶è´¹è¡¨æ ¼/åˆ†æ—¶ç”µä»·è¡¨æ ¼ -->
                <div class="pricing-section">
                    <div class="section-header">
                        <h4 id="pricing-section-title" data-zh="ç”µé‡è´¹æ˜ç»†" data-en="Energy Charges Details">ç”µé‡è´¹æ˜ç»†</h4>
                        <button id="view-details-btn" class="btn btn-primary" style="display: none;" onclick="showDetailedView()">
                            <span data-zh="æŸ¥çœ‹æ˜ç»†" data-en="View Details">æŸ¥çœ‹æ˜ç»†</span>
                        </button>
                    </div>
                    <div class="pricing-table-container">
                        <!-- é˜¶æ¢¯ç”µè´¹è¡¨æ ¼ -->
                        <div id="tiered-pricing-table" class="pricing-table">
                            <div class="pricing-header">
                                <span data-zh="é˜¶æ¢¯" data-en="Tier">é˜¶æ¢¯</span>
                                <span data-zh="èŒƒå›´(kWh)" data-en="Range(kWh)">èŒƒå›´(kWh)</span>
                                <span data-zh="ç”µä»·(â‚¹/kWh)" data-en="Rate(â‚¹/kWh)">ç”µä»·(â‚¹/kWh)</span>
                                <span data-zh="ç”¨é‡(kWh)" data-en="Usage(kWh)">ç”¨é‡(kWh)</span>
                                <span data-zh="é‡‘é¢(â‚¹)" data-en="Amount(â‚¹)">é‡‘é¢(â‚¹)</span>
                            </div>
                            <div id="pricing-body" class="pricing-body">
                                <!-- é˜¶æ¢¯æ•°æ®ç”±JavaScriptç”Ÿæˆ -->
                            </div>
                            <div class="pricing-total">
                                <span class="total-label" data-zh="å°è®¡" data-en="Subtotal">å°è®¡</span>
                                <span class="total-amount" id="total-tier-amount">â‚¹900.00</span>
                            </div>
                        </div>

                        <!-- åˆ†æ—¶ç”µä»·æ±‡æ€»è¡¨æ ¼ -->
                        <div id="time-of-use-pricing-table" class="pricing-table" style="display: none;">
                            <div class="time-pricing-summary">
                                <div class="summary-header">
                                    <span data-zh="æ—¶æ®µ" data-en="Period">æ—¶æ®µ</span>
                                    <span data-zh="ç”¨ç”µé‡(kWh)" data-en="Usage(kWh)">ç”¨ç”µé‡(kWh)</span>
                                    <span data-zh="ç”µä»·(â‚¹/kWh)" data-en="Rate(â‚¹/kWh)">ç”µä»·(â‚¹/kWh)</span>
                                    <span data-zh="é‡‘é¢(â‚¹)" data-en="Amount(â‚¹)">é‡‘é¢(â‚¹)</span>
                                </div>
                                <div id="time-pricing-body" class="time-pricing-body">
                                    <!-- åˆ†æ—¶ç”µä»·æ•°æ®ç”±JavaScriptç”Ÿæˆ -->
                                </div>
                                <div class="pricing-total">
                                    <span class="total-label" data-zh="å°è®¡" data-en="Subtotal">å°è®¡</span>
                                    <span class="total-amount" id="total-time-amount">â‚¹1,580.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


    <script src="assets/js/common.js"></script>
    <script>
        // åœ°åŒºæ•°æ®
        const regionsData = {
            'tamil-nadu': { name: 'æ³°ç±³å°”çº³å¾·', nameEn: 'Tamil Nadu' },
            'karnataka': { name: 'å¡çº³å¡”å…‹', nameEn: 'Karnataka' },
            'andhra-pradesh': { name: 'å®‰å¾—æ‹‰é‚¦', nameEn: 'Andhra Pradesh' },
            'kerala': { name: 'å–€æ‹‰æ‹‰', nameEn: 'Kerala' }
        };

        // è·å–URLå‚æ•°
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // ç”Ÿæˆè´¦å•è¯¦æƒ…æ•°æ®
        function generateBillDetails(bill, month) {
            if (bill.billingMethod === 'tiered') {
                // æ˜¾ç¤ºé˜¶æ¢¯ç”µè´¹æ˜ç»†
                showTieredPricing(bill);
                generateTieredPricing(bill);
            } else if (bill.billingMethod === 'time-of-use') {
                // æ˜¾ç¤ºåˆ†æ—¶ç”µä»·æ˜ç»†
                showTimeOfUsePricing(bill, month);
                generateTimeOfUsePricing(bill, month);
            }
        }

        // æ˜¾ç¤ºé˜¶æ¢¯ç”µè´¹è¡¨æ ¼
        function showTieredPricing(bill) {
            document.getElementById('pricing-section-title').setAttribute('data-zh', 'ç”µé‡è´¹æ˜ç»†');
            document.getElementById('pricing-section-title').setAttribute('data-en', 'Energy Charges Details');
            document.getElementById('pricing-section-title').textContent = currentLanguage === 'zh' ? 'ç”µé‡è´¹æ˜ç»†' : 'Energy Charges Details';

            document.getElementById('tiered-pricing-table').style.display = 'block';
            document.getElementById('time-of-use-pricing-table').style.display = 'none';

            // æ˜¾ç¤ºé˜¶æ¢¯ç”µä»·çš„æŸ¥çœ‹æ˜ç»†æŒ‰é’®
            document.getElementById('view-details-btn').style.display = 'inline-flex';
            // ä¿®æ”¹æŒ‰é’®ç‚¹å‡»äº‹ä»¶ä¸ºé˜¶æ¢¯ç”µä»·ä¸“ç”¨
            document.getElementById('view-details-btn').setAttribute('onclick', 'showTieredDetailedView()');

            // æ›´æ–°æ¯æ—¥ç”¨ç”µé‡è¡¨æ ¼æ ‡é¢˜ä¸ºé˜¶æ¢¯ç”µä»·ç‰ˆæœ¬
            updateDailyTableForTiered();
        }

        // æ˜¾ç¤ºåˆ†æ—¶ç”µä»·è¡¨æ ¼
        function showTimeOfUsePricing(bill, month) {
            document.getElementById('pricing-section-title').setAttribute('data-zh', 'åŸºç¡€ç”µè´¹â€”â€”2025/09');
            document.getElementById('pricing-section-title').setAttribute('data-en', 'Time-of-Use Pricing Details');
            document.getElementById('pricing-section-title').textContent = currentLanguage === 'zh' ? 'åŸºç¡€ç”µè´¹â€”â€”2025/09' : 'Basic Electricity Feeâ€”September 2025';

            document.getElementById('tiered-pricing-table').style.display = 'none';
            document.getElementById('time-of-use-pricing-table').style.display = 'block';

            // æ˜¾ç¤ºæŸ¥çœ‹æ˜ç»†æŒ‰é’®
            document.getElementById('view-details-btn').style.display = 'inline-flex';
            // è®¾ç½®ä¸ºåˆ†æ—¶ç”µä»·ä¸“ç”¨ç‚¹å‡»äº‹ä»¶
            document.getElementById('view-details-btn').setAttribute('onclick', 'showDetailedView()');

            // æ›´æ–°æ¯æ—¥ç”¨ç”µé‡è¡¨æ ¼æ ‡é¢˜ï¼Œæ˜¾ç¤ºåˆ†æ—¶ç”µä»·ç‰¹æœ‰çš„åˆ—
            updateDailyTableForTimeOfUse();
        }

        // æ›´æ–°è¡¨æ ¼ä¸ºåˆ†æ—¶ç”µä»·ç‰ˆæœ¬
        function updateDailyTableForTimeOfUse() {
            // ç§»é™¤å‡½æ•°å†…å®¹ï¼Œå› ä¸ºdaily-usage-moduleå·²è¢«åˆ é™¤
        }

        // æ›´æ–°è¡¨æ ¼ä¸ºé˜¶æ¢¯ç”µä»·ç‰ˆæœ¬
        function updateDailyTableForTiered() {
            // ç§»é™¤å‡½æ•°å†…å®¹ï¼Œå› ä¸ºdaily-usage-moduleå·²è¢«åˆ é™¤
        }

        // è·å–æœ¬åœ°åŒ–çš„æœˆä»½åç§°
        function getMonthNames() {
            return currentLanguage === 'zh' ?
                ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'] :
                ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        }

        function generateTieredPricing(bill) {
            const pricingBody = document.getElementById('pricing-body');
            const totalUsage = bill.usage;

            // å°åº¦å±…æ°‘é˜¶æ¢¯ç”µä»·ç»“æ„
            const tiers = [
                {
                    name: currentLanguage === 'zh' ? 'ç¬¬ä¸€é˜¶æ¢¯' : 'Tier 1',
                    range: '0-100',
                    rate: 3.35,
                    capacity: 100
                },
                {
                    name: currentLanguage === 'zh' ? 'ç¬¬äºŒé˜¶æ¢¯' : 'Tier 2',
                    range: '101-200',
                    rate: 4.60,
                    capacity: 100
                },
                {
                    name: currentLanguage === 'zh' ? 'ç¬¬ä¸‰é˜¶æ¢¯' : 'Tier 3',
                    range: '201-400',
                    rate: 6.85,
                    capacity: 200
                },
                {
                    name: currentLanguage === 'zh' ? 'ç¬¬å››é˜¶æ¢¯' : 'Tier 4',
                    range: '400+',
                    rate: 8.15,
                    capacity: Infinity
                }
            ];

            let remainingUsage = totalUsage;
            let totalAmount = 0;
            const tierDetails = [];

            tiers.forEach((tier, index) => {
                if (remainingUsage <= 0) {
                    tierDetails.push({
                        ...tier,
                        usage: 0,
                        amount: 0
                    });
                    return;
                }

                // è®¡ç®—æœ¬é˜¶æ¢¯çš„ä½¿ç”¨é‡
                let tierUsage = 0;
                if (tier.capacity === Infinity) {
                    // æœ€é«˜é˜¶æ¢¯ï¼Œä½¿ç”¨æ‰€æœ‰å‰©ä½™ç”¨é‡
                    tierUsage = remainingUsage;
                } else {
                    // ä½¿ç”¨é¢„å®šä¹‰çš„å®¹é‡
                    tierUsage = Math.min(remainingUsage, tier.capacity);
                }

                const tierAmount = tierUsage * tier.rate;

                tierDetails.push({
                    ...tier,
                    usage: Math.round(tierUsage),
                    amount: tierAmount
                });

                totalAmount += tierAmount;
                remainingUsage -= tierUsage;
            });

            // æ¸²æŸ“é˜¶æ¢¯è¡¨æ ¼
            pricingBody.innerHTML = tierDetails.map(tier => `
                <div class="pricing-row ${tier.usage > 0 ? 'used' : 'unused'}">
                    <span class="tier-name">${tier.name}</span>
                    <span class="tier-range">${tier.range}</span>
                    <span class="tier-rate">â‚¹${tier.rate.toFixed(2)}</span>
                    <span class="tier-usage">${tier.usage}</span>
                    <span class="tier-amount">â‚¹${tier.amount.toFixed(2)}</span>
                </div>
            `).join('');

            // æ›´æ–°é˜¶æ¢¯ç”µè´¹å°è®¡
            document.getElementById('total-tier-amount').textContent = `â‚¹${totalAmount.toFixed(2)}`;

            // ç”Ÿæˆè´¹ç”¨æ˜ç»†
            console.log('Calling generateCostBreakdown with:', totalAmount, totalUsage);
            generateCostBreakdown(totalAmount, totalUsage);
        }

        function generateCostBreakdown(electricityFee, usage) {
            console.log('generateCostBreakdown called with:', electricityFee, usage);
            const costBody = document.getElementById('cost-body');
            console.log('costBody element:', costBody);

            // è®¡ç®—å„é¡¹è´¹ç”¨
            const energyCharges = electricityFee; // ç”µé‡è´¹ï¼ˆåŸºäºå®é™…ç”¨ç”µé‡è®¡ç®—ï¼‰
            const fixedCharges = 150; // å›ºå®šè´¹ï¼ˆæ¯æœˆå›ºå®šæ”¶è´¹ï¼‰
            const fpppaCharges = energyCharges * 0.08; // ç‡ƒæ–™è°ƒæ•´è´¹ï¼ˆ8% Ã— ç”µé‡è´¹ï¼‰
            const governmentDuty = (energyCharges + fixedCharges + fpppaCharges) * 0.12; // æ”¿åºœç¨ï¼ˆ12% Ã— å°è®¡ï¼‰
            const totalCost = energyCharges + fixedCharges + fpppaCharges + governmentDuty;

            const costItems = [
                {
                    item: currentLanguage === 'zh' ? 'ç”µé‡è´¹' : 'Energy charges',
                    amount: energyCharges,
                    description: currentLanguage === 'zh' ? `${usage} kWh Ã— ç”µä»·` : `${usage} kWh Ã— tariff rate`
                },
                {
                    item: currentLanguage === 'zh' ? 'å›ºå®šè´¹' : 'Fixed charges',
                    amount: fixedCharges,
                    description: currentLanguage === 'zh' ? `æ¯æœˆå›ºå®šæœåŠ¡è´¹` : `Monthly fixed service charge`
                },
                {
                    item: currentLanguage === 'zh' ? 'ç‡ƒæ–™è°ƒæ•´è´¹' : 'FPPPA charges',
                    amount: fpppaCharges,
                    description: currentLanguage === 'zh' ? `8% Ã— ç”µé‡è´¹` : `8% Ã— energy charges`
                },
                {
                    item: currentLanguage === 'zh' ? 'æ”¿åºœç¨' : 'Government duty',
                    amount: governmentDuty,
                    description: currentLanguage === 'zh' ? `12% Ã— (ç”µé‡è´¹ + å›ºå®šè´¹ + ç‡ƒæ–™è´¹)` : `12% Ã— (energy + fixed + FPPPA)`
                }
            ];

            // æ¸²æŸ“è´¹ç”¨æ˜ç»†è¡¨æ ¼
            console.log('Rendering cost items:', costItems);
            costBody.innerHTML = costItems.map(item => `
                <div class="cost-row">
                    <span class="cost-item">${item.item}</span>
                    <span class="cost-amount">â‚¹${item.amount.toFixed(0)}</span>
                    <span class="cost-desc">${item.description}</span>
                </div>
            `).join('');

            // æ›´æ–°æ€»è´¹ç”¨
            document.getElementById('final-total-amount').textContent = `â‚¹${totalCost.toFixed(0)}`;

            // åŒæ—¶æ›´æ–°é¡µé¢é¡¶éƒ¨çš„æ€»é‡‘é¢æ˜¾ç¤º
            document.getElementById('detail-amount').textContent = `â‚¹${totalCost.toFixed(0)}`;
        }

        // ç”Ÿæˆåˆ†æ—¶ç”µä»·æ˜ç»†
        function generateTimeOfUsePricing(bill, month) {
            const timePricingBody = document.getElementById('time-pricing-body');
            const totalUsage = bill.usage;

            // åˆ†æ—¶ç”µä»·ç»“æ„ (åŸºç¡€ç”µä»·4.5â‚¹/kWh)
            const baseRate = 4.5;
            const timeRates = {
                peak: baseRate * 1.2,      // é«˜å³°æ—¶æ®µ: +20%
                standard: baseRate,        // å¹³å³°æ—¶æ®µ: åŸºç¡€ç”µä»·
                valley: baseRate * 0.8     // ä½è°·æ—¶æ®µ: -20%
            };

            // æ¨¡æ‹Ÿå„æ—¶æ®µç”¨ç”µé‡åˆ†é… (æ€»è®¡åº”ç­‰äºtotalUsage)
            const peakUsage = Math.round(totalUsage * 0.25);      // 25% é«˜å³°æ—¶æ®µ
            const standardUsage = Math.round(totalUsage * 0.45);  // 45% å¹³å³°æ—¶æ®µ
            const valleyUsage = totalUsage - peakUsage - standardUsage; // 30% ä½è°·æ—¶æ®µ

            // è®¡ç®—å„æ—¶æ®µè´¹ç”¨
            const peakCost = peakUsage * timeRates.peak;
            const standardCost = standardUsage * timeRates.standard;
            const valleyCost = valleyUsage * timeRates.valley;
            const totalElectricityFee = peakCost + standardCost + valleyCost;

            // æ¸²æŸ“åˆ†æ—¶ç”µä»·æ±‡æ€»è¡¨æ ¼
            timePricingBody.innerHTML = `
                <div class="time-pricing-row peak">
                    <span class="period-name">
                        <div class="period-title">${currentLanguage === 'zh' ? 'é«˜å³°æ—¶æ®µ' : 'Peak'}</div>
                        <div class="period-time">${currentLanguage === 'zh' ? '(12:00-18:00)' : '(12:00-18:00)'}</div>
                    </span>
                    <span class="period-usage">${peakUsage}</span>
                    <span class="period-rate">â‚¹${timeRates.peak.toFixed(2)}</span>
                    <span class="period-amount">â‚¹${peakCost.toFixed(2)}</span>
                </div>
                <div class="time-pricing-row standard">
                    <span class="period-name">
                        <div class="period-title">${currentLanguage === 'zh' ? 'å¹³å³°æ—¶æ®µ' : 'Standard'}</div>
                        <div class="period-time">${currentLanguage === 'zh' ? '(08:00-12:00 & 18:00-23:00)' : '(08:00-12:00 & 18:00-23:00)'}</div>
                    </span>
                    <span class="period-usage">${standardUsage}</span>
                    <span class="period-rate">â‚¹${timeRates.standard.toFixed(2)}</span>
                    <span class="period-amount">â‚¹${standardCost.toFixed(2)}</span>
                </div>
                <div class="time-pricing-row valley">
                    <span class="period-name">
                        <div class="period-title">${currentLanguage === 'zh' ? 'ä½è°·æ—¶æ®µ' : 'Valley'}</div>
                        <div class="period-time">${currentLanguage === 'zh' ? '(23:00-08:00)' : '(23:00-08:00)'}</div>
                    </span>
                    <span class="period-usage">${valleyUsage}</span>
                    <span class="period-rate">â‚¹${timeRates.valley.toFixed(2)}</span>
                    <span class="period-amount">â‚¹${valleyCost.toFixed(2)}</span>
                </div>
            `;

            // æ›´æ–°åˆ†æ—¶ç”µä»·å°è®¡
            document.getElementById('total-time-amount').textContent = `â‚¹${totalElectricityFee.toFixed(2)}`;

            // ç”Ÿæˆè´¹ç”¨æ˜ç»†
            generateCostBreakdown(totalElectricityFee, totalUsage);

            // ç”Ÿæˆåˆ†æ—¶ç”µä»·çš„æ¯æ—¥ç”¨ç”µé‡æ•°æ®
            generateTimeOfUseDailyData(bill, month, timeRates);
        }

        // ç”Ÿæˆåˆ†æ—¶ç”µä»·çš„æ¯æ—¥ç”¨ç”µé‡æ•°æ®
        function generateTimeOfUseDailyData(bill, month, timeRates) {
            const daysInMonth = new Date(2025, parseInt(month.split('-')[1]), 0).getDate();
            const dailyData = [];
            const totalUsage = bill.usage;
            const dailyUsage = totalUsage / daysInMonth;

            for (let day = 1; day <= daysInMonth; day++) {
                const dayUsage = Math.round((dailyUsage * (0.8 + Math.random() * 0.4)) * 10) / 10;

                // åˆ†é…å„æ—¶æ®µç”¨ç”µé‡
                const peakUsage = Math.round(dayUsage * (0.20 + Math.random() * 0.10) * 10) / 10;    // 20-30%
                const standardUsage = Math.round(dayUsage * (0.40 + Math.random() * 0.15) * 10) / 10; // 40-55%
                const valleyUsage = Math.round((dayUsage - peakUsage - standardUsage) * 10) / 10;     // å‰©ä½™

                // è®¡ç®—è´¹ç”¨
                const peakCost = peakUsage * timeRates.peak;
                const standardCost = standardUsage * timeRates.standard;
                const valleyCost = valleyUsage * timeRates.valley;
                const totalCost = peakCost + standardCost + valleyCost;

                dailyData.push({
                    date: `2025-${month.split('-')[1].padStart(2, '0')}-${day.toString().padStart(2, '0')}`,
                    day: day,
                    usage: dayUsage,
                    peakUsage: peakUsage,
                    standardUsage: standardUsage,
                    valleyUsage: valleyUsage,
                    cost: Math.round(totalCost)
                });
            }

            // æ¸²æŸ“åˆ†æ—¶ç”µä»·çš„è¡¨æ ¼è§†å›¾
            renderTimeOfUseTableView(dailyData);
            // æ›´æ–°æ—¥å†å’Œå›¾è¡¨è§†å›¾ä¹Ÿæ˜¾ç¤ºåˆ†æ—¶ç”µä»·æ•°æ®
            renderCalendarView(dailyData, month);
            renderChartView(dailyData);
        }

        // æ¸²æŸ“åˆ†æ—¶ç”µä»·çš„è¡¨æ ¼è§†å›¾
        function renderTimeOfUseTableView(dailyData) {
            const tableBody = document.getElementById('daily-table-body');

            // å¦‚æœå…ƒç´ ä¸å­˜åœ¨ï¼ˆå› ä¸ºdaily-usage-moduleå·²è¢«åˆ é™¤ï¼‰ï¼Œç›´æ¥è¿”å›
            if (!tableBody) {
                console.log('daily-table-body not found, skipping renderTimeOfUseTableView');
                return;
            }

            // å…ˆæ¸…ç©ºè¡¨æ ¼å†…å®¹
            tableBody.innerHTML = '';

            // ä¸ºæ¯ä¸€å¤©åˆ›å»ºè¡Œ
            dailyData.forEach(day => {
                // åˆ›å»ºä¸»è¡Œ
                const mainRow = document.createElement('div');
                mainRow.className = 'daily-table-row time-of-use';
                mainRow.style.cursor = 'pointer';
                mainRow.innerHTML = `
                    <span class="date-cell">${currentLanguage === 'zh' ? `${day.day}æ—¥` : day.day}</span>
                    <span class="usage-cell">${day.usage}</span>
                    <span class="cost-cell">â‚¹${day.cost}</span>
                    <span class="expand-icon" id="expand-icon-${day.day}">â–¼</span>
                `;

                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                mainRow.addEventListener('click', () => toggleDayHourlyDetails(day.day));

                // åˆ›å»ºè¯¦æƒ…è¡Œ
                const detailsRow = document.createElement('div');
                detailsRow.className = 'hourly-details-row';
                detailsRow.id = `hourly-details-row-${day.day}`;
                detailsRow.style.display = 'none';
                detailsRow.innerHTML = `
                    <div class="hourly-details-content">
                        <div class="hourly-grid" id="hourly-grid-${day.day}">
                            <!-- æ¯å°æ—¶æ•°æ®ç”±JavaScriptç”Ÿæˆ -->
                        </div>
                    </div>
                `;

                // æ·»åŠ åˆ°è¡¨æ ¼
                tableBody.appendChild(mainRow);
                tableBody.appendChild(detailsRow);
            });
        }

        // åˆ‡æ¢æ—¥æœŸæ¯å°æ—¶è¯¦æƒ…æ˜¾ç¤ºï¼ˆè¡¨æ ¼è§†å›¾ï¼‰
        function toggleDayHourlyDetails(day) {
            const detailsRow = document.getElementById(`hourly-details-row-${day}`);
            const expandIcon = document.getElementById(`expand-icon-${day}`);

            if (detailsRow.style.display === 'none') {
                // å…³é—­å…¶ä»–å·²æ‰“å¼€çš„è¯¦æƒ…
                document.querySelectorAll('.hourly-details-row').forEach(row => {
                    row.style.display = 'none';
                });
                document.querySelectorAll('.expand-icon').forEach(icon => {
                    icon.textContent = 'â–¼';
                    icon.style.transform = 'rotate(0deg)';
                });

                // æ‰“å¼€å½“å‰è¯¦æƒ…
                detailsRow.style.display = 'block';
                expandIcon.textContent = 'â–²';
                expandIcon.style.transform = 'rotate(180deg)';

                // ç”Ÿæˆæ¯å°æ—¶æ•°æ®
                generateTableHourlyData(day);
            } else {
                // å…³é—­å½“å‰è¯¦æƒ…
                detailsRow.style.display = 'none';
                expandIcon.textContent = 'â–¼';
                expandIcon.style.transform = 'rotate(0deg)';
            }
        }

        // ç”Ÿæˆè¡¨æ ¼ä¸­çš„æ¯å°æ—¶ç”¨ç”µæ•°æ®
        function generateTableHourlyData(day) {
            const hourlyGrid = document.getElementById(`hourly-grid-${day}`);

            // è·å–æ—¶æ®µç”µä»·
            const timeRates = {
                peak: 5.40,     // é«˜å³°æ—¶æ®µ 12:00-18:00
                standard: 4.50, // å¹³å³°æ—¶æ®µ 08:00-12:00 & 18:00-23:00
                valley: 3.60    // ä½è°·æ—¶æ®µ 23:00-08:00
            };

            // ç”Ÿæˆ24å°æ—¶æ•°æ®
            let hourlyHTML = '';
            for (let hour = 0; hour < 24; hour++) {
                // ç¡®å®šæ—¶æ®µç±»å‹
                let period, periodName, rate, periodClass;
                if (hour >= 12 && hour < 18) {
                    period = 'peak';
                    periodName = currentLanguage === 'zh' ? 'é«˜å³°' : 'Peak';
                    rate = timeRates.peak;
                    periodClass = 'peak';
                } else if ((hour >= 8 && hour < 12) || (hour >= 18 && hour < 23)) {
                    period = 'standard';
                    periodName = currentLanguage === 'zh' ? 'å¹³å³°' : 'Standard';
                    rate = timeRates.standard;
                    periodClass = 'standard';
                } else {
                    period = 'valley';
                    periodName = currentLanguage === 'zh' ? 'ä½è°·' : 'Valley';
                    rate = timeRates.valley;
                    periodClass = 'valley';
                }

                // æ¨¡æ‹Ÿæ¯å°æ—¶ç”¨ç”µé‡ (0.8-2.5kWhä¹‹é—´)
                const hourlyUsage = (Math.random() * 1.7 + 0.8).toFixed(1);

                hourlyHTML += `
                    <div class="hourly-item-small ${periodClass}">
                        <span class="hour-time-small">${hour.toString().padStart(2, '0')}:00</span>
                        <span class="hour-usage-small">${hourlyUsage}kWh</span>
                        <span class="hour-period-small">${periodName}</span>
                    </div>
                `;
            }

            hourlyGrid.innerHTML = hourlyHTML;
        }

        function goBack() {
            window.history.back();
        }

        function downloadBill() {
            EnergySystem.showNotification('ä¸‹è½½è´¦å•åŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }

        // å¯¼å‡ºæ•°æ®
        function exportUsageData() {
            // è·å–å½“å‰æ˜¾ç¤ºçš„æ•°æ®
            const currentDailyData = window.currentDailyData;
            if (!currentDailyData) {
                EnergySystem.showNotification('æš‚æ— æ•°æ®å¯å¯¼å‡º', 'warning');
                return;
            }

            // åˆ›å»ºCSVå†…å®¹
            let csvContent = '';

            // æ ¹æ®è®¡è´¹æ–¹å¼ç¡®å®šè¡¨å¤´
            const billElement = document.getElementById('detail-billing-method');
            const billingMethod = billElement ? billElement.textContent : '';

            if (billingMethod.includes('é˜¶æ¢¯')) {
                csvContent = currentLanguage === 'zh' ?
                    'æ—¥æœŸ,ç”¨ç”µé‡(kWh),æœ¬æœˆç´¯è®¡(kWh),æ‰€å±é˜¶æ®µ\n' :
                    'Date,Usage(kWh),Monthly Total(kWh),Tier\n';

                currentDailyData.forEach(day => {
                    csvContent += `${day.date},${day.usage},${day.cumulativeUsage},${day.tier}\n`;
                });
            } else {
                csvContent = currentLanguage === 'zh' ?
                    'æ—¥æœŸ,ç”¨ç”µé‡(kWh),é«˜å³°æ—¶æ®µ,å¹³å³°æ—¶æ®µ,ä½è°·æ—¶æ®µ\n' :
                    'Date,Usage(kWh),Peak,Standard,Valley\n';

                currentDailyData.forEach(day => {
                    csvContent += `${day.date},${day.usage},${day.peakUsage || '-'},${day.standardUsage || '-'},${day.valleyUsage || '-'}\n`;
                });
            }

            // ä¸‹è½½CSVæ–‡ä»¶
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `data_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            EnergySystem.showNotification('å¯¼å‡ºæˆåŠŸ', 'success');
        }

        function downloadBill() {
            EnergySystem.showNotification('è´¦å•ä¸‹è½½åŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }

        function payBill() {
            EnergySystem.showNotification('è·³è½¬åˆ°ä»˜è´¹é¡µé¢...', 'info');
        }

        // ç”Ÿæˆé˜¶æ¢¯ç”µä»·æ¯æ—¥ç”¨ç”µé‡æ•°æ®
        function generateDailyUsageData(month, totalUsage) {
            const daysInMonth = new Date(2025, parseInt(month.split('-')[1]), 0).getDate();
            const dailyData = [];

            // é˜¶æ¢¯ç”µä»·ç»“æ„
            const tiers = [
                { name: 'é˜¶æ¢¯1', nameWithRange: 'é˜¶æ¢¯1 (0-100kWh)', nameWithRangeEn: 'Tier 1 (0-100kWh)', min: 0, max: 100 },
                { name: 'é˜¶æ¢¯2', nameWithRange: 'é˜¶æ¢¯2 (101-200kWh)', nameWithRangeEn: 'Tier 2 (101-200kWh)', min: 101, max: 200 },
                { name: 'é˜¶æ¢¯3', nameWithRange: 'é˜¶æ¢¯3 (201-400kWh)', nameWithRangeEn: 'Tier 3 (201-400kWh)', min: 201, max: 400 },
                { name: 'é˜¶æ¢¯4', nameWithRange: 'é˜¶æ¢¯4 (400+kWh)', nameWithRangeEn: 'Tier 4 (400+kWh)', min: 401, max: Infinity }
            ];

            // ç”Ÿæˆæ¨¡æ‹Ÿçš„æ¯æ—¥ç”¨ç”µé‡æ•°æ®
            let cumulativeUsage = 0;
            const dailyUsage = totalUsage / daysInMonth;

            for (let day = 1; day <= daysInMonth; day++) {
                const baseUsage = dailyUsage * (0.8 + Math.random() * 0.4); // æ¯å¤©ç”¨ç”µé‡æœ‰å˜åŒ–
                const usage = Math.round(baseUsage * 10) / 10;
                cumulativeUsage += usage;

                // ç¡®å®šæ‰€å±é˜¶æ®µ
                let currentTier = currentLanguage === 'zh' ? 'é˜¶æ¢¯1 (0-100kWh)' : 'Tier 1 (0-100kWh)';
                for (let i = 0; i < tiers.length; i++) {
                    if (cumulativeUsage > tiers[i].min && (cumulativeUsage <= tiers[i].max || tiers[i].max === Infinity)) {
                        currentTier = currentLanguage === 'zh' ? tiers[i].nameWithRange : tiers[i].nameWithRangeEn;
                        break;
                    }
                }

                // æ¨¡æ‹Ÿå³°è°·ç”¨ç”µåˆ†é…ï¼ˆç”¨äºæ—¥å†å’Œå›¾è¡¨æ˜¾ç¤ºï¼‰
                const peakUsage = usage * (0.3 + Math.random() * 0.2); // 30-50%æ˜¯å³°æ—¶ç”¨ç”µ
                const offPeakUsage = usage - peakUsage;

                dailyData.push({
                    date: `2025-${month.split('-')[1].padStart(2, '0')}-${day.toString().padStart(2, '0')}`,
                    day: day,
                    usage: usage,
                    cumulativeUsage: Math.round(cumulativeUsage * 10) / 10,
                    tier: currentTier,
                    peakUsage: Math.round(peakUsage * 10) / 10,
                    offPeakUsage: Math.round(offPeakUsage * 10) / 10,
                    cost: Math.round(usage * 6.5) // ç®€åŒ–è´¹ç”¨è®¡ç®—
                });
            }

            return dailyData;
        }

        // æ¸²æŸ“é˜¶æ¢¯ç”µä»·è¡¨æ ¼è§†å›¾
        function renderTableView(dailyData) {
            const tableBody = document.getElementById('daily-table-body');

            // å¦‚æœå…ƒç´ ä¸å­˜åœ¨ï¼ˆå› ä¸ºdaily-usage-moduleå·²è¢«åˆ é™¤ï¼‰ï¼Œç›´æ¥è¿”å›
            if (!tableBody) {
                console.log('daily-table-body not found, skipping renderTableView');
                return;
            }

            // é˜¶æ¢¯ç”µä»·æ•°æ®æ ¼å¼
            if (dailyData.length > 0 && dailyData[0].cumulativeUsage !== undefined) {
                tableBody.innerHTML = dailyData.map(day => `
                    <div class="daily-table-row">
                        <span class="date-cell">${currentLanguage === 'zh' ? `${day.day}æ—¥` : day.day}</span>
                        <span class="usage-cell">${day.usage}</span>
                        <span class="cumulative-cell">${day.cumulativeUsage}</span>
                        <span class="tier-cell">${day.tier}</span>
                    </div>
                `).join('');
            } else {
                // å…¼å®¹åŸæœ‰æ ¼å¼
                tableBody.innerHTML = dailyData.map(day => `
                    <div class="daily-table-row">
                        <span class="date-cell">${currentLanguage === 'zh' ? `${day.day}æ—¥` : day.day}</span>
                        <span class="usage-cell">${day.usage}</span>
                        <span class="peak-cell">${day.peakUsage || '-'}</span>
                        <span class="offpeak-cell">${day.offPeakUsage || '-'}</span>
                        <span class="cost-cell">â‚¹${day.cost}</span>
                    </div>
                `).join('');
            }
        }

        // æ¸²æŸ“æ—¥å†è§†å›¾
        function renderCalendarView(dailyData, month) {
            const calendarGrid = document.getElementById('calendar-grid');
            const monthYear = month.split('-');
            const year = parseInt(monthYear[0]);
            const monthNum = parseInt(monthYear[1]) - 1;

            const firstDay = new Date(year, monthNum, 1).getDay();
            const daysInMonth = new Date(year, monthNum + 1, 0).getDate();

            // è®¡ç®—æœ€é«˜æœ€ä½ç”¨ç”µé‡å’Œè´¹ç”¨
            const usageValues = dailyData.map(d => d.usage);
            const costValues = dailyData.map(d => d.cost);
            const maxUsage = Math.max(...usageValues);
            const minUsage = Math.min(...usageValues);
            const maxCost = Math.max(...costValues);

            // æ‰¾åˆ°æœ€é«˜ç”¨ç”µé‡å’Œæœ€é«˜è´¹ç”¨çš„æ—¥æœŸ
            const maxUsageDay = dailyData.find(d => d.usage === maxUsage)?.day;
            const maxCostDay = dailyData.find(d => d.cost === maxCost)?.day;


            // æ˜ŸæœŸæ ‡é¢˜
            const weekDays = currentLanguage === 'zh' ?
                ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'] :
                ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

            let calendarHTML = weekDays.map(day => `<div class="calendar-weekday">${day}</div>`).join('');

            // ç©ºç™½æ ¼å­ï¼ˆæœˆåˆï¼‰
            for (let i = 0; i < firstDay; i++) {
                calendarHTML += '<div class="calendar-day empty"></div>';
            }

            // æ—¥æœŸæ ¼å­
            for (let day = 1; day <= daysInMonth; day++) {
                const dayData = dailyData.find(d => d.day === day);
                const usage = dayData ? dayData.usage : 0;
                const cost = dayData ? dayData.cost : 0;

                // æ ¹æ®å½“å‰ç±»å‹é€‰æ‹©æ˜¾ç¤ºå€¼
                const displayValue = currentCalendarType === 'usage' ? usage : cost;
                const displayUnit = currentCalendarType === 'usage' ? 'kWh' : 'â‚¹';
                const displayFormat = currentCalendarType === 'usage' ? usage.toFixed(1) : cost.toFixed(2);

                // æ·»åŠ æœ€é«˜å€¼æ ‡è®°ç‚¹
                let marker = '';
                if (currentCalendarType === 'usage' && day === maxUsageDay) {
                    marker = `<span class="max-marker usage-max" title="æœ¬æœˆç”¨ç”µé‡æœ€é«˜">â—</span>`;
                } else if (currentCalendarType === 'cost' && day === maxCostDay) {
                    marker = `<span class="max-marker cost-max" title="æœ¬æœˆè´¹ç”¨æœ€é«˜">â—</span>`;
                }

                calendarHTML += `
                    <div class="calendar-day ${day === 1 ? 'selected' : ''}" data-day="${day}" onclick="selectCalendarDay(${day})" title="${currentLanguage === 'zh' ? `${day}æ—¥: ${displayFormat}${displayUnit}` : `Day ${day}: ${displayFormat}${displayUnit}`}">
                        <span class="day-number">${day}</span>
                        ${marker}
                        <div class="day-content">
                            <span class="day-usage-value">${displayFormat}</span>
                            <span class="day-unit">${displayUnit}</span>
                        </div>
                    </div>
                `;
            }

            calendarGrid.innerHTML = calendarHTML;

            // åˆå§‹åŒ–æ˜¾ç¤ºç¬¬ä¸€å¤©çš„æ•°æ®
            generateCalendarHourlyData(1);
        }

        // åˆ‡æ¢æ—¥æœŸè¯¦æƒ…æ˜¾ç¤º
        // é€‰ä¸­æ—¥å†æ—¥æœŸ
        function selectCalendarDay(day) {
            // ç§»é™¤å…¶ä»–æ—¥æœŸçš„é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.calendar-day').forEach(dayEl => {
                dayEl.classList.remove('selected');
            });

            // è®¾ç½®å½“å‰æ—¥æœŸä¸ºé€‰ä¸­
            const selectedDay = document.querySelector(`[data-day="${day}"]`);
            if (selectedDay) {
                selectedDay.classList.add('selected');
            }

            // æ›´æ–°å³ä¾§æ ‡é¢˜
            const title = document.getElementById('selected-day-title');
            if (title) {
                title.setAttribute('data-zh', `${day}æ—¥æ¯å°æ—¶ç”¨ç”µè¯¦æƒ…`);
                title.setAttribute('data-en', `Day ${day} Hourly Details`);
                title.textContent = currentLanguage === 'zh' ? `${day}æ—¥æ¯å°æ—¶ç”¨ç”µè¯¦æƒ…` : `Day ${day} Hourly Details`;
            }

            // ç”Ÿæˆæ¯å°æ—¶æ•°æ®
            generateCalendarHourlyData(day);
        }

        // ç”Ÿæˆæ—¥å†æ¯å°æ—¶æ•°æ®
        function generateCalendarHourlyData(day) {
            const hourlyList = document.getElementById('calendar-hourly-list');
            if (!hourlyList) return;

            const timeRates = {
                peak: 5.40,     // é«˜å³°æ—¶æ®µï¼š12:00-18:00
                standard: 4.50, // å¹³å³°æ—¶æ®µï¼š08:00-12:00, 18:00-23:00
                valley: 3.60    // ä½è°·æ—¶æ®µï¼š23:00-08:00
            };

            let hourlyHTML = '';

            for (let hour = 0; hour < 24; hour++) {
                let period, periodName, rate, periodClass;

                if (hour >= 12 && hour < 18) {
                    period = 'peak';
                    periodName = currentLanguage === 'zh' ? 'é«˜å³°' : 'Peak';
                    rate = timeRates.peak;
                    periodClass = 'peak';
                } else if ((hour >= 8 && hour < 12) || (hour >= 18 && hour < 23)) {
                    period = 'standard';
                    periodName = currentLanguage === 'zh' ? 'å¹³å³°' : 'Standard';
                    rate = timeRates.standard;
                    periodClass = 'standard';
                } else {
                    period = 'valley';
                    periodName = currentLanguage === 'zh' ? 'ä½è°·' : 'Valley';
                    rate = timeRates.valley;
                    periodClass = 'valley';
                }

                // æ¨¡æ‹Ÿæ¯å°æ—¶ç”¨ç”µé‡ (0.8-2.5kWhä¹‹é—´)
                const hourlyUsage = (Math.random() * 1.7 + 0.8).toFixed(2);
                const hourlyCost = (hourlyUsage * rate).toFixed(2);

                hourlyHTML += `
                    <div class="hourly-item ${periodClass}">
                        <span class="hour-time">${hour.toString().padStart(2, '0')}:00</span>
                        <span class="hour-period">${periodName}</span>
                        <span class="hour-usage">${hourlyUsage} kWh</span>
                        <span class="hour-rate">â‚¹${rate.toFixed(2)}</span>
                        <span class="hour-cost">â‚¹${hourlyCost}</span>
                    </div>
                `;
            }

            hourlyList.innerHTML = hourlyHTML;
        }


        // ç”Ÿæˆæ¯å°æ—¶ç”¨ç”µæ•°æ®
        function generateHourlyData(day) {
            const hourlyList = document.getElementById(`hourly-list-${day}`);

            // è·å–æ—¶æ®µç”µä»·
            const timeRates = {
                peak: 5.40,     // é«˜å³°æ—¶æ®µ 12:00-18:00
                standard: 4.50, // å¹³å³°æ—¶æ®µ 08:00-12:00 & 18:00-23:00
                valley: 3.60    // ä½è°·æ—¶æ®µ 23:00-08:00
            };

            // ç”Ÿæˆ24å°æ—¶æ•°æ®
            let hourlyHTML = '';
            for (let hour = 0; hour < 24; hour++) {
                // ç¡®å®šæ—¶æ®µç±»å‹
                let period, periodName, rate, periodClass;
                if (hour >= 12 && hour < 18) {
                    period = 'peak';
                    periodName = currentLanguage === 'zh' ? 'é«˜å³°' : 'Peak';
                    rate = timeRates.peak;
                    periodClass = 'peak';
                } else if ((hour >= 8 && hour < 12) || (hour >= 18 && hour < 23)) {
                    period = 'standard';
                    periodName = currentLanguage === 'zh' ? 'å¹³å³°' : 'Standard';
                    rate = timeRates.standard;
                    periodClass = 'standard';
                } else {
                    period = 'valley';
                    periodName = currentLanguage === 'zh' ? 'ä½è°·' : 'Valley';
                    rate = timeRates.valley;
                    periodClass = 'valley';
                }

                // æ¨¡æ‹Ÿæ¯å°æ—¶ç”¨ç”µé‡ (0.8-2.5kWhä¹‹é—´)
                const hourlyUsage = (Math.random() * 1.7 + 0.8).toFixed(2);
                const hourlyCost = (hourlyUsage * rate).toFixed(2);

                hourlyHTML += `
                    <div class="hourly-item ${periodClass}">
                        <span class="hour-time">${hour.toString().padStart(2, '0')}:00</span>
                        <span class="hour-period">${periodName}</span>
                        <span class="hour-usage">${hourlyUsage} kWh</span>
                        <span class="hour-rate">â‚¹${rate.toFixed(2)}</span>
                        <span class="hour-cost">â‚¹${hourlyCost}</span>
                    </div>
                `;
            }

            hourlyList.innerHTML = hourlyHTML;
        }

        // æ˜¾ç¤ºè¯¦ç»†è§†å›¾åŠŸèƒ½ - å³ä¾§æŠ½å±‰
        function showDetailedView() {
            console.log('showDetailedView called');
            // åˆ›å»ºå³ä¾§æŠ½å±‰æ˜¾ç¤ºåˆ†æ—¶ç”µä»·æ˜ç»†
            const drawer = document.createElement('div');
            drawer.className = 'right-drawer';
            drawer.innerHTML = `
                <div class="drawer-overlay" onclick="closeDetailedView()"></div>
                <div class="drawer-content">
                    <div class="drawer-header">
                        <h3 data-zh="åŸºç¡€ç”µè´¹â€”â€”2025/09" data-en="Basic Electricity Feeâ€”September 2025">åŸºç¡€ç”µè´¹â€”â€”2025/09</h3>
                        <button class="drawer-close" onclick="closeDetailedView()">Ã—</button>
                    </div>
                    <div class="drawer-body">
                        <!-- æ¨¡å— -->
                        <div class="drawer-usage-module">
                            <div class="drawer-module-header">
                                <div class="drawer-header-left">
                                    <div class="drawer-view-tabs">
                                        <button class="drawer-tab-btn active" onclick="switchDrawerView('chart')">
                                            <span data-zh="å›¾è¡¨" data-en="Chart">å›¾è¡¨</span>
                                        </button>
                                        <button class="drawer-tab-btn" onclick="switchDrawerView('calendar')">
                                            <span data-zh="æ—¥å†" data-en="Calendar">æ—¥å†</span>
                                        </button>
                                        <button class="drawer-tab-btn" onclick="switchDrawerView('table')">
                                            <span data-zh="è¡¨æ ¼" data-en="Table">è¡¨æ ¼</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="drawer-header-right">
                                    <button class="drawer-export-btn" onclick="exportDrawerData()">
                                        ğŸ“Š <span data-zh="å¯¼å‡º" data-en="Export">å¯¼å‡º</span>
                                    </button>
                                </div>
                            </div>

                            <!-- è¡¨æ ¼è§†å›¾ -->
                            <div id="drawer-table-view" class="drawer-usage-view">
                                <div class="drawer-table-container">
                                    <div class="drawer-daily-table">
                                        <div class="drawer-daily-table-header" id="drawer-table-header">
                                            <span data-zh="æ—¥æœŸ" data-en="Date">æ—¥æœŸ</span>
                                            <span data-zh="ç”¨ç”µé‡(kWh)" data-en="Usage(kWh)">ç”¨ç”µé‡(kWh)</span>
                                            <span data-zh="é‡‘é¢(â‚¹)" data-en="Amount(â‚¹)">é‡‘é¢(â‚¹)</span>
                                            <span></span>
                                        </div>
                                        <div class="drawer-daily-table-body" id="drawer-table-body">
                                            <!-- æ•°æ®å°†ä»ä¸»é¡µé¢å¤åˆ¶ -->
                                        </div>
                                    </div>
                                </div>
                                <!-- æ¯å°æ—¶è¯¦æƒ…é¢æ¿ï¼ˆåœ¨è¡¨æ ¼è§†å›¾ä¸­ï¼Œç”¨äºå³ä¾§æ˜¾ç¤ºï¼‰ -->
                                <div id="drawer-hourly-details-panel" class="drawer-hourly-details-panel" style="display: none;">
                                    <div class="drawer-hourly-header">
                                        <h4 id="drawer-selected-date-title" data-zh="æ¯å°æ—¶æ˜ç»†" data-en="Hourly Details">æ¯å°æ—¶æ˜ç»†</h4>
                                        <button class="drawer-hourly-close" onclick="closeDrawerHourlyDetails()">Ã—</button>
                                    </div>
                                    <div class="drawer-hourly-content" id="drawer-hourly-details-content">
                                        <!-- æ¯å°æ—¶æ•°æ®å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                                    </div>
                                </div>
                            </div>

                            <!-- æ—¥å†è§†å›¾ -->
                            <div id="drawer-calendar-view" class="drawer-usage-view">
                                <div class="drawer-calendar-container">
                                    <div class="drawer-calendar-controls">
                                        <div class="drawer-calendar-header">
                                            <h3 id="drawer-calendar-title">2025å¹´9æœˆ</h3>
                                            <div class="drawer-calendar-toggle">
                                                <button class="drawer-calendar-toggle-btn active" data-type="usage" onclick="switchDrawerCalendarType('usage')">
                                                    <span data-zh="ç”µé‡" data-en="Usage">ç”µé‡</span>
                                                </button>
                                                <button class="drawer-calendar-toggle-btn" data-type="cost" onclick="switchDrawerCalendarType('cost')">
                                                    <span data-zh="è´¹ç”¨" data-en="Cost">è´¹ç”¨</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="drawer-calendar-weekdays">
                                        <div class="drawer-weekday" data-zh="æ—¥" data-en="Sun">æ—¥</div>
                                        <div class="drawer-weekday" data-zh="ä¸€" data-en="Mon">ä¸€</div>
                                        <div class="drawer-weekday" data-zh="äºŒ" data-en="Tue">äºŒ</div>
                                        <div class="drawer-weekday" data-zh="ä¸‰" data-en="Wed">ä¸‰</div>
                                        <div class="drawer-weekday" data-zh="å››" data-en="Thu">å››</div>
                                        <div class="drawer-weekday" data-zh="äº”" data-en="Fri">äº”</div>
                                        <div class="drawer-weekday" data-zh="å…­" data-en="Sat">å…­</div>
                                    </div>

                                    <div id="drawer-calendar-grid" class="drawer-calendar-grid">
                                        <!-- æ—¥å†ç”±JavaScriptç”Ÿæˆ -->
                                    </div>

                                    <div class="drawer-calendar-legend">
                                        <div class="legend-item">
                                            <div class="legend-dot low-usage"></div>
                                            <span data-zh="ä½ç”¨ç”µ (<15kWh)" data-en="Low usage (<15kWh)">ä½ç”¨ç”µ (<15kWh)</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-dot medium-usage"></div>
                                            <span data-zh="ä¸­ç­‰ç”¨ç”µ (15-25kWh)" data-en="Medium usage (15-25kWh)">ä¸­ç­‰ç”¨ç”µ (15-25kWh)</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-dot high-usage"></div>
                                            <span data-zh="é«˜ç”¨ç”µ (>25kWh)" data-en="High usage (>25kWh)">é«˜ç”¨ç”µ (>25kWh)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- å›¾è¡¨è§†å›¾ -->
                            <div id="drawer-chart-view" class="drawer-usage-view active">
                                <div class="drawer-chart-container">
                                    <div id="drawer-usage-chart" style="width: 100%; height: 400px;"></div>
                                </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(drawer);

            // é˜»æ­¢æŠ½å±‰å†…çš„æ»šåŠ¨äº‹ä»¶å†’æ³¡åˆ°ä¸»é¡µé¢
            const drawerContent = drawer.querySelector('.drawer-content');
            if (drawerContent) {
                drawerContent.addEventListener('wheel', function(e) {
                    e.stopPropagation();
                }, { passive: false });

                drawerContent.addEventListener('touchmove', function(e) {
                    e.stopPropagation();
                }, { passive: false });
            }

            // å¤åˆ¶åˆ†æ—¶ç”µä»·æ•°æ®åˆ°æŠ½å±‰
            copyTimeOfUsePricingToDrawer();

            // æ·»åŠ æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                drawer.classList.add('show');
                // ç¦ç”¨ä¸»é¡µé¢æ»šåŠ¨
                document.body.style.overflow = 'hidden';
                // åˆå§‹åŒ–é»˜è®¤çš„å›¾è¡¨è§†å›¾
                setTimeout(() => {
                    renderDrawerChart();
                }, 300);
            }, 10);

            // æ›´æ–°è¯­è¨€
            EnergySystem.updateTexts();
        }

        // é˜¶æ¢¯ç”µä»·ä¸“ç”¨è¯¦ç»†è§†å›¾åŠŸèƒ½ - å³ä¾§æŠ½å±‰
        function showTieredDetailedView() {
            console.log('showTieredDetailedView called');
            // åˆ›å»ºå³ä¾§æŠ½å±‰æ˜¾ç¤ºé˜¶æ¢¯ç”µä»·æ˜ç»†
            const drawer = document.createElement('div');
            drawer.className = 'right-drawer';
            drawer.innerHTML = `
                <div class="drawer-overlay" onclick="closeTieredDetailedView()"></div>
                <div class="drawer-content">
                    <div class="drawer-header">
                        <h3 data-zh="ç”µé‡è´¹æ˜ç»†â€”â€”2025/09" data-en="Energy Charges Detailsâ€”September 2025">ç”µé‡è´¹æ˜ç»†â€”â€”2025/09</h3>
                        <button class="drawer-close" onclick="closeTieredDetailedView()">Ã—</button>
                    </div>
                    <div class="drawer-body">
                        <!-- æ¨¡å— -->
                        <div class="drawer-usage-module">
                            <div class="drawer-module-header">
                                <div class="drawer-header-left">
                                    <div class="drawer-view-tabs">
                                        <button class="drawer-tab-btn active" onclick="switchTieredDrawerView('chart')">
                                            <span data-zh="å›¾è¡¨" data-en="Chart">å›¾è¡¨</span>
                                        </button>
                                        <button class="drawer-tab-btn" onclick="switchTieredDrawerView('calendar')">
                                            <span data-zh="æ—¥å†" data-en="Calendar">æ—¥å†</span>
                                        </button>
                                        <button class="drawer-tab-btn" onclick="switchTieredDrawerView('table')">
                                            <span data-zh="è¡¨æ ¼" data-en="Table">è¡¨æ ¼</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="drawer-header-right">
                                    <button class="drawer-export-btn" onclick="exportTieredDrawerData()">
                                        ğŸ“Š <span data-zh="å¯¼å‡º" data-en="Export">å¯¼å‡º</span>
                                    </button>
                                </div>
                            </div>

                            <!-- è¡¨æ ¼è§†å›¾ -->
                            <div id="tiered-drawer-table-view" class="drawer-usage-view">
                                <div class="drawer-table-container">
                                    <div class="drawer-daily-table">
                                        <div class="drawer-daily-table-header" id="tiered-drawer-table-header">
                                            <span data-zh="æ—¥æœŸ" data-en="Date">æ—¥æœŸ</span>
                                            <span data-zh="ç”¨ç”µé‡(kWh)" data-en="Usage(kWh)">ç”¨ç”µé‡(kWh)</span>
                                            <span data-zh="ç´¯è®¡(kWh)" data-en="Cumulative(kWh)">ç´¯è®¡(kWh)</span>
                                            <span data-zh="æ‰€å±é˜¶æ¢¯" data-en="Tier">æ‰€å±é˜¶æ¢¯</span>
                                            <span></span>
                                        </div>
                                        <div class="drawer-daily-table-body" id="tiered-drawer-table-body">
                                            <!-- é˜¶æ¢¯ç”µä»·æ•°æ®å°†ç”Ÿæˆåœ¨è¿™é‡Œ -->
                                        </div>
                                    </div>
                                </div>
                                <!-- é˜¶æ¢¯ç”µä»·æ¯å°æ—¶è¯¦æƒ…é¢æ¿ï¼ˆåœ¨è¡¨æ ¼è§†å›¾ä¸­ï¼Œç”¨äºå³ä¾§æ˜¾ç¤ºï¼‰ -->
                                <div id="tiered-drawer-hourly-details-panel" class="drawer-hourly-details-panel" style="display: none;">
                                    <div class="drawer-hourly-header">
                                        <h4 id="tiered-drawer-selected-date-title" data-zh="æ¯å°æ—¶æ˜ç»†" data-en="Hourly Details">æ¯å°æ—¶æ˜ç»†</h4>
                                        <button class="drawer-hourly-close" onclick="closeTieredDrawerHourlyDetails()">Ã—</button>
                                    </div>
                                    <div class="drawer-hourly-content" id="tiered-drawer-hourly-details-content">
                                        <!-- æ¯å°æ—¶æ•°æ®å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                                    </div>
                                </div>
                            </div>

                            <!-- æ—¥å†è§†å›¾ -->
                            <div id="tiered-drawer-calendar-view" class="drawer-usage-view">
                                <div class="drawer-calendar-container">
                                    <div class="drawer-calendar-controls">
                                        <div class="drawer-calendar-header">
                                            <h3 id="tiered-drawer-calendar-title">2025å¹´9æœˆ</h3>
                                            <div class="drawer-calendar-toggle">
                                                <button class="drawer-calendar-toggle-btn active" data-type="usage" onclick="switchTieredDrawerCalendarType('usage')">
                                                    <span data-zh="ç”µé‡" data-en="Usage">ç”µé‡</span>
                                                </button>
                                                <button class="drawer-calendar-toggle-btn" data-type="cumulative" onclick="switchTieredDrawerCalendarType('cumulative')">
                                                    <span data-zh="ç´¯è®¡" data-en="Cumulative">ç´¯è®¡</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="drawer-calendar-weekdays">
                                        <div class="drawer-weekday" data-zh="æ—¥" data-en="Sun">æ—¥</div>
                                        <div class="drawer-weekday" data-zh="ä¸€" data-en="Mon">ä¸€</div>
                                        <div class="drawer-weekday" data-zh="äºŒ" data-en="Tue">äºŒ</div>
                                        <div class="drawer-weekday" data-zh="ä¸‰" data-en="Wed">ä¸‰</div>
                                        <div class="drawer-weekday" data-zh="å››" data-en="Thu">å››</div>
                                        <div class="drawer-weekday" data-zh="äº”" data-en="Fri">äº”</div>
                                        <div class="drawer-weekday" data-zh="å…­" data-en="Sat">å…­</div>
                                    </div>

                                    <div id="tiered-drawer-calendar-grid" class="drawer-calendar-grid">
                                        <!-- æ—¥å†ç”±JavaScriptç”Ÿæˆ -->
                                    </div>

                                    <div class="drawer-calendar-legend">
                                        <div class="legend-item">
                                            <div class="legend-dot tier-1"></div>
                                            <span data-zh="ç¬¬ä¸€é˜¶æ¢¯ (0-100kWh) â‚¹3.35" data-en="Tier 1 (0-100kWh) â‚¹3.35">ç¬¬ä¸€é˜¶æ¢¯ (0-100kWh) â‚¹3.35</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-dot tier-2"></div>
                                            <span data-zh="ç¬¬äºŒé˜¶æ¢¯ (101-200kWh) â‚¹4.60" data-en="Tier 2 (101-200kWh) â‚¹4.60">ç¬¬äºŒé˜¶æ¢¯ (101-200kWh) â‚¹4.60</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-dot tier-3"></div>
                                            <span data-zh="ç¬¬ä¸‰é˜¶æ¢¯ (201-400kWh) â‚¹6.85" data-en="Tier 3 (201-400kWh) â‚¹6.85">ç¬¬ä¸‰é˜¶æ¢¯ (201-400kWh) â‚¹6.85</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-dot tier-4"></div>
                                            <span data-zh="ç¬¬å››é˜¶æ¢¯ (400+kWh) â‚¹8.50" data-en="Tier 4 (400+kWh) â‚¹8.50">ç¬¬å››é˜¶æ¢¯ (400+kWh) â‚¹8.50</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- å›¾è¡¨è§†å›¾ -->
                            <div id="tiered-drawer-chart-view" class="drawer-usage-view active">
                                <div class="drawer-chart-container">
                                    <div id="tiered-drawer-usage-chart" style="width: 100%; height: 480px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(drawer);

            // é˜»æ­¢æŠ½å±‰å†…çš„æ»šåŠ¨äº‹ä»¶å†’æ³¡åˆ°ä¸»é¡µé¢
            const drawerContent = drawer.querySelector('.drawer-content');
            if (drawerContent) {
                drawerContent.addEventListener('wheel', function(e) {
                    e.stopPropagation();
                }, { passive: false });

                drawerContent.addEventListener('touchmove', function(e) {
                    e.stopPropagation();
                }, { passive: false });
            }

            // å¤åˆ¶é˜¶æ¢¯ç”µä»·æ•°æ®åˆ°æŠ½å±‰
            copyTieredPricingToDrawer();

            // æ·»åŠ æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                drawer.classList.add('show');
                // ç¦ç”¨ä¸»é¡µé¢æ»šåŠ¨
                document.body.style.overflow = 'hidden';
                // åˆå§‹åŒ–é»˜è®¤çš„å›¾è¡¨è§†å›¾
                setTimeout(() => {
                    renderTieredDrawerChart();
                }, 300);
            }, 10);

            // æ›´æ–°è¯­è¨€
            EnergySystem.updateTexts();
        }

        // å¤åˆ¶é˜¶æ¢¯ç”µä»·æ•°æ®åˆ°æŠ½å±‰
        function copyTieredPricingToDrawer() {
            console.log('copyTieredPricingToDrawer called');
            const drawerTableBody = document.getElementById('tiered-drawer-table-body');
            console.log('tiered drawerTableBody:', drawerTableBody);

            if (!drawerTableBody) {
                console.error('tiered-drawer-table-body not found!');
                return;
            }

            // é˜¶æ¢¯ç”µä»·ç»“æ„
            const tierStructure = [
                {
                    max: 100,
                    rate: 3.35,
                    name: currentLanguage === 'zh' ? 'ç¬¬ä¸€é˜¶æ¢¯ (0-100kWh)' : 'Tier 1 (0-100kWh)'
                },
                {
                    max: 200,
                    rate: 4.60,
                    name: currentLanguage === 'zh' ? 'ç¬¬äºŒé˜¶æ¢¯ (101-200kWh)' : 'Tier 2 (101-200kWh)'
                },
                {
                    max: 400,
                    rate: 6.85,
                    name: currentLanguage === 'zh' ? 'ç¬¬ä¸‰é˜¶æ¢¯ (201-400kWh)' : 'Tier 3 (201-400kWh)'
                },
                {
                    max: Infinity,
                    rate: 8.50,
                    name: currentLanguage === 'zh' ? 'ç¬¬å››é˜¶æ¢¯ (400+kWh)' : 'Tier 4 (400+kWh)'
                }
            ];

            // ç”Ÿæˆé˜¶æ¢¯ç”µä»·æ•°æ® - æ¨¡æ‹Ÿ280kWhçš„æœˆç”¨é‡
            let tieredData = [];
            const daysInSeptember = new Date(2025, 9, 0).getDate(); // 2025å¹´9æœˆçš„å¤©æ•° (30å¤©)
            let cumulativeUsage = 0;
            const totalMonthUsage = 280; // æ€»æœˆç”¨é‡280kWhï¼Œè¾¾åˆ°ç¬¬ä¸‰é˜¶æ¢¯

            for (let day = 1; day <= daysInSeptember; day++) {
                // æ¨¡æ‹Ÿæ¯æ—¥ç”¨é‡ï¼Œæ€»è®¡çº¦280kWh
                let dailyUsage;
                if (day <= 10) {
                    dailyUsage = 8 + Math.random() * 4; // å‰10å¤©è¾ƒä½ç”¨é‡
                } else if (day <= 20) {
                    dailyUsage = 10 + Math.random() * 4; // ä¸­é—´10å¤©ä¸­ç­‰ç”¨é‡
                } else {
                    dailyUsage = 7 + Math.random() * 6; // å10å¤©å˜åŒ–ç”¨é‡
                }

                cumulativeUsage += dailyUsage;

                // ç¡®å®šæ‰€å±é˜¶æ¢¯
                let tier;
                if (cumulativeUsage <= 100) {
                    tier = 1;
                } else if (cumulativeUsage <= 200) {
                    tier = 2;
                } else if (cumulativeUsage <= 400) {
                    tier = 3;
                } else {
                    tier = 4;
                }

                tieredData.push({
                    day: day,
                    date: `2025-09-${day.toString().padStart(2, '0')}`,
                    usage: dailyUsage.toFixed(2),
                    cumulative: cumulativeUsage.toFixed(2),
                    tier: tier
                });
            }

            window.currentTieredData = tieredData;
            window.tierStructure = tierStructure;
            console.log('Generated tiered data for', daysInSeptember, 'days');

            // ç”Ÿæˆè¡¨æ ¼è¡Œï¼Œå®Œå…¨å¤åˆ¶åˆ†æ—¶ç”µä»·çš„è¡¨æ ¼ç»“æ„
            drawerTableBody.innerHTML = '';
            console.log('Tiered data length:', tieredData.length);
            let dayCounter = 1;

            tieredData.forEach(dayData => {
                console.log('Processing tiered day:', dayData);

                // åˆ›å»ºä¸»è¡Œ
                const newRow = document.createElement('div');
                newRow.className = 'drawer-daily-table-row';
                newRow.innerHTML = `
                    <span class="drawer-daily-date">${dayData.date}</span>
                    <span class="drawer-daily-usage">${dayData.usage}</span>
                    <span class="drawer-daily-cumulative">${dayData.cumulative}</span>
                    <span class="drawer-daily-tier">${currentLanguage === 'zh' ? `ç¬¬${dayData.tier}é˜¶æ¢¯` : `Tier ${dayData.tier}`}</span>
                    <span class="drawer-daily-action">
                        <button class="drawer-view-details-btn btn-primary-small" onclick="showTieredDrawerDayDetails('${dayData.date}', event)">
                            <svg style="width: 12px; height: 12px; margin-right: 4px;" viewBox="0 0 24 24" fill="none">
                                <path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span data-zh="æŸ¥çœ‹è¯¦æƒ…" data-en="View Details">æŸ¥çœ‹è¯¦æƒ…</span>
                        </button>
                    </span>
                `;

                // åˆ›å»ºè¯¦æƒ…è¡Œ - å®Œå…¨å¤åˆ¶åˆ†æ—¶ç”µä»·çš„ç»“æ„
                const detailsRow = document.createElement('div');
                detailsRow.className = 'drawer-daily-details-row';
                detailsRow.style.display = 'none';
                detailsRow.innerHTML = `
                    <div class="drawer-daily-details-content">
                        <div class="drawer-hourly-content">
                            <div class="drawer-hourly-table">
                                <div class="drawer-hourly-table-header">
                                    <span data-zh="æ—¶é—´" data-en="Time">æ—¶é—´</span>
                                    <span data-zh="é˜¶æ¢¯" data-en="Tier">é˜¶æ¢¯</span>
                                    <span data-zh="ç”¨ç”µé‡" data-en="Usage">ç”¨ç”µé‡</span>
                                    <span data-zh="å•ä»·" data-en="Rate">å•ä»·</span>
                                    <span data-zh="é‡‘é¢" data-en="Amount">é‡‘é¢</span>
                                </div>
                                <div class="drawer-hourly-table-body" id="tiered-drawer-hourly-body-${dayCounter}">
                                    <!-- æ¯å°æ—¶æ•°æ®ç”±JavaScriptç”Ÿæˆ -->
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                drawerTableBody.appendChild(newRow);
                drawerTableBody.appendChild(detailsRow);
                dayCounter++;
            });

            console.log('Tiered table generated with', dayCounter - 1, 'rows');
        }

        // å…³é—­é˜¶æ¢¯ç”µä»·æŠ½å±‰
        function closeTieredDetailedView() {
            const drawer = document.querySelector('.right-drawer');
            if (drawer) {
                drawer.classList.remove('show');
                // æ¢å¤ä¸»é¡µé¢æ»šåŠ¨
                document.body.style.overflow = 'auto';
                setTimeout(() => {
                    drawer.remove();
                }, 300);
            }
        }

        // åˆ‡æ¢é˜¶æ¢¯ç”µä»·æŠ½å±‰è§†å›¾
        function switchTieredDrawerView(viewType) {
            console.log('switchTieredDrawerView:', viewType);

            // æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­çš„æ—¥æœŸï¼ˆå±•å¼€çŠ¶æ€ï¼‰
            const selectedCalendarDay = document.querySelector('.drawer-calendar-day.selected');
            const selectedTableRow = document.querySelector('.drawer-daily-table-row.selected');
            const isExpanded = selectedCalendarDay !== null || selectedTableRow !== null;

            // è§†å›¾åˆ‡æ¢æ—¶çš„æ¸…ç†å·¥ä½œ
            const drawer = document.querySelector('.right-drawer');

            if (viewType === 'calendar') {
                console.log('Calendar view selected - clearing selections but keeping drawer state');

                // æ¸…é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.drawer-calendar-day.selected').forEach(day => {
                    day.classList.remove('selected');
                });
                document.querySelectorAll('.drawer-daily-table-row.selected').forEach(row => {
                    row.classList.remove('selected');
                });
                document.querySelectorAll('.drawer-daily-details-row').forEach(row => {
                    row.style.display = 'none';
                });

                // å¦‚æœå½“å‰æœ‰å±•å¼€çŠ¶æ€ï¼Œæ”¶èµ·æŠ½å±‰æ¢å¤çª„å®½åº¦
                if (drawer.classList.contains('expanded')) {
                    drawer.classList.remove('expanded');
                    console.log('Calendar view selected - drawer collapsed to narrow width');
                }
            } else {
                // åˆ‡æ¢åˆ°éæ—¥å†è§†å›¾æ—¶ï¼Œæ¸…ç†æ—¥å†è¯¦æƒ…é¢æ¿
                const calendarDetailsPanel = document.getElementById('tiered-calendar-hourly-details-panel');
                if (calendarDetailsPanel) {
                    calendarDetailsPanel.remove();
                }

                // æ¸…ç†é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.drawer-calendar-day.selected').forEach(day => {
                    day.classList.remove('selected');
                });
                document.querySelectorAll('.drawer-daily-table-row.selected').forEach(row => {
                    row.classList.remove('selected');
                });
                document.querySelectorAll('.drawer-daily-details-row').forEach(row => {
                    row.style.display = 'none';
                });

                // æ”¶èµ·æŠ½å±‰
                if (drawer.classList.contains('expanded')) {
                    drawer.classList.remove('expanded');
                }
            }

            // æ›´æ–°æ ‡ç­¾çŠ¶æ€
            document.querySelectorAll('.drawer-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // æ›´å®‰å…¨çš„æŒ‰é’®é€‰æ‹©æ–¹å¼
            const targetBtn = document.querySelector(`[onclick="switchTieredDrawerView('${viewType}')"]`);
            if (targetBtn) {
                targetBtn.classList.add('active');
                console.log('Button activated:', targetBtn);
            } else {
                console.error('Button not found for viewType:', viewType);
            }

            // åˆ‡æ¢è§†å›¾
            document.querySelectorAll('.drawer-usage-view').forEach(view => {
                view.classList.remove('active');
                view.style.display = 'none';
                console.log('Removed active from:', view.id);
            });

            const targetView = document.getElementById(`tiered-drawer-${viewType}-view`);
            if (targetView) {
                targetView.classList.add('active');
                console.log('Added active to:', targetView.id);

                // æ¸…é™¤å†…è”æ ·å¼ï¼Œè®©CSSè§„åˆ™æ ¹æ®å±•å¼€çŠ¶æ€è‡ªåŠ¨ç”Ÿæ•ˆ
                targetView.style.display = '';
            } else {
                console.error('Target view not found:', `tiered-drawer-${viewType}-view`);
            }

            // æ ¹æ®è§†å›¾ç±»å‹æ‰§è¡Œç‰¹å®šæ“ä½œ
            if (viewType === 'chart') {
                setTimeout(() => {
                    renderTieredDrawerChart();
                }, 100);
            } else if (viewType === 'calendar') {
                setTimeout(() => {
                    renderTieredDrawerCalendar();
                }, 100);
            } else if (viewType === 'table') {
                setTimeout(() => {
                    copyTieredPricingToDrawerTable();
                }, 100);
            }
        }

        // æ˜¾ç¤ºé˜¶æ¢¯ç”µä»·æŠ½å±‰ä¸­æŸå¤©çš„è¯¦æƒ…
        function showTieredDrawerDayDetails(date, event) {
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }

            console.log('showTieredDrawerDayDetails called for:', date);

            // æŸ¥æ‰¾è¯¥æ—¥æœŸçš„æ•°æ®
            const dayData = window.currentTieredData?.find(d => d.date === date);
            if (!dayData) {
                console.error('Day data not found for:', date);
                return;
            }

            // æ‰¾åˆ°å¯¹åº”çš„è¡¨æ ¼è¡Œå’Œè¯¦æƒ…è¡Œ
            const tableRows = document.querySelectorAll('.drawer-daily-table-row');
            const detailsRows = document.querySelectorAll('.drawer-daily-details-row');

            let targetRow = null;
            let targetDetailsRow = null;
            let rowIndex = -1;

            // æŸ¥æ‰¾å¯¹åº”çš„è¡Œ
            tableRows.forEach((row, index) => {
                const rowDate = row.querySelector('.drawer-daily-date').textContent;
                if (rowDate === date) {
                    targetRow = row;
                    targetDetailsRow = detailsRows[index];
                    rowIndex = index;
                }
            });

            if (!targetRow || !targetDetailsRow) {
                console.error('Table row not found for date:', date);
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²ç»å±•å¼€
            const isExpanded = targetDetailsRow.style.display === 'block';

            // å…ˆæ”¶èµ·æ‰€æœ‰å±•å¼€çš„è¡Œ
            detailsRows.forEach(row => {
                row.style.display = 'none';
            });
            tableRows.forEach(row => {
                row.classList.remove('selected');
            });

            if (!isExpanded) {
                // å±•å¼€é€‰ä¸­çš„è¡Œ
                targetDetailsRow.style.display = 'block';
                targetRow.classList.add('selected');

                // ç”Ÿæˆå°æ—¶æ•°æ®
                const hourlyBodyId = `tiered-drawer-hourly-body-${rowIndex + 1}`;
                const hourlyBody = document.getElementById(hourlyBodyId);

                if (hourlyBody) {
                    let hourlyHTML = '';
                    for (let hour = 0; hour < 24; hour++) {
                        const hourUsage = (parseFloat(dayData.usage) / 24 + Math.random() * 2 - 1).toFixed(2);
                        const hourlyRate = getTieredHourlyRate(dayData.tier, hour);
                        const hourlyCost = (hourUsage * hourlyRate).toFixed(2);

                        const tierName = currentLanguage === 'zh' ? `ç¬¬${dayData.tier}é˜¶æ¢¯` : `Tier ${dayData.tier}`;

                        hourlyHTML += `
                            <div class="drawer-hourly-table-row">
                                <span class="drawer-hourly-time">${hour.toString().padStart(2, '0')}:00</span>
                                <span class="drawer-hourly-tier">${tierName}</span>
                                <span class="drawer-hourly-usage">${hourUsage}</span>
                                <span class="drawer-hourly-rate">â‚¹${hourlyRate}</span>
                                <span class="drawer-hourly-cost">â‚¹${hourlyCost}</span>
                            </div>
                        `;
                    }
                    hourlyBody.innerHTML = hourlyHTML;
                }

                // æ›´æ–°è¯­è¨€
                EnergySystem.updateTexts();
            }
        }

        // è·å–é˜¶æ¢¯ç”µä»·çš„å°æ—¶è´¹ç‡
        function getTieredHourlyRate(tier, hour) {
            const baseRates = {
                1: 3.35,  // ç¬¬ä¸€é˜¶æ¢¯ â‚¹3.35
                2: 4.60,  // ç¬¬äºŒé˜¶æ¢¯ â‚¹4.60
                3: 6.85,  // ç¬¬ä¸‰é˜¶æ¢¯ â‚¹6.85
                4: 8.50   // ç¬¬å››é˜¶æ¢¯ â‚¹8.50 (ä¼°ç®—)
            };

            // é˜¶æ¢¯ç”µä»·ä¸€èˆ¬æ²¡æœ‰æ—¶æ®µå·®å¼‚ï¼Œä½¿ç”¨å›ºå®šè´¹ç‡
            return baseRates[tier].toFixed(2);
        }


        // æ¸²æŸ“é˜¶æ¢¯ç”µä»·æŠ½å±‰å›¾è¡¨
        function renderTieredDrawerChart() {
            console.log('renderTieredDrawerChart called');

            if (!window.echarts) {
                console.error('ECharts not loaded');
                return;
            }

            const chartContainer = document.getElementById('tiered-drawer-usage-chart');
            if (!chartContainer) {
                console.error('Tiered chart container not found');
                return;
            }

            // é”€æ¯ç°æœ‰å›¾è¡¨å®ä¾‹
            if (window.tieredDrawerChartInstance) {
                window.tieredDrawerChartInstance.dispose();
            }

            const chart = echarts.init(chartContainer);
            window.tieredDrawerChartInstance = chart;

            // ä½¿ç”¨é˜¶æ¢¯ç”µä»·æ•°æ®
            const data = window.currentTieredData || [];
            const dates = data.map(d => d.date.substring(5)); // åªæ˜¾ç¤ºæœˆ-æ—¥
            const usageData = data.map(d => parseFloat(d.usage));
            const tierData = data.map(d => d.tier);

            // è®¡ç®—é˜¶æ¢¯åŒºé—´å’Œç”¨é‡
            const tierRanges = [];
            let currentTier = tierData[0];
            let startIndex = 0;

            for (let i = 1; i <= tierData.length; i++) {
                if (i === tierData.length || tierData[i] !== currentTier) {
                    // è®¡ç®—è¯¥é˜¶æ¢¯çš„æ€»ç”¨é‡
                    let tierUsage = 0;
                    for (let j = startIndex; j <= i - 1; j++) {
                        tierUsage += usageData[j];
                    }

                    tierRanges.push({
                        tier: currentTier,
                        start: startIndex,
                        end: i - 1,
                        startDate: dates[startIndex],
                        endDate: dates[i - 1],
                        usage: tierUsage.toFixed(1)
                    });
                    if (i < tierData.length) {
                        currentTier = tierData[i];
                        startIndex = i;
                    }
                }
            }

            // åˆ›å»ºé˜¶æ¢¯åŒºé—´æ ‡è®°çº¿
            const markAreas = tierRanges.map(range => ({
                name: currentLanguage === 'zh' ? `é˜¶æ¢¯${range.tier}` : `Tier ${range.tier}`,
                xAxis: range.startDate,
                x2Axis: range.endDate,
                itemStyle: {
                    color: 'transparent',
                    borderColor: 'transparent'
                },
                label: {
                    show: true,
                    position: 'bottom',
                    distance: 10,
                    formatter: currentLanguage === 'zh' ?
                        `é˜¶æ¢¯${range.tier}\n(${range.startDate}~${range.endDate})` :
                        `Tier ${range.tier}\n(${range.startDate}~${range.endDate})`,
                    fontSize: 10,
                    color: '#666'
                }
            }));

            const option = {
                title: {
                    text: currentLanguage === 'zh' ? 'é˜¶æ¢¯ç”µä»·æ—¥ç”¨ç”µé‡åˆ†æ' : 'Tiered Pricing Daily Usage Analysis',
                    left: 'center',
                    textStyle: {
                        fontSize: 16,
                        fontWeight: 500
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    },
                    formatter: function(params) {
                        const param = params[0];
                        const tier = tierData[param.dataIndex];
                        const tierNames = currentLanguage === 'zh' ? {
                            1: 'ç¬¬ä¸€é˜¶æ¢¯ (0-100kWh) â‚¹3.35',
                            2: 'ç¬¬äºŒé˜¶æ¢¯ (101-200kWh) â‚¹4.60',
                            3: 'ç¬¬ä¸‰é˜¶æ¢¯ (201-400kWh) â‚¹6.85',
                            4: 'ç¬¬å››é˜¶æ¢¯ (400+kWh) â‚¹8.50'
                        } : {
                            1: 'Tier 1 (0-100kWh) â‚¹3.35',
                            2: 'Tier 2 (101-200kWh) â‚¹4.60',
                            3: 'Tier 3 (201-400kWh) â‚¹6.85',
                            4: 'Tier 4 (400+kWh) â‚¹8.50'
                        };

                        return `<div style="font-weight: 500; margin-bottom: 8px;">${dates[param.dataIndex]}</div>
                                <div style="margin: 4px 0;">
                                    <span style="display: inline-block; width: 10px; height: 10px; background: ${param.color}; border-radius: 50%; margin-right: 6px;"></span>
                                    ${currentLanguage === 'zh' ? 'æ—¥ç”¨ç”µé‡' : 'Daily Usage'}: ${param.value} kWh
                                </div>
                                <div style="margin: 4px 0; color: #666;">
                                    ${currentLanguage === 'zh' ? 'æ‰€å±é˜¶æ¢¯' : 'Tier'}: ${tierNames[tier]}
                                </div>`;
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '12%',
                    top: '12%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    axisLabel: {
                        rotate: 45,
                        fontSize: 11
                    }
                },
                yAxis: {
                    type: 'value',
                    name: currentLanguage === 'zh' ? 'æ—¥ç”¨ç”µé‡ (kWh)' : 'Daily Usage (kWh)',
                    nameTextStyle: {
                        fontSize: 12
                    }
                },
                series: [
                    {
                        name: currentLanguage === 'zh' ? 'æ—¥ç”¨ç”µé‡' : 'Daily Usage',
                        type: 'bar',
                        data: usageData,
                        itemStyle: {
                            color: '#0066CC'
                        },
                        barWidth: '60%',
                        emphasis: {
                            itemStyle: {
                                shadowBlur: 10,
                                shadowOffsetX: 0,
                                shadowColor: 'rgba(0, 0, 0, 0.2)'
                            }
                        },
                        markArea: {
                            silent: true,
                            data: tierRanges.map(range => [
                                {
                                    name: currentLanguage === 'zh' ? `é˜¶æ¢¯${range.tier}` : `Tier ${range.tier}`,
                                    xAxis: range.startDate,
                                    itemStyle: {
                                        color: 'rgba(0, 102, 204, 0.05)',
                                        borderColor: '#0066CC',
                                        borderWidth: 1,
                                        borderType: 'dashed'
                                    },
                                    label: {
                                        show: true,
                                        position: 'insideTop',
                                        formatter: function() {
                                            const tierRanges = currentLanguage === 'zh' ? {
                                                1: 'ç¬¬ä¸€é˜¶æ¢¯\n(0-100kWh)',
                                                2: 'ç¬¬äºŒé˜¶æ¢¯\n(101-200kWh)',
                                                3: 'ç¬¬ä¸‰é˜¶æ¢¯\n(201-400kWh)',
                                                4: 'ç¬¬å››é˜¶æ¢¯\n(400+kWh)'
                                            } : {
                                                1: 'Tier 1\n(0-100kWh)',
                                                2: 'Tier 2\n(101-200kWh)',
                                                3: 'Tier 3\n(201-400kWh)',
                                                4: 'Tier 4\n(400+kWh)'
                                            };
                                            return tierRanges[range.tier] || (currentLanguage === 'zh' ? `ç¬¬${range.tier}é˜¶æ¢¯` : `Tier ${range.tier}`);
                                        },
                                        fontSize: 10,
                                        color: '#666',
                                        fontWeight: 'bold'
                                    }
                                },
                                {
                                    xAxis: range.endDate
                                }
                            ])
                        }
                    }
                ]
            };

            chart.setOption(option);

            // å“åº”å¼è°ƒæ•´
            window.addEventListener('resize', function() {
                chart.resize();
            });
        }

        // ç”Ÿæˆé˜¶æ¢¯ç”µä»·æŠ½å±‰æ—¥å† - å®Œå…¨å¤åˆ¶åˆ†æ—¶ç”µä»·é€»è¾‘
        function renderTieredDrawerCalendar() {
            const calendarGrid = document.getElementById('tiered-drawer-calendar-grid');
            if (!calendarGrid) return;

            // è·å–å½“å‰æ—¥æœŸ
            const now = new Date();
            const currentYear = 2025;
            const currentMonth = 8; // JavaScriptä¸­9æœˆæ˜¯ç´¢å¼•8
            const today = now.getDate();

            // æ¨¡æ‹Ÿæ•°æ®ç”¨äºæ‰¾åˆ°æœ€å¤§å€¼ - ç¡®ä¿ä¸º2025å¹´9æœˆç”Ÿæˆ30å¤©æ•°æ®
            const monthlyData = [];
            const daysInMonth = new Date(2025, 9, 0).getDate(); // 2025å¹´9æœˆçš„å¤©æ•° (30å¤©)
            const data = window.currentTieredData || [];

            for (let d = 1; d <= daysInMonth; d++) {
                const dayData = data.find(item => item.day === d);
                if (dayData) {
                    const usage = parseFloat(dayData.usage);
                    const cumulative = parseFloat(dayData.cumulative);
                    monthlyData.push({ day: d, usage, cumulative, tier: dayData.tier });
                } else {
                    const usage = 15 + Math.sin(d * 0.3) * 8 + Math.random() * 6;
                    monthlyData.push({ day: d, usage, cumulative: usage, tier: 1 });
                }
            }

            const maxUsage = Math.max(...monthlyData.map(d => d.usage));
            const maxCumulative = Math.max(...monthlyData.map(d => d.cumulative));
            const maxUsageDay = monthlyData.find(d => d.usage === maxUsage)?.day;
            const maxCumulativeDay = monthlyData.find(d => d.cumulative === maxCumulative)?.day;

            // ç”Ÿæˆæ—¥å†æ•°æ®
            const firstDay = new Date(2025, currentMonth, 1);
            const lastDay = new Date(2025, currentMonth + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            let calendarHTML = '';
            let date = new Date(startDate);

            // ç”Ÿæˆ6å‘¨çš„æ—¥å†ï¼ˆ42å¤©ï¼‰
            for (let i = 0; i < 42; i++) {
                const day = date.getDate();
                const isCurrentMonth = date.getMonth() === currentMonth;
                const isToday = isCurrentMonth && day === today;
                const isOtherMonth = !isCurrentMonth;

                // æ¨¡æ‹Ÿç”¨ç”µé‡æ•°æ® - ä½¿ç”¨é¢„ç”Ÿæˆçš„æ•°æ®ç¡®ä¿ä¸€è‡´æ€§
                let dailyUsage = 0;
                let cumulativeUsage = 0;
                if (isCurrentMonth && day <= daysInMonth) {
                    const dayData = monthlyData.find(d => d.day === day);
                    dailyUsage = dayData ? dayData.usage : 15 + Math.sin(day * 0.3) * 8 + Math.random() * 6;
                    cumulativeUsage = dayData ? dayData.cumulative : dailyUsage;
                }

                // æ ¹æ®å½“å‰ç±»å‹é€‰æ‹©æ˜¾ç¤ºå€¼
                const displayValue = currentTieredDrawerCalendarType === 'usage' ? dailyUsage : cumulativeUsage;
                const displayUnit = 'kWh';
                const displayFormat = currentTieredDrawerCalendarType === 'usage' ? dailyUsage.toFixed(1) : cumulativeUsage.toFixed(1);

                // æ·»åŠ æœ€é«˜å€¼æ ‡è®°ç‚¹
                let marker = '';
                if (isCurrentMonth) {
                    if (currentTieredDrawerCalendarType === 'usage' && day === maxUsageDay) {
                        marker = `<span class="drawer-max-marker usage-max" title="æœ¬æœˆç”¨ç”µé‡æœ€é«˜">â—</span>`;
                    } else if (currentTieredDrawerCalendarType === 'cumulative' && day === maxCumulativeDay) {
                        marker = `<span class="drawer-max-marker cumulative-max" title="æœ¬æœˆç´¯è®¡æœ€é«˜">â—</span>`;
                    }
                }

                const dayClasses = [
                    'drawer-calendar-day',
                    isOtherMonth ? 'other-month' : ''
                ].filter(Boolean).join(' ');

                calendarHTML += `
                    <div class="${dayClasses}" data-date="${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}" onclick="showTieredCalendarDayDetails('${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}', ${day})">
                        <div class="drawer-day-number">${day}</div>
                        ${marker}
                        ${isCurrentMonth ? `
                            <div class="drawer-day-content">
                                <div class="drawer-day-usage-value">${displayFormat}</div>
                                <div class="drawer-day-unit">${displayUnit}</div>
                            </div>
                        ` : ''}
                    </div>
                `;

                date.setDate(date.getDate() + 1);
            }

            calendarGrid.innerHTML = calendarHTML;

            // æ›´æ–°æ ‡é¢˜
            const calendarTitle = document.getElementById('tiered-drawer-calendar-title');
            if (calendarTitle) {
                const monthNames = currentLanguage === 'zh' ?
                    ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'] :
                    ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                calendarTitle.textContent = currentLanguage === 'zh' ?
                    `2025å¹´${monthNames[currentMonth]}` :
                    `${monthNames[currentMonth]} 2025`;
            }
        }

        // é˜¶æ¢¯ç”µä»·æ—¥å†ç±»å‹è·Ÿè¸ª
        let currentTieredDrawerCalendarType = 'usage';
        let currentTieredCalendarType = 'usage';

        // åˆ‡æ¢é˜¶æ¢¯ç”µä»·æŠ½å±‰æ—¥å†ç±»å‹ - å®Œå…¨å¤åˆ¶åˆ†æ—¶ç”µä»·é€»è¾‘
        function switchTieredDrawerCalendarType(type) {
            currentTieredDrawerCalendarType = type;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.drawer-calendar-toggle-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });

            // é‡æ–°ç”ŸæˆæŠ½å±‰æ—¥å†
            renderTieredDrawerCalendar();
        }

        // æ˜¾ç¤º/åˆ‡æ¢é˜¶æ¢¯ç”µä»·æ—¥æœŸè¯¦æƒ…å¹¶æ‰©å±•/æ”¶ç¼©æŠ½å±‰ - å®Œå…¨å¤åˆ¶åˆ†æ—¶ç”µä»·é€»è¾‘
        function showTieredDayDetails(dateStr) {
            // è§£ææ—¥æœŸ
            const [year, month, day] = dateStr.split('-');
            const date = new Date(year, month - 1, day);
            const monthNames = getMonthNames();

            // æ£€æŸ¥æ˜¯å¦æ˜¯è´¦å•æœˆä»½ï¼ˆ2025å¹´9æœˆï¼‰
            if (parseInt(year) !== 2025 || parseInt(month) !== 9) {
                return; // éè´¦å•æœˆä»½ä¸æ˜¾ç¤ºè¯¦æƒ…
            }

            // æ£€æŸ¥å½“å‰æ˜¯å¦åœ¨æ—¥å†è§†å›¾ï¼Œå¦‚æœæ˜¯ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†è¯¦æƒ…æ˜¾ç¤º
            const currentActiveView = document.querySelector('.drawer-usage-view.active');
            if (currentActiveView && currentActiveView.id === 'tiered-drawer-calendar-view') {
                // åœ¨æ—¥å†è§†å›¾ä¸­ï¼Œåˆ›å»ºä¸´æ—¶è¯¦æƒ…é¢æ¿æ˜¾ç¤ºåœ¨å³ä¾§
                showTieredCalendarDayDetails(dateStr, parseInt(day));
                return;
            }

            const clickedDay = document.querySelector(`[data-date="${dateStr}"]`);
            const isAlreadySelected = clickedDay.classList.contains('selected');

            if (isAlreadySelected) {
                // å¦‚æœå·²ç»é€‰ä¸­ï¼Œåˆ™å–æ¶ˆé€‰æ‹©å¹¶æ”¶èµ·
                closeTieredDrawerHourlyDetails();
            } else {
                // å¦‚æœæœªé€‰ä¸­ï¼Œåˆ™é€‰ä¸­å¹¶å±•å¼€
                // æ›´æ–°é€‰ä¸­çŠ¶æ€ - æ¸…é™¤æ—¥å†å’Œè¡¨æ ¼çš„é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.drawer-calendar-day').forEach(dayEl => {
                    dayEl.classList.remove('selected');
                });
                document.querySelectorAll('.drawer-daily-table-row').forEach(rowEl => {
                    rowEl.classList.remove('selected');
                });

                // é€‰ä¸­å½“å‰ç‚¹å‡»çš„å…ƒç´ ï¼ˆå¯èƒ½æ˜¯æ—¥å†æ—¥æœŸæˆ–è¡¨æ ¼è¡Œï¼‰
                if (clickedDay) {
                    clickedDay.classList.add('selected');
                }

                // æ‰©å±•æŠ½å±‰
                const drawer = document.querySelector('.right-drawer');
                drawer.classList.add('expanded');
                console.log('Drawer expanded in showTieredDayDetails:', drawer);

                // æ— è®ºä»€ä¹ˆè§†å›¾ï¼Œéƒ½ä½¿ç”¨ç›¸åŒçš„è¯¦æƒ…é¢æ¿ç¡®ä¿ä¸€è‡´æ€§
                showTieredDrawerHourlyDetailsCommon(dateStr, parseInt(day));
            }
        }

        function showTieredCalendarDayDetails(dateStr, dayNumber) {
            console.log('showTieredCalendarDayDetails called:', dateStr, dayNumber);

            // è§£ææ—¥æœŸ
            const [year, month, day] = dateStr.split('-');
            const monthNames = getMonthNames();

            // æŸ¥æ‰¾è¢«ç‚¹å‡»çš„æ—¥å†æ ¼å­
            const clickedDay = document.querySelector(`[data-date="${dateStr}"]`);
            const isAlreadySelected = clickedDay && clickedDay.classList.contains('selected');

            if (isAlreadySelected) {
                // å¦‚æœå·²ç»é€‰ä¸­ï¼Œåˆ™å–æ¶ˆé€‰æ‹©å¹¶æ”¶èµ·
                closeTieredCalendarHourlyDetails();
            } else {
                // æ¸…é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.drawer-calendar-day.selected').forEach(day => {
                    day.classList.remove('selected');
                });

                // é€‰ä¸­å½“å‰ç‚¹å‡»çš„æ—¥å†æ ¼å­
                if (clickedDay) {
                    clickedDay.classList.add('selected');
                }

                // æ‰©å±•æŠ½å±‰
                const drawer = document.querySelector('.right-drawer');
                drawer.classList.add('expanded');

                // åŠ¨æ€åˆ›å»ºè¯¦æƒ…é¢æ¿åœ¨æ—¥å†è§†å›¾çš„å³ä¾§
                createTieredCalendarDetailsPanel(dateStr, dayNumber);
            }
        }

        // ä¸ºé˜¶æ¢¯ç”µä»·æ—¥å†è§†å›¾åˆ›å»ºè¯¦æƒ…é¢æ¿
        function createTieredCalendarDetailsPanel(dateStr, dayNumber) {
            // ç§»é™¤ä¹‹å‰çš„è¯¦æƒ…é¢æ¿ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const existingPanel = document.getElementById('tiered-calendar-hourly-details-panel');
            if (existingPanel) {
                existingPanel.remove();
            }

            // è§£ææ—¥æœŸç”¨äºæ ‡é¢˜
            const [year, month, day] = dateStr.split('-');
            const monthNames = getMonthNames();

            // åœ¨æ—¥å†è§†å›¾ä¸­åˆ›å»ºè¯¦æƒ…é¢æ¿
            const calendarView = document.getElementById('tiered-drawer-calendar-view');
            const detailsPanel = document.createElement('div');
            detailsPanel.id = 'tiered-calendar-hourly-details-panel';
            detailsPanel.className = 'drawer-hourly-details-panel';
            detailsPanel.innerHTML = `
                <div class="drawer-hourly-header">
                    <h4>${currentLanguage === 'zh' ?
                        `${year}å¹´${monthNames[parseInt(month) - 1]}${day}æ—¥ â€” æ¯å°æ—¶æ˜ç»†` :
                        `${monthNames[parseInt(month) - 1]} ${day}, ${year} â€” Hourly Details`}</h4>
                    <button class="drawer-hourly-close" onclick="closeTieredCalendarHourlyDetails()">Ã—</button>
                </div>
                <div class="drawer-hourly-content" id="tiered-calendar-hourly-details-content">
                    <!-- æ¯å°æ—¶æ•°æ®å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            `;

            calendarView.appendChild(detailsPanel);

            // ç”Ÿæˆæ¯å°æ—¶æ•°æ®
            setTimeout(() => {
                generateTieredDrawerHourlyData(parseInt(day), 'tiered-calendar-hourly-details-content');
            }, 100);
        }

        // é˜¶æ¢¯ç”µä»·é€šç”¨çš„å°æ—¶è¯¦æƒ…æ˜¾ç¤ºå‡½æ•°
        function showTieredDrawerHourlyDetailsCommon(dateStr, dayNumber) {
            console.log('showTieredDrawerHourlyDetailsCommon called:', dateStr, dayNumber);

            const [year, month, day] = dateStr.split('-');
            const monthNames = getMonthNames();

            // è¿™é‡Œå¯ä»¥æ ¹æ®ä¸åŒè§†å›¾ä½¿ç”¨ä¸åŒçš„è¯¦æƒ…é¢æ¿
            const currentActiveView = document.querySelector('.drawer-usage-view.active');
            let panelId = 'tiered-drawer-hourly-details-panel';
            let titleId = 'tiered-drawer-selected-date-title';
            let panelContentId = 'tiered-drawer-hourly-details-content';

            if (currentActiveView) {
                if (currentActiveView.id === 'tiered-drawer-table-view') {
                    // è¡¨æ ¼è§†å›¾ä½¿ç”¨è¡¨æ ¼ç‰¹å®šçš„é¢æ¿ID
                    const hourlyPanel = document.getElementById(panelId);
                    if (hourlyPanel) {
                        hourlyPanel.style.display = 'block';
                    }
                } else if (currentActiveView.id === 'tiered-drawer-calendar-view') {
                    // æ—¥å†è§†å›¾ä¼šåŠ¨æ€åˆ›å»ºé¢æ¿ï¼Œä¸éœ€è¦åœ¨è¿™é‡Œå¤„ç†
                    return;
                }
            }

            // æ›´æ–°æ ‡é¢˜
            const dateTitle = document.getElementById(titleId);
            if (dateTitle) {
                dateTitle.setAttribute('data-zh', `${year}å¹´${monthNames[parseInt(month) - 1]}${day}æ—¥ â€” æ¯å°æ—¶æ˜ç»†`);
                dateTitle.setAttribute('data-en', `${monthNames[parseInt(month) - 1]} ${day}, ${year} â€” Hourly Details`);
                dateTitle.textContent = `${year}å¹´${monthNames[parseInt(month) - 1]}${day}æ—¥ â€” æ¯å°æ—¶æ˜ç»†`;
            }

            // ç­‰å¾…DOMæ›´æ–°åç”Ÿæˆæ¯å°æ—¶æ•°æ®
            setTimeout(() => {
                console.log('Calling generateTieredDrawerHourlyData for day:', parseInt(day));
                generateTieredDrawerHourlyData(parseInt(day), panelContentId);
            }, 100);
        }

        // å…³é—­é˜¶æ¢¯ç”µä»·é€šç”¨è¯¦æƒ…é¢æ¿
        function closeTieredDrawerHourlyDetails() {
            // æ”¶ç¼©æŠ½å±‰
            const drawer = document.querySelector('.right-drawer');
            drawer.classList.remove('expanded');

            // éšè—è¯¦æƒ…é¢æ¿
            const hourlyPanel = document.getElementById('tiered-drawer-hourly-details-panel');
            if (hourlyPanel) {
                hourlyPanel.style.display = 'none';
            }

            // æ¸…é™¤é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.drawer-calendar-day.selected').forEach(day => {
                day.classList.remove('selected');
            });
            document.querySelectorAll('.drawer-daily-table-row.selected').forEach(row => {
                row.classList.remove('selected');
            });
        }

        // å…³é—­é˜¶æ¢¯ç”µä»·æ—¥å†è¯¦æƒ…é¢æ¿
        function closeTieredCalendarHourlyDetails() {
            // æ”¶ç¼©æŠ½å±‰
            const drawer = document.querySelector('.right-drawer');
            drawer.classList.remove('expanded');

            // ç§»é™¤è¯¦æƒ…é¢æ¿
            const detailsPanel = document.getElementById('tiered-calendar-hourly-details-panel');
            if (detailsPanel) {
                detailsPanel.remove();
            }

            // æ¸…é™¤é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.drawer-calendar-day.selected').forEach(day => {
                day.classList.remove('selected');
            });
        }

        // ç”Ÿæˆé˜¶æ¢¯ç”µä»·æ¯å°æ—¶æ•°æ® - å®Œå…¨å¤åˆ¶åˆ†æ—¶ç”µä»·çš„é€»è¾‘
        function generateTieredDrawerHourlyData(day, contentId = 'tiered-drawer-hourly-details-content', retryCount = 0) {
            console.log('generateTieredDrawerHourlyData called with day:', day, 'contentId:', contentId, 'retry:', retryCount);
            const hourlyContent = document.getElementById(contentId);
            console.log('hourlyContent element:', hourlyContent);

            if (!hourlyContent) {
                console.error('hourlyContent element not found!');
                if (retryCount < 3) {
                    console.log('Retrying in 200ms...');
                    setTimeout(() => {
                        generateTieredDrawerHourlyData(day, contentId, retryCount + 1);
                    }, 200);
                }
                return;
            }

            // è·å–è¯¥å¤©çš„æ•°æ®
            const dayData = window.currentTieredData?.find(d => d.day === day);
            if (!dayData) {
                console.error('Day data not found for:', day);
                return;
            }

            const dailyUsage = parseFloat(dayData.usage);
            const tier = dayData.tier;

            // é˜¶æ¢¯ç”µä»·è´¹ç‡
            const tierRates = {
                1: { rate: 3.35, name: currentLanguage === 'zh' ? 'ç¬¬ä¸€é˜¶æ¢¯' : 'Tier 1' },
                2: { rate: 4.60, name: currentLanguage === 'zh' ? 'ç¬¬äºŒé˜¶æ¢¯' : 'Tier 2' },
                3: { rate: 6.85, name: currentLanguage === 'zh' ? 'ç¬¬ä¸‰é˜¶æ¢¯' : 'Tier 3' },
                4: { rate: 8.50, name: currentLanguage === 'zh' ? 'ç¬¬å››é˜¶æ¢¯' : 'Tier 4' }
            };

            // ç”Ÿæˆç®€å•çš„24å°æ—¶æ•°æ®è¡¨æ ¼ï¼Œæ˜¾ç¤ºæ—¶é—´ã€ç”µé‡ã€ç´¯è®¡ä¸‰åˆ—
            let hourlyHTML = `
                <table class="simple-hourly-table">
                    <tr>
                        <th>${currentLanguage === 'zh' ? 'æ—¶é—´' : 'Time'}</th>
                        <th>${currentLanguage === 'zh' ? 'ç”µé‡' : 'Usage'}</th>
                        <th>${currentLanguage === 'zh' ? 'ç´¯è®¡' : 'Cumulative'}</th>
                    </tr>
            `;

            // å…ˆç”Ÿæˆæ‰€æœ‰å°æ—¶çš„æ•°æ®
            let allHours = [];
            let cumulativeUsage = 0; // å½“æ—¥ç´¯è®¡ç”¨ç”µé‡

            for (let hour = 0; hour < 24; hour++) {
                // æ¨¡æ‹Ÿç”¨ç”µé‡ - åŸºäºè¯¥å¤©æ€»ç”¨é‡åˆ†é…åˆ°24å°æ—¶
                const baseUsage = dailyUsage / 24 + Math.sin((hour + day) * 0.3) * (dailyUsage / 48) + Math.random() * (dailyUsage / 48);
                const usage = Math.max(0.1, baseUsage);
                cumulativeUsage += usage; // ç´¯åŠ å½“æ—¥ç”¨ç”µé‡

                allHours.push({
                    hour: hour,
                    timeStr: `${hour.toString().padStart(2, '0')}:00`,
                    usage: usage,
                    cumulative: cumulativeUsage
                });
            }

            // ç”Ÿæˆè¡¨æ ¼è¡Œ
            for (let i = 0; i < allHours.length; i++) {
                const hourData = allHours[i];

                hourlyHTML += `
                    <tr>
                        <td>${hourData.timeStr}</td>
                        <td>${hourData.usage.toFixed(2)} kWh</td>
                        <td>${hourData.cumulative.toFixed(2)} kWh</td>
                    </tr>
                `;
            }

            hourlyHTML += `</table>`;

            console.log('Setting hourlyHTML:', hourlyHTML);
            hourlyContent.innerHTML = hourlyHTML;
            console.log('Content set, element innerHTML length:', hourlyContent.innerHTML.length);
        }

        // å¯¼å‡ºé˜¶æ¢¯ç”µä»·æŠ½å±‰æ•°æ®
        function exportTieredDrawerData() {
            console.log('exportTieredDrawerData called');

            const data = window.currentTieredData || [];
            if (data.length === 0) {
                EnergySystem.showNotification('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®', 'warning');
                return;
            }

            // åˆ›å»ºCSVå†…å®¹
            const headers = ['æ—¥æœŸ', 'æ—¥ç”¨ç”µé‡(kWh)', 'ç´¯è®¡ç”¨ç”µé‡(kWh)', 'æ‰€å±é˜¶æ¢¯'];
            let csvContent = headers.join(',') + '\n';

            data.forEach(row => {
                const csvRow = [
                    row.date,
                    row.usage,
                    row.cumulative,
                    `ç¬¬${row.tier}é˜¶æ¢¯`
                ].join(',');
                csvContent += csvRow + '\n';
            });

            // åˆ›å»ºå¹¶ä¸‹è½½æ–‡ä»¶
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'ç”µé‡è´¹æ˜ç»†_2025å¹´9æœˆ.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            EnergySystem.showNotification('æ•°æ®å¯¼å‡ºæˆåŠŸ', 'success');
        }

        // é˜¶æ¢¯ç”µä»·è¡¨æ ¼è¡Œé«˜äº®å‡½æ•°
        function highlightSelectedDateInTieredTable(dateStr) {
            console.log('Highlighting date in tiered table:', dateStr);

            // ç¡®ä¿è¡¨æ ¼è¡Œå·²ç»è¢«é€‰ä¸­ï¼ˆè¿™åº”è¯¥å·²ç»åœ¨showTieredDayDetailsä¸­å®Œæˆäº†ï¼‰
            const selectedRow = document.querySelector(`.tiered-drawer-daily-table-row[data-date="${dateStr}"]`);
            if (selectedRow) {
                selectedRow.classList.add('selected');
                console.log('Tiered table row highlighted:', selectedRow);

                // æ»šåŠ¨åˆ°é€‰ä¸­çš„è¡Œï¼ˆå¦‚æœè¡¨æ ¼å¾ˆé•¿çš„è¯ï¼‰
                selectedRow.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });
            } else {
                console.warn('Tiered table row not found for date:', dateStr);
            }
        }

        // ç”Ÿæˆé˜¶æ¢¯ç”µä»·æŠ½å±‰è¡¨æ ¼è§†å›¾æ•°æ®
        function generateTieredDrawerTableData(day) {
            console.log('generateTieredDrawerTableData called with day:', day);
            const tableBody = document.getElementById('tiered-drawer-table-body');

            if (!tableBody) {
                console.error('tiered-drawer-table-body element not found!');
                return;
            }

            // è·å–è¯¥å¤©çš„æ•°æ®
            const dayData = window.currentTieredData?.find(d => d.day === day);
            if (!dayData) {
                console.error('Day data not found for:', day);
                return;
            }

            // ç”Ÿæˆè¡¨æ ¼HTML
            let tableHTML = `
                <div class="tiered-drawer-daily-table-row selected-day-row" onclick="toggleTieredDrawerDayDetails(${day})">
                    <span class="expand-icon" id="tiered-expand-icon-${day}">â–¼</span>
                    <span>${dayData.date}</span>
                    <span>${dayData.usage} kWh</span>
                    <span>â‚¹${dayData.amount}</span>
                </div>
                <div class="tiered-drawer-hourly-details-row expanded" id="tiered-drawer-hourly-details-${day}">
                    <div class="tiered-drawer-hourly-grid" id="tiered-drawer-hourly-grid-${day}">
                        <!-- æ¯å°æ—¶æ•°æ®å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
                    </div>
                </div>
            `;

            tableBody.innerHTML = tableHTML;

            // ç«‹å³ç”Ÿæˆé€‰ä¸­æ—¥æœŸçš„æ¯å°æ—¶è¯¦æƒ…
            setTimeout(() => {
                generateTieredDrawerHourlyData(day, `tiered-drawer-hourly-grid-${day}`);
            }, 100);
        }

        // é˜¶æ¢¯ç”µä»·åˆ‡æ¢æ—¥è¯¦æƒ…å±•å¼€/æ”¶èµ·
        function toggleTieredDrawerDayDetails(day) {
            console.log('é˜¶æ¢¯ç”µä»·ç‚¹å‡»å±•å¼€æ—¥æœŸ:', day);
            const detailsRow = document.getElementById(`tiered-drawer-hourly-details-${day}`);
            const expandIcon = document.getElementById(`tiered-expand-icon-${day}`);

            console.log('é˜¶æ¢¯è¯¦æƒ…è¡Œ:', detailsRow);
            console.log('é˜¶æ¢¯å±•å¼€å›¾æ ‡:', expandIcon);

            if (!detailsRow || !expandIcon) {
                console.error('æœªæ‰¾åˆ°é˜¶æ¢¯ç›¸å…³å…ƒç´ ');
                return;
            }

            if (detailsRow.style.display === 'none' || detailsRow.style.display === '') {
                // å…³é—­å…¶ä»–å·²æ‰“å¼€çš„è¯¦æƒ…
                document.querySelectorAll('.tiered-drawer-hourly-details-row').forEach(row => {
                    row.style.display = 'none';
                });
                document.querySelectorAll('.tiered-drawer-expand-icon').forEach(icon => {
                    icon.textContent = 'â–¶';
                    icon.style.transform = 'rotate(0deg)';
                });

                // æ‰“å¼€å½“å‰è¯¦æƒ…
                detailsRow.style.display = 'block';
                expandIcon.textContent = 'â–¼';
                expandIcon.style.transform = 'rotate(0deg)';

                // ç”Ÿæˆæ¯å°æ—¶æ•°æ®
                generateTieredDrawerHourlyDataOld(day);
            } else {
                // å…³é—­å½“å‰è¯¦æƒ…
                detailsRow.style.display = 'none';
                expandIcon.textContent = 'â–¶';
                expandIcon.style.transform = 'rotate(0deg)';
            }
        }

        // ç”Ÿæˆé˜¶æ¢¯ç”µä»·æŠ½å±‰ä¸­çš„æ¯å°æ—¶ç”¨ç”µæ•°æ®ï¼ˆæ—§è¡¨æ ¼å±•å¼€åŠŸèƒ½ï¼‰
        function generateTieredDrawerHourlyDataOld(day) {
            const hourlyBody = document.getElementById(`tiered-drawer-hourly-body-${day}`);

            // è·å–è¯¥å¤©çš„æ•°æ®
            const dayData = window.currentTieredData?.find(d => d.day === day);
            if (!dayData) {
                console.error('Day data not found for:', day);
                return;
            }

            const dailyUsage = parseFloat(dayData.usage);
            const tier = dayData.tier;

            // é˜¶æ¢¯ç”µä»·è´¹ç‡
            const tierRates = {
                1: { rate: 3.35, name: currentLanguage === 'zh' ? 'ç¬¬ä¸€é˜¶æ¢¯' : 'Tier 1' },
                2: { rate: 4.60, name: currentLanguage === 'zh' ? 'ç¬¬äºŒé˜¶æ¢¯' : 'Tier 2' },
                3: { rate: 6.85, name: currentLanguage === 'zh' ? 'ç¬¬ä¸‰é˜¶æ¢¯' : 'Tier 3' },
                4: { rate: 8.50, name: currentLanguage === 'zh' ? 'ç¬¬å››é˜¶æ¢¯' : 'Tier 4' }
            };

            const tierInfo = tierRates[tier];
            const tierName = tierInfo.name;
            const rate = tierInfo.rate;

            // ç”Ÿæˆ24å°æ—¶æ•°æ®ï¼Œæ˜¾ç¤ºæ—¶é—´ã€ç”µé‡ã€ç´¯è®¡ä¸‰åˆ—
            let hourlyHTML = '';
            let cumulativeUsage = 0; // å½“æ—¥ç´¯è®¡ç”¨ç”µé‡

            for (let hour = 0; hour < 24; hour++) {
                // æ¨¡æ‹Ÿç”¨ç”µé‡ - åŸºäºè¯¥å¤©æ€»ç”¨é‡åˆ†é…åˆ°24å°æ—¶
                const baseUsage = dailyUsage / 24 + Math.sin((hour + day) * 0.3) * (dailyUsage / 48) + Math.random() * (dailyUsage / 48);
                const usage = Math.max(0.1, baseUsage);
                cumulativeUsage += usage; // ç´¯åŠ å½“æ—¥ç”¨ç”µé‡

                hourlyHTML += `
                    <div class="tiered-drawer-hourly-row">
                        <span class="tiered-drawer-hour-time">${hour.toString().padStart(2, '0')}:00</span>
                        <span class="tiered-drawer-hour-usage">${usage.toFixed(2)} kWh</span>
                        <span class="tiered-drawer-hour-cumulative">${cumulativeUsage.toFixed(2)} kWh</span>
                    </div>
                `;
            }

            hourlyBody.innerHTML = hourlyHTML;
        }

        // å¤åˆ¶é˜¶æ¢¯ç”µä»·æ•°æ®åˆ°æŠ½å±‰è¡¨æ ¼
        function copyTieredPricingToDrawerTable() {
            console.log('copyTieredPricingToDrawerTable called');
            const drawerTableBody = document.getElementById('tiered-drawer-table-body');
            console.log('tieredDrawerTableBody:', drawerTableBody);
            console.log('window.currentTieredData:', window.currentTieredData);

            if (!drawerTableBody) {
                console.error('tiered-drawer-table-body not found!');
                return;
            }

            // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œç”Ÿæˆæ¨¡æ‹Ÿæ•°æ® - ç¡®ä¿ç”Ÿæˆ2025å¹´9æœˆçš„æ‰€æœ‰30å¤©
            let tieredData = window.currentTieredData;
            if (!tieredData || tieredData.length === 0) {
                console.log('Generating mock tiered data...');
                tieredData = [];
                const daysInSeptember = new Date(2025, 9, 0).getDate(); // 2025å¹´9æœˆçš„å¤©æ•° (30å¤©)
                let cumulativeUsage = 0;
                for (let day = 1; day <= daysInSeptember; day++) {
                    const usage = 15 + Math.sin(day * 0.3) * 8 + Math.random() * 6;
                    cumulativeUsage += usage;
                    let tier = 1;
                    if (cumulativeUsage > 300) tier = 4;
                    else if (cumulativeUsage > 200) tier = 3;
                    else if (cumulativeUsage > 100) tier = 2;

                    const tierRates = { 1: 3.35, 2: 4.60, 3: 6.85, 4: 8.50 };
                    const cost = usage * tierRates[tier];

                    tieredData.push({
                        day: day,
                        date: `2025-09-${day.toString().padStart(2, '0')}`,
                        usage: usage.toFixed(2),
                        cumulative: cumulativeUsage.toFixed(2),
                        tier: tier,
                        amount: cost.toFixed(2)
                    });
                }
                window.currentTieredData = tieredData;
                console.log('Generated tiered data for', daysInSeptember, 'days');
            }

            // ç”Ÿæˆè¡¨æ ¼è¡Œï¼Œç‚¹å‡»ååœ¨å³ä¾§æ˜¾ç¤ºè¯¦æƒ…é¢æ¿ï¼ˆä¸æ˜¯ä¸‹æ–¹å±•å¼€ï¼‰
            drawerTableBody.innerHTML = '';
            console.log('Tiered data length:', tieredData.length);

            // æ˜¾ç¤ºæ‰€æœ‰30å¤©çš„æ•°æ®ï¼Œé€šè¿‡æ»šåŠ¨æŸ¥çœ‹
            tieredData.forEach(dayData => {
                console.log('Processing tiered day:', dayData);
                // åˆ›å»ºä¸»è¡Œ
                const newRow = document.createElement('div');
                newRow.className = 'drawer-daily-table-row';
                newRow.style.cursor = 'pointer';
                newRow.setAttribute('data-date', dayData.date);

                // ä½¿ç”¨tieredDataç”Ÿæˆè¡Œæ•°æ® - å¯¹åº”è¡¨æ ¼å¤´éƒ¨çš„4åˆ—
                newRow.innerHTML = `
                        <span class="drawer-date-cell">${dayData.date}</span>
                        <span class="drawer-usage-cell">${parseFloat(dayData.usage).toFixed(1)} kWh</span>
                        <span class="drawer-cumulative-cell">${parseFloat(dayData.cumulative).toFixed(1)} kWh</span>
                        <span class="drawer-tier-cell">${currentLanguage === 'zh' ? `ç¬¬${dayData.tier}é˜¶æ¢¯` : `Tier ${dayData.tier}`}</span>
                        <span class="drawer-expand-icon">â–¶</span>
                `;

                // æ·»åŠ ç‚¹å‡»äº‹ä»¶ - ç‚¹å‡»ååœ¨å³ä¾§æ˜¾ç¤ºè¯¦æƒ…é¢æ¿
                newRow.addEventListener('click', function() {
                    console.log('Tiered table row clicked, date:', dayData.date);
                    // ä½¿ç”¨é˜¶æ¢¯ç”µä»·ä¸“é—¨çš„è¡¨æ ¼è¡Œå¤„ç†å‡½æ•°
                    showTieredTableRowDetails(dayData.date, dayData.day);
                });

                drawerTableBody.appendChild(newRow);
            });

            console.log('Tiered table rows generated:', tieredData.length);
        }

        // é˜¶æ¢¯ç”µä»·ç‰ˆæœ¬çš„é€šç”¨æ—¥è¯¦æƒ…æ˜¾ç¤ºå‡½æ•°
        function showTieredDayDetails(dateStr, dayNumber) {
            console.log('showTieredDayDetails called:', dateStr, dayNumber);

            // è§£ææ—¥æœŸ
            const [year, month, day] = dateStr.split('-');
            const monthNames = getMonthNames();

            // æ£€æŸ¥æ˜¯å¦æ˜¯è´¦å•æœˆä»½ï¼ˆ2025å¹´9æœˆï¼‰
            if (parseInt(year) !== 2025 || parseInt(month) !== 9) {
                return; // éè´¦å•æœˆä»½ä¸æ˜¾ç¤ºè¯¦æƒ…
            }

            // æ¸…é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.drawer-calendar-day').forEach(dayEl => {
                dayEl.classList.remove('selected');
            });
            document.querySelectorAll('.drawer-daily-table-row').forEach(rowEl => {
                rowEl.classList.remove('selected');
            });
            document.querySelectorAll('.tiered-drawer-daily-table-row').forEach(rowEl => {
                rowEl.classList.remove('selected');
            });

            // æŸ¥æ‰¾è¢«ç‚¹å‡»çš„å…ƒç´ 
            const clickedDay = document.querySelector(`[data-date="${dateStr}"]`);
            const isAlreadySelected = clickedDay && clickedDay.classList.contains('selected');

            if (isAlreadySelected) {
                // å¦‚æœå·²ç»é€‰ä¸­ï¼Œåˆ™å–æ¶ˆé€‰æ‹©å¹¶æ”¶èµ·
                closeTieredDrawerHourlyDetails();
            } else {
                // é€‰ä¸­å½“å‰ç‚¹å‡»çš„å…ƒç´ ï¼ˆå¯èƒ½æ˜¯æ—¥å†æ—¥æœŸæˆ–è¡¨æ ¼è¡Œï¼‰
                if (clickedDay) {
                    clickedDay.classList.add('selected');
                }

                // æ‰©å±•æŠ½å±‰
                const drawer = document.querySelector('.right-drawer');
                drawer.classList.add('expanded');
                console.log('Tiered drawer expanded:', drawer);

                // ä½¿ç”¨é˜¶æ¢¯ç”µä»·ä¸“ç”¨çš„è¯¦æƒ…é¢æ¿
                let hourlyPanel = document.getElementById('tiered-drawer-hourly-details-panel');
                let panelContentId = 'tiered-drawer-hourly-details-content';
                let titleId = 'tiered-drawer-selected-date-title';

                if (hourlyPanel) {
                    hourlyPanel.style.display = 'block';
                    console.log('Tiered hourly panel displayed:', hourlyPanel);
                } else {
                    console.error('Tiered hourly panel not found!');
                }

                // ä¿æŒç”¨æˆ·å½“å‰é€‰æ‹©çš„è§†å›¾ï¼Œä¸å¼ºåˆ¶è·³è½¬
                // æ£€æŸ¥å½“å‰æ¿€æ´»çš„è§†å›¾
                const currentActiveView = document.querySelector('.drawer-usage-view.active');
                let currentViewType = 'chart'; // é»˜è®¤å›¾è¡¨è§†å›¾

                console.log('Current active view:', currentActiveView);

                if (currentActiveView) {
                    if (currentActiveView.id === 'tiered-drawer-chart-view') {
                        currentViewType = 'chart';
                    } else if (currentActiveView.id === 'tiered-drawer-calendar-view') {
                        currentViewType = 'calendar';
                    } else if (currentActiveView.id === 'tiered-drawer-table-view') {
                        currentViewType = 'table';
                    }
                }

                console.log('Determined view type:', currentViewType);

                // æ¿€æ´»å½“å‰è§†å›¾ï¼ˆå¦‚æœæ˜¯æ—¥å†è§†å›¾ï¼Œä¼šè‡ªåŠ¨è®¾ç½®ä¸ºå·¦å³å¸ƒå±€ï¼‰
                switchTieredDrawerView(currentViewType);

                // æ›´æ–°æ ‡é¢˜
                const dateTitle = document.getElementById(titleId);
                if (dateTitle) {
                    dateTitle.setAttribute('data-zh', `${year}å¹´${monthNames[parseInt(month) - 1]}${day}æ—¥ â€” æ¯å°æ—¶æ˜ç»†`);
                    dateTitle.setAttribute('data-en', `${monthNames[parseInt(month) - 1]} ${day}, ${year} â€” Hourly Details`);
                    dateTitle.textContent = currentLanguage === 'zh' ?
                        `${year}å¹´${monthNames[parseInt(month) - 1]}${day}æ—¥ â€” æ¯å°æ—¶æ˜ç»†` :
                        `${monthNames[parseInt(month) - 1]} ${day}, ${year} â€” Hourly Details`;
                }

                // ç­‰å¾…DOMæ›´æ–°åç”Ÿæˆæ¯å°æ—¶æ•°æ®
                setTimeout(() => {
                    console.log('Calling generateTieredDrawerHourlyData for day:', parseInt(day));
                    generateTieredDrawerHourlyData(parseInt(day), panelContentId);

                    // å¦‚æœå½“å‰åœ¨è¡¨æ ¼è§†å›¾ï¼Œç¡®ä¿é€‰ä¸­æ—¥æœŸçš„è¡Œè¢«æ­£ç¡®æ ‡è®°å’Œå±•å¼€
                    if (currentViewType === 'table') {
                        highlightSelectedDateInTieredTable(dateStr);
                    }
                }, 500);
            }
        }

        // é˜¶æ¢¯ç”µä»·è¡¨æ ¼è¡Œä¸“ç”¨çš„è¯¦æƒ…å±•å¼€å‡½æ•°
        function showTieredTableRowDetails(dateStr, dayNumber) {
            console.log('showTieredTableRowDetails called:', dateStr, dayNumber);

            // è§£ææ—¥æœŸ
            const [year, month, day] = dateStr.split('-');
            const monthNames = getMonthNames();

            // æ£€æŸ¥æ˜¯å¦æ˜¯è´¦å•æœˆä»½ï¼ˆ2025å¹´9æœˆï¼‰
            if (parseInt(year) !== 2025 || parseInt(month) !== 9) {
                return; // éè´¦å•æœˆä»½ä¸æ˜¾ç¤ºè¯¦æƒ…
            }

            // æŸ¥æ‰¾è¢«ç‚¹å‡»çš„è¡¨æ ¼è¡Œ
            const clickedRow = document.querySelector(`[data-date="${dateStr}"]`);
            const isAlreadySelected = clickedRow && clickedRow.classList.contains('selected');

            if (isAlreadySelected) {
                // å¦‚æœå·²ç»é€‰ä¸­ï¼Œåˆ™å–æ¶ˆé€‰æ‹©å¹¶æ”¶èµ·
                closeTieredDrawerHourlyDetails();
            } else {
                // æ¸…é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.drawer-calendar-day').forEach(dayEl => {
                    dayEl.classList.remove('selected');
                });
                document.querySelectorAll('.drawer-daily-table-row').forEach(rowEl => {
                    rowEl.classList.remove('selected');
                });

                // é€‰ä¸­å½“å‰ç‚¹å‡»çš„è¡¨æ ¼è¡Œ
                if (clickedRow) {
                    clickedRow.classList.add('selected');
                }

                // æ‰©å±•æŠ½å±‰
                const drawer = document.querySelector('.right-drawer');
                drawer.classList.add('expanded');

                // æ˜¾ç¤ºæ¯å°æ—¶è¯¦æƒ…é¢æ¿
                const hourlyPanel = document.getElementById('tiered-drawer-hourly-details-panel');
                hourlyPanel.style.display = 'block';

                // CSSè§„åˆ™ä¼šè‡ªåŠ¨å¤„ç†å±•å¼€çŠ¶æ€çš„flexå¸ƒå±€
                console.log('Tiered drawer expanded, CSS will handle flex layout');

                // æ›´æ–°è¯¦æƒ…é¢æ¿æ ‡é¢˜
                const dateTitle = document.getElementById('tiered-drawer-selected-date-title');
                if (dateTitle) {
                    dateTitle.setAttribute('data-zh', `${year}å¹´${monthNames[parseInt(month) - 1]}${day}æ—¥ â€” æ¯å°æ—¶æ˜ç»†`);
                    dateTitle.setAttribute('data-en', `${monthNames[parseInt(month) - 1]} ${day}, ${year} â€” Hourly Details`);
                    dateTitle.textContent = currentLanguage === 'zh' ?
                        `${year}å¹´${monthNames[parseInt(month) - 1]}${day}æ—¥ â€” æ¯å°æ—¶æ˜ç»†` :
                        `${monthNames[parseInt(month) - 1]} ${day}, ${year} â€” Hourly Details`;
                }

                // ç­‰å¾…DOMæ›´æ–°åç”Ÿæˆæ¯å°æ—¶æ•°æ®
                setTimeout(() => {
                    console.log('Calling generateTieredDrawerHourlyData for table row, day:', parseInt(day));
                    generateTieredDrawerHourlyData(parseInt(day), 'tiered-drawer-hourly-details-content');

                    // ç¡®ä¿é€‰ä¸­æ—¥æœŸçš„è¡Œè¢«æ­£ç¡®æ ‡è®°å’Œå±•å¼€
                    highlightSelectedDateInTieredTable(dateStr);
                }, 100);
            }
        }

        // å¤åˆ¶æ•°æ®åˆ°æŠ½å±‰
        function copyTimeOfUsePricingToDrawer() {
            // ç›´æ¥ç”Ÿæˆè¡¨æ ¼æ•°æ®ï¼Œå› ä¸ºdaily-usage-moduleå·²è¢«åˆ é™¤
            console.log('copyTimeOfUsePricingToDrawer called');
            const drawerTableBody = document.getElementById('drawer-table-body');
            console.log('drawerTableBody:', drawerTableBody);
            console.log('window.currentDailyData:', window.currentDailyData);

            if (!drawerTableBody) {
                console.error('drawer-table-body not found!');
                return;
            }

            // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œç”Ÿæˆæ¨¡æ‹Ÿæ•°æ® - ç¡®ä¿ç”Ÿæˆ2025å¹´9æœˆçš„æ‰€æœ‰30å¤©
            let dailyData = window.currentDailyData;
            if (!dailyData || dailyData.length === 0) {
                console.log('Generating mock daily data...');
                dailyData = [];
                const daysInSeptember = new Date(2025, 9, 0).getDate(); // 2025å¹´9æœˆçš„å¤©æ•° (30å¤©)
                for (let day = 1; day <= daysInSeptember; day++) {
                    const usage = 15 + Math.sin(day * 0.3) * 8 + Math.random() * 6;
                    const cost = usage * 4.5;
                    dailyData.push({
                        day: day,
                        date: `2025-09-${day.toString().padStart(2, '0')}`,
                        usage: usage.toFixed(2),
                        cost: cost.toFixed(2)
                    });
                }
                window.currentDailyData = dailyData;
                console.log('Generated data for', daysInSeptember, 'days');
            }

            // ç”Ÿæˆè¡¨æ ¼è¡Œï¼Œå¹¶æ·»åŠ æŠ½å±‰ç‰¹æœ‰çš„å±•å¼€åŠŸèƒ½
            drawerTableBody.innerHTML = '';
            console.log('Daily data length:', dailyData.length);
            let dayCounter = 1;

            dailyData.forEach(dayData => {
                console.log('Processing day:', dayData);
                // åˆ›å»ºä¸»è¡Œ
                const newRow = document.createElement('div');
                newRow.className = 'drawer-daily-table-row';
                newRow.style.cursor = 'pointer';
                newRow.setAttribute('data-date', dayData.date);

                // ä½¿ç”¨dailyDataç”Ÿæˆè¡Œæ•°æ®
                newRow.innerHTML = `
                        <span class="drawer-date-cell">${dayData.date}</span>
                        <span class="drawer-usage-cell">${parseFloat(dayData.usage).toFixed(1)} kWh</span>
                        <span class="drawer-cost-cell">â‚¹${parseFloat(dayData.cost).toFixed(2)}</span>
                        <span class="drawer-expand-icon" id="drawer-expand-icon-${dayCounter}">â–¶</span>
                `;

                // æ·»åŠ ç‚¹å‡»äº‹ä»¶ - ä½¿ç”¨ç«‹å³æ‰§è¡Œå‡½æ•°æ•è·dayCounterå€¼
                (function(currentDay, currentDate) {
                    newRow.addEventListener('click', function() {
                        console.log('Table row clicked, day:', currentDay, 'date:', currentDate);
                        // ä½¿ç”¨ä¸“é—¨çš„è¡¨æ ¼è¡Œå±•å¼€é€»è¾‘ï¼Œä¸åˆ‡æ¢è§†å›¾
                        showTableRowDetails(currentDate, currentDay);
                    });
                })(dayCounter, dayData.date);

                // åˆ›å»ºå±•å¼€è¯¦æƒ…è¡Œ
                const detailsRow = document.createElement('div');
                detailsRow.className = 'drawer-hourly-details-row';
                detailsRow.id = `drawer-hourly-details-${dayCounter}`;
                detailsRow.style.display = 'none';
                detailsRow.innerHTML = `
                        <div class="drawer-hourly-content">
                            <div class="drawer-hourly-table">
                                <div class="drawer-hourly-table-header">
                                    <span data-zh="æ—¶é—´" data-en="Time">æ—¶é—´</span>
                                    <span data-zh="æ—¶æ®µ" data-en="Period">æ—¶æ®µ</span>
                                    <span data-zh="ç”¨ç”µé‡" data-en="Usage">ç”¨ç”µé‡</span>
                                    <span data-zh="å•ä»·" data-en="Rate">å•ä»·</span>
                                    <span data-zh="é‡‘é¢" data-en="Amount">é‡‘é¢</span>
                                </div>
                                <div class="drawer-hourly-table-body" id="drawer-hourly-body-${dayCounter}">
                                    <!-- æ¯å°æ—¶æ•°æ®ç”±JavaScriptç”Ÿæˆ -->
                                </div>
                            </div>
                        </div>
                `;

                drawerTableBody.appendChild(newRow);
                drawerTableBody.appendChild(detailsRow);
                dayCounter++;
            });

            // è¡¨æ ¼æ•°æ®ç”Ÿæˆå®Œæˆï¼Œä¸éœ€è¦ç”Ÿæˆå…¶ä»–è§†å›¾çš„æ•°æ®
        }

        // æŠ½å±‰è§†å›¾åˆ‡æ¢åŠŸèƒ½
        function switchDrawerView(viewType) {
            console.log('Switching to view:', viewType); // è°ƒè¯•æ—¥å¿—

            // æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­çš„æ—¥æœŸï¼ˆå±•å¼€çŠ¶æ€ï¼‰
            const selectedCalendarDay = document.querySelector('.drawer-calendar-day.selected');
            const selectedTableRow = document.querySelector('.drawer-daily-table-row.selected');
            const isExpanded = selectedCalendarDay !== null || selectedTableRow !== null;

            // æ£€æŸ¥è¯¦æƒ…é¢æ¿æ˜¯å¦å¯è§
            const hourlyPanel = document.getElementById('drawer-hourly-details-panel');
            const isPanelVisible = hourlyPanel && hourlyPanel.style.display === 'block';

            // è§†å›¾åˆ‡æ¢æ—¶çš„æ¸…ç†å·¥ä½œ
            const drawer = document.querySelector('.right-drawer');

            if (viewType === 'calendar') {
                console.log('Calendar view selected - clearing selections but keeping drawer state');

                // éšè—è¡¨æ ¼è¯¦æƒ…é¢æ¿
                if (hourlyPanel) hourlyPanel.style.display = 'none';

                // æ¸…é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.drawer-calendar-day.selected').forEach(day => {
                    day.classList.remove('selected');
                });
                document.querySelectorAll('.drawer-daily-table-row.selected').forEach(row => {
                    row.classList.remove('selected');
                });

                // å¦‚æœå½“å‰æœ‰å±•å¼€çŠ¶æ€ï¼Œæ”¶èµ·æŠ½å±‰æ¢å¤çª„å®½åº¦
                if (drawer.classList.contains('expanded')) {
                    drawer.classList.remove('expanded');
                    console.log('Calendar view selected - drawer collapsed to narrow width');
                }
            } else {
                // åˆ‡æ¢åˆ°éæ—¥å†è§†å›¾æ—¶ï¼Œæ¸…ç†æ—¥å†è¯¦æƒ…é¢æ¿
                const calendarDetailsPanel = document.getElementById('calendar-hourly-details-panel');
                if (calendarDetailsPanel) {
                    calendarDetailsPanel.remove();
                }

                // éšè—è¡¨æ ¼è¯¦æƒ…é¢æ¿
                if (hourlyPanel) hourlyPanel.style.display = 'none';

                // æ¸…é™¤é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.drawer-calendar-day.selected').forEach(day => {
                    day.classList.remove('selected');
                });
                document.querySelectorAll('.drawer-daily-table-row.selected').forEach(row => {
                    row.classList.remove('selected');
                });

                // æ”¶èµ·æŠ½å±‰
                if (drawer.classList.contains('expanded')) {
                    drawer.classList.remove('expanded');
                }
            }

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.drawer-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // æ›´å®‰å…¨çš„æŒ‰é’®é€‰æ‹©æ–¹å¼
            const targetBtn = document.querySelector(`[onclick="switchDrawerView('${viewType}')"]`);
            if (targetBtn) {
                targetBtn.classList.add('active');
                console.log('Button activated:', targetBtn);
            } else {
                console.error('Button not found for viewType:', viewType);
            }

            // åˆ‡æ¢è§†å›¾
            document.querySelectorAll('.drawer-usage-view').forEach(view => {
                view.classList.remove('active');
                view.style.display = 'none';
                console.log('Removed active from:', view.id);
            });

            const targetView = document.getElementById(`drawer-${viewType}-view`);
            if (targetView) {
                targetView.classList.add('active');
                console.log('Added active to:', targetView.id);

                // æ¸…é™¤å†…è”æ ·å¼ï¼Œè®©CSSè§„åˆ™æ ¹æ®å±•å¼€çŠ¶æ€è‡ªåŠ¨ç”Ÿæ•ˆ
                targetView.style.display = '';
            } else {
                console.error('Target view not found:', `drawer-${viewType}-view`);
            }

            // å¦‚æœåˆ‡æ¢åˆ°å›¾è¡¨è§†å›¾ï¼Œé‡æ–°æ¸²æŸ“å›¾è¡¨
            if (viewType === 'chart') {
                setTimeout(() => {
                    renderDrawerChart();
                }, 100);
            }

            // å¦‚æœåˆ‡æ¢åˆ°æ—¥å†è§†å›¾ï¼Œé‡æ–°ç”Ÿæˆæ—¥å†
            if (viewType === 'calendar') {
                setTimeout(() => {
                    generateDrawerCalendar();
                }, 100);
            }
        }

        // EChartså›¾è¡¨å®ä¾‹
        let chartInstance = null;
        let chartData = [];

        // æ¸²æŸ“EChartså›¾è¡¨
        function renderDrawerChart() {
            const chartContainer = document.getElementById('drawer-usage-chart');
            if (!chartContainer) {
                console.log('Chart container not found');
                return;
            }

            console.log('=== å¼€å§‹æ¸²æŸ“EChartså›¾è¡¨ ===');
            console.log('Chart view visible:', document.getElementById('drawer-chart-view').style.display);
            console.log('Chart view has active class:', document.getElementById('drawer-chart-view').classList.contains('active'));

            // å¦‚æœå·²æœ‰å›¾è¡¨å®ä¾‹ï¼Œå…ˆé”€æ¯
            if (chartInstance) {
                chartInstance.dispose();
            }

            // åˆå§‹åŒ–EChartså®ä¾‹
            chartInstance = echarts.init(chartContainer);

            console.log('Chart container dimensions:', chartContainer.offsetWidth, 'x', chartContainer.offsetHeight);

            // ç”Ÿæˆæœ¬æœˆæ•°æ®ï¼ˆ30å¤©ï¼‰
            const days = [];
            const usageData = [];
            const costData = [];

            for (let day = 1; day <= 30; day++) {
                // æ¨¡æ‹Ÿæ¯æ—¥ç”¨ç”µé‡ (10-30kWhä¹‹é—´çš„æ³¢åŠ¨)
                const dailyUsage = 20 + Math.sin(day * 0.3) * 8 + Math.cos(day * 0.2) * 4 + (Math.random() - 0.5) * 6;

                // è®¡ç®—æ¯æ—¥è´¹ç”¨
                const dailyCost = Math.max(0, dailyUsage) * 4.5;

                days.push(`${day}æ—¥`);
                usageData.push(Math.max(0, dailyUsage).toFixed(2));
                costData.push(dailyCost.toFixed(2));
            }

            // EChartsé…ç½®
            const option = {
                title: {
                    text: 'æœ¬æœˆæ¯æ—¥ç”¨ç”µé‡ä¸è´¹ç”¨è¶‹åŠ¿',
                    left: 'center',
                    textStyle: {
                        fontFamily: '"SF Pro Display", -apple-system, BlinkMacSystemFont, "Inter", sans-serif',
                        fontWeight: 300,
                        fontSize: 18,
                        color: '#000000'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    },
                    backgroundColor: '#000000',
                    borderColor: '#000000',
                    textStyle: {
                        fontFamily: '"SF Pro Display", -apple-system, BlinkMacSystemFont, "Inter", sans-serif',
                        color: '#FFFFFF',
                        fontSize: 13
                    },
                    formatter: function(params) {
                        let result = `<div style="font-weight: 500; margin-bottom: 4px;">${params[0].axisValue}æ•°æ®</div>`;
                        params.forEach(function(item) {
                            if (item.seriesName === 'æ¯æ—¥ç”µé‡') {
                                result += `<div style="margin-bottom: 2px;">ç”¨ç”µé‡: ${item.value} kWh</div>`;
                            } else if (item.seriesName === 'æ¯æ—¥è´¹ç”¨') {
                                result += `<div>è´¹ç”¨: â‚¹${item.value}</div>`;
                            }
                        });
                        return result;
                    }
                },
                legend: {
                    data: ['æ¯æ—¥ç”µé‡', 'æ¯æ—¥è´¹ç”¨'],
                    top: 30,
                    textStyle: {
                        fontFamily: '"SF Pro Display", -apple-system, BlinkMacSystemFont, "Inter", sans-serif',
                        fontWeight: 500,
                        fontSize: 14
                    }
                },
                grid: {
                    left: '80px',
                    right: '80px',
                    top: '80px',
                    bottom: '60px',
                    containLabel: false
                },
                xAxis: {
                    type: 'category',
                    data: days,
                    axisLine: {
                        lineStyle: {
                            color: '#666666'
                        }
                    },
                    axisLabel: {
                        fontFamily: '"SF Pro Display", -apple-system, BlinkMacSystemFont, "Inter", sans-serif',
                        color: '#666666',
                        fontSize: 12
                    },
                    splitLine: {
                        show: true,
                        lineStyle: {
                            color: '#F0F0F0'
                        }
                    }
                },
                yAxis: [
                    {
                        type: 'value',
                        name: 'æ¯æ—¥ç”µé‡ (kWh)',
                        nameTextStyle: {
                            fontFamily: '"SF Pro Display", -apple-system, BlinkMacSystemFont, "Inter", sans-serif',
                            color: '#0066CC',
                            fontWeight: 500,
                            fontSize: 14
                        },
                        axisLine: {
                            lineStyle: {
                                color: '#0066CC'
                            }
                        },
                        axisLabel: {
                            fontFamily: '"SF Pro Display", -apple-system, BlinkMacSystemFont, "Inter", sans-serif',
                            color: '#0066CC',
                            fontSize: 11
                        },
                        splitLine: {
                            show: true,
                            lineStyle: {
                                color: '#F0F0F0'
                            }
                        }
                    },
                    {
                        type: 'value',
                        name: 'æ¯æ—¥é‡‘é¢ (â‚¹)',
                        nameTextStyle: {
                            fontFamily: '"SF Pro Display", -apple-system, BlinkMacSystemFont, "Inter", sans-serif',
                            color: '#28A745',
                            fontWeight: 500,
                            fontSize: 14
                        },
                        axisLine: {
                            lineStyle: {
                                color: '#28A745'
                            }
                        },
                        axisLabel: {
                            fontFamily: '"SF Pro Display", -apple-system, BlinkMacSystemFont, "Inter", sans-serif',
                            color: '#28A745',
                            fontSize: 11,
                            formatter: 'â‚¹{value}'
                        },
                        splitLine: {
                            show: false
                        }
                    }
                ],
                series: [
                    {
                        name: 'æ¯æ—¥ç”µé‡',
                        type: 'line',
                        yAxisIndex: 0,
                        data: usageData,
                        lineStyle: {
                            color: '#0066CC',
                            width: 2
                        },
                        itemStyle: {
                            color: '#0066CC'
                        },
                        symbol: 'circle',
                        symbolSize: 4,
                        smooth: true
                    },
                    {
                        name: 'æ¯æ—¥è´¹ç”¨',
                        type: 'line',
                        yAxisIndex: 1,
                        data: costData,
                        lineStyle: {
                            color: '#28A745',
                            width: 2
                        },
                        itemStyle: {
                            color: '#28A745'
                        },
                        symbol: 'circle',
                        symbolSize: 4,
                        smooth: true
                    }
                ]
            };

            // è®¾ç½®é…ç½®é¡¹å¹¶æ¸²æŸ“å›¾è¡¨
            chartInstance.setOption(option);

            // å“åº”å¼å¤„ç†
            window.addEventListener('resize', function() {
                if (chartInstance) {
                    chartInstance.resize();
                }
            });

            console.log('EChartså›¾è¡¨æ¸²æŸ“å®Œæˆ');
        }


        // ç”ŸæˆæŠ½å±‰æ—¥å†
        function generateDrawerCalendar() {
            const calendarGrid = document.getElementById('drawer-calendar-grid');
            if (!calendarGrid) return;

            // è·å–å½“å‰æ—¥æœŸ
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();
            const today = now.getDate();

            // æ¨¡æ‹Ÿæ•°æ®ç”¨äºæ‰¾åˆ°æœ€å¤§å€¼ - ç¡®ä¿ä¸º2025å¹´9æœˆç”Ÿæˆ30å¤©æ•°æ®
            const monthlyData = [];
            const daysInMonth = new Date(2025, 9, 0).getDate(); // 2025å¹´9æœˆçš„å¤©æ•° (30å¤©)
            for (let d = 1; d <= daysInMonth; d++) {
                const usage = 15 + Math.sin(d * 0.3) * 8 + Math.random() * 6;
                const cost = usage * 4.5;
                monthlyData.push({ day: d, usage, cost });
            }

            const maxUsage = Math.max(...monthlyData.map(d => d.usage));
            const maxCost = Math.max(...monthlyData.map(d => d.cost));
            const maxUsageDay = monthlyData.find(d => d.usage === maxUsage)?.day;
            const maxCostDay = monthlyData.find(d => d.cost === maxCost)?.day;

            // ç”Ÿæˆæ—¥å†æ•°æ®
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            let calendarHTML = '';
            let date = new Date(startDate);

            // ç”Ÿæˆ6å‘¨çš„æ—¥å†ï¼ˆ42å¤©ï¼‰
            for (let i = 0; i < 42; i++) {
                const day = date.getDate();
                const isCurrentMonth = date.getMonth() === currentMonth;
                const isToday = isCurrentMonth && day === today;
                const isOtherMonth = !isCurrentMonth;

                // æ¨¡æ‹Ÿç”¨ç”µé‡æ•°æ® - ä½¿ç”¨é¢„ç”Ÿæˆçš„æ•°æ®ç¡®ä¿ä¸€è‡´æ€§
                let dailyUsage = 0;
                if (isCurrentMonth && day <= daysInMonth) {
                    const dayData = monthlyData.find(d => d.day === day);
                    dailyUsage = dayData ? dayData.usage : 15 + Math.sin(day * 0.3) * 8 + Math.random() * 6;
                }

                // æ¨¡æ‹Ÿè´¹ç”¨æ•°æ®ï¼ˆæ ¹æ®ç”¨ç”µé‡è®¡ç®—ï¼‰
                const dailyCost = dailyUsage * 4.5; // å¹³å‡ç”µä»·

                // æ ¹æ®å½“å‰ç±»å‹é€‰æ‹©æ˜¾ç¤ºå€¼
                const displayValue = currentDrawerCalendarType === 'usage' ? dailyUsage : dailyCost;
                const displayUnit = currentDrawerCalendarType === 'usage' ? 'kWh' : 'â‚¹';
                const displayFormat = currentDrawerCalendarType === 'usage' ? dailyUsage.toFixed(1) : dailyCost.toFixed(2);

                // æ·»åŠ æœ€é«˜å€¼æ ‡è®°ç‚¹
                let marker = '';
                if (isCurrentMonth) {
                    if (currentDrawerCalendarType === 'usage' && day === maxUsageDay) {
                        marker = `<span class="drawer-max-marker usage-max" title="æœ¬æœˆç”¨ç”µé‡æœ€é«˜">â—</span>`;
                    } else if (currentDrawerCalendarType === 'cost' && day === maxCostDay) {
                        marker = `<span class="drawer-max-marker cost-max" title="æœ¬æœˆè´¹ç”¨æœ€é«˜">â—</span>`;
                    }
                }

                // ç¡®å®šç”¨ç”µé‡ç­‰çº§
                let usageLevel = '';
                if (dailyUsage > 0) {
                    if (dailyUsage < 15) {
                        usageLevel = 'low-usage';
                    } else if (dailyUsage <= 25) {
                        usageLevel = 'medium-usage';
                    } else {
                        usageLevel = 'high-usage';
                    }
                }

                const dayClasses = [
                    'drawer-calendar-day',
                    isOtherMonth ? 'other-month' : ''
                ].filter(Boolean).join(' ');

                calendarHTML += `
                    <div class="${dayClasses}" data-date="${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}" onclick="showDayDetails('${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}')">
                        <div class="drawer-day-number">${day}</div>
                        ${marker}
                        ${isCurrentMonth ? `
                            <div class="drawer-day-content">
                                <div class="drawer-day-usage-value">${displayFormat}</div>
                                <div class="drawer-day-unit">${displayUnit}</div>
                            </div>
                        ` : ''}
                    </div>
                `;

                date.setDate(date.getDate() + 1);
            }

            calendarGrid.innerHTML = calendarHTML;

            // è°ƒè¯•ï¼šæ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†æ‰€æœ‰å¤©æ•°
            const generatedDays = calendarGrid.querySelectorAll('.drawer-calendar-day:not(.other-month)');
            console.log('Generated calendar days:', generatedDays.length);
            console.log('Days in month:', daysInMonth);

            // æ›´æ–°æ ‡é¢˜
            const calendarTitle = document.getElementById('drawer-calendar-title');
            if (calendarTitle) {
                const monthNames = currentLanguage === 'zh' ?
                    ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'] :
                    ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                calendarTitle.textContent = currentLanguage === 'zh' ?
                    `${currentYear}å¹´${monthNames[currentMonth]}` :
                    `${monthNames[currentMonth]} ${currentYear}`;
            }
        }

        // æ˜¾ç¤º/åˆ‡æ¢æ—¥æœŸè¯¦æƒ…å¹¶æ‰©å±•/æ”¶ç¼©æŠ½å±‰
        function showDayDetails(dateStr) {
            // è§£ææ—¥æœŸ
            const [year, month, day] = dateStr.split('-');
            const date = new Date(year, month - 1, day);
            const monthNames = getMonthNames();

            // æ£€æŸ¥æ˜¯å¦æ˜¯è´¦å•æœˆä»½ï¼ˆ2025å¹´9æœˆï¼‰
            if (parseInt(year) !== 2025 || parseInt(month) !== 9) {
                return; // éè´¦å•æœˆä»½ä¸æ˜¾ç¤ºè¯¦æƒ…
            }

            // æ£€æŸ¥å½“å‰æ˜¯å¦åœ¨æ—¥å†è§†å›¾ï¼Œå¦‚æœæ˜¯ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†è¯¦æƒ…æ˜¾ç¤º
            const currentActiveView = document.querySelector('.drawer-usage-view.active');
            if (currentActiveView && currentActiveView.id === 'drawer-calendar-view') {
                // åœ¨æ—¥å†è§†å›¾ä¸­ï¼Œåˆ›å»ºä¸´æ—¶è¯¦æƒ…é¢æ¿æ˜¾ç¤ºåœ¨å³ä¾§
                showCalendarDayDetails(dateStr, parseInt(day));
                return;
            }

            const clickedDay = document.querySelector(`[data-date="${dateStr}"]`);
            const isAlreadySelected = clickedDay.classList.contains('selected');

            if (isAlreadySelected) {
                // å¦‚æœå·²ç»é€‰ä¸­ï¼Œåˆ™å–æ¶ˆé€‰æ‹©å¹¶æ”¶èµ·
                closeDrawerHourlyDetails();
            } else {
                // å¦‚æœæœªé€‰ä¸­ï¼Œåˆ™é€‰ä¸­å¹¶å±•å¼€
                // æ›´æ–°é€‰ä¸­çŠ¶æ€ - æ¸…é™¤æ—¥å†å’Œè¡¨æ ¼çš„é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.drawer-calendar-day').forEach(dayEl => {
                    dayEl.classList.remove('selected');
                });
                document.querySelectorAll('.drawer-daily-table-row').forEach(rowEl => {
                    rowEl.classList.remove('selected');
                });

                // é€‰ä¸­å½“å‰ç‚¹å‡»çš„å…ƒç´ ï¼ˆå¯èƒ½æ˜¯æ—¥å†æ—¥æœŸæˆ–è¡¨æ ¼è¡Œï¼‰
                if (clickedDay) {
                    clickedDay.classList.add('selected');
                }

                // æ‰©å±•æŠ½å±‰
                const drawer = document.querySelector('.right-drawer');
                drawer.classList.add('expanded');
                console.log('Drawer expanded in showDayDetails:', drawer);

                // æ— è®ºä»€ä¹ˆè§†å›¾ï¼Œéƒ½ä½¿ç”¨ç›¸åŒçš„è¯¦æƒ…é¢æ¿ç¡®ä¿ä¸€è‡´æ€§
                let hourlyPanel = document.getElementById('drawer-hourly-details-panel');
                let panelContentId = 'drawer-hourly-details-content';
                let titleId = 'drawer-selected-date-title';

                if (hourlyPanel) {
                    hourlyPanel.style.display = 'block';
                    console.log('Hourly panel displayed in showDayDetails:', hourlyPanel);
                } else {
                    console.error('Hourly panel not found in showDayDetails!');
                }

                // ä¿æŒç”¨æˆ·å½“å‰é€‰æ‹©çš„è§†å›¾ï¼Œä¸å¼ºåˆ¶è·³è½¬
                // æ£€æŸ¥å½“å‰æ¿€æ´»çš„è§†å›¾
                const currentActiveView = document.querySelector('.drawer-usage-view.active');
                let currentViewType = 'chart'; // é»˜è®¤å›¾è¡¨è§†å›¾

                console.log('Current active view:', currentActiveView);

                if (currentActiveView) {
                    if (currentActiveView.id === 'drawer-chart-view') {
                        currentViewType = 'chart';
                    } else if (currentActiveView.id === 'drawer-calendar-view') {
                        currentViewType = 'calendar';
                    } else if (currentActiveView.id === 'drawer-table-view') {
                        currentViewType = 'table';
                    }
                }

                console.log('Determined view type:', currentViewType);

                // æ¿€æ´»å½“å‰è§†å›¾ï¼ˆå¦‚æœæ˜¯æ—¥å†è§†å›¾ï¼Œä¼šè‡ªåŠ¨è®¾ç½®ä¸ºå·¦å³å¸ƒå±€ï¼‰
                switchDrawerView(currentViewType);

                // æ›´æ–°æ ‡é¢˜
                const dateTitle = document.getElementById(titleId);
                if (dateTitle) {
                    dateTitle.setAttribute('data-zh', `${year}å¹´${monthNames[parseInt(month) - 1]}${day}æ—¥ â€” æ¯å°æ—¶æ˜ç»†`);
                    dateTitle.setAttribute('data-en', `${monthNames[parseInt(month) - 1]} ${day}, ${year} â€” Hourly Details`);
                    dateTitle.textContent = currentLanguage === 'zh' ?
                        `${year}å¹´${monthNames[parseInt(month) - 1]}${day}æ—¥ â€” æ¯å°æ—¶æ˜ç»†` :
                        `${monthNames[parseInt(month) - 1]} ${day}, ${year} â€” Hourly Details`;
                }

                // ç­‰å¾…DOMæ›´æ–°åç”Ÿæˆæ¯å°æ—¶æ•°æ®
                setTimeout(() => {
                    console.log('Calling generateDrawerHourlyData for day:', parseInt(day));
                    generateDrawerHourlyData(parseInt(day), panelContentId);

                    // å¦‚æœå½“å‰åœ¨è¡¨æ ¼è§†å›¾ï¼Œç¡®ä¿é€‰ä¸­æ—¥æœŸçš„è¡Œè¢«æ­£ç¡®æ ‡è®°å’Œå±•å¼€
                    if (currentViewType === 'table') {
                        highlightSelectedDateInTable(dateStr);
                    }
                }, 500);
            }
        }

        // æ—¥å†è§†å›¾ä¸“ç”¨çš„è¯¦æƒ…å±•å¼€å‡½æ•°
        function showCalendarDayDetails(dateStr, dayNumber) {
            console.log('showCalendarDayDetails called:', dateStr, dayNumber);

            // è§£ææ—¥æœŸ
            const [year, month, day] = dateStr.split('-');
            const monthNames = getMonthNames();

            // æŸ¥æ‰¾è¢«ç‚¹å‡»çš„æ—¥å†æ ¼å­
            const clickedDay = document.querySelector(`[data-date="${dateStr}"]`);
            const isAlreadySelected = clickedDay && clickedDay.classList.contains('selected');

            if (isAlreadySelected) {
                // å¦‚æœå·²ç»é€‰ä¸­ï¼Œåˆ™å–æ¶ˆé€‰æ‹©å¹¶æ”¶èµ·
                closeCalendarHourlyDetails();
            } else {
                // æ¸…é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.drawer-calendar-day.selected').forEach(day => {
                    day.classList.remove('selected');
                });

                // é€‰ä¸­å½“å‰ç‚¹å‡»çš„æ—¥å†æ ¼å­
                if (clickedDay) {
                    clickedDay.classList.add('selected');
                }

                // æ‰©å±•æŠ½å±‰
                const drawer = document.querySelector('.right-drawer');
                drawer.classList.add('expanded');

                // åŠ¨æ€åˆ›å»ºè¯¦æƒ…é¢æ¿åœ¨æ—¥å†è§†å›¾çš„å³ä¾§
                createCalendarDetailsPanel(dateStr, dayNumber);
            }
        }

        // ä¸ºæ—¥å†è§†å›¾åˆ›å»ºè¯¦æƒ…é¢æ¿
        function createCalendarDetailsPanel(dateStr, dayNumber) {
            // ç§»é™¤ä¹‹å‰çš„è¯¦æƒ…é¢æ¿ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const existingPanel = document.getElementById('calendar-hourly-details-panel');
            if (existingPanel) {
                existingPanel.remove();
            }

            // è§£ææ—¥æœŸç”¨äºæ ‡é¢˜
            const [year, month, day] = dateStr.split('-');
            const monthNames = getMonthNames();

            // åœ¨æ—¥å†è§†å›¾ä¸­åˆ›å»ºè¯¦æƒ…é¢æ¿
            const calendarView = document.getElementById('drawer-calendar-view');
            const detailsPanel = document.createElement('div');
            detailsPanel.id = 'calendar-hourly-details-panel';
            detailsPanel.className = 'drawer-hourly-details-panel';
            detailsPanel.innerHTML = `
                <div class="drawer-hourly-header">
                    <h4>${currentLanguage === 'zh' ?
                        `${year}å¹´${monthNames[parseInt(month) - 1]}${day}æ—¥ â€” æ¯å°æ—¶æ˜ç»†` :
                        `${monthNames[parseInt(month) - 1]} ${day}, ${year} â€” Hourly Details`}</h4>
                    <button class="drawer-hourly-close" onclick="closeCalendarHourlyDetails()">Ã—</button>
                </div>
                <div class="drawer-hourly-content" id="calendar-hourly-details-content">
                    <!-- æ¯å°æ—¶æ•°æ®å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            `;

            calendarView.appendChild(detailsPanel);

            // ç”Ÿæˆæ¯å°æ—¶æ•°æ®
            setTimeout(() => {
                generateDrawerHourlyData(parseInt(day), 'calendar-hourly-details-content');
            }, 100);
        }

        // å…³é—­æ—¥å†è¯¦æƒ…é¢æ¿
        function closeCalendarHourlyDetails() {
            // æ”¶ç¼©æŠ½å±‰
            const drawer = document.querySelector('.right-drawer');
            drawer.classList.remove('expanded');

            // ç§»é™¤è¯¦æƒ…é¢æ¿
            const detailsPanel = document.getElementById('calendar-hourly-details-panel');
            if (detailsPanel) {
                detailsPanel.remove();
            }

            // æ¸…é™¤é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.drawer-calendar-day.selected').forEach(day => {
                day.classList.remove('selected');
            });
        }

        // è¡¨æ ¼è¡Œä¸“ç”¨çš„è¯¦æƒ…å±•å¼€å‡½æ•°
        function showTableRowDetails(dateStr, dayNumber) {
            console.log('showTableRowDetails called:', dateStr, dayNumber);

            // è§£ææ—¥æœŸ
            const [year, month, day] = dateStr.split('-');
            const monthNames = getMonthNames();

            // æ£€æŸ¥æ˜¯å¦æ˜¯è´¦å•æœˆä»½ï¼ˆ2025å¹´9æœˆï¼‰
            if (parseInt(year) !== 2025 || parseInt(month) !== 9) {
                return; // éè´¦å•æœˆä»½ä¸æ˜¾ç¤ºè¯¦æƒ…
            }

            // æŸ¥æ‰¾è¢«ç‚¹å‡»çš„è¡¨æ ¼è¡Œ
            const clickedRow = document.querySelector(`[data-date="${dateStr}"]`);
            const isAlreadySelected = clickedRow && clickedRow.classList.contains('selected');

            if (isAlreadySelected) {
                // å¦‚æœå·²ç»é€‰ä¸­ï¼Œåˆ™å–æ¶ˆé€‰æ‹©å¹¶æ”¶èµ·
                closeDrawerHourlyDetails();
            } else {
                // æ¸…é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.drawer-calendar-day').forEach(dayEl => {
                    dayEl.classList.remove('selected');
                });
                document.querySelectorAll('.drawer-daily-table-row').forEach(rowEl => {
                    rowEl.classList.remove('selected');
                });

                // é€‰ä¸­å½“å‰ç‚¹å‡»çš„è¡¨æ ¼è¡Œ
                if (clickedRow) {
                    clickedRow.classList.add('selected');
                }

                // æ‰©å±•æŠ½å±‰
                const drawer = document.querySelector('.right-drawer');
                drawer.classList.add('expanded');

                // æ˜¾ç¤ºæ¯å°æ—¶è¯¦æƒ…é¢æ¿
                const hourlyPanel = document.getElementById('drawer-hourly-details-panel');
                hourlyPanel.style.display = 'block';

                // CSSè§„åˆ™ä¼šè‡ªåŠ¨å¤„ç†å±•å¼€çŠ¶æ€çš„flexå¸ƒå±€
                console.log('Drawer expanded, CSS will handle flex layout');

                // æ›´æ–°è¯¦æƒ…é¢æ¿æ ‡é¢˜
                const dateTitle = document.getElementById('drawer-selected-date-title');
                if (dateTitle) {
                    dateTitle.setAttribute('data-zh', `${year}å¹´${monthNames[parseInt(month) - 1]}${day}æ—¥ â€” æ¯å°æ—¶æ˜ç»†`);
                    dateTitle.setAttribute('data-en', `${monthNames[parseInt(month) - 1]} ${day}, ${year} â€” Hourly Details`);
                    dateTitle.textContent = currentLanguage === 'zh' ?
                        `${year}å¹´${monthNames[parseInt(month) - 1]}${day}æ—¥ â€” æ¯å°æ—¶æ˜ç»†` :
                        `${monthNames[parseInt(month) - 1]} ${day}, ${year} â€” Hourly Details`;
                }

                // ç”Ÿæˆæ¯å°æ—¶æ•°æ®
                setTimeout(() => {
                    console.log('Calling generateDrawerHourlyData for day:', parseInt(day));
                    generateDrawerHourlyData(parseInt(day), 'drawer-hourly-details-content');
                }, 100);
            }
        }

        // åœ¨è¡¨æ ¼è§†å›¾ä¸­é«˜äº®é€‰ä¸­çš„æ—¥æœŸ
        function highlightSelectedDateInTable(dateStr) {
            console.log('Highlighting date in table:', dateStr);

            // ç¡®ä¿è¡¨æ ¼è¡Œå·²ç»è¢«é€‰ä¸­ï¼ˆè¿™åº”è¯¥å·²ç»åœ¨showDayDetailsä¸­å®Œæˆäº†ï¼‰
            const selectedRow = document.querySelector(`.drawer-daily-table-row[data-date="${dateStr}"]`);
            if (selectedRow) {
                selectedRow.classList.add('selected');
                console.log('Table row highlighted:', selectedRow);

                // æ»šåŠ¨åˆ°é€‰ä¸­çš„è¡Œï¼ˆå¦‚æœè¡¨æ ¼å¾ˆé•¿çš„è¯ï¼‰
                selectedRow.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });
            } else {
                console.warn('Table row not found for date:', dateStr);
            }
        }

        // å…³é—­æ¯å°æ—¶è¯¦æƒ…å¹¶æ”¶ç¼©æŠ½å±‰
        function closeDrawerHourlyDetails() {
            // æ”¶ç¼©æŠ½å±‰
            const drawer = document.querySelector('.right-drawer');
            drawer.classList.remove('expanded');

            // éšè—è¯¦æƒ…é¢æ¿
            const hourlyPanel = document.getElementById('drawer-hourly-details-panel');
            if (hourlyPanel) {
                hourlyPanel.style.display = 'none';
            }

            // ç§»é™¤å†…è”æ ·å¼ï¼Œè®©CSSè§„åˆ™ç”Ÿæ•ˆ
            document.querySelectorAll('.drawer-usage-view').forEach(view => {
                if (view.classList.contains('active')) {
                    view.style.display = '';  // æ¸…é™¤å†…è”æ ·å¼ï¼Œæ¢å¤CSSé»˜è®¤
                }
            });

            // æ¸…é™¤é€‰ä¸­çŠ¶æ€ - åŒ…æ‹¬æ—¥å†å’Œè¡¨æ ¼
            document.querySelectorAll('.drawer-calendar-day').forEach(dayEl => {
                dayEl.classList.remove('selected');
            });
            document.querySelectorAll('.drawer-daily-table-row').forEach(rowEl => {
                rowEl.classList.remove('selected');
            });

            // æ¸…é™¤æ—¥å†é€‰æ‹©ä¿¡æ¯
            const selectionInfo = document.querySelector('.calendar-selection-info');
            if (selectionInfo) {
                selectionInfo.remove();
            }
        }

        // ç”ŸæˆæŠ½å±‰æ¯å°æ—¶è¯¦æƒ…æ•°æ®
        function generateDrawerHourlyData(day, contentId = 'drawer-hourly-details-content', retryCount = 0) {
            console.log('generateDrawerHourlyData called with day:', day, 'contentId:', contentId, 'retry:', retryCount);
            const hourlyContent = document.getElementById(contentId);
            console.log('hourlyContent element:', hourlyContent);

            if (!hourlyContent) {
                console.error('hourlyContent element not found!');
                if (retryCount < 3) {
                    console.log('Retrying in 200ms...');
                    setTimeout(() => {
                        generateDrawerHourlyData(day, contentId, retryCount + 1);
                    }, 200);
                }
                return;
            }

            // å°åº¦åˆ†æ—¶ç”µä»·æ—¶æ®µ
            const timeRates = {
                valley: { rate: 3.60, name: 'ä½è°·', nameEn: 'Valley' },
                standard: { rate: 4.50, name: 'å¹³æ—¶', nameEn: 'Standard' },
                peak: { rate: 5.40, name: 'é«˜å³°', nameEn: 'Peak' }
            };

            // ç”Ÿæˆç®€å•çš„24å°æ—¶æ•°æ®è¡¨æ ¼ï¼Œæ—¶æ®µåˆ—åˆå¹¶ç›¸åŒå•å…ƒæ ¼
            let hourlyHTML = `
                <table class="simple-hourly-table">
                    <tr>
                        <th>${currentLanguage === 'zh' ? 'æ—¶é—´' : 'Time'}</th>
                        <th>${currentLanguage === 'zh' ? 'æ—¶æ®µ' : 'Period'}</th>
                        <th>${currentLanguage === 'zh' ? 'ç”µé‡' : 'Usage'}</th>
                        <th>${currentLanguage === 'zh' ? 'å•ä»·' : 'Rate'}</th>
                        <th>${currentLanguage === 'zh' ? 'è´¹ç”¨' : 'Cost'}</th>
                    </tr>
            `;

            // å…ˆç”Ÿæˆæ‰€æœ‰å°æ—¶çš„æ•°æ®
            let allHours = [];
            for (let hour = 0; hour < 24; hour++) {
                // ç¡®å®šæ—¶æ®µ
                let period = '';
                let rate = 0;
                if (hour >= 0 && hour < 8) {
                    period = 'ä½è°·';
                    rate = 3.60;
                } else if (hour >= 8 && hour < 12) {
                    period = 'å¹³æ—¶';
                    rate = 4.50;
                } else if (hour >= 12 && hour < 18) {
                    period = 'é«˜å³°';
                    rate = 5.40;
                } else if (hour >= 18 && hour < 23) {
                    period = 'å¹³æ—¶';
                    rate = 4.50;
                } else { // hour == 23
                    period = 'ä½è°·';
                    rate = 3.60;
                }

                // æ¨¡æ‹Ÿç”¨ç”µé‡
                const baseUsage = 0.8 + Math.sin((hour + day) * 0.3) * 0.4 + Math.random() * 0.3;
                const usage = Math.max(0.1, baseUsage);
                const cost = usage * rate;

                allHours.push({
                    hour: hour,
                    timeStr: `${hour.toString().padStart(2, '0')}:00`,
                    period: period,
                    rate: rate,
                    usage: usage,
                    cost: cost
                });
            }

            // è®¡ç®—æ¯ä¸ªæ—¶æ®µéœ€è¦åˆå¹¶çš„è¡Œæ•°
            let periodSpans = {};
            let currentPeriod = null;
            let currentSpan = 0;

            for (let i = 0; i < allHours.length; i++) {
                const hourData = allHours[i];
                if (hourData.period !== currentPeriod) {
                    if (currentPeriod !== null) {
                        periodSpans[currentPeriod + '_' + (i - currentSpan)] = currentSpan;
                    }
                    currentPeriod = hourData.period;
                    currentSpan = 1;
                } else {
                    currentSpan++;
                }
            }
            // å¤„ç†æœ€åä¸€ä¸ªæ—¶æ®µ
            if (currentPeriod !== null) {
                periodSpans[currentPeriod + '_' + (allHours.length - currentSpan)] = currentSpan;
            }

            // ç”Ÿæˆè¡¨æ ¼è¡Œ
            for (let i = 0; i < allHours.length; i++) {
                const hourData = allHours[i];
                let periodCell = '';

                // æ£€æŸ¥æ˜¯å¦æ˜¯æŸä¸ªæ—¶æ®µçš„ç¬¬ä¸€è¡Œ
                if (i === 0 || allHours[i-1].period !== hourData.period) {
                    // è®¡ç®—è¿™ä¸ªæ—¶æ®µæœ‰å¤šå°‘è¿ç»­çš„å°æ—¶
                    let spanCount = 1;
                    for (let j = i + 1; j < allHours.length; j++) {
                        if (allHours[j].period === hourData.period) {
                            spanCount++;
                        } else {
                            break;
                        }
                    }
                    periodCell = `<td rowspan="${spanCount}" class="merged-period">${hourData.period}</td>`;
                }

                // æ ¹æ®æ—¶æ®µè®¾ç½®è¡Œçš„é¢œè‰²ç±»
                let rowClass = '';
                if (hourData.period === 'é«˜å³°') {
                    rowClass = 'peak-hour';
                } else if (hourData.period === 'å¹³æ—¶') {
                    rowClass = 'standard-hour';
                } else if (hourData.period === 'ä½è°·') {
                    rowClass = 'valley-hour';
                }

                hourlyHTML += `
                    <tr class="${rowClass}">
                        <td>${hourData.timeStr}</td>
                        ${periodCell}
                        <td>${hourData.usage.toFixed(2)} kWh</td>
                        <td>â‚¹${hourData.rate.toFixed(2)}</td>
                        <td>â‚¹${hourData.cost.toFixed(2)}</td>
                    </tr>
                `;
            }

            hourlyHTML += `</table>`;

            console.log('Setting hourlyHTML:', hourlyHTML);
            hourlyContent.innerHTML = hourlyHTML;
            console.log('Content set, element innerHTML length:', hourlyContent.innerHTML.length);
        }

        // ç”ŸæˆæŠ½å±‰è¡¨æ ¼è§†å›¾æ•°æ®
        function generateDrawerTableData(day) {
            console.log('generateDrawerTableData called with day:', day);
            const tableBody = document.getElementById('drawer-table-body');

            if (!tableBody) {
                console.error('drawer-table-body element not found!');
                return;
            }

            // ç”Ÿæˆé€‰ä¸­æ—¥æœŸçš„è¡Œæ•°æ®
            const dayData = {
                day: day,
                date: `2025-09-${day.toString().padStart(2, '0')}`,
                usage: (15 + Math.sin(day * 0.3) * 8 + Math.random() * 6).toFixed(2),
                amount: 0
            };

            // è®¡ç®—é‡‘é¢ï¼ˆåŸºäºåˆ†æ—¶ç”µä»·ï¼‰
            dayData.amount = (parseFloat(dayData.usage) * 4.5).toFixed(2);

            // ç”Ÿæˆè¡¨æ ¼HTML
            let tableHTML = `
                <div class="drawer-daily-table-row selected-day-row" onclick="toggleDrawerDayDetails(${day})">
                    <span class="expand-icon" id="expand-icon-${day}">â–¼</span>
                    <span>${dayData.date}</span>
                    <span>${dayData.usage} kWh</span>
                    <span>â‚¹${dayData.amount}</span>
                </div>
                <div class="drawer-hourly-details-row expanded" id="drawer-hourly-details-${day}">
                    <div class="drawer-hourly-grid" id="drawer-hourly-grid-${day}">
                        <!-- æ¯å°æ—¶æ•°æ®å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
                    </div>
                </div>
            `;

            tableBody.innerHTML = tableHTML;

            // ç”Ÿæˆæ¯å°æ—¶æ•°æ®
            setTimeout(() => {
                generateDrawerTableHourlyData(day);
            }, 100);
        }

        // ç”Ÿæˆè¡¨æ ¼ä¸­çš„æ¯å°æ—¶è¯¦ç»†æ•°æ®
        function generateDrawerTableHourlyData(day) {
            const hourlyGrid = document.getElementById(`drawer-hourly-grid-${day}`);
            if (!hourlyGrid) {
                console.error('Hourly grid not found for day:', day);
                return;
            }

            // æ·»åŠ è¡¨æ ¼æ ‡é¢˜
            let hourlyHTML = `
                <div class="hourly-header">
                    <span>æ—¶é—´</span>
                    <span>æ—¶æ®µ</span>
                    <span>ç”µé‡</span>
                    <span>å•ä»·</span>
                    <span>è´¹ç”¨</span>
                </div>
            `;

            // ç”Ÿæˆ24å°æ—¶æ•°æ®
            for (let hour = 0; hour < 24; hour++) {
                // ç¡®å®šæ—¶æ®µ
                let period = '';
                let rate = 0;
                if (hour >= 0 && hour < 8) {
                    period = 'ä½è°·';
                    rate = 3.60;
                } else if (hour >= 8 && hour < 12) {
                    period = 'å¹³æ—¶';
                    rate = 4.50;
                } else if (hour >= 12 && hour < 18) {
                    period = 'é«˜å³°';
                    rate = 5.40;
                } else if (hour >= 18 && hour < 23) {
                    period = 'å¹³æ—¶';
                    rate = 4.50;
                } else { // hour == 23
                    period = 'ä½è°·';
                    rate = 3.60;
                }

                // æ¨¡æ‹Ÿç”¨ç”µé‡
                const usage = (0.8 + Math.sin((hour + day) * 0.3) * 0.4 + Math.random() * 0.3).toFixed(2);
                const cost = (parseFloat(usage) * rate).toFixed(2);
                const timeStr = `${hour.toString().padStart(2, '0')}:00`;

                hourlyHTML += `
                    <div class="hourly-item">
                        <span class="hour-time">${timeStr}</span>
                        <span class="hour-period">${period}</span>
                        <span class="hour-usage">${usage} kWh</span>
                        <span class="hour-rate">â‚¹${rate.toFixed(2)}</span>
                        <span class="hour-cost">â‚¹${cost}</span>
                    </div>
                `;
            }

            hourlyGrid.innerHTML = hourlyHTML;
        }

        // æ—¥å†ç±»å‹åˆ‡æ¢å…¨å±€å˜é‡
        let currentCalendarType = 'usage'; // 'usage' æˆ– 'cost'
        let currentDrawerCalendarType = 'usage';

        // ä¸»æ—¥å†åˆ‡æ¢åŠŸèƒ½
        function switchCalendarType(type) {
            currentCalendarType = type;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.calendar-toggle-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });

            // é‡æ–°ç”Ÿæˆæ—¥å†
            generateCalendar();
        }

        // æŠ½å±‰æ—¥å†åˆ‡æ¢åŠŸèƒ½
        function switchDrawerCalendarType(type) {
            currentDrawerCalendarType = type;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.drawer-calendar-toggle-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });

            // é‡æ–°ç”ŸæˆæŠ½å±‰æ—¥å†
            generateDrawerCalendar();
        }


        // æŸ¥çœ‹å°æ—¶è¯¦æƒ…
        function viewHourlyDetails(dateStr) {
            // å…³é—­å½“å‰å¼¹çª—
            const modal = document.querySelector('[style*="position: fixed"]');
            if (modal) modal.remove();

            // åˆ‡æ¢åˆ°è¡¨æ ¼è§†å›¾å¹¶å±•å¼€å¯¹åº”æ—¥æœŸ
            switchDrawerView('table');

            // è¿™é‡Œå¯ä»¥æ·»åŠ æ»šåŠ¨åˆ°å¯¹åº”æ—¥æœŸå¹¶å±•å¼€çš„é€»è¾‘
            EnergySystem.showNotification('åˆ‡æ¢åˆ°è¡¨æ ¼è§†å›¾æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯', 'info');
        }

        // å¯¼å‡ºæŠ½å±‰æ•°æ®
        function exportDrawerData() {
            EnergySystem.showNotification('å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }


        // æŠ½å±‰è¡¨æ ¼æ—¥æœŸå±•å¼€åŠŸèƒ½
        function toggleDrawerDayDetails(day) {
            console.log('ç‚¹å‡»å±•å¼€æ—¥æœŸ:', day); // è°ƒè¯•ä¿¡æ¯
            const detailsRow = document.getElementById(`drawer-hourly-details-${day}`);
            const expandIcon = document.getElementById(`drawer-expand-icon-${day}`);

            console.log('è¯¦æƒ…è¡Œ:', detailsRow); // è°ƒè¯•ä¿¡æ¯
            console.log('å±•å¼€å›¾æ ‡:', expandIcon); // è°ƒè¯•ä¿¡æ¯

            if (!detailsRow || !expandIcon) {
                console.error('æœªæ‰¾åˆ°ç›¸å…³å…ƒç´ ');
                return;
            }

            if (detailsRow.style.display === 'none' || detailsRow.style.display === '') {
                // å…³é—­å…¶ä»–å·²æ‰“å¼€çš„è¯¦æƒ…
                document.querySelectorAll('.drawer-hourly-details-row').forEach(row => {
                    row.style.display = 'none';
                });
                document.querySelectorAll('.drawer-expand-icon').forEach(icon => {
                    icon.textContent = 'â–¶';
                    icon.style.transform = 'rotate(0deg)';
                });

                // æ‰“å¼€å½“å‰è¯¦æƒ…
                detailsRow.style.display = 'block';
                expandIcon.textContent = 'â–¼';
                expandIcon.style.transform = 'rotate(0deg)';

                // ç”Ÿæˆæ¯å°æ—¶æ•°æ®
                generateDrawerHourlyDataOld(day);
            } else {
                // å…³é—­å½“å‰è¯¦æƒ…
                detailsRow.style.display = 'none';
                expandIcon.textContent = 'â–¶';
                expandIcon.style.transform = 'rotate(0deg)';
            }
        }

        // ç”ŸæˆæŠ½å±‰ä¸­çš„æ¯å°æ—¶ç”¨ç”µæ•°æ®ï¼ˆæ—§è¡¨æ ¼å±•å¼€åŠŸèƒ½ï¼‰
        function generateDrawerHourlyDataOld(day) {
            const hourlyBody = document.getElementById(`drawer-hourly-body-${day}`);

            // è·å–æ—¶æ®µç”µä»·
            const timeRates = {
                peak: 5.40,     // é«˜å³°æ—¶æ®µ 12:00-18:00
                standard: 4.50, // å¹³å³°æ—¶æ®µ 08:00-12:00 & 18:00-23:00
                valley: 3.60    // ä½è°·æ—¶æ®µ 23:00-08:00
            };

            // ç”Ÿæˆ24å°æ—¶æ•°æ®
            let hourlyHTML = '';
            for (let hour = 0; hour < 24; hour++) {
                // ç¡®å®šæ—¶æ®µç±»å‹
                let period, periodName, rate, periodClass;
                if (hour >= 12 && hour < 18) {
                    period = 'peak';
                    periodName = currentLanguage === 'zh' ? 'é«˜å³°' : 'Peak';
                    rate = timeRates.peak;
                    periodClass = 'peak';
                } else if ((hour >= 8 && hour < 12) || (hour >= 18 && hour < 23)) {
                    period = 'standard';
                    periodName = currentLanguage === 'zh' ? 'å¹³å³°' : 'Standard';
                    rate = timeRates.standard;
                    periodClass = 'standard';
                } else {
                    period = 'valley';
                    periodName = currentLanguage === 'zh' ? 'ä½è°·' : 'Valley';
                    rate = timeRates.valley;
                    periodClass = 'valley';
                }

                // æ¨¡æ‹Ÿæ¯å°æ—¶ç”¨ç”µé‡ (0.8-2.5kWhä¹‹é—´)
                const hourlyUsage = (Math.random() * 1.7 + 0.8).toFixed(2);
                const hourlyCost = (hourlyUsage * rate).toFixed(2);

                hourlyHTML += `
                    <div class="drawer-hourly-row">
                        <span class="drawer-hour-time">${hour.toString().padStart(2, '0')}:00</span>
                        <span class="drawer-hour-period ${periodClass}">${periodName}</span>
                        <span class="drawer-hour-usage">${hourlyUsage}kWh</span>
                        <span class="drawer-hour-rate">â‚¹${rate.toFixed(2)}</span>
                        <span class="drawer-hour-cost">â‚¹${hourlyCost}</span>
                    </div>
                `;
            }

            hourlyBody.innerHTML = hourlyHTML;
        }

        // å…³é—­è¯¦ç»†è§†å›¾
        function closeDetailedView() {
            const drawer = document.querySelector('.right-drawer');
            if (drawer) {
                drawer.classList.add('hide');
                // æ¢å¤ä¸»é¡µé¢æ»šåŠ¨
                document.body.style.overflow = '';
                setTimeout(() => {
                    document.body.removeChild(drawer);
                }, 300);
            }
        }

        // æ¸²æŸ“å›¾è¡¨è§†å›¾ï¼ˆç®€åŒ–ç‰ˆçº¿å›¾ï¼‰
        function renderChartView(dailyData) {
            const canvas = document.getElementById('usage-chart');
            const ctx = canvas.getContext('2d');

            // è®¾ç½®ç”»å¸ƒå°ºå¯¸
            canvas.width = canvas.offsetWidth;
            canvas.height = 200;

            const width = canvas.width;
            const height = canvas.height;
            const padding = 40;

            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, width, height);

            // è·å–æ•°æ®èŒƒå›´
            const maxUsage = Math.max(...dailyData.map(d => d.usage));
            const minUsage = Math.min(...dailyData.map(d => d.usage));
            const dataRange = maxUsage - minUsage;

            // ç»˜åˆ¶åæ ‡è½´
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;

            // Yè½´
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.stroke();

            // Xè½´
            ctx.beginPath();
            ctx.moveTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();

            // ç»˜åˆ¶ç½‘æ ¼çº¿
            ctx.strokeStyle = '#f5f5f5';
            ctx.lineWidth = 0.5;
            for (let i = 1; i <= 4; i++) {
                const y = padding + (height - 2 * padding) * i / 4;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
            }

            // ç»˜åˆ¶æŠ˜çº¿
            ctx.strokeStyle = '#0066CC';
            ctx.lineWidth = 2;
            ctx.beginPath();

            dailyData.forEach((day, index) => {
                const x = padding + (width - 2 * padding) * index / (dailyData.length - 1);
                const y = height - padding - (height - 2 * padding) * (day.usage - minUsage) / dataRange;

                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });

            ctx.stroke();

            // ç»˜åˆ¶æ•°æ®ç‚¹
            ctx.fillStyle = '#0066CC';
            dailyData.forEach((day, index) => {
                const x = padding + (width - 2 * padding) * index / (dailyData.length - 1);
                const y = height - padding - (height - 2 * padding) * (day.usage - minUsage) / dataRange;

                ctx.beginPath();
                ctx.arc(x, y, 3, 0, 2 * Math.PI);
                ctx.fill();
            });

            // ç»˜åˆ¶æ ‡ç­¾
            ctx.fillStyle = '#666';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';

            // Xè½´æ ‡ç­¾ï¼ˆæ˜¾ç¤ºéƒ¨åˆ†æ—¥æœŸï¼‰
            for (let i = 0; i < dailyData.length; i += Math.ceil(dailyData.length / 6)) {
                const x = padding + (width - 2 * padding) * i / (dailyData.length - 1);
                ctx.fillText(dailyData[i].day, x, height - padding + 15);
            }

            // Yè½´æ ‡ç­¾
            ctx.textAlign = 'right';
            for (let i = 0; i <= 4; i++) {
                const value = minUsage + dataRange * (4 - i) / 4;
                const y = padding + (height - 2 * padding) * i / 4;
                ctx.fillText(value.toFixed(1), padding - 10, y + 4);
            }

        }

        // åˆ‡æ¢è§†å›¾
        function switchView(viewType) {
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === viewType);
            });

            // åˆ‡æ¢è§†å›¾æ˜¾ç¤º
            document.querySelectorAll('.usage-view').forEach(view => {
                view.classList.toggle('active', view.id === `${viewType}-view`);
            });
        }

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è®¾ç½®å½“å‰é¡µé¢å¯¼èˆª
            EnergySystem.setActiveNavigation('bills.html');

            // åˆå§‹åŒ–è¯­è¨€ç³»ç»Ÿ
            EnergySystem.initLanguageSystem();

            // ç›‘å¬è¯­è¨€å˜åŒ–äº‹ä»¶ï¼Œé‡æ–°æ¸²æŸ“è§†å›¾ - ç§»åŠ¨åˆ°åˆå§‹åŒ–æ—©æœŸ
            window.addEventListener('languageChanged', function(e) {
                // é‡æ–°å¡«å……ç”¨æˆ·ä¿¡æ¯å’ŒåŸºæœ¬æ•°æ®
                if (window.currentBill && window.currentMonth) {
                    const bill = window.currentBill;
                    const month = window.currentMonth;

                    // é‡æ–°å¡«å……åŸºæœ¬ä¿¡æ¯
                    document.getElementById('detail-username').textContent = currentLanguage === 'zh' ? bill.userName : bill.userNameEn;
                    document.getElementById('header-address').textContent = currentLanguage === 'zh' ? regionsData[bill.region].name : regionsData[bill.region].nameEn;

                    const businessTypeTexts = {
                        zh: { residential: 'å±…æ°‘', industrial: 'å·¥ä¸š', commercial: 'å•†ä¸š', agricultural: 'å†œä¸š' },
                        en: { residential: 'Residential', industrial: 'Industrial', commercial: 'Commercial', agricultural: 'Agricultural' }
                    };

                    const billingMethodTexts = {
                        zh: { tiered: 'é˜¶æ¢¯ç”µè´¹', 'time-of-use': 'åˆ†æ—¶ç”µä»·' },
                        en: { tiered: 'Tiered', 'time-of-use': 'Time-of-Use' }
                    };

                    document.getElementById('header-business-type').textContent = businessTypeTexts[currentLanguage][bill.businessType];

                    const monthText = currentLanguage === 'zh' ?
                        `${month.split('-')[0]}å¹´${parseInt(month.split('-')[1])}æœˆ` :
                        new Date(month + '-01').toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                    document.getElementById('detail-period').textContent = monthText;
                    document.getElementById('detail-billing-method').textContent = billingMethodTexts[currentLanguage][bill.billingMethod];

                    const currentReading = Math.floor(Math.random() * 50000 + 50000);
                    const previousReading = currentReading - bill.usage;
                    const readingText = currentLanguage === 'zh' ?
                        `ï¼ˆå¼€å§‹ï¼š${previousReading.toLocaleString()} â€” ç»“æŸï¼š${currentReading.toLocaleString()}ï¼‰` :
                        `ï¼ˆStart: ${previousReading.toLocaleString()} â€” End: ${currentReading.toLocaleString()}ï¼‰`;
                    document.getElementById('reading-detail').textContent = readingText;

                    // é‡æ–°ç”Ÿæˆè´¹ç”¨æ˜ç»†
                    generateBillDetails(bill, month);
                }

                // æ›´æ–°åŠ¨æ€è¡¨æ ¼å†…å®¹
                if (window.currentDailyData) {
                    renderTableView(window.currentDailyData);
                    renderCalendarView(window.currentDailyData, month || '2025-09');
                }

                // é‡æ–°æ¸²æŸ“å›¾è¡¨ä»¥æ›´æ–°è¯­è¨€
                if (window.currentTieredData) {
                    setTimeout(() => {
                        renderTieredChart(window.currentTieredData);
                    }, 100);
                }

                // æ›´æ–°å³ä¾§æŠ½å±‰å†…å®¹ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                if (document.querySelector('.right-drawer')) {
                    const drawerTitle = document.querySelector('.drawer-title');
                    if (drawerTitle) {
                        const titleKey = drawerTitle.getAttribute('data-title-key');
                        if (titleKey) {
                            drawerTitle.textContent = currentLanguage === 'zh' ?
                                (titleKey === 'time-of-use' ? 'åˆ†æ—¶ç”µä»·æ—¥ç”¨ç”µè¯¦æƒ…' : 'é˜¶æ¢¯ç”µä»·æ—¥ç”¨ç”µè¯¦æƒ…') :
                                (titleKey === 'time-of-use' ? 'Time-of-Use Daily Details' : 'Tiered Pricing Daily Details');
                        }
                    }
                }

            });

            // è·å–è´¦å•IDå‚æ•°
            const billId = getUrlParameter('id');
            const month = getUrlParameter('month') || '2025-09';

            if (billId) {
                // æ¨¡æ‹Ÿè·å–è´¦å•æ•°æ®ï¼ˆå®é™…åº”è¯¥ä»åç«¯APIè·å–ï¼‰
                // åŸºäºè´¦å•IDç”Ÿæˆå¯¹åº”çš„è´¦å•ä¿¡æ¯
                function generateBillDataById(id) {
                    const southStates = [
                        { region: 'tamil-nadu', names: ['Ravi Kumar', 'Priya Sharma', 'Arjun Patel', 'Deepika Singh'], avatars: ['R', 'P', 'A', 'D'] },
                        { region: 'karnataka', names: ['Manjunath Gowda', 'Kavitha Reddy', 'Sachin Joshi', 'Anitha Murthy'], avatars: ['M', 'K', 'S', 'A'] },
                        { region: 'andhra-pradesh', names: ['Venkat Rao', 'Lakshmi Devi', 'Suresh Babu', 'Padma Valli'], avatars: ['V', 'L', 'S', 'P'] },
                        { region: 'kerala', names: ['Ajay Nair', 'Meera Pillai', 'Rajesh Kumar', 'Nisha Thomas'], avatars: ['A', 'M', 'R', 'N'] }
                    ];

                    const businessTypes = ['residential', 'industrial', 'commercial', 'agricultural'];
                    const billingMethods = ['tiered', 'time-of-use'];

                    const idNum = parseInt(id) || 1;
                    const stateIndex = Math.floor((idNum - 1) / 8) % 4;
                    const businessIndex = Math.floor((idNum - 1) / 2) % 4;
                    const methodIndex = (idNum - 1) % 2;
                    const nameIndex = (businessIndex + methodIndex) % 4;

                    const state = southStates[stateIndex];
                    const businessType = businessTypes[businessIndex];
                    const billingMethod = billingMethods[methodIndex];
                    const usage = Math.floor(Math.random() * 800 + 150);
                    const baseRate = businessType === 'residential' ? 0.45 :
                                   businessType === 'commercial' ? 0.62 :
                                   businessType === 'industrial' ? 0.38 : 0.32;
                    const amount = usage * baseRate * (1 + Math.random() * 0.3);

                    return {
                        id: id,
                        userName: state.names[nameIndex],
                        userNameEn: state.names[nameIndex],
                        avatar: state.avatars[nameIndex],
                        usage: usage,
                        amount: parseFloat(amount.toFixed(2)),
                        region: state.region,
                        businessType: businessType,
                        billingMethod: billingMethod,
                        electricNumber: `${stateIndex + 1}${businessIndex + 1}${String(idNum).padStart(8, '0')}`
                    };
                }

                const mockBill = generateBillDataById(billId);

                // ä¿å­˜æ•°æ®ä¾›è¯­è¨€åˆ‡æ¢æ—¶ä½¿ç”¨
                window.currentBill = mockBill;
                window.currentMonth = month;

                // å¡«å……é¡µé¢æ•°æ®
                const businessTypeTexts = {
                    zh: { residential: 'å±…æ°‘', industrial: 'å·¥ä¸š', commercial: 'å•†ä¸š', agricultural: 'å†œä¸š' },
                    en: { residential: 'Residential', industrial: 'Industrial', commercial: 'Commercial', agricultural: 'Agricultural' }
                };

                const billingMethodTexts = {
                    zh: { tiered: 'é˜¶æ¢¯ç”µè´¹', 'time-of-use': 'åˆ†æ—¶ç”µä»·' },
                    en: { tiered: 'Tiered', 'time-of-use': 'Time-of-Use' }
                };

                // å¡«å……åŸºæœ¬ä¿¡æ¯
                document.getElementById('detail-username').textContent = currentLanguage === 'zh' ? mockBill.userName : mockBill.userNameEn;
                document.getElementById('header-business-type').textContent = businessTypeTexts[currentLanguage][mockBill.businessType];

                // å¡«å……é¡µé¢å¤´éƒ¨ä¿¡æ¯
                document.getElementById('header-electric-number').textContent = mockBill.electricNumber;
                document.getElementById('header-address').textContent = currentLanguage === 'zh' ? regionsData[mockBill.region].name : regionsData[mockBill.region].nameEn;

                // å¡«å……è´¦æœŸä¿¡æ¯
                const monthText = currentLanguage === 'zh' ?
                    `${month.split('-')[0]}å¹´${parseInt(month.split('-')[1])}æœˆ` :
                    new Date(month + '-01').toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                document.getElementById('detail-period').textContent = monthText;
                document.getElementById('detail-billing-method').textContent = billingMethodTexts[currentLanguage][mockBill.billingMethod];

                // ç”ŸæˆæŠ„è¡¨è¯»æ•°ï¼ˆæ¨¡æ‹Ÿæ•°æ®ï¼‰
                const currentReading = Math.floor(Math.random() * 50000 + 50000);
                const previousReading = currentReading - mockBill.usage;

                // å¡«å……ç”¨ç”µé‡å’Œé‡‘é¢ä¿¡æ¯ï¼ˆåˆå§‹å€¼ï¼Œåç»­ä¼šè¢«è´¹ç”¨è®¡ç®—æ›´æ–°ï¼‰
                document.getElementById('detail-usage').textContent = `${mockBill.usage} kWh`;
                const readingText = currentLanguage === 'zh' ?
                    `ï¼ˆå¼€å§‹ï¼š${previousReading.toLocaleString()} â€” ç»“æŸï¼š${currentReading.toLocaleString()}ï¼‰` :
                    `ï¼ˆStart: ${previousReading.toLocaleString()} â€” End: ${currentReading.toLocaleString()}ï¼‰`;
                document.getElementById('reading-detail').textContent = readingText;
                document.getElementById('detail-amount').textContent = `â‚¹${mockBill.amount.toFixed(0)}`;

                // ç”Ÿæˆè¯¦ç»†æ•°æ®
                generateBillDetails(mockBill, month);

                // ç”Ÿæˆæ¯æ—¥ç”¨ç”µé‡æ•°æ®
                const dailyUsageData = generateDailyUsageData(month, mockBill.usage);

                // ä¿å­˜æ•°æ®ä¾›è¯­è¨€åˆ‡æ¢æ—¶ä½¿ç”¨
                window.currentDailyData = dailyUsageData;

                // åˆå§‹åŒ–æ¯æ—¥ç”¨ç”µé‡è§†å›¾
                renderTableView(dailyUsageData);
                renderCalendarView(dailyUsageData, month);
                renderChartView(dailyUsageData);

                // ç»‘å®šè§†å›¾åˆ‡æ¢äº‹ä»¶
                document.querySelectorAll('.view-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        switchView(btn.dataset.view);
                        if (btn.dataset.view === 'chart') {
                            // é‡æ–°ç»˜åˆ¶å›¾è¡¨ä»¥ç¡®ä¿æ­£ç¡®å°ºå¯¸
                            setTimeout(() => renderChartView(dailyUsageData), 100);
                        }
                    });
                });


            } else {
                EnergySystem.showNotification('æœªæ‰¾åˆ°è´¦å•ä¿¡æ¯', 'error');
                setTimeout(() => {
                    window.location.href = 'bills.html';
                }, 2000);
            }

        });
    </script>

    <style>
        /* é¡µé¢å¤´éƒ¨æ ·å¼ */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-8);
            gap: var(--space-6);
        }

        .header-left {
            display: flex;
            align-items: flex-start;
            gap: var(--space-4);
        }

        .header-title-section {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-1);
        }

        .header-title-section h2 {
            font-size: 28px;
            font-weight: var(--font-weight-medium);
            margin: 0;
        }

        .user-name-header {
            font-size: 28px;
            font-weight: var(--font-weight-medium);
            color: var(--text-primary);
        }

        .header-info {
            display: flex;
            gap: var(--space-6);
            margin-top: var(--space-3);
        }

        .header-info-item {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .info-label {
            font-size: 14px;
            font-weight: var(--font-weight-medium);
            color: var(--text-secondary);
        }

        .info-value {
            font-size: 15px;
            font-weight: var(--font-weight-medium);
            color: var(--text-primary);
        }

        .header-actions {
            display: flex;
            gap: var(--space-3);
        }

        /* è´¦å•æ¦‚è¦å¡ç‰‡ */
        .bill-summary {
            margin-bottom: var(--space-8);
            padding: var(--space-6);
            background: var(--background);
            border: var(--border);
            border-radius: var(--radius);
        }

        .info-horizontal {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .info-pair {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            flex: 1;
            justify-content: center;
        }

        .info-pair .label {
            font-size: 16px;
            font-weight: var(--font-weight-medium);
            color: var(--text-secondary);
        }

        .info-pair .value {
            font-size: 16px;
            font-weight: var(--font-weight-semibold);
            color: var(--text-primary);
        }

        .info-pair .value.amount {
            font-size: 20px;
            color: var(--primary);
            font-family: 'Monaco', 'Courier New', monospace;
        }

        .usage-detail {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-1);
        }

        .reading-info {
            font-size: 12px;
            color: var(--text-tertiary);
            font-weight: var(--font-weight-regular);
        }


        /* è¯¦ç»†ä¿¡æ¯ç½‘æ ¼å¸ƒå±€ */
        .details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-8);
            margin-bottom: var(--space-8);
        }

        /* é˜¶æ¢¯æ”¶è´¹å’Œè´¹ç”¨æ˜ç»†è¡¨æ ¼ */
        .pricing-section,
        .cost-breakdown-section {
            background: var(--background);
            border: var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .section-header {
            padding: var(--space-5);
            background: var(--surface);
            border-bottom: var(--border);
        }

        .section-header h4 {
            margin: 0;
            font-size: 18px;
            font-weight: var(--font-weight-medium);
        }

        .pricing-table-container,
        .cost-table-container {
            padding: var(--space-5);
        }

        .pricing-table,
        .cost-table {
            border: var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .pricing-header,
        .cost-header {
            display: grid;
            gap: var(--space-3);
            background: var(--divider);
            padding: var(--space-4);
            font-weight: var(--font-weight-semibold);
            font-size: 14px;
            color: var(--text-primary);
        }

        .pricing-header {
            grid-template-columns: 1.5fr 1fr 1fr 1fr 1fr;
        }

        .cost-header {
            grid-template-columns: 2fr 1fr 2fr;
        }

        .pricing-body,
        .cost-body {
            max-height: none;
        }

        .pricing-row,
        .cost-row {
            display: grid;
            gap: var(--space-3);
            padding: var(--space-4);
            border-bottom: var(--border);
            font-size: 14px;
            transition: all 0.15s ease;
        }

        .pricing-row {
            grid-template-columns: 1.5fr 1fr 1fr 1fr 1fr;
        }

        .cost-row {
            grid-template-columns: 2fr 1fr 2fr;
        }

        .pricing-row:last-child,
        .cost-row:last-child {
            border-bottom: none;
        }

        .pricing-row.used {
            background: rgba(40, 167, 69, 0.05);
            border-left: 4px solid var(--success);
        }

        .pricing-row.unused {
            background: var(--surface);
            opacity: 0.6;
        }

        .cost-row {
            background: var(--background);
        }

        .cost-row:nth-child(even) {
            background: var(--surface);
        }

        .pricing-total,
        .cost-total {
            display: grid;
            gap: var(--space-3);
            padding: var(--space-4);
            background: var(--primary);
            color: white;
            font-weight: var(--font-weight-semibold);
        }

        .pricing-total {
            grid-template-columns: 2fr 1fr;
        }

        .cost-total {
            grid-template-columns: 2fr 1fr 2fr;
        }

        .pricing-total .total-label {
            grid-column: 1;
            text-align: right;
        }

        .cost-total .final-label {
            font-size: 16px;
        }

        .cost-total .final-amount {
            font-size: 18px;
            font-weight: var(--font-weight-bold);
        }

        .cost-total .final-desc {
            font-size: 13px;
            opacity: 0.9;
        }

        .tier-name,
        .cost-item {
            font-weight: var(--font-weight-medium);
        }

        .tier-rate,
        .tier-amount,
        .cost-amount {
            font-family: 'Monaco', 'Courier New', monospace;
            text-align: right;
        }

        .tier-usage {
            text-align: center;
        }

        .cost-desc {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* æ¯æ—¥ç”¨ç”µé‡è¯¦ç»†ä¿¡æ¯æ ·å¼ */
        .daily-usage-section {
            margin-top: var(--space-6);
            padding-top: var(--space-6);
            border-top: var(--border);
        }

        .daily-usage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-5);
        }

        .daily-usage-header h5 {
            margin: 0;
            font-size: 16px;
            font-weight: var(--font-weight-medium);
            color: var(--text-primary);
        }

        /* è§†å›¾åˆ‡æ¢æŒ‰é’® */
        .view-controls {
            display: flex;
            background: var(--surface);
            border-radius: var(--radius);
            padding: 2px;
            gap: 2px;
        }

        .view-btn {
            padding: var(--space-2) var(--space-3);
            border: none;
            background: transparent;
            border-radius: calc(var(--radius) - 2px);
            font-family: inherit;
            font-weight: var(--font-weight-medium);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.15s ease;
            color: var(--text-secondary);
        }

        .view-btn.active {
            background: var(--background);
            color: var(--text-primary);
            box-shadow: var(--shadow);
        }

        /* è§†å›¾å®¹å™¨ */
        .usage-view {
            display: none;
        }

        .usage-view.active {
            display: block;
        }

        /* è¡¨æ ¼è§†å›¾æ ·å¼ */
        .daily-table {
            border: var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            margin-top: var(--space-4);
        }

        .daily-table-header {
            display: grid;
            grid-template-columns: 1fr 1.2fr 1.2fr 1.2fr 1fr;
            gap: var(--space-3);
            background: var(--divider);
            padding: var(--space-3) var(--space-4);
            font-weight: var(--font-weight-semibold);
            font-size: 13px;
            color: var(--text-primary);
        }

        .daily-table-body {
            max-height: 300px;
            overflow-y: auto;
        }

        .daily-table-row {
            display: grid;
            grid-template-columns: 1fr 1.2fr 1.2fr 1.2fr 1fr;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-4);
            border-bottom: var(--border);
            font-size: 14px;
            transition: all 0.15s ease;
        }

        .daily-table-row:hover {
            background: var(--surface);
        }

        .daily-table-row:last-child {
            border-bottom: none;
        }

        .usage-cell,
        .peak-cell,
        .offpeak-cell {
            text-align: center;
            font-family: 'Monaco', 'Courier New', monospace;
        }

        .cost-cell {
            text-align: right;
            font-family: 'Monaco', 'Courier New', monospace;
            font-weight: var(--font-weight-medium);
        }

        /* æ—¥å†è§†å›¾æ ·å¼ */
        .calendar-container {
            margin-top: var(--space-4);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
            padding: 0 var(--space-2);
        }

        .calendar-header h6 {
            margin: 0;
            font-size: 16px;
            font-weight: var(--font-weight-medium);
        }

        .calendar-nav {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--surface);
            border-radius: 50%;
            font-size: 16px;
            font-weight: bold;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-nav:hover {
            background: var(--primary);
            color: white;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: var(--divider);
            padding: 2px;
            border-radius: var(--radius);
        }

        .calendar-weekday {
            background: var(--surface);
            padding: var(--space-2);
            text-align: center;
            font-weight: var(--font-weight-semibold);
            font-size: 12px;
            color: var(--text-secondary);
        }

        .calendar-day {
            background: var(--background);
            padding: var(--space-2);
            min-height: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
        }

        .calendar-day:hover {
            background: var(--surface);
        }

        .calendar-day.empty {
            background: var(--divider);
            cursor: default;
        }

        .calendar-day.empty:hover {
            background: var(--divider);
        }

        .calendar-day {
            position: relative;
        }

        .day-number {
            position: absolute;
            top: 4px;
            left: 4px;
            font-size: 10px;
            font-weight: var(--font-weight-medium);
            color: var(--text-secondary);
            z-index: 1;
        }

        .day-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 2px;
        }

        .day-unit {
            font-size: 9px;
            font-weight: var(--font-weight-regular);
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .day-usage-value {
            font-size: 18px;
            font-weight: var(--font-weight-semibold);
            color: var(--text-primary);
            font-family: 'Monaco', 'Courier New', monospace;
            line-height: 1;
        }

        /* ç”¨ç”µé‡æ ‡è®°æ ·å¼ */
        .usage-marker {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 8px;
            font-weight: var(--font-weight-semibold);
            padding: 1px 3px;
            border-radius: 2px;
            line-height: 1;
        }

        .high-marker {
            background: var(--error);
            color: white;
        }

        .low-marker {
            background: var(--info);
            color: white;
        }

        /* å±•å¼€æŒ‡ç¤ºå™¨ */

        /* æ¯å°æ—¶æ•°æ®è¡¨æ ¼ */
        .hourly-table-header {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
            gap: var(--space-2);
            padding: var(--space-3);
            background: var(--surface);
            border-radius: var(--radius);
            font-weight: var(--font-weight-medium);
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: var(--space-3);
        }

        /* æ¯å°æ—¶æ•°æ®é¡¹ */
        .hourly-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--space-2);
        }

        .hourly-item {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
            gap: var(--space-2);
            padding: var(--space-3);
            background: var(--background);
            border-radius: var(--radius);
            font-size: 13px;
            border-left: 3px solid;
        }

        .hourly-item.peak {
            border-left-color: var(--error);
            background: rgba(220, 53, 69, 0.02);
        }

        .hourly-item.standard {
            border-left-color: var(--accent);
            background: rgba(0, 102, 204, 0.02);
        }

        .hourly-item.valley {
            border-left-color: var(--success);
            background: rgba(40, 167, 69, 0.02);
        }

        .hour-time {
            font-weight: var(--font-weight-medium);
        }

        .hour-period {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .hour-usage {
            font-weight: var(--font-weight-medium);
        }

        .hour-rate,
        .hour-cost {
            text-align: right;
        }

        /* å³ä¾§æŠ½å±‰æ ·å¼ */
        .right-drawer {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            /* éš”ç¦»æ»šåŠ¨äº‹ä»¶ */
            overflow: hidden;
        }

        .right-drawer.show {
            opacity: 1;
            visibility: visible;
        }

        .right-drawer.hide {
            opacity: 0;
            visibility: hidden;
        }

        .drawer-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .drawer-content {
            position: absolute;
            top: 0;
            right: 0;
            width: 800px;
            height: 100%;
            background: var(--background);
            box-shadow: -4px 0 24px rgba(0, 0, 0, 0.1);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* å»æ‰ä¸»æŠ½å±‰æ»šåŠ¨æ¡ */
            /* é˜»æ­¢æ»šåŠ¨äº‹ä»¶å†’æ³¡åˆ°ä¸»é¡µé¢ */
            overscroll-behavior: contain;
        }

        .right-drawer.show .drawer-content {
            transform: translateX(0);
        }

        .drawer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-6);
            border-bottom: var(--border);
            flex-shrink: 0;
        }

        .drawer-header h3 {
            font-size: 20px;
            font-weight: var(--font-weight-medium);
            margin: 0;
        }

        .drawer-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: var(--space-2);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .drawer-close:hover {
            background: var(--surface);
        }

        .drawer-body {
            flex: 1;
            padding: var(--space-6);
            overflow: hidden; /* å»æ‰æŠ½å±‰ä¸»ä½“æ»šåŠ¨æ¡ */
        }


        .drawer-pricing-section {
            margin-bottom: var(--space-8);
        }

        .drawer-pricing-section h4 {
            font-size: 18px;
            font-weight: var(--font-weight-medium);
            margin: 0 0 var(--space-4) 0;
        }

        .drawer-time-pricing-summary {
            border: var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .drawer-summary-header {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr 1fr;
            gap: var(--space-3);
            background: var(--surface);
            padding: var(--space-4);
            font-weight: var(--font-weight-medium);
            font-size: 14px;
            color: var(--text-secondary);
        }

        .drawer-time-pricing-body {
            background: var(--background);
        }

        .drawer-time-pricing-body .time-pricing-row {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr 1fr;
            gap: var(--space-3);
            padding: var(--space-4);
            border-bottom: var(--border);
            font-size: 14px;
        }

        .drawer-time-pricing-body .time-pricing-row:last-child {
            border-bottom: none;
        }

        .drawer-pricing-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-4);
            background: var(--surface);
            font-weight: var(--font-weight-medium);
            font-size: 16px;
        }

        .drawer-explanation {
            margin-bottom: var(--space-8);
        }

        .drawer-explanation h4 {
            font-size: 18px;
            font-weight: var(--font-weight-medium);
            margin: 0 0 var(--space-4) 0;
        }

        .drawer-period-details {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }

        .drawer-period-item {
            background: var(--surface);
            padding: var(--space-5);
            border-radius: var(--radius);
            border-left: 4px solid;
        }

        .drawer-period-item.peak {
            border-left-color: var(--error);
        }

        .drawer-period-item.standard {
            border-left-color: var(--accent);
        }

        .drawer-period-item.valley {
            border-left-color: var(--success);
        }

        .drawer-period-item h5 {
            font-size: 16px;
            font-weight: var(--font-weight-medium);
            margin: 0 0 var(--space-2) 0;
        }

        .drawer-period-item p {
            margin: var(--space-1) 0;
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.5;
        }

        .drawer-billing-info h4 {
            font-size: 18px;
            font-weight: var(--font-weight-medium);
            margin: 0 0 var(--space-4) 0;
        }

        .drawer-billing-info ul {
            margin: 0;
            padding-left: var(--space-5);
        }

        .drawer-billing-info li {
            margin-bottom: var(--space-2);
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.5;
        }

        /* æŠ½å±‰æ¨¡å—æ ·å¼ */
        .drawer-usage-module {
            height: 100%;
            overflow: hidden; /* å»æ‰æ¨¡å—æ»šåŠ¨æ¡ */
        }

        .drawer-module-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
        }

        .drawer-module-title h3 {
            font-size: 20px;
            font-weight: var(--font-weight-medium);
            margin: 0;
        }

        .drawer-export-btn {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-4);
            background: var(--surface);
            border: var(--border);
            border-radius: var(--radius);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .drawer-export-btn:hover {
            background: var(--divider);
        }

        .drawer-module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-6);
            border-bottom: var(--border);
            margin-top: -20px; /* ä¸Šç§»20åƒç´  */
        }

        .drawer-header-left {
            display: flex;
            align-items: center;
        }

        .drawer-header-right {
            display: flex;
            align-items: center;
        }

        .drawer-view-tabs {
            display: flex;
            gap: var(--space-2);
            background: var(--surface);
            border-radius: var(--radius);
            padding: var(--space-1);
        }

        .drawer-tab-btn {
            flex: 1;
            padding: var(--space-2) var(--space-3);
            border: none;
            background: transparent;
            border-radius: 50px; /* æœ€å¤§åœ†è§’ */
            font-size: 14px;
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all 0.15s ease;
            color: var(--text-secondary);
        }

        .drawer-tab-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow);
        }

        .drawer-usage-view {
            display: none;
            overflow: hidden; /* å»æ‰è§†å›¾æ»šåŠ¨æ¡ */
        }

        .drawer-usage-view.active {
            display: block;
            overflow: hidden; /* å»æ‰æ¿€æ´»è§†å›¾æ»šåŠ¨æ¡ */
        }

        /* æŠ½å±‰è¡¨æ ¼æ ·å¼ */
        .drawer-daily-table {
            border: var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .drawer-daily-table-header {
            display: grid;
            grid-template-columns: 1fr 1.2fr 1fr 30px;
            gap: var(--space-3);
            background: var(--surface);
            padding: var(--space-4);
            font-weight: var(--font-weight-medium);
            font-size: 14px;
            color: var(--text-secondary);
        }

        .drawer-daily-table-body {
            max-height: 550px; /* å›ºå®šé«˜åº¦ï¼Œæ˜¾ç¤ºçº¦10å¤©æ•°æ®ï¼Œå…¶ä½™é€šè¿‡æ»šåŠ¨æŸ¥çœ‹å…¨éƒ¨30å¤© */
            overflow-y: auto; /* æ»šåŠ¨æŸ¥çœ‹æ‰€æœ‰æ•°æ® */
        }

        /* å±•å¼€çŠ¶æ€ä¸‹çš„è¡¨æ ¼é«˜åº¦ */
        .right-drawer.expanded .drawer-daily-table-body {
            max-height: 550px; /* å±•å¼€æ—¶ç»´æŒå›ºå®šé«˜åº¦ï¼Œé€šè¿‡æ»šåŠ¨æŸ¥çœ‹å…¨éƒ¨30å¤©æ•°æ® */
        }

        .drawer-daily-table-row {
            display: grid;
            grid-template-columns: 1fr 1.2fr 1fr 30px;
            gap: var(--space-3);
            padding: var(--space-4);
            border-bottom: var(--border);
            font-size: 14px;
        }

        /* é˜¶æ¢¯ç”µä»·è¡¨æ ¼ç‰¹å®šæ ·å¼ - 5åˆ—å¸ƒå±€ */
        #tiered-drawer-table-header {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 30px;
            gap: var(--space-3);
            background: var(--surface);
            padding: var(--space-4);
            font-weight: var(--font-weight-medium);
            font-size: 14px;
            color: var(--text-secondary);
        }

        #tiered-drawer-table-body .drawer-daily-table-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 30px;
            gap: var(--space-3);
            padding: var(--space-4);
            border-bottom: var(--border);
            font-size: 14px;
        }

        .drawer-expand-icon {
            font-size: 14px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.15s ease;
            font-weight: bold;
        }

        .drawer-daily-table-row:hover {
            background: var(--surface);
        }

        .drawer-daily-table-row:last-child {
            border-bottom: none;
        }

        /* æŠ½å±‰æ—¥å†æ ·å¼ */
        .drawer-calendar-container {
            background: var(--background);
            border: var(--border);
            border-radius: var(--radius);
            padding: var(--space-6);
            box-shadow: var(--shadow);
            /* ç§»é™¤é«˜åº¦é™åˆ¶ï¼Œè®©æ—¥å†å®Œæ•´æ˜¾ç¤º */
        }

        /* æŠ½å±‰æ‰©å±•åŠŸèƒ½ */
        .right-drawer {
            transition: all 0.3s ease;
        }

        .right-drawer.expanded .drawer-content {
            width: 1150px; /* æ—¥å†600px + è¯¦æƒ…500px + é—´éš™50px */
            max-width: 90vw;
        }

        .right-drawer.expanded .drawer-usage-view.active {
            display: flex;
            gap: var(--space-6);
        }

        .right-drawer.expanded .drawer-calendar-container,
        .right-drawer.expanded .drawer-table-container {
            flex: 0 0 auto;
            width: 600px; /* å›ºå®šå®½åº¦ï¼Œä¿æŒåŸæ¥å¤§å° */
            height: 100%; /* ç¡®ä¿å®¹å™¨æœ‰è¶³å¤Ÿé«˜åº¦ */
        }

        /* åªæœ‰æ¿€æ´»çš„è§†å›¾æ‰æ˜¾ç¤º */

        /* è§†å›¾å±•å¼€æ—¶çš„ç‰¹æ®Šæ ·å¼ - åªå¯¹æ¿€æ´»çš„è§†å›¾åº”ç”¨flexå¸ƒå±€ */
        .right-drawer.expanded #drawer-table-view.active,
        .right-drawer.expanded #drawer-calendar-view.active,
        .right-drawer.expanded #tiered-drawer-table-view.active,
        .right-drawer.expanded #tiered-drawer-calendar-view.active {
            display: flex !important;
            gap: var(--space-6);
        }

        /* æ¯å°æ—¶è¯¦æƒ…é¢æ¿ */
        .drawer-hourly-details-panel {
            flex: 0 0 auto;
            width: 500px; /* å›ºå®šå®½åº¦çš„è¯¦æƒ…é¢æ¿ */
            background: var(--background);
            border: var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            height: fit-content;
            align-self: flex-start;
        }

        .drawer-hourly-header {
            padding: var(--space-4) var(--space-6);
            border-bottom: var(--border);
            background: var(--surface);
            border-radius: var(--radius) var(--radius) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .drawer-hourly-header h4 {
            margin: 0;
            font-size: 16px;
            font-weight: var(--font-weight-medium);
        }

        .drawer-hourly-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.15s ease;
        }

        .drawer-hourly-close:hover {
            background: var(--divider);
            color: var(--text-primary);
        }

        .drawer-hourly-content {
            padding: var(--space-6);
            max-height: 500px;
            overflow-y: auto; /* æ¢å¤æ¯å°æ—¶è¯¦æƒ…æ»šåŠ¨æ¡ */
        }

        /* ç®€å•è¡¨æ ¼æ ·å¼ */
        .simple-hourly-table {
            width: 100%;
            border-collapse: collapse;
        }

        .simple-hourly-table th {
            background: #f5f5f5;
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
            font-weight: bold;
        }

        .simple-hourly-table td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }

        .simple-hourly-table tr:hover {
            background: #f9f9f9;
        }

        .merged-period {
            text-align: center;
            vertical-align: middle;
            font-weight: bold;
        }

        /* æ—¶æ®µé¢œè‰²åŒºåˆ† - ä¸åŸºç¡€ç”µè´¹è¡¨æ ¼é¢œè‰²ä¿æŒä¸€è‡´ */
        .peak-hour {
            background: rgba(220, 53, 69, 0.05);
        }

        .peak-hour .merged-period {
            background: rgba(220, 53, 69, 0.1);
            border-left: 3px solid #dc3545;
            color: #dc3545;
        }

        .standard-hour {
            background: rgba(0, 102, 204, 0.05);
        }

        .standard-hour .merged-period {
            background: rgba(0, 102, 204, 0.1);
            border-left: 3px solid #0066cc;
            color: #0066cc;
        }

        .valley-hour {
            background: rgba(40, 167, 69, 0.05);
        }

        .valley-hour .merged-period {
            background: rgba(40, 167, 69, 0.1);
            border-left: 3px solid #28a745;
            color: #28a745;
        }

        /* æ—¶æ®µåˆ†éš”æ ‡é¢˜ */
        .drawer-period-separator {
            background: var(--surface);
            padding: var(--space-2) var(--space-3);
            margin: var(--space-2) 0;
            border-radius: var(--radius);
            border-left: 3px solid var(--accent);
        }

        .period-title {
            font-weight: var(--font-weight-medium);
            font-size: 14px;
            color: var(--text-primary);
        }

        /* æŠ½å±‰æ—¥å†é€‰ä¸­çŠ¶æ€ - é»‘è‰² */
        .drawer-calendar-day.selected,
        #tiered-drawer-calendar-grid .drawer-calendar-day.selected {
            background: #000000 !important;
            color: white !important;
            transform: scale(1.05);
            border: 2px solid #0066CC !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
            z-index: 10;
            position: relative;
        }

        .drawer-calendar-day.selected .drawer-day-content {
            color: white !important;
        }

        .drawer-calendar-day.selected .drawer-day-number {
            color: white !important;
            font-weight: bold;
        }

        .drawer-calendar-day.selected .drawer-day-usage-value {
            color: white !important;
        }

        .drawer-calendar-day.selected .drawer-day-unit {
            color: white !important;
        }

        /* ç¡®ä¿é€‰ä¸­çŠ¶æ€ä¸‹æ‰€æœ‰å­å…ƒç´ éƒ½æ˜¯ç™½è‰² */
        .drawer-calendar-day.selected * {
            color: white !important;
        }

        /* é€‰ä¸­çŠ¶æ€ä¸‹çš„æ ‡è®°ç‚¹ä¹Ÿè¦æ˜¾ç¤ºä¸ºç™½è‰² */
        .drawer-calendar-day.selected .drawer-max-marker {
            color: white !important;
        }

        /* ç‰¹åˆ«ä¸ºé˜¶æ¢¯ç”µä»·æ—¥å†å¢åŠ é€‰ä¸­çŠ¶æ€ */
        #tiered-drawer-calendar-grid .drawer-calendar-day.selected {
            background: #000000 !important;
            color: white !important;
            transform: scale(1.05) !important;
            border: 2px solid #0066CC !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
            z-index: 10 !important;
            position: relative !important;
        }
        #tiered-drawer-calendar-grid .drawer-calendar-day.selected * {
            color: white !important;
        }

        /* å°å°ºå¯¸é»‘è‰²æŒ‰é’®æ ·å¼ */
        .btn-primary-small {
            background: #000000;
            color: white;
            border: none;
            padding: var(--space-1) var(--space-2);
            border-radius: calc(var(--radius) / 2);
            font-size: 11px;
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all 0.15s ease;
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
        }

        .btn-primary-small:hover {
            background: #333333;
            transform: translateY(-1px);
        }

        .drawer-calendar-day {
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .drawer-calendar-day:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .drawer-calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-6);
            padding-bottom: var(--space-4);
            border-bottom: var(--border);
        }

        .drawer-calendar-title-wrapper {
            text-align: center;
            flex: 1;
        }

        .drawer-calendar-title-wrapper h3 {
            margin: 0 0 var(--space-1) 0;
            font-size: 20px;
            font-weight: var(--font-weight-medium);
            color: var(--text-primary);
        }

        .drawer-calendar-subtitle {
            margin: 0;
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: var(--font-weight-regular);
        }

        .drawer-calendar-nav {
            background: var(--surface);
            border: var(--border);
            border-radius: var(--radius);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-secondary);
        }

        .drawer-calendar-nav:hover {
            background: var(--divider);
            color: var(--text-primary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-hover);
        }

        .drawer-calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: var(--space-2);
            margin-bottom: var(--space-2); /* å‡å°é—´è· */
        }

        .drawer-weekday {
            text-align: center;
            font-size: 12px;
            font-weight: var(--font-weight-semibold);
            color: var(--text-secondary);
            padding: var(--space-2);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }


        .drawer-calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: var(--border);
            border-radius: var(--radius);
            background: var(--surface);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            min-height: 50px; /* é€‚ä¸­é«˜åº¦ç¡®ä¿å†…å®¹å¯è§ */
        }

        .drawer-calendar-day:hover {
            background: var(--divider);
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .drawer-calendar-day.today {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .drawer-calendar-day.today:hover {
            background: #0052A3;
        }

        .drawer-calendar-day.other-month {
            color: var(--text-tertiary);
            background: transparent;
        }

        .drawer-calendar-day.other-month:hover {
            background: var(--surface);
        }

        /* æ—¥å†åˆ‡æ¢æ§ä»¶æ ·å¼ */
        .calendar-controls {
            margin-bottom: var(--space-4);
        }

        .calendar-toggle {
            display: flex;
            background: var(--surface);
            border-radius: var(--radius);
            padding: var(--space-1);
            width: fit-content;
        }

        .calendar-toggle-btn {
            padding: var(--space-2) var(--space-4);
            border: none;
            background: transparent;
            border-radius: calc(var(--radius) - 2px);
            font-size: 14px;
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all 0.15s ease;
            color: var(--text-secondary);
        }

        .calendar-toggle-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow);
        }

        /* æŠ½å±‰æ—¥å†åˆ‡æ¢æ§ä»¶æ ·å¼ */
        .drawer-calendar-controls {
            margin-bottom: var(--space-4);
        }

        .drawer-calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-3); /* å‡å°é—´è· */
        }

        .drawer-calendar-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: var(--font-weight-medium);
        }


        /* æŠ½å±‰è¡¨æ ¼é€‰ä¸­æ—¥æœŸæ ·å¼ */
        .selected-day-row {
            background: rgba(0, 102, 204, 0.1) !important;
            font-weight: var(--font-weight-medium);
        }

        /* è¡¨æ ¼è¡Œé€‰ä¸­çŠ¶æ€ */
        .drawer-daily-table-row.selected {
            background: #000000 !important;
            color: white !important;
            transform: scale(1.02);
        }

        .drawer-daily-table-row.selected span {
            color: white !important;
        }

        .drawer-daily-table-row {
            transition: all 0.2s ease;
        }

        .drawer-daily-table-row:hover {
            background: var(--surface);
            transform: translateY(-1px);
        }

        .drawer-hourly-details-row {
            display: none;
            padding: var(--space-4);
            background: var(--surface);
            border-top: var(--border);
        }

        .drawer-hourly-details-row.expanded {
            display: block;
        }

        .drawer-hourly-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: var(--space-2);
            max-height: 300px;
            overflow-y: auto;
            border: var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .hourly-header {
            display: contents;
            font-weight: var(--font-weight-semibold);
            background: var(--surface);
        }

        .hourly-header span {
            background: var(--surface);
            border-bottom: 2px solid var(--divider) !important;
        }

        .hourly-item {
            display: contents;
        }

        .hourly-item span {
            padding: var(--space-2);
            border-bottom: 1px solid var(--divider);
            font-size: 13px;
        }

        .hour-time {
            font-weight: var(--font-weight-medium);
        }

        .hour-period {
            text-align: center;
        }

        .hour-usage,
        .hour-rate,
        .hour-cost {
            text-align: right;
        }

        .drawer-calendar-toggle {
            display: flex;
            background: var(--surface);
            border-radius: var(--radius);
            padding: var(--space-1);
            width: fit-content;
        }

        .drawer-calendar-toggle-btn {
            padding: var(--space-2) var(--space-3);
            border: none;
            background: transparent;
            border-radius: calc(var(--radius) - 2px);
            font-size: 13px;
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all 0.15s ease;
            color: var(--text-secondary);
        }

        .drawer-calendar-toggle-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow);
        }

        /* æœ€é«˜å€¼æ ‡è®°ç‚¹æ ·å¼ */
        .max-marker {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 8px;
            z-index: 2;
        }

        .max-marker.usage-max {
            color: #FF6B35; /* ç”¨ç”µé‡æœ€é«˜ - æ©™è‰² */
        }

        .max-marker.cost-max {
            color: #E74C3C; /* è´¹ç”¨æœ€é«˜ - çº¢è‰² */
        }

        .drawer-max-marker {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 6px;
            z-index: 2;
        }

        .drawer-max-marker.usage-max {
            color: #FF6B35; /* ç”¨ç”µé‡æœ€é«˜ - æ©™è‰² */
        }

        .drawer-max-marker.cost-max {
            color: #E74C3C; /* è´¹ç”¨æœ€é«˜ - çº¢è‰² */
        }

        /* æ—¥å†å·¦å³å¸ƒå±€ */
        .calendar-layout {
            display: flex;
            gap: var(--space-8);
            height: 600px;
        }

        .calendar-left {
            flex: 1;
            min-width: 0;
        }

        .calendar-right {
            width: 400px;
            flex-shrink: 0;
        }

        .calendar-day.selected {
            background: var(--accent);
            color: white;
        }

        .calendar-day.selected .day-number,
        .calendar-day.selected .day-usage-value,
        .calendar-day.selected .day-unit {
            color: white;
        }

        .calendar-day.selected .max-marker {
            color: rgba(255, 255, 255, 0.8);
        }

        /* å³ä¾§æ¯å°æ—¶è¯¦æƒ…é¢æ¿ */
        .hourly-details-panel {
            background: var(--background);
            border: var(--border);
            border-radius: var(--radius);
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .hourly-details-header {
            padding: var(--space-6);
            border-bottom: var(--border);
        }

        .hourly-details-header h4 {
            font-size: 18px;
            font-weight: var(--font-weight-medium);
            margin: 0;
        }

        .hourly-details-content {
            flex: 1;
            overflow-y: auto;
        }

        .drawer-calendar-day {
            position: relative;
        }

        .drawer-day-number {
            position: absolute;
            top: 3px;
            left: 3px;
            font-size: 9px;
            font-weight: var(--font-weight-medium);
            color: var(--text-secondary);
            z-index: 1;
        }

        .drawer-day-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 2px;
        }

        .drawer-day-unit {
            font-size: 8px;
            font-weight: var(--font-weight-regular);
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .drawer-day-usage-value {
            font-size: 16px;
            font-weight: var(--font-weight-semibold);
            color: var(--text-primary);
            font-family: 'Monaco', 'Courier New', monospace;
            line-height: 1;
        }

        .drawer-calendar-day.today .drawer-day-number {
            color: rgba(255, 255, 255, 0.8);
        }

        .drawer-calendar-day.today .drawer-day-unit {
            color: rgba(255, 255, 255, 0.6);
        }

        .drawer-calendar-day.today .drawer-day-usage-value {
            color: rgba(255, 255, 255, 0.95);
        }


        .drawer-calendar-legend {
            display: flex;
            justify-content: center;
            gap: var(--space-6);
            padding-top: var(--space-4);
            border-top: var(--border);
        }

        .drawer-calendar-legend .legend-item {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: 12px;
            color: var(--text-secondary);
        }

        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .legend-dot.low-usage {
            background: var(--success);
        }

        .legend-dot.medium-usage {
            background: var(--warning);
        }

        .legend-dot.high-usage {
            background: var(--error);
        }

        /* é˜¶æ¢¯ç”µä»·ç›¸å…³æ ·å¼ */
        .legend-dot.tier-1 {
            background: #28A745; /* ç»¿è‰² - é˜¶æ¢¯1 */
        }

        .legend-dot.tier-2 {
            background: #FFC107; /* é»„è‰² - é˜¶æ¢¯2 */
        }

        .legend-dot.tier-3 {
            background: #FF9500; /* æ©™è‰² - é˜¶æ¢¯3 */
        }

        .legend-dot.tier-4 {
            background: #DC3545; /* çº¢è‰² - é˜¶æ¢¯4 */
        }

        /* é˜¶æ¢¯ç”µä»·æ—¥å†å¤©æ•°æ ·å¼ */
        .drawer-calendar-day.tier-1 {
            background: rgba(40, 167, 69, 0.1);
            border-left: 3px solid #28A745;
        }

        .drawer-calendar-day.tier-2 {
            background: rgba(255, 193, 7, 0.1);
            border-left: 3px solid #FFC107;
        }

        .drawer-calendar-day.tier-3 {
            background: rgba(255, 149, 0, 0.1);
            border-left: 3px solid #FF9500;
        }

        .drawer-calendar-day.tier-4 {
            background: rgba(220, 53, 69, 0.1);
            border-left: 3px solid #DC3545;
        }

        .drawer-calendar-nav {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--surface);
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .drawer-calendar-nav:hover {
            background: var(--divider);
        }

        .drawer-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--divider);
            border-radius: var(--radius);
            overflow: hidden;
            margin-bottom: var(--space-3); /* å‡å°åº•éƒ¨é—´è· */
        }

        .drawer-calendar-grid .calendar-day {
            min-height: 40px;
            font-size: 12px;
        }

        /* æŠ½å±‰å›¾è¡¨æ ·å¼ */
        .drawer-chart-container {
            margin-top: var(--space-4);
            padding: var(--space-6);
            background: var(--background);
            border: var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .chart-legend {
            display: flex;
            justify-content: center;
            gap: var(--space-6);
            margin-bottom: var(--space-4);
            padding: var(--space-3);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: 14px;
            cursor: pointer;
        }

        .legend-item input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
        }

        .legend-color {
            width: 20px;
            height: 3px;
            border-radius: 2px;
        }

        .legend-color.usage-line {
            background: #0066CC;
        }

        .legend-color.cost-line {
            background: #28A745;
        }

        .legend-item label {
            cursor: pointer;
            user-select: none;
            font-weight: var(--font-weight-medium);
        }

        #drawer-usage-chart {
            width: 720px;
            height: 400px;
            border: none;
            border-radius: var(--radius);
            margin: 0 auto;
            display: block;
            background: var(--background);
        }

        /* æŠ½å±‰æ¯å°æ—¶è¯¦æƒ…å±•å¼€æ ·å¼ */
        .drawer-hourly-details-row {
            background: var(--surface);
            border-bottom: var(--border);
        }

        .drawer-hourly-content {
            padding: var(--space-4);
        }

        .drawer-hourly-header {
            margin-bottom: var(--space-4);
        }

        .drawer-hourly-header h5 {
            font-size: 16px;
            font-weight: var(--font-weight-medium);
            margin: 0;
            color: var(--text-primary);
        }

        .drawer-hourly-table {
            border: var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .drawer-hourly-table-header {
            display: grid;
            grid-template-columns: 80px 80px 100px 80px 100px;
            gap: var(--space-2);
            background: var(--background);
            padding: var(--space-3);
            font-weight: var(--font-weight-medium);
            font-size: 13px;
            color: var(--text-secondary);
        }

        .drawer-hourly-table-body {
            /* ç§»é™¤é«˜åº¦é™åˆ¶å’Œæ»šåŠ¨ï¼Œæ˜¾ç¤ºå…¨éƒ¨24å°æ—¶ */
        }

        .drawer-hourly-row {
            display: grid;
            grid-template-columns: 80px 80px 100px 80px 100px;
            gap: var(--space-2);
            padding: var(--space-3);
            border-bottom: var(--border);
            font-size: 13px;
            align-items: center;
        }

        .drawer-hourly-row:last-child {
            border-bottom: none;
        }

        .drawer-hourly-row:hover {
            background: var(--surface);
        }

        /* é˜¶æ¢¯ç”µä»·æ¯å°æ—¶æ˜ç»†è¡Œ - 3åˆ—å¸ƒå±€ï¼šæ—¶é—´ã€ç”µé‡ã€ç´¯è®¡ */
        .tiered-drawer-hourly-row {
            display: grid;
            grid-template-columns: 80px 100px 100px;
            gap: var(--space-2);
            padding: var(--space-3);
            border-bottom: var(--border);
            font-size: 13px;
            align-items: center;
        }

        .tiered-drawer-hourly-row:last-child {
            border-bottom: none;
        }

        .tiered-drawer-hourly-row:hover {
            background: var(--surface);
        }

        .drawer-hour-period {
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: var(--font-weight-medium);
            text-align: center;
        }

        .drawer-hour-period.peak {
            background: rgba(220, 53, 69, 0.1);
            color: var(--error);
        }

        .drawer-hour-period.standard {
            background: rgba(0, 102, 204, 0.1);
            color: var(--accent);
        }

        .drawer-hour-period.valley {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success);
        }

        /* æŠ½å±‰ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .drawer-content {
                width: 100%;
                max-width: 600px;
            }

            .drawer-body {
                padding: var(--space-4);
            }

            .drawer-header {
                padding: var(--space-4);
            }

            .drawer-body {
                padding: var(--space-4);
            }

            .drawer-module-header {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--space-3);
                padding: var(--space-4);
            }

            .drawer-header-left,
            .drawer-header-right {
                width: 100%;
            }

            .drawer-view-tabs {
                flex-direction: column;
                gap: var(--space-1);
                width: 100%;
            }

            .drawer-tab-btn {
                text-align: left;
            }

            #drawer-usage-chart {
                width: 100%;
                max-width: 600px;
                height: 300px;
            }

            .drawer-daily-table-header,
            .drawer-daily-table-row {
                grid-template-columns: 1fr;
                gap: var(--space-2);
                text-align: left;
            }

            .drawer-daily-table-row {
                padding: var(--space-3);
                background: var(--surface);
                margin-bottom: var(--space-2);
                border-radius: var(--radius);
                border: var(--border);
                position: relative;
            }

            .drawer-daily-table-row:last-child {
                margin-bottom: 0;
            }

            .drawer-expand-icon {
                position: absolute;
                top: var(--space-3);
                right: var(--space-3);
                font-size: 16px;
            }

            .drawer-date-cell::before { content: "æ—¥æœŸ: "; font-weight: bold; }
            .drawer-usage-cell::before { content: "ç”¨ç”µé‡: "; font-weight: bold; }
            .drawer-cost-cell::before { content: "é‡‘é¢: "; font-weight: bold; }

            /* æŠ½å±‰æ¯å°æ—¶è¯¦æƒ…ç§»åŠ¨ç«¯æ ·å¼ */
            .drawer-hourly-table-header {
                display: none;
            }

            .drawer-hourly-row {
                grid-template-columns: 1fr;
                gap: var(--space-1);
                padding: var(--space-3);
                background: var(--background);
                margin-bottom: var(--space-2);
                border-radius: var(--radius);
                border: var(--border);
            }

            .drawer-hourly-row:last-child {
                margin-bottom: 0;
            }

            .drawer-hour-time::before { content: "æ—¶é—´: "; font-weight: bold; }
            .drawer-hour-usage::before { content: "ç”¨ç”µé‡: "; font-weight: bold; }
            .drawer-hour-rate::before { content: "å•ä»·: "; font-weight: bold; }
            .drawer-hour-cost::before { content: "é‡‘é¢: "; font-weight: bold; }

            /* é˜¶æ¢¯ç”µä»·æ¯å°æ—¶æ˜ç»†ç§»åŠ¨ç«¯æ ·å¼ */
            .tiered-drawer-hourly-row {
                grid-template-columns: 1fr;
                gap: var(--space-1);
                padding: var(--space-3);
                background: var(--background);
                margin-bottom: var(--space-2);
                border-radius: var(--radius);
                border: var(--border);
            }

            .tiered-drawer-hourly-row:last-child {
                margin-bottom: 0;
            }

            .tiered-drawer-hour-time::before { content: "æ—¶é—´: "; font-weight: bold; }
            .tiered-drawer-hour-usage::before { content: "ç”¨ç”µé‡: "; font-weight: bold; }
            .tiered-drawer-hour-cumulative::before { content: "ç´¯è®¡: "; font-weight: bold; }

            .drawer-hour-period {
                align-self: flex-start;
                margin-top: var(--space-1);
            }

            .drawer-calendar-grid .calendar-day {
                min-height: 35px;
                font-size: 11px;
            }

            #drawer-usage-chart {
                width: 100%;
                height: 150px;
            }
        }

        /* section-headeræ ·å¼è°ƒæ•´ */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
        }


        /* å›¾è¡¨è§†å›¾æ ·å¼ */
        .chart-container {
            margin-top: var(--space-4);
            background: var(--background);
            border: var(--border);
            border-radius: var(--radius);
            padding: var(--space-5);
        }

        #usage-chart {
            width: 100%;
            height: 200px;
            display: block;
        }

        .chart-summary {
            display: flex;
            justify-content: space-around;
            margin-top: var(--space-4);
            padding-top: var(--space-4);
            border-top: var(--border);
        }


        /* åˆ†æ—¶ç”µä»·æ ·å¼ */
        .time-pricing-rules {
            margin-bottom: var(--space-6);
        }

        .time-pricing-rules .rule-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-4);
            border-radius: var(--radius);
            border-left: 4px solid;
            margin-bottom: var(--space-3);
        }

        .time-pricing-rules .rule-item.peak {
            background: rgba(220, 53, 69, 0.1);
            border-left-color: var(--error);
        }

        .time-pricing-rules .rule-item.standard {
            background: rgba(0, 102, 204, 0.1);
            border-left-color: var(--accent);
        }

        .time-pricing-rules .rule-item.valley {
            background: rgba(40, 167, 69, 0.1);
            border-left-color: var(--success);
        }

        .rule-info {
            flex: 1;
        }

        .rule-time {
            display: block;
            font-weight: var(--font-weight-medium);
            margin-bottom: var(--space-1);
        }

        .rule-price {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .rule-rate {
            font-family: 'Monaco', 'Courier New', monospace;
            font-weight: var(--font-weight-semibold);
            font-size: 16px;
            color: var(--text-primary);
        }

        /* åˆ†æ—¶ç”µä»·æ±‡æ€»è¡¨æ ¼ */
        .time-pricing-summary {
            border: var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .summary-header {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr 1fr;
            gap: var(--space-3);
            background: var(--divider);
            padding: var(--space-4);
            font-weight: var(--font-weight-semibold);
            font-size: 14px;
            color: var(--text-primary);
        }

        .time-pricing-body {
            max-height: none;
        }

        .time-pricing-row {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr 1fr;
            gap: var(--space-3);
            padding: var(--space-4);
            border-bottom: var(--border);
            font-size: 14px;
            transition: all 0.15s ease;
            border-left: 3px solid;
        }

        .time-pricing-row:last-child {
            border-bottom: none;
        }

        .time-pricing-row.peak {
            background: rgba(220, 53, 69, 0.05);
            border-left-color: var(--error);
        }

        .time-pricing-row.standard {
            background: rgba(0, 102, 204, 0.05);
            border-left-color: var(--accent);
        }

        .time-pricing-row.valley {
            background: rgba(40, 167, 69, 0.05);
            border-left-color: var(--success);
        }

        .period-name {
            font-weight: var(--font-weight-medium);
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }
        .period-title {
            font-size: 14px;
            font-weight: var(--font-weight-medium);
        }
        .period-time {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: var(--font-weight-regular);
        }

        .period-usage,
        .period-rate,
        .period-amount {
            font-family: 'Monaco', 'Courier New', monospace;
            text-align: right;
        }

        /* è¡¨æ ¼æ ·å¼ */
        .daily-table-header {
            grid-template-columns: 1fr 1.2fr 1.2fr 1fr;
        }

        .daily-table-row {
            grid-template-columns: 1fr 1.2fr 1.2fr 1fr;
        }

        .cumulative-cell,
        .tier-cell,
        .standard-cell,
        .valley-cell {
            text-align: center;
            font-family: 'Monaco', 'Courier New', monospace;
        }

        .tier-cell {
            font-weight: var(--font-weight-medium);
            color: var(--accent);
        }

        /* åˆ†æ—¶ç”µä»·è¡¨æ ¼æ ·å¼ */
        .daily-table-header.time-of-use {
            grid-template-columns: 1fr 1.2fr 1fr 30px;
        }

        .daily-table-row.time-of-use {
            grid-template-columns: 1fr 1.2fr 1fr 30px;
        }

        .expand-icon {
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
            transition: transform 0.15s ease;
        }

        .daily-table-row.time-of-use:hover {
            background: var(--surface);
        }

        /* æ¯å°æ—¶è¯¦æƒ…å±•å¼€è¡Œ */
        .hourly-details-row {
            grid-column: 1 / -1;
            background: var(--surface);
            border-bottom: var(--border);
        }

        .hourly-details-content {
            padding: var(--space-4);
        }

        .hourly-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: var(--space-3);
        }

        .hourly-item-small {
            background: var(--background);
            padding: var(--space-3);
            border-radius: var(--radius);
            font-size: 12px;
            border-left: 3px solid;
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }

        .hourly-item-small.peak {
            border-left-color: var(--error);
        }

        .hourly-item-small.standard {
            border-left-color: var(--accent);
        }

        .hourly-item-small.valley {
            border-left-color: var(--success);
        }

        .hour-time-small {
            font-weight: var(--font-weight-medium);
            font-size: 11px;
        }

        .hour-usage-small {
            font-weight: var(--font-weight-medium);
            color: var(--text-primary);
        }

        .hour-period-small {
            font-size: 10px;
            color: var(--text-secondary);
        }

        /* ç‹¬ç«‹çš„æ¯æ—¥ç”¨ç”µé‡æ¨¡å—æ ·å¼ */



        /* ä¸šæ€æ ·å¼ */
        .business-type {
            padding: var(--space-1) var(--space-2);
            border-radius: calc(var(--radius) / 2);
            font-size: 12px;
            font-weight: var(--font-weight-medium);
            display: inline-block;
        }

        .business-type {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .details-grid {
                grid-template-columns: 1fr;
                gap: var(--space-6);
            }

            .info-horizontal {
                flex-wrap: wrap;
                gap: var(--space-6);
            }
        }

        @media (max-width: 768px) {
            .page-header {
                flex-direction: column;
                align-items: stretch;
                gap: var(--space-4);
            }

            .header-left {
                flex-direction: column;
                gap: var(--space-3);
            }

            .header-actions {
                justify-content: stretch;
            }

            .info-horizontal {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--space-4);
            }


            .header-title-section {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--space-2);
            }

            .header-info {
                flex-direction: column;
                gap: var(--space-3);
            }

            .pricing-header,
            .pricing-row,
            .pricing-total {
                grid-template-columns: 1fr;
                gap: var(--space-2);
                text-align: left;
            }

            .cost-header,
            .cost-row,
            .cost-total {
                grid-template-columns: 1fr;
                gap: var(--space-2);
                text-align: left;
            }

            .pricing-total .total-label {
                grid-column: 1;
                text-align: left;
            }

            .tier-rate,
            .tier-amount,
            .cost-amount {
                text-align: left;
            }

            /* æ¯æ—¥ç”¨ç”µé‡ç§»åŠ¨ç«¯æ ·å¼ */
            .daily-usage-header {
                flex-direction: column;
                align-items: stretch;
                gap: var(--space-3);
            }

            .view-controls {
                justify-content: center;
            }

            .daily-table-header,
            .daily-table-row {
                grid-template-columns: 1fr;
                gap: var(--space-2);
                text-align: left;
            }

            .daily-table-row {
                padding: var(--space-4);
                border-bottom: var(--border);
                display: block;
                background: var(--surface);
                margin-bottom: var(--space-2);
                border-radius: var(--radius);
                border: var(--border);
            }

            .daily-table-row:last-child {
                margin-bottom: 0;
            }

            .date-cell,
            .usage-cell,
            .peak-cell,
            .offpeak-cell,
            .cost-cell {
                display: block;
                text-align: left;
                margin-bottom: var(--space-1);
            }

            .date-cell::before { content: "æ—¥æœŸ: "; font-weight: bold; }
            .usage-cell::before { content: "ç”¨ç”µé‡: "; font-weight: bold; }
            .peak-cell::before { content: "å³°æ—¶: "; font-weight: bold; }
            .offpeak-cell::before { content: "è°·æ—¶: "; font-weight: bold; }
            .cost-cell::before { content: "è´¹ç”¨: "; font-weight: bold; }

            .calendar-grid {
                gap: 1px;
            }

            .calendar-day {
                min-height: 40px;
                padding: var(--space-1);
            }

            .day-number {
                top: 3px;
                left: 3px;
                font-size: 9px;
            }

            .day-unit {
                font-size: 8px;
            }

            .day-usage-value {
                font-size: 16px;
            }

            .drawer-day-number {
                top: 2px;
                left: 2px;
                font-size: 8px;
            }

            .drawer-day-unit {
                font-size: 7px;
            }

            .drawer-day-usage-value {
                font-size: 14px;
            }

            .calendar-controls {
                margin-bottom: var(--space-3);
            }

            .calendar-toggle-btn {
                padding: var(--space-2) var(--space-3);
                font-size: 13px;
            }

            .drawer-calendar-controls {
                margin-bottom: var(--space-3);
            }

            .drawer-calendar-toggle-btn {
                padding: var(--space-1) var(--space-2);
                font-size: 12px;
            }

            .max-marker {
                top: 1px;
                right: 1px;
                font-size: 7px;
            }

            .drawer-max-marker {
                top: 1px;
                right: 1px;
                font-size: 5px;
            }

            .calendar-layout {
                flex-direction: column;
                height: auto;
            }

            .calendar-right {
                width: 100%;
                margin-top: var(--space-6);
            }

            .hourly-details-panel {
                height: 400px;
            }

            .usage-marker {
                font-size: 7px;
                padding: 1px 2px;
            }
            .hourly-table-header {
                display: none;
            }
            .hourly-list {
                grid-template-columns: 1fr;
            }
            .hourly-item {
                grid-template-columns: 1fr;
                gap: var(--space-1);
                padding: var(--space-2);
            }
            .hourly-item .hour-time::before { content: "æ—¶é—´: "; font-weight: bold; }
            .hourly-item .hour-period::before { content: "æ—¶æ®µ: "; font-weight: bold; }
            .hourly-item .hour-usage::before { content: "ç”¨ç”µé‡: "; font-weight: bold; }
            .hourly-item .hour-rate::before { content: "ç”µä»·: "; font-weight: bold; }
            .hourly-item .hour-cost::before { content: "é‡‘é¢: "; font-weight: bold; }

            /* è¡¨æ ¼å±•å¼€çš„æ¯å°æ—¶æ•°æ®ç§»åŠ¨ç«¯æ ·å¼ */
            .hourly-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: var(--space-2);
            }
            .hourly-item-small {
                padding: var(--space-2);
                font-size: 11px;
            }
            .hour-time-small {
                font-size: 10px;
            }
            .hour-period-small {
                font-size: 9px;
            }


            .chart-summary {
                flex-direction: column;
                gap: var(--space-3);
            }



            /* åˆ†æ—¶ç”µä»·ç§»åŠ¨ç«¯æ ·å¼ */
            .time-pricing-rules .rule-item {
                flex-direction: column;
                align-items: stretch;
                gap: var(--space-2);
            }

            .rule-rate {
                text-align: left;
                margin-top: var(--space-2);
            }

            .summary-header,
            .time-pricing-row {
                grid-template-columns: 1fr;
                gap: var(--space-2);
                text-align: left;
            }

            .time-pricing-row {
                padding: var(--space-4);
                background: var(--surface);
                margin-bottom: var(--space-2);
                border-radius: var(--radius);
                border: var(--border);
            }

            .period-name::before { content: "æ—¶æ®µ: "; font-weight: bold; }
            .period-name {
                flex-direction: row;
                gap: var(--space-2);
                align-items: baseline;
            }
            .period-time {
                font-size: 11px;
            }
            .period-usage::before { content: "ç”¨ç”µé‡: "; font-weight: bold; }
            .period-rate::before { content: "ç”µä»·: "; font-weight: bold; }
            .period-amount::before { content: "é‡‘é¢: "; font-weight: bold; }

            .period-usage,
            .period-rate,
            .period-amount {
                text-align: left;
                display: block;
                margin-bottom: var(--space-1);
            }

            .standard-cell::before { content: "å¹³å³°: "; font-weight: bold; }
            .valley-cell::before { content: "ä½è°·: "; font-weight: bold; }

            /* ç‹¬ç«‹æ¨¡å—ç§»åŠ¨ç«¯æ ·å¼ */
            .module-header {
                flex-direction: column;
                align-items: stretch;
                gap: var(--space-4);
            }

            .module-header h3 {
                text-align: center;
            }

            .header-controls {
                flex-direction: column;
                gap: var(--space-3);
            }

            .view-controls {
                justify-content: center;
            }


            /* ç§»åŠ¨ç«¯è¡¨æ ¼æ ·å¼è°ƒæ•´ */
            .daily-table-header,
            .daily-table-row {
                grid-template-columns: 1fr;
                gap: var(--space-2);
                text-align: left;
            }

            .daily-table-row {
                padding: var(--space-4);
                background: var(--surface);
                margin-bottom: var(--space-2);
                border-radius: var(--radius);
                border: var(--border);
            }

            .date-cell::before { content: "æ—¥æœŸ: "; font-weight: bold; }
            .usage-cell::before { content: "ç”¨ç”µé‡: "; font-weight: bold; }
            .cumulative-cell::before { content: "æœ¬æœˆç´¯è®¡: "; font-weight: bold; }
            .tier-cell::before { content: "æ‰€å±é˜¶æ®µ: "; font-weight: bold; }
            .peak-cell::before { content: "é«˜å³°æ—¶æ®µ: "; font-weight: bold; }

            .cumulative-cell,
            .tier-cell,
            .peak-cell,
            .standard-cell,
            .valley-cell {
                text-align: left;
                display: block;
                margin-bottom: var(--space-1);
            }
        }
    </style>
</body>
</html>
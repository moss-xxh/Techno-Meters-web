<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-zh="Ë¥¶ÂçïËØ¶ÊÉÖ" data-en="Bill Details">Ë¥¶ÂçïËØ¶ÊÉÖ</title>
    <link rel="stylesheet" href="assets/css/common.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
</head>
<body>
    <!-- ÂØºËà™Ê†è -->
    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-brand">
                <h1 data-zh="ËÉΩÊ∫êÁÆ°ÁêÜÁ≥ªÁªü" data-en="Energy Management System">ËÉΩÊ∫êÁÆ°ÁêÜÁ≥ªÁªü</h1>
            </div>
            <div class="nav-menu">
                <a href="dashboard.html" class="nav-link" data-zh="‰ª™Ë°®Êùø" data-en="Dashboard">‰ª™Ë°®Êùø</a>
                <a href="users.html" class="nav-link" data-zh="Áî®Êà∑ÁÆ°ÁêÜ" data-en="User Management">Áî®Êà∑ÁÆ°ÁêÜ</a>
                <a href="bills.html" class="nav-link" data-zh="Ë¥¶ÂçïÁÆ°ÁêÜ" data-en="Bill Management">Ë¥¶ÂçïÁÆ°ÁêÜ</a>
                <a href="reports.html" class="nav-link" data-zh="Êä•Ë°®ÂàÜÊûê" data-en="Reports">Êä•Ë°®ÂàÜÊûê</a>
                <a href="settings.html" class="nav-link" data-zh="Á≥ªÁªüËÆæÁΩÆ" data-en="Settings">Á≥ªÁªüËÆæÁΩÆ</a>
            </div>
            <div class="nav-actions">
                <div class="lang-dropdown">
                    <select id="language-select" class="form-select lang-select">
                        <option value="zh" data-zh="‰∏≠Êñá" data-en="Chinese">‰∏≠Êñá</option>
                        <option value="en" data-zh="English" data-en="English">English</option>
                    </select>
                </div>
                <div class="user-menu">
                    <div class="user-avatar">ÁÆ°</div>
                    <span data-zh="ÁÆ°ÁêÜÂëò" data-en="Admin">ÁÆ°ÁêÜÂëò</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- ‰∏ªÂÜÖÂÆπÂå∫Âüü -->
    <main class="main-content">
        <div class="container">
            <!-- È°µÈù¢Ê†áÈ¢òÂíåËøîÂõûÊåâÈíÆ -->
            <div class="page-header">
                <div class="header-left">
                    <button class="btn btn-secondary" onclick="goBack()">
                        <span>‚Üê</span>
                        <span data-zh="ËøîÂõû" data-en="Back">ËøîÂõû</span>
                    </button>
                    <div class="header-text">
                        <div class="header-title-section">
                            <span id="detail-username" class="user-name-header">Priya Sharma</span>
                            <span id="header-business-type" class="business-type">Â±ÖÊ∞ë</span>
                        </div>
                        <div class="header-info">
                            <span class="header-info-item">
                                <span class="info-label" data-zh="ÁîµË°®Âè∑" data-en="Meter No.">ÁîµË°®Âè∑</span>
                                <span id="header-electric-number" class="info-value">1111111001</span>
                            </span>
                            <span class="header-info-item">
                                <span class="info-label" data-zh="Âú∞ÂùÄ" data-en="Address">Âú∞ÂùÄ</span>
                                <span id="header-address" class="info-value">Ê≥∞Á±≥Â∞îÁ∫≥Âæ∑</span>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="downloadBill()">
                        <span>üìÑ</span>
                        <span data-zh="‰∏ãËΩΩË¥¶Âçï" data-en="Download Bill">‰∏ãËΩΩË¥¶Âçï</span>
                    </button>
                </div>
            </div>

            <!-- Áî®Êà∑Âü∫Êú¨‰ø°ÊÅØ -->
            <div class="bill-summary">
                <div class="info-horizontal">
                    <span class="info-pair">
                        <span class="label" data-zh="Ë¥¶Êúü" data-en="Billing Period">Ë¥¶Êúü</span>
                        <span id="detail-period" class="value">2025Âπ¥9Êúà</span>
                    </span>
                    <span class="info-pair">
                        <span class="label" data-zh="ËÆ°Ë¥πÊñπÂºè" data-en="Billing Method">ËÆ°Ë¥πÊñπÂºè</span>
                        <span id="detail-billing-method" class="value">Èò∂Ê¢ØÁîµË¥π</span>
                    </span>
                    <span class="info-pair">
                        <span class="label" data-zh="Áî®ÁîµÈáè" data-en="Usage">Áî®ÁîµÈáè</span>
                        <div class="usage-detail">
                            <span id="detail-usage" class="value">387 kWh</span>
                            <span id="reading-detail" class="reading-info">Ôºà54,801 - 55,188Ôºâ</span>
                        </div>
                    </span>
                    <span class="info-pair">
                        <span class="label" data-zh="Ë¥πÁî®" data-en="Cost">Ë¥πÁî®</span>
                        <span id="detail-amount" class="value amount">‚Çπ2546</span>
                    </span>
                </div>
            </div>


            <!-- ËØ¶ÁªÜ‰ø°ÊÅØÂ±ïÁ§∫Âå∫Âüü -->
            <div class="details-grid">
                <!-- Ë¥¶ÂçïÁÆ°ÁêÜË°®Ê†º -->
                <div class="cost-breakdown-section">
                    <div class="section-header">
                        <h4 data-zh="Ë¥¶ÂçïÁÆ°ÁêÜ" data-en="Bill Management">Ë¥¶ÂçïÁÆ°ÁêÜ</h4>
                    </div>
                    <div class="cost-table-container">
                        <div class="cost-table">
                            <div class="cost-header">
                                <span data-zh="È°πÁõÆ" data-en="Item">È°πÁõÆ</span>
                                <span data-zh="ÈáëÈ¢ùÔºàÂç¢ÊØîÔºâ" data-en="Amount (‚Çπ)">ÈáëÈ¢ùÔºàÂç¢ÊØîÔºâ</span>
                                <span data-zh="ËØ¥Êòé" data-en="Description">ËØ¥Êòé</span>
                            </div>
                            <div id="cost-body" class="cost-body">
                                <!-- Ë¥πÁî®ÊòéÁªÜÊï∞ÊçÆÁî±JavaScriptÁîüÊàê -->
                            </div>
                            <div class="cost-total">
                                <span class="final-label" data-zh="ÊÄªË¥πÁî®" data-en="Total Cost">ÊÄªË¥πÁî®</span>
                                <span class="final-amount" id="final-total-amount">‚Çπ1,107</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Èò∂Ê¢ØÊî∂Ë¥πË°®Ê†º/ÂàÜÊó∂Áîµ‰ª∑Ë°®Ê†º -->
                <div class="pricing-section">
                    <div class="section-header">
                        <h4 id="pricing-section-title" data-zh="ÁîµÈáèË¥πÊòéÁªÜ" data-en="Energy Charges Details">ÁîµÈáèË¥πÊòéÁªÜ</h4>
                        <button id="view-details-btn" class="btn btn-primary" style="display: none;" onclick="showDetailedView()">
                            <span data-zh="Êü•ÁúãÊòéÁªÜ" data-en="View Details">Êü•ÁúãÊòéÁªÜ</span>
                        </button>
                    </div>
                    <div class="pricing-table-container">
                        <!-- Èò∂Ê¢ØÁîµË¥πË°®Ê†º -->
                        <div id="tiered-pricing-table" class="pricing-table">
                            <div class="pricing-header">
                                <span data-zh="Èò∂Ê¢Ø" data-en="Tier">Èò∂Ê¢Ø</span>
                                <span data-zh="ËåÉÂõ¥(kWh)" data-en="Range(kWh)">ËåÉÂõ¥(kWh)</span>
                                <span data-zh="Áîµ‰ª∑(‚Çπ/kWh)" data-en="Rate(‚Çπ/kWh)">Áîµ‰ª∑(‚Çπ/kWh)</span>
                                <span data-zh="Áî®Èáè(kWh)" data-en="Usage(kWh)">Áî®Èáè(kWh)</span>
                                <span data-zh="ÈáëÈ¢ù(‚Çπ)" data-en="Amount(‚Çπ)">ÈáëÈ¢ù(‚Çπ)</span>
                            </div>
                            <div id="pricing-body" class="pricing-body">
                                <!-- Èò∂Ê¢ØÊï∞ÊçÆÁî±JavaScriptÁîüÊàê -->
                            </div>
                            <div class="pricing-total">
                                <span class="total-label" data-zh="Â∞èËÆ°" data-en="Subtotal">Â∞èËÆ°</span>
                                <span class="total-amount" id="total-tier-amount">‚Çπ900.00</span>
                            </div>
                        </div>

                        <!-- ÂàÜÊó∂Áîµ‰ª∑Ê±áÊÄªË°®Ê†º -->
                        <div id="time-of-use-pricing-table" class="pricing-table" style="display: none;">
                            <div class="time-pricing-summary">
                                <div class="summary-header">
                                    <span data-zh="Êó∂ÊÆµ" data-en="Period">Êó∂ÊÆµ</span>
                                    <span data-zh="Áî®ÁîµÈáè(kWh)" data-en="Usage(kWh)">Áî®ÁîµÈáè(kWh)</span>
                                    <span data-zh="Áîµ‰ª∑(‚Çπ/kWh)" data-en="Rate(‚Çπ/kWh)">Áîµ‰ª∑(‚Çπ/kWh)</span>
                                    <span data-zh="ÈáëÈ¢ù(‚Çπ)" data-en="Amount(‚Çπ)">ÈáëÈ¢ù(‚Çπ)</span>
                                </div>
                                <div id="time-pricing-body" class="time-pricing-body">
                                    <!-- ÂàÜÊó∂Áîµ‰ª∑Êï∞ÊçÆÁî±JavaScriptÁîüÊàê -->
                                </div>
                                <div class="pricing-total">
                                    <span class="total-label" data-zh="Â∞èËÆ°" data-en="Subtotal">Â∞èËÆ°</span>
                                    <span class="total-amount" id="total-time-amount">‚Çπ1,580.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


    <script src="assets/js/common.js"></script>
    <script>
        // Âú∞Âå∫Êï∞ÊçÆ
        const regionsData = {
            'tamil-nadu': { name: 'Ê≥∞Á±≥Â∞îÁ∫≥Âæ∑', nameEn: 'Tamil Nadu' },
            'karnataka': { name: 'Âç°Á∫≥Â°îÂÖã', nameEn: 'Karnataka' },
            'andhra-pradesh': { name: 'ÂÆâÂæóÊãâÈÇ¶', nameEn: 'Andhra Pradesh' },
            'kerala': { name: 'ÂñÄÊãâÊãâ', nameEn: 'Kerala' }
        };

        // Ëé∑ÂèñURLÂèÇÊï∞
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // ÁîüÊàêË¥¶ÂçïËØ¶ÊÉÖÊï∞ÊçÆ
        function generateBillDetails(bill, month) {
            if (bill.billingMethod === 'tiered') {
                // ÊòæÁ§∫Èò∂Ê¢ØÁîµË¥πÊòéÁªÜ
                showTieredPricing(bill);
                generateTieredPricing(bill);
            } else if (bill.billingMethod === 'time-of-use') {
                // ÊòæÁ§∫ÂàÜÊó∂Áîµ‰ª∑ÊòéÁªÜ
                showTimeOfUsePricing(bill, month);
                generateTimeOfUsePricing(bill, month);
            }
        }

        // ÊòæÁ§∫Èò∂Ê¢ØÁîµË¥πË°®Ê†º
        function showTieredPricing(bill) {
            document.getElementById('pricing-section-title').setAttribute('data-zh', 'ÁîµÈáèË¥πÊòéÁªÜ');
            document.getElementById('pricing-section-title').setAttribute('data-en', 'Energy Charges Details');
            document.getElementById('pricing-section-title').textContent = currentLanguage === 'zh' ? 'ÁîµÈáèË¥πÊòéÁªÜ' : 'Energy Charges Details';

            document.getElementById('tiered-pricing-table').style.display = 'block';
            document.getElementById('time-of-use-pricing-table').style.display = 'none';

            // ÊòæÁ§∫Èò∂Ê¢ØÁîµ‰ª∑ÁöÑÊü•ÁúãÊòéÁªÜÊåâÈíÆ
            document.getElementById('view-details-btn').style.display = 'inline-flex';
            // ‰øÆÊîπÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂‰∏∫Èò∂Ê¢ØÁîµ‰ª∑‰∏ìÁî®
            document.getElementById('view-details-btn').setAttribute('onclick', 'showTieredDetailedView()');

            // Êõ¥Êñ∞ÊØèÊó•Áî®ÁîµÈáèË°®Ê†ºÊ†áÈ¢ò‰∏∫Èò∂Ê¢ØÁîµ‰ª∑ÁâàÊú¨
            updateDailyTableForTiered();
        }

        // ÊòæÁ§∫ÂàÜÊó∂Áîµ‰ª∑Ë°®Ê†º
        function showTimeOfUsePricing(bill, month) {
            document.getElementById('pricing-section-title').setAttribute('data-zh', 'Âü∫Á°ÄÁîµË¥π‚Äî‚Äî2025/09');
            document.getElementById('pricing-section-title').setAttribute('data-en', 'Time-of-Use Pricing Details');
            document.getElementById('pricing-section-title').textContent = currentLanguage === 'zh' ? 'Âü∫Á°ÄÁîµË¥π‚Äî‚Äî2025/09' : 'Basic Electricity Fee‚ÄîSeptember 2025';

            document.getElementById('tiered-pricing-table').style.display = 'none';
            document.getElementById('time-of-use-pricing-table').style.display = 'block';

            // ÊòæÁ§∫Êü•ÁúãÊòéÁªÜÊåâÈíÆ
            document.getElementById('view-details-btn').style.display = 'inline-flex';
            // ËÆæÁΩÆ‰∏∫ÂàÜÊó∂Áîµ‰ª∑‰∏ìÁî®ÁÇπÂáª‰∫ã‰ª∂
            document.getElementById('view-details-btn').setAttribute('onclick', 'showDetailedView()');

            // Êõ¥Êñ∞ÊØèÊó•Áî®ÁîµÈáèË°®Ê†ºÊ†áÈ¢òÔºåÊòæÁ§∫ÂàÜÊó∂Áîµ‰ª∑ÁâπÊúâÁöÑÂàó
            updateDailyTableForTimeOfUse();
        }

        // Êõ¥Êñ∞Ë°®Ê†º‰∏∫ÂàÜÊó∂Áîµ‰ª∑ÁâàÊú¨
        function updateDailyTableForTimeOfUse() {
            // ÁßªÈô§ÂáΩÊï∞ÂÜÖÂÆπÔºåÂõ†‰∏∫daily-usage-moduleÂ∑≤Ë¢´Âà†Èô§
        }

        // Êõ¥Êñ∞Ë°®Ê†º‰∏∫Èò∂Ê¢ØÁîµ‰ª∑ÁâàÊú¨
        function updateDailyTableForTiered() {
            // ÁßªÈô§ÂáΩÊï∞ÂÜÖÂÆπÔºåÂõ†‰∏∫daily-usage-moduleÂ∑≤Ë¢´Âà†Èô§
        }

        // Ëé∑ÂèñÊú¨Âú∞ÂåñÁöÑÊúà‰ªΩÂêçÁß∞
        function getMonthNames() {
            return currentLanguage === 'zh' ?
                ['1Êúà', '2Êúà', '3Êúà', '4Êúà', '5Êúà', '6Êúà', '7Êúà', '8Êúà', '9Êúà', '10Êúà', '11Êúà', '12Êúà'] :
                ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        }

        function generateTieredPricing(bill) {
            const pricingBody = document.getElementById('pricing-body');
            const totalUsage = bill.usage;

            // Âç∞Â∫¶Â±ÖÊ∞ëÈò∂Ê¢ØÁîµ‰ª∑ÁªìÊûÑ
            const tiers = [
                {
                    name: currentLanguage === 'zh' ? 'Á¨¨‰∏ÄÈò∂Ê¢Ø' : 'Tier 1',
                    range: '0-100',
                    rate: 3.35,
                    capacity: 100
                },
                {
                    name: currentLanguage === 'zh' ? 'Á¨¨‰∫åÈò∂Ê¢Ø' : 'Tier 2',
                    range: '101-200',
                    rate: 4.60,
                    capacity: 100
                },
                {
                    name: currentLanguage === 'zh' ? 'Á¨¨‰∏âÈò∂Ê¢Ø' : 'Tier 3',
                    range: '201-400',
                    rate: 6.85,
                    capacity: 200
                },
                {
                    name: currentLanguage === 'zh' ? 'Á¨¨ÂõõÈò∂Ê¢Ø' : 'Tier 4',
                    range: '400+',
                    rate: 8.15,
                    capacity: Infinity
                }
            ];

            let remainingUsage = totalUsage;
            let totalAmount = 0;
            const tierDetails = [];

            tiers.forEach((tier, index) => {
                if (remainingUsage <= 0) {
                    tierDetails.push({
                        ...tier,
                        usage: 0,
                        amount: 0
                    });
                    return;
                }

                // ËÆ°ÁÆóÊú¨Èò∂Ê¢ØÁöÑ‰ΩøÁî®Èáè
                let tierUsage = 0;
                if (tier.capacity === Infinity) {
                    // ÊúÄÈ´òÈò∂Ê¢ØÔºå‰ΩøÁî®ÊâÄÊúâÂâ©‰ΩôÁî®Èáè
                    tierUsage = remainingUsage;
                } else {
                    // ‰ΩøÁî®È¢ÑÂÆö‰πâÁöÑÂÆπÈáè
                    tierUsage = Math.min(remainingUsage, tier.capacity);
                }

                const tierAmount = tierUsage * tier.rate;

                tierDetails.push({
                    ...tier,
                    usage: Math.round(tierUsage),
                    amount: tierAmount
                });

                totalAmount += tierAmount;
                remainingUsage -= tierUsage;
            });

            // Ê∏≤ÊüìÈò∂Ê¢ØË°®Ê†º
            pricingBody.innerHTML = tierDetails.map(tier => `
                <div class="pricing-row ${tier.usage > 0 ? 'used' : 'unused'}">
                    <span class="tier-name">${tier.name}</span>
                    <span class="tier-range">${tier.range}</span>
                    <span class="tier-rate">‚Çπ${tier.rate.toFixed(2)}</span>
                    <span class="tier-usage">${tier.usage}</span>
                    <span class="tier-amount">‚Çπ${tier.amount.toFixed(2)}</span>
                </div>
            `).join('');

            // Êõ¥Êñ∞Èò∂Ê¢ØÁîµË¥πÂ∞èËÆ°
            document.getElementById('total-tier-amount').textContent = `‚Çπ${totalAmount.toFixed(2)}`;

            // ÁîüÊàêË¥πÁî®ÊòéÁªÜ
            console.log('Calling generateCostBreakdown with:', totalAmount, totalUsage);
            generateCostBreakdown(totalAmount, totalUsage);
        }

        function generateCostBreakdown(electricityFee, usage) {
            console.log('generateCostBreakdown called with:', electricityFee, usage);
            const costBody = document.getElementById('cost-body');
            console.log('costBody element:', costBody);

            // ËÆ°ÁÆóÂêÑÈ°πË¥πÁî®
            const energyCharges = electricityFee; // ÁîµÈáèË¥πÔºàÂü∫‰∫éÂÆûÈôÖÁî®ÁîµÈáèËÆ°ÁÆóÔºâ
            const fixedCharges = 150; // Âõ∫ÂÆöË¥πÔºàÊØèÊúàÂõ∫ÂÆöÊî∂Ë¥πÔºâ
            const fpppaCharges = energyCharges * 0.08; // ÁáÉÊñôË∞ÉÊï¥Ë¥πÔºà8% √ó ÁîµÈáèË¥πÔºâ
            const governmentDuty = (energyCharges + fixedCharges + fpppaCharges) * 0.12; // ÊîøÂ∫úÁ®éÔºà12% √ó Â∞èËÆ°Ôºâ
            const totalCost = energyCharges + fixedCharges + fpppaCharges + governmentDuty;

            const costItems = [
                {
                    item: currentLanguage === 'zh' ? 'ÁîµÈáèË¥π' : 'Energy charges',
                    amount: energyCharges,
                    description: currentLanguage === 'zh' ? `${usage} kWh √ó Áîµ‰ª∑` : `${usage} kWh √ó tariff rate`
                },
                {
                    item: currentLanguage === 'zh' ? 'Âõ∫ÂÆöË¥π' : 'Fixed charges',
                    amount: fixedCharges,
                    description: currentLanguage === 'zh' ? `ÊØèÊúàÂõ∫ÂÆöÊúçÂä°Ë¥π` : `Monthly fixed service charge`
                },
                {
                    item: currentLanguage === 'zh' ? 'ÁáÉÊñôË∞ÉÊï¥Ë¥π' : 'FPPPA charges',
                    amount: fpppaCharges,
                    description: currentLanguage === 'zh' ? `8% √ó ÁîµÈáèË¥π` : `8% √ó energy charges`
                },
                {
                    item: currentLanguage === 'zh' ? 'ÊîøÂ∫úÁ®é' : 'Government duty',
                    amount: governmentDuty,
                    description: currentLanguage === 'zh' ? `12% √ó (ÁîµÈáèË¥π + Âõ∫ÂÆöË¥π + ÁáÉÊñôË¥π)` : `12% √ó (energy + fixed + FPPPA)`
                }
            ];

            // Ê∏≤ÊüìË¥πÁî®ÊòéÁªÜË°®Ê†º
            console.log('Rendering cost items:', costItems);
            costBody.innerHTML = costItems.map(item => `
                <div class="cost-row">
                    <span class="cost-item">${item.item}</span>
                    <span class="cost-amount">‚Çπ${item.amount.toFixed(0)}</span>
                    <span class="cost-desc">${item.description}</span>
                </div>
            `).join('');

            // Êõ¥Êñ∞ÊÄªË¥πÁî®
            document.getElementById('final-total-amount').textContent = `‚Çπ${totalCost.toFixed(0)}`;

            // ÂêåÊó∂Êõ¥Êñ∞È°µÈù¢È°∂ÈÉ®ÁöÑÊÄªÈáëÈ¢ùÊòæÁ§∫
            document.getElementById('detail-amount').textContent = `‚Çπ${totalCost.toFixed(0)}`;
        }

        // ÁîüÊàêÂàÜÊó∂Áîµ‰ª∑ÊòéÁªÜ
        function generateTimeOfUsePricing(bill, month) {
            const timePricingBody = document.getElementById('time-pricing-body');
            const totalUsage = bill.usage;

            // ÂàÜÊó∂Áîµ‰ª∑ÁªìÊûÑ (Âü∫Á°ÄÁîµ‰ª∑4.5‚Çπ/kWh)
            const baseRate = 4.5;
            const timeRates = {
                peak: baseRate * 1.2,      // È´òÂ≥∞Êó∂ÊÆµ: +20%
                standard: baseRate,        // Âπ≥Â≥∞Êó∂ÊÆµ: Âü∫Á°ÄÁîµ‰ª∑
                valley: baseRate * 0.8     // ‰ΩéË∞∑Êó∂ÊÆµ: -20%
            };

            // Ê®°ÊãüÂêÑÊó∂ÊÆµÁî®ÁîµÈáèÂàÜÈÖç (ÊÄªËÆ°Â∫îÁ≠â‰∫étotalUsage)
            const peakUsage = Math.round(totalUsage * 0.25);      // 25% È´òÂ≥∞Êó∂ÊÆµ
            const standardUsage = Math.round(totalUsage * 0.45);  // 45% Âπ≥Â≥∞Êó∂ÊÆµ
            const valleyUsage = totalUsage - peakUsage - standardUsage; // 30% ‰ΩéË∞∑Êó∂ÊÆµ

            // ËÆ°ÁÆóÂêÑÊó∂ÊÆµË¥πÁî®
            const peakCost = peakUsage * timeRates.peak;
            const standardCost = standardUsage * timeRates.standard;
            const valleyCost = valleyUsage * timeRates.valley;
            const totalElectricityFee = peakCost + standardCost + valleyCost;

            // Ê∏≤ÊüìÂàÜÊó∂Áîµ‰ª∑Ê±áÊÄªË°®Ê†º
            timePricingBody.innerHTML = `
                <div class="time-pricing-row peak">
                    <span class="period-name">
                        <div class="period-title">${currentLanguage === 'zh' ? 'È´òÂ≥∞Êó∂ÊÆµ' : 'Peak'}</div>
                        <div class="period-time">${currentLanguage === 'zh' ? '(12:00-18:00)' : '(12:00-18:00)'}</div>
                    </span>
                    <span class="period-usage">${peakUsage}</span>
                    <span class="period-rate">‚Çπ${timeRates.peak.toFixed(2)}</span>
                    <span class="period-amount">‚Çπ${peakCost.toFixed(2)}</span>
                </div>
                <div class="time-pricing-row standard">
                    <span class="period-name">
                        <div class="period-title">${currentLanguage === 'zh' ? 'Âπ≥Â≥∞Êó∂ÊÆµ' : 'Standard'}</div>
                        <div class="period-time">${currentLanguage === 'zh' ? '(08:00-12:00 & 18:00-23:00)' : '(08:00-12:00 & 18:00-23:00)'}</div>
                    </span>
                    <span class="period-usage">${standardUsage}</span>
                    <span class="period-rate">‚Çπ${timeRates.standard.toFixed(2)}</span>
                    <span class="period-amount">‚Çπ${standardCost.toFixed(2)}</span>
                </div>
                <div class="time-pricing-row valley">
                    <span class="period-name">
                        <div class="period-title">${currentLanguage === 'zh' ? '‰ΩéË∞∑Êó∂ÊÆµ' : 'Valley'}</div>
                        <div class="period-time">${currentLanguage === 'zh' ? '(23:00-08:00)' : '(23:00-08:00)'}</div>
                    </span>
                    <span class="period-usage">${valleyUsage}</span>
                    <span class="period-rate">‚Çπ${timeRates.valley.toFixed(2)}</span>
                    <span class="period-amount">‚Çπ${valleyCost.toFixed(2)}</span>
                </div>
            `;

            // Êõ¥Êñ∞ÂàÜÊó∂Áîµ‰ª∑Â∞èËÆ°
            document.getElementById('total-time-amount').textContent = `‚Çπ${totalElectricityFee.toFixed(2)}`;

            // ÁîüÊàêË¥πÁî®ÊòéÁªÜ
            generateCostBreakdown(totalElectricityFee, totalUsage);

            // ÁîüÊàêÂàÜÊó∂Áîµ‰ª∑ÁöÑÊØèÊó•Áî®ÁîµÈáèÊï∞ÊçÆ
            generateTimeOfUseDailyData(bill, month, timeRates);
        }

        // ÁîüÊàêÂàÜÊó∂Áîµ‰ª∑ÁöÑÊØèÊó•Áî®ÁîµÈáèÊï∞ÊçÆ
        function generateTimeOfUseDailyData(bill, month, timeRates) {
            const daysInMonth = new Date(2025, parseInt(month.split('-')[1]), 0).getDate();
            const dailyData = [];
            const totalUsage = bill.usage;
            const dailyUsage = totalUsage / daysInMonth;

            for (let day = 1; day <= daysInMonth; day++) {
                const dayUsage = Math.round((dailyUsage * (0.8 + Math.random() * 0.4)) * 10) / 10;

                // ÂàÜÈÖçÂêÑÊó∂ÊÆµÁî®ÁîµÈáè
                const peakUsage = Math.round(dayUsage * (0.20 + Math.random() * 0.10) * 10) / 10;    // 20-30%
                const standardUsage = Math.round(dayUsage * (0.40 + Math.random() * 0.15) * 10) / 10; // 40-55%
                const valleyUsage = Math.round((dayUsage - peakUsage - standardUsage) * 10) / 10;     // Ââ©‰Ωô

                // ËÆ°ÁÆóË¥πÁî®
                const peakCost = peakUsage * timeRates.peak;
                const standardCost = standardUsage * timeRates.standard;
                const valleyCost = valleyUsage * timeRates.valley;
                const totalCost = peakCost + standardCost + valleyCost;

                dailyData.push({
                    date: `2025-${month.split('-')[1].padStart(2, '0')}-${day.toString().padStart(2, '0')}`,
                    day: day,
                    usage: dayUsage,
                    peakUsage: peakUsage,
                    standardUsage: standardUsage,
                    valleyUsage: valleyUsage,
                    cost: Math.round(totalCost)
                });
            }

            // Ê∏≤ÊüìÂàÜÊó∂Áîµ‰ª∑ÁöÑË°®Ê†ºËßÜÂõæ
            renderTimeOfUseTableView(dailyData);
            // Êõ¥Êñ∞Êó•ÂéÜÂíåÂõæË°®ËßÜÂõæ‰πüÊòæÁ§∫ÂàÜÊó∂Áîµ‰ª∑Êï∞ÊçÆ
            renderCalendarView(dailyData, month);
            renderChartView(dailyData);
        }

        // Ê∏≤ÊüìÂàÜÊó∂Áîµ‰ª∑ÁöÑË°®Ê†ºËßÜÂõæ
        function renderTimeOfUseTableView(dailyData) {
            const tableBody = document.getElementById('daily-table-body');

            // Â¶ÇÊûúÂÖÉÁ¥†‰∏çÂ≠òÂú®ÔºàÂõ†‰∏∫daily-usage-moduleÂ∑≤Ë¢´Âà†Èô§ÔºâÔºåÁõ¥Êé•ËøîÂõû
            if (!tableBody) {
                console.log('daily-table-body not found, skipping renderTimeOfUseTableView');
                return;
            }

            // ÂÖàÊ∏ÖÁ©∫Ë°®Ê†ºÂÜÖÂÆπ
            tableBody.innerHTML = '';

            // ‰∏∫ÊØè‰∏ÄÂ§©ÂàõÂª∫Ë°å
            dailyData.forEach(day => {
                // ÂàõÂª∫‰∏ªË°å
                const mainRow = document.createElement('div');
                mainRow.className = 'daily-table-row time-of-use';
                mainRow.style.cursor = 'pointer';
                mainRow.innerHTML = `
                    <span class="date-cell">${currentLanguage === 'zh' ? `${day.day}Êó•` : day.day}</span>
                    <span class="usage-cell">${day.usage}</span>
                    <span class="cost-cell">‚Çπ${day.cost}</span>
                    <span class="expand-icon" id="expand-icon-${day.day}">‚ñº</span>
                `;

                // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
                mainRow.addEventListener('click', () => toggleDayHourlyDetails(day.day));

                // ÂàõÂª∫ËØ¶ÊÉÖË°å
                const detailsRow = document.createElement('div');
                detailsRow.className = 'hourly-details-row';
                detailsRow.id = `hourly-details-row-${day.day}`;
                detailsRow.style.display = 'none';
                detailsRow.innerHTML = `
                    <div class="hourly-details-content">
                        <div class="hourly-grid" id="hourly-grid-${day.day}">
                            <!-- ÊØèÂ∞èÊó∂Êï∞ÊçÆÁî±JavaScriptÁîüÊàê -->
                        </div>
                    </div>
                `;

                // Ê∑ªÂä†Âà∞Ë°®Ê†º
                tableBody.appendChild(mainRow);
                tableBody.appendChild(detailsRow);
            });
        }

        // ÂàáÊç¢Êó•ÊúüÊØèÂ∞èÊó∂ËØ¶ÊÉÖÊòæÁ§∫ÔºàË°®Ê†ºËßÜÂõæÔºâ
        function toggleDayHourlyDetails(day) {
            const detailsRow = document.getElementById(`hourly-details-row-${day}`);
            const expandIcon = document.getElementById(`expand-icon-${day}`);

            if (detailsRow.style.display === 'none') {
                // ÂÖ≥Èó≠ÂÖ∂‰ªñÂ∑≤ÊâìÂºÄÁöÑËØ¶ÊÉÖ
                document.querySelectorAll('.hourly-details-row').forEach(row => {
                    row.style.display = 'none';
                });
                document.querySelectorAll('.expand-icon').forEach(icon => {
                    icon.textContent = '‚ñº';
                    icon.style.transform = 'rotate(0deg)';
                });

                // ÊâìÂºÄÂΩìÂâçËØ¶ÊÉÖ
                detailsRow.style.display = 'block';
                expandIcon.textContent = '‚ñ≤';
                expandIcon.style.transform = 'rotate(180deg)';

                // ÁîüÊàêÊØèÂ∞èÊó∂Êï∞ÊçÆ
                generateTableHourlyData(day);
            } else {
                // ÂÖ≥Èó≠ÂΩìÂâçËØ¶ÊÉÖ
                detailsRow.style.display = 'none';
                expandIcon.textContent = '‚ñº';
                expandIcon.style.transform = 'rotate(0deg)';
            }
        }

        // ÁîüÊàêË°®Ê†º‰∏≠ÁöÑÊØèÂ∞èÊó∂Áî®ÁîµÊï∞ÊçÆ
        function generateTableHourlyData(day) {
            const hourlyGrid = document.getElementById(`hourly-grid-${day}`);

            // Ëé∑ÂèñÊó∂ÊÆµÁîµ‰ª∑
            const timeRates = {
                peak: 5.40,     // È´òÂ≥∞Êó∂ÊÆµ 12:00-18:00
                standard: 4.50, // Âπ≥Â≥∞Êó∂ÊÆµ 08:00-12:00 & 18:00-23:00
                valley: 3.60    // ‰ΩéË∞∑Êó∂ÊÆµ 23:00-08:00
            };

            // ÁîüÊàê24Â∞èÊó∂Êï∞ÊçÆ
            let hourlyHTML = '';
            for (let hour = 0; hour < 24; hour++) {
                // Á°ÆÂÆöÊó∂ÊÆµÁ±ªÂûã
                let period, periodName, rate, periodClass;
                if (hour >= 12 && hour < 18) {
                    period = 'peak';
                    periodName = currentLanguage === 'zh' ? 'È´òÂ≥∞' : 'Peak';
                    rate = timeRates.peak;
                    periodClass = 'peak';
                } else if ((hour >= 8 && hour < 12) || (hour >= 18 && hour < 23)) {
                    period = 'standard';
                    periodName = currentLanguage === 'zh' ? 'Âπ≥Â≥∞' : 'Standard';
                    rate = timeRates.standard;
                    periodClass = 'standard';
                } else {
                    period = 'valley';
                    periodName = currentLanguage === 'zh' ? '‰ΩéË∞∑' : 'Valley';
                    rate = timeRates.valley;
                    periodClass = 'valley';
                }

                // Ê®°ÊãüÊØèÂ∞èÊó∂Áî®ÁîµÈáè (0.8-2.5kWh‰πãÈó¥)
                const hourlyUsage = (Math.random() * 1.7 + 0.8).toFixed(1);

                hourlyHTML += `
                    <div class="hourly-item-small ${periodClass}">
                        <span class="hour-time-small">${hour.toString().padStart(2, '0')}:00</span>
                        <span class="hour-usage-small">${hourlyUsage}kWh</span>
                        <span class="hour-period-small">${periodName}</span>
                    </div>
                `;
            }

            hourlyGrid.innerHTML = hourlyHTML;
        }

        function goBack() {
            window.history.back();
        }

        function downloadBill() {
            EnergySystem.showNotification('‰∏ãËΩΩË¥¶ÂçïÂäüËÉΩÂºÄÂèë‰∏≠...', 'info');
        }

        // ÂØºÂá∫Êï∞ÊçÆ
        function exportUsageData() {
            // Ëé∑ÂèñÂΩìÂâçÊòæÁ§∫ÁöÑÊï∞ÊçÆ
            const currentDailyData = window.currentDailyData;
            if (!currentDailyData) {
                EnergySystem.showNotification('ÊöÇÊó†Êï∞ÊçÆÂèØÂØºÂá∫', 'warning');
                return;
            }

            // ÂàõÂª∫CSVÂÜÖÂÆπ
            let csvContent = '';

            // Ê†πÊçÆËÆ°Ë¥πÊñπÂºèÁ°ÆÂÆöË°®Â§¥
            const billElement = document.getElementById('detail-billing-method');
            const billingMethod = billElement ? billElement.textContent : '';

            if (billingMethod.includes('Èò∂Ê¢Ø')) {
                csvContent = currentLanguage === 'zh' ?
                    'Êó•Êúü,Áî®ÁîµÈáè(kWh),Êú¨ÊúàÁ¥ØËÆ°(kWh),ÊâÄÂ±ûÈò∂ÊÆµ\n' :
                    'Date,Usage(kWh),Monthly Total(kWh),Tier\n';

                currentDailyData.forEach(day => {
                    csvContent += `${day.date},${day.usage},${day.cumulativeUsage},${day.tier}\n`;
                });
            } else {
                csvContent = currentLanguage === 'zh' ?
                    'Êó•Êúü,Áî®ÁîµÈáè(kWh),È´òÂ≥∞Êó∂ÊÆµ,Âπ≥Â≥∞Êó∂ÊÆµ,‰ΩéË∞∑Êó∂ÊÆµ\n' :
                    'Date,Usage(kWh),Peak,Standard,Valley\n';

                currentDailyData.forEach(day => {
                    csvContent += `${day.date},${day.usage},${day.peakUsage || '-'},${day.standardUsage || '-'},${day.valleyUsage || '-'}\n`;
                });
            }

            // ‰∏ãËΩΩCSVÊñá‰ª∂
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `data_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            EnergySystem.showNotification('ÂØºÂá∫ÊàêÂäü', 'success');
        }

        function downloadBill() {
            EnergySystem.showNotification('Ë¥¶Âçï‰∏ãËΩΩÂäüËÉΩÂºÄÂèë‰∏≠...', 'info');
        }

        function payBill() {
            EnergySystem.showNotification('Ë∑≥ËΩ¨Âà∞‰ªòË¥πÈ°µÈù¢...', 'info');
        }

        // ÁîüÊàêÈò∂Ê¢ØÁîµ‰ª∑ÊØèÊó•Áî®ÁîµÈáèÊï∞ÊçÆ
        function generateDailyUsageData(month, totalUsage) {
            const daysInMonth = new Date(2025, parseInt(month.split('-')[1]), 0).getDate();
            const dailyData = [];

            // Èò∂Ê¢ØÁîµ‰ª∑ÁªìÊûÑ
            const tiers = [
                { name: 'Èò∂Ê¢Ø1', nameWithRange: 'Èò∂Ê¢Ø1 (0-100kWh)', nameWithRangeEn: 'Tier 1 (0-100kWh)', min: 0, max: 100 },
                { name: 'Èò∂Ê¢Ø2', nameWithRange: 'Èò∂Ê¢Ø2 (101-200kWh)', nameWithRangeEn: 'Tier 2 (101-200kWh)', min: 101, max: 200 },
                { name: 'Èò∂Ê¢Ø3', nameWithRange: 'Èò∂Ê¢Ø3 (201-400kWh)', nameWithRangeEn: 'Tier 3 (201-400kWh)', min: 201, max: 400 },
                { name: 'Èò∂Ê¢Ø4', nameWithRange: 'Èò∂Ê¢Ø4 (400+kWh)', nameWithRangeEn: 'Tier 4 (400+kWh)', min: 401, max: Infinity }
            ];

            // ÁîüÊàêÊ®°ÊãüÁöÑÊØèÊó•Áî®ÁîµÈáèÊï∞ÊçÆ
            let cumulativeUsage = 0;
            const dailyUsage = totalUsage / daysInMonth;

            for (let day = 1; day <= daysInMonth; day++) {
                const baseUsage = dailyUsage * (0.8 + Math.random() * 0.4); // ÊØèÂ§©Áî®ÁîµÈáèÊúâÂèòÂåñ
                const usage = Math.round(baseUsage * 10) / 10;
                cumulativeUsage += usage;

                // Á°ÆÂÆöÊâÄÂ±ûÈò∂ÊÆµ
                let currentTier = currentLanguage === 'zh' ? 'Èò∂Ê¢Ø1 (0-100kWh)' : 'Tier 1 (0-100kWh)';
                for (let i = 0; i < tiers.length; i++) {
                    if (cumulativeUsage > tiers[i].min && (cumulativeUsage <= tiers[i].max || tiers[i].max === Infinity)) {
                        currentTier = currentLanguage === 'zh' ? tiers[i].nameWithRange : tiers[i].nameWithRangeEn;
                        break;
                    }
                }

                // Ê®°ÊãüÂ≥∞Ë∞∑Áî®ÁîµÂàÜÈÖçÔºàÁî®‰∫éÊó•ÂéÜÂíåÂõæË°®ÊòæÁ§∫Ôºâ
                const peakUsage = usage * (0.3 + Math.random() * 0.2); // 30-50%ÊòØÂ≥∞Êó∂Áî®Áîµ
                const offPeakUsage = usage - peakUsage;

                dailyData.push({
                    date: `2025-${month.split('-')[1].padStart(2, '0')}-${day.toString().padStart(2, '0')}`,
                    day: day,
                    usage: usage,
                    cumulativeUsage: Math.round(cumulativeUsage * 10) / 10,
                    tier: currentTier,
                    peakUsage: Math.round(peakUsage * 10) / 10,
                    offPeakUsage: Math.round(offPeakUsage * 10) / 10,
                    cost: Math.round(usage * 6.5) // ÁÆÄÂåñË¥πÁî®ËÆ°ÁÆó
                });
            }

            return dailyData;
        }

        // Ê∏≤ÊüìÈò∂Ê¢ØÁîµ‰ª∑Ë°®Ê†ºËßÜÂõæ
        function renderTableView(dailyData) {
            const tableBody = document.getElementById('daily-table-body');

            // Â¶ÇÊûúÂÖÉÁ¥†‰∏çÂ≠òÂú®ÔºàÂõ†‰∏∫daily-usage-moduleÂ∑≤Ë¢´Âà†Èô§ÔºâÔºåÁõ¥Êé•ËøîÂõû
            if (!tableBody) {
                console.log('daily-table-body not found, skipping renderTableView');
                return;
            }

            // Èò∂Ê¢ØÁîµ‰ª∑Êï∞ÊçÆÊ†ºÂºè
            if (dailyData.length > 0 && dailyData[0].cumulativeUsage !== undefined) {
                tableBody.innerHTML = dailyData.map(day => `
                    <div class="daily-table-row">
                        <span class="date-cell">${currentLanguage === 'zh' ? `${day.day}Êó•` : day.day}</span>
                        <span class="usage-cell">${day.usage}</span>
                        <span class="cumulative-cell">${day.cumulativeUsage}</span>
                        <span class="tier-cell">${day.tier}</span>
                    </div>
                `).join('');
            } else {
                // ÂÖºÂÆπÂéüÊúâÊ†ºÂºè
                tableBody.innerHTML = dailyData.map(day => `
                    <div class="daily-table-row">
                        <span class="date-cell">${currentLanguage === 'zh' ? `${day.day}Êó•` : day.day}</span>
                        <span class="usage-cell">${day.usage}</span>
                        <span class="peak-cell">${day.peakUsage || '-'}</span>
                        <span class="offpeak-cell">${day.offPeakUsage || '-'}</span>
                        <span class="cost-cell">‚Çπ${day.cost}</span>
                    </div>
                `).join('');
            }
        }

        // Ê∏≤ÊüìÊó•ÂéÜËßÜÂõæ
        function renderCalendarView(dailyData, month) {
            const calendarGrid = document.getElementById('calendar-grid');
            const monthYear = month.split('-');
            const year = parseInt(monthYear[0]);
            const monthNum = parseInt(monthYear[1]) - 1;

            const firstDay = new Date(year, monthNum, 1).getDay();
            const daysInMonth = new Date(year, monthNum + 1, 0).getDate();

            // ËÆ°ÁÆóÊúÄÈ´òÊúÄ‰ΩéÁî®ÁîµÈáèÂíåË¥πÁî®
            const usageValues = dailyData.map(d => d.usage);
            const costValues = dailyData.map(d => d.cost);
            const maxUsage = Math.max(...usageValues);
            const minUsage = Math.min(...usageValues);
            const maxCost = Math.max(...costValues);

            // ÊâæÂà∞ÊúÄÈ´òÁî®ÁîµÈáèÂíåÊúÄÈ´òË¥πÁî®ÁöÑÊó•Êúü
            const maxUsageDay = dailyData.find(d => d.usage === maxUsage)?.day;
            const maxCostDay = dailyData.find(d => d.cost === maxCost)?.day;


            // ÊòüÊúüÊ†áÈ¢ò
            const weekDays = currentLanguage === 'zh' ?
                ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'] :
                ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

            let calendarHTML = weekDays.map(day => `<div class="calendar-weekday">${day}</div>`).join('');

            // Á©∫ÁôΩÊ†ºÂ≠êÔºàÊúàÂàùÔºâ
            for (let i = 0; i < firstDay; i++) {
                calendarHTML += '<div class="calendar-day empty"></div>';
            }

            // Êó•ÊúüÊ†ºÂ≠ê
            for (let day = 1; day <= daysInMonth; day++) {
                const dayData = dailyData.find(d => d.day === day);
                const usage = dayData ? dayData.usage : 0;
                const cost = dayData ? dayData.cost : 0;

                // Ê†πÊçÆÂΩìÂâçÁ±ªÂûãÈÄâÊã©ÊòæÁ§∫ÂÄº
                const displayValue = currentCalendarType === 'usage' ? usage : cost;
                const displayUnit = currentCalendarType === 'usage' ? 'kWh' : '‚Çπ';
                const displayFormat = currentCalendarType === 'usage' ? usage.toFixed(1) : cost.toFixed(2);

                // Ê∑ªÂä†ÊúÄÈ´òÂÄºÊ†áËÆ∞ÁÇπ
                let marker = '';
                if (currentCalendarType === 'usage' && day === maxUsageDay) {
                    marker = `<span class="max-marker usage-max" title="Êú¨ÊúàÁî®ÁîµÈáèÊúÄÈ´ò">‚óè</span>`;
                } else if (currentCalendarType === 'cost' && day === maxCostDay) {
                    marker = `<span class="max-marker cost-max" title="Êú¨ÊúàË¥πÁî®ÊúÄÈ´ò">‚óè</span>`;
                }

                calendarHTML += `
                    <div class="calendar-day ${day === 1 ? 'selected' : ''}" data-day="${day}" onclick="selectCalendarDay(${day})" title="${currentLanguage === 'zh' ? `${day}Êó•: ${displayFormat}${displayUnit}` : `Day ${day}: ${displayFormat}${displayUnit}`}">
                        <span class="day-number">${day}</span>
                        ${marker}
                        <div class="day-content">
                            <span class="day-usage-value">${displayFormat}</span>
                            <span class="day-unit">${displayUnit}</span>
                        </div>
                    </div>
                `;
            }

            calendarGrid.innerHTML = calendarHTML;

            // ÂàùÂßãÂåñÊòæÁ§∫Á¨¨‰∏ÄÂ§©ÁöÑÊï∞ÊçÆ
            generateCalendarHourlyData(1);
        }

        // ÂàáÊç¢Êó•ÊúüËØ¶ÊÉÖÊòæÁ§∫
        // ÈÄâ‰∏≠Êó•ÂéÜÊó•Êúü
        function selectCalendarDay(day) {
            // ÁßªÈô§ÂÖ∂‰ªñÊó•ÊúüÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
            document.querySelectorAll('.calendar-day').forEach(dayEl => {
                dayEl.classList.remove('selected');
            });

            // ËÆæÁΩÆÂΩìÂâçÊó•Êúü‰∏∫ÈÄâ‰∏≠
            const selectedDay = document.querySelector(`[data-day="${day}"]`);
            if (selectedDay) {
                selectedDay.classList.add('selected');
            }

            // Êõ¥Êñ∞Âè≥‰æßÊ†áÈ¢ò
            const title = document.getElementById('selected-day-title');
            if (title) {
                title.setAttribute('data-zh', `${day}Êó•ÊØèÂ∞èÊó∂Áî®ÁîµËØ¶ÊÉÖ`);
                title.setAttribute('data-en', `Day ${day} Hourly Details`);
                title.textContent = currentLanguage === 'zh' ? `${day}Êó•ÊØèÂ∞èÊó∂Áî®ÁîµËØ¶ÊÉÖ` : `Day ${day} Hourly Details`;
            }

            // ÁîüÊàêÊØèÂ∞èÊó∂Êï∞ÊçÆ
            generateCalendarHourlyData(day);
        }

        // ÁîüÊàêÊó•ÂéÜÊØèÂ∞èÊó∂Êï∞ÊçÆ
        function generateCalendarHourlyData(day) {
            const hourlyList = document.getElementById('calendar-hourly-list');
            if (!hourlyList) return;

            const timeRates = {
                peak: 5.40,     // È´òÂ≥∞Êó∂ÊÆµÔºö12:00-18:00
                standard: 4.50, // Âπ≥Â≥∞Êó∂ÊÆµÔºö08:00-12:00, 18:00-23:00
                valley: 3.60    // ‰ΩéË∞∑Êó∂ÊÆµÔºö23:00-08:00
            };

            let hourlyHTML = '';

            for (let hour = 0; hour < 24; hour++) {
                let period, periodName, rate, periodClass;

                if (hour >= 12 && hour < 18) {
                    period = 'peak';
                    periodName = currentLanguage === 'zh' ? 'È´òÂ≥∞' : 'Peak';
                    rate = timeRates.peak;
                    periodClass = 'peak';
                } else if ((hour >= 8 && hour < 12) || (hour >= 18 && hour < 23)) {
                    period = 'standard';
                    periodName = currentLanguage === 'zh' ? 'Âπ≥Â≥∞' : 'Standard';
                    rate = timeRates.standard;
                    periodClass = 'standard';
                } else {
                    period = 'valley';
                    periodName = currentLanguage === 'zh' ? '‰ΩéË∞∑' : 'Valley';
                    rate = timeRates.valley;
                    periodClass = 'valley';
                }

                // Ê®°ÊãüÊØèÂ∞èÊó∂Áî®ÁîµÈáè (0.8-2.5kWh‰πãÈó¥)
                const hourlyUsage = (Math.random() * 1.7 + 0.8).toFixed(2);
                const hourlyCost = (hourlyUsage * rate).toFixed(2);

                hourlyHTML += `
                    <div class="hourly-item ${periodClass}">
                        <span class="hour-time">${hour.toString().padStart(2, '0')}:00</span>
                        <span class="hour-period">${periodName}</span>
                        <span class="hour-usage">${hourlyUsage} kWh</span>
                        <span class="hour-rate">‚Çπ${rate.toFixed(2)}</span>
                        <span class="hour-cost">‚Çπ${hourlyCost}</span>
                    </div>
                `;
            }

            hourlyList.innerHTML = hourlyHTML;
        }


        // ÁîüÊàêÊØèÂ∞èÊó∂Áî®ÁîµÊï∞ÊçÆ
        function generateHourlyData(day) {
            const hourlyList = document.getElementById(`hourly-list-${day}`);

            // Ëé∑ÂèñÊó∂ÊÆµÁîµ‰ª∑
            const timeRates = {
                peak: 5.40,     // È´òÂ≥∞Êó∂ÊÆµ 12:00-18:00
                standard: 4.50, // Âπ≥Â≥∞Êó∂ÊÆµ 08:00-12:00 & 18:00-23:00
                valley: 3.60    // ‰ΩéË∞∑Êó∂ÊÆµ 23:00-08:00
            };

            // ÁîüÊàê24Â∞èÊó∂Êï∞ÊçÆ
            let hourlyHTML = '';
            for (let hour = 0; hour < 24; hour++) {
                // Á°ÆÂÆöÊó∂ÊÆµÁ±ªÂûã
                let period, periodName, rate, periodClass;
                if (hour >= 12 && hour < 18) {
                    period = 'peak';
                    periodName = currentLanguage === 'zh' ? 'È´òÂ≥∞' : 'Peak';
                    rate = timeRates.peak;
                    periodClass = 'peak';
                } else if ((hour >= 8 && hour < 12) || (hour >= 18 && hour < 23)) {
                    period = 'standard';
                    periodName = currentLanguage === 'zh' ? 'Âπ≥Â≥∞' : 'Standard';
                    rate = timeRates.standard;
                    periodClass = 'standard';
                } else {
                    period = 'valley';
                    periodName = currentLanguage === 'zh' ? '‰ΩéË∞∑' : 'Valley';
                    rate = timeRates.valley;
                    periodClass = 'valley';
                }

                // Ê®°ÊãüÊØèÂ∞èÊó∂Áî®ÁîµÈáè (0.8-2.5kWh‰πãÈó¥)
                const hourlyUsage = (Math.random() * 1.7 + 0.8).toFixed(2);
                const hourlyCost = (hourlyUsage * rate).toFixed(2);

                hourlyHTML += `
                    <div class="hourly-item ${periodClass}">
                        <span class="hour-time">${hour.toString().padStart(2, '0')}:00</span>
                        <span class="hour-period">${periodName}</span>
                        <span class="hour-usage">${hourlyUsage} kWh</span>
                        <span class="hour-rate">‚Çπ${rate.toFixed(2)}</span>
                        <span class="hour-cost">‚Çπ${hourlyCost}</span>
                    </div>
                `;
            }

            hourlyList.innerHTML = hourlyHTML;
        }

        // ÊòæÁ§∫ËØ¶ÁªÜËßÜÂõæÂäüËÉΩ - Âè≥‰æßÊäΩÂ±â
        function showDetailedView() {
            console.log('showDetailedView called');
            // ÂàõÂª∫Âè≥‰æßÊäΩÂ±âÊòæÁ§∫ÂàÜÊó∂Áîµ‰ª∑ÊòéÁªÜ
            const drawer = document.createElement('div');
            drawer.className = 'right-drawer';
            drawer.innerHTML = `
                <div class="drawer-overlay" onclick="closeDetailedView()"></div>
                <div class="drawer-content">
                    <div class="drawer-header">
                        <h3 data-zh="Âü∫Á°ÄÁîµË¥π‚Äî‚Äî2025/09" data-en="Basic Electricity Fee‚ÄîSeptember 2025">Âü∫Á°ÄÁîµË¥π‚Äî‚Äî2025/09</h3>
                        <button class="drawer-close" onclick="closeDetailedView()">√ó</button>
                    </div>
                    <div class="drawer-body">
                        <!-- Ê®°Âùó -->
                        <div class="drawer-usage-module">
                            <div class="drawer-module-header">
                                <div class="drawer-header-left">
                                    <div class="drawer-view-tabs">
                                        <button class="drawer-tab-btn active" onclick="switchDrawerView('chart')">
                                            <span data-zh="ÂõæË°®" data-en="Chart">ÂõæË°®</span>
                                        </button>
                                        <button class="drawer-tab-btn" onclick="switchDrawerView('calendar')">
                                            <span data-zh="Êó•ÂéÜ" data-en="Calendar">Êó•ÂéÜ</span>
                                        </button>
                                        <button class="drawer-tab-btn" onclick="switchDrawerView('table')">
                                            <span data-zh="Ë°®Ê†º" data-en="Table">Ë°®Ê†º</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="drawer-header-right">
                                    <button class="drawer-export-btn" onclick="exportDrawerData()">
                                        üìä <span data-zh="ÂØºÂá∫" data-en="Export">ÂØºÂá∫</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Ë°®Ê†ºËßÜÂõæ -->
                            <div id="drawer-table-view" class="drawer-usage-view">
                                <div class="drawer-table-container">
                                    <div class="drawer-daily-table">
                                        <div class="drawer-daily-table-header" id="drawer-table-header">
                                            <span data-zh="Êó•Êúü" data-en="Date">Êó•Êúü</span>
                                            <span data-zh="Áî®ÁîµÈáè(kWh)" data-en="Usage(kWh)">Áî®ÁîµÈáè(kWh)</span>
                                            <span data-zh="ÈáëÈ¢ù(‚Çπ)" data-en="Amount(‚Çπ)">ÈáëÈ¢ù(‚Çπ)</span>
                                            <span></span>
                                        </div>
                                        <div class="drawer-daily-table-body" id="drawer-table-body">
                                            <!-- Êï∞ÊçÆÂ∞Ü‰ªé‰∏ªÈ°µÈù¢Â§çÂà∂ -->
                                        </div>
                                    </div>
                                </div>
                                <!-- ÊØèÂ∞èÊó∂ËØ¶ÊÉÖÈù¢ÊùøÔºàÂú®Ë°®Ê†ºËßÜÂõæ‰∏≠ÔºåÁî®‰∫éÂè≥‰æßÊòæÁ§∫Ôºâ -->
                                <div id="drawer-hourly-details-panel" class="drawer-hourly-details-panel" style="display: none;">
                                    <div class="drawer-hourly-header">
                                        <h4 id="drawer-selected-date-title" data-zh="ÊØèÂ∞èÊó∂ÊòéÁªÜ" data-en="Hourly Details">ÊØèÂ∞èÊó∂ÊòéÁªÜ</h4>
                                        <button class="drawer-hourly-close" onclick="closeDrawerHourlyDetails()">√ó</button>
                                    </div>
                                    <div class="drawer-hourly-content" id="drawer-hourly-details-content">
                                        <!-- ÊØèÂ∞èÊó∂Êï∞ÊçÆÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
                                    </div>
                                </div>
                            </div>

                            <!-- Êó•ÂéÜËßÜÂõæ -->
                            <div id="drawer-calendar-view" class="drawer-usage-view">
                                <div class="drawer-calendar-container">
                                    <div class="drawer-calendar-controls">
                                        <div class="drawer-calendar-header">
                                            <h3 id="drawer-calendar-title">2025Âπ¥9Êúà</h3>
                                            <div class="drawer-calendar-toggle">
                                                <button class="drawer-calendar-toggle-btn active" data-type="usage" onclick="switchDrawerCalendarType('usage')">
                                                    <span data-zh="ÁîµÈáè" data-en="Usage">ÁîµÈáè</span>
                                                </button>
                                                <button class="drawer-calendar-toggle-btn" data-type="cost" onclick="switchDrawerCalendarType('cost')">
                                                    <span data-zh="Ë¥πÁî®" data-en="Cost">Ë¥πÁî®</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="drawer-calendar-weekdays">
                                        <div class="drawer-weekday" data-zh="Êó•" data-en="Sun">Êó•</div>
                                        <div class="drawer-weekday" data-zh="‰∏Ä" data-en="Mon">‰∏Ä</div>
                                        <div class="drawer-weekday" data-zh="‰∫å" data-en="Tue">‰∫å</div>
                                        <div class="drawer-weekday" data-zh="‰∏â" data-en="Wed">‰∏â</div>
                                        <div class="drawer-weekday" data-zh="Âõõ" data-en="Thu">Âõõ</div>
                                        <div class="drawer-weekday" data-zh="‰∫î" data-en="Fri">‰∫î</div>
                                        <div class="drawer-weekday" data-zh="ÂÖ≠" data-en="Sat">ÂÖ≠</div>
                                    </div>

                                    <div id="drawer-calendar-grid" class="drawer-calendar-grid">
                                        <!-- Êó•ÂéÜÁî±JavaScriptÁîüÊàê -->
                                    </div>

                                    <div class="drawer-calendar-legend">
                                        <div class="legend-item">
                                            <div class="legend-dot low-usage"></div>
                                            <span data-zh="‰ΩéÁî®Áîµ (<15kWh)" data-en="Low usage (<15kWh)">‰ΩéÁî®Áîµ (<15kWh)</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-dot medium-usage"></div>
                                            <span data-zh="‰∏≠Á≠âÁî®Áîµ (15-25kWh)" data-en="Medium usage (15-25kWh)">‰∏≠Á≠âÁî®Áîµ (15-25kWh)</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-dot high-usage"></div>
                                            <span data-zh="È´òÁî®Áîµ (>25kWh)" data-en="High usage (>25kWh)">È´òÁî®Áîµ (>25kWh)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ÂõæË°®ËßÜÂõæ -->
                            <div id="drawer-chart-view" class="drawer-usage-view active">
                                <div class="drawer-chart-container">
                                    <div id="drawer-usage-chart" style="width: 100%; height: 400px;"></div>
                                </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(drawer);

            // ÈòªÊ≠¢ÊäΩÂ±âÂÜÖÁöÑÊªöÂä®‰∫ã‰ª∂ÂÜíÊ≥°Âà∞‰∏ªÈ°µÈù¢
            const drawerContent = drawer.querySelector('.drawer-content');
            if (drawerContent) {
                drawerContent.addEventListener('wheel', function(e) {
                    e.stopPropagation();
                }, { passive: false });

                drawerContent.addEventListener('touchmove', function(e) {
                    e.stopPropagation();
                }, { passive: false });
            }

            // Â§çÂà∂ÂàÜÊó∂Áîµ‰ª∑Êï∞ÊçÆÂà∞ÊäΩÂ±â
            copyTimeOfUsePricingToDrawer();

            // Ê∑ªÂä†ÊòæÁ§∫Âä®Áîª
            setTimeout(() => {
                drawer.classList.add('show');
                // Á¶ÅÁî®‰∏ªÈ°µÈù¢ÊªöÂä®
                document.body.style.overflow = 'hidden';
                // ÂàùÂßãÂåñÈªòËÆ§ÁöÑÂõæË°®ËßÜÂõæ
                setTimeout(() => {
                    renderDrawerChart();
                }, 300);
            }, 10);

            // Êõ¥Êñ∞ËØ≠Ë®Ä
            EnergySystem.updateTexts();
        }

        // Èò∂Ê¢ØÁîµ‰ª∑‰∏ìÁî®ËØ¶ÁªÜËßÜÂõæÂäüËÉΩ - Âè≥‰æßÊäΩÂ±â
        function showTieredDetailedView() {
            console.log('showTieredDetailedView called');
            // ÂàõÂª∫Âè≥‰æßÊäΩÂ±âÊòæÁ§∫Èò∂Ê¢ØÁîµ‰ª∑ÊòéÁªÜ
            const drawer = document.createElement('div');
            drawer.className = 'right-drawer';
            drawer.innerHTML = `
                <div class="drawer-overlay" onclick="closeTieredDetailedView()"></div>
                <div class="drawer-content">
                    <div class="drawer-header">
                        <h3 data-zh="ÁîµÈáèË¥πÊòéÁªÜ‚Äî‚Äî2025/09" data-en="Energy Charges Details‚ÄîSeptember 2025">ÁîµÈáèË¥πÊòéÁªÜ‚Äî‚Äî2025/09</h3>
                        <button class="drawer-close" onclick="closeTieredDetailedView()">√ó</button>
                    </div>
                    <div class="drawer-body">
                        <!-- Ê®°Âùó -->
                        <div class="drawer-usage-module">
                            <div class="drawer-module-header">
                                <div class="drawer-header-left">
                                    <div class="drawer-view-tabs">
                                        <button class="drawer-tab-btn active" onclick="switchTieredDrawerView('chart')">
                                            <span data-zh="ÂõæË°®" data-en="Chart">ÂõæË°®</span>
                                        </button>
                                        <button class="drawer-tab-btn" onclick="switchTieredDrawerView('calendar')">
                                            <span data-zh="Êó•ÂéÜ" data-en="Calendar">Êó•ÂéÜ</span>
                                        </button>
                                        <button class="drawer-tab-btn" onclick="switchTieredDrawerView('table')">
                                            <span data-zh="Ë°®Ê†º" data-en="Table">Ë°®Ê†º</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="drawer-header-right">
                                    <button class="drawer-export-btn" onclick="exportTieredDrawerData()">
                                        üìä <span data-zh="ÂØºÂá∫" data-en="Export">ÂØºÂá∫</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Ë°®Ê†ºËßÜÂõæ -->
                            <div id="tiered-drawer-table-view" class="drawer-usage-view">
                                <div class="drawer-table-container">
                                    <div class="drawer-daily-table">
                                        <div class="drawer-daily-table-header" id="tiered-drawer-table-header">
                                            <span data-zh="Êó•Êúü" data-en="Date">Êó•Êúü</span>
                                            <span data-zh="Áî®ÁîµÈáè(kWh)" data-en="Usage(kWh)">Áî®ÁîµÈáè(kWh)</span>
                                            <span data-zh="Á¥ØËÆ°(kWh)" data-en="Cumulative(kWh)">Á¥ØËÆ°(kWh)</span>
                                            <span data-zh="ÊâÄÂ±ûÈò∂Ê¢Ø" data-en="Tier">ÊâÄÂ±ûÈò∂Ê¢Ø</span>
                                            <span></span>
                                        </div>
                                        <div class="drawer-daily-table-body" id="tiered-drawer-table-body">
                                            <!-- Èò∂Ê¢ØÁîµ‰ª∑Êï∞ÊçÆÂ∞ÜÁîüÊàêÂú®ËøôÈáå -->
                                        </div>
                                    </div>
                                </div>
                                <!-- Èò∂Ê¢ØÁîµ‰ª∑ÊØèÂ∞èÊó∂ËØ¶ÊÉÖÈù¢ÊùøÔºàÂú®Ë°®Ê†ºËßÜÂõæ‰∏≠ÔºåÁî®‰∫éÂè≥‰æßÊòæÁ§∫Ôºâ -->
                                <div id="tiered-drawer-hourly-details-panel" class="drawer-hourly-details-panel" style="display: none;">
                                    <div class="drawer-hourly-header">
                                        <h4 id="tiered-drawer-selected-date-title" data-zh="ÊØèÂ∞èÊó∂ÊòéÁªÜ" data-en="Hourly Details">ÊØèÂ∞èÊó∂ÊòéÁªÜ</h4>
                                        <button class="drawer-hourly-close" onclick="closeTieredDrawerHourlyDetails()">√ó</button>
                                    </div>
                                    <div class="drawer-hourly-content" id="tiered-drawer-hourly-details-content">
                                        <!-- ÊØèÂ∞èÊó∂Êï∞ÊçÆÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
                                    </div>
                                </div>
                            </div>

                            <!-- Êó•ÂéÜËßÜÂõæ -->
                            <div id="tiered-drawer-calendar-view" class="drawer-usage-view">
                                <div class="drawer-calendar-container">
                                    <div class="drawer-calendar-controls">
                                        <div class="drawer-calendar-header">
                                            <h3 id="tiered-drawer-calendar-title">2025Âπ¥9Êúà</h3>
                                            <div class="drawer-calendar-toggle">
                                                <button class="drawer-calendar-toggle-btn active" data-type="usage" onclick="switchTieredDrawerCalendarType('usage')">
                                                    <span data-zh="ÁîµÈáè" data-en="Usage">ÁîµÈáè</span>
                                                </button>
                                                <button class="drawer-calendar-toggle-btn" data-type="cumulative" onclick="switchTieredDrawerCalendarType('cumulative')">
                                                    <span data-zh="Á¥ØËÆ°" data-en="Cumulative">Á¥ØËÆ°</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="drawer-calendar-weekdays">
                                        <div class="drawer-weekday" data-zh="Êó•" data-en="Sun">Êó•</div>
                                        <div class="drawer-weekday" data-zh="‰∏Ä" data-en="Mon">‰∏Ä</div>
                                        <div class="drawer-weekday" data-zh="‰∫å" data-en="Tue">‰∫å</div>
                                        <div class="drawer-weekday" data-zh="‰∏â" data-en="Wed">‰∏â</div>
                                        <div class="drawer-weekday" data-zh="Âõõ" data-en="Thu">Âõõ</div>
                                        <div class="drawer-weekday" data-zh="‰∫î" data-en="Fri">‰∫î</div>
                                        <div class="drawer-weekday" data-zh="ÂÖ≠" data-en="Sat">ÂÖ≠</div>
                                    </div>

                                    <div id="tiered-drawer-calendar-grid" class="drawer-calendar-grid">
                                        <!-- Êó•ÂéÜÁî±JavaScriptÁîüÊàê -->
                                    </div>

                                    <div class="drawer-calendar-legend">
                                        <div class="legend-item">
                                            <div class="legend-dot tier-1"></div>
                                            <span data-zh="Á¨¨‰∏ÄÈò∂Ê¢Ø (0-100kWh) ‚Çπ3.35" data-en="Tier 1 (0-100kWh) ‚Çπ3.35">Á¨¨‰∏ÄÈò∂Ê¢Ø (0-100kWh) ‚Çπ3.35</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-dot tier-2"></div>
                                            <span data-zh="Á¨¨‰∫åÈò∂Ê¢Ø (101-200kWh) ‚Çπ4.60" data-en="Tier 2 (101-200kWh) ‚Çπ4.60">Á¨¨‰∫åÈò∂Ê¢Ø (101-200kWh) ‚Çπ4.60</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-dot tier-3"></div>
                                            <span data-zh="Á¨¨‰∏âÈò∂Ê¢Ø (201-400kWh) ‚Çπ6.85" data-en="Tier 3 (201-400kWh) ‚Çπ6.85">Á¨¨‰∏âÈò∂Ê¢Ø (201-400kWh) ‚Çπ6.85</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-dot tier-4"></div>
                                            <span data-zh="Á¨¨ÂõõÈò∂Ê¢Ø (400+kWh) ‚Çπ8.50" data-en="Tier 4 (400+kWh) ‚Çπ8.50">Á¨¨ÂõõÈò∂Ê¢Ø (400+kWh) ‚Çπ8.50</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ÂõæË°®ËßÜÂõæ -->
                            <div id="tiered-drawer-chart-view" class="drawer-usage-view active">
                                <div class="drawer-chart-container">
                                    <div id="tiered-drawer-usage-chart" style="width: 100%; height: 480px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(drawer);

            // ÈòªÊ≠¢ÊäΩÂ±âÂÜÖÁöÑÊªöÂä®‰∫ã‰ª∂ÂÜíÊ≥°Âà∞‰∏ªÈ°µÈù¢
            const drawerContent = drawer.querySelector('.drawer-content');
            if (drawerContent) {
                drawerContent.addEventListener('wheel', function(e) {
                    e.stopPropagation();
                }, { passive: false });

                drawerContent.addEventListener('touchmove', function(e) {
                    e.stopPropagation();
                }, { passive: false });
            }

            // Â§çÂà∂Èò∂Ê¢ØÁîµ‰ª∑Êï∞ÊçÆÂà∞ÊäΩÂ±â
            copyTieredPricingToDrawer();

            // Ê∑ªÂä†ÊòæÁ§∫Âä®Áîª
            setTimeout(() => {
                drawer.classList.add('show');
                // Á¶ÅÁî®‰∏ªÈ°µÈù¢ÊªöÂä®
                document.body.style.overflow = 'hidden';
                // ÂàùÂßãÂåñÈªòËÆ§ÁöÑÂõæË°®ËßÜÂõæ
                setTimeout(() => {
                    renderTieredDrawerChart();
                }, 300);
            }, 10);

            // Êõ¥Êñ∞ËØ≠Ë®Ä
            EnergySystem.updateTexts();
        }

        // Â§çÂà∂Èò∂Ê¢ØÁîµ‰ª∑Êï∞ÊçÆÂà∞ÊäΩÂ±â
        function copyTieredPricingToDrawer() {
            console.log('copyTieredPricingToDrawer called');
            const drawerTableBody = document.getElementById('tiered-drawer-table-body');
            console.log('tiered drawerTableBody:', drawerTableBody);

            if (!drawerTableBody) {
                console.error('tiered-drawer-table-body not found!');
                return;
            }

            // Èò∂Ê¢ØÁîµ‰ª∑ÁªìÊûÑ
            const tierStructure = [
                {
                    max: 100,
                    rate: 3.35,
                    name: currentLanguage === 'zh' ? 'Á¨¨‰∏ÄÈò∂Ê¢Ø (0-100kWh)' : 'Tier 1 (0-100kWh)'
                },
                {
                    max: 200,
                    rate: 4.60,
                    name: currentLanguage === 'zh' ? 'Á¨¨‰∫åÈò∂Ê¢Ø (101-200kWh)' : 'Tier 2 (101-200kWh)'
                },
                {
                    max: 400,
                    rate: 6.85,
                    name: currentLanguage === 'zh' ? 'Á¨¨‰∏âÈò∂Ê¢Ø (201-400kWh)' : 'Tier 3 (201-400kWh)'
                },
                {
                    max: Infinity,
                    rate: 8.50,
                    name: currentLanguage === 'zh' ? 'Á¨¨ÂõõÈò∂Ê¢Ø (400+kWh)' : 'Tier 4 (400+kWh)'
                }
            ];

            // ÁîüÊàêÈò∂Ê¢ØÁîµ‰ª∑Êï∞ÊçÆ - Ê®°Êãü280kWhÁöÑÊúàÁî®Èáè
            let tieredData = [];
            const daysInSeptember = new Date(2025, 9, 0).getDate(); // 2025Âπ¥9ÊúàÁöÑÂ§©Êï∞ (30Â§©)
            let cumulativeUsage = 0;
            const totalMonthUsage = 280; // ÊÄªÊúàÁî®Èáè280kWhÔºåËææÂà∞Á¨¨‰∏âÈò∂Ê¢Ø

            for (let day = 1; day <= daysInSeptember; day++) {
                // Ê®°ÊãüÊØèÊó•Áî®ÈáèÔºåÊÄªËÆ°Á∫¶280kWh
                let dailyUsage;
                if (day <= 10) {
                    dailyUsage = 8 + Math.random() * 4; // Ââç10Â§©ËæÉ‰ΩéÁî®Èáè
                } else if (day <= 20) {
                    dailyUsage = 10 + Math.random() * 4; // ‰∏≠Èó¥10Â§©‰∏≠Á≠âÁî®Èáè
                } else {
                    dailyUsage = 7 + Math.random() * 6; // Âêé10Â§©ÂèòÂåñÁî®Èáè
                }

                cumulativeUsage += dailyUsage;

                // Á°ÆÂÆöÊâÄÂ±ûÈò∂Ê¢Ø
                let tier;
                if (cumulativeUsage <= 100) {
                    tier = 1;
                } else if (cumulativeUsage <= 200) {
                    tier = 2;
                } else if (cumulativeUsage <= 400) {
                    tier = 3;
                } else {
                    tier = 4;
                }

                tieredData.push({
                    day: day,
                    date: `2025-09-${day.toString().padStart(2, '0')}`,
                    usage: dailyUsage.toFixed(2),
                    cumulative: cumulativeUsage.toFixed(2),
                    tier: tier
                });
            }

            window.currentTieredData = tieredData;
            window.tierStructure = tierStructure;
            console.log('Generated tiered data for', daysInSeptember, 'days');

            // ÁîüÊàêË°®Ê†ºË°åÔºåÂÆåÂÖ®Â§çÂà∂ÂàÜÊó∂Áîµ‰ª∑ÁöÑË°®Ê†ºÁªìÊûÑ
            drawerTableBody.innerHTML = '';
            console.log('Tiered data length:', tieredData.length);
            let dayCounter = 1;

            tieredData.forEach(dayData => {
                console.log('Processing tiered day:', dayData);

                // ÂàõÂª∫‰∏ªË°å
                const newRow = document.createElement('div');
                newRow.className = 'drawer-daily-table-row';
                newRow.innerHTML = `
                    <span class="drawer-daily-date">${dayData.date}</span>
                    <span class="drawer-daily-usage">${dayData.usage}</span>
                    <span class="drawer-daily-cumulative">${dayData.cumulative}</span>
                    <span class="drawer-daily-tier">${currentLanguage === 'zh' ? `Á¨¨${dayData.tier}Èò∂Ê¢Ø` : `Tier ${dayData.tier}`}</span>
                    <span class="drawer-daily-action">
                        <button class="drawer-view-details-btn btn-primary-small" onclick="showTieredDrawerDayDetails('${dayData.date}', event)">
                            <svg style="width: 12px; height: 12px; margin-right: 4px;" viewBox="0 0 24 24" fill="none">
                                <path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span data-zh="Êü•ÁúãËØ¶ÊÉÖ" data-en="View Details">Êü•ÁúãËØ¶ÊÉÖ</span>
                        </button>
                    </span>
                `;

                // ÂàõÂª∫ËØ¶ÊÉÖË°å - ÂÆåÂÖ®Â§çÂà∂ÂàÜÊó∂Áîµ‰ª∑ÁöÑÁªìÊûÑ
                const detailsRow = document.createElement('div');
                detailsRow.className = 'drawer-daily-details-row';
                detailsRow.style.display = 'none';
                detailsRow.innerHTML = `
                    <div class="drawer-daily-details-content">
                        <div class="drawer-hourly-content">
                            <div class="drawer-hourly-table">
                                <div class="drawer-hourly-table-header">
                                    <span data-zh="Êó∂Èó¥" data-en="Time">Êó∂Èó¥</span>
                                    <span data-zh="Èò∂Ê¢Ø" data-en="Tier">Èò∂Ê¢Ø</span>
                                    <span data-zh="Áî®ÁîµÈáè" data-en="Usage">Áî®ÁîµÈáè</span>
                                    <span data-zh="Âçï‰ª∑" data-en="Rate">Âçï‰ª∑</span>
                                    <span data-zh="ÈáëÈ¢ù" data-en="Amount">ÈáëÈ¢ù</span>
                                </div>
                                <div class="drawer-hourly-table-body" id="tiered-drawer-hourly-body-${dayCounter}">
                                    <!-- ÊØèÂ∞èÊó∂Êï∞ÊçÆÁî±JavaScriptÁîüÊàê -->
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                drawerTableBody.appendChild(newRow);
                drawerTableBody.appendChild(detailsRow);
                dayCounter++;
            });

            console.log('Tiered table generated with', dayCounter - 1, 'rows');
        }

        // ÂÖ≥Èó≠Èò∂Ê¢ØÁîµ‰ª∑ÊäΩÂ±â
        function closeTieredDetailedView() {
            const drawer = document.querySelector('.right-drawer');
            if (drawer) {
                drawer.classList.remove('show');
                // ÊÅ¢Â§ç‰∏ªÈ°µÈù¢ÊªöÂä®
                document.body.style.overflow = 'auto';
                setTimeout(() => {
                    drawer.remove();
                }, 300);
            }
        }

        // ÂàáÊç¢Èò∂Ê¢ØÁîµ‰ª∑ÊäΩÂ±âËßÜÂõæ
        function switchTieredDrawerView(viewType) {
            console.log('switchTieredDrawerView:', viewType);

            // Ê£ÄÊü•ÊòØÂê¶ÊúâÈÄâ‰∏≠ÁöÑÊó•ÊúüÔºàÂ±ïÂºÄÁä∂ÊÄÅÔºâ
            const selectedCalendarDay = document.querySelector('.drawer-calendar-day.selected');
            const selectedTableRow = document.querySelector('.drawer-daily-table-row.selected');
            const isExpanded = selectedCalendarDay !== null || selectedTableRow !== null;

            // ËßÜÂõæÂàáÊç¢Êó∂ÁöÑÊ∏ÖÁêÜÂ∑•‰Ωú
            const drawer = document.querySelector('.right-drawer');

            if (viewType === 'calendar') {
                console.log('Calendar view selected - clearing selections but keeping drawer state');

                // Ê∏ÖÈô§ÊâÄÊúâÈÄâ‰∏≠Áä∂ÊÄÅ
                document.querySelectorAll('.drawer-calendar-day.selected').forEach(day => {
                    day.classList.remove('selected');
                });
                document.querySelectorAll('.drawer-daily-table-row.selected').forEach(row => {
                    row.classList.remove('selected');
                });
                document.querySelectorAll('.drawer-daily-details-row').forEach(row => {
                    row.style.display = 'none';
                });

                // Â¶ÇÊûúÂΩìÂâçÊúâÂ±ïÂºÄÁä∂ÊÄÅÔºåÊî∂Ëµ∑ÊäΩÂ±âÊÅ¢Â§çÁ™ÑÂÆΩÂ∫¶
                if (drawer.classList.contains('expanded')) {
                    drawer.classList.remove('expanded');
                    console.log('Calendar view selected - drawer collapsed to narrow width');
                }
            } else {
                // ÂàáÊç¢Âà∞ÈùûÊó•ÂéÜËßÜÂõæÊó∂ÔºåÊ∏ÖÁêÜÊó•ÂéÜËØ¶ÊÉÖÈù¢Êùø
                const calendarDetailsPanel = document.getElementById('tiered-calendar-hourly-details-panel');
                if (calendarDetailsPanel) {
                    calendarDetailsPanel.remove();
                }

                // Ê∏ÖÁêÜÈÄâ‰∏≠Áä∂ÊÄÅ
                document.querySelectorAll('.drawer-calendar-day.selected').forEach(day => {
                    day.classList.remove('selected');
                });
                document.querySelectorAll('.drawer-daily-table-row.selected').forEach(row => {
                    row.classList.remove('selected');
                });
                document.querySelectorAll('.drawer-daily-details-row').forEach(row => {
                    row.style.display = 'none';
                });

                // Êî∂Ëµ∑ÊäΩÂ±â
                if (drawer.classList.contains('expanded')) {
                    drawer.classList.remove('expanded');
                }
            }

            // Êõ¥Êñ∞Ê†áÁ≠æÁä∂ÊÄÅ
            document.querySelectorAll('.drawer-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Êõ¥ÂÆâÂÖ®ÁöÑÊåâÈíÆÈÄâÊã©ÊñπÂºè
            const targetBtn = document.querySelector(`[onclick="switchTieredDrawerView('${viewType}')"]`);
            if (targetBtn) {
                targetBtn.classList.add('active');
                console.log('Button activated:', targetBtn);
            } else {
                console.error('Button not found for viewType:', viewType);
            }

            // ÂàáÊç¢ËßÜÂõæ
            document.querySelectorAll('.drawer-usage-view').forEach(view => {
                view.classList.remove('active');
                view.style.display = 'none';
                console.log('Removed active from:', view.id);
            });

            const targetView = document.getElementById(`tiered-drawer-${viewType}-view`);
            if (targetView) {
                targetView.classList.add('active');
                console.log('Added active to:', targetView.id);

                // Ê∏ÖÈô§ÂÜÖËÅîÊ†∑ÂºèÔºåËÆ©CSSËßÑÂàôÊ†πÊçÆÂ±ïÂºÄÁä∂ÊÄÅËá™Âä®ÁîüÊïà
                targetView.style.display = '';
            } else {
                console.error('Target view not found:', `tiered-drawer-${viewType}-view`);
            }

            // Ê†πÊçÆËßÜÂõæÁ±ªÂûãÊâßË°åÁâπÂÆöÊìç‰Ωú
            if (viewType === 'chart') {
                setTimeout(() => {
                    renderTieredDrawerChart();
                }, 100);
            } else if (viewType === 'calendar') {
                setTimeout(() => {
                    renderTieredDrawerCalendar();
                }, 100);
            } else if (viewType === 'table') {
                setTimeout(() => {
                    copyTieredPricingToDrawerTable();
                }, 100);
            }
        }

        // ÊòæÁ§∫Èò∂Ê¢ØÁîµ‰ª∑ÊäΩÂ±â‰∏≠ÊüêÂ§©ÁöÑËØ¶ÊÉÖ
        function showTieredDrawerDayDetails(date, event) {
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }

            console.log('showTieredDrawerDayDetails called for:', date);

            // Êü•ÊâæËØ•Êó•ÊúüÁöÑÊï∞ÊçÆ
            const dayData = window.currentTieredData?.find(d => d.date === date);
            if (!dayData) {
                console.error('Day data not found for:', date);
                return;
            }

            // ÊâæÂà∞ÂØπÂ∫îÁöÑË°®Ê†ºË°åÂíåËØ¶ÊÉÖË°å
            const tableRows = document.querySelectorAll('.drawer-daily-table-row');
            const detailsRows = document.querySelectorAll('.drawer-daily-details-row');

            let targetRow = null;
            let targetDetailsRow = null;
            let rowIndex = -1;

            // Êü•ÊâæÂØπÂ∫îÁöÑË°å
            tableRows.forEach((row, index) => {
                const rowDate = row.querySelector('.drawer-daily-date').textContent;
                if (rowDate === date) {
                    targetRow = row;
                    targetDetailsRow = detailsRows[index];
                    rowIndex = index;
                }
            });

            if (!targetRow || !targetDetailsRow) {
                console.error('Table row not found for date:', date);
                return;
            }

            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÂ±ïÂºÄ
            const isExpanded = targetDetailsRow.style.display === 'block';

            // ÂÖàÊî∂Ëµ∑ÊâÄÊúâÂ±ïÂºÄÁöÑË°å
            detailsRows.forEach(row => {
                row.style.display = 'none';
            });
            tableRows.forEach(row => {
                row.classList.remove('selected');
            });

            if (!isExpanded) {
                // Â±ïÂºÄÈÄâ‰∏≠ÁöÑË°å
                targetDetailsRow.style.display = 'block';
                targetRow.classList.add('selected');

                // ÁîüÊàêÂ∞èÊó∂Êï∞ÊçÆ
                const hourlyBodyId = `tiered-drawer-hourly-body-${rowIndex + 1}`;
                const hourlyBody = document.getElementById(hourlyBodyId);

                if (hourlyBody) {
                    let hourlyHTML = '';
                    for (let hour = 0; hour < 24; hour++) {
                        const hourUsage = (parseFloat(dayData.usage) / 24 + Math.random() * 2 - 1).toFixed(2);
                        const hourlyRate = getTieredHourlyRate(dayData.tier, hour);
                        const hourlyCost = (hourUsage * hourlyRate).toFixed(2);

                        const tierName = currentLanguage === 'zh' ? `Á¨¨${dayData.tier}Èò∂Ê¢Ø` : `Tier ${dayData.tier}`;

                        hourlyHTML += `
                            <div class="drawer-hourly-table-row">
                                <span class="drawer-hourly-time">${hour.toString().padStart(2, '0')}:00</span>
                                <span class="drawer-hourly-tier">${tierName}</span>
                                <span class="drawer-hourly-usage">${hourUsage}</span>
                                <span class="drawer-hourly-rate">‚Çπ${hourlyRate}</span>
                                <span class="drawer-hourly-cost">‚Çπ${hourlyCost}</span>
                            </div>
                        `;
                    }
                    hourlyBody.innerHTML = hourlyHTML;
                }

                // Êõ¥Êñ∞ËØ≠Ë®Ä
                EnergySystem.updateTexts();
            }
        }

        // Ëé∑ÂèñÈò∂Ê¢ØÁîµ‰ª∑ÁöÑÂ∞èÊó∂Ë¥πÁéá
        function getTieredHourlyRate(tier, hour) {
            const baseRates = {
                1: 3.35,  // Á¨¨‰∏ÄÈò∂Ê¢Ø ‚Çπ3.35
                2: 4.60,  // Á¨¨‰∫åÈò∂Ê¢Ø ‚Çπ4.60
                3: 6.85,  // Á¨¨‰∏âÈò∂Ê¢Ø ‚Çπ6.85
                4: 8.50   // Á¨¨ÂõõÈò∂Ê¢Ø ‚Çπ8.50 (‰º∞ÁÆó)
            };

            // Èò∂Ê¢ØÁîµ‰ª∑‰∏ÄËà¨Ê≤°ÊúâÊó∂ÊÆµÂ∑ÆÂºÇÔºå‰ΩøÁî®Âõ∫ÂÆöË¥πÁéá
            return baseRates[tier].toFixed(2);
        }


        // Ê∏≤ÊüìÈò∂Ê¢ØÁîµ‰ª∑ÊäΩÂ±âÂõæË°®
        function renderTieredDrawerChart() {
            console.log('renderTieredDrawerChart called');

            if (!window.echarts) {
                console.error('ECharts not loaded');
                return;
            }

            const chartContainer = document.getElementById('tiered-drawer-usage-chart');
            if (!chartContainer) {
                console.error('Tiered chart container not found');
                return;
            }

            // ÈîÄÊØÅÁé∞ÊúâÂõæË°®ÂÆû‰æã
            if (window.tieredDrawerChartInstance) {
                window.tieredDrawerChartInstance.dispose();
            }

            const chart = echarts.init(chartContainer);
            window.tieredDrawerChartInstance = chart;

            // ‰ΩøÁî®Èò∂Ê¢ØÁîµ‰ª∑Êï∞ÊçÆ
            const data = window.currentTieredData || [];
            const dates = data.map(d => d.date.substring(5)); // Âè™ÊòæÁ§∫Êúà-Êó•
            const usageData = data.map(d => parseFloat(d.usage));
            const tierData = data.map(d => d.tier);

            // ËÆ°ÁÆóÈò∂Ê¢ØÂå∫Èó¥ÂíåÁî®Èáè
            const tierRanges = [];
            let currentTier = tierData[0];
            let startIndex = 0;

            for (let i = 1; i <= tierData.length; i++) {
                if (i === tierData.length || tierData[i] !== currentTier) {
                    // ËÆ°ÁÆóËØ•Èò∂Ê¢ØÁöÑÊÄªÁî®Èáè
                    let tierUsage = 0;
                    for (let j = startIndex; j <= i - 1; j++) {
                        tierUsage += usageData[j];
                    }

                    tierRanges.push({
                        tier: currentTier,
                        start: startIndex,
                        end: i - 1,
                        startDate: dates[startIndex],
                        endDate: dates[i - 1],
                        usage: tierUsage.toFixed(1)
                    });
                    if (i < tierData.length) {
                        currentTier = tierData[i];
                        startIndex = i;
                    }
                }
            }

            // ÂàõÂª∫Èò∂Ê¢ØÂå∫Èó¥Ê†áËÆ∞Á∫ø
            const markAreas = tierRanges.map(range => ({
                name: currentLanguage === 'zh' ? `Èò∂Ê¢Ø${range.tier}` : `Tier ${range.tier}`,
                xAxis: range.startDate,
                x2Axis: range.endDate,
                itemStyle: {
                    color: 'transparent',
                    borderColor: 'transparent'
                },
                label: {
                    show: true,
                    position: 'bottom',
                    distance: 10,
                    formatter: currentLanguage === 'zh' ?
                        `Èò∂Ê¢Ø${range.tier}\n(${range.startDate}~${range.endDate})` :
                        `Tier ${range.tier}\n(${range.startDate}~${range.endDate})`,
                    fontSize: 10,
                    color: '#666'
                }
            }));

            const option = {
                title: {
                    text: currentLanguage === 'zh' ? 'Èò∂Ê¢ØÁîµ‰ª∑Êó•Áî®ÁîµÈáèÂàÜÊûê' : 'Tiered Pricing Daily Usage Analysis',
                    left: 'center',
                    textStyle: {
                        fontSize: 16,
                        fontWeight: 500
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    },
                    formatter: function(params) {
                        const param = params[0];
                        const tier = tierData[param.dataIndex];
                        const tierNames = currentLanguage === 'zh' ? {
                            1: 'Á¨¨‰∏ÄÈò∂Ê¢Ø (0-100kWh) ‚Çπ3.35',
                            2: 'Á¨¨‰∫åÈò∂Ê¢Ø (101-200kWh) ‚Çπ4.60',
                            3: 'Á¨¨‰∏âÈò∂Ê¢Ø (201-400kWh) ‚Çπ6.85',
                            4: 'Á¨¨ÂõõÈò∂Ê¢Ø (400+kWh) ‚Çπ8.50'
                        } : {
                            1: 'Tier 1 (0-100kWh) ‚Çπ3.35',
                            2: 'Tier 2 (101-200kWh) ‚Çπ4.60',
                            3: 'Tier 3 (201-400kWh) ‚Çπ6.85',
                            4: 'Tier 4 (400+kWh) ‚Çπ8.50'
                        };

                        return `<div style="font-weight: 500; margin-bottom: 8px;">${dates[param.dataIndex]}</div>
                                <div style="margin: 4px 0;">
                                    <span style="display: inline-block; width: 10px; height: 10px; background: ${param.color}; border-radius: 50%; margin-right: 6px;"></span>
                                    ${currentLanguage === 'zh' ? 'Êó•Áî®ÁîµÈáè' : 'Daily Usage'}: ${param.value} kWh
                                </div>
                                <div style="margin: 4px 0; color: #666;">
                                    ${currentLanguage === 'zh' ? 'ÊâÄÂ±ûÈò∂Ê¢Ø' : 'Tier'}: ${tierNames[tier]}
                                </div>`;
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '12%',
                    top: '12%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    axisLabel: {
                        rotate: 45,
                        fontSize: 11
                    }
                },
                yAxis: {
                    type: 'value',
                    name: currentLanguage === 'zh' ? 'Êó•Áî®ÁîµÈáè (kWh)' : 'Daily Usage (kWh)',
                    nameTextStyle: {
                        fontSize: 12
                    }
                },
                series: [
                    {
                        name: currentLanguage === 'zh' ? 'Êó•Áî®ÁîµÈáè' : 'Daily Usage',
                        type: 'bar',
                        data: usageData,
                        itemStyle: {
                            color: '#0066CC'
                        },
                        barWidth: '60%',
                        emphasis: {
                            itemStyle: {
                                shadowBlur: 10,
                                shadowOffsetX: 0,
                                shadowColor: 'rgba(0, 0, 0, 0.2)'
                            }
                        },
                        markArea: {
                            silent: true,
                            data: tierRanges.map(range => [
                                {
                                    name: currentLanguage === 'zh' ? `Èò∂Ê¢Ø${range.tier}` : `Tier ${range.tier}`,
                                    xAxis: range.startDate,
                                    itemStyle: {
                                        color: 'rgba(0, 102, 204, 0.05)',
                                        borderColor: '#0066CC',
                                        borderWidth: 1,
                                        borderType: 'dashed'
                                    },
                                    label: {
                                        show: true,
                                        position: 'insideTop',
                                        formatter: function() {
                                            const tierRanges = currentLanguage === 'zh' ? {
                                                1: 'Á¨¨‰∏ÄÈò∂Ê¢Ø\n(0-100kWh)',
                                                2: 'Á¨¨‰∫åÈò∂Ê¢Ø\n(101-200kWh)',
                                                3: 'Á¨¨‰∏âÈò∂Ê¢Ø\n(201-400kWh)',
                                                4: 'Á¨¨ÂõõÈò∂Ê¢Ø\n(400+kWh)'
                                            } : {
                                                1: 'Tier 1\n(0-100kWh)',
                                                2: 'Tier 2\n(101-200kWh)',
                                                3: 'Tier 3\n(201-400kWh)',
                                                4: 'Tier 4\n(400+kWh)'
                                            };
                                            return tierRanges[range.tier] || (currentLanguage === 'zh' ? `Á¨¨${range.tier}Èò∂Ê¢Ø` : `Tier ${range.tier}`);
                                        },
                                        fontSize: 10,
                                        color: '#666',
                                        fontWeight: 'bold'
                                    }
                                },
                                {
                                    xAxis: range.endDate
                                }
                            ])
                        }
                    }
                ]
            };

            chart.setOption(option);

            // ÂìçÂ∫îÂºèË∞ÉÊï¥
            window.addEventListener('resize', function() {
                chart.resize();
            });
        }

        // ÁîüÊàêÈò∂Ê¢ØÁîµ‰ª∑ÊäΩÂ±âÊó•ÂéÜ - ÂÆåÂÖ®Â§çÂà∂ÂàÜÊó∂Áîµ‰ª∑ÈÄªËæë
        function renderTieredDrawerCalendar() {
            const calendarGrid = document.getElementById('tiered-drawer-calendar-grid');
            if (!calendarGrid) return;

            // Ëé∑ÂèñÂΩìÂâçÊó•Êúü
            const now = new Date();
            const currentYear = 2025;
            const currentMonth = 8; // JavaScript‰∏≠9ÊúàÊòØÁ¥¢Âºï8
            const today = now.getDate();

            // Ê®°ÊãüÊï∞ÊçÆÁî®‰∫éÊâæÂà∞ÊúÄÂ§ßÂÄº - Á°Æ‰øù‰∏∫2025Âπ¥9ÊúàÁîüÊàê30Â§©Êï∞ÊçÆ
            const monthlyData = [];
            const daysInMonth = new Date(2025, 9, 0).getDate(); // 2025Âπ¥9ÊúàÁöÑÂ§©Êï∞ (30Â§©)
            const data = window.currentTieredData || [];

            for (let d = 1; d <= daysInMonth; d++) {
                const dayData = data.find(item => item.day === d);
                if (dayData) {
                    const usage = parseFloat(dayData.usage);
                    const cumulative = parseFloat(dayData.cumulative);
                    monthlyData.push({ day: d, usage, cumulative, tier: dayData.tier });
                } else {
                    const usage = 15 + Math.sin(d * 0.3) * 8 + Math.random() * 6;
                    monthlyData.push({ day: d, usage, cumulative: usage, tier: 1 });
                }
            }

            const maxUsage = Math.max(...monthlyData.map(d => d.usage));
            const maxCumulative = Math.max(...monthlyData.map(d => d.cumulative));
            const maxUsageDay = monthlyData.find(d => d.usage === maxUsage)?.day;
            const maxCumulativeDay = monthlyData.find(d => d.cumulative === maxCumulative)?.day;

            // ÁîüÊàêÊó•ÂéÜÊï∞ÊçÆ
            const firstDay = new Date(2025, currentMonth, 1);
            const lastDay = new Date(2025, currentMonth + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            let calendarHTML = '';
            let date = new Date(startDate);

            // ÁîüÊàê6Âë®ÁöÑÊó•ÂéÜÔºà42Â§©Ôºâ
            for (let i = 0; i < 42; i++) {
                const day = date.getDate();
                const isCurrentMonth = date.getMonth() === currentMonth;
                const isToday = isCurrentMonth && day === today;
                const isOtherMonth = !isCurrentMonth;

                // Ê®°ÊãüÁî®ÁîµÈáèÊï∞ÊçÆ - ‰ΩøÁî®È¢ÑÁîüÊàêÁöÑÊï∞ÊçÆÁ°Æ‰øù‰∏ÄËá¥ÊÄß
                let dailyUsage = 0;
                let cumulativeUsage = 0;
                if (isCurrentMonth && day <= daysInMonth) {
                    const dayData = monthlyData.find(d => d.day === day);
                    dailyUsage = dayData ? dayData.usage : 15 + Math.sin(day * 0.3) * 8 + Math.random() * 6;
                    cumulativeUsage = dayData ? dayData.cumulative : dailyUsage;
                }

                // Ê†πÊçÆÂΩìÂâçÁ±ªÂûãÈÄâÊã©ÊòæÁ§∫ÂÄº
                const displayValue = currentTieredDrawerCalendarType === 'usage' ? dailyUsage : cumulativeUsage;
                const displayUnit = 'kWh';
                const displayFormat = currentTieredDrawerCalendarType === 'usage' ? dailyUsage.toFixed(1) : cumulativeUsage.toFixed(1);

                // Ê∑ªÂä†ÊúÄÈ´òÂÄºÊ†áËÆ∞ÁÇπ
                let marker = '';
                if (isCurrentMonth) {
                    if (currentTieredDrawerCalendarType === 'usage' && day === maxUsageDay) {
                        marker = `<span class="drawer-max-marker usage-max" title="Êú¨ÊúàÁî®ÁîµÈáèÊúÄÈ´ò">‚óè</span>`;
                    } else if (currentTieredDrawerCalendarType === 'cumulative' && day === maxCumulativeDay) {
                        marker = `<span class="drawer-max-marker cumulative-max" title="Êú¨ÊúàÁ¥ØËÆ°ÊúÄÈ´ò">‚óè</span>`;
                    }
                }

                const dayClasses = [
                    'drawer-calendar-day',
                    isOtherMonth ? 'other-month' : ''
                ].filter(Boolean).join(' ');

                calendarHTML += `
                    <div class="${dayClasses}" data-date="${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}" onclick="showTieredCalendarDayDetails('${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}', ${day})">
                        <div class="drawer-day-number">${day}</div>
                        ${marker}
                        ${isCurrentMonth ? `
                            <div class="drawer-day-content">
                                <div class="drawer-day-usage-value">${displayFormat}</div>
                                <div class="drawer-day-unit">${displayUnit}</div>
                            </div>
                        ` : ''}
                    </div>
                `;

                date.setDate(date.getDate() + 1);
            }

            calendarGrid.innerHTML = calendarHTML;

            // Êõ¥Êñ∞Ê†áÈ¢ò
            const calendarTitle = document.getElementById('tiered-drawer-calendar-title');
            if (calendarTitle) {
                const monthNames = currentLanguage === 'zh' ?
                    ['1Êúà', '2Êúà', '3Êúà', '4Êúà', '5Êúà', '6Êúà', '7Êúà', '8Êúà', '9Êúà', '10Êúà', '11Êúà', '12Êúà'] :
                    ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                calendarTitle.textContent = currentLanguage === 'zh' ?
                    `2025Âπ¥${monthNames[currentMonth]}` :
                    `${monthNames[currentMonth]} 2025`;
            }
        }

        // Èò∂Ê¢ØÁîµ‰ª∑Êó•ÂéÜÁ±ªÂûãË∑üË∏™
        let currentTieredDrawerCalendarType = 'usage';
        let currentTieredCalendarType = 'usage';

        // ÂàáÊç¢Èò∂Ê¢ØÁîµ‰ª∑ÊäΩÂ±âÊó•ÂéÜÁ±ªÂûã - ÂÆåÂÖ®Â§çÂà∂ÂàÜÊó∂Áîµ‰ª∑ÈÄªËæë
        function switchTieredDrawerCalendarType(type) {
            currentTieredDrawerCalendarType = type;

            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            document.querySelectorAll('.drawer-calendar-toggle-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });

            // ÈáçÊñ∞ÁîüÊàêÊäΩÂ±âÊó•ÂéÜ
            renderTieredDrawerCalendar();
        }

        // ÊòæÁ§∫/ÂàáÊç¢Èò∂Ê¢ØÁîµ‰ª∑Êó•ÊúüËØ¶ÊÉÖÂπ∂Êâ©Â±ï/Êî∂Áº©ÊäΩÂ±â - ÂÆåÂÖ®Â§çÂà∂ÂàÜÊó∂Áîµ‰ª∑ÈÄªËæë
        function showTieredDayDetails(dateStr) {
            // Ëß£ÊûêÊó•Êúü
            const [year, month, day] = dateStr.split('-');
            const date = new Date(year, month - 1, day);
            const monthNames = getMonthNames();

            // Ê£ÄÊü•ÊòØÂê¶ÊòØË¥¶ÂçïÊúà‰ªΩÔºà2025Âπ¥9ÊúàÔºâ
            if (parseInt(year) !== 2025 || parseInt(month) !== 9) {
                return; // ÈùûË¥¶ÂçïÊúà‰ªΩ‰∏çÊòæÁ§∫ËØ¶ÊÉÖ
            }

            // Ê£ÄÊü•ÂΩìÂâçÊòØÂê¶Âú®Êó•ÂéÜËßÜÂõæÔºåÂ¶ÇÊûúÊòØÔºåÈúÄË¶ÅÁâπÊÆäÂ§ÑÁêÜËØ¶ÊÉÖÊòæÁ§∫
            const currentActiveView = document.querySelector('.drawer-usage-view.active');
            if (currentActiveView && currentActiveView.id === 'tiered-drawer-calendar-view') {
                // Âú®Êó•ÂéÜËßÜÂõæ‰∏≠ÔºåÂàõÂª∫‰∏¥Êó∂ËØ¶ÊÉÖÈù¢ÊùøÊòæÁ§∫Âú®Âè≥‰æß
                showTieredCalendarDayDetails(dateStr, parseInt(day));
                return;
            }

            const clickedDay = document.querySelector(`[data-date="${dateStr}"]`);
            const isAlreadySelected = clickedDay.classList.contains('selected');

            if (isAlreadySelected) {
                // Â¶ÇÊûúÂ∑≤ÁªèÈÄâ‰∏≠ÔºåÂàôÂèñÊ∂àÈÄâÊã©Âπ∂Êî∂Ëµ∑
                closeTieredDrawerHourlyDetails();
            } else {
                // Â¶ÇÊûúÊú™ÈÄâ‰∏≠ÔºåÂàôÈÄâ‰∏≠Âπ∂Â±ïÂºÄ
                // Êõ¥Êñ∞ÈÄâ‰∏≠Áä∂ÊÄÅ - Ê∏ÖÈô§Êó•ÂéÜÂíåË°®Ê†ºÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
                document.querySelectorAll('.drawer-calendar-day').forEach(dayEl => {
                    dayEl.classList.remove('selected');
                });
                document.querySelectorAll('.drawer-daily-table-row').forEach(rowEl => {
                    rowEl.classList.remove('selected');
                });

                // ÈÄâ‰∏≠ÂΩìÂâçÁÇπÂáªÁöÑÂÖÉÁ¥†ÔºàÂèØËÉΩÊòØÊó•ÂéÜÊó•ÊúüÊàñË°®Ê†ºË°åÔºâ
                if (clickedDay) {
                    clickedDay.classList.add('selected');
                }

                // Êâ©Â±ïÊäΩÂ±â
                const drawer = document.querySelector('.right-drawer');
                drawer.classList.add('expanded');
                console.log('Drawer expanded in showTieredDayDetails:', drawer);

                // Êó†ËÆ∫‰ªÄ‰πàËßÜÂõæÔºåÈÉΩ‰ΩøÁî®Áõ∏ÂêåÁöÑËØ¶ÊÉÖÈù¢ÊùøÁ°Æ‰øù‰∏ÄËá¥ÊÄß
                showTieredDrawerHourlyDetailsCommon(dateStr, parseInt(day));
            }
        }

        function showTieredCalendarDayDetails(dateStr, dayNumber) {
            console.log('showTieredCalendarDayDetails called:', dateStr, dayNumber);

            // Ëß£ÊûêÊó•Êúü
            const [year, month, day] = dateStr.split('-');
            const monthNames = getMonthNames();

            // Êü•ÊâæË¢´ÁÇπÂáªÁöÑÊó•ÂéÜÊ†ºÂ≠ê
            const clickedDay = document.querySelector(`[data-date="${dateStr}"]`);
            const isAlreadySelected = clickedDay && clickedDay.classList.contains('selected');

            if (isAlreadySelected) {
                // Â¶ÇÊûúÂ∑≤ÁªèÈÄâ‰∏≠ÔºåÂàôÂèñÊ∂àÈÄâÊã©Âπ∂Êî∂Ëµ∑
                closeTieredCalendarHourlyDetails();
            } else {
                // Ê∏ÖÈô§ÊâÄÊúâÈÄâ‰∏≠Áä∂ÊÄÅ
                document.querySelectorAll('.drawer-calendar-day.selected').forEach(day => {
                    day.classList.remove('selected');
                });

                // ÈÄâ‰∏≠ÂΩìÂâçÁÇπÂáªÁöÑÊó•ÂéÜÊ†ºÂ≠ê
                if (clickedDay) {
                    clickedDay.classList.add('selected');
                }

                // Êâ©Â±ïÊäΩÂ±â
                const drawer = document.querySelector('.right-drawer');
                drawer.classList.add('expanded');

                // Âä®ÊÄÅÂàõÂª∫ËØ¶ÊÉÖÈù¢ÊùøÂú®Êó•ÂéÜËßÜÂõæÁöÑÂè≥‰æß
                createTieredCalendarDetailsPanel(dateStr, dayNumber);
            }
        }

        // ‰∏∫Èò∂Ê¢ØÁîµ‰ª∑Êó•ÂéÜËßÜÂõæÂàõÂª∫ËØ¶ÊÉÖÈù¢Êùø
        function createTieredCalendarDetailsPanel(dateStr, dayNumber) {
            // ÁßªÈô§‰πãÂâçÁöÑËØ¶ÊÉÖÈù¢ÊùøÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
            const existingPanel = document.getElementById('tiered-calendar-hourly-details-panel');
            if (existingPanel) {
                existingPanel.remove();
            }

            // Ëß£ÊûêÊó•ÊúüÁî®‰∫éÊ†áÈ¢ò
            const [year, month, day] = dateStr.split('-');
            const monthNames = getMonthNames();

            // Âú®Êó•ÂéÜËßÜÂõæ‰∏≠ÂàõÂª∫ËØ¶ÊÉÖÈù¢Êùø
            const calendarView = document.getElementById('tiered-drawer-calendar-view');
            const detailsPanel = document.createElement('div');
            detailsPanel.id = 'tiered-calendar-hourly-details-panel';
            detailsPanel.className = 'drawer-hourly-details-panel';
            detailsPanel.innerHTML = `
                <div class="drawer-hourly-header">
                    <h4>${currentLanguage === 'zh' ?
                        `${year}Âπ¥${monthNames[parseInt(month) - 1]}${day}Êó• ‚Äî ÊØèÂ∞èÊó∂ÊòéÁªÜ` :
                        `${monthNames[parseInt(month) - 1]} ${day}, ${year} ‚Äî Hourly Details`}</h4>
                    <button class="drawer-hourly-close" onclick="closeTieredCalendarHourlyDetails()">√ó</button>
                </div>
                <div class="drawer-hourly-content" id="tiered-calendar-hourly-details-content">
                    <!-- ÊØèÂ∞èÊó∂Êï∞ÊçÆÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
                </div>
            `;

            calendarView.appendChild(detailsPanel);

            // ÁîüÊàêÊØèÂ∞èÊó∂Êï∞ÊçÆ
            setTimeout(() => {
                generateTieredDrawerHourlyData(parseInt(day), 'tiered-calendar-hourly-details-content');
            }, 100);
        }

        // Èò∂Ê¢ØÁîµ‰ª∑ÈÄöÁî®ÁöÑÂ∞èÊó∂ËØ¶ÊÉÖÊòæÁ§∫ÂáΩÊï∞
        function showTieredDrawerHourlyDetailsCommon(dateStr, dayNumber) {
            console.log('showTieredDrawerHourlyDetailsCommon called:', dateStr, dayNumber);

            const [year, month, day] = dateStr.split('-');
            const monthNames = getMonthNames();

            // ËøôÈáåÂèØ‰ª•Ê†πÊçÆ‰∏çÂêåËßÜÂõæ‰ΩøÁî®‰∏çÂêåÁöÑËØ¶ÊÉÖÈù¢Êùø
            const currentActiveView = document.querySelector('.drawer-usage-view.active');
            let panelId = 'tiered-drawer-hourly-details-panel';
            let titleId = 'tiered-drawer-selected-date-title';
            let panelContentId = 'tiered-drawer-hourly-details-content';

            if (currentActiveView) {
                if (currentActiveView.id === 'tiered-drawer-table-view') {
                    // Ë°®Ê†ºËßÜÂõæ‰ΩøÁî®Ë°®Ê†ºÁâπÂÆöÁöÑÈù¢ÊùøID
                    const hourlyPanel = document.getElementById(panelId);
                    if (hourlyPanel) {
                        hourlyPanel.style.display = 'block';
                    }
                } else if (currentActiveView.id === 'tiered-drawer-calendar-view') {
                    // Êó•ÂéÜËßÜÂõæ‰ºöÂä®ÊÄÅÂàõÂª∫Èù¢ÊùøÔºå‰∏çÈúÄË¶ÅÂú®ËøôÈáåÂ§ÑÁêÜ
                    return;
                }
            }

            // Êõ¥Êñ∞Ê†áÈ¢ò
            const dateTitle = document.getElementById(titleId);
            if (dateTitle) {
                dateTitle.setAttribute('data-zh', `${year}Âπ¥${monthNames[parseInt(month) - 1]}${day}Êó• ‚Äî ÊØèÂ∞èÊó∂ÊòéÁªÜ`);
                dateTitle.setAttribute('data-en', `${monthNames[parseInt(month) - 1]} ${day}, ${year} ‚Äî Hourly Details`);
                dateTitle.textContent = `${year}Âπ¥${monthNames[parseInt(month) - 1]}${day}Êó• ‚Äî ÊØèÂ∞èÊó∂ÊòéÁªÜ`;
            }

            // Á≠âÂæÖDOMÊõ¥Êñ∞ÂêéÁîüÊàêÊØèÂ∞èÊó∂Êï∞ÊçÆ
            setTimeout(() => {
                console.log('Calling generateTieredDrawerHourlyData for day:', parseInt(day));
                generateTieredDrawerHourlyData(parseInt(day), panelContentId);
            }, 100);
        }

        // ÂÖ≥Èó≠Èò∂Ê¢ØÁîµ‰ª∑ÈÄöÁî®ËØ¶ÊÉÖÈù¢Êùø
        function closeTieredDrawerHourlyDetails() {
            // Êî∂Áº©ÊäΩÂ±â
            const drawer = document.querySelector('.right-drawer');
            drawer.classList.remove('expanded');

            // ÈöêËóèËØ¶ÊÉÖÈù¢Êùø
            const hourlyPanel = document.getElementById('tiered-drawer-hourly-details-panel');
            if (hourlyPanel) {
                hourlyPanel.style.display = 'none';
            }

            // Ê∏ÖÈô§ÈÄâ‰∏≠Áä∂ÊÄÅ
            document.querySelectorAll('.drawer-calendar-day.selected').forEach(day => {
                day.classList.remove('selected');
            });
            document.querySelectorAll('.drawer-daily-table-row.selected').forEach(row => {
                row.classList.remove('selected');
            });
        }

        // ÂÖ≥Èó≠Èò∂Ê¢ØÁîµ‰ª∑Êó•ÂéÜËØ¶ÊÉÖÈù¢Êùø
        function closeTieredCalendarHourlyDetails() {
            // Êî∂Áº©ÊäΩÂ±â
            const drawer = document.querySelector('.right-drawer');
            drawer.classList.remove('expanded');

            // ÁßªÈô§ËØ¶ÊÉÖÈù¢Êùø
            const detailsPanel = document.getElementById('tiered-calendar-hourly-details-panel');
            if (detailsPanel) {
                detailsPanel.remove();
            }

            // Ê∏ÖÈô§ÈÄâ‰∏≠Áä∂ÊÄÅ
            document.querySelectorAll('.drawer-calendar-day.selected').forEach(day => {
                day.classList.remove('selected');
            });
        }

        // ÁîüÊàêÈò∂Ê¢ØÁîµ‰ª∑ÊØèÂ∞èÊó∂Êï∞ÊçÆ - ÂÆåÂÖ®Â§çÂà∂ÂàÜÊó∂Áîµ‰ª∑ÁöÑÈÄªËæë
        function generateTieredDrawerHourlyData(day, contentId = 'tiered-drawer-hourly-details-content', retryCount = 0) {
            console.log('generateTieredDrawerHourlyData called with day:', day, 'contentId:', contentId, 'retry:', retryCount);
            const hourlyContent = document.getElementById(contentId);
            console.log('hourlyContent element:', hourlyContent);

            if (!hourlyContent) {
                console.error('hourlyContent element not found!');
                if (retryCount < 3) {
                    console.log('Retrying in 200ms...');
                    setTimeout(() => {
                        generateTieredDrawerHourlyData(day, contentId, retryCount + 1);
                    }, 200);
                }
                return;
            }

            // Ëé∑ÂèñËØ•Â§©ÁöÑÊï∞ÊçÆ
            const dayData = window.currentTieredData?.find(d => d.day === day);
            if (!dayData) {
                console.error('Day data not found for:', day);
                return;
            }

            const dailyUsage = parseFloat(dayData.usage);
            const tier = dayData.tier;

            // Èò∂Ê¢ØÁîµ‰ª∑Ë¥πÁéá
            const tierRates = {
                1: { rate: 3.35, name: currentLanguage === 'zh' ? 'Á¨¨‰∏ÄÈò∂Ê¢Ø' : 'Tier 1' },
                2: { rate: 4.60, name: currentLanguage === 'zh' ? 'Á¨¨‰∫åÈò∂Ê¢Ø' : 'Tier 2' },
                3: { rate: 6.85, name: currentLanguage === 'zh' ? 'Á¨¨‰∏âÈò∂Ê¢Ø' : 'Tier 3' },
                4: { rate: 8.50, name: currentLanguage === 'zh' ? 'Á¨¨ÂõõÈò∂Ê¢Ø' : 'Tier 4' }
            };

            // ÁîüÊàêÁÆÄÂçïÁöÑ24Â∞èÊó∂Êï∞ÊçÆË°®Ê†ºÔºåÊòæÁ§∫Êó∂Èó¥„ÄÅÁîµÈáè„ÄÅÁ¥ØËÆ°‰∏âÂàó
            let hourlyHTML = `
                <table class="simple-hourly-table">
                    <tr>
                        <th>${currentLanguage === 'zh' ? 'Êó∂Èó¥' : 'Time'}</th>
                        <th>${currentLanguage === 'zh' ? 'ÁîµÈáè' : 'Usage'}</th>
                        <th>${currentLanguage === 'zh' ? 'Á¥ØËÆ°' : 'Cumulative'}</th>
                    </tr>
            `;

            // ÂÖàÁîüÊàêÊâÄÊúâÂ∞èÊó∂ÁöÑÊï∞ÊçÆ
            let allHours = [];
            let cumulativeUsage = 0; // ÂΩìÊó•Á¥ØËÆ°Áî®ÁîµÈáè

            for (let hour = 0; hour < 24; hour++) {
                // Ê®°ÊãüÁî®ÁîµÈáè - Âü∫‰∫éËØ•Â§©ÊÄªÁî®ÈáèÂàÜÈÖçÂà∞24Â∞èÊó∂
                const baseUsage = dailyUsage / 24 + Math.sin((hour + day) * 0.3) * (dailyUsage / 48) + Math.random() * (dailyUsage / 48);
                const usage = Math.max(0.1, baseUsage);
                cumulativeUsage += usage; // Á¥ØÂä†ÂΩìÊó•Áî®ÁîµÈáè

                allHours.push({
                    hour: hour,
                    timeStr: `${hour.toString().padStart(2, '0')}:00`,
                    usage: usage,
                    cumulative: cumulativeUsage
                });
            }

            // ÁîüÊàêË°®Ê†ºË°å
            for (let i = 0; i < allHours.length; i++) {
                const hourData = allHours[i];

                hourlyHTML += `
                    <tr>
                        <td>${hourData.timeStr}</td>
                        <td>${hourData.usage.toFixed(2)} kWh</td>
                        <td>${hourData.cumulative.toFixed(2)} kWh</td>
                    </tr>
                `;
            }

            hourlyHTML += `</table>`;

            console.log('Setting hourlyHTML:', hourlyHTML);
            hourlyContent.innerHTML = hourlyHTML;
            console.log('Content set, element innerHTML length:', hourlyContent.innerHTML.length);
        }

        // ÂØºÂá∫Èò∂Ê¢ØÁîµ‰ª∑ÊäΩÂ±âÊï∞ÊçÆ
        function exportTieredDrawerData() {
            console.log('exportTieredDrawerData called');

            const data = window.currentTieredData || [];
            if (data.length === 0) {
                EnergySystem.showNotification('Ê≤°ÊúâÂèØÂØºÂá∫ÁöÑÊï∞ÊçÆ', 'warning');
                return;
            }

            // ÂàõÂª∫CSVÂÜÖÂÆπ
            const headers = ['Êó•Êúü', 'Êó•Áî®ÁîµÈáè(kWh)', 'Á¥ØËÆ°Áî®ÁîµÈáè(kWh)', 'ÊâÄÂ±ûÈò∂Ê¢Ø'];
            let csvContent = headers.join(',') + '\n';

            data.forEach(row => {
                const csvRow = [
                    row.date,
                    row.usage,
                    row.cumulative,
                    `Á¨¨${row.tier}Èò∂Ê¢Ø`
                ].join(',');
                csvContent += csvRow + '\n';
            });

            // ÂàõÂª∫Âπ∂‰∏ãËΩΩÊñá‰ª∂
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'ÁîµÈáèË¥πÊòéÁªÜ_2025Âπ¥9Êúà.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            EnergySystem.showNotification('Êï∞ÊçÆÂØºÂá∫ÊàêÂäü', 'success');
        }

        // Èò∂Ê¢ØÁîµ‰ª∑Ë°®Ê†ºË°åÈ´ò‰∫ÆÂáΩÊï∞
        function highlightSelectedDateInTieredTable(dateStr) {
            console.log('Highlighting date in tiered table:', dateStr);

            // Á°Æ‰øùË°®Ê†ºË°åÂ∑≤ÁªèË¢´ÈÄâ‰∏≠ÔºàËøôÂ∫îËØ•Â∑≤ÁªèÂú®showTieredDayDetails‰∏≠ÂÆåÊàê‰∫ÜÔºâ
            const selectedRow = document.querySelector(`.tiered-drawer-daily-table-row[data-date="${dateStr}"]`);
            if (selectedRow) {
                selectedRow.classList.add('selected');
                console.log('Tiered table row highlighted:', selectedRow);

                // ÊªöÂä®Âà∞ÈÄâ‰∏≠ÁöÑË°åÔºàÂ¶ÇÊûúË°®Ê†ºÂæàÈïøÁöÑËØùÔºâ
                selectedRow.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });
            } else {
                console.warn('Tiered table row not found for date:', dateStr);
            }
        }

        // ÁîüÊàêÈò∂Ê¢ØÁîµ‰ª∑ÊäΩÂ±âË°®Ê†ºËßÜÂõæÊï∞ÊçÆ
        function generateTieredDrawerTableData(day) {
            console.log('generateTieredDrawerTableData called with day:', day);
            const tableBody = document.getElementById('tiered-drawer-table-body');

            if (!tableBody) {
                console.error('tiered-drawer-table-body element not found!');
                return;
            }

            // Ëé∑ÂèñËØ•Â§©ÁöÑÊï∞ÊçÆ
            const dayData = window.currentTieredData?.find(d => d.day === day);
            if (!dayData) {
                console.error('Day data not found for:', day);
                return;
            }

            // ÁîüÊàêË°®Ê†ºHTML
            let tableHTML = `
                <div class="tiered-drawer-daily-table-row selected-day-row" onclick="toggleTieredDrawerDayDetails(${day})">
                    <span class="expand-icon" id="tiered-expand-icon-${day}">‚ñº</span>
                    <span>${dayData.date}</span>
                    <span>${dayData.usage} kWh</span>
                    <span>‚Çπ${dayData.amount}</span>
                </div>
                <div class="tiered-drawer-hourly-details-row expanded" id="tiered-drawer-hourly-details-${day}">
                    <div class="tiered-drawer-hourly-grid" id="tiered-drawer-hourly-grid-${day}">
                        <!-- ÊØèÂ∞èÊó∂Êï∞ÊçÆÂ∞ÜÂú®ËøôÈáåÁîüÊàê -->
                    </div>
                </div>
            `;

            tableBody.innerHTML = tableHTML;

            // Á´ãÂç≥ÁîüÊàêÈÄâ‰∏≠Êó•ÊúüÁöÑÊØèÂ∞èÊó∂ËØ¶ÊÉÖ
            setTimeout(() => {
                generateTieredDrawerHourlyData(day, `tiered-drawer-hourly-grid-${day}`);
            }, 100);
        }

        // Èò∂Ê¢ØÁîµ‰ª∑ÂàáÊç¢Êó•ËØ¶ÊÉÖÂ±ïÂºÄ/Êî∂Ëµ∑
        function toggleTieredDrawerDayDetails(day) {
            console.log('Èò∂Ê¢ØÁîµ‰ª∑ÁÇπÂáªÂ±ïÂºÄÊó•Êúü:', day);
            const detailsRow = document.getElementById(`tiered-drawer-hourly-details-${day}`);
            const expandIcon = document.getElementById(`tiered-expand-icon-${day}`);

            console.log('Èò∂Ê¢ØËØ¶ÊÉÖË°å:', detailsRow);
            console.log('Èò∂Ê¢ØÂ±ïÂºÄÂõæÊ†á:', expandIcon);

            if (!detailsRow || !expandIcon) {
                console.error('Êú™ÊâæÂà∞Èò∂Ê¢ØÁõ∏ÂÖ≥ÂÖÉÁ¥†');
                return;
            }

            if (detailsRow.style.display === 'none' || detailsRow.style.display === '') {
                // ÂÖ≥Èó≠ÂÖ∂‰ªñÂ∑≤ÊâìÂºÄÁöÑËØ¶ÊÉÖ
                document.querySelectorAll('.tiered-drawer-hourly-details-row').forEach(row => {
                    row.style.display = 'none';
                });
                document.querySelectorAll('.tiered-drawer-expand-icon').forEach(icon => {
                    icon.textContent = '‚ñ∂';
                    icon.style.transform = 'rotate(0deg)';
                });

                // ÊâìÂºÄÂΩìÂâçËØ¶ÊÉÖ
                detailsRow.style.display = 'block';
                expandIcon.textContent = '‚ñº';
                expandIcon.style.transform = 'rotate(0deg)';

                // ÁîüÊàêÊØèÂ∞èÊó∂Êï∞ÊçÆ
                generateTieredDrawerHourlyDataOld(day);
            } else {
                // ÂÖ≥Èó≠ÂΩìÂâçËØ¶ÊÉÖ
                detailsRow.style.display = 'none';
                expandIcon.textContent = '‚ñ∂';
                expandIcon.style.transform = 'rotate(0deg)';
            }
        }

        // ÁîüÊàêÈò∂Ê¢ØÁîµ‰ª∑ÊäΩÂ±â‰∏≠ÁöÑÊØèÂ∞èÊó∂Áî®ÁîµÊï∞ÊçÆÔºàÊóßË°®Ê†ºÂ±ïÂºÄÂäüËÉΩÔºâ
        function generateTieredDrawerHourlyDataOld(day) {
            const hourlyBody = document.getElementById(`tiered-drawer-hourly-body-${day}`);

            // Ëé∑ÂèñËØ•Â§©ÁöÑÊï∞ÊçÆ
            const dayData = window.currentTieredData?.find(d => d.day === day);
            if (!dayData) {
                console.error('Day data not found for:', day);
                return;
            }

            const dailyUsage = parseFloat(dayData.usage);
            const tier = dayData.tier;

            // Èò∂Ê¢ØÁîµ‰ª∑Ë¥πÁéá
            const tierRates = {
                1: { rate: 3.35, name: currentLanguage === 'zh' ? 'Á¨¨‰∏ÄÈò∂Ê¢Ø' : 'Tier 1' },
                2: { rate: 4.60, name: currentLanguage === 'zh' ? 'Á¨¨‰∫åÈò∂Ê¢Ø' : 'Tier 2' },
                3: { rate: 6.85, name: currentLanguage === 'zh' ? 'Á¨¨‰∏âÈò∂Ê¢Ø' : 'Tier 3' },
                4: { rate: 8.50, name: currentLanguage === 'zh' ? 'Á¨¨ÂõõÈò∂Ê¢Ø' : 'Tier 4' }
            };

            const tierInfo = tierRates[tier];
            const tierName = tierInfo.name;
            const rate = tierInfo.rate;

            // ÁîüÊàê24Â∞èÊó∂Êï∞ÊçÆÔºåÊòæÁ§∫Êó∂Èó¥„ÄÅÁîµÈáè„ÄÅÁ¥ØËÆ°‰∏âÂàó
            let hourlyHTML = '';
            let cumulativeUsage = 0; // ÂΩìÊó•Á¥ØËÆ°Áî®ÁîµÈáè

            for (let hour = 0; hour < 24; hour++) {
                // Ê®°ÊãüÁî®ÁîµÈáè - Âü∫‰∫éËØ•Â§©ÊÄªÁî®ÈáèÂàÜÈÖçÂà∞24Â∞èÊó∂
                const baseUsage = dailyUsage / 24 + Math.sin((hour + day) * 0.3) * (dailyUsage / 48) + Math.random() * (dailyUsage / 48);
                const usage = Math.max(0.1, baseUsage);
                cumulativeUsage += usage; // Á¥ØÂä†ÂΩìÊó•Áî®ÁîµÈáè

                hourlyHTML += `
                    <div class="tiered-drawer-hourly-row">
                        <span class="tiered-drawer-hour-time">${hour.toString().padStart(2, '0')}:00</span>
                        <span class="tiered-drawer-hour-usage">${usage.toFixed(2)} kWh</span>
                        <span class="tiered-drawer-hour-cumulative">${cumulativeUsage.toFixed(2)} kWh</span>
                    </div>
                `;
            }

            hourlyBody.innerHTML = hourlyHTML;
        }

        // Â§çÂà∂Èò∂Ê¢ØÁîµ‰ª∑Êï∞ÊçÆÂà∞ÊäΩÂ±âË°®Ê†º
        function copyTieredPricingToDrawerTable() {
            console.log('copyTieredPricingToDrawerTable called');
            const drawerTableBody = document.getElementById('tiered-drawer-table-body');
            console.log('tieredDrawerTableBody:', drawerTableBody);
            console.log('window.currentTieredData:', window.currentTieredData);

            if (!drawerTableBody) {
                console.error('tiered-drawer-table-body not found!');
                return;
            }

            // Â¶ÇÊûúÊ≤°ÊúâÊï∞ÊçÆÔºåÁîüÊàêÊ®°ÊãüÊï∞ÊçÆ - Á°Æ‰øùÁîüÊàê2025Âπ¥9ÊúàÁöÑÊâÄÊúâ30Â§©
            let tieredData = window.currentTieredData;
            if (!tieredData || tieredData.length === 0) {
                console.log('Generating mock tiered data...');
                tieredData = [];
                const daysInSeptember = new Date(2025, 9, 0).getDate(); // 2025Âπ¥9ÊúàÁöÑÂ§©Êï∞ (30Â§©)
                let cumulativeUsage = 0;
                for (let day = 1; day <= daysInSeptember; day++) {
                    const usage = 15 + Math.sin(day * 0.3) * 8 + Math.random() * 6;
                    cumulativeUsage += usage;
                    let tier = 1;
                    if (cumulativeUsage > 300) tier = 4;
                    else if (cumulativeUsage > 200) tier = 3;
                    else if (cumulativeUsage > 100) tier = 2;

                    const tierRates = { 1: 3.35, 2: 4.60, 3: 6.85, 4: 8.50 };
                    const cost = usage * tierRates[tier];

                    tieredData.push({
                        day: day,
                        date: `2025-09-${day.toString().padStart(2, '0')}`,
                        usage: usage.toFixed(2),
                        cumulative: cumulativeUsage.toFixed(2),
                        tier: tier,
                        amount: cost.toFixed(2)
                    });
                }
                window.currentTieredData = tieredData;
                console.log('Generated tiered data for', daysInSeptember, 'days');
            }

            // ÁîüÊàêË°®Ê†ºË°åÔºåÁÇπÂáªÂêéÂú®Âè≥‰æßÊòæÁ§∫ËØ¶ÊÉÖÈù¢ÊùøÔºà‰∏çÊòØ‰∏ãÊñπÂ±ïÂºÄÔºâ
            drawerTableBody.innerHTML = '';
            console.log('Tiered data length:', tieredData.length);

            // ÊòæÁ§∫ÊâÄÊúâ30Â§©ÁöÑÊï∞ÊçÆÔºåÈÄöËøáÊªöÂä®Êü•Áúã
            tieredData.forEach(dayData => {
                console.log('Processing tiered day:', dayData);
                // ÂàõÂª∫‰∏ªË°å
                const newRow = document.createElement('div');
                newRow.className = 'drawer-daily-table-row';
                newRow.style.cursor = 'pointer';
                newRow.setAttribute('data-date', dayData.date);

                // ‰ΩøÁî®tieredDataÁîüÊàêË°åÊï∞ÊçÆ - ÂØπÂ∫îË°®Ê†ºÂ§¥ÈÉ®ÁöÑ4Âàó
                newRow.innerHTML = `
                        <span class="drawer-date-cell">${dayData.date}</span>
                        <span class="drawer-usage-cell">${parseFloat(dayData.usage).toFixed(1)} kWh</span>
                        <span class="drawer-cumulative-cell">${parseFloat(dayData.cumulative).toFixed(1)} kWh</span>
                        <span class="drawer-tier-cell">${currentLanguage === 'zh' ? `Á¨¨${dayData.tier}Èò∂Ê¢Ø` : `Tier ${dayData.tier}`}</span>
                        <span class="drawer-expand-icon">‚ñ∂</span>
                `;

                // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂ - ÁÇπÂáªÂêéÂú®Âè≥‰æßÊòæÁ§∫ËØ¶ÊÉÖÈù¢Êùø
                newRow.addEventListener('click', function() {
                    console.log('Tiered table row clicked, date:', dayData.date);
                    // ‰ΩøÁî®Èò∂Ê¢ØÁîµ‰ª∑‰∏ìÈó®ÁöÑË°®Ê†ºË°åÂ§ÑÁêÜÂáΩÊï∞
                    showTieredTableRowDetails(dayData.date, dayData.day);
                });

                drawerTableBody.appendChild(newRow);
            });

            console.log('Tiered table rows generated:', tieredData.length);
        }

        // Èò∂Ê¢ØÁîµ‰ª∑ÁâàÊú¨ÁöÑÈÄöÁî®Êó•ËØ¶ÊÉÖÊòæÁ§∫ÂáΩÊï∞
        function showTieredDayDetails(dateStr, dayNumber) {
            console.log('showTieredDayDetails called:', dateStr, dayNumber);

            // Ëß£ÊûêÊó•Êúü
            const [year, month, day] = dateStr.split('-');
            const monthNames = getMonthNames();

            // Ê£ÄÊü•ÊòØÂê¶ÊòØË¥¶ÂçïÊúà‰ªΩÔºà2025Âπ¥9ÊúàÔºâ
            if (parseInt(year) !== 2025 || parseInt(month) !== 9) {
                return; // ÈùûË¥¶ÂçïÊúà‰ªΩ‰∏çÊòæÁ§∫ËØ¶ÊÉÖ
            }

            // Ê∏ÖÈô§ÊâÄÊúâÈÄâ‰∏≠Áä∂ÊÄÅ
            document.querySelectorAll('.drawer-calendar-day').forEach(dayEl => {
                dayEl.classList.remove('selected');
            });
            document.querySelectorAll('.drawer-daily-table-row').forEach(rowEl => {
                rowEl.classList.remove('selected');
            });
            document.querySelectorAll('.tiered-drawer-daily-table-row').forEach(rowEl => {
                rowEl.classList.remove('selected');
            });

            // Êü•ÊâæË¢´ÁÇπÂáªÁöÑÂÖÉÁ¥†
            const clickedDay = document.querySelector(`[data-date="${dateStr}"]`);
            const isAlreadySelected = clickedDay && clickedDay.classList.contains('selected');

            if (isAlreadySelected) {
                // Â¶ÇÊûúÂ∑≤ÁªèÈÄâ‰∏≠ÔºåÂàôÂèñÊ∂àÈÄâÊã©Âπ∂Êî∂Ëµ∑
                closeTieredDrawerHourlyDetails();
            } else {
                // ÈÄâ‰∏≠ÂΩìÂâçÁÇπÂáªÁöÑÂÖÉÁ¥†ÔºàÂèØËÉΩÊòØÊó•ÂéÜÊó•ÊúüÊàñË°®Ê†ºË°åÔºâ
                if (clickedDay) {
                    clickedDay.classList.add('selected');
                }

                // Êâ©Â±ïÊäΩÂ±â
                const drawer = document.querySelector('.right-drawer');
                drawer.classList.add('expanded');
                console.log('Tiered drawer expanded:', drawer);

                // ‰ΩøÁî®Èò∂Ê¢ØÁîµ‰ª∑‰∏ìÁî®ÁöÑËØ¶ÊÉÖÈù¢Êùø
                let hourlyPanel = document.getElementById('tiered-drawer-hourly-details-panel');
                let panelContentId = 'tiered-drawer-hourly-details-content';
                let titleId = 'tiered-drawer-selected-date-title';

                if (hourlyPanel) {
                    hourlyPanel.style.display = 'block';
                    console.log('Tiered hourly panel displayed:', hourlyPanel);
                } else {
                    console.error('Tiered hourly panel not found!');
                }

                // ‰øùÊåÅÁî®Êà∑ÂΩìÂâçÈÄâÊã©ÁöÑËßÜÂõæÔºå‰∏çÂº∫Âà∂Ë∑≥ËΩ¨
                // Ê£ÄÊü•ÂΩìÂâçÊøÄÊ¥ªÁöÑËßÜÂõæ
                const currentActiveView = document.querySelector('.drawer-usage-view.active');
                let currentViewType = 'chart'; // ÈªòËÆ§ÂõæË°®ËßÜÂõæ

                console.log('Current active view:', currentActiveView);

                if (currentActiveView) {
                    if (currentActiveView.id === 'tiered-drawer-chart-view') {
                        currentViewType = 'chart';
                    } else if (currentActiveView.id === 'tiered-drawer-calendar-view') {
                        currentViewType = 'calendar';
                    } else if (currentActiveView.id === 'tiered-drawer-table-view') {
                        currentViewType = 'table';
                    }
                }

                console.log('Determined view type:', currentViewType);

                // ÊøÄÊ¥ªÂΩìÂâçËßÜÂõæÔºàÂ¶ÇÊûúÊòØÊó•ÂéÜËßÜÂõæÔºå‰ºöËá™Âä®ËÆæÁΩÆ‰∏∫Â∑¶Âè≥Â∏ÉÂ±ÄÔºâ
                switchTieredDrawerView(currentViewType);

                // Êõ¥Êñ∞Ê†áÈ¢ò
                const dateTitle = document.getElementById(titleId);
                if (dateTitle) {
                    dateTitle.setAttribute('data-zh', `${year}Âπ¥${monthNames[parseInt(month) - 1]}${day}Êó• ‚Äî ÊØèÂ∞èÊó∂ÊòéÁªÜ`);
                    dateTitle.setAttribute('data-en', `${monthNames[parseInt(month) - 1]} ${day}, ${year} ‚Äî Hourly Details`);
                    dateTitle.textContent = currentLanguage === 'zh' ?
                        `${year}Âπ¥${monthNames[parseInt(month) - 1]}${day}Êó• ‚Äî ÊØèÂ∞èÊó∂ÊòéÁªÜ` :
                        `${monthNames[parseInt(month) - 1]} ${day}, ${year} ‚Äî Hourly Details`;
                }

                // Á≠âÂæÖDOMÊõ¥Êñ∞ÂêéÁîüÊàêÊØèÂ∞èÊó∂Êï∞ÊçÆ
                setTimeout(() => {
                    console.log('Calling generateTieredDrawerHourlyData for day:', parseInt(day));
                    generateTieredDrawerHourlyData(parseInt(day), panelContentId);

                    // Â¶ÇÊûúÂΩìÂâçÂú®Ë°®Ê†ºËßÜÂõæÔºåÁ°Æ‰øùÈÄâ‰∏≠Êó•ÊúüÁöÑË°åË¢´Ê≠£Á°ÆÊ†áËÆ∞ÂíåÂ±ïÂºÄ
                    if (currentViewType === 'table') {
                        highlightSelectedDateInTieredTable(dateStr);
                    }
                }, 500);
            }
        }

        // Èò∂Ê¢ØÁîµ‰ª∑Ë°®Ê†ºË°å‰∏ìÁî®ÁöÑËØ¶ÊÉÖÂ±ïÂºÄÂáΩÊï∞
        function showTieredTableRowDetails(dateStr, dayNumber) {
            console.log('showTieredTableRowDetails called:', dateStr, dayNumber);

            // Ëß£ÊûêÊó•Êúü
            const [year, month, day] = dateStr.split('-');
            const monthNames = getMonthNames();

            // Ê£ÄÊü•ÊòØÂê¶ÊòØË¥¶ÂçïÊúà‰ªΩÔºà2025Âπ¥9ÊúàÔºâ
            if (parseInt(year) !== 2025 || parseInt(month) !== 9) {
                return; // ÈùûË¥¶ÂçïÊúà‰ªΩ‰∏çÊòæÁ§∫ËØ¶ÊÉÖ
            }

            // Êü•ÊâæË¢´ÁÇπÂáªÁöÑË°®Ê†ºË°å
            const clickedRow = document.querySelector(`[data-date="${dateStr}"]`);
            const isAlreadySelected = clickedRow && clickedRow.classList.contains('selected');

            if (isAlreadySelected) {
                // Â¶ÇÊûúÂ∑≤ÁªèÈÄâ‰∏≠ÔºåÂàôÂèñÊ∂àÈÄâÊã©Âπ∂Êî∂Ëµ∑
                closeTieredDrawerHourlyDetails();
            } else {
                // Ê∏ÖÈô§ÊâÄÊúâÈÄâ‰∏≠Áä∂ÊÄÅ
                document.querySelectorAll('.drawer-calendar-day').forEach(dayEl => {
                    dayEl.classList.remove('selected');
                });
                document.querySelectorAll('.drawer-daily-table-row').forEach(rowEl => {
                    rowEl.classList.remove('selected');
                });

                // ÈÄâ‰∏≠ÂΩìÂâçÁÇπÂáªÁöÑË°®Ê†ºË°å
                if (clickedRow) {
                    clickedRow.classList.add('selected');
                }

                // Êâ©Â±ïÊäΩÂ±â
                const drawer = document.querySelector('.right-drawer');
                drawer.classList.add('expanded');

                // ÊòæÁ§∫ÊØèÂ∞èÊó∂ËØ¶ÊÉÖÈù¢Êùø
                const hourlyPanel = document.getElementById('tiered-drawer-hourly-details-panel');
                hourlyPanel.style.display = 'block';

                // CSSËßÑÂàô‰ºöËá™Âä®Â§ÑÁêÜÂ±ïÂºÄÁä∂ÊÄÅÁöÑflexÂ∏ÉÂ±Ä
                console.log('Tiered drawer expanded, CSS will handle flex layout');

                // Êõ¥Êñ∞ËØ¶ÊÉÖÈù¢ÊùøÊ†áÈ¢ò
                const dateTitle = document.getElementById('tiered-drawer-selected-date-title');
                if (dateTitle) {
                    dateTitle.setAttribute('data-zh', `${year}Âπ¥${monthNames[parseInt(month) - 1]}${day}Êó• ‚Äî ÊØèÂ∞èÊó∂ÊòéÁªÜ`);
                    dateTitle.setAttribute('data-en', `${monthNames[parseInt(month) - 1]} ${day}, ${year} ‚Äî Hourly Details`);
                    dateTitle.textContent = currentLanguage === 'zh' ?
                        `${year}Âπ¥${monthNames[parseInt(month) - 1]}${day}Êó• ‚Äî ÊØèÂ∞èÊó∂ÊòéÁªÜ` :
                        `${monthNames[parseInt(month) - 1]} ${day}, ${year} ‚Äî Hourly Details`;
                }

                // Á≠âÂæÖDOMÊõ¥Êñ∞ÂêéÁîüÊàêÊØèÂ∞èÊó∂Êï∞ÊçÆ
                setTimeout(() => {
                    console.log('Calling generateTieredDrawerHourlyData for table row, day:', parseInt(day));
                    generateTieredDrawerHourlyData(parseInt(day), 'tiered-drawer-hourly-details-content');

                    // Á°Æ‰øùÈÄâ‰∏≠Êó•ÊúüÁöÑË°åË¢´Ê≠£Á°ÆÊ†áËÆ∞ÂíåÂ±ïÂºÄ
                    highlightSelectedDateInTieredTable(dateStr);
                }, 100);
            }
        }

        // Â§çÂà∂Êï∞ÊçÆÂà∞ÊäΩÂ±â
        function copyTimeOfUsePricingToDrawer() {
            // Áõ¥Êé•ÁîüÊàêË°®Ê†ºÊï∞ÊçÆÔºåÂõ†‰∏∫daily-usage-moduleÂ∑≤Ë¢´Âà†Èô§
            console.log('copyTimeOfUsePricingToDrawer called');
            const drawerTableBody = document.getElementById('drawer-table-body');
            console.log('drawerTableBody:', drawerTableBody);
            console.log('window.currentDailyData:', window.currentDailyData);

            if (!drawerTableBody) {
                console.error('drawer-table-body not found!');
                return;
            }

            // Â¶ÇÊûúÊ≤°ÊúâÊï∞ÊçÆÔºåÁîüÊàêÊ®°ÊãüÊï∞ÊçÆ - Á°Æ‰øùÁîüÊàê2025Âπ¥9ÊúàÁöÑÊâÄÊúâ30Â§©
            let dailyData = window.currentDailyData;
            if (!dailyData || dailyData.length === 0) {
                console.log('Generating mock daily data...');
                dailyData = [];
                const daysInSeptember = new Date(2025, 9, 0).getDate(); // 2025Âπ¥9ÊúàÁöÑÂ§©Êï∞ (30Â§©)
                for (let day = 1; day <= daysInSeptember; day++) {
                    const usage = 15 + Math.sin(day * 0.3) * 8 + Math.random() * 6;
                    const cost = usage * 4.5;
                    dailyData.push({
                        day: day,
                        date: `2025-09-${day.toString().padStart(2, '0')}`,
                        usage: usage.toFixed(2),
                        cost: cost.toFixed(2)
                    });
                }
                window.currentDailyData = dailyData;
                console.log('Generated data for', daysInSeptember, 'days');
            }

            // ÁîüÊàêË°®Ê†ºË°åÔºåÂπ∂Ê∑ªÂä†ÊäΩÂ±âÁâπÊúâÁöÑÂ±ïÂºÄÂäüËÉΩ
            drawerTableBody.innerHTML = '';
            console.log('Daily data length:', dailyData.length);
            let dayCounter = 1;

            dailyData.forEach(dayData => {
                console.log('Processing day:', dayData);
                // ÂàõÂª∫‰∏ªË°å
                const newRow = document.createElement('div');
                newRow.className = 'drawer-daily-table-row';
                newRow.style.cursor = 'pointer';
                newRow.setAttribute('data-date', dayData.date);

                // ‰ΩøÁî®dailyDataÁîüÊàêË°åÊï∞ÊçÆ
                newRow.innerHTML = `
                        <span class="drawer-date-cell">${dayData.date}</span>
                        <span class="drawer-usage-cell">${parseFloat(dayData.usage).toFixed(1)} kWh</span>
                        <span class="drawer-cost-cell">‚Çπ${parseFloat(dayData.cost).toFixed(2)}</span>
                        <span class="drawer-expand-icon" id="drawer-expand-icon-${dayCounter}">‚ñ∂</span>
                `;

                // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂ - ‰ΩøÁî®Á´ãÂç≥ÊâßË°åÂáΩÊï∞ÊçïËé∑dayCounterÂÄº
                (function(currentDay, currentDate) {
                    newRow.addEventListener('click', function() {
                        console.log('Table row clicked, day:', currentDay, 'date:', currentDate);
                        // ‰ΩøÁî®‰∏ìÈó®ÁöÑË°®Ê†ºË°åÂ±ïÂºÄÈÄªËæëÔºå‰∏çÂàáÊç¢ËßÜÂõæ
                        showTableRowDetails(currentDate, currentDay);
                    });
                })(dayCounter, dayData.date);

                // ÂàõÂª∫Â±ïÂºÄËØ¶ÊÉÖË°å
                const detailsRow = document.createElement('div');
                detailsRow.className = 'drawer-hourly-details-row';
                detailsRow.id = `drawer-hourly-details-${dayCounter}`;
                detailsRow.style.display = 'none';
                detailsRow.innerHTML = `
                        <div class="drawer-hourly-content">
                            <div class="drawer-hourly-table">
                                <div class="drawer-hourly-table-header">
                                    <span data-zh="Êó∂Èó¥" data-en="Time">Êó∂Èó¥</span>
                                    <span data-zh="Êó∂ÊÆµ" data-en="Period">Êó∂ÊÆµ</span>
                                    <span data-zh="Áî®ÁîµÈáè" data-en="Usage">Áî®ÁîµÈáè</span>
                                    <span data-zh="Âçï‰ª∑" data-en="Rate">Âçï‰ª∑</span>
                                    <span data-zh="ÈáëÈ¢ù" data-en="Amount">ÈáëÈ¢ù</span>
                                </div>
                                <div class="drawer-hourly-table-body" id="drawer-hourly-body-${dayCounter}">
                                    <!-- ÊØèÂ∞èÊó∂Êï∞ÊçÆÁî±JavaScriptÁîüÊàê -->
                                </div>
                            </div>
                        </div>
                `;

                drawerTableBody.appendChild(newRow);
                drawerTableBody.appendChild(detailsRow);
                dayCounter++;
            });

            // Ë°®Ê†ºÊï∞ÊçÆÁîüÊàêÂÆåÊàêÔºå‰∏çÈúÄË¶ÅÁîüÊàêÂÖ∂‰ªñËßÜÂõæÁöÑÊï∞ÊçÆ
        }

        // ÊäΩÂ±âËßÜÂõæÂàáÊç¢ÂäüËÉΩ
        function switchDrawerView(viewType) {
            console.log('Switching to view:', viewType); // Ë∞ÉËØïÊó•Âøó

            // Ê£ÄÊü•ÊòØÂê¶ÊúâÈÄâ‰∏≠ÁöÑÊó•ÊúüÔºàÂ±ïÂºÄÁä∂ÊÄÅÔºâ
            const selectedCalendarDay = document.querySelector('.drawer-calendar-day.selected');
            const selectedTableRow = document.querySelector('.drawer-daily-table-row.selected');
            const isExpanded = selectedCalendarDay !== null || selectedTableRow !== null;

            // Ê£ÄÊü•ËØ¶ÊÉÖÈù¢ÊùøÊòØÂê¶ÂèØËßÅ
            const hourlyPanel = document.getElementById('drawer-hourly-details-panel');
            const isPanelVisible = hourlyPanel && hourlyPanel.style.display === 'block';

            // ËßÜÂõæÂàáÊç¢Êó∂ÁöÑÊ∏ÖÁêÜÂ∑•‰Ωú
            const drawer = document.querySelector('.right-drawer');

            if (viewType === 'calendar') {
                console.log('Calendar view selected - clearing selections but keeping drawer state');

                // ÈöêËóèË°®Ê†ºËØ¶ÊÉÖÈù¢Êùø
                if (hourlyPanel) hourlyPanel.style.display = 'none';

                // Ê∏ÖÈô§ÊâÄÊúâÈÄâ‰∏≠Áä∂ÊÄÅ
                document.querySelectorAll('.drawer-calendar-day.selected').forEach(day => {
                    day.classList.remove('selected');
                });
                document.querySelectorAll('.drawer-daily-table-row.selected').forEach(row => {
                    row.classList.remove('selected');
                });

                // Â¶ÇÊûúÂΩìÂâçÊúâÂ±ïÂºÄÁä∂ÊÄÅÔºåÊî∂Ëµ∑ÊäΩÂ±âÊÅ¢Â§çÁ™ÑÂÆΩÂ∫¶
                if (drawer.classList.contains('expanded')) {
                    drawer.classList.remove('expanded');
                    console.log('Calendar view selected - drawer collapsed to narrow width');
                }
            } else {
                // ÂàáÊç¢Âà∞ÈùûÊó•ÂéÜËßÜÂõæÊó∂ÔºåÊ∏ÖÁêÜÊó•ÂéÜËØ¶ÊÉÖÈù¢Êùø
                const calendarDetailsPanel = document.getElementById('calendar-hourly-details-panel');
                if (calendarDetailsPanel) {
                    calendarDetailsPanel.remove();
                }

                // ÈöêËóèË°®Ê†ºËØ¶ÊÉÖÈù¢Êùø
                if (hourlyPanel) hourlyPanel.style.display = 'none';

                // Ê∏ÖÈô§ÈÄâ‰∏≠Áä∂ÊÄÅ
                document.querySelectorAll('.drawer-calendar-day.selected').forEach(day => {
                    day.classList.remove('selected');
                });
                document.querySelectorAll('.drawer-daily-table-row.selected').forEach(row => {
                    row.classList.remove('selected');
                });

                // Êî∂Ëµ∑ÊäΩÂ±â
                if (drawer.classList.contains('expanded')) {
                    drawer.classList.remove('expanded');
                }
            }

            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            document.querySelectorAll('.drawer-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Êõ¥ÂÆâÂÖ®ÁöÑÊåâÈíÆÈÄâÊã©ÊñπÂºè
            const targetBtn = document.querySelector(`[onclick="switchDrawerView('${viewType}')"]`);
            if (targetBtn) {
                targetBtn.classList.add('active');
                console.log('Button activated:', targetBtn);
            } else {
                console.error('Button not found for viewType:', viewType);
            }

            // ÂàáÊç¢ËßÜÂõæ
            document.querySelectorAll('.drawer-usage-view').forEach(view => {
                view.classList.remove('active');
                view.style.display = 'none';
                console.log('Removed active from:', view.id);
            });

            const targetView = document.getElementById(`drawer-${viewType}-view`);
            if (targetView) {
                targetView.classList.add('active');
                console.log('Added active to:', targetView.id);

                // Ê∏ÖÈô§ÂÜÖËÅîÊ†∑ÂºèÔºåËÆ©CSSËßÑÂàôÊ†πÊçÆÂ±ïÂºÄÁä∂ÊÄÅËá™Âä®ÁîüÊïà
                targetView.style.display = '';
            } else {
                console.error('Target view not found:', `drawer-${viewType}-view`);
            }

            // Â¶ÇÊûúÂàáÊç¢Âà∞ÂõæË°®ËßÜÂõæÔºåÈáçÊñ∞Ê∏≤ÊüìÂõæË°®
            if (viewType === 'chart') {
                setTimeout(() => {
                    renderDrawerChart();
                }, 100);
            }

            // Â¶ÇÊûúÂàáÊç¢Âà∞Êó•ÂéÜËßÜÂõæÔºåÈáçÊñ∞ÁîüÊàêÊó•ÂéÜ
            if (viewType === 'calendar') {
                setTimeout(() => {
                    generateDrawerCalendar();
                }, 100);
            }
        }

        // EChartsÂõæË°®ÂÆû‰æã
        let chartInstance = null;
        let chartData = [];

        // Ê∏≤ÊüìEChartsÂõæË°®
        function renderDrawerChart() {
            const chartContainer = document.getElementById('drawer-usage-chart');
            if (!chartContainer) {
                console.log('Chart container not found');
                return;
            }

            console.log('=== ÂºÄÂßãÊ∏≤ÊüìEChartsÂõæË°® ===');
            console.log('Chart view visible:', document.getElementById('drawer-chart-view').style.display);
            console.log('Chart view has active class:', document.getElementById('drawer-chart-view').classList.contains('active'));

            // Â¶ÇÊûúÂ∑≤ÊúâÂõæË°®ÂÆû‰æãÔºåÂÖàÈîÄÊØÅ
            if (chartInstance) {
                chartInstance.dispose();
            }

            // ÂàùÂßãÂåñEChartsÂÆû‰æã
            chartInstance = echarts.init(chartContainer);

            console.log('Chart container dimensions:', chartContainer.offsetWidth, 'x', chartContainer.offsetHeight);

            // ÁîüÊàêÊú¨ÊúàÊï∞ÊçÆÔºà30Â§©Ôºâ
            const days = [];
            const usageData = [];
            const costData = [];

            for (let day = 1; day <= 30; day++) {
                // Ê®°ÊãüÊØèÊó•Áî®ÁîµÈáè (10-30kWh‰πãÈó¥ÁöÑÊ≥¢Âä®)
                const dailyUsage = 20 + Math.sin(day * 0.3) * 8 + Math.cos(day * 0.2) * 4 + (Math.random() - 0.5) * 6;

                // ËÆ°ÁÆóÊØèÊó•Ë¥πÁî®
                const dailyCost = Math.max(0, dailyUsage) * 4.5;

                days.push(`${day}Êó•`);
                usageData.push(Math.max(0, dailyUsage).toFixed(2));
                costData.push(dailyCost.toFixed(2));
            }

            // EChartsÈÖçÁΩÆ
            const option = {
                title: {
                    text: 'Êú¨ÊúàÊØèÊó•Áî®ÁîµÈáè‰∏éË¥πÁî®Ë∂ãÂäø',
                    left: 'center',
                    textStyle: {
                        fontFamily: '"SF Pro Display", -apple-system, BlinkMacSystemFont, "Inter", sans-serif',
                        fontWeight: 300,
                        fontSize: 18,
                        color: '#000000'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    },
                    backgroundColor: '#000000',
                    borderColor: '#000000',
                    textStyle: {
                        fontFamily: '"SF Pro Display", -apple-system, BlinkMacSystemFont, "Inter", sans-serif',
                        color: '#FFFFFF',
                        fontSize: 13
                    },
                    formatter: function(params) {
                        let result = `<div style="font-weight: 500; margin-bottom: 4px;">${params[0].axisValue}Êï∞ÊçÆ</div>`;
                        params.forEach(function(item) {
                            if (item.seriesName === 'ÊØèÊó•ÁîµÈáè') {
                                result += `<div style="margin-bottom: 2px;">Áî®ÁîµÈáè: ${item.value} kWh</div>`;
                            } else if (item.seriesName === 'ÊØèÊó•Ë¥πÁî®') {
                                result += `<div>Ë¥πÁî®: ‚Çπ${item.value}</div>`;
                            }
                        });
                        return result;
                    }
                },
                legend: {
                    data: ['ÊØèÊó•ÁîµÈáè', 'ÊØèÊó•Ë¥πÁî®'],
                    top: 30,
                    textStyle: {
                        fontFamily: '"SF Pro Display", -apple-system, BlinkMacSystemFont, "Inter", sans-serif',
                        fontWeight: 500,
                        fontSize: 14
                    }
                },
                grid: {
                    left: '80px',
                    right: '80px',
                    top: '80px',
                    bottom: '60px',
                    containLabel: false
                },
                xAxis: {
                    type: 'category',
                    data: days,
                    axisLine: {
                        lineStyle: {
                            color: '#666666'
                        }
                    },
                    axisLabel: {
                        fontFamily: '"SF Pro Display", -apple-system, BlinkMacSystemFont, "Inter", sans-serif',
                        color: '#666666',
                        fontSize: 12
                    },
                    splitLine: {
                        show: true,
                        lineStyle: {
                            color: '#F0F0F0'
                        }
                    }
                },
                yAxis: [
                    {
                        type: 'value',
                        name: 'ÊØèÊó•ÁîµÈáè (kWh)',
                        nameTextStyle: {
                            fontFamily: '"SF Pro Display", -apple-system, BlinkMacSystemFont, "Inter", sans-serif',
                            color: '#0066CC',
                            fontWeight: 500,
                            fontSize: 14
                        },
                        axisLine: {
                            lineStyle: {
                                color: '#0066CC'
                            }
                        },
                        axisLabel: {
                            fontFamily: '"SF Pro Display", -apple-system, BlinkMacSystemFont, "Inter", sans-serif',
                            color: '#0066CC',
                            fontSize: 11
                        },
                        splitLine: {
                            show: true,
                            lineStyle: {
                                color: '#F0F0F0'
                            }
                        }
                    },
                    {
                        type: 'value',
                        name: 'ÊØèÊó•ÈáëÈ¢ù (‚Çπ)',
                        nameTextStyle: {
                            fontFamily: '"SF Pro Display", -apple-system, BlinkMacSystemFont, "Inter", sans-serif',
                            color: '#28A745',
                            fontWeight: 500,
                            fontSize: 14
                        },
                        axisLine: {
                            lineStyle: {
                                color: '#28A745'
                            }
                        },
                        axisLabel: {
                            fontFamily: '"SF Pro Display", -apple-system, BlinkMacSystemFont, "Inter", sans-serif',
                            color: '#28A745',
                            fontSize: 11,
                            formatter: '‚Çπ{value}'
                        },
                        splitLine: {
                            show: false
                        }
                    }
                ],
                series: [
                    {
                        name: 'ÊØèÊó•ÁîµÈáè',
                        type: 'line',
                        yAxisIndex: 0,
                        data: usageData,
                        lineStyle: {
                            color: '#0066CC',
                            width: 2
                        },
                        itemStyle: {
                            color: '#0066CC'
                        },
                        symbol: 'circle',
                        symbolSize: 4,
                        smooth: true
                    },
                    {
                        name: 'ÊØèÊó•Ë¥πÁî®',
                        type: 'line',
                        yAxisIndex: 1,
                        data: costData,
                        lineStyle: {
                            color: '#28A745',
                            width: 2
                        },
                        itemStyle: {
                            color: '#28A745'
                        },
                        symbol: 'circle',
                        symbolSize: 4,
                        smooth: true
                    }
                ]
            };

            // ËÆæÁΩÆÈÖçÁΩÆÈ°πÂπ∂Ê∏≤ÊüìÂõæË°®
            chartInstance.setOption(option);

            // ÂìçÂ∫îÂºèÂ§ÑÁêÜ
            window.addEventListener('resize', function() {
                if (chartInstance) {
                    chartInstance.resize();
                }
            });

            console.log('EChartsÂõæË°®Ê∏≤ÊüìÂÆåÊàê');
        }


        // ÁîüÊàêÊäΩÂ±âÊó•ÂéÜ
        function generateDrawerCalendar() {
            const calendarGrid = document.getElementById('drawer-calendar-grid');
            if (!calendarGrid) return;

            // Ëé∑ÂèñÂΩìÂâçÊó•Êúü
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();
            const today = now.getDate();

            // Ê®°ÊãüÊï∞ÊçÆÁî®‰∫éÊâæÂà∞ÊúÄÂ§ßÂÄº - Á°Æ‰øù‰∏∫2025Âπ¥9ÊúàÁîüÊàê30Â§©Êï∞ÊçÆ
            const monthlyData = [];
            const daysInMonth = new Date(2025, 9, 0).getDate(); // 2025Âπ¥9ÊúàÁöÑÂ§©Êï∞ (30Â§©)
            for (let d = 1; d <= daysInMonth; d++) {
                const usage = 15 + Math.sin(d * 0.3) * 8 + Math.random() * 6;
                const cost = usage * 4.5;
                monthlyData.push({ day: d, usage, cost });
            }

            const maxUsage = Math.max(...monthlyData.map(d => d.usage));
            const maxCost = Math.max(...monthlyData.map(d => d.cost));
            const maxUsageDay = monthlyData.find(d => d.usage === maxUsage)?.day;
            const maxCostDay = monthlyData.find(d => d.cost === maxCost)?.day;

            // ÁîüÊàêÊó•ÂéÜÊï∞ÊçÆ
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            let calendarHTML = '';
            let date = new Date(startDate);

            // ÁîüÊàê6Âë®ÁöÑÊó•ÂéÜÔºà42Â§©Ôºâ
            for (let i = 0; i < 42; i++) {
                const day = date.getDate();
                const isCurrentMonth = date.getMonth() === currentMonth;
                const isToday = isCurrentMonth && day === today;
                const isOtherMonth = !isCurrentMonth;

                // Ê®°ÊãüÁî®ÁîµÈáèÊï∞ÊçÆ - ‰ΩøÁî®È¢ÑÁîüÊàêÁöÑÊï∞ÊçÆÁ°Æ‰øù‰∏ÄËá¥ÊÄß
                let dailyUsage = 0;
                if (isCurrentMonth && day <= daysInMonth) {
                    const dayData = monthlyData.find(d => d.day === day);
                    dailyUsage = dayData ? dayData.usage : 15 + Math.sin(day * 0.3) * 8 + Math.random() * 6;
                }

                // Ê®°ÊãüË¥πÁî®Êï∞ÊçÆÔºàÊ†πÊçÆÁî®ÁîµÈáèËÆ°ÁÆóÔºâ
                const dailyCost = dailyUsage * 4.5; // Âπ≥ÂùáÁîµ‰ª∑

                // Ê†πÊçÆÂΩìÂâçÁ±ªÂûãÈÄâÊã©ÊòæÁ§∫ÂÄº
                const displayValue = currentDrawerCalendarType === 'usage' ? dailyUsage : dailyCost;
                const displayUnit = currentDrawerCalendarType === 'usage' ? 'kWh' : '‚Çπ';
                const displayFormat = currentDrawerCalendarType === 'usage' ? dailyUsage.toFixed(1) : dailyCost.toFixed(2);

                // Ê∑ªÂä†ÊúÄÈ´òÂÄºÊ†áËÆ∞ÁÇπ
                let marker = '';
                if (isCurrentMonth) {
                    if (currentDrawerCalendarType === 'usage' && day === maxUsageDay) {
                        marker = `<span class="drawer-max-marker usage-max" title="Êú¨ÊúàÁî®ÁîµÈáèÊúÄÈ´ò">‚óè</span>`;
                    } else if (currentDrawerCalendarType === 'cost' && day === maxCostDay) {
                        marker = `<span class="drawer-max-marker cost-max" title="Êú¨ÊúàË¥πÁî®ÊúÄÈ´ò">‚óè</span>`;
                    }
                }

                // Á°ÆÂÆöÁî®ÁîµÈáèÁ≠âÁ∫ß
                let usageLevel = '';
                if (dailyUsage > 0) {
                    if (dailyUsage < 15) {
                        usageLevel = 'low-usage';
                    } else if (dailyUsage <= 25) {
                        usageLevel = 'medium-usage';
                    } else {
                        usageLevel = 'high-usage';
                    }
                }

                const dayClasses = [
                    'drawer-calendar-day',
                    isOtherMonth ? 'other-month' : ''
                ].filter(Boolean).join(' ');

                calendarHTML += `
                    <div class="${dayClasses}" data-date="${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}" onclick="showDayDetails('${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}')">
                        <div class="drawer-day-number">${day}</div>
                        ${marker}
                        ${isCurrentMonth ? `
                            <div class="drawer-day-content">
                                <div class="drawer-day-usage-value">${displayFormat}</div>
                                <div class="drawer-day-unit">${displayUnit}</div>
                            </div>
                        ` : ''}
                    </div>
                `;

                date.setDate(date.getDate() + 1);
            }

            calendarGrid.innerHTML = calendarHTML;

            // Ë∞ÉËØïÔºöÊ£ÄÊü•ÊòØÂê¶ÁîüÊàê‰∫ÜÊâÄÊúâÂ§©Êï∞
            const generatedDays = calendarGrid.querySelectorAll('.drawer-calendar-day:not(.other-month)');
            console.log('Generated calendar days:', generatedDays.length);
            console.log('Days in month:', daysInMonth);

            // Êõ¥Êñ∞Ê†áÈ¢ò
            const calendarTitle = document.getElementById('drawer-calendar-title');
            if (calendarTitle) {
                const monthNames = currentLanguage === 'zh' ?
                    ['1Êúà', '2Êúà', '3Êúà', '4Êúà', '5Êúà', '6Êúà', '7Êúà', '8Êúà', '9Êúà', '10Êúà', '11Êúà', '12Êúà'] :
                    ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                calendarTitle.textContent = currentLanguage === 'zh' ?
                    `${currentYear}Âπ¥${monthNames[currentMonth]}` :
                    `${monthNames[currentMonth]} ${currentYear}`;
            }
        }

        // ÊòæÁ§∫/ÂàáÊç¢Êó•ÊúüËØ¶ÊÉÖÂπ∂Êâ©Â±ï/Êî∂Áº©ÊäΩÂ±â
        function showDayDetails(dateStr) {
            // Ëß£ÊûêÊó•Êúü
            const [year, month, day] = dateStr.split('-');
            const date = new Date(year, month - 1, day);
            const monthNames = getMonthNames();

            // Ê£ÄÊü•ÊòØÂê¶ÊòØË¥¶ÂçïÊúà‰ªΩÔºà2025Âπ¥9ÊúàÔºâ
            if (parseInt(year) !== 2025 || parseInt(month) !== 9) {
                return; // ÈùûË¥¶ÂçïÊúà‰ªΩ‰∏çÊòæÁ§∫ËØ¶ÊÉÖ
            }

            // Ê£ÄÊü•ÂΩìÂâçÊòØÂê¶Âú®Êó•ÂéÜËßÜÂõæÔºåÂ¶ÇÊûúÊòØÔºåÈúÄË¶ÅÁâπÊÆäÂ§ÑÁêÜËØ¶ÊÉÖÊòæÁ§∫
            const currentActiveView = document.querySelector('.drawer-usage-view.active');
            if (currentActiveView && currentActiveView.id === 'drawer-calendar-view') {
                // Âú®Êó•ÂéÜËßÜÂõæ‰∏≠ÔºåÂàõÂª∫‰∏¥Êó∂ËØ¶ÊÉÖÈù¢ÊùøÊòæÁ§∫Âú®Âè≥‰æß
                showCalendarDayDetails(dateStr, parseInt(day));
                return;
            }

            const clickedDay = document.querySelector(`[data-date="${dateStr}"]`);
            const isAlreadySelected = clickedDay.classList.contains('selected');

            if (isAlreadySelected) {
                // Â¶ÇÊûúÂ∑≤ÁªèÈÄâ‰∏≠ÔºåÂàôÂèñÊ∂àÈÄâÊã©Âπ∂Êî∂Ëµ∑
                closeDrawerHourlyDetails();
            } else {
                // Â¶ÇÊûúÊú™ÈÄâ‰∏≠ÔºåÂàôÈÄâ‰∏≠Âπ∂Â±ïÂºÄ
                // Êõ¥Êñ∞ÈÄâ‰∏≠Áä∂ÊÄÅ - Ê∏ÖÈô§Êó•ÂéÜÂíåË°®Ê†ºÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
                document.querySelectorAll('.drawer-calendar-day').forEach(dayEl => {
                    dayEl.classList.remove('selected');
                });
                document.querySelectorAll('.drawer-daily-table-row').forEach(rowEl => {
                    rowEl.classList.remove('selected');
                });

                // ÈÄâ‰∏≠ÂΩìÂâçÁÇπÂáªÁöÑÂÖÉÁ¥†ÔºàÂèØËÉΩÊòØÊó•ÂéÜÊó•ÊúüÊàñË°®Ê†ºË°åÔºâ
                if (clickedDay) {
                    clickedDay.classList.add('selected');
                }

                // Êâ©Â±ïÊäΩÂ±â
                const drawer = document.querySelector('.right-drawer');
                drawer.classList.add('expanded');
                console.log('Drawer expanded in showDayDetails:', drawer);

                // Êó†ËÆ∫‰ªÄ‰πàËßÜÂõæÔºåÈÉΩ‰ΩøÁî®Áõ∏ÂêåÁöÑËØ¶ÊÉÖÈù¢ÊùøÁ°Æ‰øù‰∏ÄËá¥ÊÄß
                let hourlyPanel = document.getElementById('drawer-hourly-details-panel');
                let panelContentId = 'drawer-hourly-details-content';
                let titleId = 'drawer-selected-date-title';

                if (hourlyPanel) {
                    hourlyPanel.style.display = 'block';
                    console.log('Hourly panel displayed in showDayDetails:', hourlyPanel);
                } else {
                    console.error('Hourly panel not found in showDayDetails!');
                }

                // ‰øùÊåÅÁî®Êà∑ÂΩìÂâçÈÄâÊã©ÁöÑËßÜÂõæÔºå‰∏çÂº∫Âà∂Ë∑≥ËΩ¨
                // Ê£ÄÊü•ÂΩìÂâçÊøÄÊ¥ªÁöÑËßÜÂõæ
                const currentActiveView = document.querySelector('.drawer-usage-view.active');
                let currentViewType = 'chart'; // ÈªòËÆ§ÂõæË°®ËßÜÂõæ

                console.log('Current active view:', currentActiveView);

                if (currentActiveView) {
                    if (currentActiveView.id === 'drawer-chart-view') {
                        currentViewType = 'chart';
                    } else if (currentActiveView.id === 'drawer-calendar-view') {
                        currentViewType = 'calendar';
                    } else if (currentActiveView.id === 'drawer-table-view') {
                        currentViewType = 'table';
                    }
                }

                console.log('Determined view type:', currentViewType);

                // ÊøÄÊ¥ªÂΩìÂâçËßÜÂõæÔºàÂ¶ÇÊûúÊòØÊó•ÂéÜËßÜÂõæÔºå‰ºöËá™Âä®ËÆæÁΩÆ‰∏∫Â∑¶Âè≥Â∏ÉÂ±ÄÔºâ
                switchDrawerView(currentViewType);

                // Êõ¥Êñ∞Ê†áÈ¢ò
                const dateTitle = document.getElementById(titleId);
                if (dateTitle) {
                    dateTitle.setAttribute('data-zh', `${year}Âπ¥${monthNames[parseInt(month) - 1]}${day}Êó• ‚Äî ÊØèÂ∞èÊó∂ÊòéÁªÜ`);
                    dateTitle.setAttribute('data-en', `${monthNames[parseInt(month) - 1]} ${day}, ${year} ‚Äî Hourly Details`);
                    dateTitle.textContent = currentLanguage === 'zh' ?
                        `${year}Âπ¥${monthNames[parseInt(month) - 1]}${day}Êó• ‚Äî ÊØèÂ∞èÊó∂ÊòéÁªÜ` :
                        `${monthNames[parseInt(month) - 1]} ${day}, ${year} ‚Äî Hourly Details`;
                }

                // Á≠âÂæÖDOMÊõ¥Êñ∞ÂêéÁîüÊàêÊØèÂ∞èÊó∂Êï∞ÊçÆ
                setTimeout(() => {
                    console.log('Calling generateDrawerHourlyData for day:', parseInt(day));
                    generateDrawerHourlyData(parseInt(day), panelContentId);

                    // Â¶ÇÊûúÂΩìÂâçÂú®Ë°®Ê†ºËßÜÂõæÔºåÁ°Æ‰øùÈÄâ‰∏≠Êó•ÊúüÁöÑË°åË¢´Ê≠£Á°ÆÊ†áËÆ∞ÂíåÂ±ïÂºÄ
                    if (currentViewType === 'table') {
                        highlightSelectedDateInTable(dateStr);
                    }
                }, 500);
            }
        }

        // Êó•ÂéÜËßÜÂõæ‰∏ìÁî®ÁöÑËØ¶ÊÉÖÂ±ïÂºÄÂáΩÊï∞
        function showCalendarDayDetails(dateStr, dayNumber) {
            console.log('showCalendarDayDetails called:', dateStr, dayNumber);

            // Ëß£ÊûêÊó•Êúü
            const [year, month, day] = dateStr.split('-');
            const monthNames = getMonthNames();

            // Êü•ÊâæË¢´ÁÇπÂáªÁöÑÊó•ÂéÜÊ†ºÂ≠ê
            const clickedDay = document.querySelector(`[data-date="${dateStr}"]`);
            const isAlreadySelected = clickedDay && clickedDay.classList.contains('selected');

            if (isAlreadySelected) {
                // Â¶ÇÊûúÂ∑≤ÁªèÈÄâ‰∏≠ÔºåÂàôÂèñÊ∂àÈÄâÊã©Âπ∂Êî∂Ëµ∑
                closeCalendarHourlyDetails();
            } else {
                // Ê∏ÖÈô§ÊâÄÊúâÈÄâ‰∏≠Áä∂ÊÄÅ
                document.querySelectorAll('.drawer-calendar-day.selected').forEach(day => {
                    day.classList.remove('selected');
                });

                // ÈÄâ‰∏≠ÂΩìÂâçÁÇπÂáªÁöÑÊó•ÂéÜÊ†ºÂ≠ê
                if (clickedDay) {
                    clickedDay.classList.add('selected');
                }

                // Êâ©Â±ïÊäΩÂ±â
                const drawer = document.querySelector('.right-drawer');
                drawer.classList.add('expanded');

                // Âä®ÊÄÅÂàõÂª∫ËØ¶ÊÉÖÈù¢ÊùøÂú®Êó•ÂéÜËßÜÂõæÁöÑÂè≥‰æß
                createCalendarDetailsPanel(dateStr, dayNumber);
            }
        }

        // ‰∏∫Êó•ÂéÜËßÜÂõæÂàõÂª∫ËØ¶ÊÉÖÈù¢Êùø
        function createCalendarDetailsPanel(dateStr, dayNumber) {
            // ÁßªÈô§‰πãÂâçÁöÑËØ¶ÊÉÖÈù¢ÊùøÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
            const existingPanel = document.getElementById('calendar-hourly-details-panel');
            if (existingPanel) {
                existingPanel.remove();
            }

            // Ëß£ÊûêÊó•ÊúüÁî®‰∫éÊ†áÈ¢ò
            const [year, month, day] = dateStr.split('-');
            const monthNames = getMonthNames();

            // Âú®Êó•ÂéÜËßÜÂõæ‰∏≠ÂàõÂª∫ËØ¶ÊÉÖÈù¢Êùø
            const calendarView = document.getElementById('drawer-calendar-view');
            const detailsPanel = document.createElement('div');
            detailsPanel.id = 'calendar-hourly-details-panel';
            detailsPanel.className = 'drawer-hourly-details-panel';
            detailsPanel.innerHTML = `
                <div class="drawer-hourly-header">
                    <h4>${currentLanguage === 'zh' ?
                        `${year}Âπ¥${monthNames[parseInt(month) - 1]}${day}Êó• ‚Äî ÊØèÂ∞èÊó∂ÊòéÁªÜ` :
                        `${monthNames[parseInt(month) - 1]} ${day}, ${year} ‚Äî Hourly Details`}</h4>
                    <button class="drawer-hourly-close" onclick="closeCalendarHourlyDetails()">√ó</button>
                </div>
                <div class="drawer-hourly-content" id="calendar-hourly-details-content">
                    <!-- ÊØèÂ∞èÊó∂Êï∞ÊçÆÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
                </div>
            `;

            calendarView.appendChild(detailsPanel);

            // ÁîüÊàêÊØèÂ∞èÊó∂Êï∞ÊçÆ
            setTimeout(() => {
                generateDrawerHourlyData(parseInt(day), 'calendar-hourly-details-content');
            }, 100);
        }

        // ÂÖ≥Èó≠Êó•ÂéÜËØ¶ÊÉÖÈù¢Êùø
        function closeCalendarHourlyDetails() {
            // Êî∂Áº©ÊäΩÂ±â
            const drawer = document.querySelector('.right-drawer');
            drawer.classList.remove('expanded');

            // ÁßªÈô§ËØ¶ÊÉÖÈù¢Êùø
            const detailsPanel = document.getElementById('calendar-hourly-details-panel');
            if (detailsPanel) {
                detailsPanel.remove();
            }

            // Ê∏ÖÈô§ÈÄâ‰∏≠Áä∂ÊÄÅ
            document.querySelectorAll('.drawer-calendar-day.selected').forEach(day => {
                day.classList.remove('selected');
            });
        }

        // Ë°®Ê†ºË°å‰∏ìÁî®ÁöÑËØ¶ÊÉÖÂ±ïÂºÄÂáΩÊï∞
        function showTableRowDetails(dateStr, dayNumber) {
            console.log('showTableRowDetails called:', dateStr, dayNumber);

            // Ëß£ÊûêÊó•Êúü
            const [year, month, day] = dateStr.split('-');
            const monthNames = getMonthNames();

            // Ê£ÄÊü•ÊòØÂê¶ÊòØË¥¶ÂçïÊúà‰ªΩÔºà2025Âπ¥9ÊúàÔºâ
            if (parseInt(year) !== 2025 || parseInt(month) !== 9) {
                return; // ÈùûË¥¶ÂçïÊúà‰ªΩ‰∏çÊòæÁ§∫ËØ¶ÊÉÖ
            }

            // Êü•ÊâæË¢´ÁÇπÂáªÁöÑË°®Ê†ºË°å
            const clickedRow = document.querySelector(`[data-date="${dateStr}"]`);
            const isAlreadySelected = clickedRow && clickedRow.classList.contains('selected');

            if (isAlreadySelected) {
                // Â¶ÇÊûúÂ∑≤ÁªèÈÄâ‰∏≠ÔºåÂàôÂèñÊ∂àÈÄâÊã©Âπ∂Êî∂Ëµ∑
                closeDrawerHourlyDetails();
            } else {
                // Ê∏ÖÈô§ÊâÄÊúâÈÄâ‰∏≠Áä∂ÊÄÅ
                document.querySelectorAll('.drawer-calendar-day').forEach(dayEl => {
                    dayEl.classList.remove('selected');
                });
                document.querySelectorAll('.drawer-daily-table-row').forEach(rowEl => {
                    rowEl.classList.remove('selected');
                });

                // ÈÄâ‰∏≠ÂΩìÂâçÁÇπÂáªÁöÑË°®Ê†ºË°å
                if (clickedRow) {
                    clickedRow.classList.add('selected');
                }

                // Êâ©Â±ïÊäΩÂ±â
                const drawer = document.querySelector('.right-drawer');
                drawer.classList.add('expanded');

                // ÊòæÁ§∫ÊØèÂ∞èÊó∂ËØ¶ÊÉÖÈù¢Êùø
                const hourlyPanel = document.getElementById('drawer-hourly-details-panel');
                hourlyPanel.style.display = 'block';

                // CSSËßÑÂàô‰ºöËá™Âä®Â§ÑÁêÜÂ±ïÂºÄÁä∂ÊÄÅÁöÑflexÂ∏ÉÂ±Ä
                console.log('Drawer expanded, CSS will handle flex layout');

                // Êõ¥Êñ∞ËØ¶ÊÉÖÈù¢ÊùøÊ†áÈ¢ò
                const dateTitle = document.getElementById('drawer-selected-date-title');
                if (dateTitle) {
                    dateTitle.setAttribute('data-zh', `${year}Âπ¥${monthNames[parseInt(month) - 1]}${day}Êó• ‚Äî ÊØèÂ∞èÊó∂ÊòéÁªÜ`);
                    dateTitle.setAttribute('data-en', `${monthNames[parseInt(month) - 1]} ${day}, ${year} ‚Äî Hourly Details`);
                    dateTitle.textContent = currentLanguage === 'zh' ?
                        `${year}Âπ¥${monthNames[parseInt(month) - 1]}${day}Êó• ‚Äî ÊØèÂ∞èÊó∂ÊòéÁªÜ` :
                        `${monthNames[parseInt(month) - 1]} ${day}, ${year} ‚Äî Hourly Details`;
                }

                // ÁîüÊàêÊØèÂ∞èÊó∂Êï∞ÊçÆ
                setTimeout(() => {
                    console.log('Calling generateDrawerHourlyData for day:', parseInt(day));
                    generateDrawerHourlyData(parseInt(day), 'drawer-hourly-details-content');
                }, 100);
            }
        }

        // Âú®Ë°®Ê†ºËßÜÂõæ‰∏≠È´ò‰∫ÆÈÄâ‰∏≠ÁöÑÊó•Êúü
        function highlightSelectedDateInTable(dateStr) {
            console.log('Highlighting date in table:', dateStr);

            // Á°Æ‰øùË°®Ê†ºË°åÂ∑≤ÁªèË¢´ÈÄâ‰∏≠ÔºàËøôÂ∫îËØ•Â∑≤ÁªèÂú®showDayDetails‰∏≠ÂÆåÊàê‰∫ÜÔºâ
            const selectedRow = document.querySelector(`.drawer-daily-table-row[data-date="${dateStr}"]`);
            if (selectedRow) {
                selectedRow.classList.add('selected');
                console.log('Table row highlighted:', selectedRow);

                // ÊªöÂä®Âà∞ÈÄâ‰∏≠ÁöÑË°åÔºàÂ¶ÇÊûúË°®Ê†ºÂæàÈïøÁöÑËØùÔºâ
                selectedRow.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });
            } else {
                console.warn('Table row not found for date:', dateStr);
            }
        }

        // ÂÖ≥Èó≠ÊØèÂ∞èÊó∂ËØ¶ÊÉÖÂπ∂Êî∂Áº©ÊäΩÂ±â
        function closeDrawerHourlyDetails() {
            // Êî∂Áº©ÊäΩÂ±â
            const drawer = document.querySelector('.right-drawer');
            drawer.classList.remove('expanded');

            // ÈöêËóèËØ¶ÊÉÖÈù¢Êùø
            const hourlyPanel = document.getElementById('drawer-hourly-details-panel');
            if (hourlyPanel) {
                hourlyPanel.style.display = 'none';
            }

            // ÁßªÈô§ÂÜÖËÅîÊ†∑ÂºèÔºåËÆ©CSSËßÑÂàôÁîüÊïà
            document.querySelectorAll('.drawer-usage-view').forEach(view => {
                if (view.classList.contains('active')) {
                    view.style.display = '';  // Ê∏ÖÈô§ÂÜÖËÅîÊ†∑ÂºèÔºåÊÅ¢Â§çCSSÈªòËÆ§
                }
            });

            // Ê∏ÖÈô§ÈÄâ‰∏≠Áä∂ÊÄÅ - ÂåÖÊã¨Êó•ÂéÜÂíåË°®Ê†º
            document.querySelectorAll('.drawer-calendar-day').forEach(dayEl => {
                dayEl.classList.remove('selected');
            });
            document.querySelectorAll('.drawer-daily-table-row').forEach(rowEl => {
                rowEl.classList.remove('selected');
            });

            // Ê∏ÖÈô§Êó•ÂéÜÈÄâÊã©‰ø°ÊÅØ
            const selectionInfo = document.querySelector('.calendar-selection-info');
            if (selectionInfo) {
                selectionInfo.remove();
            }
        }

        // ÁîüÊàêÊäΩÂ±âÊØèÂ∞èÊó∂ËØ¶ÊÉÖÊï∞ÊçÆ
        function generateDrawerHourlyData(day, contentId = 'drawer-hourly-details-content', retryCount = 0) {
            console.log('generateDrawerHourlyData called with day:', day, 'contentId:', contentId, 'retry:', retryCount);
            const hourlyContent = document.getElementById(contentId);
            console.log('hourlyContent element:', hourlyContent);

            if (!hourlyContent) {
                console.error('hourlyContent element not found!');
                if (retryCount < 3) {
                    console.log('Retrying in 200ms...');
                    setTimeout(() => {
                        generateDrawerHourlyData(day, contentId, retryCount + 1);
                    }, 200);
                }
                return;
            }

            // Âç∞Â∫¶ÂàÜÊó∂Áîµ‰ª∑Êó∂ÊÆµ
            const timeRates = {
                valley: { rate: 3.60, name: '‰ΩéË∞∑', nameEn: 'Valley' },
                standard: { rate: 4.50, name: 'Âπ≥Êó∂', nameEn: 'Standard' },
                peak: { rate: 5.40, name: 'È´òÂ≥∞', nameEn: 'Peak' }
            };

            // ÁîüÊàêÁÆÄÂçïÁöÑ24Â∞èÊó∂Êï∞ÊçÆË°®Ê†ºÔºåÊó∂ÊÆµÂàóÂêàÂπ∂Áõ∏ÂêåÂçïÂÖÉÊ†º
            let hourlyHTML = `
                <table class="simple-hourly-table">
                    <tr>
                        <th>${currentLanguage === 'zh' ? 'Êó∂Èó¥' : 'Time'}</th>
                        <th>${currentLanguage === 'zh' ? 'Êó∂ÊÆµ' : 'Period'}</th>
                        <th>${currentLanguage === 'zh' ? 'ÁîµÈáè' : 'Usage'}</th>
                        <th>${currentLanguage === 'zh' ? 'Âçï‰ª∑' : 'Rate'}</th>
                        <th>${currentLanguage === 'zh' ? 'Ë¥πÁî®' : 'Cost'}</th>
                    </tr>
            `;

            // ÂÖàÁîüÊàêÊâÄÊúâÂ∞èÊó∂ÁöÑÊï∞ÊçÆ
            let allHours = [];
            for (let hour = 0; hour < 24; hour++) {
                // Á°ÆÂÆöÊó∂ÊÆµ
                let period = '';
                let rate = 0;
                if (hour >= 0 && hour < 8) {
                    period = '‰ΩéË∞∑';
                    rate = 3.60;
                } else if (hour >= 8 && hour < 12) {
                    period = 'Âπ≥Êó∂';
                    rate = 4.50;
                } else if (hour >= 12 && hour < 18) {
                    period = 'È´òÂ≥∞';
                    rate = 5.40;
                } else if (hour >= 18 && hour < 23) {
                    period = 'Âπ≥Êó∂';
                    rate = 4.50;
                } else { // hour == 23
                    period = '‰ΩéË∞∑';
                    rate = 3.60;
                }

                // Ê®°ÊãüÁî®ÁîµÈáè
                const baseUsage = 0.8 + Math.sin((hour + day) * 0.3) * 0.4 + Math.random() * 0.3;
                const usage = Math.max(0.1, baseUsage);
                const cost = usage * rate;

                allHours.push({
                    hour: hour,
                    timeStr: `${hour.toString().padStart(2, '0')}:00`,
                    period: period,
                    rate: rate,
                    usage: usage,
                    cost: cost
                });
            }

            // ËÆ°ÁÆóÊØè‰∏™Êó∂ÊÆµÈúÄË¶ÅÂêàÂπ∂ÁöÑË°åÊï∞
            let periodSpans = {};
            let currentPeriod = null;
            let currentSpan = 0;

            for (let i = 0; i < allHours.length; i++) {
                const hourData = allHours[i];
                if (hourData.period !== currentPeriod) {
                    if (currentPeriod !== null) {
                        periodSpans[currentPeriod + '_' + (i - currentSpan)] = currentSpan;
                    }
                    currentPeriod = hourData.period;
                    currentSpan = 1;
                } else {
                    currentSpan++;
                }
            }
            // Â§ÑÁêÜÊúÄÂêé‰∏Ä‰∏™Êó∂ÊÆµ
            if (currentPeriod !== null) {
                periodSpans[currentPeriod + '_' + (allHours.length - currentSpan)] = currentSpan;
            }

            // ÁîüÊàêË°®Ê†ºË°å
            for (let i = 0; i < allHours.length; i++) {
                const hourData = allHours[i];
                let periodCell = '';

                // Ê£ÄÊü•ÊòØÂê¶ÊòØÊüê‰∏™Êó∂ÊÆµÁöÑÁ¨¨‰∏ÄË°å
                if (i === 0 || allHours[i-1].period !== hourData.period) {
                    // ËÆ°ÁÆóËøô‰∏™Êó∂ÊÆµÊúâÂ§öÂ∞ëËøûÁª≠ÁöÑÂ∞èÊó∂
                    let spanCount = 1;
                    for (let j = i + 1; j < allHours.length; j++) {
                        if (allHours[j].period === hourData.period) {
                            spanCount++;
                        } else {
                            break;
                        }
                    }
                    periodCell = `<td rowspan="${spanCount}" class="merged-period">${hourData.period}</td>`;
                }

                // Ê†πÊçÆÊó∂ÊÆµËÆæÁΩÆË°åÁöÑÈ¢úËâ≤Á±ª
                let rowClass = '';
                if (hourData.period === 'È´òÂ≥∞') {
                    rowClass = 'peak-hour';
                } else if (hourData.period === 'Âπ≥Êó∂') {
                    rowClass = 'standard-hour';
                } else if (hourData.period === '‰ΩéË∞∑') {
                    rowClass = 'valley-hour';
                }

                hourlyHTML += `
                    <tr class="${rowClass}">
                        <td>${hourData.timeStr}</td>
                        ${periodCell}
                        <td>${hourData.usage.toFixed(2)} kWh</td>
                        <td>‚Çπ${hourData.rate.toFixed(2)}</td>
                        <td>‚Çπ${hourData.cost.toFixed(2)}</td>
                    </tr>
                `;
            }

            hourlyHTML += `</table>`;

            console.log('Setting hourlyHTML:', hourlyHTML);
            hourlyContent.innerHTML = hourlyHTML;
            console.log('Content set, element innerHTML length:', hourlyContent.innerHTML.length);
        }

        // ÁîüÊàêÊäΩÂ±âË°®Ê†ºËßÜÂõæÊï∞ÊçÆ
        function generateDrawerTableData(day) {
            console.log('generateDrawerTableData called with day:', day);
            const tableBody = document.getElementById('drawer-table-body');

            if (!tableBody) {
                console.error('drawer-table-body element not found!');
                return;
            }

            // ÁîüÊàêÈÄâ‰∏≠Êó•ÊúüÁöÑË°åÊï∞ÊçÆ
            const dayData = {
                day: day,
                date: `2025-09-${day.toString().padStart(2, '0')}`,
                usage: (15 + Math.sin(day * 0.3) * 8 + Math.random() * 6).toFixed(2),
                amount: 0
            };

            // ËÆ°ÁÆóÈáëÈ¢ùÔºàÂü∫‰∫éÂàÜÊó∂Áîµ‰ª∑Ôºâ
            dayData.amount = (parseFloat(dayData.usage) * 4.5).toFixed(2);

            // ÁîüÊàêË°®Ê†ºHTML
            let tableHTML = `
                <div class="drawer-daily-table-row selected-day-row" onclick="toggleDrawerDayDetails(${day})">
                    <span class="expand-icon" id="expand-icon-${day}">‚ñº</span>
                    <span>${dayData.date}</span>
                    <span>${dayData.usage} kWh</span>
                    <span>‚Çπ${dayData.amount}</span>
                </div>
                <div class="drawer-hourly-details-row expanded" id="drawer-hourly-details-${day}">
                    <div class="drawer-hourly-grid" id="drawer-hourly-grid-${day}">
                        <!-- ÊØèÂ∞èÊó∂Êï∞ÊçÆÂ∞ÜÂú®ËøôÈáåÁîüÊàê -->
                    </div>
                </div>
            `;

            tableBody.innerHTML = tableHTML;

            // ÁîüÊàêÊØèÂ∞èÊó∂Êï∞ÊçÆ
            setTimeout(() => {
                generateDrawerTableHourlyData(day);
            }, 100);
        }

        // ÁîüÊàêË°®Ê†º‰∏≠ÁöÑÊØèÂ∞èÊó∂ËØ¶ÁªÜÊï∞ÊçÆ
        function generateDrawerTableHourlyData(day) {
            const hourlyGrid = document.getElementById(`drawer-hourly-grid-${day}`);
            if (!hourlyGrid) {
                console.error('Hourly grid not found for day:', day);
                return;
            }

            // Ê∑ªÂä†Ë°®Ê†ºÊ†áÈ¢ò
            let hourlyHTML = `
                <div class="hourly-header">
                    <span>Êó∂Èó¥</span>
                    <span>Êó∂ÊÆµ</span>
                    <span>ÁîµÈáè</span>
                    <span>Âçï‰ª∑</span>
                    <span>Ë¥πÁî®</span>
                </div>
            `;

            // ÁîüÊàê24Â∞èÊó∂Êï∞ÊçÆ
            for (let hour = 0; hour < 24; hour++) {
                // Á°ÆÂÆöÊó∂ÊÆµ
                let period = '';
                let rate = 0;
                if (hour >= 0 && hour < 8) {
                    period = '‰ΩéË∞∑';
                    rate = 3.60;
                } else if (hour >= 8 && hour < 12) {
                    period = 'Âπ≥Êó∂';
                    rate = 4.50;
                } else if (hour >= 12 && hour < 18) {
                    period = 'È´òÂ≥∞';
                    rate = 5.40;
                } else if (hour >= 18 && hour < 23) {
                    period = 'Âπ≥Êó∂';
                    rate = 4.50;
                } else { // hour == 23
                    period = '‰ΩéË∞∑';
                    rate = 3.60;
                }

                // Ê®°ÊãüÁî®ÁîµÈáè
                const usage = (0.8 + Math.sin((hour + day) * 0.3) * 0.4 + Math.random() * 0.3).toFixed(2);
                const cost = (parseFloat(usage) * rate).toFixed(2);
                const timeStr = `${hour.toString().padStart(2, '0')}:00`;

                hourlyHTML += `
                    <div class="hourly-item">
                        <span class="hour-time">${timeStr}</span>
                        <span class="hour-period">${period}</span>
                        <span class="hour-usage">${usage} kWh</span>
                        <span class="hour-rate">‚Çπ${rate.toFixed(2)}</span>
                        <span class="hour-cost">‚Çπ${cost}</span>
                    </div>
                `;
            }

            hourlyGrid.innerHTML = hourlyHTML;
        }

        // Êó•ÂéÜÁ±ªÂûãÂàáÊç¢ÂÖ®Â±ÄÂèòÈáè
        let currentCalendarType = 'usage'; // 'usage' Êàñ 'cost'
        let currentDrawerCalendarType = 'usage';

        // ‰∏ªÊó•ÂéÜÂàáÊç¢ÂäüËÉΩ
        function switchCalendarType(type) {
            currentCalendarType = type;

            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            document.querySelectorAll('.calendar-toggle-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });

            // ÈáçÊñ∞ÁîüÊàêÊó•ÂéÜ
            generateCalendar();
        }

        // ÊäΩÂ±âÊó•ÂéÜÂàáÊç¢ÂäüËÉΩ
        function switchDrawerCalendarType(type) {
            currentDrawerCalendarType = type;

            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            document.querySelectorAll('.drawer-calendar-toggle-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });

            // ÈáçÊñ∞ÁîüÊàêÊäΩÂ±âÊó•ÂéÜ
            generateDrawerCalendar();
        }


        // Êü•ÁúãÂ∞èÊó∂ËØ¶ÊÉÖ
        function viewHourlyDetails(dateStr) {
            // ÂÖ≥Èó≠ÂΩìÂâçÂºπÁ™ó
            const modal = document.querySelector('[style*="position: fixed"]');
            if (modal) modal.remove();

            // ÂàáÊç¢Âà∞Ë°®Ê†ºËßÜÂõæÂπ∂Â±ïÂºÄÂØπÂ∫îÊó•Êúü
            switchDrawerView('table');

            // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ÊªöÂä®Âà∞ÂØπÂ∫îÊó•ÊúüÂπ∂Â±ïÂºÄÁöÑÈÄªËæë
            EnergySystem.showNotification('ÂàáÊç¢Âà∞Ë°®Ê†ºËßÜÂõæÊü•ÁúãËØ¶ÁªÜ‰ø°ÊÅØ', 'info');
        }

        // ÂØºÂá∫ÊäΩÂ±âÊï∞ÊçÆ
        function exportDrawerData() {
            EnergySystem.showNotification('ÂØºÂá∫ÂäüËÉΩÂºÄÂèë‰∏≠...', 'info');
        }


        // ÊäΩÂ±âË°®Ê†ºÊó•ÊúüÂ±ïÂºÄÂäüËÉΩ
        function toggleDrawerDayDetails(day) {
            console.log('ÁÇπÂáªÂ±ïÂºÄÊó•Êúü:', day); // Ë∞ÉËØï‰ø°ÊÅØ
            const detailsRow = document.getElementById(`drawer-hourly-details-${day}`);
            const expandIcon = document.getElementById(`drawer-expand-icon-${day}`);

            console.log('ËØ¶ÊÉÖË°å:', detailsRow); // Ë∞ÉËØï‰ø°ÊÅØ
            console.log('Â±ïÂºÄÂõæÊ†á:', expandIcon); // Ë∞ÉËØï‰ø°ÊÅØ

            if (!detailsRow || !expandIcon) {
                console.error('Êú™ÊâæÂà∞Áõ∏ÂÖ≥ÂÖÉÁ¥†');
                return;
            }

            if (detailsRow.style.display === 'none' || detailsRow.style.display === '') {
                // ÂÖ≥Èó≠ÂÖ∂‰ªñÂ∑≤ÊâìÂºÄÁöÑËØ¶ÊÉÖ
                document.querySelectorAll('.drawer-hourly-details-row').forEach(row => {
                    row.style.display = 'none';
                });
                document.querySelectorAll('.drawer-expand-icon').forEach(icon => {
                    icon.textContent = '‚ñ∂';
                    icon.style.transform = 'rotate(0deg)';
                });

                // ÊâìÂºÄÂΩìÂâçËØ¶ÊÉÖ
                detailsRow.style.display = 'block';
                expandIcon.textContent = '‚ñº';
                expandIcon.style.transform = 'rotate(0deg)';

                // ÁîüÊàêÊØèÂ∞èÊó∂Êï∞ÊçÆ
                generateDrawerHourlyDataOld(day);
            } else {
                // ÂÖ≥Èó≠ÂΩìÂâçËØ¶ÊÉÖ
                detailsRow.style.display = 'none';
                expandIcon.textContent = '‚ñ∂';
                expandIcon.style.transform = 'rotate(0deg)';
            }
        }

        // ÁîüÊàêÊäΩÂ±â‰∏≠ÁöÑÊØèÂ∞èÊó∂Áî®ÁîµÊï∞ÊçÆÔºàÊóßË°®Ê†ºÂ±ïÂºÄÂäüËÉΩÔºâ
        function generateDrawerHourlyDataOld(day) {
            const hourlyBody = document.getElementById(`drawer-hourly-body-${day}`);

            // Ëé∑ÂèñÊó∂ÊÆµÁîµ‰ª∑
            const timeRates = {
                peak: 5.40,     // È´òÂ≥∞Êó∂ÊÆµ 12:00-18:00
                standard: 4.50, // Âπ≥Â≥∞Êó∂ÊÆµ 08:00-12:00 & 18:00-23:00
                valley: 3.60    // ‰ΩéË∞∑Êó∂ÊÆµ 23:00-08:00
            };

            // ÁîüÊàê24Â∞èÊó∂Êï∞ÊçÆ
            let hourlyHTML = '';
            for (let hour = 0; hour < 24; hour++) {
                // Á°ÆÂÆöÊó∂ÊÆµÁ±ªÂûã
                let period, periodName, rate, periodClass;
                if (hour >= 12 && hour < 18) {
                    period = 'peak';
                    periodName = currentLanguage === 'zh' ? 'È´òÂ≥∞' : 'Peak';
                    rate = timeRates.peak;
                    periodClass = 'peak';
                } else if ((hour >= 8 && hour < 12) || (hour >= 18 && hour < 23)) {
                    period = 'standard';
                    periodName = currentLanguage === 'zh' ? 'Âπ≥Â≥∞' : 'Standard';
                    rate = timeRates.standard;
                    periodClass = 'standard';
                } else {
                    period = 'valley';
                    periodName = currentLanguage === 'zh' ? '‰ΩéË∞∑' : 'Valley';
                    rate = timeRates.valley;
                    periodClass = 'valley';
                }

                // Ê®°ÊãüÊØèÂ∞èÊó∂Áî®ÁîµÈáè (0.8-2.5kWh‰πãÈó¥)
                const hourlyUsage = (Math.random() * 1.7 + 0.8).toFixed(2);
                const hourlyCost = (hourlyUsage * rate).toFixed(2);

                hourlyHTML += `
                    <div class="drawer-hourly-row">
                        <span class="drawer-hour-time">${hour.toString().padStart(2, '0')}:00</span>
                        <span class="drawer-hour-period ${periodClass}">${periodName}</span>
                        <span class="drawer-hour-usage">${hourlyUsage}kWh</span>
                        <span class="drawer-hour-rate">‚Çπ${rate.toFixed(2)}</span>
                        <span class="drawer-hour-cost">‚Çπ${hourlyCost}</span>
                    </div>
                `;
            }

            hourlyBody.innerHTML = hourlyHTML;
        }

        // ÂÖ≥Èó≠ËØ¶ÁªÜËßÜÂõæ
        function closeDetailedView() {
            const drawer = document.querySelector('.right-drawer');
            if (drawer) {
                drawer.classList.add('hide');
                // ÊÅ¢Â§ç‰∏ªÈ°µÈù¢ÊªöÂä®
                document.body.style.overflow = '';
                setTimeout(() => {
                    document.body.removeChild(drawer);
                }, 300);
            }
        }

        // Ê∏≤ÊüìÂõæË°®ËßÜÂõæÔºàÁÆÄÂåñÁâàÁ∫øÂõæÔºâ
        function renderChartView(dailyData) {
            const canvas = document.getElementById('usage-chart');
            const ctx = canvas.getContext('2d');

            // ËÆæÁΩÆÁîªÂ∏ÉÂ∞∫ÂØ∏
            canvas.width = canvas.offsetWidth;
            canvas.height = 200;

            const width = canvas.width;
            const height = canvas.height;
            const padding = 40;

            // Ê∏ÖÁ©∫ÁîªÂ∏É
            ctx.clearRect(0, 0, width, height);

            // Ëé∑ÂèñÊï∞ÊçÆËåÉÂõ¥
            const maxUsage = Math.max(...dailyData.map(d => d.usage));
            const minUsage = Math.min(...dailyData.map(d => d.usage));
            const dataRange = maxUsage - minUsage;

            // ÁªòÂà∂ÂùêÊ†áËΩ¥
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;

            // YËΩ¥
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.stroke();

            // XËΩ¥
            ctx.beginPath();
            ctx.moveTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();

            // ÁªòÂà∂ÁΩëÊ†ºÁ∫ø
            ctx.strokeStyle = '#f5f5f5';
            ctx.lineWidth = 0.5;
            for (let i = 1; i <= 4; i++) {
                const y = padding + (height - 2 * padding) * i / 4;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
            }

            // ÁªòÂà∂ÊäòÁ∫ø
            ctx.strokeStyle = '#0066CC';
            ctx.lineWidth = 2;
            ctx.beginPath();

            dailyData.forEach((day, index) => {
                const x = padding + (width - 2 * padding) * index / (dailyData.length - 1);
                const y = height - padding - (height - 2 * padding) * (day.usage - minUsage) / dataRange;

                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });

            ctx.stroke();

            // ÁªòÂà∂Êï∞ÊçÆÁÇπ
            ctx.fillStyle = '#0066CC';
            dailyData.forEach((day, index) => {
                const x = padding + (width - 2 * padding) * index / (dailyData.length - 1);
                const y = height - padding - (height - 2 * padding) * (day.usage - minUsage) / dataRange;

                ctx.beginPath();
                ctx.arc(x, y, 3, 0, 2 * Math.PI);
                ctx.fill();
            });

            // ÁªòÂà∂Ê†áÁ≠æ
            ctx.fillStyle = '#666';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';

            // XËΩ¥Ê†áÁ≠æÔºàÊòæÁ§∫ÈÉ®ÂàÜÊó•ÊúüÔºâ
            for (let i = 0; i < dailyData.length; i += Math.ceil(dailyData.length / 6)) {
                const x = padding + (width - 2 * padding) * i / (dailyData.length - 1);
                ctx.fillText(dailyData[i].day, x, height - padding + 15);
            }

            // YËΩ¥Ê†áÁ≠æ
            ctx.textAlign = 'right';
            for (let i = 0; i <= 4; i++) {
                const value = minUsage + dataRange * (4 - i) / 4;
                const y = padding + (height - 2 * padding) * i / 4;
                ctx.fillText(value.toFixed(1), padding - 10, y + 4);
            }

        }

        // ÂàáÊç¢ËßÜÂõæ
        function switchView(viewType) {
            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === viewType);
            });

            // ÂàáÊç¢ËßÜÂõæÊòæÁ§∫
            document.querySelectorAll('.usage-view').forEach(view => {
                view.classList.toggle('active', view.id === `${viewType}-view`);
            });
        }

        // È°µÈù¢ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            // ËÆæÁΩÆÂΩìÂâçÈ°µÈù¢ÂØºËà™
            EnergySystem.setActiveNavigation('bills.html');

            // ÂàùÂßãÂåñËØ≠Ë®ÄÁ≥ªÁªü
            EnergySystem.initLanguageSystem();

            // ÁõëÂê¨ËØ≠Ë®ÄÂèòÂåñ‰∫ã‰ª∂ÔºåÈáçÊñ∞Ê∏≤ÊüìËßÜÂõæ - ÁßªÂä®Âà∞ÂàùÂßãÂåñÊó©Êúü
            window.addEventListener('languageChanged', function(e) {
                // ÈáçÊñ∞Â°´ÂÖÖÁî®Êà∑‰ø°ÊÅØÂíåÂü∫Êú¨Êï∞ÊçÆ
                if (window.currentBill && window.currentMonth) {
                    const bill = window.currentBill;
                    const month = window.currentMonth;

                    // ÈáçÊñ∞Â°´ÂÖÖÂü∫Êú¨‰ø°ÊÅØ
                    document.getElementById('detail-username').textContent = currentLanguage === 'zh' ? bill.userName : bill.userNameEn;
                    document.getElementById('header-address').textContent = currentLanguage === 'zh' ? regionsData[bill.region].name : regionsData[bill.region].nameEn;

                    const businessTypeTexts = {
                        zh: { residential: 'Â±ÖÊ∞ë', industrial: 'Â∑•‰∏ö', commercial: 'ÂïÜ‰∏ö', agricultural: 'ÂÜú‰∏ö' },
                        en: { residential: 'Residential', industrial: 'Industrial', commercial: 'Commercial', agricultural: 'Agricultural' }
                    };

                    const billingMethodTexts = {
                        zh: { tiered: 'Èò∂Ê¢ØÁîµË¥π', 'time-of-use': 'ÂàÜÊó∂Áîµ‰ª∑' },
                        en: { tiered: 'Tiered', 'time-of-use': 'Time-of-Use' }
                    };

                    document.getElementById('header-business-type').textContent = businessTypeTexts[currentLanguage][bill.businessType];

                    const monthText = currentLanguage === 'zh' ?
                        `${month.split('-')[0]}Âπ¥${parseInt(month.split('-')[1])}Êúà` :
                        new Date(month + '-01').toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                    document.getElementById('detail-period').textContent = monthText;
                    document.getElementById('detail-billing-method').textContent = billingMethodTexts[currentLanguage][bill.billingMethod];

                    const currentReading = Math.floor(Math.random() * 50000 + 50000);
                    const previousReading = currentReading - bill.usage;
                    const readingText = currentLanguage === 'zh' ?
                        `ÔºàÂºÄÂßãÔºö${previousReading.toLocaleString()} ‚Äî ÁªìÊùüÔºö${currentReading.toLocaleString()}Ôºâ` :
                        `ÔºàStart: ${previousReading.toLocaleString()} ‚Äî End: ${currentReading.toLocaleString()}Ôºâ`;
                    document.getElementById('reading-detail').textContent = readingText;

                    // ÈáçÊñ∞ÁîüÊàêË¥πÁî®ÊòéÁªÜ
                    generateBillDetails(bill, month);
                }

                // Êõ¥Êñ∞Âä®ÊÄÅË°®Ê†ºÂÜÖÂÆπ
                if (window.currentDailyData) {
                    renderTableView(window.currentDailyData);
                    renderCalendarView(window.currentDailyData, month || '2025-09');
                }

                // ÈáçÊñ∞Ê∏≤ÊüìÂõæË°®‰ª•Êõ¥Êñ∞ËØ≠Ë®Ä
                if (window.currentTieredData) {
                    setTimeout(() => {
                        renderTieredChart(window.currentTieredData);
                    }, 100);
                }

                // Êõ¥Êñ∞Âè≥‰æßÊäΩÂ±âÂÜÖÂÆπÔºàÂ¶ÇÊûúÊúâÁöÑËØùÔºâ
                if (document.querySelector('.right-drawer')) {
                    const drawerTitle = document.querySelector('.drawer-title');
                    if (drawerTitle) {
                        const titleKey = drawerTitle.getAttribute('data-title-key');
                        if (titleKey) {
                            drawerTitle.textContent = currentLanguage === 'zh' ?
                                (titleKey === 'time-of-use' ? 'ÂàÜÊó∂Áîµ‰ª∑Êó•Áî®ÁîµËØ¶ÊÉÖ' : 'Èò∂Ê¢ØÁîµ‰ª∑Êó•Áî®ÁîµËØ¶ÊÉÖ') :
                                (titleKey === 'time-of-use' ? 'Time-of-Use Daily Details' : 'Tiered Pricing Daily Details');
                        }
                    }
                }

            });

            // Ëé∑ÂèñË¥¶ÂçïIDÂèÇÊï∞
            const billId = getUrlParameter('id');
            const month = getUrlParameter('month') || '2025-09';

            if (billId) {
                // Ê®°ÊãüËé∑ÂèñË¥¶ÂçïÊï∞ÊçÆÔºàÂÆûÈôÖÂ∫îËØ•‰ªéÂêéÁ´ØAPIËé∑ÂèñÔºâ
                // Âü∫‰∫éË¥¶ÂçïIDÁîüÊàêÂØπÂ∫îÁöÑË¥¶Âçï‰ø°ÊÅØ
                function generateBillDataById(id) {
                    const southStates = [
                        { region: 'tamil-nadu', names: ['Ravi Kumar', 'Priya Sharma', 'Arjun Patel', 'Deepika Singh'], avatars: ['R', 'P', 'A', 'D'] },
                        { region: 'karnataka', names: ['Manjunath Gowda', 'Kavitha Reddy', 'Sachin Joshi', 'Anitha Murthy'], avatars: ['M', 'K', 'S', 'A'] },
                        { region: 'andhra-pradesh', names: ['Venkat Rao', 'Lakshmi Devi', 'Suresh Babu', 'Padma Valli'], avatars: ['V', 'L', 'S', 'P'] },
                        { region: 'kerala', names: ['Ajay Nair', 'Meera Pillai', 'Rajesh Kumar', 'Nisha Thomas'], avatars: ['A', 'M', 'R', 'N'] }
                    ];

                    const businessTypes = ['residential', 'industrial', 'commercial', 'agricultural'];
                    const billingMethods = ['tiered', 'time-of-use'];

                    const idNum = parseInt(id) || 1;
                    const stateIndex = Math.floor((idNum - 1) / 8) % 4;
                    const businessIndex = Math.floor((idNum - 1) / 2) % 4;
                    const methodIndex = (idNum - 1) % 2;
                    const nameIndex = (businessIndex + methodIndex) % 4;

                    const state = southStates[stateIndex];
                    const businessType = businessTypes[businessIndex];
                    const billingMethod = billingMethods[methodIndex];
                    const usage = Math.floor(Math.random() * 800 + 150);
                    const baseRate = businessType === 'residential' ? 0.45 :
                                   businessType === 'commercial' ? 0.62 :
                                   businessType === 'industrial' ? 0.38 : 0.32;
                    const amount = usage * baseRate * (1 + Math.random() * 0.3);

                    return {
                        id: id,
                        userName: state.names[nameIndex],
                        userNameEn: state.names[nameIndex],
                        avatar: state.avatars[nameIndex],
                        usage: usage,
                        amount: parseFloat(amount.toFixed(2)),
                        region: state.region,
                        businessType: businessType,
                        billingMethod: billingMethod,
                        electricNumber: `${stateIndex + 1}${businessIndex + 1}${String(idNum).padStart(8, '0')}`
                    };
                }

                const mockBill = generateBillDataById(billId);

                // ‰øùÂ≠òÊï∞ÊçÆ‰æõËØ≠Ë®ÄÂàáÊç¢Êó∂‰ΩøÁî®
                window.currentBill = mockBill;
                window.currentMonth = month;

                // Â°´ÂÖÖÈ°µÈù¢Êï∞ÊçÆ
                const businessTypeTexts = {
                    zh: { residential: 'Â±ÖÊ∞ë', industrial: 'Â∑•‰∏ö', commercial: 'ÂïÜ‰∏ö', agricultural: 'ÂÜú‰∏ö' },
                    en: { residential: 'Residential', industrial: 'Industrial', commercial: 'Commercial', agricultural: 'Agricultural' }
                };

                const billingMethodTexts = {
                    zh: { tiered: 'Èò∂Ê¢ØÁîµË¥π', 'time-of-use': 'ÂàÜÊó∂Áîµ‰ª∑' },
                    en: { tiered: 'Tiered', 'time-of-use': 'Time-of-Use' }
                };

                // Â°´ÂÖÖÂü∫Êú¨‰ø°ÊÅØ
                document.getElementById('detail-username').textContent = currentLanguage === 'zh' ? mockBill.userName : mockBill.userNameEn;
                document.getElementById('header-business-type').textContent = businessTypeTexts[currentLanguage][mockBill.businessType];

                // Â°´ÂÖÖÈ°µÈù¢Â§¥ÈÉ®‰ø°ÊÅØ
                document.getElementById('header-electric-number').textContent = mockBill.electricNumber;
                document.getElementById('header-address').textContent = currentLanguage === 'zh' ? regionsData[mockBill.region].name : regionsData[mockBill.region].nameEn;

                // Â°´ÂÖÖË¥¶Êúü‰ø°ÊÅØ
                const monthText = currentLanguage === 'zh' ?
                    `${month.split('-')[0]}Âπ¥${parseInt(month.split('-')[1])}Êúà` :
                    new Date(month + '-01').toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                document.getElementById('detail-period').textContent = monthText;
                document.getElementById('detail-billing-method').textContent = billingMethodTexts[currentLanguage][mockBill.billingMethod];

                // ÁîüÊàêÊäÑË°®ËØªÊï∞ÔºàÊ®°ÊãüÊï∞ÊçÆÔºâ
                const currentReading = Math.floor(Math.random() * 50000 + 50000);
                const previousReading = currentReading - mockBill.usage;

                // Â°´ÂÖÖÁî®ÁîµÈáèÂíåÈáëÈ¢ù‰ø°ÊÅØÔºàÂàùÂßãÂÄºÔºåÂêéÁª≠‰ºöË¢´Ë¥πÁî®ËÆ°ÁÆóÊõ¥Êñ∞Ôºâ
                document.getElementById('detail-usage').textContent = `${mockBill.usage} kWh`;
                const readingText = currentLanguage === 'zh' ?
                    `ÔºàÂºÄÂßãÔºö${previousReading.toLocaleString()} ‚Äî ÁªìÊùüÔºö${currentReading.toLocaleString()}Ôºâ` :
                    `ÔºàStart: ${previousReading.toLocaleString()} ‚Äî End: ${currentReading.toLocaleString()}Ôºâ`;
                document.getElementById('reading-detail').textContent = readingText;
                document.getElementById('detail-amount').textContent = `‚Çπ${mockBill.amount.toFixed(0)}`;

                // ÁîüÊàêËØ¶ÁªÜÊï∞ÊçÆ
                generateBillDetails(mockBill, month);

                // ÁîüÊàêÊØèÊó•Áî®ÁîµÈáèÊï∞ÊçÆ
                const dailyUsageData = generateDailyUsageData(month, mockBill.usage);

                // ‰øùÂ≠òÊï∞ÊçÆ‰æõËØ≠Ë®ÄÂàáÊç¢Êó∂‰ΩøÁî®
                window.currentDailyData = dailyUsageData;

                // ÂàùÂßãÂåñÊØèÊó•Áî®ÁîµÈáèËßÜÂõæ
                renderTableView(dailyUsageData);
                renderCalendarView(dailyUsageData, month);
                renderChartView(dailyUsageData);

                // ÁªëÂÆöËßÜÂõæÂàáÊç¢‰∫ã‰ª∂
                document.querySelectorAll('.view-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        switchView(btn.dataset.view);
                        if (btn.dataset.view === 'chart') {
                            // ÈáçÊñ∞ÁªòÂà∂ÂõæË°®‰ª•Á°Æ‰øùÊ≠£Á°ÆÂ∞∫ÂØ∏
                            setTimeout(() => renderChartView(dailyUsageData), 100);
                        }
                    });
                });


            } else {
                EnergySystem.showNotification('Êú™ÊâæÂà∞Ë¥¶Âçï‰ø°ÊÅØ', 'error');
                setTimeout(() => {
                    window.location.href = 'bills.html';
                }, 2000);
            }

        });
    </script>

    <style>
        /* È°µÈù¢Â§¥ÈÉ®Ê†∑Âºè */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-8);
            gap: var(--space-6);
        }

        .header-left {
            display: flex;
            align-items: flex-start;
            gap: var(--space-4);
        }

        .header-title-section {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-1);
        }

        .header-title-section h2 {
            font-size: 28px;
            font-weight: var(--font-weight-medium);
            margin: 0;
        }

        .user-name-header {
            font-size: 28px;
            font-weight: var(--font-weight-medium);
            color: var(--text-primary);
        }

        .header-info {
            display: flex;
            gap: var(--space-6);
            margin-top: var(--space-3);
        }

        .header-info-item {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .info-label {
            font-size: 14px;
            font-weight: var(--font-weight-medium);
            color: var(--text-secondary);
        }

        .info-value {
            font-size: 15px;
            font-weight: var(--font-weight-medium);
            color: var(--text-primary);
        }

        .header-actions {
            display: flex;
            gap: var(--space-3);
        }

        /* Ë¥¶ÂçïÊ¶ÇË¶ÅÂç°Áâá */
        .bill-summary {
            margin-bottom: var(--space-8);
            padding: var(--space-6);
            background: var(--background);
            border: var(--border);
            border-radius: var(--radius);
        }

        .info-horizontal {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .info-pair {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            flex: 1;
            justify-content: center;
        }

        .info-pair .label {
            font-size: 16px;
            font-weight: var(--font-weight-medium);
            color: var(--text-secondary);
        }

        .info-pair .value {
            font-size: 16px;
            font-weight: var(--font-weight-semibold);
            color: var(--text-primary);
        }

        .info-pair .value.amount {
            font-size: 20px;
            color: var(--primary);
            font-family: 'Monaco', 'Courier New', monospace;
        }

        .usage-detail {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-1);
        }

        .reading-info {
            font-size: 12px;
            color: var(--text-tertiary);
            font-weight: var(--font-weight-regular);
        }


        /* ËØ¶ÁªÜ‰ø°ÊÅØÁΩëÊ†ºÂ∏ÉÂ±Ä */
        .details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-8);
            margin-bottom: var(--space-8);
        }

        /* Èò∂Ê¢ØÊî∂Ë¥πÂíåË¥πÁî®ÊòéÁªÜË°®Ê†º */
        .pricing-section,
        .cost-breakdown-section {
            background: var(--background);
            border: var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .section-header {
            padding: var(--space-5);
            background: var(--surface);
            border-bottom: var(--border);
        }

        .section-header h4 {
            margin: 0;
            font-size: 18px;
            font-weight: var(--font-weight-medium);
        }

        .pricing-table-container,
        .cost-table-container {
            padding: var(--space-5);
        }

        .pricing-table,
        .cost-table {
            border: var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .pricing-header,
        .cost-header {
            display: grid;
            gap: var(--space-3);
            background: var(--divider);
            padding: var(--space-4);
            font-weight: var(--font-weight-semibold);
            font-size: 14px;
            color: var(--text-primary);
        }

        .pricing-header {
            grid-template-columns: 1.5fr 1fr 1fr 1fr 1fr;
        }

        .cost-header {
            grid-template-columns: 2fr 1fr 2fr;
        }

        .pricing-body,
        .cost-body {
            max-height: none;
        }

        .pricing-row,
        .cost-row {
            display: grid;
            gap: var(--space-3);
            padding: var(--space-4);
            border-bottom: var(--border);
            font-size: 14px;
            transition: all 0.15s ease;
        }

        .pricing-row {
            grid-template-columns: 1.5fr 1fr 1fr 1fr 1fr;
        }

        .cost-row {
            grid-template-columns: 2fr 1fr 2fr;
        }

        .pricing-row:last-child,
        .cost-row:last-child {
            border-bottom: none;
        }

        .pricing-row.used {
            background: rgba(40, 167, 69, 0.05);
            border-left: 4px solid var(--success);
        }

        .pricing-row.unused {
            background: var(--surface);
            opacity: 0.6;
        }

        .cost-row {
            background: var(--background);
        }

        .cost-row:nth-child(even) {
            background: var(--surface);
        }

        .pricing-total,
        .cost-total {
            display: grid;
            gap: var(--space-3);
            padding: var(--space-4);
            background: var(--primary);
            color: white;
            font-weight: var(--font-weight-semibold);
        }

        .pricing-total {
            grid-template-columns: 2fr 1fr;
        }

        .cost-total {
            grid-template-columns: 2fr 1fr 2fr;
        }

        .pricing-total .total-label {
            grid-column: 1;
            text-align: right;
        }

        .cost-total .final-label {
            font-size: 16px;
        }

        .cost-total .final-amount {
            font-size: 18px;
            font-weight: var(--font-weight-bold);
        }

        .cost-total .final-desc {
            font-size: 13px;
            opacity: 0.9;
        }

        .tier-name,
        .cost-item {
            font-weight: var(--font-weight-medium);
        }

        .tier-rate,
        .tier-amount,
        .cost-amount {
            font-family: 'Monaco', 'Courier New', monospace;
            text-align: right;
        }

        .tier-usage {
            text-align: center;
        }

        .cost-desc {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* ÊØèÊó•Áî®ÁîµÈáèËØ¶ÁªÜ‰ø°ÊÅØÊ†∑Âºè */
        .daily-usage-section {
            margin-top: var(--space-6);
            padding-top: var(--space-6);
            border-top: var(--border);
        }

        .daily-usage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-5);
        }

        .daily-usage-header h5 {
            margin: 0;
            font-size: 16px;
            font-weight: var(--font-weight-medium);
            color: var(--text-primary);
        }

        /* ËßÜÂõæÂàáÊç¢ÊåâÈíÆ */
        .view-controls {
            display: flex;
            background: var(--surface);
            border-radius: var(--radius);
            padding: 2px;
            gap: 2px;
        }

        .view-btn {
            padding: var(--space-2) var(--space-3);
            border: none;
            background: transparent;
            border-radius: calc(var(--radius) - 2px);
            font-family: inherit;
            font-weight: var(--font-weight-medium);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.15s ease;
            color: var(--text-secondary);
        }

        .view-btn.active {
            background: var(--background);
            color: var(--text-primary);
            box-shadow: var(--shadow);
        }

        /* ËßÜÂõæÂÆπÂô® */
        .usage-view {
            display: none;
        }

        .usage-view.active {
            display: block;
        }

        /* Ë°®Ê†ºËßÜÂõæÊ†∑Âºè */
        .daily-table {
            border: var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            margin-top: var(--space-4);
        }

        .daily-table-header {
            display: grid;
            grid-template-columns: 1fr 1.2fr 1.2fr 1.2fr 1fr;
            gap: var(--space-3);
            background: var(--divider);
            padding: var(--space-3) var(--space-4);
            font-weight: var(--font-weight-semibold);
            font-size: 13px;
            color: var(--text-primary);
        }

        .daily-table-body {
            max-height: 300px;
            overflow-y: auto;
        }

        .daily-table-row {
            display: grid;
            grid-template-columns: 1fr 1.2fr 1.2fr 1.2fr 1fr;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-4);
            border-bottom: var(--border);
            font-size: 14px;
            transition: all 0.15s ease;
        }

        .daily-table-row:hover {
            background: var(--surface);
        }

        .daily-table-row:last-child {
            border-bottom: none;
        }

        .usage-cell,
        .peak-cell,
        .offpeak-cell {
            text-align: center;
            font-family: 'Monaco', 'Courier New', monospace;
        }

        .cost-cell {
            text-align: right;
            font-family: 'Monaco', 'Courier New', monospace;
            font-weight: var(--font-weight-medium);
        }

        /* Êó•ÂéÜËßÜÂõæÊ†∑Âºè */
        .calendar-container {
            margin-top: var(--space-4);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
            padding: 0 var(--space-2);
        }

        .calendar-header h6 {
            margin: 0;
            font-size: 16px;
            font-weight: var(--font-weight-medium);
        }

        .calendar-nav {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--surface);
            border-radius: 50%;
            font-size: 16px;
            font-weight: bold;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-nav:hover {
            background: var(--primary);
            color: white;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: var(--divider);
            padding: 2px;
            border-radius: var(--radius);
        }

        .calendar-weekday {
            background: var(--surface);
            padding: var(--space-2);
            text-align: center;
            font-weight: var(--font-weight-semibold);
            font-size: 12px;
            color: var(--text-secondary);
        }

        .calendar-day {
            background: var(--background);
            padding: var(--space-2);
            min-height: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
        }

        .calendar-day:hover {
            background: var(--surface);
        }

        .calendar-day.empty {
            background: var(--divider);
            cursor: default;
        }

        .calendar-day.empty:hover {
            background: var(--divider);
        }

        .calendar-day {
            position: relative;
        }

        .day-number {
            position: absolute;
            top: 4px;
            left: 4px;
            font-size: 10px;
            font-weight: var(--font-weight-medium);
            color: var(--text-secondary);
            z-index: 1;
        }

        .day-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 2px;
        }

        .day-unit {
            font-size: 9px;
            font-weight: var(--font-weight-regular);
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .day-usage-value {
            font-size: 18px;
            font-weight: var(--font-weight-semibold);
            color: var(--text-primary);
            font-family: 'Monaco', 'Courier New', monospace;
            line-height: 1;
        }

        /* Áî®ÁîµÈáèÊ†áËÆ∞Ê†∑Âºè */
        .usage-marker {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 8px;
            font-weight: var(--font-weight-semibold);
            padding: 1px 3px;
            border-radius: 2px;
            line-height: 1;
        }

        .high-marker {
            background: var(--error);
            color: white;
        }

        .low-marker {
            background: var(--info);
            color: white;
        }

        /* Â±ïÂºÄÊåáÁ§∫Âô® */

        /* ÊØèÂ∞èÊó∂Êï∞ÊçÆË°®Ê†º */
        .hourly-table-header {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
            gap: var(--space-2);
            padding: var(--space-3);
            background: var(--surface);
            border-radius: var(--radius);
            font-weight: var(--font-weight-medium);
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: var(--space-3);
        }

        /* ÊØèÂ∞èÊó∂Êï∞ÊçÆÈ°π */
        .hourly-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--space-2);
        }

        .hourly-item {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
            gap: var(--space-2);
            padding: var(--space-3);
            background: var(--background);
            border-radius: var(--radius);
            font-size: 13px;
            border-left: 3px solid;
        }

        .hourly-item.peak {
            border-left-color: var(--error);
            background: rgba(220, 53, 69, 0.02);
        }

        .hourly-item.standard {
            border-left-color: var(--accent);
            background: rgba(0, 102, 204, 0.02);
        }

        .hourly-item.valley {
            border-left-color: var(--success);
            background: rgba(40, 167, 69, 0.02);
        }

        .hour-time {
            font-weight: var(--font-weight-medium);
        }

        .hour-period {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .hour-usage {
            font-weight: var(--font-weight-medium);
        }

        .hour-rate,
        .hour-cost {
            text-align: right;
        }

        /* Âè≥‰æßÊäΩÂ±âÊ†∑Âºè */
        .right-drawer {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            /* ÈöîÁ¶ªÊªöÂä®‰∫ã‰ª∂ */
            overflow: hidden;
        }

        .right-drawer.show {
            opacity: 1;
            visibility: visible;
        }

        .right-drawer.hide {
            opacity: 0;
            visibility: hidden;
        }

        .drawer-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .drawer-content {
            position: absolute;
            top: 0;
            right: 0;
            width: 800px;
            height: 100%;
            background: var(--background);
            box-shadow: -4px 0 24px rgba(0, 0, 0, 0.1);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* ÂéªÊéâ‰∏ªÊäΩÂ±âÊªöÂä®Êù° */
            /* ÈòªÊ≠¢ÊªöÂä®‰∫ã‰ª∂ÂÜíÊ≥°Âà∞‰∏ªÈ°µÈù¢ */
            overscroll-behavior: contain;
        }

        .right-drawer.show .drawer-content {
            transform: translateX(0);
        }

        .drawer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-6);
            border-bottom: var(--border);
            flex-shrink: 0;
        }

        .drawer-header h3 {
            font-size: 20px;
            font-weight: var(--font-weight-medium);
            margin: 0;
        }

        .drawer-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: var(--space-2);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .drawer-close:hover {
            background: var(--surface);
        }

        .drawer-body {
            flex: 1;
            padding: var(--space-6);
            overflow: hidden; /* ÂéªÊéâÊäΩÂ±â‰∏ª‰ΩìÊªöÂä®Êù° */
        }


        .drawer-pricing-section {
            margin-bottom: var(--space-8);
        }

        .drawer-pricing-section h4 {
            font-size: 18px;
            font-weight: var(--font-weight-medium);
            margin: 0 0 var(--space-4) 0;
        }

        .drawer-time-pricing-summary {
            border: var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .drawer-summary-header {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr 1fr;
            gap: var(--space-3);
            background: var(--surface);
            padding: var(--space-4);
            font-weight: var(--font-weight-medium);
            font-size: 14px;
            color: var(--text-secondary);
        }

        .drawer-time-pricing-body {
            background: var(--background);
        }

        .drawer-time-pricing-body .time-pricing-row {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr 1fr;
            gap: var(--space-3);
            padding: var(--space-4);
            border-bottom: var(--border);
            font-size: 14px;
        }

        .drawer-time-pricing-body .time-pricing-row:last-child {
            border-bottom: none;
        }

        .drawer-pricing-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-4);
            background: var(--surface);
            font-weight: var(--font-weight-medium);
            font-size: 16px;
        }

        .drawer-explanation {
            margin-bottom: var(--space-8);
        }

        .drawer-explanation h4 {
            font-size: 18px;
            font-weight: var(--font-weight-medium);
            margin: 0 0 var(--space-4) 0;
        }

        .drawer-period-details {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }

        .drawer-period-item {
            background: var(--surface);
            padding: var(--space-5);
            border-radius: var(--radius);
            border-left: 4px solid;
        }

        .drawer-period-item.peak {
            border-left-color: var(--error);
        }

        .drawer-period-item.standard {
            border-left-color: var(--accent);
        }

        .drawer-period-item.valley {
            border-left-color: var(--success);
        }

        .drawer-period-item h5 {
            font-size: 16px;
            font-weight: var(--font-weight-medium);
            margin: 0 0 var(--space-2) 0;
        }

        .drawer-period-item p {
            margin: var(--space-1) 0;
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.5;
        }

        .drawer-billing-info h4 {
            font-size: 18px;
            font-weight: var(--font-weight-medium);
            margin: 0 0 var(--space-4) 0;
        }

        .drawer-billing-info ul {
            margin: 0;
            padding-left: var(--space-5);
        }

        .drawer-billing-info li {
            margin-bottom: var(--space-2);
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.5;
        }

        /* ÊäΩÂ±âÊ®°ÂùóÊ†∑Âºè */
        .drawer-usage-module {
            height: 100%;
            overflow: hidden; /* ÂéªÊéâÊ®°ÂùóÊªöÂä®Êù° */
        }

        .drawer-module-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
        }

        .drawer-module-title h3 {
            font-size: 20px;
            font-weight: var(--font-weight-medium);
            margin: 0;
        }

        .drawer-export-btn {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-4);
            background: var(--surface);
            border: var(--border);
            border-radius: var(--radius);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .drawer-export-btn:hover {
            background: var(--divider);
        }

        .drawer-module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-6);
            border-bottom: var(--border);
            margin-top: -20px; /* ‰∏äÁßª20ÂÉèÁ¥† */
        }

        .drawer-header-left {
            display: flex;
            align-items: center;
        }

        .drawer-header-right {
            display: flex;
            align-items: center;
        }

        .drawer-view-tabs {
            display: flex;
            gap: var(--space-2);
            background: var(--surface);
            border-radius: var(--radius);
            padding: var(--space-1);
        }

        .drawer-tab-btn {
            flex: 1;
            padding: var(--space-2) var(--space-3);
            border: none;
            background: transparent;
            border-radius: 50px; /* ÊúÄÂ§ßÂúÜËßí */
            font-size: 14px;
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all 0.15s ease;
            color: var(--text-secondary);
        }

        .drawer-tab-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow);
        }

        .drawer-usage-view {
            display: none;
            overflow: hidden; /* ÂéªÊéâËßÜÂõæÊªöÂä®Êù° */
        }

        .drawer-usage-view.active {
            display: block;
            overflow: hidden; /* ÂéªÊéâÊøÄÊ¥ªËßÜÂõæÊªöÂä®Êù° */
        }

        /* ÊäΩÂ±âË°®Ê†ºÊ†∑Âºè */
        .drawer-daily-table {
            border: var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .drawer-daily-table-header {
            display: grid;
            grid-template-columns: 1fr 1.2fr 1fr 30px;
            gap: var(--space-3);
            background: var(--surface);
            padding: var(--space-4);
            font-weight: var(--font-weight-medium);
            font-size: 14px;
            color: var(--text-secondary);
        }

        .drawer-daily-table-body {
            max-height: 550px; /* Âõ∫ÂÆöÈ´òÂ∫¶ÔºåÊòæÁ§∫Á∫¶10Â§©Êï∞ÊçÆÔºåÂÖ∂‰ΩôÈÄöËøáÊªöÂä®Êü•ÁúãÂÖ®ÈÉ®30Â§© */
            overflow-y: auto; /* ÊªöÂä®Êü•ÁúãÊâÄÊúâÊï∞ÊçÆ */
        }

        /* Â±ïÂºÄÁä∂ÊÄÅ‰∏ãÁöÑË°®Ê†ºÈ´òÂ∫¶ */
        .right-drawer.expanded .drawer-daily-table-body {
            max-height: 550px; /* Â±ïÂºÄÊó∂Áª¥ÊåÅÂõ∫ÂÆöÈ´òÂ∫¶ÔºåÈÄöËøáÊªöÂä®Êü•ÁúãÂÖ®ÈÉ®30Â§©Êï∞ÊçÆ */
        }

        .drawer-daily-table-row {
            display: grid;
            grid-template-columns: 1fr 1.2fr 1fr 30px;
            gap: var(--space-3);
            padding: var(--space-4);
            border-bottom: var(--border);
            font-size: 14px;
        }

        /* Èò∂Ê¢ØÁîµ‰ª∑Ë°®Ê†ºÁâπÂÆöÊ†∑Âºè - 5ÂàóÂ∏ÉÂ±Ä */
        #tiered-drawer-table-header {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 30px;
            gap: var(--space-3);
            background: var(--surface);
            padding: var(--space-4);
            font-weight: var(--font-weight-medium);
            font-size: 14px;
            color: var(--text-secondary);
        }

        #tiered-drawer-table-body .drawer-daily-table-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 30px;
            gap: var(--space-3);
            padding: var(--space-4);
            border-bottom: var(--border);
            font-size: 14px;
        }

        .drawer-expand-icon {
            font-size: 14px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.15s ease;
            font-weight: bold;
        }

        .drawer-daily-table-row:hover {
            background: var(--surface);
        }

        .drawer-daily-table-row:last-child {
            border-bottom: none;
        }

        /* ÊäΩÂ±âÊó•ÂéÜÊ†∑Âºè */
        .drawer-calendar-container {
            background: var(--background);
            border: var(--border);
            border-radius: var(--radius);
            padding: var(--space-6);
            box-shadow: var(--shadow);
            /* ÁßªÈô§È´òÂ∫¶ÈôêÂà∂ÔºåËÆ©Êó•ÂéÜÂÆåÊï¥ÊòæÁ§∫ */
        }

        /* ÊäΩÂ±âÊâ©Â±ïÂäüËÉΩ */
        .right-drawer {
            transition: all 0.3s ease;
        }

        .right-drawer.expanded .drawer-content {
            width: 1150px; /* Êó•ÂéÜ600px + ËØ¶ÊÉÖ500px + Èó¥Èöô50px */
            max-width: 90vw;
        }

        .right-drawer.expanded .drawer-usage-view.active {
            display: flex;
            gap: var(--space-6);
        }

        .right-drawer.expanded .drawer-calendar-container,
        .right-drawer.expanded .drawer-table-container {
            flex: 0 0 auto;
            width: 600px; /* Âõ∫ÂÆöÂÆΩÂ∫¶Ôºå‰øùÊåÅÂéüÊù•Â§ßÂ∞è */
            height: 100%; /* Á°Æ‰øùÂÆπÂô®ÊúâË∂≥Â§üÈ´òÂ∫¶ */
        }

        /* Âè™ÊúâÊøÄÊ¥ªÁöÑËßÜÂõæÊâçÊòæÁ§∫ */

        /* ËßÜÂõæÂ±ïÂºÄÊó∂ÁöÑÁâπÊÆäÊ†∑Âºè - Âè™ÂØπÊøÄÊ¥ªÁöÑËßÜÂõæÂ∫îÁî®flexÂ∏ÉÂ±Ä */
        .right-drawer.expanded #drawer-table-view.active,
        .right-drawer.expanded #drawer-calendar-view.active,
        .right-drawer.expanded #tiered-drawer-table-view.active,
        .right-drawer.expanded #tiered-drawer-calendar-view.active {
            display: flex !important;
            gap: var(--space-6);
        }

        /* ÊØèÂ∞èÊó∂ËØ¶ÊÉÖÈù¢Êùø */
        .drawer-hourly-details-panel {
            flex: 0 0 auto;
            width: 500px; /* Âõ∫ÂÆöÂÆΩÂ∫¶ÁöÑËØ¶ÊÉÖÈù¢Êùø */
            background: var(--background);
            border: var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            height: fit-content;
            align-self: flex-start;
        }

        .drawer-hourly-header {
            padding: var(--space-4) var(--space-6);
            border-bottom: var(--border);
            background: var(--surface);
            border-radius: var(--radius) var(--radius) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .drawer-hourly-header h4 {
            margin: 0;
            font-size: 16px;
            font-weight: var(--font-weight-medium);
        }

        .drawer-hourly-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.15s ease;
        }

        .drawer-hourly-close:hover {
            background: var(--divider);
            color: var(--text-primary);
        }

        .drawer-hourly-content {
            padding: var(--space-6);
            max-height: 500px;
            overflow-y: auto; /* ÊÅ¢Â§çÊØèÂ∞èÊó∂ËØ¶ÊÉÖÊªöÂä®Êù° */
        }

        /* ÁÆÄÂçïË°®Ê†ºÊ†∑Âºè */
        .simple-hourly-table {
            width: 100%;
            border-collapse: collapse;
        }

        .simple-hourly-table th {
            background: #f5f5f5;
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
            font-weight: bold;
        }

        .simple-hourly-table td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }

        .simple-hourly-table tr:hover {
            background: #f9f9f9;
        }

        .merged-period {
            text-align: center;
            vertical-align: middle;
            font-weight: bold;
        }

        /* Êó∂ÊÆµÈ¢úËâ≤Âå∫ÂàÜ - ‰∏éÂü∫Á°ÄÁîµË¥πË°®Ê†ºÈ¢úËâ≤‰øùÊåÅ‰∏ÄËá¥ */
        .peak-hour {
            background: rgba(220, 53, 69, 0.05);
        }

        .peak-hour .merged-period {
            background: rgba(220, 53, 69, 0.1);
            border-left: 3px solid #dc3545;
            color: #dc3545;
        }

        .standard-hour {
            background: rgba(0, 102, 204, 0.05);
        }

        .standard-hour .merged-period {
            background: rgba(0, 102, 204, 0.1);
            border-left: 3px solid #0066cc;
            color: #0066cc;
        }

        .valley-hour {
            background: rgba(40, 167, 69, 0.05);
        }

        .valley-hour .merged-period {
            background: rgba(40, 167, 69, 0.1);
            border-left: 3px solid #28a745;
            color: #28a745;
        }

        /* Êó∂ÊÆµÂàÜÈöîÊ†áÈ¢ò */
        .drawer-period-separator {
            background: var(--surface);
            padding: var(--space-2) var(--space-3);
            margin: var(--space-2) 0;
            border-radius: var(--radius);
            border-left: 3px solid var(--accent);
        }

        .period-title {
            font-weight: var(--font-weight-medium);
            font-size: 14px;
            color: var(--text-primary);
        }

        /* ÊäΩÂ±âÊó•ÂéÜÈÄâ‰∏≠Áä∂ÊÄÅ - ÈªëËâ≤ */
        .drawer-calendar-day.selected,
        #tiered-drawer-calendar-grid .drawer-calendar-day.selected {
            background: #000000 !important;
            color: white !important;
            transform: scale(1.05);
            border: 2px solid #0066CC !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
            z-index: 10;
            position: relative;
        }

        .drawer-calendar-day.selected .drawer-day-content {
            color: white !important;
        }

        .drawer-calendar-day.selected .drawer-day-number {
            color: white !important;
            font-weight: bold;
        }

        .drawer-calendar-day.selected .drawer-day-usage-value {
            color: white !important;
        }

        .drawer-calendar-day.selected .drawer-day-unit {
            color: white !important;
        }

        /* Á°Æ‰øùÈÄâ‰∏≠Áä∂ÊÄÅ‰∏ãÊâÄÊúâÂ≠êÂÖÉÁ¥†ÈÉΩÊòØÁôΩËâ≤ */
        .drawer-calendar-day.selected * {
            color: white !important;
        }

        /* ÈÄâ‰∏≠Áä∂ÊÄÅ‰∏ãÁöÑÊ†áËÆ∞ÁÇπ‰πüË¶ÅÊòæÁ§∫‰∏∫ÁôΩËâ≤ */
        .drawer-calendar-day.selected .drawer-max-marker {
            color: white !important;
        }

        /* ÁâπÂà´‰∏∫Èò∂Ê¢ØÁîµ‰ª∑Êó•ÂéÜÂ¢ûÂä†ÈÄâ‰∏≠Áä∂ÊÄÅ */
        #tiered-drawer-calendar-grid .drawer-calendar-day.selected {
            background: #000000 !important;
            color: white !important;
            transform: scale(1.05) !important;
            border: 2px solid #0066CC !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
            z-index: 10 !important;
            position: relative !important;
        }
        #tiered-drawer-calendar-grid .drawer-calendar-day.selected * {
            color: white !important;
        }

        /* Â∞èÂ∞∫ÂØ∏ÈªëËâ≤ÊåâÈíÆÊ†∑Âºè */
        .btn-primary-small {
            background: #000000;
            color: white;
            border: none;
            padding: var(--space-1) var(--space-2);
            border-radius: calc(var(--radius) / 2);
            font-size: 11px;
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all 0.15s ease;
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
        }

        .btn-primary-small:hover {
            background: #333333;
            transform: translateY(-1px);
        }

        .drawer-calendar-day {
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .drawer-calendar-day:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .drawer-calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-6);
            padding-bottom: var(--space-4);
            border-bottom: var(--border);
        }

        .drawer-calendar-title-wrapper {
            text-align: center;
            flex: 1;
        }

        .drawer-calendar-title-wrapper h3 {
            margin: 0 0 var(--space-1) 0;
            font-size: 20px;
            font-weight: var(--font-weight-medium);
            color: var(--text-primary);
        }

        .drawer-calendar-subtitle {
            margin: 0;
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: var(--font-weight-regular);
        }

        .drawer-calendar-nav {
            background: var(--surface);
            border: var(--border);
            border-radius: var(--radius);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-secondary);
        }

        .drawer-calendar-nav:hover {
            background: var(--divider);
            color: var(--text-primary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-hover);
        }

        .drawer-calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: var(--space-2);
            margin-bottom: var(--space-2); /* ÂáèÂ∞èÈó¥Ë∑ù */
        }

        .drawer-weekday {
            text-align: center;
            font-size: 12px;
            font-weight: var(--font-weight-semibold);
            color: var(--text-secondary);
            padding: var(--space-2);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }


        .drawer-calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: var(--border);
            border-radius: var(--radius);
            background: var(--surface);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            min-height: 50px; /* ÈÄÇ‰∏≠È´òÂ∫¶Á°Æ‰øùÂÜÖÂÆπÂèØËßÅ */
        }

        .drawer-calendar-day:hover {
            background: var(--divider);
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .drawer-calendar-day.today {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .drawer-calendar-day.today:hover {
            background: #0052A3;
        }

        .drawer-calendar-day.other-month {
            color: var(--text-tertiary);
            background: transparent;
        }

        .drawer-calendar-day.other-month:hover {
            background: var(--surface);
        }

        /* Êó•ÂéÜÂàáÊç¢Êéß‰ª∂Ê†∑Âºè */
        .calendar-controls {
            margin-bottom: var(--space-4);
        }

        .calendar-toggle {
            display: flex;
            background: var(--surface);
            border-radius: var(--radius);
            padding: var(--space-1);
            width: fit-content;
        }

        .calendar-toggle-btn {
            padding: var(--space-2) var(--space-4);
            border: none;
            background: transparent;
            border-radius: calc(var(--radius) - 2px);
            font-size: 14px;
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all 0.15s ease;
            color: var(--text-secondary);
        }

        .calendar-toggle-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow);
        }

        /* ÊäΩÂ±âÊó•ÂéÜÂàáÊç¢Êéß‰ª∂Ê†∑Âºè */
        .drawer-calendar-controls {
            margin-bottom: var(--space-4);
        }

        .drawer-calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-3); /* ÂáèÂ∞èÈó¥Ë∑ù */
        }

        .drawer-calendar-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: var(--font-weight-medium);
        }


        /* ÊäΩÂ±âË°®Ê†ºÈÄâ‰∏≠Êó•ÊúüÊ†∑Âºè */
        .selected-day-row {
            background: rgba(0, 102, 204, 0.1) !important;
            font-weight: var(--font-weight-medium);
        }

        /* Ë°®Ê†ºË°åÈÄâ‰∏≠Áä∂ÊÄÅ */
        .drawer-daily-table-row.selected {
            background: #000000 !important;
            color: white !important;
            transform: scale(1.02);
        }

        .drawer-daily-table-row.selected span {
            color: white !important;
        }

        .drawer-daily-table-row {
            transition: all 0.2s ease;
        }

        .drawer-daily-table-row:hover {
            background: var(--surface);
            transform: translateY(-1px);
        }

        .drawer-hourly-details-row {
            display: none;
            padding: var(--space-4);
            background: var(--surface);
            border-top: var(--border);
        }

        .drawer-hourly-details-row.expanded {
            display: block;
        }

        .drawer-hourly-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: var(--space-2);
            max-height: 300px;
            overflow-y: auto;
            border: var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .hourly-header {
            display: contents;
            font-weight: var(--font-weight-semibold);
            background: var(--surface);
        }

        .hourly-header span {
            background: var(--surface);
            border-bottom: 2px solid var(--divider) !important;
        }

        .hourly-item {
            display: contents;
        }

        .hourly-item span {
            padding: var(--space-2);
            border-bottom: 1px solid var(--divider);
            font-size: 13px;
        }

        .hour-time {
            font-weight: var(--font-weight-medium);
        }

        .hour-period {
            text-align: center;
        }

        .hour-usage,
        .hour-rate,
        .hour-cost {
            text-align: right;
        }

        .drawer-calendar-toggle {
            display: flex;
            background: var(--surface);
            border-radius: var(--radius);
            padding: var(--space-1);
            width: fit-content;
        }

        .drawer-calendar-toggle-btn {
            padding: var(--space-2) var(--space-3);
            border: none;
            background: transparent;
            border-radius: calc(var(--radius) - 2px);
            font-size: 13px;
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all 0.15s ease;
            color: var(--text-secondary);
        }

        .drawer-calendar-toggle-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow);
        }

        /* ÊúÄÈ´òÂÄºÊ†áËÆ∞ÁÇπÊ†∑Âºè */
        .max-marker {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 8px;
            z-index: 2;
        }

        .max-marker.usage-max {
            color: #FF6B35; /* Áî®ÁîµÈáèÊúÄÈ´ò - Ê©ôËâ≤ */
        }

        .max-marker.cost-max {
            color: #E74C3C; /* Ë¥πÁî®ÊúÄÈ´ò - Á∫¢Ëâ≤ */
        }

        .drawer-max-marker {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 6px;
            z-index: 2;
        }

        .drawer-max-marker.usage-max {
            color: #FF6B35; /* Áî®ÁîµÈáèÊúÄÈ´ò - Ê©ôËâ≤ */
        }

        .drawer-max-marker.cost-max {
            color: #E74C3C; /* Ë¥πÁî®ÊúÄÈ´ò - Á∫¢Ëâ≤ */
        }

        /* Êó•ÂéÜÂ∑¶Âè≥Â∏ÉÂ±Ä */
        .calendar-layout {
            display: flex;
            gap: var(--space-8);
            height: 600px;
        }

        .calendar-left {
            flex: 1;
            min-width: 0;
        }

        .calendar-right {
            width: 400px;
            flex-shrink: 0;
        }

        .calendar-day.selected {
            background: var(--accent);
            color: white;
        }

        .calendar-day.selected .day-number,
        .calendar-day.selected .day-usage-value,
        .calendar-day.selected .day-unit {
            color: white;
        }

        .calendar-day.selected .max-marker {
            color: rgba(255, 255, 255, 0.8);
        }

        /* Âè≥‰æßÊØèÂ∞èÊó∂ËØ¶ÊÉÖÈù¢Êùø */
        .hourly-details-panel {
            background: var(--background);
            border: var(--border);
            border-radius: var(--radius);
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .hourly-details-header {
            padding: var(--space-6);
            border-bottom: var(--border);
        }

        .hourly-details-header h4 {
            font-size: 18px;
            font-weight: var(--font-weight-medium);
            margin: 0;
        }

        .hourly-details-content {
            flex: 1;
            overflow-y: auto;
        }

        .drawer-calendar-day {
            position: relative;
        }

        .drawer-day-number {
            position: absolute;
            top: 3px;
            left: 3px;
            font-size: 9px;
            font-weight: var(--font-weight-medium);
            color: var(--text-secondary);
            z-index: 1;
        }

        .drawer-day-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 2px;
        }

        .drawer-day-unit {
            font-size: 8px;
            font-weight: var(--font-weight-regular);
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .drawer-day-usage-value {
            font-size: 16px;
            font-weight: var(--font-weight-semibold);
            color: var(--text-primary);
            font-family: 'Monaco', 'Courier New', monospace;
            line-height: 1;
        }

        .drawer-calendar-day.today .drawer-day-number {
            color: rgba(255, 255, 255, 0.8);
        }

        .drawer-calendar-day.today .drawer-day-unit {
            color: rgba(255, 255, 255, 0.6);
        }

        .drawer-calendar-day.today .drawer-day-usage-value {
            color: rgba(255, 255, 255, 0.95);
        }


        .drawer-calendar-legend {
            display: flex;
            justify-content: center;
            gap: var(--space-6);
            padding-top: var(--space-4);
            border-top: var(--border);
        }

        .drawer-calendar-legend .legend-item {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: 12px;
            color: var(--text-secondary);
        }

        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .legend-dot.low-usage {
            background: var(--success);
        }

        .legend-dot.medium-usage {
            background: var(--warning);
        }

        .legend-dot.high-usage {
            background: var(--error);
        }

        /* Èò∂Ê¢ØÁîµ‰ª∑Áõ∏ÂÖ≥Ê†∑Âºè */
        .legend-dot.tier-1 {
            background: #28A745; /* ÁªøËâ≤ - Èò∂Ê¢Ø1 */
        }

        .legend-dot.tier-2 {
            background: #FFC107; /* ÈªÑËâ≤ - Èò∂Ê¢Ø2 */
        }

        .legend-dot.tier-3 {
            background: #FF9500; /* Ê©ôËâ≤ - Èò∂Ê¢Ø3 */
        }

        .legend-dot.tier-4 {
            background: #DC3545; /* Á∫¢Ëâ≤ - Èò∂Ê¢Ø4 */
        }

        /* Èò∂Ê¢ØÁîµ‰ª∑Êó•ÂéÜÂ§©Êï∞Ê†∑Âºè */
        .drawer-calendar-day.tier-1 {
            background: rgba(40, 167, 69, 0.1);
            border-left: 3px solid #28A745;
        }

        .drawer-calendar-day.tier-2 {
            background: rgba(255, 193, 7, 0.1);
            border-left: 3px solid #FFC107;
        }

        .drawer-calendar-day.tier-3 {
            background: rgba(255, 149, 0, 0.1);
            border-left: 3px solid #FF9500;
        }

        .drawer-calendar-day.tier-4 {
            background: rgba(220, 53, 69, 0.1);
            border-left: 3px solid #DC3545;
        }

        .drawer-calendar-nav {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--surface);
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .drawer-calendar-nav:hover {
            background: var(--divider);
        }

        .drawer-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--divider);
            border-radius: var(--radius);
            overflow: hidden;
            margin-bottom: var(--space-3); /* ÂáèÂ∞èÂ∫ïÈÉ®Èó¥Ë∑ù */
        }

        .drawer-calendar-grid .calendar-day {
            min-height: 40px;
            font-size: 12px;
        }

        /* ÊäΩÂ±âÂõæË°®Ê†∑Âºè */
        .drawer-chart-container {
            margin-top: var(--space-4);
            padding: var(--space-6);
            background: var(--background);
            border: var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .chart-legend {
            display: flex;
            justify-content: center;
            gap: var(--space-6);
            margin-bottom: var(--space-4);
            padding: var(--space-3);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: 14px;
            cursor: pointer;
        }

        .legend-item input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
        }

        .legend-color {
            width: 20px;
            height: 3px;
            border-radius: 2px;
        }

        .legend-color.usage-line {
            background: #0066CC;
        }

        .legend-color.cost-line {
            background: #28A745;
        }

        .legend-item label {
            cursor: pointer;
            user-select: none;
            font-weight: var(--font-weight-medium);
        }

        #drawer-usage-chart {
            width: 720px;
            height: 400px;
            border: none;
            border-radius: var(--radius);
            margin: 0 auto;
            display: block;
            background: var(--background);
        }

        /* ÊäΩÂ±âÊØèÂ∞èÊó∂ËØ¶ÊÉÖÂ±ïÂºÄÊ†∑Âºè */
        .drawer-hourly-details-row {
            background: var(--surface);
            border-bottom: var(--border);
        }

        .drawer-hourly-content {
            padding: var(--space-4);
        }

        .drawer-hourly-header {
            margin-bottom: var(--space-4);
        }

        .drawer-hourly-header h5 {
            font-size: 16px;
            font-weight: var(--font-weight-medium);
            margin: 0;
            color: var(--text-primary);
        }

        .drawer-hourly-table {
            border: var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .drawer-hourly-table-header {
            display: grid;
            grid-template-columns: 80px 80px 100px 80px 100px;
            gap: var(--space-2);
            background: var(--background);
            padding: var(--space-3);
            font-weight: var(--font-weight-medium);
            font-size: 13px;
            color: var(--text-secondary);
        }

        .drawer-hourly-table-body {
            /* ÁßªÈô§È´òÂ∫¶ÈôêÂà∂ÂíåÊªöÂä®ÔºåÊòæÁ§∫ÂÖ®ÈÉ®24Â∞èÊó∂ */
        }

        .drawer-hourly-row {
            display: grid;
            grid-template-columns: 80px 80px 100px 80px 100px;
            gap: var(--space-2);
            padding: var(--space-3);
            border-bottom: var(--border);
            font-size: 13px;
            align-items: center;
        }

        .drawer-hourly-row:last-child {
            border-bottom: none;
        }

        .drawer-hourly-row:hover {
            background: var(--surface);
        }

        /* Èò∂Ê¢ØÁîµ‰ª∑ÊØèÂ∞èÊó∂ÊòéÁªÜË°å - 3ÂàóÂ∏ÉÂ±ÄÔºöÊó∂Èó¥„ÄÅÁîµÈáè„ÄÅÁ¥ØËÆ° */
        .tiered-drawer-hourly-row {
            display: grid;
            grid-template-columns: 80px 100px 100px;
            gap: var(--space-2);
            padding: var(--space-3);
            border-bottom: var(--border);
            font-size: 13px;
            align-items: center;
        }

        .tiered-drawer-hourly-row:last-child {
            border-bottom: none;
        }

        .tiered-drawer-hourly-row:hover {
            background: var(--surface);
        }

        .drawer-hour-period {
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: var(--font-weight-medium);
            text-align: center;
        }

        .drawer-hour-period.peak {
            background: rgba(220, 53, 69, 0.1);
            color: var(--error);
        }

        .drawer-hour-period.standard {
            background: rgba(0, 102, 204, 0.1);
            color: var(--accent);
        }

        .drawer-hour-period.valley {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success);
        }

        /* ÊäΩÂ±âÁßªÂä®Á´ØÈÄÇÈÖç */
        @media (max-width: 768px) {
            .drawer-content {
                width: 100%;
                max-width: 600px;
            }

            .drawer-body {
                padding: var(--space-4);
            }

            .drawer-header {
                padding: var(--space-4);
            }

            .drawer-body {
                padding: var(--space-4);
            }

            .drawer-module-header {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--space-3);
                padding: var(--space-4);
            }

            .drawer-header-left,
            .drawer-header-right {
                width: 100%;
            }

            .drawer-view-tabs {
                flex-direction: column;
                gap: var(--space-1);
                width: 100%;
            }

            .drawer-tab-btn {
                text-align: left;
            }

            #drawer-usage-chart {
                width: 100%;
                max-width: 600px;
                height: 300px;
            }

            .drawer-daily-table-header,
            .drawer-daily-table-row {
                grid-template-columns: 1fr;
                gap: var(--space-2);
                text-align: left;
            }

            .drawer-daily-table-row {
                padding: var(--space-3);
                background: var(--surface);
                margin-bottom: var(--space-2);
                border-radius: var(--radius);
                border: var(--border);
                position: relative;
            }

            .drawer-daily-table-row:last-child {
                margin-bottom: 0;
            }

            .drawer-expand-icon {
                position: absolute;
                top: var(--space-3);
                right: var(--space-3);
                font-size: 16px;
            }

            .drawer-date-cell::before { content: "Êó•Êúü: "; font-weight: bold; }
            .drawer-usage-cell::before { content: "Áî®ÁîµÈáè: "; font-weight: bold; }
            .drawer-cost-cell::before { content: "ÈáëÈ¢ù: "; font-weight: bold; }

            /* ÊäΩÂ±âÊØèÂ∞èÊó∂ËØ¶ÊÉÖÁßªÂä®Á´ØÊ†∑Âºè */
            .drawer-hourly-table-header {
                display: none;
            }

            .drawer-hourly-row {
                grid-template-columns: 1fr;
                gap: var(--space-1);
                padding: var(--space-3);
                background: var(--background);
                margin-bottom: var(--space-2);
                border-radius: var(--radius);
                border: var(--border);
            }

            .drawer-hourly-row:last-child {
                margin-bottom: 0;
            }

            .drawer-hour-time::before { content: "Êó∂Èó¥: "; font-weight: bold; }
            .drawer-hour-usage::before { content: "Áî®ÁîµÈáè: "; font-weight: bold; }
            .drawer-hour-rate::before { content: "Âçï‰ª∑: "; font-weight: bold; }
            .drawer-hour-cost::before { content: "ÈáëÈ¢ù: "; font-weight: bold; }

            /* Èò∂Ê¢ØÁîµ‰ª∑ÊØèÂ∞èÊó∂ÊòéÁªÜÁßªÂä®Á´ØÊ†∑Âºè */
            .tiered-drawer-hourly-row {
                grid-template-columns: 1fr;
                gap: var(--space-1);
                padding: var(--space-3);
                background: var(--background);
                margin-bottom: var(--space-2);
                border-radius: var(--radius);
                border: var(--border);
            }

            .tiered-drawer-hourly-row:last-child {
                margin-bottom: 0;
            }

            .tiered-drawer-hour-time::before { content: "Êó∂Èó¥: "; font-weight: bold; }
            .tiered-drawer-hour-usage::before { content: "Áî®ÁîµÈáè: "; font-weight: bold; }
            .tiered-drawer-hour-cumulative::before { content: "Á¥ØËÆ°: "; font-weight: bold; }

            .drawer-hour-period {
                align-self: flex-start;
                margin-top: var(--space-1);
            }

            .drawer-calendar-grid .calendar-day {
                min-height: 35px;
                font-size: 11px;
            }

            #drawer-usage-chart {
                width: 100%;
                height: 150px;
            }
        }

        /* section-headerÊ†∑ÂºèË∞ÉÊï¥ */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
        }


        /* ÂõæË°®ËßÜÂõæÊ†∑Âºè */
        .chart-container {
            margin-top: var(--space-4);
            background: var(--background);
            border: var(--border);
            border-radius: var(--radius);
            padding: var(--space-5);
        }

        #usage-chart {
            width: 100%;
            height: 200px;
            display: block;
        }

        .chart-summary {
            display: flex;
            justify-content: space-around;
            margin-top: var(--space-4);
            padding-top: var(--space-4);
            border-top: var(--border);
        }


        /* ÂàÜÊó∂Áîµ‰ª∑Ê†∑Âºè */
        .time-pricing-rules {
            margin-bottom: var(--space-6);
        }

        .time-pricing-rules .rule-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-4);
            border-radius: var(--radius);
            border-left: 4px solid;
            margin-bottom: var(--space-3);
        }

        .time-pricing-rules .rule-item.peak {
            background: rgba(220, 53, 69, 0.1);
            border-left-color: var(--error);
        }

        .time-pricing-rules .rule-item.standard {
            background: rgba(0, 102, 204, 0.1);
            border-left-color: var(--accent);
        }

        .time-pricing-rules .rule-item.valley {
            background: rgba(40, 167, 69, 0.1);
            border-left-color: var(--success);
        }

        .rule-info {
            flex: 1;
        }

        .rule-time {
            display: block;
            font-weight: var(--font-weight-medium);
            margin-bottom: var(--space-1);
        }

        .rule-price {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .rule-rate {
            font-family: 'Monaco', 'Courier New', monospace;
            font-weight: var(--font-weight-semibold);
            font-size: 16px;
            color: var(--text-primary);
        }

        /* ÂàÜÊó∂Áîµ‰ª∑Ê±áÊÄªË°®Ê†º */
        .time-pricing-summary {
            border: var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .summary-header {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr 1fr;
            gap: var(--space-3);
            background: var(--divider);
            padding: var(--space-4);
            font-weight: var(--font-weight-semibold);
            font-size: 14px;
            color: var(--text-primary);
        }

        .time-pricing-body {
            max-height: none;
        }

        .time-pricing-row {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr 1fr;
            gap: var(--space-3);
            padding: var(--space-4);
            border-bottom: var(--border);
            font-size: 14px;
            transition: all 0.15s ease;
            border-left: 3px solid;
        }

        .time-pricing-row:last-child {
            border-bottom: none;
        }

        .time-pricing-row.peak {
            background: rgba(220, 53, 69, 0.05);
            border-left-color: var(--error);
        }

        .time-pricing-row.standard {
            background: rgba(0, 102, 204, 0.05);
            border-left-color: var(--accent);
        }

        .time-pricing-row.valley {
            background: rgba(40, 167, 69, 0.05);
            border-left-color: var(--success);
        }

        .period-name {
            font-weight: var(--font-weight-medium);
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }
        .period-title {
            font-size: 14px;
            font-weight: var(--font-weight-medium);
        }
        .period-time {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: var(--font-weight-regular);
        }

        .period-usage,
        .period-rate,
        .period-amount {
            font-family: 'Monaco', 'Courier New', monospace;
            text-align: right;
        }

        /* Ë°®Ê†ºÊ†∑Âºè */
        .daily-table-header {
            grid-template-columns: 1fr 1.2fr 1.2fr 1fr;
        }

        .daily-table-row {
            grid-template-columns: 1fr 1.2fr 1.2fr 1fr;
        }

        .cumulative-cell,
        .tier-cell,
        .standard-cell,
        .valley-cell {
            text-align: center;
            font-family: 'Monaco', 'Courier New', monospace;
        }

        .tier-cell {
            font-weight: var(--font-weight-medium);
            color: var(--accent);
        }

        /* ÂàÜÊó∂Áîµ‰ª∑Ë°®Ê†ºÊ†∑Âºè */
        .daily-table-header.time-of-use {
            grid-template-columns: 1fr 1.2fr 1fr 30px;
        }

        .daily-table-row.time-of-use {
            grid-template-columns: 1fr 1.2fr 1fr 30px;
        }

        .expand-icon {
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
            transition: transform 0.15s ease;
        }

        .daily-table-row.time-of-use:hover {
            background: var(--surface);
        }

        /* ÊØèÂ∞èÊó∂ËØ¶ÊÉÖÂ±ïÂºÄË°å */
        .hourly-details-row {
            grid-column: 1 / -1;
            background: var(--surface);
            border-bottom: var(--border);
        }

        .hourly-details-content {
            padding: var(--space-4);
        }

        .hourly-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: var(--space-3);
        }

        .hourly-item-small {
            background: var(--background);
            padding: var(--space-3);
            border-radius: var(--radius);
            font-size: 12px;
            border-left: 3px solid;
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }

        .hourly-item-small.peak {
            border-left-color: var(--error);
        }

        .hourly-item-small.standard {
            border-left-color: var(--accent);
        }

        .hourly-item-small.valley {
            border-left-color: var(--success);
        }

        .hour-time-small {
            font-weight: var(--font-weight-medium);
            font-size: 11px;
        }

        .hour-usage-small {
            font-weight: var(--font-weight-medium);
            color: var(--text-primary);
        }

        .hour-period-small {
            font-size: 10px;
            color: var(--text-secondary);
        }

        /* Áã¨Á´ãÁöÑÊØèÊó•Áî®ÁîµÈáèÊ®°ÂùóÊ†∑Âºè */



        /* ‰∏öÊÄÅÊ†∑Âºè */
        .business-type {
            padding: var(--space-1) var(--space-2);
            border-radius: calc(var(--radius) / 2);
            font-size: 12px;
            font-weight: var(--font-weight-medium);
            display: inline-block;
        }

        .business-type {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success);
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 1200px) {
            .details-grid {
                grid-template-columns: 1fr;
                gap: var(--space-6);
            }

            .info-horizontal {
                flex-wrap: wrap;
                gap: var(--space-6);
            }
        }

        @media (max-width: 768px) {
            .page-header {
                flex-direction: column;
                align-items: stretch;
                gap: var(--space-4);
            }

            .header-left {
                flex-direction: column;
                gap: var(--space-3);
            }

            .header-actions {
                justify-content: stretch;
            }

            .info-horizontal {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--space-4);
            }


            .header-title-section {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--space-2);
            }

            .header-info {
                flex-direction: column;
                gap: var(--space-3);
            }

            .pricing-header,
            .pricing-row,
            .pricing-total {
                grid-template-columns: 1fr;
                gap: var(--space-2);
                text-align: left;
            }

            .cost-header,
            .cost-row,
            .cost-total {
                grid-template-columns: 1fr;
                gap: var(--space-2);
                text-align: left;
            }

            .pricing-total .total-label {
                grid-column: 1;
                text-align: left;
            }

            .tier-rate,
            .tier-amount,
            .cost-amount {
                text-align: left;
            }

            /* ÊØèÊó•Áî®ÁîµÈáèÁßªÂä®Á´ØÊ†∑Âºè */
            .daily-usage-header {
                flex-direction: column;
                align-items: stretch;
                gap: var(--space-3);
            }

            .view-controls {
                justify-content: center;
            }

            .daily-table-header,
            .daily-table-row {
                grid-template-columns: 1fr;
                gap: var(--space-2);
                text-align: left;
            }

            .daily-table-row {
                padding: var(--space-4);
                border-bottom: var(--border);
                display: block;
                background: var(--surface);
                margin-bottom: var(--space-2);
                border-radius: var(--radius);
                border: var(--border);
            }

            .daily-table-row:last-child {
                margin-bottom: 0;
            }

            .date-cell,
            .usage-cell,
            .peak-cell,
            .offpeak-cell,
            .cost-cell {
                display: block;
                text-align: left;
                margin-bottom: var(--space-1);
            }

            .date-cell::before { content: "Êó•Êúü: "; font-weight: bold; }
            .usage-cell::before { content: "Áî®ÁîµÈáè: "; font-weight: bold; }
            .peak-cell::before { content: "Â≥∞Êó∂: "; font-weight: bold; }
            .offpeak-cell::before { content: "Ë∞∑Êó∂: "; font-weight: bold; }
            .cost-cell::before { content: "Ë¥πÁî®: "; font-weight: bold; }

            .calendar-grid {
                gap: 1px;
            }

            .calendar-day {
                min-height: 40px;
                padding: var(--space-1);
            }

            .day-number {
                top: 3px;
                left: 3px;
                font-size: 9px;
            }

            .day-unit {
                font-size: 8px;
            }

            .day-usage-value {
                font-size: 16px;
            }

            .drawer-day-number {
                top: 2px;
                left: 2px;
                font-size: 8px;
            }

            .drawer-day-unit {
                font-size: 7px;
            }

            .drawer-day-usage-value {
                font-size: 14px;
            }

            .calendar-controls {
                margin-bottom: var(--space-3);
            }

            .calendar-toggle-btn {
                padding: var(--space-2) var(--space-3);
                font-size: 13px;
            }

            .drawer-calendar-controls {
                margin-bottom: var(--space-3);
            }

            .drawer-calendar-toggle-btn {
                padding: var(--space-1) var(--space-2);
                font-size: 12px;
            }

            .max-marker {
                top: 1px;
                right: 1px;
                font-size: 7px;
            }

            .drawer-max-marker {
                top: 1px;
                right: 1px;
                font-size: 5px;
            }

            .calendar-layout {
                flex-direction: column;
                height: auto;
            }

            .calendar-right {
                width: 100%;
                margin-top: var(--space-6);
            }

            .hourly-details-panel {
                height: 400px;
            }

            .usage-marker {
                font-size: 7px;
                padding: 1px 2px;
            }
            .hourly-table-header {
                display: none;
            }
            .hourly-list {
                grid-template-columns: 1fr;
            }
            .hourly-item {
                grid-template-columns: 1fr;
                gap: var(--space-1);
                padding: var(--space-2);
            }
            .hourly-item .hour-time::before { content: "Êó∂Èó¥: "; font-weight: bold; }
            .hourly-item .hour-period::before { content: "Êó∂ÊÆµ: "; font-weight: bold; }
            .hourly-item .hour-usage::before { content: "Áî®ÁîµÈáè: "; font-weight: bold; }
            .hourly-item .hour-rate::before { content: "Áîµ‰ª∑: "; font-weight: bold; }
            .hourly-item .hour-cost::before { content: "ÈáëÈ¢ù: "; font-weight: bold; }

            /* Ë°®Ê†ºÂ±ïÂºÄÁöÑÊØèÂ∞èÊó∂Êï∞ÊçÆÁßªÂä®Á´ØÊ†∑Âºè */
            .hourly-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: var(--space-2);
            }
            .hourly-item-small {
                padding: var(--space-2);
                font-size: 11px;
            }
            .hour-time-small {
                font-size: 10px;
            }
            .hour-period-small {
                font-size: 9px;
            }


            .chart-summary {
                flex-direction: column;
                gap: var(--space-3);
            }



            /* ÂàÜÊó∂Áîµ‰ª∑ÁßªÂä®Á´ØÊ†∑Âºè */
            .time-pricing-rules .rule-item {
                flex-direction: column;
                align-items: stretch;
                gap: var(--space-2);
            }

            .rule-rate {
                text-align: left;
                margin-top: var(--space-2);
            }

            .summary-header,
            .time-pricing-row {
                grid-template-columns: 1fr;
                gap: var(--space-2);
                text-align: left;
            }

            .time-pricing-row {
                padding: var(--space-4);
                background: var(--surface);
                margin-bottom: var(--space-2);
                border-radius: var(--radius);
                border: var(--border);
            }

            .period-name::before { content: "Êó∂ÊÆµ: "; font-weight: bold; }
            .period-name {
                flex-direction: row;
                gap: var(--space-2);
                align-items: baseline;
            }
            .period-time {
                font-size: 11px;
            }
            .period-usage::before { content: "Áî®ÁîµÈáè: "; font-weight: bold; }
            .period-rate::before { content: "Áîµ‰ª∑: "; font-weight: bold; }
            .period-amount::before { content: "ÈáëÈ¢ù: "; font-weight: bold; }

            .period-usage,
            .period-rate,
            .period-amount {
                text-align: left;
                display: block;
                margin-bottom: var(--space-1);
            }

            .standard-cell::before { content: "Âπ≥Â≥∞: "; font-weight: bold; }
            .valley-cell::before { content: "‰ΩéË∞∑: "; font-weight: bold; }

            /* Áã¨Á´ãÊ®°ÂùóÁßªÂä®Á´ØÊ†∑Âºè */
            .module-header {
                flex-direction: column;
                align-items: stretch;
                gap: var(--space-4);
            }

            .module-header h3 {
                text-align: center;
            }

            .header-controls {
                flex-direction: column;
                gap: var(--space-3);
            }

            .view-controls {
                justify-content: center;
            }


            /* ÁßªÂä®Á´ØË°®Ê†ºÊ†∑ÂºèË∞ÉÊï¥ */
            .daily-table-header,
            .daily-table-row {
                grid-template-columns: 1fr;
                gap: var(--space-2);
                text-align: left;
            }

            .daily-table-row {
                padding: var(--space-4);
                background: var(--surface);
                margin-bottom: var(--space-2);
                border-radius: var(--radius);
                border: var(--border);
            }

            .date-cell::before { content: "Êó•Êúü: "; font-weight: bold; }
            .usage-cell::before { content: "Áî®ÁîµÈáè: "; font-weight: bold; }
            .cumulative-cell::before { content: "Êú¨ÊúàÁ¥ØËÆ°: "; font-weight: bold; }
            .tier-cell::before { content: "ÊâÄÂ±ûÈò∂ÊÆµ: "; font-weight: bold; }
            .peak-cell::before { content: "È´òÂ≥∞Êó∂ÊÆµ: "; font-weight: bold; }

            .cumulative-cell,
            .tier-cell,
            .peak-cell,
            .standard-cell,
            .valley-cell {
                text-align: left;
                display: block;
                margin-bottom: var(--space-1);
            }
        }
    </style>
</body>
</html>
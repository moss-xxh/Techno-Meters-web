<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-zh="ç”¨æˆ·ç®¡ç†" data-en="User Management">ç”¨æˆ·ç®¡ç†</title>
    <link rel="stylesheet" href="assets/css/common.css">
    <link rel="stylesheet" href="assets/css/navbar.css">
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-brand">
                <img src="logo.png" alt="Logo" class="nav-logo">
            </div>
            <div class="nav-menu">
                <a href="dashboard.html" class="nav-link" data-zh="ä»ªè¡¨ç›˜" data-en="Dashboard">ä»ªè¡¨ç›˜</a>
                <a href="device-management.html" class="nav-link" data-zh="è®¾å¤‡ç®¡ç†" data-en="Device Management">è®¾å¤‡ç®¡ç†</a>
                <a href="space-management.html" class="nav-link" data-zh="å»ºç­‘ç®¡ç†" data-en="Building Management">å»ºç­‘ç®¡ç†</a>
                <a href="user-management.html" class="nav-link active" data-zh="ç”¨æˆ·ç®¡ç†" data-en="User Management">ç”¨æˆ·ç®¡ç†</a>
                <a href="bills.html" class="nav-link" data-zh="è´¦å•ç®¡ç†" data-en="Bill Management">è´¦å•ç®¡ç†</a>
            </div>
            <div class="nav-actions" style="overflow: visible !important;">
                <div class="lang-dropdown">
                    <select id="language-select" class="form-select lang-select">
                        <option value="zh" data-zh="ä¸­æ–‡" data-en="Chinese">ä¸­æ–‡</option>
                        <option value="en" data-zh="English" data-en="English">English</option>
                    </select>
                </div>
                <div class="user-menu" style="position: relative; overflow: visible !important;">
                    <input type="checkbox" id="user-dropdown-toggle" style="display: none;">
                    <label for="user-dropdown-toggle" style="display: flex; align-items: center; cursor: pointer; gap: 8px;">
                        <div class="user-avatar">ç®¡</div>
                        <span data-zh="ç®¡ç†å‘˜" data-en="Admin">ç®¡ç†å‘˜</span>
                        <span style="font-size: 12px; margin-left: 4px;">â–¼</span>
                    </label>
                    <div class="dropdown-menu" style="position: fixed; top: 64px; right: 20px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); min-width: 120px; display: none; z-index: 9999; padding: 4px 0;">
                        <label for="logout-confirm-toggle" style="display: flex; align-items: center; padding: 12px 16px; color: #dc2626; font-size: 14px; cursor: pointer; gap: 8px;">
                            <span style="font-size: 16px;">ğŸšª</span>
                            <span data-zh="é€€å‡ºç™»å½•" data-en="Logout">é€€å‡ºç™»å½•</span>
                        </label>
                    </div>
                </div>
                <style>
                    .navbar, .nav-content, .nav-actions, .user-menu { overflow: visible !important; }
                    #user-dropdown-toggle:checked + label + .dropdown-menu { display: block !important; }
                    #user-dropdown-toggle:checked + label span:last-child { transform: rotate(180deg); }
                    .dropdown-menu label:hover { background-color: #f9fafb !important; }
                    #logout-confirm-toggle:checked + .logout-modal { display: flex !important; }
                </style>
            </div>
        </div>
    </nav>

    <!-- é€€å‡ºç¡®è®¤å¼¹çª— -->
    <input type="checkbox" id="logout-confirm-toggle" style="display: none;">
    <div class="logout-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: none; z-index: 99999; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; padding: 32px; max-width: 420px; width: 90%; box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);">
            <div style="text-align: center; font-size: 48px; margin-bottom: 20px;">âš ï¸</div>
            <h3 style="text-align: center; font-size: 20px; font-weight: 600; color: #1f2937; margin-bottom: 12px; margin-top: 0;">ç¡®è®¤é€€å‡º</h3>
            <p style="text-align: center; color: #6b7280; font-size: 16px; margin-bottom: 28px; margin-top: 0;">æ‚¨ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿé€€å‡ºåéœ€è¦é‡æ–°è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ã€‚</p>
            <div style="display: flex; gap: 12px; justify-content: center;">
                <label for="logout-confirm-toggle" style="padding: 12px 24px; background: #f3f4f6; color: #374151; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; min-width: 80px;">å–æ¶ˆ</label>
                <a href="index.html" style="padding: 12px 24px; background: #dc2626; color: white; border-radius: 8px; text-decoration: none; font-size: 14px; font-weight: 500; min-width: 80px; text-align: center;">ç¡®è®¤é€€å‡º</a>
            </div>
        </div>
    </div>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <main class="main-content">
        <div class="content-layout">
            <div class="main-container">

                <!-- æœç´¢å’Œæ“ä½œåŒºåŸŸ -->
                <div class="search-section">
                    <div class="search-controls">
                        <input type="text" id="user-search" class="form-input" placeholder="ç§Ÿæˆ·å§“å/ç”µè¯/æˆ¿å·..." data-zh-placeholder="ç§Ÿæˆ·å§“å/ç”µè¯/æˆ¿å·..." data-en-placeholder="Name/Phone/Room...">
                        <select id="user-status-filter" class="form-select">
                            <option value="all" data-zh="å…¨éƒ¨çŠ¶æ€" data-en="All Status">å…¨éƒ¨çŠ¶æ€</option>
                            <option value="active" data-zh="å…¥é©»ä¸­" data-en="Checked In">å…¥é©»ä¸­</option>
                            <option value="inactive" data-zh="å·²é€€ç§Ÿ" data-en="Checked Out">å·²é€€ç§Ÿ</option>
                            <option value="pending" data-zh="æœªå…¥é©»" data-en="Not Checked In">æœªå…¥é©»</option>
                        </select>
                    </div>
                    <div class="search-actions">
                        <button class="btn btn-primary" onclick="searchUsers()">
                            <span data-zh="æŸ¥è¯¢" data-en="Search">æŸ¥è¯¢</span>
                        </button>
                        <button class="btn btn-secondary" onclick="resetFilters()">
                            <span data-zh="é‡ç½®" data-en="Reset">é‡ç½®</span>
                        </button>
                    </div>
                </div>

                <!-- ç”¨æˆ·åˆ—è¡¨è¡¨æ ¼ -->
                <div class="table-container">
                    <div class="table-header">
                        <button class="btn btn-success" onclick="showAddModal()">
                            <span data-zh="+ æ·»åŠ ç§Ÿæˆ·" data-en="+ Add Tenant">+ æ·»åŠ ç§Ÿæˆ·</span>
                        </button>
                    </div>
                    <table class="table" id="users-table">
                        <thead>
                            <tr>
                                <th data-sortable data-zh="å§“å" data-en="Name">å§“å</th>
                                <th data-sortable data-zh="æˆ¿é—´" data-en="Room">æˆ¿é—´</th>
                                <th data-sortable data-zh="å…¥é©»æ—¶é—´ï¼ˆå¼€å§‹è¯»æ•°ï¼‰" data-en="Check-in Time (Start Reading)">å…¥é©»æ—¶é—´ï¼ˆå¼€å§‹è¯»æ•°ï¼‰</th>
                                <th data-sortable data-zh="é€€ç§Ÿæ—¶é—´ï¼ˆç»“æŸè¯»æ•°ï¼‰" data-en="Check-out Time (End Reading)">é€€ç§Ÿæ—¶é—´ï¼ˆç»“æŸè¯»æ•°ï¼‰</th>
                                <th data-sortable data-zh="çŠ¶æ€" data-en="Status">çŠ¶æ€</th>
                                <th data-zh="æ“ä½œ" data-en="Actions">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="users-tbody">
                            <!-- æ•°æ®ç”±JavaScriptç”Ÿæˆ -->
                        </tbody>
                    </table>

                    <!-- åˆ†é¡µ -->
                    <div class="pagination">
                        <button class="btn btn-secondary" id="prev-page" disabled>
                            <span>â€¹</span>
                            <span data-zh="ä¸Šä¸€é¡µ" data-en="Previous">ä¸Šä¸€é¡µ</span>
                        </button>
                        <div class="page-info">
                            <span data-zh="ç¬¬" data-en="Page">ç¬¬</span>
                            <span id="current-page">1</span>
                            <span data-zh="é¡µï¼Œå…±" data-en="of">é¡µï¼Œå…±</span>
                            <span id="total-pages">3</span>
                            <span data-zh="é¡µ" data-en="pages">é¡µ</span>
                        </div>
                        <button class="btn btn-secondary" id="next-page">
                            <span data-zh="ä¸‹ä¸€é¡µ" data-en="Next">ä¸‹ä¸€é¡µ</span>
                            <span>â€º</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- æ·»åŠ ç§Ÿæˆ·æ¨¡æ€æ¡† -->
    <div id="user-modal" class="modal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title" data-zh="æ·»åŠ ç§Ÿæˆ·" data-en="Add Tenant">æ·»åŠ ç§Ÿæˆ·</h3>
                <button class="modal-close" onclick="hideModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="user-form" class="user-form">
                        <div class="form-row">
                            <div class="form-group">
                                <div style="display: flex; align-items: center;">
                                    <span style="color: red; font-size: 14px; margin-right: 2px;">*</span>
                                    <label for="tenant-name" data-zh="å§“å" data-en="Name">å§“å</label>
                                </div>
                                <input type="text" id="tenant-name" name="tenantName" class="form-input"
                                       data-zh-placeholder="å¼ ä¸‰" data-en-placeholder="John Doe" placeholder="å¼ ä¸‰" required>
                            </div>
                            <div class="form-group">
                                <div style="display: flex; align-items: center;">
                                    <span style="color: red; font-size: 14px; margin-right: 2px;">*</span>
                                    <label for="tenant-email" data-zh="é‚®ç®±" data-en="Email">é‚®ç®±</label>
                                </div>
                                <input type="email" id="tenant-email" name="tenantEmail" class="form-input"
                                       placeholder="tenant@example.com" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="tenant-phone" data-zh="è”ç³»ç”µè¯" data-en="Phone">è”ç³»ç”µè¯</label>
                                <input type="tel" id="tenant-phone" name="tenantPhone" class="form-input"
                                       data-zh-placeholder="+91 98765 43210" data-en-placeholder="+91 98765 43210" placeholder="+91 98765 43210" required>
                            </div>
                            <div class="form-group">
                                <label for="tenant-notes" data-zh="å¤‡æ³¨" data-en="Notes">å¤‡æ³¨</label>
                                <textarea id="tenant-notes" name="tenantNotes" class="form-textarea"
                                          rows="2" data-zh-placeholder="ç§Ÿæˆ·ç›¸å…³å¤‡æ³¨ä¿¡æ¯..." data-en-placeholder="Tenant related notes..." placeholder="ç§Ÿæˆ·ç›¸å…³å¤‡æ³¨ä¿¡æ¯..."></textarea>
                            </div>
                        </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideModal()" data-zh="å–æ¶ˆ" data-en="Cancel">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="saveUser()" data-zh="ä¿å­˜" data-en="Save">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- å…¥é©»å¼¹çª— -->
    <div id="checkin-modal" class="modal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-zh="ç§Ÿæˆ·å…¥é©»" data-en="Tenant Check-in">ç§Ÿæˆ·å…¥é©»</h3>
                <button class="modal-close" onclick="hideCheckinModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="checkin-form" class="user-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label data-zh="ç§Ÿæˆ·å§“å" data-en="Tenant Name">ç§Ÿæˆ·å§“å</label>
                            <div id="checkin-user-name" style="padding: 12px; background: #f5f5f5; border-radius: 6px; color: #666;">--</div>
                            <input type="hidden" id="checkin-user-id">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <div style="display: flex; align-items: center;">
                                <span style="color: red; font-size: 14px; margin-right: 2px;">*</span>
                                <label for="checkin-room" data-zh="é€‰æ‹©æˆ¿é—´" data-en="Select Room">é€‰æ‹©æˆ¿é—´</label>
                            </div>
                            <select id="checkin-room" name="room" class="form-input" required>
                                <option value="" data-zh="è¯·é€‰æ‹©æˆ¿é—´" data-en="Please select room">è¯·é€‰æ‹©æˆ¿é—´</option>
                                <option value="101">101å®¤</option>
                                <option value="102">102å®¤</option>
                                <option value="103">103å®¤</option>
                                <option value="201">201å®¤</option>
                                <option value="202">202å®¤</option>
                                <option value="203">203å®¤</option>
                                <option value="301">301å®¤</option>
                                <option value="302">302å®¤</option>
                                <option value="303">303å®¤</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <div style="display: flex; align-items: center;">
                                <span style="color: red; font-size: 14px; margin-right: 2px;">*</span>
                                <label for="checkin-date" data-zh="å…¥é©»æ—¶é—´" data-en="Check-in Date">å…¥é©»æ—¶é—´</label>
                            </div>
                            <input type="date" id="checkin-date" name="checkinDate" class="form-input" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <div style="display: flex; align-items: center;">
                                <span style="color: red; font-size: 14px; margin-right: 2px;">*</span>
                                <label for="electricity-reading" data-zh="ç”µè¡¨è¯»æ•°" data-en="Electricity Reading">ç”µè¡¨è¯»æ•° (kWh)</label>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="number" id="electricity-reading" name="electricityReading" class="form-input"
                                       data-zh-placeholder="è¾“å…¥å½“å‰ç”µè¡¨è¯»æ•°" data-en-placeholder="Enter current electricity reading" placeholder="è¾“å…¥å½“å‰ç”µè¡¨è¯»æ•°" step="0.01" min="0" required style="flex: 1;">
                                <button type="button" class="btn btn-secondary" onclick="readCurrentMeter()" style="flex-shrink: 0;" data-zh="è¯»å–" data-en="Read">è¯»å–</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideCheckinModal()" data-zh="å–æ¶ˆ" data-en="Cancel">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="saveCheckin()" data-zh="ç¡®è®¤å…¥é©»" data-en="Confirm Check-in">ç¡®è®¤å…¥é©»</button>
            </div>
        </div>
    </div>

    <!-- é€€ç§Ÿå¼¹çª— -->
    <div id="checkout-modal" class="modal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-zh="ç§Ÿæˆ·é€€ç§Ÿ" data-en="Tenant Check-out">ç§Ÿæˆ·é€€ç§Ÿ</h3>
                <button class="modal-close" onclick="hideCheckoutModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="checkout-form" class="user-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label data-zh="ç§Ÿæˆ·å§“å" data-en="Tenant Name">ç§Ÿæˆ·å§“å</label>
                            <div id="checkout-user-name" style="padding: 12px; background: #f5f5f5; border-radius: 6px; color: #666;">--</div>
                            <input type="hidden" id="checkout-user-id">
                        </div>
                        <div class="form-group">
                            <label data-zh="å½“å‰æˆ¿é—´" data-en="Current Room">å½“å‰æˆ¿é—´</label>
                            <div id="checkout-user-room" style="padding: 12px; background: #f5f5f5; border-radius: 6px; color: #666;">--</div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <div style="display: flex; align-items: center;">
                                <span style="color: red; font-size: 14px; margin-right: 2px;">*</span>
                                <label for="checkout-date" data-zh="é€€ç§Ÿæ—¶é—´" data-en="Check-out Date">é€€ç§Ÿæ—¶é—´</label>
                            </div>
                            <input type="date" id="checkout-date" name="checkoutDate" class="form-input" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <div style="display: flex; align-items: center;">
                                <span style="color: red; font-size: 14px; margin-right: 2px;">*</span>
                                <label for="checkout-electricity-reading" data-zh="ç”µè¡¨è¯»æ•°" data-en="Electricity Reading">ç”µè¡¨è¯»æ•° (kWh)</label>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="number" id="checkout-electricity-reading" name="electricityReading" class="form-input"
                                       data-zh-placeholder="è¾“å…¥å½“å‰ç”µè¡¨è¯»æ•°" data-en-placeholder="Enter current electricity reading" placeholder="è¾“å…¥å½“å‰ç”µè¡¨è¯»æ•°" step="0.01" min="0" required style="flex: 1;">
                                <button type="button" class="btn btn-secondary" onclick="readCurrentMeterForCheckout()" style="flex-shrink: 0;" data-zh="è¯»å–" data-en="Read">è¯»å–</button>
                            </div>
                            <div style="margin-top: 6px; font-size: 12px; color: #999;">
                                <span data-zh="æç¤ºï¼šé€€ç§Ÿåï¼Œè¯·å‰å¾€è´¦å•ç®¡ç†æŸ¥çœ‹è´¦å•" data-en="Tip: After check-out, go to Bills Management to view bills">æç¤ºï¼šé€€ç§Ÿåï¼Œè¯·å‰å¾€è´¦å•ç®¡ç†æŸ¥çœ‹è´¦å•</span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideCheckoutModal()" data-zh="å–æ¶ˆ" data-en="Cancel">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="saveCheckout()" data-zh="ç¡®è®¤é€€ç§Ÿ" data-en="Confirm Check-out">ç¡®è®¤é€€ç§Ÿ</button>
            </div>
        </div>
    </div>

    <!-- åˆ é™¤ç¡®è®¤å¼¹çª— -->
    <div id="delete-confirm-modal" class="modal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content delete-confirm-modal">
            <div class="modal-header">
                <h3 data-zh="ç¡®è®¤åˆ é™¤" data-en="Confirm Delete">ç¡®è®¤åˆ é™¤</h3>
                <button class="modal-close" onclick="hideDeleteConfirm()">&times;</button>
            </div>
            <div class="modal-body">
                <p><span data-zh="ç¡®å®šè¦åˆ é™¤ç§Ÿæˆ·" data-en="Are you sure you want to delete tenant">ç¡®å®šè¦åˆ é™¤ç§Ÿæˆ·</span> "<span id="delete-user-name">--</span>"<span data-zh="å—ï¼Ÿ" data-en="?">å—ï¼Ÿ</span></p>
                <p class="delete-warning" data-zh="æ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚" data-en="This action cannot be undone.">æ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideDeleteConfirm()" data-zh="å–æ¶ˆ" data-en="Cancel">å–æ¶ˆ</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()" data-zh="åˆ é™¤" data-en="Delete">åˆ é™¤</button>
            </div>
        </div>
    </div>

    <script src="assets/js/navbar.js"></script>
    <script src="assets/js/common.js"></script>
    <script>
        // ç§Ÿæˆ·æ•°æ®
        // è·å–å½“å‰è¯­è¨€
        function getCurrentLanguage() {
            return document.getElementById('language-select')?.value || 'zh';
        }

        // å¼ºåˆ¶ç¿»è¯‘æ‰€æœ‰é™æ€æ–‡æœ¬
        function forceTranslateStaticText() {
            const currentLang = getCurrentLanguage();
            console.log('å¼ºåˆ¶ç¿»è¯‘é™æ€æ–‡æœ¬ï¼Œå½“å‰è¯­è¨€:', currentLang);

            // ç¿»è¯‘æ‰€æœ‰å¸¦æœ‰data-zhå’Œdata-enå±æ€§çš„å…ƒç´ 
            document.querySelectorAll('[data-zh][data-en]').forEach(element => {
                const zhText = element.getAttribute('data-zh');
                const enText = element.getAttribute('data-en');
                if (zhText && enText) {
                    element.textContent = currentLang === 'en' ? enText : zhText;
                }
            });

            // ç¿»è¯‘å ä½ç¬¦
            document.querySelectorAll('[data-zh-placeholder][data-en-placeholder]').forEach(element => {
                const zhPlaceholder = element.getAttribute('data-zh-placeholder');
                const enPlaceholder = element.getAttribute('data-en-placeholder');
                if (zhPlaceholder && enPlaceholder) {
                    element.placeholder = currentLang === 'en' ? enPlaceholder : zhPlaceholder;
                }
            });

            console.log('é™æ€æ–‡æœ¬ç¿»è¯‘å®Œæˆ');
        }

        const usersData = [
            {
                id: 'TNT001',
                name: 'å¼ æ˜å',
                nameEn: 'Zhang Minghua',
                phone: '+91 98765 43210',
                email: 'zhang@example.com',
                room: 'A-101',
                building: 'A',
                floor: 1,
                type: 'residential',
                status: 'active',
                checkinDate: '2024-01-15',
                electricityReading: 1250.5,
                moveInDate: '2024-01-15',
                leaseEndDate: '2025-01-14',
                rent: 15000,
                deposit: 30000
            },
            {
                id: 'TNT002',
                name: 'æå°çº¢',
                nameEn: 'Li Xiaohong',
                phone: '+91 87654 32109',
                email: 'li@example.com',
                room: 'B-205',
                building: 'B',
                floor: 2,
                type: 'commercial',
                status: 'inactive',
                checkinDate: '2024-03-01',
                electricityReading: 890.2,
                checkoutDate: '2024-12-15',
                finalElectricityReading: 2145.8,
                moveInDate: '2024-03-01',
                leaseEndDate: '2025-02-28',
                rent: 25000,
                deposit: 50000
            },
            {
                id: 'TNT003',
                name: 'ç‹å»ºå›½',
                nameEn: 'Wang Jianguo',
                phone: '+91 76543 21098',
                email: 'wang@example.com',
                room: 'C-302',
                building: 'C',
                floor: 3,
                type: 'office',
                status: 'active',
                checkinDate: '2024-05-10',
                electricityReading: 675.3,
                moveInDate: '2024-05-10',
                leaseEndDate: '2025-05-09',
                rent: 20000,
                deposit: 40000
            },
            {
                id: 'TNT004',
                name: 'é™ˆç¾ä¸½',
                nameEn: 'Chen Meili',
                phone: '+91 65432 10987',
                email: 'chen@example.com',
                building: 'A',
                floor: 2,
                type: 'residential',
                status: 'pending',
                notes: 'å¾…å…¥é©»'
            }
        ];

        function renderUsersTable() {
            console.log('å¼€å§‹æ¸²æŸ“ç”¨æˆ·è¡¨æ ¼, ç”¨æˆ·æ•°æ®æ•°é‡:', usersData.length);
            const tbody = document.getElementById('users-tbody');
            tbody.innerHTML = '';

            const currentLang = getCurrentLanguage();
            console.log('å½“å‰è¯­è¨€:', currentLang);

            usersData.forEach(user => {
                const row = document.createElement('tr');

                const statusClass = user.status === 'active' ? 'status-online' :
                                   user.status === 'inactive' ? 'status-offline' : 'status-pending';

                const statusText = user.status === 'active'
                    ? (currentLang === 'zh' ? 'å…¥é©»ä¸­' : 'Checked In')
                    : user.status === 'inactive'
                    ? (currentLang === 'zh' ? 'å·²é€€ç§Ÿ' : 'Checked Out')
                    : (currentLang === 'zh' ? 'æœªå…¥é©»' : 'Not Checked In');

                // æ ¼å¼åŒ–å…¥é©»æ—¶é—´å’Œå¼€å§‹è¯»æ•°
                const checkinInfo = user.checkinDate && user.electricityReading
                    ? `${user.checkinDate}<br><small style="color: #666;">${currentLang === 'zh' ? 'å¼€å§‹' : 'Start'}: ${user.electricityReading}</small>`
                    : user.checkinDate || '--';

                // æ ¼å¼åŒ–é€€ç§Ÿæ—¶é—´å’Œç»“æŸè¯»æ•°
                const checkoutInfo = user.checkoutDate && user.finalElectricityReading
                    ? `${user.checkoutDate}<br><small style="color: #666;">${currentLang === 'zh' ? 'ç»“æŸ' : 'End'}: ${user.finalElectricityReading}</small>`
                    : user.checkoutDate || '--';

                // Use appropriate name based on language
                const displayName = currentLang === 'zh' ? user.name : (user.nameEn || user.name);

                row.innerHTML = `
                    <td>${displayName}</td>
                    <td>${user.room || '--'}</td>
                    <td>${checkinInfo}</td>
                    <td>${checkoutInfo}</td>
                    <td><span class="device-status ${statusClass}">${statusText}</span></td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editUser('${user.id}')">${currentLang === 'zh' ? 'ç¼–è¾‘' : 'Edit'}</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser('${user.id}')" data-user-id="${user.id}">${currentLang === 'zh' ? 'åˆ é™¤' : 'Delete'}</button>
                        ${user.status === 'active'
                            ? `<button class="btn btn-sm btn-warning" onclick="moveOutUser('${user.id}')">${currentLang === 'zh' ? 'é€€ç§Ÿ' : 'Check-out'}</button>`
                            : `<button class="btn btn-sm btn-success" onclick="moveInUser('${user.id}')">${currentLang === 'zh' ? 'å…¥é©»' : 'Check-in'}</button>`
                        }
                    </td>
                `;

                tbody.appendChild(row);
            });
            console.log('ç”¨æˆ·è¡¨æ ¼æ¸²æŸ“å®Œæˆ');
        }

        // Translation helper function
        function getTranslation(zh, en) {
            const currentLang = getCurrentLanguage();
            return currentLang === 'en' ? en : zh;
        }

        // Update placeholders based on current language
        function updatePlaceholders() {
            const currentLang = getCurrentLanguage();
            const elements = document.querySelectorAll('[data-zh-placeholder]');

            elements.forEach(element => {
                const zhPlaceholder = element.getAttribute('data-zh-placeholder');
                const enPlaceholder = element.getAttribute('data-en-placeholder');
                element.placeholder = currentLang === 'en' ? enPlaceholder : zhPlaceholder;
            });
        }

        window.searchUsers = function() {
            alert(getTranslation('æœç´¢åŠŸèƒ½', 'Search function'));
        }

        window.resetFilters = function() {
            alert(getTranslation('é‡ç½®åŠŸèƒ½', 'Reset function'));
        }


        window.showAddModal = function() {
            // é‡ç½®ç¼–è¾‘æ¨¡å¼
            isEditMode = false;
            editingUserId = null;

            // é‡ç½®è¡¨å•å’ŒUI
            document.getElementById('modal-title').textContent = 'æ·»åŠ ç§Ÿæˆ·';
            document.getElementById('user-form').reset();

            // é‡ç½®é‚®ç®±å­—æ®µçŠ¶æ€
            const emailField = document.getElementById('tenant-email');
            emailField.readOnly = false;
            emailField.disabled = false;
            emailField.style.backgroundColor = '';
            emailField.style.color = '';
            emailField.style.cursor = '';

            // æ˜¾ç¤ºå¼¹çª—
            document.getElementById('user-modal').style.display = 'flex';
            document.body.classList.add('modal-open');
        }

        window.hideModal = function() {
            document.getElementById('user-modal').style.display = 'none';
            document.body.classList.remove('modal-open');

            // é‡ç½®ç¼–è¾‘æ¨¡å¼
            isEditMode = false;
            editingUserId = null;

            // é‡ç½®é‚®ç®±å­—æ®µçŠ¶æ€
            const emailField = document.getElementById('tenant-email');
            emailField.readOnly = false;
            emailField.disabled = false;
            emailField.style.backgroundColor = '';
            emailField.style.color = '';
            emailField.style.cursor = '';
        }

        window.saveUser = function() {
            const formData = new FormData(document.getElementById('user-form'));

            // è·å–è¡¨å•æ•°æ®
            const userData = {
                name: formData.get('tenantName').trim(),
                phone: formData.get('tenantPhone').trim(),
                email: formData.get('tenantEmail').trim(),
                notes: formData.get('tenantNotes').trim()
            };

            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!userData.name || !userData.email) {
                alert(getTranslation('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ', 'Please fill in all required fields'));
                return;
            }

            try {
                if (isEditMode && editingUserId) {
                    // ç¼–è¾‘æ¨¡å¼ï¼šæ›´æ–°ç°æœ‰ç”¨æˆ·
                    const userIndex = usersData.findIndex(u => u.id === editingUserId);
                    if (userIndex > -1) {
                        // ä¿ç•™åŸæœ‰æ•°æ®ï¼Œåªæ›´æ–°å…è®¸ç¼–è¾‘çš„å­—æ®µ
                        usersData[userIndex].name = userData.name;
                        usersData[userIndex].phone = userData.phone;
                        usersData[userIndex].notes = userData.notes;
                        // é‚®ç®±ä¸å…è®¸ç¼–è¾‘ï¼Œä¿æŒåŸå€¼

                        // é‡æ–°æ¸²æŸ“è¡¨æ ¼
                        renderUsersTable();
                        // å…³é—­æ¨¡æ€æ¡†
                        hideModal();

                        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        console.log('ç§Ÿæˆ·ä¿¡æ¯æ›´æ–°æˆåŠŸï¼');
                    }
                } else {
                    // æ·»åŠ æ¨¡å¼ï¼šåˆ›å»ºæ–°ç”¨æˆ·
                    const newUser = {
                        id: 'TNT' + String(Math.floor(Math.random() * 900) + 100),
                        name: userData.name,
                        phone: userData.phone,
                        email: userData.email,
                        type: 'residential',
                        notes: userData.notes,
                        status: 'inactive'
                    };

                    // æ·»åŠ åˆ°ç§Ÿæˆ·åˆ—è¡¨
                    usersData.push(newUser);
                    // é‡æ–°æ¸²æŸ“è¡¨æ ¼
                    renderUsersTable();
                    // å…³é—­æ¨¡æ€æ¡†
                    hideModal();

                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    if (typeof EnergySystem !== 'undefined') {
                        EnergySystem.showNotification('ç§Ÿæˆ·æ·»åŠ æˆåŠŸï¼', 'success');
                    } else {
                        alert(getTranslation('ç§Ÿæˆ·æ·»åŠ æˆåŠŸï¼', 'Tenant added successfully!'));
                    }

                    // æ ‡è®°ç”¨æˆ·æµç¨‹ä¸ºå®Œæˆ
                    let workflowProgress = JSON.parse(localStorage.getItem('workflowProgress') || '{}');
                    workflowProgress.user = true;
                    localStorage.setItem('workflowProgress', JSON.stringify(workflowProgress));
                }
            } catch (error) {
                console.error('ä¿å­˜ç§Ÿæˆ·æ—¶å‡ºé”™:', error);
                alert(getTranslation('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'Save failed, please try again'));
            }
        }

        window.editUser = function(userId) {
            const user = usersData.find(u => u.id === userId);
            if (user) {
                // è®¾ç½®ä¸ºç¼–è¾‘æ¨¡å¼
                isEditMode = true;
                editingUserId = userId;

                // æ›´æ–°å¼¹çª—æ ‡é¢˜
                document.getElementById('modal-title').textContent = 'ç¼–è¾‘ç§Ÿæˆ·';

                // å¡«å……è¡¨å•æ•°æ® - æ ¹æ®å½“å‰è¯­è¨€æ˜¾ç¤ºåå­—
                const currentLang = document.getElementById('language-select')?.value || 'zh';
                const displayName = currentLang === 'zh' ? user.name : (user.nameEn || user.name);
                document.getElementById('tenant-name').value = displayName || '';
                document.getElementById('tenant-email').value = user.email || '';
                document.getElementById('tenant-phone').value = user.phone || '';
                document.getElementById('tenant-notes').value = user.notes || '';

                // è®¾ç½®é‚®ç®±ä¸ºåªè¯»
                const emailField = document.getElementById('tenant-email');
                emailField.readOnly = true;
                emailField.disabled = false; // ä¿æŒå¯æ˜¾ç¤ºä½†ä¸å¯ç¼–è¾‘
                emailField.style.backgroundColor = '#f5f5f5';
                emailField.style.color = '#666';
                emailField.style.cursor = 'not-allowed';

                // æ˜¾ç¤ºå¼¹çª—
                document.getElementById('user-modal').style.display = 'flex';
                document.body.classList.add('modal-open');
            }
        }

        // ç¼–è¾‘å’Œåˆ é™¤åŠŸèƒ½ç›¸å…³å˜é‡
        let isEditMode = false;
        let editingUserId = null;
        let deleteUserId = null;

        // Make sure deleteUser is globally accessible
        window.deleteUser = function(userId) {
            console.log('deleteUser called with userId:', userId);
            const user = usersData.find(u => u.id === userId);
            if (!user) {
                console.log('User not found for ID:', userId);
                return;
            }

            deleteUserId = userId;
            // ä½¿ç”¨é€‚å½“çš„è¯­è¨€æ˜¾ç¤ºåå­—
            const currentLang = document.getElementById('language-select')?.value || 'zh';
            const displayName = currentLang === 'zh' ? user.name : (user.nameEn || user.name);

            // ç­‰å¾…DOMå‡†å¤‡å¥½ï¼Œç„¶åæŸ¥æ‰¾å…ƒç´ 
            setTimeout(function() {
                // å°è¯•å¤šç§æ–¹å¼æŸ¥æ‰¾å…ƒç´ 
                let deleteNameElement = document.getElementById('delete-user-name');
                let deleteModalElement = document.getElementById('delete-confirm-modal');

                // å¦‚æœæ‰¾ä¸åˆ°ï¼Œå°è¯•é€šè¿‡querySelectoræŸ¥æ‰¾
                if (!deleteNameElement) {
                    deleteNameElement = document.querySelector('#delete-user-name');
                }
                if (!deleteModalElement) {
                    deleteModalElement = document.querySelector('#delete-confirm-modal');
                }

                console.log('Delete name element:', deleteNameElement);
                console.log('Delete modal element:', deleteModalElement);

                // å¦‚æœè¿˜æ˜¯æ‰¾ä¸åˆ°ï¼Œå°è¯•åœ¨æ‰€æœ‰æ¨¡æ€æ¡†ä¸­æŸ¥æ‰¾
                if (!deleteNameElement) {
                    const allSpans = document.querySelectorAll('span');
                    console.log('All spans on page:', allSpans);
                    for (let span of allSpans) {
                        if (span.id === 'delete-user-name') {
                            deleteNameElement = span;
                            break;
                        }
                    }
                }

                if (!deleteNameElement) {
                    console.error('Cannot find delete-user-name element anywhere!');
                    // å°è¯•åˆ›å»ºå¹¶æ’å…¥å…ƒç´ 
                    const modalBody = document.querySelector('#delete-confirm-modal .modal-body p');
                    if (modalBody) {
                        console.log('Found modal body, trying to update text directly');
                        modalBody.innerHTML = `ç¡®å®šè¦åˆ é™¤ç§Ÿæˆ· "<span id="delete-user-name">${displayName}</span>" å—ï¼Ÿ`;
                        deleteNameElement = document.getElementById('delete-user-name');
                    }
                }

                if (!deleteModalElement) {
                    console.error('Cannot find delete-confirm-modal element!');
                    alert('åˆ é™¤ç¡®è®¤çª—å£æ‰¾ä¸åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
                    return;
                }

                // å¦‚æœæ‰¾åˆ°äº†å…ƒç´ ï¼Œè¿›è¡Œæ“ä½œ
                if (deleteNameElement) {
                    deleteNameElement.textContent = displayName;
                } else {
                    console.error('Still cannot find delete-user-name element after all attempts');
                }

                deleteModalElement.style.display = 'flex';
                document.body.classList.add('modal-open');
                console.log('Modal should be visible now');
            }, 50); // å¢åŠ å»¶è¿Ÿ
        }

        window.moveInUser = function(userId) {
            const user = usersData.find(u => u.id === userId);
            if (user) {
                // å¡«å……å…¥é©»è¡¨å• - ä½¿ç”¨é€‚å½“çš„è¯­è¨€æ˜¾ç¤ºåå­—
                const currentLang = document.getElementById('language-select')?.value || 'zh';
                const displayName = currentLang === 'zh' ? user.name : (user.nameEn || user.name);
                document.getElementById('checkin-user-name').textContent = displayName;
                document.getElementById('checkin-user-id').value = userId;

                // è®¾ç½®é»˜è®¤å…¥é©»æ—¥æœŸä¸ºä»Šå¤©
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('checkin-date').value = today;

                // æ˜¾ç¤ºå…¥é©»å¼¹çª—
                document.getElementById('checkin-modal').style.display = 'flex';
                document.body.classList.add('modal-open');
            }
        }

        window.moveOutUser = function(userId) {
            const user = usersData.find(u => u.id === userId);
            if (user) {
                // å¡«å……é€€ç§Ÿè¡¨å• - ä½¿ç”¨é€‚å½“çš„è¯­è¨€æ˜¾ç¤ºåå­—
                const currentLang = document.getElementById('language-select')?.value || 'zh';
                const displayName = currentLang === 'zh' ? user.name : (user.nameEn || user.name);
                document.getElementById('checkout-user-name').textContent = displayName;
                document.getElementById('checkout-user-room').textContent = user.room || getTranslation('æœªåˆ†é…', 'Unassigned');
                document.getElementById('checkout-user-id').value = userId;

                // è®¾ç½®é»˜è®¤é€€ç§Ÿæ—¥æœŸä¸ºä»Šå¤©
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('checkout-date').value = today;

                // æ˜¾ç¤ºé€€ç§Ÿå¼¹çª—
                document.getElementById('checkout-modal').style.display = 'flex';
                document.body.classList.add('modal-open');
            }
        }

        // å…¥é©»å¼¹çª—å‡½æ•°
        window.hideCheckinModal = function() {
            document.getElementById('checkin-modal').style.display = 'none';
            document.body.classList.remove('modal-open');
            // æ¸…ç©ºè¡¨å•
            document.getElementById('checkin-form').reset();
        }

        window.readCurrentMeter = function() {
            // æ¨¡æ‹Ÿè¯»å–å½“å‰ç”µè¡¨è¯»æ•°
            const currentReading = (Math.random() * 1000 + 500).toFixed(2);
            document.getElementById('electricity-reading').value = currentReading;

            if (typeof EnergySystem !== 'undefined') {
                EnergySystem.showNotification(getTranslation(`å·²è¯»å–å½“å‰ç”µè¡¨è¯»æ•°ï¼š${currentReading} kWh`, `Current electricity reading: ${currentReading} kWh`), 'success');
            } else {
                alert(getTranslation(`å·²è¯»å–å½“å‰ç”µè¡¨è¯»æ•°ï¼š${currentReading} kWh`, `Current electricity reading: ${currentReading} kWh`));
            }
        }

        window.saveCheckin = function() {
            const formData = new FormData(document.getElementById('checkin-form'));
            const userId = document.getElementById('checkin-user-id').value;

            // è·å–è¡¨å•æ•°æ®
            const checkinData = {
                room: formData.get('room').trim(),
                checkinDate: formData.get('checkinDate'),
                electricityReading: parseFloat(formData.get('electricityReading'))
            };

            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!checkinData.room || !checkinData.checkinDate ||
                isNaN(checkinData.electricityReading)) {
                alert(getTranslation('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ', 'Please fill in all required fields'));
                return;
            }

            // éªŒè¯è¯»æ•°å€¼
            if (checkinData.electricityReading < 0) {
                alert(getTranslation('ç”µè¡¨è¯»æ•°ä¸èƒ½ä¸ºè´Ÿæ•°', 'Electricity reading cannot be negative'));
                return;
            }

            try {
                // æ›´æ–°ç§Ÿæˆ·çŠ¶æ€
                const user = usersData.find(u => u.id === userId);
                if (user) {
                    user.status = 'active';
                    user.room = checkinData.room;
                    user.checkinDate = checkinData.checkinDate;
                    user.electricityReading = checkinData.electricityReading;

                    // é‡æ–°æ¸²æŸ“è¡¨æ ¼
                    renderUsersTable();

                    // å…³é—­å¼¹çª—
                    hideCheckinModal();

                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    if (typeof EnergySystem !== 'undefined') {
                        EnergySystem.showNotification(getTranslation(`${user.name} å…¥é©»æˆåŠŸï¼æˆ¿é—´ï¼š${checkinData.room}`, `${user.name} checked in successfully! Room: ${checkinData.room}`), 'success');
                    } else {
                        alert(getTranslation(`${user.name} å…¥é©»æˆåŠŸï¼æˆ¿é—´ï¼š${checkinData.room}`, `${user.name} checked in successfully! Room: ${checkinData.room}`));
                    }
                }
            } catch (error) {
                console.error('å…¥é©»ä¿å­˜å¤±è´¥:', error);
                alert(getTranslation('å…¥é©»ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'Check-in save failed, please try again'));
            }
        }

        // é€€ç§Ÿå¼¹çª—å‡½æ•°
        window.hideCheckoutModal = function() {
            document.getElementById('checkout-modal').style.display = 'none';
            document.body.classList.remove('modal-open');
            // æ¸…ç©ºè¡¨å•
            document.getElementById('checkout-form').reset();
        }

        window.readCurrentMeterForCheckout = function() {
            // æ¨¡æ‹Ÿè¯»å–å½“å‰ç”µè¡¨è¯»æ•°
            const currentReading = (Math.random() * 1000 + 500).toFixed(2);
            document.getElementById('checkout-electricity-reading').value = currentReading;

            if (typeof EnergySystem !== 'undefined') {
                EnergySystem.showNotification(getTranslation(`å·²è¯»å–å½“å‰ç”µè¡¨è¯»æ•°ï¼š${currentReading} kWh`, `Current electricity reading: ${currentReading} kWh`), 'success');
            } else {
                alert(getTranslation(`å·²è¯»å–å½“å‰ç”µè¡¨è¯»æ•°ï¼š${currentReading} kWh`, `Current electricity reading: ${currentReading} kWh`));
            }
        }

        window.saveCheckout = function() {
            const formData = new FormData(document.getElementById('checkout-form'));
            const userId = document.getElementById('checkout-user-id').value;

            // è·å–è¡¨å•æ•°æ®
            const checkoutData = {
                checkoutDate: formData.get('checkoutDate'),
                electricityReading: parseFloat(formData.get('electricityReading'))
            };

            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!checkoutData.checkoutDate || isNaN(checkoutData.electricityReading)) {
                alert(getTranslation('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ', 'Please fill in all required fields'));
                return;
            }

            // éªŒè¯è¯»æ•°å€¼
            if (checkoutData.electricityReading < 0) {
                alert(getTranslation('ç”µè¡¨è¯»æ•°ä¸èƒ½ä¸ºè´Ÿæ•°', 'Electricity reading cannot be negative'));
                return;
            }

            try {
                // æ›´æ–°ç§Ÿæˆ·çŠ¶æ€
                const user = usersData.find(u => u.id === userId);
                if (user) {
                    user.status = 'inactive';
                    user.checkoutDate = checkoutData.checkoutDate;
                    user.finalElectricityReading = checkoutData.electricityReading;
                    // æ¸…é™¤æˆ¿é—´ä¿¡æ¯
                    user.room = null;

                    // é‡æ–°æ¸²æŸ“è¡¨æ ¼
                    renderUsersTable();

                    // å…³é—­å¼¹çª—
                    hideCheckoutModal();

                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    const displayName = (document.getElementById('language-select')?.value || 'zh') === 'zh' ? user.name : (user.nameEn || user.name);
                    if (typeof EnergySystem !== 'undefined') {
                        EnergySystem.showNotification(getTranslation(`${displayName} é€€ç§ŸæˆåŠŸï¼`, `${displayName} checked out successfully!`), 'success');
                    } else {
                        alert(getTranslation(`${displayName} é€€ç§ŸæˆåŠŸï¼`, `${displayName} checked out successfully!`));
                    }
                }
            } catch (error) {
                console.error('é€€ç§Ÿä¿å­˜å¤±è´¥:', error);
                alert(getTranslation('é€€ç§Ÿä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'Check-out save failed, please try again'));
            }
        }

        window.hideDeleteConfirm = function() {
            document.getElementById('delete-confirm-modal').style.display = 'none';
            document.body.classList.remove('modal-open');
            deleteUserId = null;
        }

        window.confirmDelete = function() {
            if (deleteUserId) {
                const index = usersData.findIndex(u => u.id === deleteUserId);
                if (index > -1) {
                    const user = usersData[index];
                    const currentLang = document.getElementById('language-select')?.value || 'zh';
                    const displayName = currentLang === 'zh' ? user.name : (user.nameEn || user.name);

                    usersData.splice(index, 1);
                    renderUsersTable();
                    hideDeleteConfirm();

                    if (typeof EnergySystem !== 'undefined') {
                        EnergySystem.showNotification(getTranslation(`${displayName} åˆ é™¤æˆåŠŸï¼`, `${displayName} deleted successfully!`), 'success');
                    } else {
                        alert(getTranslation(`${displayName} åˆ é™¤æˆåŠŸï¼`, `${displayName} deleted successfully!`));
                    }
                }
            }
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.addEventListener('click', function(event) {
            const userModal = document.getElementById('user-modal');

            if (event.target === userModal || event.target === userModal.querySelector('.modal-overlay')) {
                hideModal();
            }

            const checkinModal = document.getElementById('checkin-modal');
            if (event.target === checkinModal || event.target === checkinModal.querySelector('.modal-overlay')) {
                hideCheckinModal();
            }

            const checkoutModal = document.getElementById('checkout-modal');
            if (event.target === checkoutModal || event.target === checkoutModal.querySelector('.modal-overlay')) {
                hideCheckoutModal();
            }

            const deleteModal = document.getElementById('delete-confirm-modal');
            if (event.target === deleteModal || event.target === deleteModal.querySelector('.modal-overlay')) {
                hideDeleteConfirm();
            }
        });

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ç”¨æˆ·ç®¡ç†é¡µé¢åŠ è½½å¼€å§‹');

            // ç«‹å³åº”ç”¨å½“å‰è¯­è¨€
            setTimeout(forceTranslateStaticText, 10);

            // ç›´æ¥åˆå§‹åŒ–é¡µé¢
            function waitForNavManager() {
                console.log('å¼€å§‹åˆå§‹åŒ–é¡µé¢');
                initPage();
            }

            function initPage() {
                // é¡µé¢åˆå§‹åŒ–å®Œæˆ
                console.log('User management page loaded successfully');

                // åˆå§‹åŒ–è¯­è¨€ç³»ç»Ÿ
                if (typeof EnergySystem !== 'undefined' && typeof EnergySystem.initLanguageSystem === 'function') {
                    EnergySystem.initLanguageSystem();
                } else if (typeof initLanguageSystem === 'function') {
                    initLanguageSystem();
                }

                // ç­‰å¾…DOMå®Œå…¨åŠ è½½åå†ç¿»è¯‘
                setTimeout(function() {
                    // å¼ºåˆ¶ç¿»è¯‘é™æ€æ–‡æœ¬
                    forceTranslateStaticText();

                    // æ¸²æŸ“è¡¨æ ¼
                    renderUsersTable();
                }, 50);
                updatePlaceholders(); // åˆå§‹åŒ–æ—¶æ›´æ–°å ä½ç¬¦
                console.log('ç”¨æˆ·ç®¡ç†é¡µé¢åˆå§‹åŒ–å®Œæˆ');

                // ç›‘å¬è¯­è¨€åˆ‡æ¢äº‹ä»¶ï¼Œé‡æ–°æ¸²æŸ“è¡¨æ ¼
                window.addEventListener('languageChanged', function(event) {
                    console.log('ç”¨æˆ·ç®¡ç†é¡µé¢æ”¶åˆ°è¯­è¨€åˆ‡æ¢äº‹ä»¶:', event.detail.language);
                    setTimeout(function() {
                        console.log('é‡æ–°æ¸²æŸ“ç”¨æˆ·è¡¨æ ¼...');
                        renderUsersTable(); // é‡æ–°æ¸²æŸ“è¡¨æ ¼ä»¥åº”ç”¨æ–°è¯­è¨€
                        updatePlaceholders(); // æ›´æ–°å ä½ç¬¦æ–‡æœ¬
                    }, 100); // å»¶è¿Ÿæ‰§è¡Œç¡®ä¿è¯­è¨€åˆ‡æ¢å®Œæˆ
                });

                // ç›´æ¥ç›‘å¬è¯­è¨€é€‰æ‹©å™¨å˜åŒ–
                const languageSelect = document.getElementById('language-select');
                if (languageSelect) {
                    console.log('ä¸ºè¯­è¨€é€‰æ‹©å™¨æ·»åŠ ç›‘å¬å™¨');
                    languageSelect.addEventListener('change', function(e) {
                        console.log('*** è¯­è¨€é€‰æ‹©å™¨å˜åŒ– ***ï¼Œæ–°è¯­è¨€:', e.target.value);

                        // å¼ºåˆ¶ç¿»è¯‘é™æ€æ–‡æœ¬
                        forceTranslateStaticText();

                        // è§¦å‘è¯­è¨€ç³»ç»Ÿæ›´æ–°é™æ€ç¿»è¯‘
                        if (typeof EnergySystem !== 'undefined' && typeof EnergySystem.applyLanguage === 'function') {
                            EnergySystem.applyLanguage(e.target.value);
                        } else if (typeof applyLanguage === 'function') {
                            applyLanguage(e.target.value);
                        }

                        // ç«‹å³æ¸²æŸ“åŠ¨æ€å†…å®¹
                        renderUsersTable();
                        updatePlaceholders();

                        // å»¶è¿Ÿå†æ¬¡æ¸²æŸ“ç¡®ä¿æ›´æ–°å®Œæˆ
                        setTimeout(function() {
                            forceTranslateStaticText();
                            renderUsersTable();
                            updatePlaceholders();
                        }, 100);
                        setTimeout(function() {
                            forceTranslateStaticText();
                            renderUsersTable();
                            updatePlaceholders();
                        }, 500);
                    });

                    // ä¹Ÿç›‘å¬clickäº‹ä»¶
                    languageSelect.addEventListener('click', function() {
                        console.log('è¯­è¨€é€‰æ‹©å™¨è¢«ç‚¹å‡»');
                        setTimeout(function() {
                            renderUsersTable();
                            updatePlaceholders();
                        }, 100);
                    });
                }

                // æ¯2ç§’å¼ºåˆ¶æ£€æŸ¥å¹¶é‡æ–°æ¸²æŸ“ä¸€æ¬¡
                setInterval(function() {
                    const select = document.getElementById('language-select');
                    if (select) {
                        console.log('å®šæ—¶æ£€æŸ¥ï¼Œå½“å‰è¯­è¨€é€‰æ‹©å™¨å€¼:', select.value);
                        renderUsersTable();
                        updatePlaceholders();
                    }
                }, 2000);
            }

            // å¼€å§‹ç­‰å¾…
            waitForNavManager();
        });
    </script>

    <script>
        // æ·»åŠ ç”¨æˆ·ç®¡ç†é¡µé¢ç‰¹æœ‰æ ·å¼ - ä¸bills.htmlä¿æŒä¸€è‡´
        const style = document.createElement('style');
        style.textContent = `
            /* å¯¼èˆªæ æ ·å¼ - è¦†ç›–common.css */
            .navbar {
                height: 56px !important;
                overflow: hidden !important;
                background: rgba(255, 255, 255, 0.8) !important;
                backdrop-filter: blur(20px) !important;
                border-bottom: var(--border) !important;
                position: sticky !important;
                top: 0 !important;
                z-index: 1000 !important;
            }

            .nav-content {
                display: flex !important;
                align-items: center !important;
                justify-content: space-between !important;
                padding: 12px 20px !important;
                gap: 15px !important;
                height: 100% !important;
                max-width: none !important;
                margin: 0 !important;
            }

            .nav-brand {
                display: flex !important;
                align-items: center !important;
                flex-shrink: 0 !important;
            }

            .nav-menu {
                flex: 1 !important;
                display: flex !important;
                justify-content: center !important;
                gap: 20px !important;
            }

            .nav-actions {
                display: flex !important;
                align-items: center !important;
                gap: 15px !important;
            }

            .nav-logo {
                height: 32px !important;
                max-width: 150px !important;
                object-fit: contain !important;
                transition: all 0.2s ease !important;
            }

            .nav-logo:hover {
                transform: scale(1.02) !important;
            }

            /* å¸ƒå±€ç³»ç»Ÿ */
            .content-layout {
                display: flex;
                max-width: 1600px;
                margin: 0 auto;
                padding: var(--space-12) var(--space-8);
                gap: var(--space-6);
            }

            .main-container {
                flex: 1;
                min-width: 0;
                padding-top: 0;
            }

            /* æœç´¢åŒºåŸŸæ ·å¼ */
            .search-section {
                background: var(--background);
                border: var(--border);
                border-radius: var(--radius);
                padding: var(--space-6);
                margin-bottom: var(--space-6);
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: var(--space-4);
            }

            .search-controls {
                display: flex;
                gap: var(--space-4);
                flex: 1;
            }

            .search-controls .form-input {
                min-width: 300px;
            }

            .search-actions {
                display: flex;
                gap: var(--space-3);
            }

            /* è¡¨å•æ ·å¼ - ä»è®¾å¤‡ç®¡ç†é¡µé¢å¤åˆ¶ */
            .form-input,
            .form-select,
            .form-textarea {
                padding: 12px 16px !important;
                border: 1px solid #F0F0F0 !important;
                border-radius: 8px !important;
                background: #FFFFFF !important;
                color: #000000 !important;
                font-size: 14px !important;
                transition: all 0.2s ease !important;
                outline: none !important;
                font-family: inherit !important;
                width: 100% !important;
                display: block !important;
            }

            .form-input:focus,
            .form-select:focus,
            .form-textarea:focus {
                border-color: #0066CC !important;
                box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1) !important;
                background: #FFFFFF !important;
            }

            .form-input:hover,
            .form-select:hover {
                border-color: #666666 !important;
            }

            /* è¡¨æ ¼å¤´éƒ¨æ ·å¼ - ä»è®¾å¤‡ç®¡ç†é¡µé¢å¤åˆ¶ */
            .table-header {
                background: var(--background);
                border: var(--border);
                border-bottom: none;
                border-radius: var(--radius) var(--radius) 0 0;
                padding: var(--space-4) var(--space-6);
                display: flex;
                justify-content: flex-start;
                align-items: center;
                margin-bottom: 0;
            }

            .table-container {
                background: var(--background);
                border: var(--border);
                border-radius: var(--radius);
                overflow: hidden;
                margin-bottom: var(--space-6);
            }

            .table-container .table {
                border: none;
                margin: 0;
            }

            /* æŒ‰é’®æ ·å¼ - ä»è®¾å¤‡ç®¡ç†é¡µé¢å¤åˆ¶ */
            .btn {
                padding: var(--space-2) var(--space-4);
                border: none;
                border-radius: var(--radius);
                font-family: inherit;
                font-size: 14px;
                font-weight: var(--font-weight-medium);
                cursor: pointer;
                transition: all 0.15s ease;
                text-decoration: none;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: var(--space-2);
            }

            .btn-primary {
                background: var(--primary);
                color: white;
            }

            .btn-primary:hover {
                transform: translateY(-1px);
                box-shadow: var(--shadow-hover);
            }

            .btn-secondary {
                background: var(--surface);
                color: var(--text-primary);
                border: var(--border);
            }

            .btn-secondary:hover {
                background: var(--divider);
            }

            .btn-success {
                background: #000000 !important;
                color: white !important;
                border: 1px solid #000000 !important;
            }

            .btn-success:hover {
                background: #333333 !important;
                border-color: #333333 !important;
                transform: translateY(-1px) !important;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
            }

            .btn-warning {
                background: #ff9500;
                color: white;
                border: 1px solid #ff9500;
            }

            .btn-warning:hover {
                background: #e6850e;
                border-color: #e6850e;
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(255, 149, 0, 0.15);
            }

            .btn-sm {
                padding: 4px 8px;
                font-size: 12px;
            }


            /* è¯­è¨€ä¸‹æ‹‰åˆ—è¡¨æ ·å¼ */
            .lang-dropdown {
                display: flex;
                align-items: center;
            }

            .lang-select {
                min-width: 100px;
                padding: var(--space-2) var(--space-3);
                border: var(--border);
                border-radius: var(--radius);
                background: var(--background);
                font-size: 14px;
                font-weight: var(--font-weight-medium);
                cursor: pointer;
                transition: all 0.15s ease;
            }

            .lang-select:focus {
                outline: 2px solid var(--accent);
                outline-offset: -2px;
            }

            .lang-select:hover {
                background: var(--surface);
            }

            .pagination {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: var(--space-4);
                padding: var(--space-6);
                background: var(--surface);
                border-top: var(--border);
            }

            .page-info {
                font-size: 14px;
                color: var(--text-secondary);
            }

            /* ç”¨æˆ·çŠ¶æ€æ ·å¼ */
            .device-status {
                padding: var(--space-1) var(--space-2);
                border-radius: calc(var(--radius) / 2);
                font-size: 12px;
                font-weight: var(--font-weight-medium);
                display: inline-block;
                min-width: 48px;
                text-align: center;
            }

            .status-online {
                background: rgba(40, 167, 69, 0.1);
                color: var(--success);
            }

            .status-offline {
                background: rgba(255, 149, 0, 0.1);
                color: var(--warning);
            }

            .status-pending {
                background: rgba(108, 117, 125, 0.1);
                color: #6c757d;
            }

            .btn-danger {
                background: #dc2626;
                color: white;
                border: 1px solid #dc2626;
            }

            .btn-danger:hover {
                background: #b91c1c;
                border-color: #b91c1c;
            }

            .btn-success {
                background: #16a34a;
                color: white;
                border: 1px solid #16a34a;
            }

            .btn-success:hover {
                background: #15803d;
                border-color: #15803d;
            }

            /* å³æŠ½å±‰æ¨¡æ€æ¡†æ ·å¼ - ä¸è®¾å¤‡ç®¡ç†é¡µé¢ä¿æŒä¸€è‡´ */
            .modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(8px);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: flex-end;
                padding: 0;
                overflow: hidden;
            }

            .modal[style*="flex"] {
                display: flex !important;
            }

            /* é˜²æ­¢èƒŒæ™¯é¡µé¢æ»šåŠ¨ */
            body.modal-open {
                overflow: hidden;
            }

            /* å¼ºåˆ¶æ˜¾ç¤ºçº¢è‰²æ˜Ÿå· */
            .required-asterisk {
                color: #ff0000 !important;
                font-weight: bold !important;
                margin-left: 3px !important;
                font-size: 14px !important;
                display: inline !important;
                visibility: visible !important;
                opacity: 1 !important;
            }

            /* è¦†ç›–æ‰€æœ‰å¯èƒ½çš„æ ·å¼ */
            label .required-asterisk,
            .form-group label .required-asterisk,
            .modal .required-asterisk,
            * .required-asterisk {
                color: #ff0000 !important;
                font-weight: bold !important;
                margin-left: 3px !important;
                font-size: 14px !important;
                display: inline !important;
                visibility: visible !important;
                opacity: 1 !important;
                text-decoration: none !important;
                background: none !important;
            }

            .modal-overlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.3);
                z-index: -1;
            }

            .modal-content {
                background: var(--background);
                border-radius: 0;
                box-shadow: -10px 0 30px rgba(0, 0, 0, 0.3);
                width: 500px;
                height: 100vh;
                overflow: hidden;
                position: relative;
                z-index: 1;
                animation: drawerSlideIn 0.3s ease-out;
                display: flex;
                flex-direction: column;
            }

            @keyframes drawerSlideIn {
                from {
                    opacity: 0;
                    transform: translateX(100%);
                }
                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }

            .modal-header {
                padding: 24px 32px;
                background: var(--background);
                color: var(--text-primary);
                border-radius: 0;
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: var(--border);
                flex-shrink: 0;
            }

            .modal-header h3 {
                margin: 0;
                font-size: 20px;
                font-weight: 600;
                color: var(--text-primary);
            }

            .modal-close {
                background: none;
                border: none;
                color: var(--text-secondary);
                font-size: 24px;
                font-weight: bold;
                cursor: pointer;
                padding: 8px;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s ease;
            }

            .modal-close:hover {
                background: var(--surface);
                color: var(--text-primary);
                transform: scale(1.1);
            }

            .modal-body {
                padding: 32px;
                flex: 1;
                overflow-y: auto;
            }

            .modal-footer {
                padding: 20px 32px;
                background: var(--surface);
                border-top: var(--border);
                display: flex;
                justify-content: flex-end;
                gap: 12px;
                border-radius: 0;
                flex-shrink: 0;
            }

            /* è¡¨å•æ ·å¼ */
            .user-form {
                display: flex;
                flex-direction: column;
                gap: 24px;
            }

            .form-section {
                background: var(--surface);
                border: var(--border);
                border-radius: var(--radius);
                padding: 24px;
                position: relative;
            }

            .section-title {
                margin: 0 0 20px 0;
                font-size: 16px;
                font-weight: 600;
                color: var(--text-primary);
                display: flex;
                align-items: center;
                gap: 8px;
                padding-bottom: 8px;
                border-bottom: 2px solid var(--primary);
            }

            .section-title::before {
                content: '';
                width: 4px;
                height: 16px;
                background: var(--primary);
                border-radius: 2px;
            }

            .form-row {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 20px;
                margin-bottom: 16px;
            }

            .form-row:last-child {
                margin-bottom: 0;
            }

            .form-group {
                display: flex;
                flex-direction: column;
                gap: 6px;
            }

            .form-group.full-width {
                grid-column: 1 / -1;
            }

            .form-group label {
                font-size: 14px;
                font-weight: 500;
                color: var(--text-primary);
                display: flex;
                align-items: center;
                gap: 4px;
            }


            .form-input,
            .form-select,
            .form-textarea {
                padding: 12px 16px;
                border: 2px solid var(--border-color);
                border-radius: var(--radius);
                background: var(--background);
                color: var(--text-primary);
                font-size: 14px;
                transition: all 0.2s ease;
                outline: none;
                font-family: inherit;
            }

            .form-input:focus,
            .form-select:focus,
            .form-textarea:focus {
                border-color: var(--primary);
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
                background: var(--background);
            }

            .form-input:hover,
            .form-select:hover {
                border-color: var(--accent);
            }

            .form-textarea {
                resize: vertical;
                min-height: 80px;
                font-family: inherit;
                line-height: 1.5;
            }

            .form-input::placeholder,
            .form-textarea::placeholder {
                color: var(--text-secondary);
                opacity: 0.7;
            }

            .form-hint {
                font-size: 12px;
                color: var(--text-secondary);
                margin-top: 4px;
                font-style: italic;
            }

            .form-input[required]:invalid {
                border-color: var(--error);
            }

            .form-input[required]:invalid:focus {
                box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
            }

            /* æŒ‰é’®æ ·å¼ - ä¸bills.htmlä¿æŒä¸€è‡´ */
            .btn {
                padding: var(--space-2) var(--space-4);
                border: none;
                border-radius: var(--radius);
                font-family: inherit;
                font-size: 14px;
                font-weight: var(--font-weight-medium);
                cursor: pointer;
                transition: all 0.15s ease;
                text-decoration: none;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: var(--space-2);
            }

            .btn-primary {
                background: var(--primary);
                color: white;
            }

            .btn-primary:hover {
                transform: translateY(-1px);
                box-shadow: var(--shadow-hover);
            }

            .btn-secondary {
                background: var(--surface);
                color: var(--text-primary);
                border: var(--border);
            }

            .btn-secondary:hover {
                background: var(--divider);
            }

            .actions {
                display: flex;
                gap: var(--space-2);
            }


            /* å“åº”å¼è®¾è®¡ */
            @media (max-width: 1200px) {
                .content-layout {
                    flex-direction: column;
                }
            }

            @media (max-width: 768px) {
                .content-layout {
                    padding: var(--space-8) var(--space-4);
                }

                .search-section {
                    flex-direction: column;
                    align-items: stretch;
                }

                .search-controls {
                    flex-direction: column;
                }

                .search-controls .form-input {
                    min-width: auto;
                }

                .modal {
                    padding: 10px;
                }

                .modal-content {
                    margin-top: 20px;
                    max-height: calc(100vh - 20px);
                }

                .modal-header,
                .modal-body,
                .modal-footer {
                    padding: 20px;
                }

                .form-row {
                    grid-template-columns: 1fr;
                    gap: 16px;
                }

                .form-section {
                    padding: 16px;
                }

                .nav-menu {
                    gap: 10px !important;
                }
            }

            /* åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†æ ·å¼ - ä¸è®¾å¤‡ç®¡ç†é¡µé¢ä¿æŒä¸€è‡´ */
            #delete-confirm-modal {
                justify-content: center !important;
                align-items: center !important;
            }

            .delete-confirm-modal {
                width: 400px !important;
                height: auto !important;
                max-width: 90vw;
                animation: modalSlideIn 0.3s ease-out !important;
                border-radius: var(--radius) !important;
            }

            .delete-warning {
                color: var(--text-secondary);
                font-size: 14px;
                margin-top: 8px;
            }

            /* æ·»åŠ modalSlideInåŠ¨ç”» */
            @keyframes modalSlideIn {
                from {
                    opacity: 0;
                    transform: translateY(-20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>